<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>S.A.G.E. - AI Strategy Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
	<style>
        :root {
        --grad-1: #09203f;
        --grad-2: #537895;
        --primary: #2b506e;
        --primary-hover: #09203f;
        --accent: #537895;
        }
		html, body {
			height: 100%;
			margin: 0;
			padding: 0;
		}
        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--grad-1), var(--grad-2));
            color: white;
            font-family: sans-serif;
        }

		/* Neo4j Visualization Library Styling */
        #graph-container {
			position: relative;
			width: 90%;
			height: 600px; /* Adjust height as needed */
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 1.5rem;	/* The amount of rounding you want to apply */
			overflow: hidden; /* So content inside is also rounded */
			box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
			background-color: rgba(30, 30, 30, 0.8); 	/* Slightly transparent background */
			padding: 1.5rem;
		}

		.graph-inner {
			position: relative;
            width: 100%;
            height: 100%;
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 1.5rem;	/* The amount of rounding you want to apply */
			overflow: hidden; /* So content inside is also rounded */
			margin: 0
        }
	</style>
</head>
<body class="min-h-screen">
    <div id="knowledgeGraph" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">Knowledge Graph Visualization</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Explore the relationships between entities in an interactive knowledge graph.</p>
            <div id="graph-container">
                <div class="graph-inner"></div>
            </div>
    </div>

    <script type="module">
        // =========================================================
        // SCRIPT
        // =========================================================
        // Load NVL base library
        import { NVL } from "https://esm.sh/@neo4j-nvl/base@0.3.9/es2022/base.mjs";
        import { 
            ClickInteraction,
            ZoomInteraction,
            PanInteraction,
            DragNodeInteraction,
            HoverInteraction 
        } from "https://esm.sh/@neo4j-nvl/interaction-handlers@0.3.9/es2022/interaction-handlers.mjs";
        document.addEventListener('DOMContentLoaded', async () => {
            loadKnowledgeGraph();

			let graphContainer;
            // --- Knowledge Graph Visualization Logic ---
            async function loadKnowledgeGraph() {
                const graphContainer = document.querySelector('.graph-inner')
                
                if (!graphContainer || typeof NVL === 'undefined') {
                    console.error('NVL not loaded or graph container not found.');
                    return;
                }

                // Define color mapping for node labels
                const labelColorMap = {
                    'NOUN_CHUNK': '#FF8C42',  // Orange
                    'ORG': '#FF4757',         // Red
                    'VERB': '#2ED573',        // Green
                    'ADJ': '#5F9EA0',         // Teal
                    'NOUN': '#DDA0DD',        // Plum
                    'DATE': '#00CED1',        // Dark Turquoise
                    'PROPN': '#FF69B4',       // Hot Pink
                    'CARDINAL': '#D2691E',    // Chocolate
                    'GPE': '#A9A9A9',         // Dark Gray
                    'ORDINAL': '#C0C0C0',     // Silver
                    'PERCENT': '#B0B0B0',     // Gray
                    'MONEY': '#8B8B8B',       // Dark Gray
                    'PERSON': '#FF1493',      // Deep Pink
                    'NORP': '#BEBEBE',        // Gray
                    'LAW': '#708090',         // Slate Gray
                    'QUANTITY': '#778899',    // Light Slate Gray
                    'TIME': '#696969',        // Dim Gray
                    'WORK_OF_ART': '#808080', // Gray
                    'LOC': '#2F4F4F',         // Dark Slate Gray
                    'PRODUCT': '#1E90FF',     // Dodger Blue
                    'NUM': '#FFD700',         // Gold
                    'FAC': '#A9A9A9',         // Dark Gray
                    'ADV': '#BC8F8F',         // Rosy Brown
                    'X': '#D3D3D3'            // Light Gray
                }

                // Function to fetch data from your backend
                async function fetchGraphData() {
                try {
                        //const { data: { session } } = await supabase.auth.getSession();
                        const response = await fetch('https://matt-nlp.data2int.com/graph/knowledge-graph', {
                            method: 'GET',
                            headers: { 'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJlODRkY2I3YS1hMWQ2LTQxN2UtOWVhYi1iMjRlMTJkNjIzNDYiLCJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzYwMTY2NzM0LCJpYXQiOjE3NjAxNjMxMzQsImVtYWlsIjoibWF0dHRlc3RAZ21haWwuY29tIiwicGhvbmUiOiIiLCJhcHBfbWV0YWRhdGEiOnsiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJwcm92aWRlciI6ImVtYWlsIiwicHJvdmlkZXJzIjpbImVtYWlsIl0sInJvbGUiOiJiYXNpYyIsInRpZXIiOiJiYXNpYyJ9LCJ1c2VyX21ldGFkYXRhIjp7ImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJmaXJzdF9uYW1lIjoiTWF0dCIsImZ1bGxfbmFtZSI6Ik1hdHQgVGVzdCIsImxhc3RfbmFtZSI6IlRlc3QifSwicm9sZSI6ImF1dGhlbnRpY2F0ZWQiLCJhYWwiOiJhYWwxIiwiYW1yIjpbeyJtZXRob2QiOiJwYXNzd29yZCIsInRpbWVzdGFtcCI6MTc2MDE2MzEzNH1dLCJzZXNzaW9uX2lkIjoiNDIxNzU0ZmQtYTlhMi00NGRkLTg2MzItNTRiMTc3OGIwODUwIiwiaXNfYW5vbnltb3VzIjpmYWxzZX0.H-pGYFua826SIQH67IvJntZ9JKdnZkLzzNWPx46L_Rw' }
                        });
                            
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                    const graphData = await response.json();
                        console.log("Fetched graph data:", graphData);

                        const transformedNodes = graphData.nodes.map(node => {
                            const nodeColor = labelColorMap[String(node.label)] || '#FFD700'; // ADDED NODE COLOR VARIABLE
                            return {
                                id: String(node.id), // Ensure ID is a string
                                color: String(nodeColor), // ADDED COLOR FIELD
                                caption: node.properties.name || node.label,
                                labels: [String(node.label)], // NVL expects an array of labels
                                properties: node.properties ? { ...node.properties } : {} // Ensure properties is a plain object
                            };
                        });

                        const transformedRelationships = graphData.relationships.map(rel => {
                            const relId = rel.id ? String(rel.id) : `${rel.source_id}-${rel.type}-${rel.target_id}`;
                            return {
                                id: relId,
                                from: String(rel.source_id), // Ensure IDs are strings
                                to: String(rel.target_id),   // Ensure IDs are strings
                                caption: String(rel.type),   // Ensure caption is a string
                                type: String(rel.type),
                                properties: rel.properties ? { ...rel.properties } : {} // Ensure properties is a plain object
                            };
                        });

                        return {
                            nodes: transformedNodes,
                            relationships: transformedRelationships
                        };

                    } catch (error) {
                        console.error("Error fetching graph data:", error);
                        graphContainer.innerHTML = `<p style='color: red;'>Error loading graph: ${error.message}</p>`;
                        return null; // Return null on error
                    }
                }

                const initialGraphData = await fetchGraphData();
                console.log("Graph data", initialGraphData);
                const { nodes, relationships } = initialGraphData;
                if (initialGraphData) {
                    // Pass the data to the NVL constructor
                    const visualization = new NVL(graphContainer, nodes, relationships, {
                        // Optionally specify a layout, e.g., 'forcedirected' or 'hierarchical'
                        layout: 'forcedirected'
                    });
                    console.log("Visualization:", visualization);

                    // Instantiate and add interaction handlers
                    const clickInteraction = new ClickInteraction(visualization);
                    const zoomInteraction = new ZoomInteraction(visualization);
                    const panInteraction = new PanInteraction(visualization);
                    const dragNodeInteraction = new DragNodeInteraction(visualization);
                    //const boxSelectInteraction = new BoxSelectInteraction(visualization);
                    const hoverInteraction = new HoverInteraction(visualization);

                    // Example: Add callbacks to interaction handlers
                    clickInteraction.updateCallback('onNodeClick', (node) => {
                        console.log('Node clicked', node);
                    });
                    // boxSelectInteraction.updateCallback('onBoxSelect', ({ nodes, rels }) => {
                    //     console.log('Selected elements:', nodes, rels);
                    // });
                    dragNodeInteraction.updateCallback('onDrag', (nodes) => {
                        //console.log('Dragged nodes:', nodes);
                    });
                    hoverInteraction.updateCallback('onHover', (element, hitElements, event) => {
                        //console.log('Hovered element:', element);
                    });
                    panInteraction.updateCallback('onPan', (panning) => {
                        //console.log('Panning:', panning);
                    });
                    zoomInteraction.updateCallback('onZoom', (zoomLevel) => {
                        //console.log('Zoom level:', zoomLevel);
                    });
                }
            }
        });
    </script>
</body>
</html>