<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>S.A.G.E. - AI Strategy Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/lite.render.js"></script> 
    <style>
        /* --- THEME COLORS (CSS VARIABLES) --- */
        :root {
            --grad-1: #C33764;
            --grad-2: #1D2671;
            --primary: #8E2DE2;
            --primary-hover: #4A00E0;
            --accent: #C33764;
            --edge-color: #4A00E0;
            --node-color: #C33764;
        }

        /* --- Base & Animated Background --- */
        html, body {
            min-height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, var(--grad-1), var(--grad-2));
            background-size: 400% 400%;
            animation: gradientBG 18s ease infinite;
            color: #f9fafb;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex-grow: 1;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .page {
            display: none;
        }

        /* Hide all pages by default */
        .page.active {
            animation: fadeIn .5s ease-out;
        }

        /* Specific display rules for active pages */
        #home.active,
        #templates.active,
        #templateDetail.active,
        #examplesPage.active,
        #adminDashboard.active,
        #about.active {
            display: block;
            /* Content pages */
        }

        #login.active,
        #signup.active,
        #emailVerification.active {
            display: flex;
            /* Centered pages */
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        /* --- Glass & Card Effects --- */
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            transition: all .3s ease;
            text-align: center;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .template-card,
        .project-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: all .3s ease;
            cursor: pointer;
        }

        .template-card:hover,
        .project-card:hover {
            transform: translateY(-5px);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .project-card-content {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* --- Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(220, 38, 38, 0.5);
            color: #fca5a5;
        }

        .btn-danger:hover {
            background: rgba(220, 38, 38, 0.7);
            color: #fff;
        }

        .btn-tertiary {
            background: transparent;
            color: #c7d2fe;
            text-decoration: underline;
        }

        .btn-tertiary:hover {
            color: #fff;
        }

        /* --- Forms & Inputs --- */
        .input-field {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-field:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .error-message {
            color: #fca5a5;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(220, 38, 38, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .success-message {
            color: #a7f3d0;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(5, 150, 105, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        /* --- Loading Spinners --- */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 2rem;
        }

        .typing-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            animation: typing 1.4s infinite ease-in-out
        }

        .typing-dot:nth-child(1) {
            animation-delay: -.32s
        }

        .typing-dot:nth-child(2) {
            animation-delay: -.16s
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0s
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(.8);
                opacity: .5
            }

            40% {
                transform: scale(1);
                opacity: 1
            }
        }

        /* --- Three.js Canvas Styling --- */
        #threeJsCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            display: block;
            transition: opacity 0.5s ease-in-out;
        }

        /* Carousel specific styles */
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 9999px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: background 0.3s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .carousel-button:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .carousel-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .carousel-button.left {
            left: -6rem;
        }

        .carousel-button.right {
            right: -6rem;
        }

        @media (max-width: 768px) {
            .carousel-button.left {
                left: 0.5rem;
            }

            .carousel-button.right {
                right: 0.5rem;
            }
        }

        .analysis-example-item {
            padding: 2.5rem;
            margin-bottom: 0;
        }

        .analysis-example-item h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .analysis-example-item ul,
        .analysis-example-item ol {
            list-style-position: inside;
            margin-left: 1.25rem;
            margin-bottom: 1rem;
        }

        .analysis-example-item li {
            margin-bottom: 0.5rem;
        }

        .feature-card .feature-description ul,
        .feature-card .feature-description ol,
        .feature-card .feature-description p {
            text-align: center;
        }

        /* WebSocket connection status indicator */
        .ws-status {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .ws-status.connected {
            background: rgba(5, 150, 105, 0.8);
            color: #a7f3d0;
        }

        .ws-status.disconnected {
            background: rgba(220, 38, 38, 0.8);
            color: #fca5a5;
        }

        .ws-status.connecting {
            background: rgba(245, 158, 11, 0.8);
            color: #fbbf24;
        }

        /* Glassy Checkboxes */
        .method-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .method-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
        }
        .method-checkbox:disabled + span {
            opacity: 0.5;
        }

        .method-checkbox:checked {
            background: color-mix(in srgb, var(--primary) 80%, transparent);
            border-color: color-mix(in srgb, var(--accent) 90%, transparent);
            box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 70%, transparent);
            transform: scale(1.15);
        }

        .method-checkbox:hover:not(:disabled) {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.7);
        }
        
        /* --- Custom File Input --- */
        .input-file-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .input-file {
            position: absolute;
            font-size: 50px;
            opacity: 0;
            right: 0;
            top: 0;
            cursor: pointer;
        }
        .input-file-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
        }
        .input-file-btn:hover {
             background: rgba(255, 255, 255, 0.1);
             border-color: var(--accent);
        }
        .input-file-btn.has-file {
            color: white;
            border-color: var(--accent);
            background: color-mix(in srgb, var(--primary) 20%, transparent);
        }
        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 0.5rem;
        }

        /* --- Interactive Hover for Guide Cards --- */
        #about .glass-container {
            transition: all 0.3s ease-in-out;
        }

        #about .glass-container:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Footer Styling */
        footer {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* --- Sticky Footer Override --- */
        html, body {
            min-height: 100vh !important;
        }
        body {
            display: flex !important;
            flex-direction: column !important;
        }
        .main-content {
            flex: 1 0 auto !important;
        }
        footer {
            flex-shrink: 0 !important;
            position: relative !important;
        }

        /* --- Analysis Results Tab Styling --- */
        .analysis-tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .analysis-tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }
        .analysis-tab-btn.active {
            color: white;
            font-weight: 600;
            border-bottom-color: var(--accent);
        }
        .analysis-tab-panel {
            display: none;
            padding-top: 1.5rem;
            animation: fadeIn 0.5s;
        }
        .analysis-tab-panel.active {
            display: block;
        }

        /* --- Home Page Tab Styling --- */
        .home-tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }
        .home-tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .home-tab-btn.active {
            color: white;
            font-weight: 600;
            border-bottom-color: var(--primary);
        }
        .home-tab-panel {
            display: none;
            animation: fadeIn 0.5s;
        }
        .home-tab-panel.active {
            display: grid;
        }

        /* SWOT Tool specific styles */
        .input-radio-group {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 0.25rem;
        }
        .input-radio-label {
            flex: 1;
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .input-radio-label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .input-radio:checked + .input-radio-label {
            background: var(--primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .input-radio {
            display: none;
        }

        /* Archetype & Factor Analysis Tool Specific Styles */
        .metric-card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
            margin-bottom: 1rem;
        }
        .metric-card.critical {
            border-left-color: #dc143c;
        }
        .metric-card.high {
            border-left-color: #ff8c00;
        }

        /* --- Strategic Map Diagram Styles --- */
        .strategy-map-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem; /* 24px */
            padding-bottom: 2rem; /* Add some padding to the bottom */
        }

        /* Generic vertical line connecting sections */
        .vertical-connector {
            width: 2px;
            background-color: rgba(255, 255, 255, 0.4);
            height: 40px; /* Standard height for connectors */
            position: relative;
        }
        /* Downward arrow head for generic connectors */
        .vertical-connector::after {
            content: '';
            position: absolute;
            left: -5px;
            bottom: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid rgba(255, 255, 255, 0.4);
        }

        /* Container for the Feedback Loops, allowing horizontal alignment */
        .feedback-loops-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 2rem; /* Spacing between loop boxes */
            width: 100%;
            max-width: 900px; /* Control max width for better readability */
        }
        @media (max-width: 768px) {
            .feedback-loops-grid {
                grid-template-columns: 1fr; /* Stack on smaller screens */
            }
        }

        /* Lines from feedback loops to interventions header */
        .lines-to-interventions {
            display: flex;
            justify-content: center;
            width: 100%;
            height: 40px; /* Space for the lines */
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        /* Line from Reinforcing Loop */
        .lines-to-interventions::before {
            content: '';
            position: absolute;
            left: 25%; /* Roughly center of the left box */
            top: 0;
            width: 2px;
            height: 100%;
            background-color: rgba(46, 139, 87, 0.6); /* Greenish for reinforcing */
        }

        /* Line from Balancing Loop */
        .lines-to-interventions::after {
            content: '';
            position: absolute;
            right: 25%; /* Roughly center of the right box */
            top: 0;
            width: 2px;
            height: 100%;
            background-color: rgba(255, 140, 0, 0.6); /* Orangish for balancing */
        }

        /* Individual initiative connection indicators */
        .initiative-target-indicator {
            position: absolute;
            top: -25px; /* Position above the card */
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem; /* Larger icon */
            line-height: 1;
        }
        /* Specific colors for indicators */
        .indicator-boost { color: #28a745; /* Bootstrap success green */ }
        .indicator-mitigate { color: #ffc107; /* Bootstrap warning yellow */ }

        /* --- Strategic Cascade Styles --- */
        .cascade-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            padding: 2rem 1rem;
        }
        .cascade-objective {
            width: 100%;
            max-width: 700px;
            text-align: center;
            padding: 1.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            border-top: 4px solid var(--primary);
        }
        .cascade-connector {
            width: 2px;
            height: 40px;
            background: rgba(255,255,255,0.3);
        }
        .cascade-goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            width: 100%;
            max-width: 1200px;
        }
        .cascade-goal-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--accent);
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .cascade-strategy {
            background: rgba(0,0,0,0.2);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

        /* --- Action Plan Timeline Styles --- */
        .action-plan-container {
            position: relative;
            padding: 2rem 0;
        }
        .action-plan-container::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            transform: translateX(-50%);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 2.5rem;
            width: 50%;
        }
        .timeline-item:nth-child(odd) {
            padding-right: 2.5rem;
            align-self: flex-start;
        }
        .timeline-item:nth-child(even) {
            padding-left: 2.5rem;
            align-self: flex-end;
        }
        .timeline-dot {
            content: '';
            position: absolute;
            top: 1rem;
            width: 20px;
            height: 20px;
            background: var(--background-dark);
            border-radius: 50%;
            border: 4px solid var(--primary);
        }
        .timeline-item:nth-child(odd) .timeline-dot {
            right: -10px;
            transform: translateX(50%);
        }
        .timeline-item:nth-child(even) .timeline-dot {
            left: -10px;
            transform: translateX(-50%);
        }
        .timeline-content {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.75rem;
        }
        .priority-high { border-left: 4px solid #dc2626; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #2563eb; }

        /* --- KPI Dashboard Styles --- */
        .kpi-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .kpi-card .kpi-name {
            font-size: 1.125rem;
            font-weight: bold;
            color: white;
        }
        .kpi-card .kpi-target {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0.5rem 0;
            line-height: 1.2;
        }
        .kpi-card .kpi-type {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.1);
            align-self: center;
        }

        /* --- Misc Tool: Risk Table Styles --- */
        .risk-pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            min-width: 80px;
        }
        .risk-level-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        .risk-level-medium {
            background-color: rgba(249, 115, 22, 0.2);
            color: #fdba74;
        }
        .risk-level-low {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        /* --- Strategic Horizons Visual Styles --- */
        .horizons-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1 / 1;
            margin: 2rem auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .horizon-circle {
            position: absolute;
            border-style: dashed;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #h3-circle { width: 100%; height: 100%; border: 2px dashed rgba(255, 255, 255, 0.2); }
        #h2-circle { width: 70%; height: 70%; border: 2px dashed rgba(255, 255, 255, 0.3); }
        #h1-circle { width: 40%; height: 40%; border: 2px dashed rgba(255, 255, 255, 0.4); }
        .horizon-label {
            position: absolute;
            top: 10px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
        }
        .main-goal-center {
            width: 33%; /* Increased size */
            height: 33%; /* Increased size */
            background: rgba(var(--primary-rgb), 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
            font-weight: bold;
            font-size: 0.9rem; /* Adjusted font size */
            z-index: 10;
        }
        .initiative-point {
            position: absolute;
            background: rgba(0,0,0,0.5);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 130px; /* Added max-width for wrapping */
            text-align: center;
        }
        .initiative-point:hover {
            transform: scale(1.1) translate(-50%, -50%); /* Adjusted for proper scaling */
            background: var(--primary);
            z-index: 20;
        }

        /* --- Regression Analysis Table Styles --- */
        .coeff-table {
            width: 100%;
            text-align: left;
            border-collapse: collapse;
        }
        .coeff-table th, .coeff-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .coeff-table th {
            font-weight: 600;
            background-color: rgba(0,0,0,0.2);
        }
        .coeff-table .significant {
            color: #6ee7b7; /* A light green for significant p-values */
            font-weight: bold;
        }

        /* --- PLS-SEM Path Diagram Styles (New Flow Method) --- */
        .path-flow-container {
            display: flex;
            justify-content: space-between;
            gap: 2rem;
            padding: 2rem;
        }
        .path-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .path-column-title {
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 1rem;
        }
        .path-node-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            width: 100%;
            text-align: center;
        }
        .path-node-card h4 {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
        }
        .path-influence-list {
            margin-top: 1rem;
            font-size: 0.9rem;
            text-align: left;
        }
        .path-influence-list strong {
            color: white;
        }
        .path-influence {
            color: rgba(255,255,255,0.7);
        }
        .path-influence.significant {
            color: var(--accent);
            font-weight: bold;
        }

        /* --- Descriptive Analysis Styles --- */
        .summary-stat-card {
            background: rgba(0,0,0,0.25);
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .summary-stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
        }
        .summary-stat-card .stat-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.8);
            margin-top: 0.5rem;
        }

        /* --- Styling for SEM Learn Tab --- */
        .styled-table {
            border-collapse: collapse;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .styled-table th,
        .styled-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .styled-table thead th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: white;
        }
        .styled-table tbody tr:last-child td {
            border-bottom: none;
        }
        .styled-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        .styled-details {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
        }
        .styled-details summary {
            padding: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 0.5rem;
        }
        .styled-details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .styled-details summary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .styled-details pre {
            white-space: pre-wrap; /* Allow syntax to wrap */
        }
        /* --- Styling for SEM Analysis Model Tab --- */
        .model-section-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 1.5rem;
            height: 100%;
        }

        /* --- Prescriptive Analysis Styles --- */
        .prescription-card {
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            border-left: 5px solid var(--primary);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .prescription-card h4 {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        .prescription-card .rationale {
            font-style: italic;
            color: rgba(255,255,255,0.8);
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
        }

        /* --- Prescriptive Analysis - Enhanced Styles --- */
        .dashboard-prescription-card {
            background: rgba(0,0,0,0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border-left: 4px solid var(--accent);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .insight-card {
            background: rgba(0,0,0,0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Regression Analysis - Enhanced Styles --- */
        .diagnostic-card {
            background: rgba(0,0,0,0.2);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .diagnostic-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }
        .diagnostic-card .stat-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.25rem;
        }
        /* --- Visualization Tool Styles --- */
        .viz-interpretation-box {
            background: rgba(0,0,0,0.2);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            border-top: 2px solid var(--primary);
        }
        /* --- System Thinking Objectives Styles --- */
        .st-dashboard-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            padding: 2rem;
        }
        .st-objective-card {
            background: rgba(var(--primary-rgb), 0.2);
            border: 1px solid var(--primary);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }
        .st-goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            position: relative;
        }
        .st-goal-card {
            background: rgba(0,0,0,0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .st-loops-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        /* --- System Thinking Actions Styles --- */
        .action-card {
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .action-card.short-term { border-left: 5px solid #f59e0b; }
        .action-card.long-term { border-left: 5px solid #2563eb; }
        
        .action-card h4 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .archetype-card {
            background: rgba(var(--primary-rgb), 0.2);
            border: 1px solid var(--primary);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }
        /* --- Creative Dissonance Styles --- */
        .dissonance-map-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            gap: 2rem;
        }
        .dissonance-pole {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .dissonance-gap {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        .dissonance-point {
            background: rgba(var(--primary-rgb), 0.2);
            border: 1px solid var(--primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
        }
        /* --- Living System Analysis Styles --- */
        .ls-dashboard-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 500px;
            padding: 2rem;
        }
        .ls-core {
            width: 200px;
            height: 200px;
            background: rgba(var(--primary-rgb), 0.3);
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }
        .ls-system-node {
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
        }
        .ls-health-robust { border-top: 4px solid #22c55e; } /* green */
        .ls-health-strained { border-top: 4px solid #f97316; } /* orange */
        .ls-health-fragile { border-top: 4px solid #ef4444; } /* red */
        /* --- Thinking System (Ladder of Inference) Styles --- */
        .ladder-container {
            display: flex;
            flex-direction: column-reverse; /* Build the ladder from the bottom up */
            align-items: center;
            gap: 0.5rem;
            padding: 2rem;
        }
        .ladder-rung {
            width: 100%;
            max-width: 600px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .ladder-rung h4 {
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .ladder-rung p {
            font-size: 1.125rem;
            font-style: italic;
            color: rgba(255,255,255,0.9);
        }
        .ladder-arrow {
            font-size: 2rem;
            color: rgba(255,255,255,0.4);
            transform: rotate(90deg);
        }
        
        /* --- Predictive Styling --- */

/* --- Custom Select Dropdown Styling --- */
.select-wrapper {
    position: relative;
}

select.input-field {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    padding-right: 2.5rem; /* Make space for the arrow */
}

/* Custom Arrow using SVG */
.select-wrapper::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 1rem;
    width: 1rem;
    height: 1rem;
    transform: translateY(-50%);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='rgba(255,255,255,0.7)' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    pointer-events: none; /* Allows clicks to go through to the select element */
}

/* Style the dropdown options list */
select.input-field option {
    background: #1d2671; /* A dark color from your gradient */
    color: #f9fafb;
}

/* --- Predictive Forecast Table Styling --- */
.forecast-table thead th {
    background-color: #3b429f; /* Blue from your image */
    color: white;
}

.forecast-table tbody td {
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
}

.forecast-table tbody td strong {
    color: #f0f0f0; /* Slightly brighter for emphasis */
    font-weight: 600;
}

    </style>
</head>

<body>
    <div class="main-content">
        <canvas id="threeJsCanvas"></canvas>
        <div id="wsStatus" class="ws-status disconnected">Disconnected</div>

        <nav class="bg-black/10 backdrop-blur-sm p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <a href="#" class="text-2xl font-bold text-white nav-link" data-page="home">S.A.G.E.</a>
                <div>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link"
                        data-page="home">Home</a>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link"
                        data-page="login">Login</a>
                </div>
            </div>
        </nav>

        <div id="versionChoiceModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
            <div class="glass-container w-full max-w-lg text-center">
                <h2 class="text-3xl font-bold mb-4">Choose Your Version</h2>
                <p class="text-white/80 mb-8">Select a version to proceed with your analysis.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="selectFreeVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Free Version</h3>
                        <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Basic analysis</li>
                            <li>Select 1 of 8 frameworks</li>
                        </ul>
                    </div>
                    <div id="selectPaidVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Paid Version</h3>
                         <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Comprehensive analysis</li>
                            <li>Select up to 3 of 8 frameworks</li>
                        </ul>
                    </div>
                </div>
                 <button id="closeModalBtn" class="btn btn-secondary mt-8">Cancel</button>
            </div>
        </div>

        <div id="home" class="page active container mx-auto px-6 py-16">
            <div class="text-center">
                <h1 class="text-5xl md:text-6xl font-extrabold text-white leading-tight mb-4">Unlock Your Strategic Potential</h1>
                <p class="text-lg md:text-xl text-white/80 max-w-3xl mx-auto mb-8">
                    Select a category to explore our comprehensive suite of strategic planning tools and methodologies.
                </p>
            </div>
            
            <div id="homeTabsNav" class="flex flex-wrap justify-center space-x-1 md:space-x-2 border-b-2 border-white/10 mt-16 mb-12">
                <button class="home-tab-btn active" data-tab="strategicPlanning">Strategic Planning</button>
                <button class="home-tab-btn" data-tab="systemThinking">System Thinking</button>
                <button class="home-tab-btn" data-tab="novelStrategies">Novel Strategies</button>
                <button class="home-tab-btn" data-tab="dataAnalysis">Data Analysis</button>
            </div>

            <div id="homeTabsContent">
                <div id="strategicPlanning" class="home-tab-panel active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="mission-vision">
                        <h3 class="text-xl font-bold mb-2">Mission Vision</h3><p class="text-white/70 text-sm">Define your organization's core purpose and future aspirations.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="factor-analysis">
                        <h3 class="text-xl font-bold mb-2">Factor Analysis</h3><p class="text-white/70 text-sm">Assess internal strengths and weaknesses & external opportunities and threats.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="swot-tows">
                        <h3 class="text-xl font-bold mb-2">Swot/Tows Analysis</h3><p class="text-white/70 text-sm">Develop strategies by matching internal factors to external factors.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="goals-initiatives">
                        <h3 class="text-xl font-bold mb-2">Goals & Strategic Initiatives</h3><p class="text-white/70 text-sm">Set high-level goals and the key initiatives to achieve them.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="objectives">
                        <h3 class="text-xl font-bold mb-2">Objectives</h3><p class="text-white/70 text-sm">Formulate specific, measurable, achievable, relevant, and time-bound objectives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="action-plans">
                        <h3 class="text-xl font-bold mb-2">Action Plans</h3><p class="text-white/70 text-sm">Detail the resources, tasks, and timelines required for execution.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="kpi-events">
                        <h3 class="text-xl font-bold mb-2">KPI & Critical Events</h3><p class="text-white/70 text-sm">Define key performance indicators and track critical milestones.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="misc-summary">
                        <h3 class="text-xl font-bold mb-2">Misc</h3><p class="text-white/70 text-sm">Compile summaries, risk assessments, governance, and conclusions.</p>
                    </div>
                </div>

                <div id="systemThinking" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="process-mapping">
                        <h3 class="text-xl font-bold mb-2">Process Mapping</h3><p class="text-white/70 text-sm">Visualize and analyze the flow of activities in a process.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="pareto-fishbone">
                        <h3 class="text-xl font-bold mb-2">Fishbone/Pareto Analysis</h3><p class="text-white/70 text-sm">Identify root causes and prioritize the most significant issues.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-thinking-analysis">
                        <h3 class="text-xl font-bold mb-2">System Thinking Analysis</h3><p class="text-white/70 text-sm">Understand the complex interconnections within your organization.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="leverage-points">
                        <h3 class="text-xl font-bold mb-2">Leverage Points</h3><p class="text-white/70 text-sm">Identify areas where small changes can yield significant results.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="archetype-analysis">
                        <h3 class="text-xl font-bold mb-2">Archetypes Analysis</h3><p class="text-white/70 text-sm">Recognize and address recurring patterns of behavior in your system.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-goals-initiatives">
                        <h3 class="text-xl font-bold mb-2">Goals/Strategic Initiatives</h3><p class="text-white/70 text-sm">Align system-level goals with broader strategic initiatives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-objectives">
                        <h3 class="text-xl font-bold mb-2">Objectives</h3><p class="text-white/70 text-sm">Define clear objectives for improving system performance.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-actions">
                        <h3 class="text-xl font-bold mb-2">Actions</h3><p class="text-white/70 text-sm">Outline concrete actions to implement system-level changes.</p>
                    </div>
                </div>
                
                <div id="novelStrategies" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="novel-goals-initiatives">
                        <h3 class="text-2xl font-bold mb-2">Goals & Strategic Initiatives</h3><p class="text-white/70">Define ambitious goals and innovative initiatives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="all-framework">
                        <h3 class="text-2xl font-bold mb-2">All Framework</h3><p class="text-white/70">Access a comprehensive suite of strategic frameworks.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="creative-dissonance">
                        <h3 class="text-2xl font-bold mb-2">Creative Dissonance</h3><p class="text-white/70">Leverage the gap between vision and reality to spark innovation.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="living-system">
                        <h3 class="text-2xl font-bold mb-2">Living System</h3><p class="text-white/70">Apply principles of living systems to foster organizational adaptability.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="thinking-system">
                        <h3 class="text-2xl font-bold mb-2">Thinking System</h3><p class="text-white/70">Develop a holistic approach to problem-solving and decision-making.</p>
                    </div>
                </div>

                <div id="dataAnalysis" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="descriptive-analysis"><h3 class="text-xl font-bold mb-2">Descriptive</h3><p class="text-white/70 text-sm">Summarize historical data to understand what has happened.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="predictive-analysis"><h3 class="text-xl font-bold mb-2">Predictive</h3><p class="text-white/70 text-sm">Use statistical models to forecast future outcomes.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="prescriptive-analysis"><h3 class="text-xl font-bold mb-2">Prescriptive</h3><p class="text-white/70 text-sm">Advise on possible outcomes and recommend actions.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="visualization"><h3 class="text-xl font-bold mb-2">Visualization</h3><p class="text-white/70 text-sm">Create graphical representations of data for insights.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="regression-analysis"><h3 class="text-xl font-bold mb-2">Regression</h3><p class="text-white/70 text-sm">Model relationships between variables for prediction.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="pls-analysis"><h3 class="text-xl font-bold mb-2">PLS</h3><p class="text-white/70 text-sm">Apply Partial Least Squares for structural equation modeling.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="sem-analysis"><h3 class="text-xl font-bold mb-2">SEM</h3><p class="text-white/70 text-sm">Structural Equation Modeling for complex variable relationships.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="dematel-analysis"><h3 class="text-xl font-bold mb-2">DEMATEL</h3><p class="text-white/70 text-sm">Understand causal relationships between complex factors.</p></div>
                </div>
            </div>
        </div>
        
        <div id="about" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">How to Use S.A.G.E.</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">A Step-by-Step Guide to Unleashing Your Strategic Potential</p>
            <div class="max-w-4xl mx-auto space-y-8">
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 1:</span> Get Started (Login/Sign Up)</h3>
                    <p class="text-white/80">To unlock the full power of S.A.G.E., including saving your projects and using premium templates, you'll need an account. Click the "Login" button in the navigation bar. If you're new, you can create an account in just a few clicks.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 2:</span> Choose Your Template</h3>
                    <p class="text-white/80">From the Home page, browse through the categories like "Strategic Plans" or "Frameworks". Select the template that best fits your objective by clicking on its card.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 3:</span> Select Your Version</h3>
                    <p class="text-white/80">After choosing a template, a modal will appear. You can select the "Free Version" for a basic analysis using one framework, or the "Paid Version" to conduct a more comprehensive analysis with up to three different frameworks.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 4:</span> Provide Context & Select Options</h3>
                    <p class="text-white/80">On the template detail page, fill in the required information, such as your company name and upload your company documents. This context is crucial for the AI to generate a relevant analysis. Below the inputs, select your desired analysis sections and analytical framework(s).</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 5:</span> Generate & Review Your Analysis</h3>
                    <p class="text-white/80">Click the "Generate Analysis" button. S.A.G.E.'s AI will process your inputs and selected frameworks, which may take a few minutes. The complete, structured analysis will appear in the results panel on the right side of the screen.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 6:</span> Save & Export Your Work</h3>
                    <p class="text-white/80">Once your analysis is generated, action buttons will appear below the result. You can export the analysis as a PDF or DOCX file for easy sharing and integration into your reports.</p>
                </div>
            </div>
        </div>

        <div id="login" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Sign In</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="loginEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="loginEmail" class="input-field" placeholder="Enter your email" required>
                        </div>
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="loginPassword" class="input-field" placeholder="Enter your password"
                                required>
                        </div>
                        <button id="loginBtn" class="btn btn-primary w-full">
                            <span id="loginBtnText">Sign In</span>
                            <span id="loginSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="loginMessage" class="hidden"></div>
                    </div>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Don't have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="signup">Create Account</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="signup" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Create Account</h2>
                    <form id="registerForm" class="space-y-4">
                        <div>
                            <label for="registerFirstName" class="block text-sm font-medium text-gray-200 mb-2">First
                                Name</label>
                            <input type="text" id="registerFirstName" class="input-field"
                                placeholder="Enter your First Name" required>
                        </div>
                        <div>
                            <label for="registerLastName" class="block text-sm font-medium text-gray-200 mb-2">Last
                                Name</label>
                            <input type="text" id="registerLastName" class="input-field" placeholder="Enter your Last Name"
                                required>
                        </div>
                        <div>
                            <label for="registerEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="registerEmail" class="input-field" placeholder="Enter your email"
                                required>
                        </div>
                        <div>
                            <label for="registerPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="registerPassword" class="input-field" placeholder="Create a password"
                                required>
                        </div>
                        <div>
                            <label for="registerConfirmPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Confirm Password</label>
                            <input type="password" id="registerConfirmPassword" class="input-field"
                                placeholder="Confirm your password" required>
                        </div>
                        <button type="button" id="registerBtn" class="btn btn-primary w-full">
                            <span id="registerBtnText">Create Account</span>
                            <span id="registerSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="registerMessage" class="hidden"></div>
                    </form>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Already have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="login">Sign In</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="emailVerification" class="page flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container text-center">
                    <h2 class="text-3xl font-bold mb-6 text-white">Check Your Email</h2>
                    <p class="text-white/80 mb-6">Thank you for registering! We've sent a verification link to your email address. Please check your inbox and click the link to complete your registration.</p>
                    <p class="text-white/60 text-sm mb-6">Don't forget to check your spam folder.</p>
                    <div class="text-center">
                        <button class="btn-tertiary nav-link" data-page="login">Return to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="templateDetail" class="page container mx-auto px-6 py-16">
            <button class="btn btn-secondary mb-8 nav-link" data-page="home">&larr; Back to Home</button>
            <div id="templateDetailContent" class="grid lg:grid-cols-2 gap-12">
                </div>
        </div>

        <div id="adminDashboard" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">Admin Dashboard</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Live analytics for S.A.G.E.</p>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Users Online</h3>
                    <p id="dashUsersOnline" class="text-4xl font-bold"></p>
                    <p class="text-white/60 text-sm mt-2">Approximate active visitors.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Total Queries</h3>
                    <p id="dashQueryCount" class="text-4xl font-bold">0</p>
                    <p class="text-white/60 text-sm mt-2">From live database stats.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Server Status</h3>
                    <div class="flex items-center gap-3">
                        <span id="dashServerDot" class="inline-block w-3 h-3 rounded-full bg-yellow-400"></span>
                        <span id="dashServerText">Checking</span>
                    </div>
                    <p class="text-white/60 text-sm mt-2">Reflects WebSocket connection.</p>
                </div>
            </div>

            <div class="glass-container mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Live Database Statistics</h3>
                    <button id="refreshStatsBtn" class="btn btn-primary">
                        <span id="refreshStatsBtnText">Refresh Stats</span>
                        <span id="refreshStatsSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                </div>

                <div id="statisticsContainer" class="grid md:grid-cols-2 gap-x-8 gap-y-4 text-white/90">
                    <div>
                        <h4 class="text-xl font-semibold mb-3 border-b border-white/20 pb-2">Database Status</h4>
                        <ul class="space-y-2">
                            <li><strong>Total Users:</strong> <span id="statTotalUsers"></span></li>
                            <li><strong>Active Users (1h):</strong> <span id="statActiveUsers"></span></li>
                            <li><strong>Total Queries:</strong> <span id="statTotalQueries"></span></li>
                            <li><strong>Database Size:</strong> <span id="statDbSize"></span></li>
                            <li><strong>Avg. Processing Time:</strong> <span id="statAvgTime"></span></li>
                            <li><strong>Last Recorded:</strong> <span id="statRecordedAt"></span></li>
                        </ul>
                    </div>
                    <div id="pineconeStatsContainer" class="hidden">
                        <h4 class="text-xl font-semibold mb-3 border-b border-white/20 pb-2">Vector Store Status</h4>
                        <ul class="space-y-2">
                            <li><strong>Index Name:</strong> <span id="statPineconeName"></span></li>
                            <li><strong>Total Vectors:</strong> <span id="statTotalVectors"></span></li>
                            <li><strong>Book Vectors:</strong> <span id="statBookVectors"></span></li>
                            <li><strong>Dimension:</strong> <span id="statPineconeDimension"></span></li>
                            <li><strong>Status:</strong> <span id="statPineconeStatus"></span></li>
                            <li><strong>Cloud/Region:</strong> <span id="statPineconeCloud"></span></li>
                        </ul>
                    </div>
                </div>
                <div id="statsMessage" class="hidden mt-4"></div>
            </div>
        </div>

        <div id="examplesPage" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">AI Analysis Examples</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">See how S.A.G.E. can transform complex data
                into actionable strategic insights with these example outputs.</p>

            <div id="analysisCarousel" class="relative max-w-4xl mx-auto glass-container p-0">
                <div class="analysis-example-item">
                    <h2 class="text-3xl font-bold mb-4">Example: SWOT Analysis for "GlobalTech Solutions"</h2>
                    <div class="text-white/70">
                        <h3>STRENGTHS:</h3>
                        <ul>
                            <li><strong>Strong R&D Department:</strong> GlobalTech consistently innovates, holding numerous
                                patents in AI and quantum computing.</li>
                            <li><strong>Global Presence:</strong> Established offices and client base across North America,
                                Europe, and Asia.</li>
                            <li><strong>Talented Workforce:</strong> Highly skilled engineers and data scientists, fostering
                                a culture of excellence.</li>
                        </ul>

                        <h3>WEAKNESSES:</h3>
                        <ul>
                            <li><strong>High Operating Costs:</strong> Extensive R&D and global infrastructure lead to
                                significant overheads.</li>
                            <li><strong>Limited Marketing Reach:</strong> Reliance on word-of-mouth and niche industry
                                events, missing broader market segments.</li>
                            <li><strong>Bureaucratic Processes:</strong> Slow decision-making due to multi-layered approval
                                systems.</li>
                        </ul>

                        <h3>OPPORTUNITIES:</h3>
                        <ul>
                            <li><strong>Emerging Markets:</strong> Untapped potential in developing economies for AI-driven
                                solutions.</li>
                            <li><strong>Strategic Partnerships:</strong> Collaboration with hardware manufacturers to integrate
                                    AI software.</li>
                            <li><strong>Government Grants:</strong> Increased funding for AI research and development
                                initiatives.</li>
                        </ul>

                        <h3>THREATS:</h3>
                        <ul>
                            <li><strong>Intense Competition:</strong> Rapidly evolving tech landscape with new startups and
                                established giants.</li>
                            <li><strong>Talent Drain:</strong> High demand for skilled AI professionals leading to
                                competitive recruitment.</li>
                            <li><strong>Regulatory Changes:</strong> Evolving data privacy and AI ethics regulations
                                impacting product development.</li>
                        </ul>

                        <h3>Strategic Recommendations:</h3>
                        <ol>
                            <li><strong>Optimize Cost Structure:</strong> Implement agile methodologies to reduce R&D cycle
                                times and explore automation in operational processes.</li>
                            <li><strong>Expand Marketing Channels:</strong> Invest in digital marketing and content strategy
                                to reach a wider audience and enhance brand visibility.</li>
                            <li><strong>Forge Key Alliances:</strong> Actively pursue partnerships with complementary
                                technology providers to expand market reach and product offerings.</li>
                        </ol>
                    </div>
                </div>

                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Market Entry Strategy for "EcoCycle Innovations" into
                        Southeast Asia</h2>
                    <div class="text-white/70">
                        <h3>MARKET ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Market Size & Growth:</strong> Southeast Asia's recycling and waste management
                                market is projected to grow at a CAGR of 8% over the next five years, driven by increasing
                                environmental awareness and government initiatives.</li>
                            <li><strong>Customer Segments:</strong> Key segments include industrial waste generators,
                                municipal waste facilities, and commercial enterprises seeking sustainable solutions.</li>
                            <li><strong>Market Maturity:</strong> Varies by country; Singapore and Malaysia are more mature,
                                while Vietnam and Indonesia are emerging.</li>
                        </ul>

                        <h3>COMPETITIVE LANDSCAPE:</h3>
                        <ul>
                            <li><strong>Key Players:</strong> Dominated by local players with strong government ties and a
                                few international waste management giants.</li>
                            <li><strong>Competitive Advantages:</strong> Local players often have lower operational costs
                                and established networks. EcoCycle's advanced waste-to-energy technology offers a unique
                                value proposition.</li>
                        </ul>

                        <h3>ENTRY STRATEGY OPTIONS:</h3>
                        <ol>
                            <li><strong>Joint Venture (JV) with Local Partner:</strong> Recommended approach. A JV allows
                                EcoCycle to leverage local expertise, navigate regulatory complexities, and gain immediate
                                market access.
                                <ul>
                                    <li><strong>Pros:</strong> Reduced risk, faster market penetration, access to local
                                        networks.</li>
                                    <li><strong>Cons:</strong> Potential for cultural clashes, profit sharing.</li>
                                </ul>
                            </li>
                            <li><strong>Greenfield Investment:</strong> Building new facilities.
                                <ul>
                                    <li><strong>Pros:</strong> Full control, tailor-made operations.</li>
                                    <li><strong>Cons:</strong> High capital investment, long lead times, significant
                                        regulatory hurdles.</li>
                                </ul>
                            </li>
                        </ol>

                        <h3>Implementation Roadmap:</h3>
                        <ul>
                            <li><strong>Phase 1 (Months 1-6):</strong> Partner identification and due diligence. Focus on
                                countries with favorable regulatory environments (e.g., Malaysia, Thailand).</li>
                            <li><strong>Phase 2 (Months 7-18):</strong> JV formation and pilot project initiation. Secure
                                initial contracts with industrial clients.</li>
                            <li><strong>Phase 3 (Months 19-36):</strong> Scale operations, expand service offerings, and explore
                                    opportunities in other SEA markets.</li>
                        </ul>
                    </div>
                </div>

                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Digital Transformation Roadmap for "RetailX"</h2>
                    <div class="text-white/70">
                        <h3>VISION & OBJECTIVES:</h3>
                        <ul>
                            <li><strong>Vision:</strong> To become a leading omnichannel retailer, leveraging digital
                                technologies to enhance customer experience, optimize operations, and drive sustainable
                                growth.</li>
                            <li><strong>Objectives:</strong> Increase online sales by 30% within 2 years, reduce operational
                                costs by 15% through automation, and improve customer satisfaction scores by 20%.</li>
                        </ul>

                        <h3>CURRENT STATE ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Digital Capabilities:</strong> Fragmented legacy systems, limited e-commerce
                                capabilities, manual inventory management.</li>
                            <li><strong>Pain Points:</strong> Inconsistent customer experience across channels, inefficient
                                supply chain, lack of real-time data for decision-making.</li>
                        </ul>

                        <h3>KEY PILLARS OF TRANSFORMATION:</h3>
                        <ol>
                            <li><strong>Customer Experience:</strong> Unify online and offline channels, personalize
                                customer journeys.</li>
                            <li><strong>Operational Efficiency:</strong> Automate back-office processes, optimize supply
                                chain.</li>
                            <li><strong>Data & Analytics:</strong> Implement robust data infrastructure, leverage AI for
                                insights.</li>
                            <li><strong>Culture & Talent:</strong> Foster digital-first mindset, upskill workforce.</li>
                        </ol>

                        <h3>INITIATIVES & TECHNOLOGIES:</h3>
                        <ul>
                            <li><strong>Customer Experience:</strong> CRM implementation (Salesforce), E-commerce platform
                                upgrade (Shopify Plus), AI-powered chatbots.</li>
                            <li><strong>Operational Efficiency:</strong> ERP system integration (SAP), Warehouse Management
                                System (WMS), Robotic Process Automation (RPA) for routine tasks.</li>
                            <li><strong>Data & Analytics:</strong> Data Lake/Warehouse (Snowflake), Business Intelligence
                                tools (Tableau), Predictive Analytics.</li>
                            <li><strong>Culture & Talent:</strong> Digital literacy training, change management programs.</li>
                        </ul>

                        <h3>PHASED IMPLEMENTATION PLAN:</h3>
                        <ul>
                            <li><strong>Short-term (0-6 months):</strong> CRM implementation, basic e-commerce upgrade,
                                pilot RPA for finance.</li>
                            <li><strong>Mid-term (6-18 months):</strong> Full ERP integration, advanced e-commerce features,
                                initial data lake setup, comprehensive digital training.</li>
                            <li><strong>Long-term (18+ months):</strong> AI-driven personalization, predictive supply chain,
                                expansion into new digital services.</li>
                        </ul>

                        <h3>MEASUREMENT & KPIs:</h3>
                        <ul>
                            <li>Online Conversion Rate, Customer Lifetime Value, Order Fulfillment Time, Inventory Accuracy,
                                Employee Digital Proficiency.</li>
                        </ul>
                    </div>
                </div>

                <button id="prevExampleBtn" class="carousel-button left">&larr;</button>
                <button id="nextExampleBtn" class="carousel-button right">&rarr;</button>
            </div>
            <div class="text-center text-white/80 mt-4">
                <span id="exampleCounter">1 of 3</span>
            </div>

            <div class="text-center mt-12">
                 <button class="btn btn-primary nav-link" data-page="home">Back to Tools</button>
            </div>
        </div>

    </div>

    <footer class="mt-auto py-8">
        <div class="container mx-auto text-center text-white/70">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="hover:text-white nav-link" data-page="about">About</a>
                <a href="#" class="hover:text-white nav-link" data-page="adminDashboard">Admin Dashboard</a>
            </div>
            <p>&copy; 2025 S.A.G.E. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // js2.js
// =========================================================
// SCRIPT
// =========================================================
document.addEventListener("DOMContentLoaded", () => {
    // --- Supabase Configuration ---
    const SUPABASE_URL = "https://supabase.data2int.com";
    const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNjQwOTk1MjAwLCJleHAiOjE5NTYzNTUyMDB9.KHXKQpsN6MNB08H_IPxP4Gh0gjcsvXG9IeJuK3XpnAU";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- DOM Element References ---
    const $ = (id) => document.getElementById(id);
    const pages = document.querySelectorAll(".page");
    let currentTemplateId = null;
    let websocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectDelay = 3000;
    let pendingAnalysisRequests = new Map();

    // --- User Session State ---
    let userLoggedIn = false;
    let currentUser = null;

    // --- Version Control State ---
    let currentSelectionLimit = 3; // Default to paid
    let selectedTemplateForModal = null;
    let preFillData = ""; // Used to pass context from home card to template detail

    // --- Analysis Cache ---
    const analysisCache = {};

    // --- Template Data ---
    const templates = {
        "custom-template": {
            title: "Custom Strategy Generator",
            description: "Design your own strategic analysis by defining the type of strategy, company, and location.",
            isPremium: true
        },
        "vision-mission-goals": {
            title: "Vision & Mission Planning",
            description: "A unified tool to define your organization's guiding purpose, future state, and core goals."
        },
        swot: {
            title: "SWOT Analysis",
            description: "Analyze your organization's Strengths, Weaknesses, Opportunities, and Threats."
        },
        "swot-tows": {
            title: "SWOT/TOWS Analysis",
            description:
                "Develop strategies by matching internal factors (Strengths, Weaknesses) to external factors (Opportunities, Threats)."
        },
        "pareto-fishbone": {
            title: "Pareto & Fishbone Analysis",
            description:
                "A combined approach to identify the root causes of problems (Fishbone) and prioritize them based on impact (Pareto)."
        },
        "external-analysis": {
            title: "External Analysis",
            description:
                "Analyze the external environment (market, competition, trends) to identify opportunities and threats."
        },
        "internal-analysis": {
            title: "Internal Analysis",
            description:
                "Evaluate your organization's internal strengths and weaknesses in resources, capabilities, and core competencies."
        },
        "advanced-system-analysis": {
            title: "Advanced System Analysis",
            description:
                "Model complex systems to understand interdependencies, feedback loops, and high-leverage intervention points."
        },
        "archetype-analysis": {
            title: "Archetype Analysis",
            description:
                "Identify and analyze recurring patterns of behavior (archetypes) within your system or market."
        },
        "creative-dissonance": {
            title: "Creative Dissonance Analysis",
            description:
                "Explore the gap between your current reality and desired future to fuel innovation and strategic change."
        },
        "reframing-thinking": {
            title: "Reframing Thinking Analysis",
            description:
                "Apply the reframing technique to look at problems from new perspectives and unlock creative solutions."
        },
        "delphi-method": {
            title: "Delphi Method Analysis",
            description:
                "Utilize the Delphi method to gather and synthesize expert opinions for forecasting and decision-making."
        },
        "blue-ocean": {
            title: "Blue Ocean Strategy",
            description: "Focuses on creating uncontested market space rather than competing in existing industries."
        },
        "design-thinking": {
            title: "Design Thinking",
            description: "A human-centered, iterative process for creative problem-solving and innovation."
        },
        "thinking-hats": {
            title: "Thinking Hats Analysis",
            description: "Apply Edward de Bono's system for parallel thinking to explore an issue comprehensively."
        },
        scamper: {
            title: "SCAMPER Analysis",
            description:
                "A creative thinking technique using seven prompts (Substitute, Combine, Adapt, Modify, Put to another use, Eliminate, Reverse) to innovate."
        },
        triz: {
            title: "TRIZ Analysis",
            description:
                "A systematic approach based on the study of global patent patterns to find innovative solutions to technical problems."
        },
        "regression-analysis": {
            title: "Regression Analysis",
            description:
                "Use statistical regression to model and analyze the relationships between variables for predictive insights."
        },
        "pls-analysis": {
            title: "PLS Analysis",
            description:
                "Apply Partial Least Squares (PLS) for structural equation modeling, especially with complex models and non-normal data."
        },
        "dematel-analysis": {
            title: "Dematel Analysis",
            description:
                "Understand causal relationships between complex factors to identify core problems and effective leverage points."
        },
        competitor: {
            title: "Competitor Analysis",
            description: "Deep dive into competitor strategies, market positioning, and competitive advantages."
        },
        "market-entry": {
            title: "Market Entry Strategy",
            description: "Evaluate market opportunities, entry barriers, and develop a roadmap for market penetration."
        },
        risk: {
            title: "Risk Assessment",
            description: "Identify, evaluate, and develop mitigation strategies for business risks."
        },
        "business-model": {
            title: "Business Model Canvas",
            description: "Design and analyze your business model using the proven 9-building-block framework."
        },
        "digital-transformation": {
            title: "Digital Transformation Roadmap",
            description: "Plan your organization's journey towards digital maturity."
        },
        "predictive-analysis": {
            title: "Predictive Analysis",
            description:
                "Upload your dataset (e.g., CSV) to forecast future trends and outcomes based on historical data."
        }
    };

    // --- Template UI Rules ---
    const templateRules = {
        "thinking-system": { useThinkingSystemLayout_NS: true },
        "sem-analysis": { useSemAnalysisLayout: true },
        "predictive-analysis": { usePredictiveAnalysisLayout: true },
        "living-system": { useLivingSystemLayout_NS: true },
        "creative-dissonance": { useCreativeDissonanceLayout_NS: true },
        "system-actions": { useSystemActionsLayout_ST: true },
        "system-objectives": { useSystemObjectivesLayout_ST: true },
        "descriptive-analysis": { useDescriptiveLayout_DA: true },
        visualization: { useVisualizationLayout_DA: true },
        "pls-analysis": { usePlsLayout_DA: true },
        "mission-vision": { hideAnalysisSection: true, hideFrameworks: true },
        "regression-analysis": { useRegressionLayout_DA: true },
        "novel-goals-initiatives": { useNovelGoalsLayout_NS: true },
        "misc-summary": { useMiscLayout_MSC: true },
        "kpi-events": { useKpiLayout_KE: true },
        "action-plans": { useActionPlansLayout_AP: true },
        objectives: { hideAnalysisSection: true, hideFrameworks: true },
        "goals-initiatives": { useGoalsAndInitiativesLayout_SP: true },
        swot: { hideAnalysisSection: true },
        "swot-tows": { useSwotLayout: true },
        "leverage-points": { useLeveragePointsLayout: true },
        "system-goals-initiatives": { useSystemGoalsLayout: true },
        "archetype-analysis": { useArchetypeLayout: true },
        "factor-analysis": { useFactorAnalysisLayout: true },
        "process-mapping": { useProcessMappingLayout: true },
        "system-thinking-analysis": { useSystemThinkingLayout: true },
        competitor: { hideAnalysisSection: true },
        "market-entry": { hideAnalysisSection: true },
        risk: { hideAnalysisSection: true },
        "pareto-fishbone": { useParetoLayout: true, hideAnalysisSection: true, hideFrameworks: true },
        "external-analysis": { hideAnalysisSection: true },
        "internal-analysis": { hideAnalysisSection: true },
        "prescriptive-analysis": { usePrescriptiveLayout_DA: true },
        "dematel-analysis": { useDematelLayout: true },
        "digital-transformation": { hideAnalysisSection: true },
        "delphi-method": { preselectFramework: "Delphi Method", hideAnalysisSection: true },
        "blue-ocean": { preselectFramework: "Blue Ocean Strategy", hideAnalysisSection: true },
        "design-thinking": { preselectFramework: "Design Thinking", hideAnalysisSection: true },
        "thinking-hats": { preselectFramework: "Thinking Hats", hideAnalysisSection: true },
        "business-model": { preselectFramework: "Business Model Canvas", hideAnalysisSection: true },
        scamper: { preselectFramework: "SCAMPER", hideAnalysisSection: true },
        triz: { preselectFramework: "TRIZ (Theory of Inventive Problem Solving)", hideAnalysisSection: true },
        "reframing-thinking": { preselectFramework: "Reframing Thinking", hideAnalysisSection: true }
    };

    // WebSocket Management Functions
    function initializeWebSocket() {
        const wsStatus = document.getElementById("wsStatus");

        try {
            websocket = new WebSocket("wss://n8n-api.data2int.com/ws");

            wsStatus.textContent = "Connecting...";
            wsStatus.className = "ws-status connecting";

            websocket.onopen = function (event) {
                console.log("WebSocket connected successfully");
                wsStatus.textContent = "Connected";
                wsStatus.className = "ws-status connected";
                reconnectAttempts = 0;
            };

            websocket.onmessage = function (event) {
                console.log("Received WebSocket message:", event.data);

                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error("Error parsing WebSocket message:", error);
                }
            };

            websocket.onclose = function (event) {
                console.log("WebSocket connection closed:", event.code, event.reason);
                wsStatus.textContent = "Disconnected";
                wsStatus.className = "ws-status disconnected";

                if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        console.log(`WebSocket reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                        initializeWebSocket();
                    }, reconnectDelay);
                }
            };

            websocket.onerror = function (error) {
                console.error("WebSocket error:", error);
                wsStatus.textContent = "Error";
                wsStatus.className = "ws-status disconnected";
            };
        } catch (error) {
            console.error("Failed to initialize WebSocket:", error);
            wsStatus.textContent = "Failed";
            wsStatus.className = "ws-status disconnected";
        }
    }

   // =========================================================
    // ===== REVISED EXPORT FUNCTIONS (Using html2canvas) =====
    // =========================================================

    // --- REVISED PDF Export Logic (Image-based) ---
    async function handleSaveAsPdf(filename = "SAGE_Analysis.pdf") {
        // 1. Check Libraries
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
            alert("Error: jsPDF library not loaded."); return;
        }
        if (typeof window.html2canvas === 'undefined') {
            alert("Error: html2canvas library not loaded."); return;
        }

        const { jsPDF } = window.jspdf;
        const analysisResultElement = $("analysisResult");

        if (!analysisResultElement || !analysisResultElement.hasChildNodes() || analysisResultElement.innerText.includes("Your generated analysis will appear here.")) {
            alert("No analysis content found to save.");
            return;
        }

        alert("Preparing PDF screenshot... Please wait.");
        console.log("Starting PDF generation via html2canvas...");

        try {
            // 2. Use html2canvas to capture the element
            const canvas = await html2canvas(analysisResultElement, {
                scale: 2, // Increase scale for better resolution
                useCORS: true, // If you ever load images from other domains
                logging: true // Enable logging for debugging
            });

            console.log("Canvas generated from HTML content.");

            // 3. Convert canvas to image data
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;

            // 4. Create PDF and add image (potentially sliced)
            const doc = new jsPDF({
                orientation: imgWidth > imgHeight ? 'l' : 'p', // Use landscape if wider
                unit: 'pt',
                format: 'a4'
            });

            const pdfPageWidth = doc.internal.pageSize.getWidth();
            const pdfPageHeight = doc.internal.pageSize.getHeight();
            const margin = 20; // Small margin for image

            // Calculate image dimensions to fit page width
            const availableWidth = pdfPageWidth - margin * 2;
            const availableHeight = pdfPageHeight - margin * 2;

            const aspectRatio = imgHeight / imgWidth;
            let pdfImgWidth = availableWidth;
            let pdfImgHeight = pdfImgWidth * aspectRatio;

            // If scaled image is taller than available page height, scale based on height instead
            if (pdfImgHeight > availableHeight) {
                pdfImgHeight = availableHeight;
                pdfImgWidth = pdfImgHeight / aspectRatio;
            }

            // Calculate how many pages are needed based on the *original* canvas height
            // relative to the scaled height that fits *within* one PDF page.
            const totalPdfHeight = (imgHeight / imgWidth) * pdfImgWidth; // Total height the image would occupy in PDF units if not sliced
            const pageHeightToFitOneSlice = pdfImgHeight; // The height of one slice as it appears on the PDF page
            const numPages = Math.ceil(totalPdfHeight / pageHeightToFitOneSlice);


             console.log(`Original Canvas: ${imgWidth}x${imgHeight} | PDF Image Size per page: ${pdfImgWidth.toFixed(0)}x${pageHeightToFitOneSlice.toFixed(0)} | Total PDF Height: ${totalPdfHeight.toFixed(0)} | Pages: ${numPages}`);

            // Add image slices page by page
            let currentCanvasY = 0; // Position on the source canvas
            for (let i = 1; i <= numPages; i++) {
                if (i > 1) {
                    doc.addPage();
                }
                // Calculate the portion of the canvas to draw for this page
                const sourceHeight = Math.min(imgHeight - currentCanvasY, (pageHeightToFitOneSlice / pdfImgWidth) * imgWidth); // Height on original canvas for this slice

                // Create a temporary canvas for the slice
                const sliceCanvas = document.createElement('canvas');
                sliceCanvas.width = imgWidth;
                sliceCanvas.height = sourceHeight;
                const sliceCtx = sliceCanvas.getContext('2d');

                // Draw the slice from the main canvas
                sliceCtx.drawImage(canvas, 0, currentCanvasY, imgWidth, sourceHeight, 0, 0, imgWidth, sourceHeight);

                const sliceDataUrl = sliceCanvas.toDataURL('image/png');

                 // Add the slice image to the PDF page
                 const slicePdfHeight = (sourceHeight / imgWidth) * pdfImgWidth; // Calculate height of this slice in PDF units
                 doc.addImage(sliceDataUrl, 'PNG', margin, margin, pdfImgWidth, slicePdfHeight);

                currentCanvasY += sourceHeight; // Move to the next slice position
                 console.log(`Added page ${i}/${numPages}. Slice height (canvas): ${sourceHeight.toFixed(0)}, Slice height (pdf): ${slicePdfHeight.toFixed(0)}`);
            }


            console.log("Adding image(s) to PDF complete.");

            // 5. Save the PDF
            doc.save(filename);
            console.log("PDF saved successfully.");

        } catch (error) {
            console.error("!!! Error generating PDF with html2canvas:", error);
            alert("Failed to generate PDF. Check console for details. Ensure content is visible.");
        }
    }


    // --- REVISED DOCX Export Logic (Image-based) ---
    async function handleSaveAsDocx(filename = "SAGE_Analysis.docx") {
        // 1. Check Libraries
        if (typeof window.docx === 'undefined' || typeof window.docx.Document === 'undefined' || typeof window.docx.Packer === 'undefined') {
            alert("Error: docx library not loaded."); return;
        }
        if (typeof window.saveAs === 'undefined') {
            alert("Error: FileSaver.js library not loaded."); return;
        }
        if (typeof window.html2canvas === 'undefined') {
            alert("Error: html2canvas library not loaded."); return;
        }

        const { Document, Packer, Paragraph, ImageRun, AlignmentType, convertInchesToTwip } = window.docx;
        const saveAs = window.saveAs;
        const analysisResultElement = $("analysisResult");

        if (!analysisResultElement || !analysisResultElement.hasChildNodes() || analysisResultElement.innerText.includes("Your generated analysis will appear here.")) {
            alert("No analysis content found to save.");
            return;
        }

        alert("Preparing DOCX screenshot... Please wait.");
        console.log("Starting DOCX generation via html2canvas...");

        try {
            // 2. Use html2canvas to capture the element
            const canvas = await html2canvas(analysisResultElement, {
                scale: 2, // Higher resolution
                useCORS: true,
                logging: true
            });
            console.log("Canvas generated from HTML content.");

            // 3. Convert canvas to image buffer for docx
            const dataUrl = canvas.toDataURL('image/png');
            const base64Data = dataUrl.split(',')[1];
            const imageBuffer = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));

            // 4. Create DOCX Document with the image
            // A4 paper is approx 8.27 x 11.69 inches. Margins typically 1 inch.
            // Available width approx 6.27 inches. Let's use 6.0 for a bit more margin.
            const docPageWidthTwips = convertInchesToTwip(6.0);
            const aspectRatio = canvas.height / canvas.width;
            const imageWidthTwips = docPageWidthTwips;
            const imageHeightTwips = imageWidthTwips * aspectRatio;

             console.log(`Adding image to DOCX. DOCX Width (Twips): ${imageWidthTwips}, DOCX Height (Twips): ${imageHeightTwips.toFixed(0)}`);

            const doc = new Document({
                sections: [{
                    properties: { /* Define page size/margins if needed */ },
                    children: [
                        new Paragraph({
                            children: [
                                new ImageRun({
                                    data: imageBuffer,
                                    transformation: {
                                        width: imageWidthTwips,
                                        height: imageHeightTwips
                                    },
                                })
                            ],
                            alignment: AlignmentType.CENTER
                        })
                    ]
                }]
            });

            // 5. Pack and Save
            console.log("Packing DOCX...");
            const blob = await Packer.toBlob(doc);
            saveAs(blob, filename);
            console.log("DOCX saved successfully.");

        } catch (error) {
            console.error("!!! Error generating DOCX with html2canvas:", error);
            alert("Failed to generate DOCX. Check console for details. Ensure content is visible.");
        }
    }

    // =========================================================
    // ===== END OF REVISED EXPORT FUNCTIONS ===================
    // =========================================================

    // Initialize WebSocket connection
    initializeWebSocket();

    // --- Session Management ---
    supabase.auth.onAuthStateChange((event, session) => {
        if (event === "SIGNED_IN") {
            userLoggedIn = true;
            currentUser = session.user;
        } else if (event === "SIGNED_OUT") {
            userLoggedIn = false;
            currentUser = null;
        }
        updateNavBar();
    });

    // --- Navigation Logic ---
    function navigateTo(pageId) {
        pages.forEach((page) => {
            page.classList.remove("active", "flex", "block");
            page.style.display = "none";
        });

        const targetPage = $(pageId);
        if (targetPage) {
            targetPage.classList.add("active");
            if (["home", "templates", "templateDetail", "examplesPage", "adminDashboard", "about"].includes(pageId)) {
                targetPage.style.display = "block";
            } else {
                targetPage.style.display = "flex";
            }

            if (pageId === "adminDashboard") {
                fetchAndDisplayStatistics();
            }
            window.scrollTo(0, 0);
        }
    }

    // --- Update Navigation Bar Links ---
    function updateNavBar() {
        const loginLink = document.querySelector('a[data-page="login"], a[data-page="logout"]');

        if (userLoggedIn) {
            if (loginLink) {
                loginLink.textContent = "Logout";
                loginLink.setAttribute("data-page", "logout");
            }
        } else {
            if (loginLink) {
                loginLink.textContent = "Login";
                loginLink.setAttribute("data-page", "login");
            }
        }
        attachNavLinkListeners();
    }

    // --- Attach Navigation Link Listeners ---
    function attachNavLinkListeners() {
        document.querySelectorAll(".nav-link").forEach((link) => {
            link.removeEventListener("click", handleNavLinkClick);
            link.addEventListener("click", handleNavLinkClick);
        });
    }

    function handleNavLinkClick(e) {
        e.preventDefault();
        const pageId = this.getAttribute("data-page");

        if (pageId === "logout") {
            handleLogout();
            return;
        }

        if (pageId === "templates") {
            navigateTo("home");
            return;
        }

        if ((pageId === "login" || pageId === "signup") && userLoggedIn) {
            navigateTo("home");
            return;
        }
        navigateTo(pageId);
    }

    // --- Admin Dashboard Stats Logic ---
    const refreshStatsBtn = $("refreshStatsBtn");
    if (refreshStatsBtn) {
        refreshStatsBtn.addEventListener("click", fetchAndDisplayStatistics);
    }

    async function fetchAndDisplayStatistics() {
        if (!userLoggedIn) {
            showMessage("statsMessage", "You must be logged in to refresh statistics.", "error");
            return;
        }

        const btn = $("refreshStatsBtn");
        const textEl = $("refreshStatsBtnText");
        const spinner = $("refreshStatsSpinner");

        btn.disabled = true;
        spinner.classList.remove("hidden");
        textEl.textContent = "Loading...";
        showMessage("statsMessage", "", "success");

        try {
            const { data, error } = await supabase.functions.invoke("statistics", {
                body: { update: true }
            });

            if (error) {
                throw error;
            }

            if (data && data.success) {
                const dbStatus = data.database_status;
                if (dbStatus) {
                    $("statTotalUsers").textContent = dbStatus.total_users ?? "N/A";
                    $("statActiveUsers").textContent = dbStatus.log_in_users ?? "N/A";
                    $("statTotalQueries").textContent = dbStatus.total_queries ?? "N/A";
                    $("dashQueryCount").textContent = dbStatus.total_queries ?? "0";
                    $("statDbSize").textContent = dbStatus.database_size ?? "N/A";
                    $("statAvgTime").textContent = dbStatus.avg_p_time
                        ? parseFloat(dbStatus.avg_p_time).toFixed(2) + " ms"
                        : "N/A";
                    $("statRecordedAt").textContent = dbStatus.recorded_at
                        ? new Date(dbStatus.recorded_at).toLocaleString()
                        : "N/A";
                }

                const pineconeStatus = data.pinecone_status;
                const pineconeContainer = $("pineconeStatsContainer");
                if (pineconeStatus && pineconeStatus.status) {
                    pineconeContainer.classList.remove("hidden");
                    $("statPineconeName").textContent = pineconeStatus.name ?? "N/A";
                    $("statTotalVectors").textContent = pineconeStatus.total_vectors ?? "N/A";
                    $("statBookVectors").textContent = pineconeStatus.book_namespace_vectors ?? "N/A";
                    $("statPineconeDimension").textContent = pineconeStatus.dimension ?? "N/A";
                    $("statPineconeStatus").textContent = pineconeStatus.status ?? "N/A";
                    $("statPineconeCloud").textContent =
                        `${pineconeStatus.cloud_provider ?? ""} (${pineconeStatus.region ?? ""})`;
                } else {
                    pineconeContainer.classList.add("hidden");
                }
                showMessage("statsMessage", "Statistics updated successfully!", "success");
            } else {
                throw new Error(data.error || "Failed to fetch statistics.");
            }
        } catch (error) {
            console.error("Error fetching statistics:", error);
            showMessage("statsMessage", `Error: ${error.message}`, "error");
        } finally {
            btn.disabled = false;
            spinner.classList.add("hidden");
            textEl.textContent = "Refresh Stats";
        }
    }

    // --- Home Page Card & Tab Logic ---
    function setupHomeTabs() {
        const tabsNav = $("homeTabsNav");
        const tabPanels = document.querySelectorAll(".home-tab-panel");
        const tabBtns = document.querySelectorAll(".home-tab-btn");

        tabPanels.forEach((panel) => {
            if (panel.classList.contains("active")) {
                panel.style.display = "grid";
            } else {
                panel.style.display = "none";
            }
        });

        tabsNav.addEventListener("click", (e) => {
            if (e.target.tagName !== "BUTTON") return;
            const targetTab = e.target.dataset.tab;

            tabBtns.forEach((btn) => {
                btn.classList.toggle("active", btn.dataset.tab === targetTab);
            });

            tabPanels.forEach((panel) => {
                if (panel.id === targetTab) {
                    panel.classList.add("active");
                    panel.style.display = "grid";
                } else {
                    panel.classList.remove("active");
                    panel.style.display = "none";
                }
            });
        });
    }

    function attachHomeCardListeners() {
        document.querySelectorAll(".home-template-link").forEach((card) => {
            card.addEventListener("click", () => {
                const templateId = card.dataset.templateId;
                preFillData = card.dataset.preFill || "";

                if (!userLoggedIn) {
                    showMessage("loginMessage", "Please log in to use the analysis tools.", "error");
                    navigateTo("login");
                } else {
                    selectedTemplateForModal = templateId;
                    $("versionChoiceModal").classList.remove("hidden");
                }
            });
        });
    }

    function proceedFromModal() {
        $("versionChoiceModal").classList.add("hidden");
        if (selectedTemplateForModal) {
            showTemplateDetail(selectedTemplateForModal);
        }
    }

    // --- Template Detail Page Logic ---

    function reattachActionListeners() {
        const savePdfBtn = $("savePdfBtn");
        const saveDocxBtn = $("saveDocxBtn");
        if (savePdfBtn) savePdfBtn.addEventListener("click", handleSaveAsPdf);
        if (saveDocxBtn) saveDocxBtn.addEventListener("click", handleSaveAsDocx);
    }

    function reattachTabListeners(container) {
        const tabNav = container.querySelector(".flex.border-b");
        const tabContent = container.querySelector("div:not(.flex)");
        if (tabNav && tabContent) {
            tabNav.addEventListener("click", (e) => {
                if (e.target.tagName === "BUTTON") {
                    tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                    tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                    e.target.classList.add("active");
                    const targetPanelId = e.target.dataset.tab + "Panel";
                    const targetPanel = $(targetPanelId);
                    if (targetPanel) {
                        targetPanel.classList.add("active");
                        const chart = targetPanel.querySelector(".plotly-chart");
                        if (chart) {
                            Plotly.Plots.resize(chart);
                        }
                    }
                }
            });
        }
    }

    function showTemplateDetail(templateId) {
        currentTemplateId = templateId;
        const rule = templateRules[templateId] || {};

        // Dynamically get template info from the clicked card if not in the predefined list
        let template = templates[templateId];
        if (!template) {
            const card = document.querySelector(`.home-template-link[data-template-id="${templateId}"]`);
            if (card) {
                const title = card.querySelector("h3").innerText;
                const descriptionEl = card.querySelector("p");
                const description = descriptionEl
                    ? descriptionEl.innerText
                    : `Generate a detailed analysis for ${title}.`;
                template = { title: title, description: description };
                templates[templateId] = template; // Cache it
            } else {
                // Generic fallback if card isn't found
                template = {
                    title: templateId.replace(/-/g, " ").replace(/\b\w/g, (l) => l.toUpperCase()),
                    description: `Generate a detailed analysis.`
                };
                templates[templateId] = template;
            }
        }

        // Handle special layouts that replace the whole content area
        if (rule.useSwotLayout) {
            createSwotTowsLayout(template);
        } else if (rule.useArchetypeLayout) {
            createArchetypeAnalysisLayout(template);
        } else if (rule.useThinkingSystemLayout_NS) {
            // <-- ADD THIS BLOCK
            createThinkingSystemLayout_NS(template);
        } else if (rule.useLivingSystemLayout_NS) {
            // <-- ADD THIS BLOCK
            createLivingSystemLayout_NS(template);
        } else if (rule.useVisualizationLayout_DA) {
            // <-- ADD THIS BLOCK
            createVisualizationLayout_DA(template);
        } else if (rule.useSystemObjectivesLayout_ST) {
            // <-- ADD THIS BLOCK
            createSystemObjectivesLayout_ST(template);
        } else if (rule.useCreativeDissonanceLayout_NS) {
            // <-- ADD THIS BLOCK
            createCreativeDissonanceLayout_NS(template);
        } else if (rule.useSystemActionsLayout_ST) {
            // <-- ADD THIS BLOCK
            createSystemActionsLayout_ST(template);
        } else if (rule.usePrescriptiveLayout_DA) {
            // <-- ADD THIS BLOCK
            createPrescriptiveLayout_DA(template);
        } else if (rule.usePlsLayout_DA) {
            // <-- ADD THIS BLOCK
            createPlsLayout_DA(template);
        } else if (rule.useDescriptiveLayout_DA) {
            // <-- ADD THIS BLOCK
            createDescriptiveLayout_DA(template);
        } else if (rule.useFactorAnalysisLayout) {
            createFactorAnalysisLayout(template);
        } else if (rule.useSemAnalysisLayout) {
            // <-- ADD THIS BLOCK
            createSemAnalysisLayout(template);
        } else if (rule.useActionPlansLayout_AP) {
            createActionPlansLayout_AP(template);
        } else if (rule.useLeveragePointsLayout) {
            createLeveragePointsLayout(template);
        } else if (rule.useMiscLayout_MSC) {
            createMiscLayout_MSC(template);
        } else if (rule.useNovelGoalsLayout_NS) {
            // <-- ADD THIS BLOCK
            createNovelGoalsLayout_NS(template);
        } else if (rule.useKpiLayout_KE) {
            createKpiLayout_KE(template);
        } else if (rule.useGoalsAndInitiativesLayout_SP) {
            createGoalsAndInitiativesLayout_SP(template);
        } else if (rule.useRegressionLayout_DA) {
            // <-- ADD THIS BLOCK
            createRegressionLayout_DA(template);
        } else if (rule.useParetoLayout) {
            createParetoLayout(template);
        } else if (rule.useProcessMappingLayout) {
            createProcessMappingLayout(template);
        } else if (rule.useSystemGoalsLayout) {
            createSystemGoalsLayout(template);
        } else if (rule.useSystemThinkingLayout) {
            createSystemThinkingLayout(template);
        } else if (rule.useSemAnalysisLayout) {
            createSemAnalysisLayout(template);
        } else if (rule.usePredictiveAnalysisLayout) {
            createPredictiveAnalysisLayout(template);
        } else if (rule.useDematelLayout) {
            createDematelLayout(template);
        } else {
            createDefaultLayout(template, rule);
        }
        navigateTo("templateDetail");
    }

    function createDefaultLayout(template, rule) {
        // --- Default Layout Handling (Rebuilds the DOM for consistency) ---
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-2 gap-12"; // Reset to default grid class
        contentContainer.innerHTML = `
                    <div>
                        <h1 id="templateTitle" class="text-4xl font-bold mb-4">${template.title}</h1>
                        <p id="templateDescription" class="text-white/80 mb-8">${template.description}</p>
                        <div class="glass-container p-6">
                            <div id="templateFormFields" class="space-y-4"></div>
                            
                            <div id="analysisSectionsContainer" class="glass-container mt-8" style="display: ${rule.hideAnalysisSection ? "none" : "block"}">
                                <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Analysis Sections</h4>
                                <p class="text-white/70 text-center mb-4">Choose the components for your report.</p>
                                <ul id="analysisList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Introduction</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Overview of business</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>process overview</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>mission statement</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision analysis</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision statement 2</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 1</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 2</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 3</span></li>
                                </ul>
                            </div>
                            
                            <div id="methodsConsideredContainer" class="glass-container mt-8" style="display: ${rule.hideFrameworks ? "none" : "block"}">
                                <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Frameworks</h4>
                                <p id="selectionCounter" class="text-white/70 text-center mb-4">Selected: 0 / 3</p>
                                <ul id="frameworkList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Reframing Thinking"><span>Reframing Thinking</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Delphi Method"><span>Delphi Method</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Blue Ocean Strategy"><span>Blue Ocean Strategy</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Design Thinking"><span>Design Thinking</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Thinking Hats"><span>Thinking Hats</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Business Model Canvas"><span>Business Model Canvas</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="SCAMPER"><span>SCAMPER</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="TRIZ (Theory of Inventive Problem Solving)"><span>TRIZ (Theory of Inventive Problem Solving)</span></li>
                                </ul>
                            </div>

                            <button id="generateBtn" class="btn btn-primary w-full mt-4">
                                <span id="generateBtnText">Generate Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold mb-4">Generated Analysis</h2>
                        <div id="analysisResult" class="glass-container min-h-[300px] whitespace-pre-wrap overflow-x-auto">
                        </div>
                        <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                             <button id="savePdfBtn" class="btn btn-secondary">PDF</button>
                             <button id="saveDocxBtn" class="btn btn-secondary">DOCX</button>
                        </div>
                    </div>
                `;

        // Populate the form fields into the newly created div
        populateDefaultFormFields(currentTemplateId);

        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // Reset and configure frameworks, re-attaching listeners to new elements
        const frameworkCheckboxes = document.querySelectorAll("#frameworkList .method-checkbox");
        frameworkCheckboxes.forEach((cb) => {
            cb.addEventListener("change", frameworkCheckboxChangeHandler);
            cb.disabled = false;
            cb.checked = false;
        });

        if (rule.preselectFramework) {
            frameworkCheckboxes.forEach((cb) => {
                if (cb.dataset.framework === rule.preselectFramework) {
                    cb.checked = true;
                }
                cb.disabled = true;
            });
        }

        // Re-attach all necessary event listeners for the new elements
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();
        configureFrameworkSelector(currentSelectionLimit);
    }

    function populateDefaultFormFields(templateId) {
        const templateFormFields = $("templateFormFields");
        templateFormFields.innerHTML = ""; // Clear previous fields

        // For Fishbone/Pareto, we only need the problem statement.
        if (templateId === "pareto-fishbone") {
            templateFormFields.innerHTML = `
                        <div>
                            <label for="problemStatement" class="block text-sm font-medium text-gray-200 mb-2">Problem Statement</label>
                            <input type="text" id="problemStatement" class="input-field" placeholder="e.g., Low Customer Satisfaction" required>
                        </div>
                    `;
        } else {
            // Default form for most tools
            let formHtml = `
                        <div><label for="companyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label><input type="text" id="companyName" class="input-field" placeholder="e.g., Innovate Inc." required></div>
                        <div>
                            <label for="companyDocumentsFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Company Documents</label>
                            <div class="input-file-wrapper">
                                <label for="companyDocumentsFile" id="companyDocumentsFileLabel" class="input-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                    <span class="file-name">Click to select a file...</span>
                                </label>
                                <input type="file" id="companyDocumentsFile" class="input-file">
                            </div>
                        </div>
                        <div><label for="location" class="block text-sm font-medium text-gray-200 mb-2">Location</label><input type="text" id="location" class="input-field" placeholder="e.g., Global" required></div>
                    `;

            // Add context box for specific templates
            if (templateId === "mission-vision" || templateId === "objectives") {
                formHtml += `
                            <div>
                                <label for="useCaseContext" class="block text-sm font-medium text-gray-200 mb-2">Use Case / Company Context</label>
                                <textarea id="useCaseContext" class="input-field h-32" placeholder="Describe your company's mission, goals, or the specific use case for this analysis..."></textarea>
                            </div>
                        `;
            }

            templateFormFields.innerHTML = formHtml;

            const fileInput = $("companyDocumentsFile");
            if (fileInput) {
                fileInput.addEventListener("change", (e) => {
                    const label = $("companyDocumentsFileLabel");
                    const fileNameSpan = label.querySelector(".file-name");
                    if (e.target.files.length > 0) {
                        fileNameSpan.textContent = e.target.files[0].name;
                        label.classList.add("has-file");
                    } else {
                        fileNameSpan.textContent = "Click to select a file...";
                        label.classList.remove("has-file");
                    }
                });
            }
        }
    }

    function createSystemGoalsLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Single column layout
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">System & Goal Description</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="systemGoalsContent" class="input-field h-48" placeholder="Describe your system, its current state, and what you want to achieve. For example: 'Our software company is growing fast, but customer churn is high. We want to increase customer retention by 30%.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                 <div class="input-file-wrapper">
                                     <label for="systemGoalsFile" id="systemGoalsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                     </label>
                                     <input type="file" id="systemGoalsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Formulate Initiatives</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

        // Re-attach all necessary event listeners for the new elements
        setupInputToggle("systemGoalsFile", "systemGoalsFileLabel", "textInputArea", "docUploadArea");
    }

    function createGoalsAndInitiativesLayout_SP(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">High-Level Goal or Vision</h3>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="goalsContent" class="input-field h-48" placeholder="Describe your main business objective or long-term vision. For example: 'Become the #1 provider of eco-friendly cleaning supplies in North America by 2030.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="goalsFile" id="goalsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="goalsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Build Strategic Plan</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("goalsFile", "goalsFileLabel", "textInputArea", "docUploadArea");
    }

    function createActionPlansLayout_AP(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Objective or Initiative to Plan</h3>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="actionPlanContent" class="input-field h-48" placeholder="Describe the goal or objective you want to create an action plan for. For example: 'Launch a new mobile application for our e-commerce store within the next 6 months.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="actionPlanFile" id="actionPlanFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="actionPlanFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Create Action Plan</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Generated Action Plan</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("actionPlanFile", "actionPlanFileLabel", "textInputArea", "docUploadArea");
    }

    function createKpiLayout_KE(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Project or Goal Description</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="kpiContent" class="input-field h-48" placeholder="Describe the project, goal, or strategic initiative you want to track. For example: 'Launch a new customer loyalty program to increase repeat purchase rate.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="kpiFile" id="kpiFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="kpiFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Define KPIs & Events</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Performance Framework</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("kpiFile", "kpiFileLabel", "textInputArea", "docUploadArea");
    }

    function createNovelGoalsLayout_NS(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg-col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe Your Overarching Ambition or Goal</h3>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="novelGoalsContent" class="input-field h-48" placeholder="Provide a high-level, ambitious goal. For example: 'To transition our company from a traditional hardware manufacturer to a leading software-as-a-service provider in the IoT space.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="novelGoalsFile" id="novelGoalsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="novelGoalsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Map Strategic Horizons</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Horizons of Growth Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("novelGoalsFile", "novelGoalsFileLabel", "textInputArea", "docUploadArea");
    }

    function createRegressionLayout_DA(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Analysis Setup</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="dependentVar" class="block text-sm font-medium text-gray-200 mb-2">Dependent Variable (Y)</label>
                                    <input type="text" id="dependentVar" class="input-field" placeholder="The outcome you want to predict (e.g., 'Sales')">
                                </div>
                                <div>
                                    <label for="independentVars" class="block text-sm font-medium text-gray-200 mb-2">Independent Variables (X)</label>
                                    <input type="text" id="independentVars" class="input-field" placeholder="Comma-separated predictors (e.g., 'Marketing Spend, Website Traffic')">
                                </div>
                                <div>
                                    <label for="regressionContextFile" class="block text-sm font-medium text-gray-200 mb-2">Company Document (.txt, .docx)</label>
                                    <div class="input-file-wrapper">
                                        <label for="regressionContextFile" id="regressionContextFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select context document...</span>
                                        </label>
                                        <input type="file" id="regressionContextFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <div>
                                    <label for="regressionFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="regressionFile" id="regressionFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv data file...</span>
                                        </label>
                                        <input type="file" id="regressionFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Run Regression Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Regression Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

        // Helper to attach listeners to file inputs
        const attachListener = (inputId, labelId) => {
            const fileInput = $(inputId);
            if (fileInput) {
                fileInput.addEventListener("change", (e) => {
                    const label = $(labelId);
                    const fileNameSpan = label.querySelector(".file-name");
                    if (e.target.files.length > 0) {
                        fileNameSpan.textContent = e.target.files[0].name;
                        label.classList.add("has-file");
                    } else {
                        fileNameSpan.textContent = "Select a file...";
                        label.classList.remove("has-file");
                    }
                });
            }
        };

        attachListener("regressionFile", "regressionFileLabel");
        attachListener("regressionContextFile", "regressionContextFileLabel");

        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();
    }

    function createPlsLayout_DA(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">PLS-SEM Model Setup</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="plsMeasurementModel" class="block text-sm font-medium text-gray-200 mb-2">Measurement Model</label>
                                    <textarea id="plsMeasurementModel" class="input-field h-32" placeholder="Define latent variables and their indicators. Example:\nBrandImage = BI1, BI2, BI3\nLoyalty = LOY1, LOY2, LOY3"></textarea>
                                </div>
                                <div>
                                    <label for="plsStructuralModel" class="block text-sm font-medium text-gray-200 mb-2">Structural Model (Paths)</label>
                                    <textarea id="plsStructuralModel" class="input-field h-24" placeholder="Define hypothesized paths between latent variables. Example:\nBrandImage -> Loyalty"></textarea>
                                </div>
                                <div>
                                    <label for="plsFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="plsFile" id="plsFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv file...</span>
                                        </label>
                                        <input type="file" id="plsFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Run PLS-SEM Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">PLS-SEM Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        // --- THIS IS THE FIX ---
        setupInputToggle("plsFile", "plsFileLabel", null, null);
    }

    function createDescriptiveLayout_DA(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Upload Your Dataset & Context</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="descriptiveContextFile" class="block text-sm font-medium text-gray-200 mb-2">Company Document (.txt, .docx)</label>
                                    <div class="input-file-wrapper">
                                        <label for="descriptiveContextFile" id="descriptiveContextFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select context document...</span>
                                        </label>
                                        <input type="file" id="descriptiveContextFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <div>
                                    <label for="descriptiveFile" class="block text-sm font-medium text-gray-200 mb-2">Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="descriptiveFile" id="descriptiveFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv data file...</span>
                                        </label>
                                        <input type="file" id="descriptiveFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Analyze Data</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Descriptive Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        const attachListener = (inputId, labelId) => {
            const fileInput = $(inputId);
            if (fileInput) {
                fileInput.addEventListener("change", (e) => {
                    const label = $(labelId);
                    const fileNameSpan = label.querySelector(".file-name");
                    if (e.target.files.length > 0) {
                        fileNameSpan.textContent = e.target.files[0].name;
                        label.classList.add("has-file");
                    } else {
                        fileNameSpan.textContent = "Select a file...";
                        label.classList.remove("has-file");
                    }
                });
            }
        };
        attachListener("descriptiveFile", "descriptiveFileLabel");
        attachListener("descriptiveContextFile", "descriptiveContextFileLabel");
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();
    }

    function createPrescriptiveLayout_DA(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Analysis Setup</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="prescriptiveGoal" class="block text-sm font-medium text-gray-200 mb-2">Business Goal</label>
                                    <textarea id="prescriptiveGoal" class="input-field h-24" placeholder="Describe the business outcome you want to achieve. Example: 'Increase customer retention by 15% in the next quarter.'"></textarea>
                                </div>
                                <div>
                                    <label for="prescriptiveFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="prescriptiveFile" id="prescriptiveFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv file...</span>
                                        </label>
                                        <input type="file" id="prescriptiveFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> prescribe Actions</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Prescriptive Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("prescriptiveFile", "prescriptiveFileLabel", null, null);
    }

    function createVisualizationLayout_DA(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Visualization Setup</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="vizRequest" class="block text-sm font-medium text-gray-200 mb-2">What do you want to visualize?</label>
                                    <textarea id="vizRequest" class="input-field h-24" placeholder="Be specific. For example: 'Show the relationship between Marketing Spend and Sales Revenue', or 'Visualize the distribution of customer ages by product category.'"></textarea>
                                </div>
                                <div>
                                    <label for="vizFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="vizFile" id="vizFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv file...</span>
                                        </label>
                                        <input type="file" id="vizFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Generate Visualizations</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Data Visualizations</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("vizFile", "vizFileLabel", null, null);
    }

    async function handleVisualizationAnalysis_DA() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div></div><div></div><div></div> </div><h3 class="text-xl font-semibold text-white mb-4">Generating Advanced Visualizations...</h3><p class="text-white/80 mb-2">Analyzing data, selecting optimal charts, and crafting insights...</p></div>`;
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    // *** CHOOSE MODEL: qwen or llama ***
    const MODEL_NAME = "llama3.1:latest"; // Use Qwen for potentially better numerical accuracy / chart logic
    // const MODEL_NAME = "llama3.1:latest"; // Alternative option

    try {
        // 1. Gather Inputs
        const vizRequest = $("vizRequest").value.trim();
        const file = $("vizFile").files[0];

        if (!vizRequest || !file) {
            throw new Error(" Please describe your visualization request and upload a CSV data file.");
        }

        const fileContent = await extractTextFromFile(file);

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000; // Adjust as needed
        let truncatedNote = "";
        let dataSnippet = fileContent;
        if (fileContent.length > MAX_CONTEXT_LENGTH) {
            dataSnippet = fileContent.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters of data.)`;
            console.warn(`Visualization analysis data truncated.`);
        }

        // 2. Construct Enhanced Prompt
        const prompt = `
            You are a senior business intelligence analyst using Plotly.js. Your task is to analyze a user's request and dataset snippet to create the most insightful and relevant visualizations. Accuracy, clarity, and actionable insights are paramount.

            **ANALYSIS INPUTS:**
            * **User Request:** "${vizRequest}"
            * **Data Snippet:** ${truncatedNote}\n\`\`\`csv\n${dataSnippet}\n\`\`\`

            **DETAILED TASKS:**
            1.  **Chart Selection Rationale:** Briefly explain (1-2 sentences) your thought process for choosing the types of charts generated based on the user request and apparent data structure.
            2.  **Generate Visualizations (3-4 charts):** Create distinct, complementary visualizations using appropriate chart types (e.g., bar, line, scatter, pie, box, heatmap) that directly address the user's request using ONLY the provided data snippet. For each visualization:
                * **\`title\`:** A short, descriptive title.
                * **\`plotly_trace\`:** A *complete* Plotly.js trace object (or array of traces if needed, e.g., for grouped bars). Ensure data types are correct (numbers for y-values etc.).
                * **\`plotly_layout\`:** A *complete* Plotly.js layout object, including axis labels and a title.
                * **\`interpretation\`:** A detailed, multi-sentence interpretation explaining *what the chart shows* based on visual patterns (trends, distributions, comparisons, outliers) evident in the plotted data.
                * **\`actionable_insight\`:** A specific business action or decision that should be considered based *only* on the interpretation of *this specific chart* and the original user request context.

            3.  **Self-Correction:** Before outputting JSON, review: Does the chart selection rationale make sense? Are trace/layout objects complete and valid Plotly JSON? Do interpretations accurately reflect the chart's visual patterns in the data snippet? Are insights actionable and directly linked to the interpretation? Fix errors rigorously.

            **ABSOLUTE CONSTRAINTS:**
            - **DATA GROUNDING:** All chart data, interpretations, and insights MUST be derived *solely* from the provided data snippet and user request. No external data or assumptions.
            - **PLOTLY VALIDITY:** Ensure \`plotly_trace\` and \`plotly_layout\` are valid JSON structures usable by Plotly.js. Use correct data types.
            - **ACTIONABILITY:** Insights must suggest concrete next steps or decisions.
            - **JSON FORMAT:** Adhere EXACTLY. Include all specified keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys: "chart_selection_rationale", AND "visualizations".** The "visualizations" array MUST contain **3-4 objects**, each with "title", "plotly_trace", "plotly_layout", "interpretation", and "actionable_insight" keys.
            {
              "chart_selection_rationale": "Brief explanation here...",
              "visualizations": [
                { // Chart 1
                  "title": "Chart Title 1",
                  "plotly_trace": { /* ... Complete Trace Object(s) ... */ },
                  "plotly_layout": { /* ... Complete Layout Object ... */ },
                  "interpretation": "Detailed interpretation of chart 1 based on data...",
                  "actionable_insight": "Specific action based on interpretation of chart 1..."
                },
                { // Chart 2
                  "title": "Chart Title 2",
                  "plotly_trace": { /* ... */ },
                  "plotly_layout": { /* ... */ },
                  "interpretation": "Detailed interpretation of chart 2...",
                  "actionable_insight": "Specific action based on interpretation of chart 2..."
                } // ... 3-4 charts total ...
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED Visualization prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        try {
            parsedData = JSON.parse(data.response);
             // *** Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Visualization) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData ||
                 !parsedData.chart_selection_rationale || typeof parsedData.chart_selection_rationale !== 'string' ||
                 !parsedData.visualizations || !Array.isArray(parsedData.visualizations) || parsedData.visualizations.length < 2 || // Expect at least 2 charts
                 (parsedData.visualizations.length > 0 && (
                     typeof parsedData.visualizations[0] !== 'object' ||
                     !parsedData.visualizations[0].hasOwnProperty('title') ||
                     !parsedData.visualizations[0].hasOwnProperty('plotly_trace') || typeof parsedData.visualizations[0].plotly_trace !== 'object' || // Basic check
                     !parsedData.visualizations[0].hasOwnProperty('plotly_layout') || typeof parsedData.visualizations[0].plotly_layout !== 'object' || // Basic check
                     !parsedData.visualizations[0].hasOwnProperty('interpretation') ||
                     !parsedData.visualizations[0].hasOwnProperty('actionable_insight')
                 ))
                )
             {
                  console.error("Validation Failed (Visualization): Required fields missing or invalid structure/count.", parsedData);
                  throw new Error(`AI response structure is incorrect. Missing/invalid fields (chart_selection_rationale, visualizations array [>=2] with all sub-keys). Check console.`);
             }
             console.log(`Successfully parsed ENHANCED Visualization JSON using ${MODEL_NAME}. Rationale provided. Found ${parsedData.visualizations.length} visualizations.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED Visualization JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or required fields missing in AI response: ${e.message}. Check console logs.`);
        }

        // 4. Render Results
        renderVisualizationPage_DA(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleVisualizationAnalysis_DA (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderVisualizationPage_DA(container, data) {
    container.innerHTML = ""; // Clear loading state

     // Basic validation
     if (!data || !data.chart_selection_rationale || !data.visualizations || !Array.isArray(data.visualizations) || data.visualizations.length === 0) {
         console.error("Incomplete data passed to renderVisualizationPage_DA:", data);
         container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render visualizations.</div>`;
         $("analysisActions").classList.add("hidden");
         return;
     }

    const { chart_selection_rationale, visualizations } = data;


    // --- Create Tab Navigation ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    // Add "Learn Visualization" tab
    let tabButtonsHtml = `<button class="analysis-tab-btn active" data-tab="rationale"> Rationale</button>`;
    visualizations.forEach((viz, index) => {
        // Use a generic name if title is missing, but log a warning
        let buttonTitle = viz.title || `Chart ${index + 1}`;
        if (!viz.title) console.warn(`Visualization ${index} is missing a title.`);
        // Truncate long titles for buttons
        if (buttonTitle.length > 25) buttonTitle = buttonTitle.substring(0, 22) + "...";
        tabButtonsHtml += `<button class="analysis-tab-btn" data-tab="viz-${index}"> ${buttonTitle}</button>`;
    });
    tabButtonsHtml += `<button class="analysis-tab-btn" data-tab="learn"> Learn Viz</button>`;
    tabNav.innerHTML = tabButtonsHtml;
    container.appendChild(tabNav);

    // --- Create Tab Panels ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    let tabPanelsHtml = `<div id="rationalePanel" class="analysis-tab-panel active"></div>`;
    visualizations.forEach((viz, index) => {
        tabPanelsHtml += `<div id="viz-${index}Panel" class="analysis-tab-panel"></div>`;
    });
    // Add "Learn Visualization" panel
    tabPanelsHtml += `<div id="learnPanel" class="analysis-tab-panel"></div>`;
    tabContent.innerHTML = tabPanelsHtml;

    // --- 1. Populate Rationale Panel ---
    const rationalePanel = $("rationalePanel");
    rationalePanel.innerHTML = `
        <div class="p-6">
            <h3 class="text-2xl font-bold mb-4 text-center">Chart Selection Rationale</h3>
            <blockquote class="p-4 italic border-l-4 border-indigo-400 bg-black/20 text-white/90 max-w-3xl mx-auto">
                ${chart_selection_rationale}
            </blockquote>
            <p class="text-sm text-center text-white/60 mt-4">The following tabs contain the visualizations generated based on this reasoning.</p>
        </div>
    `;

    // --- 2. Populate Individual Visualization Panels ---
    visualizations.forEach((viz, index) => {
        const panel = $(`viz-${index}Panel`);
        if (!panel) {
            console.error(`Could not find panel for viz-${index}`);
            return; // Skip if panel doesn't exist
        }

        let panelHtml = `<div class="p-4">
                    <h3 class="text-2xl font-bold mb-4 text-center">${viz.title || `Visualization ${index + 1}`}</h3>
                    <div id="viz-chart-${index}" class="w-full min-h-[500px] plotly-chart mb-6 bg-black/10 rounded-lg flex items-center justify-center"><span class="text-white/50 italic">Rendering chart...</span></div>
                    <div class="viz-interpretation-box">
                        <h4 class="text-xl font-bold mb-2">Interpretation</h4>
                        <p class="text-white/80 mb-4 text-sm">${viz.interpretation ?? "No interpretation provided."}</p>
                        <h4 class="text-xl font-bold mb-2 text-indigo-300"> Actionable Insight</h4>
                        <p class="text-white/90 text-sm">${viz.actionable_insight ?? "No actionable insight provided."}</p>
                    </div>
                </div>`;
        panel.innerHTML = panelHtml;

        const chartContainer = $(`viz-chart-${index}`);
        if (!chartContainer) {
             console.error(`Chart container viz-chart-${index} not found after setting innerHTML.`);
             return; // Skip if container isn't found
        }

        // --- Render Plotly Chart ---
        try {
            // Basic validation of trace and layout
            if (!viz.plotly_trace || typeof viz.plotly_trace !== 'object' || !viz.plotly_layout || typeof viz.plotly_layout !== 'object') {
                throw new Error("Missing or invalid Plotly trace/layout object.");
            }

            // Ensure trace is an array
            const traces = Array.isArray(viz.plotly_trace) ? viz.plotly_trace : [viz.plotly_trace];

            // Define standard layout properties for consistency
            const layoutDefaults = {
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                xaxis: { gridcolor: "rgba(255,255,255,0.1)", zeroline: false, automargin: true },
                yaxis: { gridcolor: "rgba(255,255,255,0.1)", zeroline: false, automargin: true },
                legend: { font: { color: "white" } },
                margin: { t: 50, b: 50, l: 60, r: 30 } // Adjusted margins
            };

            // Merge AI layout with defaults, AI takes precedence
            const finalLayout = { ...layoutDefaults, ...viz.plotly_layout };
            // Ensure titles are properly handled if provided by AI
            finalLayout.title = viz.plotly_layout.title || viz.title || `Chart ${index + 1}`; // Use AI title if available

            Plotly.newPlot(chartContainer, traces, finalLayout, { responsive: true });

        } catch (chartError) {
            console.error(`Error rendering chart ${index} (${viz.title}):`, chartError, "Trace:", viz.plotly_trace, "Layout:", viz.plotly_layout);
            chartContainer.innerHTML = `<div class="p-4 text-center text-red-400">Could not render chart. Error: ${chartError.message}. Check console for details.</div>`;
        }
    });


    // --- 3. Populate Learn Visualization Tab ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Data Visualization</h3>
         [Image of various chart types]
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Why Visualize Data?</h4>
            <p class="text-sm text-white/80">Our brains process visual information much faster than text or tables. Good visualizations help us:</p>
            <ul class="list-disc list-inside space-y-1 text-sm text-white/80 mt-2">
                <li>Identify trends and patterns quickly.</li>
                <li>Spot outliers and anomalies easily.</li>
                <li>Understand complex relationships between variables.</li>
                <li>Communicate insights effectively to others.</li>
                <li>Make more informed, data-driven decisions.</li>
            </ul>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Common Chart Types & Uses:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Line Chart:</strong> Show trends over time.</li>
                    <li><strong>Bar Chart:</strong> Compare quantities across categories.</li>
                    <li><strong>Pie/Donut Chart:</strong> Show parts of a whole (use sparingly, < 6 categories).</li>
                    <li><strong>Scatter Plot:</strong> Show relationship between two numerical variables.</li>
                    <li><strong>Histogram:</strong> Show distribution of a single numerical variable.</li>
                    <li><strong>Box Plot:</strong> Show distribution summary (median, quartiles, outliers).</li>
                    <li><strong>Heatmap:</strong> Show intensity/correlation in a matrix.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Choosing the Right Chart:</h4>
                 <p class="text-sm mb-2">Think about what you want to show:</p>
                 <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Comparison:</strong> Bar chart, Grouped bar chart.</li>
                    <li><strong>Trend/Time:</strong> Line chart, Area chart.</li>
                    <li><strong>Relationship:</strong> Scatter plot, Bubble chart.</li>
                    <li><strong>Distribution:</strong> Histogram, Box plot, Density plot.</li>
                    <li><strong>Composition:</strong> Pie chart, Stacked bar chart, Treemap.</li>
                 </ul>
                 <p class="text-xs text-white/60 mt-2 italic">This tool attempts to select appropriate charts based on your request and data.</p>
            </div>
        </div>

        <details class="styled-details text-sm">
            <summary class="font-semibold">Tips for Effective Visualization</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-3">
                <p><strong>Keep it Simple:</strong> Avoid clutter ("chart junk"). Focus on clarity.</p>
                <p><strong>Use Color Purposefully:</strong> Highlight key data, ensure contrast, consider color blindness.</p>
                <p><strong>Label Clearly:</strong> Use informative titles, axis labels, and legends. Add units where needed.</p>
                <p><strong>Provide Context:</strong> Explain what the chart shows and why it's important (like the 'Interpretation' and 'Insight' sections here).</p>
                <p><strong>Choose Appropriate Scale:</strong> Start axes at zero for bar charts showing magnitude. Use log scales if needed for wide ranges.</p>
                <p><strong>Tell a Story:</strong> Arrange multiple charts logically to guide the viewer through your analysis.</p>
            </div>
        </details>
    </div>
    `;

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache the result HTML
    $("analysisActions").classList.remove("hidden"); // Show save buttons

    // Re-attach tab switching logic, including chart resizing
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");

                // Resize charts within the newly active panel
                const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                chartsInPanel.forEach(chartDiv => {
                    // Check if it's a Plotly chart that has been rendered
                    if (chartDiv.layout && typeof Plotly !== 'undefined') {
                        try {
                            Plotly.Plots.resize(chartDiv);
                             console.log(`Resized chart ${chartDiv.id} on tab switch.`);
                        } catch (resizeError) {
                            console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                        }
                    }
                });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Attempt initial resize for charts in the default active tab (rationale)
     // Since the rationale tab has no charts, we don't need initial resize here.
     // Resizing will happen automatically when a chart tab is clicked.

    // Ensure loading indicator is stopped
    setLoading("generate", false);
}

    function createSystemActionsLayout_ST(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe a Problem in Your System</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="systemActionContent" class="input-field h-48" placeholder="Describe a recurring problem. For example: 'Every time we hire more salespeople to boost revenue, our customer satisfaction drops and churn increases.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="systemActionFile" id="systemActionFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="systemActionFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Formulate Actions</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Systemic Action Plan</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("systemActionFile", "systemActionFileLabel", "textInputArea", "docUploadArea");
    }

    async function handleSystemActionsAnalysis_ST() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Diagnosing System Behavior & Formulating Actions...</h3><p class="text-white/80 mb-2">Generating analysis strictly based on your provided context...</p></div>`;
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = $("docUpload").checked;
        let text = "";
        if (useDoc) {
            const file = $("systemActionFile").files[0];
            if (!file) throw new Error("Please select a document.");
            text = await extractTextFromFile(file);
        } else {
            text = $("systemActionContent").value.trim();
            if (!text.trim()) throw new Error("Please describe the system problem.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (text.length > MAX_CONTEXT_LENGTH) {
            text = text.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`System Actions analysis context truncated.`);
        }

        // 2. Construct REFINED Prompt with STRONGER Context Grounding & ACTION CLASSIFICATION Rules
        const prompt = `
            You are an expert systems thinking consultant. A user has described a recurring problem or strategic initiative. Analyze it based **ONLY** on the provided text to diagnose the underlying system structure (archetype, if applicable) and prescribe **context-specific** actions, correctly classifying them as short-term fixes or long-term solutions based *only* on the text provided. ${truncatedNote}

            **USER'S SYSTEM PROBLEM/INITIATIVE DESCRIPTION:**
            \`\`\`
            ${text}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Diagnose Problem/Goal:** Provide a concise, one-sentence \`problem_diagnosis\` stating the core systemic issue or goal described **in the user's text**.
            2.  **Identify Archetype (If Applicable):** Identify the single most likely \`system_archetype\` (e.g., "Limits to Growth", "Shifting the Burden", etc.) evident **in the user's text**, *only if a clear recurring problem pattern is described*. If the text describes a *proactive initiative* rather than a problem cycle, state "Proactive Initiative - No Archetype" for the name. Include:
                * \`name\`: The archetype name or "Proactive Initiative - No Archetype".
                * \`explanation\`: Detail *how* this archetype manifests **in the user's specific situation**, referencing elements **from the text** OR explain why it's a proactive initiative based on the text. Include reinforcing/balancing loops *if identifiable from the text*.
            3.  **Identify Leverage Points (2-3):** Based **only** on the analysis and **the user's text**, identify specific \`leverage_points\` (key areas for intervention) described or implied **in the text**.
            4.  **Prescribe Actions (3-4 actions):** Develop an array of recommended \`actions\` derived **solely from the user's text and the identified leverage points/goal**. For each action:
                * \`action_name\`: Clear, actionable name (under 10 words) **taken directly from or summarizing actions mentioned in the user's text**.
                * \`type\`: Classify strictly as "Short-Term Fix" or "Long-Term Solution". **CRUCIAL RULE:** Base this classification **ONLY** on the user's text.
                    * If the text describes the action as addressing an immediate symptom, a temporary measure, or a quick patch -> "Short-Term Fix".
                    * If the text describes the action as part of a fundamental change, addressing a root cause, building new capabilities for a strategic goal, or having lasting impact -> "Long-Term Solution". (e.g., Building necessary infrastructure like logistics for a *new strategic direction* described in the text is "Long-Term Solution").
                * \`rationale\`: Explain *how* this action addresses a specific leverage point or contributes to the goal, **using evidence and reasoning found ONLY within the user's text**. Justify the 'type' classification based on the text.
                * \`impact\`: Estimated potential impact ("High", "Medium", "Low") **based on importance stated or implied in the text**.
                * \`effort\`: Estimated implementation effort ("High", "Medium", "Low") **based on complexity described or implied in the text**.
                * \`kpis\`: List 2-3 specific KPIs **mentioned in, implied by, or logically derived ONLY from the user's text** to track this action's success.
            5.  **Self-Correction:** Rigorously check: Is every detail (diagnosis, archetype, leverage points, action names, **action types**, rationales, KPIs) **strictly derived ONLY from the user's text**? Is the archetype choice (or lack thereof) justified **by text evidence**? Is the **action type classification strictly following the rule based on the text's description of the action's purpose/duration**? Is rationale grounded **only in text**? Is JSON perfect? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT IS KING:** All output MUST be based **EXCLUSIVELY** on the provided "USER'S SYSTEM PROBLEM/INITIATIVE DESCRIPTION". **DO NOT** invent information.
            - **ACTION TYPE ACCURACY:** The classification of "Short-Term Fix" vs. "Long-Term Solution" **MUST strictly reflect how the action is described or purposed within the user's text**, following the rule above. Building foundational capabilities for a long-term goal described in the text is LONG-TERM.
            - **NO GENERIC EXAMPLES:** **DO NOT** use the placeholder content in the RETURN FORMAT structure below. Replace ALL placeholder text with content generated **strictly from the user's input text**.
            - **JSON FORMAT:** Adhere EXACTLY.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. Replace ALL bracketed placeholders strictly based on the user's input text and the action classification rule.
            {
              "problem_diagnosis": "[Concise diagnosis/goal derived ONLY from user text]",
              "system_archetype": {
                "name": "[Archetype name or 'Proactive Initiative - No Archetype' identified ONLY from user text]",
                "explanation": "[Detailed explanation linking archetype/initiative ONLY to user's text/concepts, including loops derived ONLY from text if applicable...]",
                "leverage_points": [ // Points derived ONLY from user text/analysis
                    {"point": "[Leverage point derived ONLY from user text]"},
                    {"point": "[Another leverage point derived ONLY from user text]"}
                 ]
              },
              "actions": [ // MUST derive actions ONLY from user text
                {
                  "action_name": "[Action Name derived ONLY from user text]",
                  "type": "[Short-Term Fix or Long-Term Solution based ONLY on text description/purpose rule]",
                  "rationale": "[Rationale linking action using ONLY user text evidence, justifying type classification based on text...]",
                  "impact": "[High/Medium/Low based ONLY on context]",
                  "effort": "[High/Medium/Low based ONLY on context]",
                  "kpis": ["[KPI derived ONLY from context 1]", "[KPI derived ONLY from context 2]"]
                },
                {
                  "action_name": "[Another Action Name derived ONLY from user text]",
                  "type": "[Short-Term Fix or Long-Term Solution based ONLY on text description/purpose rule]",
                  "rationale": "[Rationale linking action using ONLY user text evidence, justifying type classification based on text...]",
                  "impact": "[High/Medium/Low based ONLY on context]",
                  "effort": "[High/Medium/Low based ONLY on context]",
                  "kpis": ["[KPI derived ONLY from context 3]", "[KPI derived ONLY from context 4]"]
                }
                // ... potentially 1-2 more actions derived ONLY from context ...
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending REFINED Context-Focused System Actions prompt (v2) to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (System Actions - Refined Prompt v2):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Use the SAME Robust Validation as before, checking placeholders and structure ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Refined System Actions v2) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !parsedData.problem_diagnosis || typeof parsedData.problem_diagnosis !== 'string' || parsedData.problem_diagnosis.includes("[") ||
                 !parsedData.system_archetype || typeof parsedData.system_archetype !== 'object' ||
                 !parsedData.system_archetype.name || parsedData.system_archetype.name.includes("[") ||
                 !parsedData.system_archetype.explanation || parsedData.system_archetype.explanation.includes("[") ||
                 !Array.isArray(parsedData.system_archetype.leverage_points) ||
                 !Array.isArray(parsedData.actions) || parsedData.actions.length < 1 ||
                  (parsedData.actions.length > 0 && (
                      typeof parsedData.actions[0] !== 'object' ||
                      !parsedData.actions[0].hasOwnProperty('action_name') || parsedData.actions[0].action_name.includes("[") ||
                      !parsedData.actions[0].hasOwnProperty('type') || !['Short-Term Fix', 'Long-Term Solution'].includes(parsedData.actions[0].type) ||
                      !parsedData.actions[0].hasOwnProperty('rationale') || parsedData.actions[0].rationale.includes("[") ||
                      !parsedData.actions[0].hasOwnProperty('impact') ||
                      !parsedData.actions[0].hasOwnProperty('effort') ||
                      !Array.isArray(parsedData.actions[0].kpis) || (parsedData.actions[0].kpis.length > 0 && parsedData.actions[0].kpis[0].includes("["))
                  ))
                )
             {
                  console.error("Validation Failed (Refined System Actions v2): Required fields missing, invalid structure, or placeholders detected.", parsedData);
                  throw new Error(`AI response structure is incorrect, inconsistent, or contains placeholders (Refined System Actions v2). Check all fields carefully. See console logs.`);
             }

             console.log(`Successfully parsed REFINED System Actions JSON (v2) using ${MODEL_NAME}. Found archetype/status: ${parsedData.system_archetype.name}.`);

        } catch (e) {
            console.error(`Failed to parse/validate REFINED System Actions JSON (v2) using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Refined System Actions v2): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results (Using the existing renderer)
        renderSystemActionsPage_ST(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleSystemActionsAnalysis_ST (Refined v2) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


// No changes needed to renderSystemActionsPage_ST as it already handles the structured data.
// Keep the existing renderSystemActionsPage_ST function as it was.
function renderSystemActionsPage_ST(container, data) {
    container.innerHTML = ""; // Clear loading state

    // Add validation for new fields
    if (!data || !data.problem_diagnosis || !data.system_archetype || !data.actions) {
         console.error("Incomplete data passed to renderSystemActionsPage_ST:", data);
         container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render System Actions results.</div>`;
         $("analysisActions").classList.add("hidden");
         return;
    }
    const { problem_diagnosis, system_archetype, actions } = data; // leverage_points are inside system_archetype now


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="actions"> Action Plan</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="dynamics"> System Dynamics</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Actions & Archetypes</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="actionsPanel" class="analysis-tab-panel"></div>
        <div id="dynamicsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- 1. Dashboard Panel (Updated) ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4 space-y-8">
        <blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90">
            <strong>Diagnosis/Goal:</strong> ${problem_diagnosis} <!-- Updated Label -->
        </blockquote>
        <div class="archetype-card text-center">
            <h3 class="text-lg font-bold text-indigo-300">SYSTEM DYNAMIC/ARCHETYPE</h3> <!-- Updated Label -->
            <p class="text-2xl font-semibold mt-1">${system_archetype.name}</p>
        </div>
        <h3 class="text-2xl font-bold text-center">Action Plan Summary</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="actionTypeChart" class="w-full h-[350px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
            <div id="actionCompareChart" class="w-full h-[350px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
        </div>
    </div>`; // Close p-4 space-y-8
    dashboardPanel.innerHTML = dashboardHtml;

    // Chart 1: Action Types
    try {
        const shortTermCount = actions.filter(a => a.type === "Short-Term Fix").length;
        const longTermCount = actions.filter(a => a.type === "Long-Term Solution").length;
        Plotly.newPlot('actionTypeChart', [{
            values: [shortTermCount, longTermCount], labels: ["Short-Term Fixes", "Long-Term Solutions"],
            type: 'pie', hole: 0.4, marker: { colors: ["#f59e0b", "#2563eb"] }, textinfo: 'value+percent', insidetextorientation: 'radial'
        }], {
            title: 'Action Type Breakdown', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }, showlegend: true, legend: { orientation: 'h', y: -0.1 }, margin: { t: 40, b: 40, l: 20, r: 20 }
        }, { responsive: true });
    } catch(e){ console.error("Chart err 1:",e); $("actionTypeChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }

    // Chart 2: Impact vs Effort (ensure mapping exists)
    try {
        const valueMap = { Low: 1, Medium: 2, High: 3 };
        const actionNames = actions.map(a => a.action_name);
        // Add default values (e.g., 1 for 'Low') if impact/effort missing
        const impactValues = actions.map(a => valueMap[a.impact] || 1);
        const effortValues = actions.map(a => valueMap[a.effort] || 1);

        const impactTrace = { y: actionNames, x: impactValues, name: 'Impact', type: 'bar', orientation: 'h', marker: { color: 'var(--accent)' } };
        const effortTrace = { y: actionNames, x: effortValues, name: 'Effort', type: 'bar', orientation: 'h', marker: { color: 'rgba(255,255,255,0.4)' } };
        Plotly.newPlot('actionCompareChart', [impactTrace, effortTrace], {
            title: 'Impact vs. Effort Comparison', barmode: 'group', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }, yaxis: { automargin: true, tickfont: {size: 10} }, // Smaller font size
            xaxis: { tickvals: [1, 2, 3], ticktext: ['Low', 'Medium', 'High'], gridcolor: "rgba(255,255,255,0.1)" }, // Lighter grid
            legend: { x: 0.5, y: -0.2, xanchor: 'center', orientation: 'h' }, // Center legend below
            margin: { t: 40, b: 60, l: 150, r: 20 } // Adjust margins maybe
        }, { responsive: true });
     } catch(e){ console.error("Chart err 2:",e); $("actionCompareChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }


    // --- 2. Action Plan Panel (Updated) ---
    const actionsPanel = $("actionsPanel");
    let actionsHtml = `<div class="p-4 space-y-6">`;
    // Separate actions by type
    const shortTermActions = actions.filter(a => a.type === "Short-Term Fix");
    const longTermActions = actions.filter(a => a.type === "Long-Term Solution");

    if (shortTermActions.length > 0) {
         actionsHtml += `<h3 class="text-xl font-bold mb-3 text-yellow-400 border-b border-yellow-400/50 pb-1"> Short-Term Fixes (Symptomatic)</h3>`;
         shortTermActions.forEach((a) => {
             actionsHtml += `<div class="action-card short-term"> <!-- Added class -->
                                <h4 class="text-lg font-bold">${a.action_name}</h4>
                                <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${a.impact || "?"} | <span class="text-blue-300">Effort:</span> ${a.effort || "?"}</p>
                                <p class="rationale"><strong>Rationale:</strong> ${a.rationale || "N/A"}</p>
                                <div class="bg-black/20 p-3 rounded text-sm mt-3">
                                    <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                                    <ul class="list-disc list-inside space-y-1 text-white/90">${(a.kpis || []).map(k => `<li>${k}</li>`).join('')}</ul>
                                </div>
                            </div>`;
         });
    }

    if (longTermActions.length > 0) {
         actionsHtml += `<h3 class="text-xl font-bold mt-8 mb-3 text-blue-400 border-b border-blue-400/50 pb-1"> Long-Term Solutions (Structural)</h3>`;
         longTermActions.forEach((a) => {
             actionsHtml += `<div class="action-card long-term"> <!-- Added class -->
                                <h4 class="text-lg font-bold">${a.action_name}</h4>
                                <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${a.impact || "?"} | <span class="text-blue-300">Effort:</span> ${a.effort || "?"}</p>
                                <p class="rationale"><strong>Rationale:</strong> ${a.rationale || "N/A"}</p>
                                <div class="bg-black/20 p-3 rounded text-sm mt-3">
                                    <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                                    <ul class="list-disc list-inside space-y-1 text-white/90">${(a.kpis || []).map(k => `<li>${k}</li>`).join('')}</ul>
                                </div>
                            </div>`;
         });
    }
     if (shortTermActions.length === 0 && longTermActions.length === 0) {
         actionsHtml += `<p class="text-center text-white/70 italic">No specific actions were generated based on the problem description.</p>`;
     }

    actionsHtml += `</div>`; // Close p-4 space-y-6
    actionsPanel.innerHTML = actionsHtml;


    // --- 3. System Dynamics Panel (Updated) ---
    const dynamicsPanel = $("dynamicsPanel");
    let dynamicsHtml = `<div class="p-4 space-y-6">
        <div class="archetype-card">
            <h3 class="text-lg font-bold text-indigo-300">SYSTEM DYNAMIC / ARCHETYPE IDENTIFIED</h3> <!-- Updated Label -->
            <p class="text-2xl font-semibold mt-1">${system_archetype.name}</p>
            <p class="text-sm text-white/80 mt-2 italic">${system_archetype.explanation}</p>
        </div>`;
        // Leverage points are now inside archetype object
        if (system_archetype.leverage_points && system_archetype.leverage_points.length > 0) {
             dynamicsHtml += `<div class="insight-card">
                                <h4 class="text-lg font-bold text-yellow-300">Key Leverage Points (Derived from Archetype & Context):</h4>
                                <ul class="list-disc list-inside space-y-2 mt-2 text-white/90">`;
             system_archetype.leverage_points.forEach((lp) => {
                 // Check if lp is an object with 'point' property, otherwise assume it's a string
                 const pointText = (typeof lp === 'object' && lp.point) ? lp.point : String(lp);
                 dynamicsHtml += `<li>${pointText}</li>`;
             });
             dynamicsHtml += `</ul></div>`;
        } else {
             dynamicsHtml += `<p class="text-center text-white/70 italic">No specific leverage points explicitly identified for this archetype/dynamic in the context.</p>`; // Modified text
        }
     dynamicsHtml += `</div>`; // Close p-4 space-y-6
    dynamicsPanel.innerHTML = dynamicsHtml;


    // --- 4. Populate Learn Actions & Archetypes Panel (Keep as is) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Actions in Systems</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Intervening in Complex Systems</h4>
            <p class="text-sm text-white/80">When dealing with systemic problems revealed by archetypes, interventions (actions) need to be carefully considered. Actions can target different leverage points and have varying time horizons and potential side effects.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50">
                <h4 class="text-xl font-bold text-yellow-300 mb-2"> Short-Term Fixes (Symptomatic Solutions)</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Goal:</strong> Alleviate immediate pressure or visible symptoms.</li>
                    <li><strong>Pros:</strong> Quick relief, buys time, politically easier.</li>
                    <li><strong>Cons:</strong> Doesn't solve the root cause, may have unintended negative side effects, can create dependency (as in "Shifting the Burden").</li>
                    <li><strong>Example:</strong> Hiring temporary staff to handle a surge instead of fixing the underlying process causing the surge.</li>
                    <li><strong>When to Use:</strong> Sparingly, as a bridge to a fundamental solution, or when immediate relief is critical.</li>
                </ul>
            </div>
            <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                <h4 class="text-xl font-bold text-blue-300 mb-2"> Long-Term Solutions (Structural Interventions)</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Goal:</strong> Address the root cause by changing the system's structure (loops, delays, goals, rules).</li>
                    <li><strong>Pros:</strong> Sustainable improvement, prevents recurrence, builds resilience.</li>
                    <li><strong>Cons:</strong> Often slower to implement, requires deeper understanding, may face resistance, results may be delayed.</li>
                    <li><strong>Example:</strong> Redesigning the process to eliminate the cause of the surge, changing performance metrics that incentivize bad behavior.</li>
                    <li><strong>When to Use:</strong> Whenever possible for lasting change. Often requires combining with short-term fixes initially.</li>
                </ul>
            </div>
        </div>

         <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
            <h4 class="text-lg font-bold mb-2">Linking Actions to Archetypes:</h4>
            <p class="text-sm text-white/80 mb-2">The most effective actions target the specific structure of the identified archetype:</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Limits to Growth:</strong> Focus on removing or easing the limiting condition (B loop) OR managing the growth engine (R loop).</li>
                <li><strong>Shifting the Burden:</strong> Strengthen the fundamental solution while weakening the symptomatic one.</li>
                <li><strong>Fixes that Fail:</strong> Map out and address the unintended consequences; anticipate delays.</li>
                <li><strong>Tragedy of the Commons:</strong> Change the rules/incentives governing resource use.</li>
                <li><strong>Success to the Successful:</strong> Re-evaluate resource allocation; create level playing fields.</li>
                <li><strong>Escalation:</strong> Find ways to de-escalate; focus on shared goals.</li>
            </ul>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool attempts to categorize actions and link them to the identified archetype's dynamics based on your input.</p>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (ensure resizing happens)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // Resize charts if the Dashboard tab is activated
                 const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                 chartsInPanel.forEach(chartDiv => {
                      if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                          try {
                              Plotly.Plots.resize(chartDiv);
                          } catch (resizeError) {
                               console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                          }
                      }
                 });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Initial resize for charts in the default active tab (Dashboard)
     setTimeout(() => {
          const activePanel = tabContent.querySelector('.analysis-tab-panel.active');
          if (activePanel) {
              activePanel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                  if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                      try {
                           Plotly.Plots.resize(chartDiv);
                      } catch (initialResizeError) {
                           console.error(`Error during initial resize ${chartDiv.id}:`, initialResizeError);
                      }
                  }
              });
          }
     }, 150);


    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}




// No changes needed to renderSystemActionsPage_ST as it already handles the structured data.
// Keep the existing renderSystemActionsPage_ST function as it was.
function renderSystemActionsPage_ST(container, data) {
    container.innerHTML = ""; // Clear loading state

    // Add validation for new fields
    if (!data || !data.problem_diagnosis || !data.system_archetype || !data.actions) {
         console.error("Incomplete data passed to renderSystemActionsPage_ST:", data);
         container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render System Actions results.</div>`;
         $("analysisActions").classList.add("hidden");
         return;
    }
    const { problem_diagnosis, system_archetype, actions } = data; // leverage_points are inside system_archetype now


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="actions"> Action Plan</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="dynamics"> System Dynamics</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Actions & Archetypes</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="actionsPanel" class="analysis-tab-panel"></div>
        <div id="dynamicsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- 1. Dashboard Panel (Updated) ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4 space-y-8">
        <blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90">
            <strong>Problem Diagnosis:</strong> ${problem_diagnosis}
        </blockquote>
        <div class="archetype-card text-center">
            <h3 class="text-lg font-bold text-indigo-300">DOMINANT ARCHETYPE</h3>
            <p class="text-2xl font-semibold mt-1">${system_archetype.name}</p>
        </div>
        <h3 class="text-2xl font-bold text-center">Action Plan Summary</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="actionTypeChart" class="w-full h-[350px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
            <div id="actionCompareChart" class="w-full h-[350px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
        </div>
    </div>`; // Close p-4 space-y-8
    dashboardPanel.innerHTML = dashboardHtml;

    // Chart 1: Action Types
    try {
        const shortTermCount = actions.filter(a => a.type === "Short-Term Fix").length;
        const longTermCount = actions.filter(a => a.type === "Long-Term Solution").length;
        Plotly.newPlot('actionTypeChart', [{
            values: [shortTermCount, longTermCount], labels: ["Short-Term Fixes", "Long-Term Solutions"],
            type: 'pie', hole: 0.4, marker: { colors: ["#f59e0b", "#2563eb"] }, textinfo: 'value+percent', insidetextorientation: 'radial'
        }], {
            title: 'Action Type Breakdown', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }, showlegend: true, legend: { orientation: 'h', y: -0.1 }, margin: { t: 40, b: 40, l: 20, r: 20 }
        }, { responsive: true });
    } catch(e){ console.error("Chart err 1:",e); $("actionTypeChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }

    // Chart 2: Impact vs Effort (ensure mapping exists)
    try {
        const valueMap = { Low: 1, Medium: 2, High: 3 };
        const actionNames = actions.map(a => a.action_name);
        // Add default values (e.g., 1 for 'Low') if impact/effort missing
        const impactValues = actions.map(a => valueMap[a.impact] || 1);
        const effortValues = actions.map(a => valueMap[a.effort] || 1);

        const impactTrace = { y: actionNames, x: impactValues, name: 'Impact', type: 'bar', orientation: 'h', marker: { color: 'var(--accent)' } };
        const effortTrace = { y: actionNames, x: effortValues, name: 'Effort', type: 'bar', orientation: 'h', marker: { color: 'rgba(255,255,255,0.4)' } };
        Plotly.newPlot('actionCompareChart', [impactTrace, effortTrace], {
            title: 'Impact vs. Effort Comparison', barmode: 'group', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }, yaxis: { automargin: true, tickfont: {size: 10} }, // Smaller font size
            xaxis: { tickvals: [1, 2, 3], ticktext: ['Low', 'Medium', 'High'], gridcolor: "rgba(255,255,255,0.1)" }, // Lighter grid
            legend: { x: 0.5, y: -0.2, xanchor: 'center', orientation: 'h' }, // Center legend below
            margin: { t: 40, b: 60, l: 150, r: 20 } // Adjust margins maybe
        }, { responsive: true });
     } catch(e){ console.error("Chart err 2:",e); $("actionCompareChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }


    // --- 2. Action Plan Panel (Updated) ---
    const actionsPanel = $("actionsPanel");
    let actionsHtml = `<div class="p-4 space-y-6">`;
    // Separate actions by type
    const shortTermActions = actions.filter(a => a.type === "Short-Term Fix");
    const longTermActions = actions.filter(a => a.type === "Long-Term Solution");

    if (shortTermActions.length > 0) {
         actionsHtml += `<h3 class="text-xl font-bold mb-3 text-yellow-400 border-b border-yellow-400/50 pb-1"> Short-Term Fixes (Symptomatic)</h3>`;
         shortTermActions.forEach((a) => {
             actionsHtml += `<div class="action-card short-term"> <!-- Added class -->
                                <h4 class="text-lg font-bold">${a.action_name}</h4>
                                <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${a.impact || "?"} | <span class="text-blue-300">Effort:</span> ${a.effort || "?"}</p>
                                <p class="rationale"><strong>Rationale:</strong> ${a.rationale || "N/A"}</p>
                                <div class="bg-black/20 p-3 rounded text-sm mt-3">
                                    <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                                    <ul class="list-disc list-inside space-y-1 text-white/90">${(a.kpis || []).map(k => `<li>${k}</li>`).join('')}</ul>
                                </div>
                            </div>`;
         });
    }

    if (longTermActions.length > 0) {
         actionsHtml += `<h3 class="text-xl font-bold mt-8 mb-3 text-blue-400 border-b border-blue-400/50 pb-1"> Long-Term Solutions (Structural)</h3>`;
         longTermActions.forEach((a) => {
             actionsHtml += `<div class="action-card long-term"> <!-- Added class -->
                                <h4 class="text-lg font-bold">${a.action_name}</h4>
                                <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${a.impact || "?"} | <span class="text-blue-300">Effort:</span> ${a.effort || "?"}</p>
                                <p class="rationale"><strong>Rationale:</strong> ${a.rationale || "N/A"}</p>
                                <div class="bg-black/20 p-3 rounded text-sm mt-3">
                                    <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                                    <ul class="list-disc list-inside space-y-1 text-white/90">${(a.kpis || []).map(k => `<li>${k}</li>`).join('')}</ul>
                                </div>
                            </div>`;
         });
    }
     if (shortTermActions.length === 0 && longTermActions.length === 0) {
         actionsHtml += `<p class="text-center text-white/70 italic">No specific actions were generated based on the problem description.</p>`;
     }

    actionsHtml += `</div>`; // Close p-4 space-y-6
    actionsPanel.innerHTML = actionsHtml;


    // --- 3. System Dynamics Panel (Updated) ---
    const dynamicsPanel = $("dynamicsPanel");
    let dynamicsHtml = `<div class="p-4 space-y-6">
        <div class="archetype-card">
            <h3 class="text-lg font-bold text-indigo-300">IDENTIFIED ARCHETYPE</h3>
            <p class="text-2xl font-semibold mt-1">${system_archetype.name}</p>
            <p class="text-sm text-white/80 mt-2 italic">${system_archetype.explanation}</p>
        </div>`;
        // Leverage points are now inside archetype object
        if (system_archetype.leverage_points && system_archetype.leverage_points.length > 0) {
             dynamicsHtml += `<div class="insight-card">
                                <h4 class="text-lg font-bold text-yellow-300">Key Leverage Points (Derived from Archetype & Context):</h4>
                                <ul class="list-disc list-inside space-y-2 mt-2 text-white/90">`;
             system_archetype.leverage_points.forEach((lp) => {
                 // Check if lp is an object with 'point' property, otherwise assume it's a string
                 const pointText = (typeof lp === 'object' && lp.point) ? lp.point : String(lp);
                 dynamicsHtml += `<li>${pointText}</li>`;
             });
             dynamicsHtml += `</ul></div>`;
        } else {
             dynamicsHtml += `<p class="text-center text-white/70 italic">No specific leverage points explicitly identified for this archetype in the context.</p>`;
        }
     dynamicsHtml += `</div>`; // Close p-4 space-y-6
    dynamicsPanel.innerHTML = dynamicsHtml;


    // --- 4. Populate Learn Actions & Archetypes Panel (New) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Actions in Systems</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Intervening in Complex Systems</h4>
            <p class="text-sm text-white/80">When dealing with systemic problems revealed by archetypes, interventions (actions) need to be carefully considered. Actions can target different leverage points and have varying time horizons and potential side effects.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50">
                <h4 class="text-xl font-bold text-yellow-300 mb-2"> Short-Term Fixes (Symptomatic Solutions)</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Goal:</strong> Alleviate immediate pressure or visible symptoms.</li>
                    <li><strong>Pros:</strong> Quick relief, buys time, politically easier.</li>
                    <li><strong>Cons:</strong> Doesn't solve the root cause, may have unintended negative side effects, can create dependency (as in "Shifting the Burden").</li>
                    <li><strong>Example:</strong> Hiring temporary staff to handle a surge instead of fixing the underlying process causing the surge.</li>
                    <li><strong>When to Use:</strong> Sparingly, as a bridge to a fundamental solution, or when immediate relief is critical.</li>
                </ul>
            </div>
            <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                <h4 class="text-xl font-bold text-blue-300 mb-2"> Long-Term Solutions (Structural Interventions)</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Goal:</strong> Address the root cause by changing the system's structure (loops, delays, goals, rules).</li>
                    <li><strong>Pros:</strong> Sustainable improvement, prevents recurrence, builds resilience.</li>
                    <li><strong>Cons:</strong> Often slower to implement, requires deeper understanding, may face resistance, results may be delayed.</li>
                    <li><strong>Example:</strong> Redesigning the process to eliminate the cause of the surge, changing performance metrics that incentivize bad behavior.</li>
                    <li><strong>When to Use:</strong> Whenever possible for lasting change. Often requires combining with short-term fixes initially.</li>
                </ul>
            </div>
        </div>

         <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
            <h4 class="text-lg font-bold mb-2">Linking Actions to Archetypes:</h4>
            <p class="text-sm text-white/80 mb-2">The most effective actions target the specific structure of the identified archetype:</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Limits to Growth:</strong> Focus on removing or easing the limiting condition (B loop) OR managing the growth engine (R loop).</li>
                <li><strong>Shifting the Burden:</strong> Strengthen the fundamental solution while weakening the symptomatic one.</li>
                <li><strong>Fixes that Fail:</strong> Map out and address the unintended consequences; anticipate delays.</li>
                <li><strong>Tragedy of the Commons:</strong> Change the rules/incentives governing resource use.</li>
                <li><strong>Success to the Successful:</strong> Re-evaluate resource allocation; create level playing fields.</li>
                <li><strong>Escalation:</strong> Find ways to de-escalate; focus on shared goals.</li>
            </ul>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool attempts to categorize actions and link them to the identified archetype's dynamics based on your input.</p>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (ensure resizing happens)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // Resize charts if the Dashboard tab is activated
                 const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                 chartsInPanel.forEach(chartDiv => {
                      if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                          try {
                              Plotly.Plots.resize(chartDiv);
                          } catch (resizeError) {
                               console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                          }
                      }
                 });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Initial resize for charts in the default active tab (Dashboard)
     setTimeout(() => {
          const activePanel = tabContent.querySelector('.analysis-tab-panel.active');
          if (activePanel) {
              activePanel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                  if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                      try {
                           Plotly.Plots.resize(chartDiv);
                      } catch (initialResizeError) {
                           console.error(`Error during initial resize ${chartDiv.id}:`, initialResizeError);
                      }
                  }
              });
          }
     }, 150);


    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}



function renderSystemActionsPage_ST(container, data) {
    container.innerHTML = ""; // Clear loading state

    // Add validation for new fields
    if (!data || !data.problem_diagnosis || !data.system_archetype || !data.actions) {
         console.error("Incomplete data passed to renderSystemActionsPage_ST:", data);
         container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render System Actions results.</div>`;
         $("analysisActions").classList.add("hidden");
         return;
    }
    const { problem_diagnosis, system_archetype, actions } = data; // leverage_points are inside system_archetype now


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="actions"> Action Plan</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="dynamics"> System Dynamics</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Actions & Archetypes</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="actionsPanel" class="analysis-tab-panel"></div>
        <div id="dynamicsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- 1. Dashboard Panel (Updated) ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4 space-y-8">
        <blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90">
            <strong>Problem Diagnosis:</strong> ${problem_diagnosis}
        </blockquote>
        <div class="archetype-card text-center">
            <h3 class="text-lg font-bold text-indigo-300">DOMINANT ARCHETYPE</h3>
            <p class="text-2xl font-semibold mt-1">${system_archetype.name}</p>
        </div>
        <h3 class="text-2xl font-bold text-center">Action Plan Summary</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="actionTypeChart" class="w-full h-[350px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
            <div id="actionCompareChart" class="w-full h-[350px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
        </div>
    </div>`; // Close p-4 space-y-8
    dashboardPanel.innerHTML = dashboardHtml;

    // Chart 1: Action Types
    try {
        const shortTermCount = actions.filter(a => a.type === "Short-Term Fix").length;
        const longTermCount = actions.filter(a => a.type === "Long-Term Solution").length;
        Plotly.newPlot('actionTypeChart', [{
            values: [shortTermCount, longTermCount], labels: ["Short-Term Fixes", "Long-Term Solutions"],
            type: 'pie', hole: 0.4, marker: { colors: ["#f59e0b", "#2563eb"] }, textinfo: 'value+percent', insidetextorientation: 'radial'
        }], {
            title: 'Action Type Breakdown', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }, showlegend: true, legend: { orientation: 'h', y: -0.1 }, margin: { t: 40, b: 40, l: 20, r: 20 }
        }, { responsive: true });
    } catch(e){ console.error("Chart err 1:",e); $("actionTypeChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }

    // Chart 2: Impact vs Effort (ensure mapping exists)
    try {
        const valueMap = { Low: 1, Medium: 2, High: 3 };
        const actionNames = actions.map(a => a.action_name);
        // Add default values (e.g., 1 for 'Low') if impact/effort missing
        const impactValues = actions.map(a => valueMap[a.impact] || 1);
        const effortValues = actions.map(a => valueMap[a.effort] || 1);

        const impactTrace = { y: actionNames, x: impactValues, name: 'Impact', type: 'bar', orientation: 'h', marker: { color: 'var(--accent)' } };
        const effortTrace = { y: actionNames, x: effortValues, name: 'Effort', type: 'bar', orientation: 'h', marker: { color: 'rgba(255,255,255,0.4)' } };
        Plotly.newPlot('actionCompareChart', [impactTrace, effortTrace], {
            title: 'Impact vs. Effort Comparison', barmode: 'group', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }, yaxis: { automargin: true, tickfont: {size: 10} }, // Smaller font size
            xaxis: { tickvals: [1, 2, 3], ticktext: ['Low', 'Medium', 'High'], gridcolor: "rgba(255,255,255,0.1)" }, // Lighter grid
            legend: { x: 0.5, y: -0.2, xanchor: 'center', orientation: 'h' }, // Center legend below
            margin: { t: 40, b: 60, l: 150, r: 20 } // Adjust margins maybe
        }, { responsive: true });
     } catch(e){ console.error("Chart err 2:",e); $("actionCompareChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }


    // --- 2. Action Plan Panel (Updated) ---
    const actionsPanel = $("actionsPanel");
    let actionsHtml = `<div class="p-4 space-y-6">`;
    // Separate actions by type
    const shortTermActions = actions.filter(a => a.type === "Short-Term Fix");
    const longTermActions = actions.filter(a => a.type === "Long-Term Solution");

    if (shortTermActions.length > 0) {
         actionsHtml += `<h3 class="text-xl font-bold mb-3 text-yellow-400 border-b border-yellow-400/50 pb-1"> Short-Term Fixes (Symptomatic)</h3>`;
         shortTermActions.forEach((a) => {
             actionsHtml += `<div class="action-card short-term"> <!-- Added class -->
                                <h4 class="text-lg font-bold">${a.action_name}</h4>
                                <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${a.impact || "?"} | <span class="text-blue-300">Effort:</span> ${a.effort || "?"}</p>
                                <p class="rationale"><strong>Rationale:</strong> ${a.rationale || "N/A"}</p>
                                <div class="bg-black/20 p-3 rounded text-sm mt-3">
                                    <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                                    <ul class="list-disc list-inside space-y-1 text-white/90">${(a.kpis || []).map(k => `<li>${k}</li>`).join('')}</ul>
                                </div>
                            </div>`;
         });
    }

    if (longTermActions.length > 0) {
         actionsHtml += `<h3 class="text-xl font-bold mt-8 mb-3 text-blue-400 border-b border-blue-400/50 pb-1"> Long-Term Solutions (Structural)</h3>`;
         longTermActions.forEach((a) => {
             actionsHtml += `<div class="action-card long-term"> <!-- Added class -->
                                <h4 class="text-lg font-bold">${a.action_name}</h4>
                                <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${a.impact || "?"} | <span class="text-blue-300">Effort:</span> ${a.effort || "?"}</p>
                                <p class="rationale"><strong>Rationale:</strong> ${a.rationale || "N/A"}</p>
                                <div class="bg-black/20 p-3 rounded text-sm mt-3">
                                    <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                                    <ul class="list-disc list-inside space-y-1 text-white/90">${(a.kpis || []).map(k => `<li>${k}</li>`).join('')}</ul>
                                </div>
                            </div>`;
         });
    }
     if (shortTermActions.length === 0 && longTermActions.length === 0) {
         actionsHtml += `<p class="text-center text-white/70 italic">No specific actions were generated based on the problem description.</p>`;
     }

    actionsHtml += `</div>`; // Close p-4 space-y-6
    actionsPanel.innerHTML = actionsHtml;


    // --- 3. System Dynamics Panel (Updated) ---
    const dynamicsPanel = $("dynamicsPanel");
    let dynamicsHtml = `<div class="p-4 space-y-6">
        <div class="archetype-card">
            <h3 class="text-lg font-bold text-indigo-300">IDENTIFIED ARCHETYPE</h3>
            <p class="text-2xl font-semibold mt-1">${system_archetype.name}</p>
            <p class="text-sm text-white/80 mt-2 italic">${system_archetype.explanation}</p>
        </div>`;
        // Leverage points are now inside archetype object
        if (system_archetype.leverage_points && system_archetype.leverage_points.length > 0) {
             dynamicsHtml += `<div class="insight-card">
                                <h4 class="text-lg font-bold text-yellow-300">Key Leverage Points:</h4>
                                <ul class="list-disc list-inside space-y-2 mt-2 text-white/90">`;
             system_archetype.leverage_points.forEach((lp) => {
                 dynamicsHtml += `<li>${lp.point || lp}</li>`; // Handle if structure is just strings
             });
             dynamicsHtml += `</ul></div>`;
        } else {
             dynamicsHtml += `<p class="text-center text-white/70 italic">No specific leverage points explicitly identified for this archetype in the context.</p>`;
        }
     dynamicsHtml += `</div>`; // Close p-4 space-y-6
    dynamicsPanel.innerHTML = dynamicsHtml;


    // --- 4. Populate Learn Actions & Archetypes Panel (New) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Actions in Systems</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Intervening in Complex Systems</h4>
            <p class="text-sm text-white/80">When dealing with systemic problems revealed by archetypes, interventions (actions) need to be carefully considered. Actions can target different leverage points and have varying time horizons and potential side effects.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50">
                <h4 class="text-xl font-bold text-yellow-300 mb-2"> Short-Term Fixes (Symptomatic Solutions)</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Goal:</strong> Alleviate immediate pressure or visible symptoms.</li>
                    <li><strong>Pros:</strong> Quick relief, buys time, politically easier.</li>
                    <li><strong>Cons:</strong> Doesn't solve the root cause, may have unintended negative side effects, can create dependency (as in "Shifting the Burden").</li>
                    <li><strong>Example:</strong> Hiring temporary staff to handle a surge instead of fixing the underlying process causing the surge.</li>
                    <li><strong>When to Use:</strong> Sparingly, as a bridge to a fundamental solution, or when immediate relief is critical.</li>
                </ul>
            </div>
            <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                <h4 class="text-xl font-bold text-blue-300 mb-2"> Long-Term Solutions (Structural Interventions)</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Goal:</strong> Address the root cause by changing the system's structure (loops, delays, goals, rules).</li>
                    <li><strong>Pros:</strong> Sustainable improvement, prevents recurrence, builds resilience.</li>
                    <li><strong>Cons:</strong> Often slower to implement, requires deeper understanding, may face resistance, results may be delayed.</li>
                    <li><strong>Example:</strong> Redesigning the process to eliminate the cause of the surge, changing performance metrics that incentivize bad behavior.</li>
                    <li><strong>When to Use:</strong> Whenever possible for lasting change. Often requires combining with short-term fixes initially.</li>
                </ul>
            </div>
        </div>

         <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
            <h4 class="text-lg font-bold mb-2">Linking Actions to Archetypes:</h4>
            <p class="text-sm text-white/80 mb-2">The most effective actions target the specific structure of the identified archetype:</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Limits to Growth:</strong> Focus on removing or easing the limiting condition (B loop) OR managing the growth engine (R loop).</li>
                <li><strong>Shifting the Burden:</strong> Strengthen the fundamental solution while weakening the symptomatic one.</li>
                <li><strong>Fixes that Fail:</strong> Map out and address the unintended consequences; anticipate delays.</li>
                <li><strong>Tragedy of the Commons:</strong> Change the rules/incentives governing resource use.</li>
                <li><strong>Success to the Successful:</strong> Re-evaluate resource allocation; create level playing fields.</li>
                <li><strong>Escalation:</strong> Find ways to de-escalate; focus on shared goals.</li>
            </ul>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool attempts to categorize actions and link them to the identified archetype's dynamics based on your input.</p>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (ensure resizing happens)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // Resize charts if the Dashboard tab is activated
                 const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                 chartsInPanel.forEach(chartDiv => {
                      if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                          try {
                              Plotly.Plots.resize(chartDiv);
                          } catch (resizeError) {
                               console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                          }
                      }
                 });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Initial resize for charts in the default active tab (Dashboard)
     setTimeout(() => {
          const activePanel = tabContent.querySelector('.analysis-tab-panel.active');
          if (activePanel) {
              activePanel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                  if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                      try {
                           Plotly.Plots.resize(chartDiv);
                      } catch (initialResizeError) {
                           console.error(`Error during initial resize ${chartDiv.id}:`, initialResizeError);
                      }
                  }
              });
          }
     }, 150);


    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}



    function createSystemObjectivesLayout_ST(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe Your System & Desired Outcome</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="systemObjContent" class="input-field h-48" placeholder="Describe the system and what you want to achieve. For example: 'Our user base is growing, but engagement is low. We want to increase the daily active user rate.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="systemObjFile" id="systemObjFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="systemObjFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Set System-Aware Objectives</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Systemic Objective Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("systemObjFile", "systemObjFileLabel", "textInputArea", "docUploadArea");
    }

    async function handleSystemObjectivesAnalysis_ST() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Analyzing System Dynamics...</h3><p class="text-white/80 mb-2">Formulating objectives based on feedback loops...</p></div>`;

        try {
            const useDoc = $("docUpload").checked;
            let text = "";
            if (useDoc) {
                const file = $("systemObjFile").files[0];
                if (!file) throw new Error("Please select a document.");
                text = await extractTextFromFile(file);
            } else {
                text = $("systemObjContent").value;
                if (!text.trim()) throw new Error("Please describe your system and goal.");
            }
            if (text.length > 15000) {
                text = text.substring(0, 15000);
            }

            const prompt = `
                        You are a systems thinking strategist. A user has described a system and a desired outcome. Your task is to structure an OGSI (Objective, Goals, Strategies, Initiatives) plan that is explicitly based on the system's feedback loops.

                        **System Context:**
                        ${text}

                        **TASK:**
                        Analyze the context and generate a complete OGSI plan.

                        1.  **main_objective**: Refine the user's input into a single, high-level, aspirational Objective.
                        2.  **feedback_loops**: Identify the most critical 'reinforcing_loop' (growth engine) and 'balancing_loop' (limiting factor) that affect the objective.
                        3.  **goals**: Define 2-3 specific, measurable Goals that contribute to the main objective.
                        4.  **strategies_and_initiatives**: An array where each item links a Goal to a system-aware Strategy and concrete Initiatives. For each item:
                            - "goal": The name of the goal it addresses.
                            - "strategy": A specific strategy designed to either **amplify the reinforcing loop** or **weaken the balancing loop**. The rationale must be explicit about this.
                            - "initiatives": An array of 2-3 specific action items to execute the strategy.
                            - "kpis": A list of 2-3 KPIs to track the success of the initiatives.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "main_objective": "Transform our platform from a simple tool into a highly engaging, self-reinforcing ecosystem.",
                          "feedback_loops": {
                            "reinforcing_loop": "The 'Network Effect Loop': More active users create more valuable content, which attracts more new users, further increasing activity and value.",
                            "balancing_loop": "The 'New User Confusion Loop': A rapid influx of new users who don't understand the platform leads to low-quality contributions and clutters the experience for existing users, causing churn."
                          },
                          "goals": ["Increase Daily Active Users (DAU) by 50%", "Increase User-Generated Content by 100%"],
                          "strategies_and_initiatives": [
                            {
                              "goal": "Increase Daily Active Users (DAU) by 50%",
                              "strategy": "Amplify the 'Network Effect Loop' by making high-quality content more discoverable and rewarding its creators.",
                              "initiatives": [
                                "Develop a new content recommendation algorithm.",
                                "Launch a 'Top Creator of the Week' feature with platform-wide visibility.",
                                "Implement a user-friendly onboarding tutorial."
                              ],
                              "kpis": ["Daily Active Users", "Average Session Duration", "Content Share Rate"]
                            },
                            {
                              "goal": "Increase User-Generated Content by 100%",
                              "strategy": "Weaken the 'New User Confusion Loop' by improving the quality of first-time contributions and reducing friction for new creators.",
                              "initiatives": [
                                "Introduce content creation templates for new users.",
                                "Create a mentorship program pairing new users with experienced 'superusers'.",
                                "Gamify the content creation process with badges and rewards."
                              ],
                              "kpis": ["New Content Submissions per Day", "First-to-Second Post Conversion Rate", "User Retention Rate (30-day)"]
                            }
                          ]
                        }
                    `;

            const response = await fetch("https://ollama.data2int.com/api/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "llama3.1:latest",
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: { num_ctx: 32768 }
                })
            });
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const data = await response.json();
            const parsedData = JSON.parse(data.response);
            renderSystemObjectivesPage_ST(analysisResultContainer, parsedData);
        } catch (error) {
            console.error("Error during System Objectives analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
        } finally {
            setLoading("generate", false);
        }
    }

    function renderSystemObjectivesPage_ST(container, data) {
        container.innerHTML = "";
        const { main_objective, feedback_loops, goals, strategies_and_initiatives } = data;
        if (!main_objective || !feedback_loops || !goals) {
            container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`;
            return;
        }

        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="dashboard"> Strategic Dashboard</button><button class="analysis-tab-btn" data-tab="strategies"> Goals & Strategies</button><button class="analysis-tab-btn" data-tab="initiatives"> Initiatives & KPIs</button>`;
        container.appendChild(tabNav);

        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `<div id="dashboardPanel" class="analysis-tab-panel active"></div><div id="strategiesPanel" class="analysis-tab-panel"></div><div id="initiativesPanel" class="analysis-tab-panel"></div>`;

        // --- 1. Dashboard Panel ---
        const dashboardPanel = $("dashboardPanel");
        let dashboardHtml = `<div class="st-dashboard-container">
                    <div class="st-objective-card">
                        <h3 class="text-xl font-bold text-indigo-300">MAIN OBJECTIVE</h3>
                        <p class="text-2xl font-semibold mt-2">${main_objective}</p>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-center mb-4">Key Goals</h3>
                        <div class="st-goals-grid">`;
        goals.forEach((goal) => {
            dashboardHtml += `<div class="st-goal-card"><p class="text-lg font-bold">${goal}</p></div>`;
        });
        dashboardHtml += `</div></div>
                    <div>
                        <h3 class="text-2xl font-bold text-center mb-4">Influential System Dynamics</h3>
                        <div class="st-loops-grid">
                            <div class="bg-white/5 p-4 rounded-lg border-l-4 border-green-400"><h4 class="text-lg font-bold"> Reinforcing Loop</h4><p class="text-sm text-white/80 my-2">${feedback_loops.reinforcing_loop}</p></div>
                            <div class="bg-white/5 p-4 rounded-lg border-l-4 border-yellow-400"><h4 class="text-lg font-bold"> Balancing Loop</h4><p class="text-sm text-white/80 my-2">${feedback_loops.balancing_loop}</p></div>
                        </div>
                    </div>
                </div>`;
        dashboardPanel.innerHTML = dashboardHtml;

        // --- 2. Goals & Strategies Panel ---
        const strategiesPanel = $("strategiesPanel");
        let strategiesHtml = `<div class="p-4 space-y-6">`;
        strategies_and_initiatives.forEach((item) => {
            strategiesHtml += `<div class="prescription-card">
                        <p class="text-sm font-semibold text-indigo-300">GOAL</p>
                        <h4 class="text-2xl font-bold mb-2">${item.goal}</h4>
                        <p class="rationale"><strong>System-Aware Strategy:</strong> ${item.strategy}</p>
                    </div>`;
        });
        strategiesHtml += `</div>`;
        strategiesPanel.innerHTML = strategiesHtml;

        // --- 3. Initiatives & KPIs Panel ---
        const initiativesPanel = $("initiativesPanel");
        let initiativesHtml = `<div class="p-4"><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>Initiative</th><th>Related Goal</th><th>KPIs to Track</th></tr></thead><tbody>`;
        strategies_and_initiatives.forEach((item) => {
            item.initiatives.forEach((initiative) => {
                initiativesHtml += `<tr><td>${initiative}</td><td>${item.goal}</td><td>${item.kpis.join(", ")}</td></tr>`;
            });
        });
        initiativesHtml += `</tbody></table></div></div>`;
        initiativesPanel.innerHTML = initiativesHtml;

        analysisCache[currentTemplateId] = container.innerHTML;
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                $(e.target.dataset.tab + "Panel").classList.add("active");
            }
        });
        $("analysisActions").classList.remove("hidden");
    }

    function createCreativeDissonanceLayout_NS(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-4xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-center text-white">Define the Dissonance</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="currentReality" class="block text-lg font-medium text-gray-200 mb-2"> Current Reality</label>
                                    <textarea id="currentReality" class="input-field h-48" placeholder="Describe your current situation, challenges, and limitations..."></textarea>
                                </div>
                                <div>
                                    <label for="futureVision" class="block text-lg font-medium text-gray-200 mb-2"> Future Vision</label>
                                    <textarea id="futureVision" class="input-field h-48" placeholder="Describe your ambitious, desired future state..."></textarea>
                                </div>
                            </div>
                             <h3 class="text-xl font-bold mt-6 mb-4 text-center text-white">Provide Additional Context (Optional)</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="dissonanceContextFile" class="block text-sm font-medium text-gray-200 mb-2">Business Document (.txt, .docx)</label>
                                    <div class="input-file-wrapper">
                                        <label for="dissonanceContextFile" id="dissonanceContextFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select context file...</span>
                                        </label>
                                        <input type="file" id="dissonanceContextFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <div>
                                    <label for="dissonanceDataFile" class="block text-sm font-medium text-gray-200 mb-2">Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="dissonanceDataFile" id="dissonanceDataFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select data file...</span>
                                        </label>
                                        <input type="file" id="dissonanceDataFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                             </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Generate Creative Strategies</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Creative Dissonance Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        const attachListener = (inputId, labelId) => {
            const fileInput = $(inputId);
            if (fileInput) {
                fileInput.addEventListener("change", (e) => {
                    const label = $(labelId);
                    const fileNameSpan = label.querySelector(".file-name");
                    if (e.target.files.length > 0) {
                        fileNameSpan.textContent = e.target.files[0].name;
                    } else {
                        fileNameSpan.textContent = "Select a file...";
                    }
                });
            }
        };
        attachListener("dissonanceContextFile", "dissonanceContextFileLabel");
        attachListener("dissonanceDataFile", "dissonanceDataFileLabel");
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();
    }

    async function handleCreativeDissonanceAnalysis_NS() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Analyzing Creative Gap (Prioritizing Files)...</h3><p class="text-white/80 mb-2">Generating initiatives based primarily on document and data context...</p></div>`;
        setLoading("generate", true); // Set loading state

        const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Using Llama 3.1 as requested

        try {
            // --- Gather Inputs ---
            const currentReality = $("currentReality").value.trim();
            const futureVision = $("futureVision").value.trim();
            const contextFile = $("dissonanceContextFile").files[0];
            const dataFile = $("dissonanceDataFile").files[0];

            if (!currentReality || !futureVision) {
                throw new Error(" Please describe both your Current Reality and Future Vision (even if brief summaries).");
            }
            // **Crucial Check:** Ensure at least one file is provided if we prioritize them.
            if (!contextFile && !dataFile) {
                 throw new Error(" Please upload at least a Business Context (.txt/.docx) or Data Context (.csv) file for detailed analysis.");
            }


            // --- Process Optional Context Files ---
            let businessContext = "No business document provided."; // Default changed
            if (contextFile) {
                try {
                    businessContext = await extractTextFromFile(contextFile);
                    console.log("Extracted text from context file.");
                } catch (e) {
                    console.warn("Could not read context file:", e.message);
                    businessContext = `Error reading provided context file: ${e.message}`;
                }
            } else {
                 console.log("No business context file uploaded.");
            }

            let dataContext = "No data file provided."; // Default changed
            if (dataFile) {
                 try {
                    dataContext = await extractTextFromFile(dataFile);
                    console.log("Extracted text from data file.");
                 } catch (e) {
                     console.warn("Could not read data file:", e.message);
                     dataContext = `Error reading provided data file: ${e.message}`;
                 }
            } else {
                 console.log("No data context file uploaded.");
            }

            // Truncate contexts if necessary
            const MAX_CONTEXT_LENGTH = 7000; // Keep reasonable for context focus
            if (businessContext.length > MAX_CONTEXT_LENGTH) {
                businessContext = businessContext.substring(0, MAX_CONTEXT_LENGTH) + "\n... (business context truncated)";
            }
            if (dataContext.length > MAX_CONTEXT_LENGTH) {
                dataContext = dataContext.substring(0, MAX_CONTEXT_LENGTH) + "\n... (data context truncated)";
            }

            // --- Enhanced Prompt Prioritizing Files ---
            const prompt = `
                You are a master strategist applying Robert Fritz's "Creative Dissonance" framework. Analyze the user's situation based *primarily* on the provided Business Context (.txt/.docx) and Data Context (.csv) files. Use the brief "Current Reality" and "Future Vision" inputs mainly for high-level framing and goal confirmation.

                **ANALYSIS INPUTS:**
                * **Business Context (Primary Source):** """${businessContext}"""
                * **Data Context (Primary Source):** """${dataContext}"""
                * **Current Reality (Framing):** ${currentReality}
                * **Future Vision (Framing):** ${futureVision}

                **TASK:**
                Perform a Creative Dissonance analysis based *strictly* on the detailed information within the **Business Context** and **Data Context** files.

                1.  **dissonance_points**: Identify 2-4 key thematic points of tension between the *detailed reality described in the files* and the *envisioned future described in the files (or framed by the Future Vision input)*. Phrase as "From '[Specific Reality from Files]' to '[Specific Vision from Files/Input]'".

                2.  **gap_analysis**: Create an array analyzing 2-4 major gaps *identified from the files*. For each gap:
                    * \`theme\`: Overarching theme (e.g., "Operational Scalability," "Market Penetration," "Data Infrastructure").
                    * \`reality_statement\`: A summary of the current state for this theme, citing specific details *from the files*.
                    * \`vision_statement\`: A summary of the desired future state for this theme, citing specific details *from the files* or aligning with the Future Vision input.
                    * \`gap\`: A clear description of the specific discrepancy *identified from the files*.

                3.  **strategic_initiatives**: Develop an array of 2-4 strategic initiatives designed *specifically* to close the gaps *identified from the files*. For each initiative:
                    * \`initiative_name\`: Action-oriented name (under 10 words).
                    * \`rationale\`: Explain *how* this initiative addresses a gap *identified from the files*, citing file context where possible.
                    * \`impact\`: Potential impact ("High", "Medium", "Low").
                    * \`effort\`: Likely effort ("High", "Medium", "Low").
                    * \`action_items\`: 2-3 concrete first steps derived from the necessary actions suggested by the *file context*.
                    * \`kpis_to_track\`: 2-3 specific KPIs relevant to the gap and measurable using data *suggested by the files* or standard business metrics.

                **ABSOLUTE CONSTRAINTS (CRITICAL):**
                - **FILE PRIORITY:** Base your ENTIRE analysisgaps, initiatives, actions, KPIsprimarily on the **Business Context** and **Data Context** files. Use the text box inputs only for overall direction if the files lack a clear goal.
                - **EVIDENCE-BASED:** Every point, gap, and initiative detail MUST be directly traceable to, or a logical necessity based on, the information *within the uploaded files*.
                - **NO FABRICATION:** Do NOT invent details, challenges, solutions, or metrics not supported by the file content. If the files lack sufficient detail for a section (e.g., H3 initiatives), state that clearly or return an empty array.
                - **SPECIFICITY:** Extract and use concrete details, numbers, challenges, or opportunities mentioned in the files.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object with the exact structure specified below. Ensure all fields reflect the file-first analysis.
                {
                  "dissonance_points": [ /* Points based primarily on file details */ ],
                  "gap_analysis": [ /* Gaps identified primarily from file details */ ],
                  "strategic_initiatives": [ /* Initiatives addressing file-based gaps */ ]
                }
            `;

            console.log("Sending FILE-PRIORITIZED Creative Dissonance prompt to Llama 3.1...");
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: { num_ctx: 32768 }
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
            const data = await response.json();

            let parsedData;
            try {
                 parsedData = JSON.parse(data.response);
                 console.log("Successfully parsed FILE-PRIORITIZED Creative Dissonance JSON response.");
            } catch (e) {
                console.error("Failed to parse FILE-PRIORITIZED Creative Dissonance JSON:", data.response, e);
                throw new Error("Invalid JSON received from AI (File-Priority). Check AI logs or input files.");
            }

            // Minimal validation
            if (!parsedData.dissonance_points || !parsedData.gap_analysis || !parsedData.strategic_initiatives) {
                 console.error("Parsed JSON structure is invalid (File-Priority):", parsedData);
                 throw new Error("AI response structure is incorrect (File-Priority).");
            }

            // Store original inputs for rendering comparison
            parsedData.original_inputs = {
                 currentReality: currentReality,
                 futureVision: futureVision
            };

            renderCreativeDissonancePage_NS(analysisResultContainer, parsedData);

        } catch (error) {
            console.error("Error during Creative Dissonance Analysis (File-Priority):", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false); // Stop loading on error
        }
    }

    function renderCreativeDissonancePage_NS(container, data) {
        container.innerHTML = ""; // Clear loading state
        // Add original inputs back for display if they were stored
        const { dissonance_points, gap_analysis, strategic_initiatives, original_inputs } = data;
        const currentRealityText = original_inputs?.currentReality || "[Current Reality Input Missing]";
        const futureVisionText = original_inputs?.futureVision || "[Future Vision Input Missing]";


        // Basic validation
        if (!dissonance_points || !gap_analysis || !strategic_initiatives || !Array.isArray(dissonance_points) || !Array.isArray(gap_analysis) || !Array.isArray(strategic_initiatives) ) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Incomplete or invalid analysis data received. Cannot render Creative Dissonance plan.</div>`;
            $("analysisActions").classList.add("hidden");
            setLoading("generate", false);
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Standard tabs
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
            <button class="analysis-tab-btn" data-tab="gap"> Gap Analysis</button>
            <button class="analysis-tab-btn" data-tab="initiatives"> Strategic Initiatives</button>
            <button class="analysis-tab-btn" data-tab="matrix"> Prioritization Matrix</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Framework</button>
            `;
            // <button class="analysis-tab-btn" data-tab="kpis"> KPI Tracker</button> // Merged KPIs into Initiatives tab for brevity
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active"></div>
            <div id="gapPanel" class="analysis-tab-panel"></div>
            <div id="initiativesPanel" class="analysis-tab-panel"></div>
            <div id="matrixPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
            `;
            // <div id="kpisPanel" class="analysis-tab-panel"></div>

        // --- 1. Populate Dashboard Panel ---
        const dashboardPanel = $("dashboardPanel");
        // Simplified dashboard focusing on the core tension and initiative count
        let dashboardHtml = `<div class="p-4 space-y-8">
            <h3 class="text-2xl font-bold text-center mb-4">Creative Dissonance Overview</h3>
            <div class="dissonance-map-container">
                 <div class="dissonance-pole">
                     <h4 class="text-xl font-bold mb-3 text-red-300"> Current Reality</h4>
                     <p class="text-white/80 text-sm">${currentRealityText}</p>
                 </div>
                 <div class="dissonance-gap">
                     <div class="text-center mb-4">
                        <span class="text-4xl"></span>
                        <h4 class="text-lg font-bold text-yellow-300">Structural Tension</h4>
                        <p class="text-xs text-white/70">(Points of Dissonance)</p>
                     </div>
                    ${(dissonance_points || []).map(dp => `<div class="dissonance-point text-xs">${dp}</div>`).join("")}
                 </div>
                 <div class="dissonance-pole">
                     <h4 class="text-xl font-bold mb-3 text-green-300"> Future Vision</h4>
                     <p class="text-white/80 text-sm">${futureVisionText}</p>
                 </div>
            </div>
            <div class="text-center mt-[-1rem] mb-6">
                <p class="text-lg text-white/90">Identified <strong class="text-yellow-300">${(gap_analysis || []).length}</strong> major gaps and formulated <strong class="text-yellow-300">${(strategic_initiatives || []).length}</strong> strategic initiatives to bridge them.</p>
            </div>
        </div>`;
        dashboardPanel.innerHTML = dashboardHtml;

        // --- 2. Populate Gap Analysis Panel ---
        const gapPanel = $("gapPanel");
        let gapHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4"> Detailed Gap Analysis</h3>`;
        if (gap_analysis.length > 0) {
            gap_analysis.forEach((gap) => {
                gapHtml += `<div class="insight-card">
                    <h4 class="text-xl font-bold mb-3 text-indigo-300">${gap.theme || "Unnamed Gap Theme"}</h4>
                    <p class="mb-2 text-sm"><strong>Current State:</strong> ${gap.reality_statement || "N/A"}</p>
                    <p class="mb-3 text-sm"><strong>Future State:</strong> ${gap.vision_statement || "N/A"}</p>
                    <div class="p-3 bg-black/20 rounded border-l-4 border-yellow-400 mt-3">
                        <p class="text-sm"><strong>Identified Gap:</strong> ${gap.gap || "N/A"}</p>
                    </div>
                </div>`;
            });
        } else {
             gapHtml += `<p class="text-center text-white/70">No specific gaps identified based on input.</p>`;
        }
        gapHtml += `</div>`;
        gapPanel.innerHTML = gapHtml;

        // --- 3. Populate Strategic Initiatives Panel (Including KPIs) ---
        const initiativesPanel = $("initiativesPanel");
        let initiativesHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Strategic Initiatives</h3>`;
         if (strategic_initiatives.length > 0) {
            initiativesHtml += `<div class="space-y-6">`;
            strategic_initiatives.forEach((p) => {
                initiativesHtml += `<div class="prescription-card">
                    <h4 class="text-xl font-bold">${p.initiative_name || "Unnamed Initiative"}</h4>
                    <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${p.impact || "?"} | <span class="text-blue-300">Effort:</span> ${p.effort || "?"}</p>
                    <p class="rationale"><strong>Strategic Rationale:</strong> ${p.rationale || "N/A"}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-indigo-300 mb-2">First Action Items</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90">${(p.action_items || []).map((a) => `<li>${a}</li>`).join("")}</ul>
                            ${!(p.action_items && p.action_items.length > 0) ? '<p class="text-white/60 italic text-xs">No specific first steps defined.</p>' : ''}
                        </div>
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-indigo-300 mb-2">KPIs to Track</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90">${(p.kpis_to_track || []).map((k) => `<li>${k}</li>`).join("")}</ul>
                            ${!(p.kpis_to_track && p.kpis_to_track.length > 0) ? '<p class="text-white/60 italic text-xs">No specific KPIs defined.</p>' : ''}
                        </div>
                    </div>
                </div>`;
            });
            initiativesHtml += `</div>`;
         } else {
            initiativesHtml += `<p class="text-center text-white/70">No specific initiatives identified based on input.</p>`;
         }
        initiativesHtml += `</div>`;
        initiativesPanel.innerHTML = initiativesHtml;


        // --- 4. Populate Prioritization Matrix Panel ---
        const matrixPanel = $("matrixPanel");
        matrixPanel.innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> Initiative Prioritization Matrix</h3><div id="initiativeMatrixPlot" class="w-full h-[600px] plotly-chart"></div></div>`;

        if (strategic_initiatives.length > 0) {
            const impactMap = { Low: 1, Medium: 2, High: 3 };
            const effortMap = { Low: 1, Medium: 2, High: 3 };
            // Add jitter to avoid points overlapping perfectly
            const addJitter = (val) => val + (Math.random() - 0.5) * 0.2;

            const matrixData = {
                x: strategic_initiatives.map((p) => addJitter(effortMap[p.effort] || 1)),
                y: strategic_initiatives.map((p) => addJitter(impactMap[p.impact] || 1)),
                text: strategic_initiatives.map((p) => p.initiative_name || "Unnamed"),
                mode: "markers+text",
                textposition: "top right", // Adjusted for better visibility with jitter
                marker: { size: 18, color: "var(--primary)", opacity: 0.8 },
                type: 'scatter' // Ensure type is scatter for jitter
            };
            const matrixLayout = { /* ... keep the same layout as before ... */
                title: { text: "Impact vs. Effort", y:0.95 },
                paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", font: { color: "white" },
                xaxis: { title: "Effort Required", range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ["Low", "Medium", "High"], gridcolor: "rgba(255,255,255,0.2)", zeroline: false },
                yaxis: { title: "Potential Impact", range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ["Low", "Medium", "High"], gridcolor: "rgba(255,255,255,0.2)", zeroline: false },
                shapes: [ { type: "line", x0: 2, y0: 0.5, x1: 2, y1: 3.5, line: { color: "rgba(255,255,255,0.3)", width: 1, dash: "dot" } }, { type: "line", x0: 0.5, y0: 2, x1: 3.5, y1: 2, line: { color: "rgba(255,255,255,0.3)", width: 1, dash: "dot" } } ],
                annotations: [ { x: 1, y: 3, text: "Quick Wins", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } }, { x: 3, y: 3, text: "Major Projects", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } }, { x: 1, y: 1, text: "Fill-ins", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } }, { x: 3, y: 1, text: "Thankless Tasks", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } } ]
            };
            Plotly.newPlot("initiativeMatrixPlot", [matrixData], matrixLayout, { responsive: true });
        } else {
             $("initiativeMatrixPlot").innerHTML = `<p class="text-center text-white/70 pt-10">No initiatives identified to plot.</p>`;
        }

        // --- 5. Populate Learn Framework Panel ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding Creative Dissonance (Structural Tension)</h3>

                <p class="italic text-center">Based on the work of Robert Fritz, Creative Dissonance (or Structural Tension) is the gap between the vision of what you want to create and your perception of current reality. This gap generates energy that naturally seeks resolution, driving action and creativity.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/50">
                        <h4 class="text-xl font-bold text-red-300 mb-2"> Current Reality</h4>
                        <p class="text-sm mb-3">A clear, objective, and honest assessment of the present situation. What *is* true right now, including limitations, challenges, and existing resources?</p>
                        <p class="text-sm"><strong>Focus:</strong> Objectivity, facts, data, current state.</p>
                        <p class="text-sm mt-2"><strong>Pitfall to Avoid:</strong> Letting the current reality limit your vision.</p>
                    </div>

                    <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/50">
                        <h4 class="text-xl font-bold text-green-300 mb-2"> Future Vision</h4>
                        <p class="text-sm mb-3">A compelling picture of the desired future state. What do you truly want to create or achieve? This should be aspirational and clearly defined.</p>
                        <p class="text-sm"><strong>Focus:</strong> Aspiration, desired outcome, clarity, intrinsic motivation.</p>
                        <p class="text-sm mt-2"><strong>Pitfall to Avoid:</strong> Making the vision a reaction to current problems (it should be about creation).</p>
                    </div>
                </div>

                 <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50 mt-6">
                        <h4 class="text-xl font-bold text-yellow-300 mb-2"> The Tension (The Gap)</h4>
                        <p class="text-sm mb-3">The difference between the Vision and Current Reality creates a natural tension. This isn't a problem to be solved, but a structure that inherently seeks resolution.</p>
                        <p class="text-sm"><strong>Mechanism:</strong> Just like a stretched rubber band wants to return to equilibrium, this structural tension drives action towards the vision OR pulls the vision down towards reality.</p>
                        <p class="text-sm mt-2"><strong>Key Insight:</strong> You resolve the tension by taking actions that move reality closer to the vision.</p>
                 </div>

                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">How This Tool Applies It:</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Dissonance Points & Gap Analysis:</strong> Clearly defines the specific areas of tension between your stated reality and vision.</li>
                        <li><strong>Strategic Initiatives:</strong> Proposes concrete actions aimed at altering the current reality structure to move it towards the desired vision, thereby resolving the tension constructively.</li>
                        <li><strong>Prioritization Matrix:</strong> Helps focus resources on initiatives likely to have the biggest impact in closing the gap relative to the effort required.</li>
                    </ul>
                 </div>
                 <p class="text-xs text-center text-white/60 mt-4">Note: This framework emphasizes creating the future you want, rather than just solving problems from the past.</p>
            </div>
        `;

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     const chart = targetPanel.querySelector(".plotly-chart");
                     if (chart) Plotly.Plots.resize(chart); // Resize chart if panel becomes active
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator
    }

    function createLivingSystemLayout_NS(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-4xl mx-auto w-full p-6 space-y-6">
                             <h3 class="text-xl font-bold mb-4 text-center text-white">Describe Your Living System</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Detailed Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="lsCoreIdentity" class="block text-lg font-medium text-gray-200 mb-2"> Core Identity (DNA)</label>
                                        <textarea id="lsCoreIdentity" class="input-field h-32" placeholder="What is your organization's fundamental purpose, mission, and core values?"></textarea>
                                    </div>
                                    <div>
                                        <label for="lsEnvironment" class="block text-lg font-medium text-gray-200 mb-2"> Environment</label>
                                        <textarea id="lsEnvironment" class="input-field h-32" placeholder="Describe your market, competitors, customers, and key trends."></textarea>
                                    </div>
                                    <div>
                                        <label for="lsMetabolism" class="block text-lg font-medium text-gray-200 mb-2"> Metabolism</label>
                                        <textarea id="lsMetabolism" class="input-field h-32" placeholder="How does your organization take in resources (revenue, talent, data) and convert them into value?"></textarea>
                                    </div>
                                    <div>
                                        <label for="lsNervousSystem" class="block text-lg font-medium text-gray-200 mb-2"> Nervous System</label>
                                        <textarea id="lsNervousSystem" class="input-field h-32" placeholder="How does information flow? How do you sense changes and make decisions?"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div id="docUploadArea" class="hidden max-w-md mx-auto">
                                <div class="input-file-wrapper">
                                    <label for="lsFile" id="lsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="lsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Diagnose Living System</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">System Health Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("lsFile", "lsFileLabel", "textInputArea", "docUploadArea");
    }

    async function handleLivingSystemAnalysis_NS() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Diagnosing System Health...</h3><p class="text-white/80 mb-2">Analyzing metabolism, nervous system, and immune response using enhanced, context-aware prompting...</p></div>`;
        setLoading("generate", true); // Set loading state

        const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Using Llama 3.1 as requested

        try {
            const useDoc = $("docUpload").checked;
            let systemDescription = "";

            if (useDoc) {
                const file = $("lsFile").files[0];
                if (!file) throw new Error(" Please select a document to upload.");
                systemDescription = await extractTextFromFile(file);
                console.log("Extracted text from Living System context file.");
            } else {
                // Combine text area inputs into a single description
                const coreIdentity = $("lsCoreIdentity")?.value.trim() || "Not specified.";
                const environment = $("lsEnvironment")?.value.trim() || "Not specified.";
                const metabolism = $("lsMetabolism")?.value.trim() || "Not specified.";
                const nervousSystem = $("lsNervousSystem")?.value.trim() || "Not specified.";

                if (!coreIdentity || !environment || !metabolism || !nervousSystem) {
                    throw new Error(" Please fill out all four detailed input sections (Core Identity, Environment, Metabolism, Nervous System).");
                }
                systemDescription = `Core Identity (DNA): ${coreIdentity}\n\nEnvironment: ${environment}\n\nMetabolism: ${metabolism}\n\nNervous System: ${nervousSystem}`;
            }

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000; // Adjust based on Llama 3.1 capabilities
            if (systemDescription.length > MAX_CONTEXT_LENGTH) {
                console.warn(`Living System description truncated to ${MAX_CONTEXT_LENGTH} characters.`);
                systemDescription = systemDescription.substring(0, MAX_CONTEXT_LENGTH);
            }

            // --- Enhanced Prompt ---
            const prompt = `
                You are an expert organizational strategist specializing in applying the "Living System" or "Viable System Model" principles to diagnose business health. Analyze the user's provided description *strictly* based on that context.

                **USER'S SYSTEM DESCRIPTION:**
                """
                ${systemDescription}
                """

                **TASK:**
                Perform a comprehensive Living System diagnosis. Identify the health status and provide analysis for each key system component *based solely on evidence within the user's description*. Formulate specific strategic interventions to address identified weaknesses, again, grounded *only* in the provided text.

                1.  **overall_diagnosis**: Provide a concise, 1-2 sentence overall assessment of the system's health and key challenges *as described by the user*.

                2.  **system_analysis**: Create an array analyzing the core system components. For each component (Metabolism, Nervous System, Immune System, Growth & Adaptation):
                    * system_name: The name of the component.
                    * health_status: Assess the health as "Robust," "Strained," or "Fragile" *based strictly on evidence (or lack thereof) in the user's text*. If the text provides no information to judge a component, default to "Strained" and state the lack of evidence in the analysis.
                    * analysis: Explain *why* you assigned that health status, citing specific examples, phrases, or lack of information *from the user's description*.

                3.  **strategic_interventions**: Develop an array of 2-4 specific strategic initiatives designed *only* to address the weaknesses identified in the system_analysis section and supported by the user's context. For each initiative:
                    * initiative_name: A clear, action-oriented name (under 10 words).
                    * target_system: The primary system component(s) this initiative aims to improve (e.g., "Metabolism", "Nervous System").
                    * rationale: Explain *how* this initiative directly addresses a weakness identified in the system_analysis, referencing the user's context.
                    * action_items: List 2-3 concrete first steps to begin implementing this initiative, logically derived from the context.
                    * kpis_to_track: List 2-3 specific, measurable KPIs relevant to the initiative's goal, based on the context.

                **ABSOLUTE CONSTRAINTS (CRITICAL):**
                - **GROUNDING:** Every diagnosis, analysis point, health status, and intervention MUST be directly traceable to specific statements or the lack of specific information within the "USER'S SYSTEM DESCRIPTION". Do NOT infer beyond the text.
                - **NO FABRICATION:** Do NOT invent organizational problems, strengths, strategies, or metrics not explicitly supported by the provided text.
                - **FRAMEWORK ADHERENCE:** Interpret the user's text through the lens of the Living System components (Metabolism, Nervous System, Immune System, Growth/Adaptation).
                - **HEALTH STATUS JUSTIFICATION:** Clearly justify each "Robust," "Strained," or "Fragile" assessment using evidence *from the text*. If evidence is missing, state that.
                - **INTERVENTION LINKAGE:** Interventions must *only* target weaknesses identified in *your* system_analysis section.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object with the exact structure specified below. Ensure all fields adhere strictly to the grounding constraints.
                {
                  "overall_diagnosis": "Concise overall assessment based ONLY on user text.",
                  "system_analysis": [
                    {
                      "system_name": "Metabolism",
                      "health_status": "Robust/Strained/Fragile (Justified by text)",
                      "analysis": "Explanation citing specific user text or lack thereof..."
                    },
                    {
                      "system_name": "Nervous System",
                      "health_status": "Robust/Strained/Fragile (Justified by text)",
                      "analysis": "Explanation citing specific user text or lack thereof..."
                    },
                    {
                      "system_name": "Immune System", // How it handles threats/change
                      "health_status": "Robust/Strained/Fragile (Justified by text)",
                      "analysis": "Explanation citing specific user text or lack thereof..."
                    },
                    {
                      "system_name": "Growth & Adaptation", // How it evolves/learns
                      "health_status": "Robust/Strained/Fragile (Justified by text)",
                      "analysis": "Explanation citing specific user text or lack thereof..."
                    }
                  ],
                  "strategic_interventions": [ // Only if weaknesses identified
                    {
                      "initiative_name": "Initiative Name 1",
                      "target_system": "System Name(s)",
                      "rationale": "How this addresses a specific weakness identified above, citing text...",
                      "action_items": ["Action 1.1 derived from context", "Action 1.2 derived from context"],
                      "kpis_to_track": ["KPI 1.1 from context", "KPI 1.2 from context"]
                    },
                    { /* ... 2-4 total, if applicable ... */ }
                  ]
                }
            `;

            console.log("Sending STRICTLY GROUNDED Living System prompt to Llama 3.1...");
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: { num_ctx: 32768 } // Adjust context window if needed
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
            const data = await response.json();

            let parsedData;
            try {
                 parsedData = JSON.parse(data.response);
                 console.log("Successfully parsed Living System JSON response from Llama 3.1.");
            } catch (e) {
                console.error("Failed to parse Living System JSON response:", data.response, e);
                throw new Error("Invalid JSON received from AI (Living System). Check AI logs or input text.");
            }

            // Minimal validation
            if (!parsedData.overall_diagnosis || !parsedData.system_analysis || !Array.isArray(parsedData.system_analysis) || parsedData.system_analysis.length < 4 || !parsedData.strategic_interventions) {
                 console.error("Parsed JSON structure is invalid (Living System):", parsedData);
                 throw new Error("AI response structure is incorrect (Living System).");
            }
             // Store original inputs if text areas were used, for potential display
             if (!$("docUpload").checked) {
                  parsedData.original_inputs = {
                     coreIdentity: $("lsCoreIdentity")?.value.trim() || "",
                     environment: $("lsEnvironment")?.value.trim() || "",
                     metabolism: $("lsMetabolism")?.value.trim() || "",
                     nervousSystem: $("lsNervousSystem")?.value.trim() || ""
                  };
             }


            renderLivingSystemPage_NS(analysisResultContainer, parsedData);

        } catch (error) {
            console.error("Error during Living System Analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false); // Stop loading on error
        }
    }
    function renderLivingSystemPage_NS(container, data) {
        container.innerHTML = ""; // Clear loading state
        const { overall_diagnosis, system_analysis, strategic_interventions, original_inputs } = data;

        // Basic validation
        if (!overall_diagnosis || !system_analysis || !Array.isArray(system_analysis) || system_analysis.length < 4 || !strategic_interventions ) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Incomplete or invalid analysis data received. Cannot render Living System plan.</div>`;
            $("analysisActions").classList.add("hidden");
            setLoading("generate", false);
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Standard tabs
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> System Health</button>
            <button class="analysis-tab-btn" data-tab="deepdive"> Deep Dive</button>
            <button class="analysis-tab-btn" data-tab="interventions"> Interventions</button>
            <button class="analysis-tab-btn" data-tab="kpis"> KPI Tracker</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Framework</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active"></div>
            <div id="deepdivePanel" class="analysis-tab-panel"></div>
            <div id="interventionsPanel" class="analysis-tab-panel"></div>
            <div id="kpisPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // Map system names for consistent ordering/display
        const systemMap = {
            "Metabolism": system_analysis.find(s => s.system_name.includes("Metabolism")) || { system_name: "Metabolism", health_status: "Strained", analysis: "Data missing." },
            "Nervous System": system_analysis.find(s => s.system_name.includes("Nervous")) || { system_name: "Nervous System", health_status: "Strained", analysis: "Data missing." },
            "Immune System": system_analysis.find(s => s.system_name.includes("Immune")) || { system_name: "Immune System", health_status: "Strained", analysis: "Data missing." },
            "Growth & Adaptation": system_analysis.find(s => s.system_name.includes("Growth") || s.system_name.includes("Adaptation")) || { system_name: "Growth & Adaptation", health_status: "Strained", analysis: "Data missing." }
        };
        const orderedSystems = ["Metabolism", "Nervous System", "Immune System", "Growth & Adaptation"];


        // --- 1. Populate Dashboard Panel ---
        const dashboardPanel = $("dashboardPanel");
        // Get Core Identity text either from original inputs or analysis if available
         const coreIdentityText = original_inputs?.coreIdentity || system_analysis.find(s => s.system_name.includes("Core Identity"))?.analysis || "Core Identity not specified in detail.";

        let dashboardHtml = `<div class="p-4">
            <blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 mb-8">
                <strong>Overall Diagnosis:</strong> ${overall_diagnosis}
            </blockquote>
            <div class="ls-dashboard-container">
                <div class="ls-core">
                    <h3 class="text-lg font-bold">Core Identity</h3>
                    <p class="text-xs text-white/70 mt-1">${coreIdentityText.substring(0, 100)}${coreIdentityText.length > 100 ? '...' : ''}</p>
                 </div>`;

        // Position nodes consistently
        const positions = [
            { bottom: "5%", left: "50%", transform: "translateX(-50%)" }, // Metabolism at bottom
            { top: "50%", left: "5%", transform: "translateY(-50%)" },   // Nervous System left
            { top: "50%", right: "5%", transform: "translateY(-50%)" },  // Immune System right
            { top: "5%", left: "50%", transform: "translateX(-50%)" }    // Growth & Adaptation at top
        ];

        orderedSystems.forEach((sysName, index) => {
            const sys = systemMap[sysName];
            const pos = positions[index];
            // Normalize health status for class name
            const healthStatusNormalized = (sys.health_status || "strained").toLowerCase();
            const healthClass = `ls-health-${healthStatusNormalized}`; // e.g., ls-health-robust

            dashboardHtml += `<div class="ls-system-node ${healthClass}" style="top:${pos.top || "auto"}; left:${pos.left || "auto"}; right:${pos.right || "auto"}; bottom:${pos.bottom || "auto"}; transform:${pos.transform || 'none'};">
                <h4 class="font-bold text-sm">${sys.system_name}</h4>
                <p class="text-md font-bold mt-1">${sys.health_status || "Unknown"}</p>
            </div>`;
        });
        dashboardHtml += `</div></div>`; // Close ls-dashboard-container and p-4
        dashboardPanel.innerHTML = dashboardHtml;


        // --- 2. Populate Deep Dive Panel ---
        const deepdivePanel = $("deepdivePanel");
        let deepdiveHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4">Deep Dive Analysis</h3>`;
        orderedSystems.forEach((sysName) => {
            const sys = systemMap[sysName];
            const healthStatusNormalized = (sys.health_status || "strained").toLowerCase();
            const healthClass = `ls-health-${healthStatusNormalized}`; // Use normalized status for class

            // Add border color based on health status
            let borderColorClass = "border-gray-500"; // Default border
            if (healthStatusNormalized === "robust") borderColorClass = "border-green-400";
            else if (healthStatusNormalized === "fragile") borderColorClass = "border-red-400";
            else if (healthStatusNormalized === "strained") borderColorClass = "border-yellow-400";


            deepdiveHtml += `<div class="insight-card border-l-4 ${borderColorClass}">
                <h4 class="text-xl font-bold mb-2">${sys.system_name} - <span class="font-semibold ${healthClass}">${sys.health_status || "Unknown"}</span></h4>
                <p class="text-white/90 text-sm">${sys.analysis || "No analysis provided."}</p>
            </div>`;
        });
        deepdiveHtml += `</div>`;
        deepdivePanel.innerHTML = deepdiveHtml;


        // --- 3. Populate Interventions Panel ---
        const interventionsPanel = $("interventionsPanel");
        let interventionsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Strategic Interventions</h3>`;
        if (strategic_interventions && strategic_interventions.length > 0) {
             interventionsHtml += `<div class="space-y-6">`;
             strategic_interventions.forEach((p) => {
                interventionsHtml += `<div class="prescription-card">
                    <h4 class="text-xl font-bold">${p.initiative_name || "Unnamed Initiative"}</h4>
                    <p class="text-xs font-semibold my-1 text-indigo-300">TARGET SYSTEM(S): ${p.target_system || "N/A"}</p>
                    <p class="rationale"><strong>Rationale:</strong> ${p.rationale || "N/A"}</p>
                    <div class="bg-black/20 p-3 rounded text-sm mt-3">
                        <h5 class="font-bold text-yellow-300 mb-2">Action Items</h5>
                        <ul class="list-disc list-inside space-y-1 text-white/90">${(p.action_items || []).map((a) => `<li>${a}</li>`).join("")}</ul>
                        ${!(p.action_items && p.action_items.length > 0) ? '<p class="text-white/60 italic text-xs">No specific action items defined.</p>' : ''}
                    </div>
                </div>`;
            });
             interventionsHtml += `</div>`;
        } else {
             interventionsHtml += `<p class="text-center text-white/70 italic">No specific strategic interventions were identified based on the provided context, likely indicating no major weaknesses were found or derivable.</p>`;
        }
        interventionsHtml += `</div>`;
        interventionsPanel.innerHTML = interventionsHtml;


        // --- 4. Populate KPI Tracker Panel ---
        const kpisPanel = $("kpisPanel");
        let kpisHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Consolidated KPI Tracker</h3>`;
        if (strategic_interventions && strategic_interventions.length > 0 && strategic_interventions.some(p => p.kpis_to_track && p.kpis_to_track.length > 0)) {
            kpisHtml += `<div class="overflow-x-auto"><table class="coeff-table">
                        <thead><tr><th>KPI to Track</th><th>Related Initiative</th><th>Target System</th></tr></thead>
                        <tbody>`;
            strategic_interventions.forEach((p) => {
                (p.kpis_to_track || []).forEach((kpi) => {
                    kpisHtml += `<tr><td>${kpi}</td><td>${p.initiative_name || "N/A"}</td><td>${p.target_system || "N/A"}</td></tr>`;
                });
            });
            kpisHtml += `</tbody></table></div>`;
        } else {
            kpisHtml += `<p class="text-center text-white/70 italic">No specific KPIs identified for the proposed interventions.</p>`;
        }
        kpisHtml += `</div>`;
        kpisPanel.innerHTML = kpisHtml;


        // --- 5. Populate Learn Framework Panel ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding the Living System / Viable System Model (VSM)</h3>

                <p class="italic text-center">This framework views organizations not just as machines, but as complex, adaptive systems akin to living organisms. It helps diagnose systemic health and identify interventions for viability and resilience, drawing heavily on Stafford Beer's Viable System Model.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                        <h4 class="text-xl font-bold text-blue-300 mb-2"> Core Identity (VSM System 5 - Policy)</h4>
                        <p class="text-sm mb-3"><strong>Focus:</strong> The organization's fundamental purpose, values, mission, and long-term direction. Its "DNA."</p>
                        <p class="text-sm"><strong>Health Check:</strong> Is the identity clear, shared, and guiding decisions? Does it align with the environment?</p>
                    </div>

                    <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/50">
                        <h4 class="text-xl font-bold text-green-300 mb-2"> Metabolism (VSM System 1 - Operations)</h4>
                        <p class="text-sm mb-3"><strong>Focus:</strong> How the organization takes in resources (inputs like revenue, materials, talent) and transforms them into value (outputs like products, services).</p>
                        <p class="text-sm"><strong>Health Check:</strong> Are core operations efficient? Is resource conversion effective? Is there waste? Can it acquire needed resources?</p>
                    </div>

                    <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50">
                        <h4 class="text-xl font-bold text-yellow-300 mb-2"> Nervous System (VSM Systems 2, 3, 3* - Coordination, Control, Audit)</h4>
                        <p class="text-sm mb-3"><strong>Focus:</strong> How information flows, how coordination happens, how performance is monitored, and how decisions are made to regulate operations and respond to the environment.</p>
                        <p class="text-sm"><strong>Health Check:</strong> Is information timely and accurate? Are feedback loops effective? Is decision-making swift and informed? Is there internal stability?</p>
                    </div>

                    <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/50">
                        <h4 class="text-xl font-bold text-red-300 mb-2"> Immune System / Adaptation (VSM System 4 - Intelligence/Environment Sensing)</h4>
                        <p class="text-sm mb-3"><strong>Focus:</strong> How the organization senses changes in its external environment (market, competitors, tech), anticipates threats/opportunities, and adapts its strategy and identity for long-term survival.</p>
                        <p class="text-sm"><strong>Health Check:</strong> Is the organization aware of external trends? Can it adapt proactively? Does it learn and evolve its model?</p>
                         <p class="text-xs italic mt-1">(Note: Sometimes 'Immune System' is used more narrowly for internal threat response, while VSM's System 4 covers broader external adaptation.)</p>
                    </div>
                </div>

                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">Why Use This Framework?</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Holistic View:</strong> Considers the organization as an interconnected whole, not just separate parts.</li>
                        <li><strong>Resilience Focus:</strong> Helps identify vulnerabilities and build adaptability for long-term survival.</li>
                        <li><strong>Systemic Diagnosis:</strong> Pinpoints root causes of problems within the system's structure, not just symptoms.</li>
                        <li><strong>Viability Assessment:</strong> Based on principles required for any system (biological or organizational) to remain viable in its environment.</li>
                    </ul>
                 </div>
                 <p class="text-xs text-center text-white/60 mt-4">This analysis maps concepts like Metabolism, Nervous System, etc., onto the core functions described in Stafford Beer's Viable System Model (VSM).</p>
            </div>
        `;

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     // const chart = targetPanel.querySelector(".plotly-chart"); // If charts added later
                     // if (chart) Plotly.Plots.resize(chart);
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator AFTER rendering
    }

    function createThinkingSystemLayout_NS(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe a Belief or Conclusion</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="tsContent" class="input-field h-48" placeholder="Describe a belief, conclusion, or decision that has led to a recurring problem. For example: 'I believe our marketing campaigns are failing because the creative team is uninspired.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="tsFile" id="tsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="tsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Deconstruct Thinking</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis of Your Thinking System</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("tsFile", "tsFileLabel", "textInputArea", "docUploadArea");
    }

    async function handleThinkingSystemAnalysis_NS() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Deconstructing Mental Models...</h3><p class="text-white/80 mb-2">Analyzing your thought process with enhanced prompting to uncover new paths...</p></div>`;
        setLoading("generate", true); // Set loading state

        const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Using Llama 3.1 as requested

        try {
            const useDoc = $("docUpload").checked;
            let beliefOrProblemContext = "";

            if (useDoc) {
                const file = $("tsFile").files[0];
                if (!file) throw new Error(" Please select a document to upload.");
                beliefOrProblemContext = await extractTextFromFile(file);
                console.log("Extracted text from Thinking System context file.");
            } else {
                beliefOrProblemContext = $("tsContent").value.trim();
                if (!beliefOrProblemContext) {
                    throw new Error(" Please describe a belief, conclusion, or problem context to analyze.");
                }
            }

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000; // Adjust based on Llama 3.1
            if (beliefOrProblemContext.length > MAX_CONTEXT_LENGTH) {
                console.warn(`Thinking System context truncated to ${MAX_CONTEXT_LENGTH} characters.`);
                beliefOrProblemContext = beliefOrProblemContext.substring(0, MAX_CONTEXT_LENGTH);
            }

            // --- Enhanced Prompt ---
            const prompt = `
                You are an expert facilitator applying Chris Argyris' "Ladder of Inference" framework. Analyze the user's provided text, which describes a belief, conclusion, or a problematic situation resulting from a certain line of thinking. Your task is to deconstruct the likely thought process *down* the ladder and then guide a reframing *up* a potentially more constructive ladder, based *strictly* on the provided context.

                **USER'S CONTEXT (Belief/Problem Description):**
                """
                ${beliefOrProblemContext}
                """

                **TASK:**
                Perform a Ladder of Inference analysis grounded *exclusively* in the USER'S CONTEXT.

                1.  **Infer Top Rung:** First, infer the core problematic **Action** or **Belief** described or implied at the top of the ladder within the user's context.

                2.  **Deconstruction (Working DOWN the Ladder):** Based *only* on the user's context, reconstruct the likely steps leading to that top rung. For each rung below, explain *how it derives from the rung above it*, citing evidence or logical inference *from the user's text*:
                    * action (The inferred problematic action/decision based on the text).
                    * belief (The inferred underlying belief driving the action, derived from the text).
                    * conclusion (The inferred conclusion drawn from assumptions/interpretations, based on the text).
                    * assumption (Inferred assumptions made based on interpretations, drawn from the text).
                    * interpretation (How selected data/observations were likely interpreted, based on the text).
                    * selection (What specific data or observations from the available 'reality' were likely focused on, ignoring others, based on the text).
                    * observation (The pool of observable data/reality described or implied in the user's text).

                3.  **Reframing (Identifying Leverage & Building UP a New Ladder):**
                    * critical_question: Formulate a challenging question that probes the assumptions or interpretations identified in the deconstruction.
                    * new_observation: Suggest broadening the pool of observable data  what else *could* be observed or considered from the context?
                    * new_interpretation: Offer an alternative, potentially more constructive interpretation of the (potentially broadened) observations.
                    * new_conclusion: State a different conclusion that could logically follow from the new interpretation.

                4.  **New Actions:** Propose 2-3 specific, actionable initiatives based on the new_conclusion. For each action:
                    * action_name: Clear name (under 10 words).
                    * rationale: Explain how this action stems from the reframed perspective and helps address the original problem described in the user's context.
                    * steps: List 2-3 concrete first steps to implement this action.
                    * kpis: List 2-3 measurable KPIs to track the effectiveness of this new action.


                **ABSOLUTE CONSTRAINTS (CRITICAL):**
                - **INPUT GROUNDING:** Every step of the deconstruction and reframing MUST be directly traceable to, or a logical inference *solely based upon*, the information presented in the "USER'S CONTEXT". Do NOT introduce external knowledge or assumptions.
                - **NO FABRICATION:** Do NOT invent observations, interpretations, beliefs, or actions not supported by the user's text.
                - **LADDER LOGIC:** Ensure a clear, step-by-step causal link when moving both down and up the ladder rungs. Explain the connection between rungs based on the context.
                - **FOCUS ON THINKING:** The analysis must focus on deconstructing and reframing the *thought process*, not just listing business problems.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object with the exact structure specified below. Fill all fields according to the constraints, using inferences grounded *only* in the user's context.
                {
                  "deconstruction": {
                    "action": "Inferred action from user text...",
                    "belief": "Inferred belief from user text...",
                    "conclusion": "Inferred conclusion from user text...",
                    "assumption": "Inferred assumption(s) from user text...",
                    "interpretation": "Inferred interpretation from user text...",
                    "selection": "Inferred selected data/observations from user text...",
                    "observation": "Observable reality described/implied in user text..."
                  },
                  "reframing": {
                    "critical_question": "Challenging question based on deconstruction...",
                    "new_observation": "Suggestion to broaden observation based on context...",
                    "new_interpretation": "Alternative interpretation grounded in context...",
                    "new_conclusion": "New conclusion based on alternative interpretation..."
                  },
                  "new_actions": [
                    {
                      "action_name": "New Action Name 1",
                      "rationale": "How this follows from reframing & addresses original problem...",
                      "steps": ["Step 1.1 based on context", "Step 1.2 based on context"],
                      "kpis": ["KPI 1.1 relevant to context", "KPI 1.2 relevant to context"]
                    },
                    { /* ... 1-2 more actions ... */ }
                  ]
                }
            `;

            console.log("Sending STRICTLY GROUNDED Ladder of Inference prompt to Llama 3.1...");
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: { num_ctx: 32768 } // Adjust context window if needed
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
            const data = await response.json();

            let parsedData;
            try {
                 parsedData = JSON.parse(data.response);
                 console.log("Successfully parsed Ladder of Inference JSON response from Llama 3.1.");
            } catch (e) {
                console.error("Failed to parse Ladder of Inference JSON response:", data.response, e);
                throw new Error("Invalid JSON received from AI (Ladder of Inference). Check AI logs or input text.");
            }

            // Minimal validation
            if (!parsedData.deconstruction || !parsedData.reframing || !parsedData.new_actions || !parsedData.deconstruction.observation) {
                 console.error("Parsed JSON structure is invalid (Ladder of Inference):", parsedData);
                 throw new Error("AI response structure is incorrect (Ladder of Inference).");
            }

            renderThinkingSystemPage_NS(analysisResultContainer, parsedData);

        } catch (error) {
            console.error("Error during Thinking System Analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false); // Stop loading on error
        }
    }

    function renderThinkingSystemPage_NS(container, data) {
        container.innerHTML = ""; // Clear loading state
        const { deconstruction, reframing, new_actions } = data;

        // Basic validation
        if (!deconstruction || !reframing || !new_actions || !Array.isArray(new_actions) || !deconstruction.observation ) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Incomplete or invalid analysis data received. Cannot render Ladder of Inference analysis.</div>`;
            $("analysisActions").classList.add("hidden");
            setLoading("generate", false);
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Standard tabs
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="ladder"> Deconstruction</button>
            <button class="analysis-tab-btn" data-tab="reframing"> Reframing</button>
            <button class="analysis-tab-btn" data-tab="actions"> New Actions</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Framework</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="ladderPanel" class="analysis-tab-panel active"></div>
            <div id="reframingPanel" class="analysis-tab-panel"></div>
            <div id="actionsPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Ladder Deconstruction Panel ---
        const ladderPanel = $("ladderPanel");
        // Rungs ordered bottom-up for display
        const rungs = [
            { name: "Observation", text: deconstruction.observation },
            { name: "Selection", text: deconstruction.selection },
            { name: "Interpretation", text: deconstruction.interpretation },
            { name: "Assumption", text: deconstruction.assumption },
            { name: "Conclusion", text: deconstruction.conclusion },
            { name: "Belief", text: deconstruction.belief },
            { name: "Action", text: deconstruction.action }
        ];
        let ladderHtml = `<div class="p-4"><h3 class="text-2xl font-bold text-center mb-6"> Deconstructing the Thought Process (Bottom-Up)</h3><div class="ladder-container">`;
        rungs.forEach(rung => {
             ladderHtml += `<div class="ladder-rung"><h4>${rung.name}</h4><p>${rung.text || "Not explicitly derived from context."}</p></div>`;
             // Add arrow between rungs, except after the last one
             if (rung.name !== "Action") {
                 ladderHtml += `<div class="ladder-arrow"></div>`;
             }
        });
        ladderHtml += `</div></div>`; // Close ladder-container and p-4
        ladderPanel.innerHTML = ladderHtml;


        // --- 2. Populate Reframing Panel ---
        const reframingPanel = $("reframingPanel");
        reframingPanel.innerHTML = `<div class="p-4 space-y-6">
             <h3 class="text-2xl font-bold mb-4"> Reframing the Perspective</h3>
            <div class="insight-card">
                <h4 class="text-lg font-bold text-yellow-300"> Critical Question to Challenge Assumptions:</h4>
                <p class="text-white/90 text-md mt-2">${reframing.critical_question || "N/A"}</p>
            </div>
            <div class="insight-card">
                <h4 class="text-lg font-bold"> Building a New Path Up the Ladder:</h4>
                <p class="mt-2 text-sm"><strong>1. Broaden Observations:</strong> What else could be considered? <code>${reframing.new_observation || "N/A"}</code></p>
                <p class="mt-2 text-sm"><strong>2. New Interpretation:</strong> How else could this data be seen? <code>${reframing.new_interpretation || "N/A"}</code></p>
                <p class="mt-2 text-sm"><strong>3. New Conclusion:</strong> What different conclusion arises? <code>${reframing.new_conclusion || "N/A"}</code></p>
                <p class="mt-4 text-sm font-semibold"> This reframed conclusion should lead to more constructive beliefs and actions.</p>
            </div>
        </div>`;

        // --- 3. Populate New Actions Panel ---
        const actionsPanel = $("actionsPanel");
        let actionsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> New Actions Based on Reframing</h3>`;
         if (new_actions.length > 0) {
            actionsHtml += `<div class="space-y-6">`;
            new_actions.forEach((p) => {
                actionsHtml += `<div class="prescription-card">
                    <h4 class="text-xl font-bold">${p.action_name || "Unnamed Action"}</h4>
                    <p class="rationale"><strong>Rationale (Linked to Reframing):</strong> ${p.rationale || "N/A"}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-indigo-300 mb-2">First Steps</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90">${(p.steps || []).map((a) => `<li>${a}</li>`).join("")}</ul>
                             ${!(p.steps && p.steps.length > 0) ? '<p class="text-white/60 italic text-xs">No specific first steps defined.</p>' : ''}
                       </div>
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-indigo-300 mb-2">KPIs to Track</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90">${(p.kpis || []).map((k) => `<li>${k}</li>`).join("")}</ul>
                             ${!(p.kpis && p.kpis.length > 0) ? '<p class="text-white/60 italic text-xs">No specific KPIs defined.</p>' : ''}
                       </div>
                    </div>
                </div>`;
            });
            actionsHtml += `</div>`;
         } else {
             actionsHtml += `<p class="text-center text-white/70 italic">No specific new actions were formulated based on the reframing.</p>`;
         }
        actionsHtml += `</div>`;
        actionsPanel.innerHTML = actionsHtml;

        // --- 4. Populate Learn Framework Panel ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding the Ladder of Inference</h3>

                <p class="italic text-center">Developed by Chris Argyris, the Ladder of Inference describes the often unconscious thinking process we go through to get from an observation to a decision or action. Understanding it helps us challenge our assumptions and make better decisions.</p>
                 
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                     <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-600/50 space-y-3">
                         <h4 class="text-xl font-bold text-indigo-300 mb-2"> The Rungs (Bottom-Up)</h4>
                         <p class="text-sm"><strong>1. Observation:</strong> Selecting data from the pool of available reality.</p>
                         <p class="text-sm"><strong>2. Selection:</strong> Filtering and choosing specific data to pay attention to (often unconsciously).</p>
                         <p class="text-sm"><strong>3. Interpretation:</strong> Adding meaning to the selected data based on our mental models.</p>
                         <p class="text-sm"><strong>4. Assumption:</strong> Making assumptions based on the interpreted meaning.</p>
                         <p class="text-sm"><strong>5. Conclusion:</strong> Drawing conclusions based on our assumptions.</p>
                         <p class="text-sm"><strong>6. Belief:</strong> Adopting beliefs based on these conclusions.</p>
                         <p class="text-sm"><strong>7. Action:</strong> Taking action based on our beliefs.</p>
                     </div>
                     <div class="bg-black/20 p-4 rounded-lg space-y-4">
                        <h4 class="text-lg font-bold mb-2"> The Danger: Reflexive Loops</h4>
                        <p class="text-sm">Our beliefs influence what data we select next time, creating a "reflexive loop." This reinforces our existing beliefs and can prevent us from seeing contradictory evidence, leading to poor decisions.</p>
                         <h4 class="text-lg font-bold mb-2 mt-4"> Using the Ladder Constructively:</h4>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li><strong>Awareness:</strong> Become conscious of your own thinking process.</li>
                            <li><strong>Reflection:</strong> Question your assumptions and interpretations. Ask "Why do I believe this?"</li>
                            <li><strong>Inquiry:</strong> Seek out different perspectives and data you might have ignored. Ask others how they interpret the situation.</li>
                            <li><strong>Testing:</strong> Test your conclusions and assumptions explicitly.</li>
                        </ul>
                        <p class="text-xs italic mt-3">This tool helps by making the inferred ladder explicit (Deconstruction) and prompting a conscious effort to challenge it (Reframing).</p>
                     </div>
                </div>

                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">Why Use This Framework?</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li>Improves critical thinking and decision-making.</li>
                        <li>Helps uncover hidden assumptions and biases.</li>
                        <li>Facilitates better communication by making reasoning explicit.</li>
                        <li>Enables more effective problem-solving by addressing root mental models.</li>
                        <li>Reduces conflict arising from misunderstood perspectives.</li>
                    </ul>
                 </div>
            </div>
        `;

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     // const chart = targetPanel.querySelector(".plotly-chart"); // If charts added later
                     // if (chart) Plotly.Plots.resize(chart);
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator AFTER rendering
    }

    function createSwotTowsLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Change class for this layout
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container p-6 max-w-2xl mx-auto w-full">
                            <h3 class="text-xl font-bold mb-4 text-white">Business Information</h3>
                            <div class="space-y-4">
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="businessContent" class="input-field h-48" placeholder="Describe your business, industry, market position, challenges, opportunities, etc."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                     <div class="input-file-wrapper">
                                         <label for="swotFile" id="swotFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Click to select a file...</span>
                                         </label>
                                         <input type="file" id="swotFile" class="input-file" accept=".txt,.pdf,.docx">
                                    </div>
                                    <p class="text-xs text-white/50 mt-2 text-center">Note: Only .txt files can be read by the browser. PDF/DOCX are not supported for reading.</p>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText">Run SWOT/TOWS Analysis</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>

                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;

        // Re-attach event listeners for the newly created elements
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // Listeners for radio buttons
        $("textInput").addEventListener("change", () => {
            $("textInputArea").classList.remove("hidden");
            $("docUploadArea").classList.add("hidden");
        });
        $("docUpload").addEventListener("change", () => {
            $("textInputArea").classList.add("hidden");
            $("docUploadArea").classList.remove("hidden");
        });
        // Listener for file input
        const fileInput = $("swotFile");
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $("swotFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                } else {
                    fileNameSpan.textContent = "Click to select a file...";
                    label.classList.remove("has-file");
                }
            });
        }
    }

    function createMiscLayout_MSC(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide Full Strategic Plan / Business Document</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="miscContent" class="input-field h-48" placeholder="Paste your complete business plan, strategic analysis, or project proposal here..."></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="miscFile" id="miscFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="miscFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Compile Final Report</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Final Sections</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("miscFile", "miscFileLabel", "textInputArea", "docUploadArea");
    }

    function createLeveragePointsLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Single column layout
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide System Description</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="leverageContent" class="input-field h-48" placeholder="Describe the system, its components, the goal of the system, and any challenges or inefficiencies you have observed..."></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                 <div class="input-file-wrapper">
                                     <label for="leverageFile" id="leverageFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                     </label>
                                     <input type="file" id="leverageFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Find Leverage Points</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

        // Re-attach all necessary event listeners for the new elements
        setupInputToggle("leverageFile", "leverageFileLabel", "textInputArea", "docUploadArea");
    }

    function createArchetypeAnalysisLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Change layout to single column
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide System Information</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="archetypeContent" class="input-field h-48" placeholder="Describe the system, its components, behaviors, and any recurring problems or patterns you have observed..."></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                 <div class="input-file-wrapper">
                                     <label for="archetypeFile" id="archetypeFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                     </label>
                                     <input type="file" id="archetypeFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Analyze System</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

        // Attach event listeners
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // Add listeners for radio buttons and file input
        $("textInput").addEventListener("change", () => {
            $("textInputArea").classList.remove("hidden");
            $("docUploadArea").classList.add("hidden");
        });
        $("docUpload").addEventListener("change", () => {
            $("textInputArea").classList.add("hidden");
            $("docUploadArea").classList.remove("hidden");
        });

        const fileInput = $("archetypeFile");
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $("archetypeFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                } else {
                    fileNameSpan.textContent = "Select .docx or .txt file...";
                    label.classList.remove("has-file");
                }
            });
        }
    }

    function createFactorAnalysisLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-4">
                               <h3 class="text-xl font-bold mb-4 text-white">Provide Business Information</h3>
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="factorContent" class="input-field h-48" placeholder="Describe your business, its operations, market environment, and internal resources..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="factorFile" id="factorFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .txt or .docx file...</span>
                                        </label>
                                        <input type="file" id="factorFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                    <div id="fileStats" class="text-sm text-white/70 text-center mt-2"></div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Analyze Factors</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                            </div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;

        // Attach event listeners
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // Add listeners for radio buttons and file input
        $("textInput").addEventListener("change", () => {
            $("textInputArea").classList.remove("hidden");
            $("docUploadArea").classList.add("hidden");
        });
        $("docUpload").addEventListener("change", () => {
            $("textInputArea").classList.add("hidden");
            $("docUploadArea").classList.remove("hidden");
        });

        const fileInput = $("factorFile");
        if (fileInput) {
            fileInput.addEventListener("change", async (e) => {
                const label = $("factorFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                const fileStats = $("fileStats");
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    fileNameSpan.textContent = file.name;
                    label.classList.add("has-file");
                    try {
                        const text = await extractTextFromFile(file);
                        fileStats.innerHTML = `<p>Word Count: ${text.split(/\s+/).length}</p><p>Character Count: ${text.length}</p>`;
                    } catch (err) {
                        fileStats.innerHTML = `<p class="text-red-400">Error reading file.</p>`;
                    }
                } else {
                    fileNameSpan.textContent = "Select .txt or .docx file...";
                    label.classList.remove("has-file");
                    fileStats.innerHTML = "";
                }
            });
        }
    }

    function createParetoLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div>
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="max-w-2xl mx-auto">
                            <div class="glass-container p-6 space-y-4">
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <label for="problemStatement" class="block text-sm font-medium text-gray-200 mb-2">Problem Statement</label>
                                    <textarea id="problemStatement" class="input-field h-32" placeholder="Describe the problem you want to analyze, including symptoms, context, and any known contributing factors..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                     <div class="input-file-wrapper">
                                         <label for="paretoFile" id="paretoFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Click to select a file...</span>
                                         </label>
                                         <input type="file" id="paretoFile" class="input-file" accept=".txt,.pdf,.docx">
                                    </div>
                                    <p class="text-xs text-white/50 mt-2 text-center">Upload a document describing the problem.</p>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText">Analyze Root Causes</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                            </div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        // Add listeners for radio buttons and file input
        $("textInput").addEventListener("change", () => {
            $("textInputArea").classList.remove("hidden");
            $("docUploadArea").classList.add("hidden");
        });
        $("docUpload").addEventListener("change", () => {
            $("textInputArea").classList.add("hidden");
            $("docUploadArea").classList.remove("hidden");
        });

        const fileInput = $("paretoFile");
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $("paretoFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                } else {
                    fileNameSpan.textContent = "Click to select a file...";
                    label.classList.remove("has-file");
                }
            });
        }
    }

    function createProcessMappingLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-4">
                               <h3 class="text-xl font-bold mb-4 text-white">Process Information</h3>
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="processContent" class="input-field h-48" placeholder="Describe the business process from start to finish. Include the steps, roles involved, and any decision points..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="processFile" id="processFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .txt or .docx file...</span>
                                        </label>
                                        <input type="file" id="processFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Map Process</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"></div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;
        setupInputToggle("processFile", "processFileLabel", "textInputArea", "docUploadArea");
    }

    function createSystemThinkingLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                     <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-4">
                                <h3 class="text-xl font-bold mb-4 text-white">System Description</h3>
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="systemContent" class="input-field h-48" placeholder="Describe the system you want to analyze. Include key elements, their relationships, and any observed behaviors or problems..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="systemFile" id="systemFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .txt or .docx file...</span>
                                        </label>
                                        <input type="file" id="systemFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Analyze System Dynamics</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"></div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;
        setupInputToggle("systemFile", "systemFileLabel", "textInputArea", "docUploadArea");
    }
   
    function createSemAnalysisLayout(template) {
    const contentContainer = $("templateDetailContent");
    contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Single column layout

    // --- HTML Structure ---
    contentContainer.innerHTML = `
        <div class="lg:col-span-1">
            <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

            <div class="max-w-2xl mx-auto w-full">
                <div class="glass-container p-6 space-y-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xl font-bold text-white">Analysis Configuration</h3>
                        <button type="button" id="configExamplesBtn" class="text-xs px-2 py-1 border border-white/30 rounded text-white/80 hover:bg-white/10 hover:text-white transition-all">View Examples</button>
                    </div>
                    <div id="configExamples" class="hidden mb-4 p-3 bg-black/20 border border-white/15 rounded-lg">
                        <div class="text-xs font-medium text-white/90 mb-2"> Configuration Examples</div>
                        <div class="space-y-2 text-xs">
                            <div id="exampleContent" class="text-white/80">Loading example...</div>
                        </div>
                    </div>

                    <div class="input-radio-group">
                        <input type="radio" name="semInputType" id="semInputFileToggle" class="input-radio" checked>
                        <label for="semInputFileToggle" class="input-radio-label">File Upload</label>
                        <input type="radio" name="semInputType" id="semInputTextToggle" class="input-radio">
                        <label for="semInputTextToggle" class="input-radio-label">Paste Text</label>
                    </div>

                    <div id="semFileUploadArea">
                        <label for="semFile" class="block text-sm font-medium text-gray-200 mb-2">Data File (.csv, .xlsx)</label>
                        <div class="input-file-wrapper">
                            <label for="semFile" id="semFileLabel" class="input-file-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                <span class="file-name">Select data file...</span>
                            </label>
                            <input type="file" id="semFile" class="input-file" accept=".csv,.xlsx">
                        </div>
                        <div id="semFileError" class="text-red-400 text-sm mt-2"></div>
                    </div>

                    <div id="semTextInputArea" class="hidden">
                        <label for="semDataText" class="block text-sm font-medium text-gray-200 mb-2">Paste CSV Data</label>
                        <textarea id="semDataText" class="input-field h-48" placeholder="Date,Var1,Var2...\n2023-01-01,10,20..."></textarea>
                        <div id="semTextError" class="text-red-400 text-sm mt-2"></div>
                    </div>

                    <div id="semDataPreview" class="hidden space-y-2">
                        <label class="block text-sm font-medium text-gray-200">Data Preview (First 5 Rows)</label>
                        <div class="overflow-x-auto rounded-lg border border-white/20">
                            <table class="min-w-full text-left text-sm text-white/90" id="semPreviewTable">
                            </table>
                        </div>
                    </div>

                    <div>
                        <label for="semModelTemplate" class="block text-sm font-medium text-gray-200 mb-2">Model Template</label>
                        <select id="semModelTemplate" class="input-field" disabled>
                            <option value="">-- Upload or paste data first --</option>
                        </select>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label for="semMeasurementSyntax" class="block text-sm font-medium text-gray-200">Measurement Model Syntax</label>
                            <button type="button" id="measurementExamplesBtn" class="text-xs px-2 py-1 border border-white/30 rounded text-white/80 hover:bg-white/10 hover:text-white transition-all">View Examples</button>
                        </div>
                        <div id="measurementExamples" class="hidden mb-2 p-3 bg-black/20 border border-white/15 rounded-lg">
                            <div class="text-xs font-medium text-white/90 mb-2"> Measurement Model Examples</div>
                            <div class="space-y-2 text-xs">
                                <div>
                                    <div class="text-white/80 mb-1">Basic Factor Structure:</div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                        <button class="absolute top-1 right-1 text-xs px-1 py-0.5 bg-white/10 rounded hover:bg-white/20" onclick="copyToClipboard(this, 'Anxiety =~ anx1 + anx2 + anx3 + anx4\\nDepression =~ dep1 + dep2 + dep3 + dep4')">Copy</button>
                                        Anxiety =~ anx1 + anx2 + anx3 + anx4<br>Depression =~ dep1 + dep2 + dep3 + dep4
                                    </div>
                                </div>
                                <div>
                                    <div class="text-white/80 mb-1">With Fixed Loadings:</div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                        <button class="absolute top-1 right-1 text-xs px-1 py-0.5 bg-white/10 rounded hover:bg-white/20" onclick="copyToClipboard(this, 'Performance =~ 1*perf1 + perf2 + perf3\\nSatisfaction =~ 1*sat1 + sat2 + sat3')">Copy</button>
                                        Performance =~ 1*perf1 + perf2 + perf3<br>Satisfaction =~ 1*sat1 + sat2 + sat3
                                    </div>
                                </div>
                            </div>
                        </div>
                        <textarea id="semMeasurementSyntax" class="input-field h-32" placeholder="e.g., Factor1 =~ varA + varB\nFactor2 =~ varC + varD..."></textarea>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label for="semStructuralSyntax" class="block text-sm font-medium text-gray-200">Structural Model Syntax</label>
                            <button type="button" id="structuralExamplesBtn" class="text-xs px-2 py-1 border border-white/30 rounded text-white/80 hover:bg-white/10 hover:text-white transition-all">View Examples</button>
                        </div>
                        <div id="structuralExamples" class="hidden mb-2 p-3 bg-black/20 border border-white/15 rounded-lg">
                            <div class="text-xs font-medium text-white/90 mb-2"> Structural Model Examples</div>
                            <div class="space-y-2 text-xs">
                                <div>
                                    <div class="text-white/80 mb-1">Simple Regression:</div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                        <button class="absolute top-1 right-1 text-xs px-1 py-0.5 bg-white/10 rounded hover:bg-white/20" onclick="copyToClipboard(this, 'Performance ~ Motivation + Ability\\nSatisfaction ~ Performance')">Copy</button>
                                        Performance ~ Motivation + Ability<br>Satisfaction ~ Performance
                                    </div>
                                </div>
                                <div>
                                    <div class="text-white/80 mb-1">Mediation Model:</div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                        <button class="absolute top-1 right-1 text-xs px-1 py-0.5 bg-white/10 rounded hover:bg-white/20" onclick="copyToClipboard(this, 'Outcome ~ c*Predictor + b*Mediator\\nMediator ~ a*Predictor\\n\\nindirect := a*b\\ntotal := c + (a*b)')">Copy</button>
                                        Outcome ~ c*Predictor + b*Mediator<br>Mediator ~ a*Predictor<br><br>indirect := a*b<br>total := c + (a*b)
                                    </div>
                                </div>
                            </div>
                        </div>
                        <textarea id="semStructuralSyntax" class="input-field h-32" placeholder="e.g., Factor1 ~ Factor2\nObservedVar ~ Factor1..."></textarea>
                    </div>

                    <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                        <span id="generateBtnText"> Run SEM Analysis</span>
                        <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                </div>
            </div>

            <div class="mt-12">
                <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"> {/* Results will be injected here */} </div>
                <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                    <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                    <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                </div>
            </div>
        </div>`;

    // --- Helper function for copying to clipboard ---
    window.copyToClipboard = function(button, text) {
        navigator.clipboard.writeText(text.replace(/\\n/g, '\n')).then(() => {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        });
    };

    // --- Attach Core Event Listeners ---
    $("generateBtn").addEventListener("click", handleGenerate); // Assumes handleGenerate exists and calls handleSemAnalysis
    reattachActionListeners(); // Assumes this function attaches save button listeners

    // --- Add Example Toggle Event Listeners ---
    $("configExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("configExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        
        if (isHidden) {
            // Display hardcoded example content immediately
            const exampleContent = $("exampleContent");
            const exampleText = `Date,Performance_Score,Satisfaction_Rating,Quality_Index,Revenue_USD
2023-01-01,85,4.2,8.5,15000
2023-02-01,87,4.4,8.7,16200
2023-03-01,89,4.6,8.9,17500
2023-04-01,82,4.1,8.2,14800
2023-05-01,91,4.8,9.1,18900
2023-06-01,88,4.5,8.8,17200`;

            exampleContent.innerHTML = `
                <div class="bg-black/30 p-2 rounded font-mono text-white/90 text-xs whitespace-pre-wrap">${exampleText}</div>
                <div class="text-white/60 text-xs mt-2 space-y-1">
                    <div class="font-medium text-white/80">SEM Data Requirements:</div>
                    <div> <strong>Clean column names:</strong> No spaces, symbols, or special characters (use underscores instead)</div>
                    <div> <strong>Numeric data only:</strong> All measurement variables must be numbers</div>
                    <div> <strong>Sample size:</strong> Minimum 200 rows recommended for reliable results</div>
                    <div> <strong>No missing values:</strong> Complete data for all variables (or <10% missing)</div>
                    <div> <strong>Variable types:</strong> Use meaningful names like Performance_Score, Customer_Satisfaction</div>
                    <div> <strong>Scale consistency:</strong> Use same scale for related measures (e.g., all 1-10 ratings)</div>
                </div>
            `;
        }
        
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

    $("measurementExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("measurementExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

    $("structuralExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("structuralExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

    // --- Restore Cached Results (if any) ---
    if (analysisCache[currentTemplateId]) {
        $("analysisResult").innerHTML = analysisCache[currentTemplateId];
        $("analysisActions").classList.remove("hidden");
        // Re-attach listeners specific to the results content (e.g., tabs)
        reattachTabListeners($("analysisResult")); // Assumes this function exists
    } else {
        // Default placeholder if no cached results
        $("analysisResult").innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
        $("analysisActions").classList.add("hidden");
    }

    // --- Get References to SEM-Specific DOM Elements ---
    const fileInput = $("semFile");
    const textInput = $("semDataText");
    const measurementSyntaxBox = $("semMeasurementSyntax");
    const structuralSyntaxBox = $("semStructuralSyntax");
    const fileError = $("semFileError");
    const textError = $("semTextError");
    const fileToggle = $("semInputFileToggle");
    const textToggle = $("semInputTextToggle");
    const fileArea = $("semFileUploadArea");
    const textArea = $("semTextInputArea");
    const dataPreviewContainer = $("semDataPreview");
    const previewTable = $("semPreviewTable");
    const modelTemplateSelect = $("semModelTemplate");
    let fullHeaders = []; // Holds the headers extracted from data

    // --- SEM Helper Functions --- (Keep all helper functions as they were)

    /**
     * Extracts headers from CSV text, trying common delimiters.
     * @param {string} text - CSV content.
     * @returns {string[]} Array of headers.
     */
    const getHeadersFromText = (text) => {
        if (!text || typeof text !== 'string' || !text.trim()) throw new Error("Input text is empty.");
        const firstLine = text.split(/[\r\n]+/)[0];
        if (!firstLine || !firstLine.trim()) throw new Error("First line (header) is empty.");

        let headers = firstLine.split(',').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
        if (headers.length <= 1) {
            headers = firstLine.split(';').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
        }
        if (headers.length <= 1) {
            headers = firstLine.split('\t').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
        }
        if (headers.length === 0) throw new Error("Could not parse headers (tried comma, semicolon, tab).");
        return headers;
    };

    /** Shows the first 5 data rows in the preview table. */
    const showDataPreview = (csvText) => {
        try {
            const lines = csvText.split(/[\r\n]+/).filter(Boolean); // Filter empty lines
            const rows = lines.slice(0, 6); // Header + 5 data rows
            if (rows.length < 2) { dataPreviewContainer.classList.add("hidden"); return; }

            const headers = getHeadersFromText(rows[0]);
            let tableHTML = '<thead class="bg-white/10 text-xs uppercase"><tr>';
            headers.forEach(h => { tableHTML += `<th scope="col" class="px-4 py-2">${h}</th>`; });
            tableHTML += '</tr></thead><tbody>';

            rows.slice(1).forEach((line, rowIndex) => {
                // Simple split for preview - assumes consistent delimiter detected by getHeadersFromText
                let cells = line.split(',');
                if (cells.length <= 1) cells = line.split(';');
                if (cells.length <= 1) cells = line.split('\t');

                tableHTML += `<tr class="border-t border-white/10 ${rowIndex % 2 === 0 ? 'bg-white/5' : ''}">`;
                headers.forEach((_, cellIndex) => {
                    tableHTML += `<td class="px-4 py-2">${cells[cellIndex] === undefined ? '' : cells[cellIndex]}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody>';
            previewTable.innerHTML = tableHTML;
            dataPreviewContainer.classList.remove("hidden");
        } catch (e) {
            console.error("Error showing data preview:", e);
            dataPreviewContainer.classList.add("hidden");
        }
    };

    /** Populates the model template dropdown based on detected headers. */
    const updateModelTemplates = (headers) => {
        fullHeaders = headers;
        modelTemplateSelect.innerHTML = '';
        modelTemplateSelect.add(new Option("Select a model template...", ""));
        modelTemplateSelect.add(new Option("Custom Syntax (Type below)", "custom"));
        modelTemplateSelect.add(new Option("Auto-Suggest (Generic Model)", "autosuggest"));
        modelTemplateSelect.disabled = false;
    };

    /** Splits syntax into measurement/structural parts and populates text boxes, removing comments first. */
    const populateSyntaxBoxes = (fullSyntax) => {
        const uncommentedSyntax = fullSyntax.split('\n')
            .filter(line => !line.trim().startsWith('#')) // Remove comments
            .join('\n');
        const lines = uncommentedSyntax.split('\n');
        let measurement = [], structural = [], foundStructural = false;

        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (!trimmedLine) return; // Skip blank lines after comment removal
            if (trimmedLine.includes('~') && !trimmedLine.includes('=~')) foundStructural = true;
            if (foundStructural) structural.push(line);
            else measurement.push(line);
        });

        measurementSyntaxBox.value = measurement.join('\n').trim();
        structuralSyntaxBox.value = structural.join('\n').trim();
        measurementSyntaxBox.placeholder = measurementSyntaxBox.value ? measurementSyntaxBox.placeholder : "e.g., F1 =~ x1+x2";
        structuralSyntaxBox.placeholder = structuralSyntaxBox.value ? structuralSyntaxBox.placeholder : "e.g., F1 ~ F2";
    };

    /** Generates the recommended path analysis syntax (comment-free). */
    const generateRecommendedSyntax = () => {
        const fullSyntax = `
Marketing =~ Ad_Spend_USD + Brand_Awareness_Pct

Profit_USD ~ Marketing + Online_Sales_USD + Retail_Sales_USD`;
        populateSyntaxBoxes(fullSyntax);
    };

    /** Generates a super simple SEM syntax based on columns (quick fix version). */
    const generateSyntax = () => {
        if (fullHeaders.length === 0) { 
            alert("Data headers not found for auto-suggestion."); 
            return; 
        }

        // Filter out common non-analytical columns
        const excludePatterns = ['id', 'date', 'time', 'timestamp', 'index', 'row'];
        const analyticalHeaders = fullHeaders.filter(h => 
            !excludePatterns.some(pattern => h.toLowerCase().includes(pattern))
        );

        // QUICK FIX: Check if we have enough columns
        if (analyticalHeaders.length < 4) {
            populateSyntaxBoxes(`# Need at least 4 numeric columns for SEM\n# Available: ${analyticalHeaders.join(', ')}\n# Please add more numeric variables to your data`);
            return;
        }

        // QUICK FIX: Generate the simplest possible model
        let measurementPart = '';
        let structuralPart = '';
        
        // Just create 2 factors with 2 indicators each
        measurementPart += `Factor1 =~ ${analyticalHeaders[0]} + ${analyticalHeaders[1]}\n`;
        measurementPart += `Factor2 =~ ${analyticalHeaders[2]} + ${analyticalHeaders[3]}\n`;
        
        // Simple structural relationship
        structuralPart = 'Factor2 ~ Factor1\n';

        // Combine parts
        let fullSyntax = measurementPart.trim() + '\n\n' + structuralPart.trim();
        populateSyntaxBoxes(fullSyntax);
    };

    /** Processes data input (file or text) to update UI state. */
    const processDataInput = async (isFileInput) => {
        let textContent = null;
        let originalHeaders = [];
        const errorEl = isFileInput === null ? null : (isFileInput ? fileError : textError);
        const inputEl = isFileInput === null ? null : (isFileInput ? fileInput : textInput);

        // Clear errors
        if (fileError) fileError.textContent = "";
        if (textError) textError.textContent = "";

        // Reset UI before processing
        modelTemplateSelect.disabled = true;
        modelTemplateSelect.innerHTML = '<option value="">-- Upload or paste data first --</option>';
        dataPreviewContainer.classList.add("hidden");
        previewTable.innerHTML = "";
        measurementSyntaxBox.value = ""; // Clear syntax boxes too
        structuralSyntaxBox.value = "";
        measurementSyntaxBox.placeholder = "Upload or paste data to see model templates...";
        structuralSyntaxBox.placeholder = "";

        // If isFileInput is null, it means we just need to reset the UI (e.g., file deselected)
        if (isFileInput === null) return;

        try {
            if (isFileInput) {
                const file = inputEl.files[0];
                if (!file) return;
                textContent = await extractTextFromFile(file);
            } else {
                textContent = inputEl.value;
                if (!textContent.trim()) return;
            }

            originalHeaders = getHeadersFromText(textContent);

            // QUICK FIX: Basic data validation
            const lines = textContent.split(/[\r\n]+/).filter(Boolean);
            const dataRows = lines.slice(1); // Skip header
            
            if (dataRows.length < 10) {
                if (errorEl) errorEl.textContent = "Warning: Very small dataset. Need at least 10 rows for reliable SEM analysis.";
            }
            
            // Check for numeric data in first few rows
            let numericColumnsCount = 0;
            if (dataRows.length > 0) {
                const firstRow = dataRows[0].split(/[,;\t]/);
                firstRow.forEach((cell, index) => {
                    if (index > 0 && !isNaN(parseFloat(cell)) && isFinite(cell)) { // Skip first column (might be date/id)
                        numericColumnsCount++;
                    }
                });
            }
            
            if (numericColumnsCount < 3) {
                if (errorEl) errorEl.textContent = "Warning: Most columns appear non-numeric. SEM requires numeric data.";
            }

            // If headers parsed successfully:
            showDataPreview(textContent);
            updateModelTemplates(originalHeaders); // This enables the dropdown

            // AUTO-TRIGGER: Only if we have sufficient data
            if (dataRows.length >= 10 && numericColumnsCount >= 3) {
                modelTemplateSelect.value = "autosuggest";
                modelTemplateSelect.dispatchEvent(new Event('change'));
            }

        } catch (err) {
            console.error("Input processing failed:", err);
            if (errorEl) errorEl.textContent = `Error: ${err.message}.`;
            // Reset UI to error state
            modelTemplateSelect.disabled = true;
            modelTemplateSelect.innerHTML = '<option value="">-- Error reading data --</option>';
            dataPreviewContainer.classList.add("hidden");
            measurementSyntaxBox.placeholder = "Error reading input data.";
            structuralSyntaxBox.placeholder = "";
        }
    };

    // --- Attach Input Event Listeners ---

    // Radio toggles
    fileToggle.addEventListener("change", () => {
        fileArea.classList.remove("hidden");
        textArea.classList.add("hidden");
        processDataInput(fileInput.files.length > 0 ? true : null); // Re-process if file exists, else reset
    });
    textToggle.addEventListener("change", () => {
        fileArea.classList.add("hidden");
        textArea.classList.remove("hidden");
        processDataInput(textInput.value.trim() ? false : null); // Re-process if text exists, else reset
    });

    // File input selection
    if (fileInput) {
        fileInput.addEventListener("change", () => {
            const label = $("semFileLabel");
            const fileNameSpan = label.querySelector(".file-name");
            if (fileInput.files.length > 0) {
                fileNameSpan.textContent = fileInput.files[0].name;
                label.classList.add("has-file");
                processDataInput(true); // Process the new file
            } else { // File deselected
                fileNameSpan.textContent = "Select data file...";
                label.classList.remove("has-file");
                processDataInput(null); // Reset the UI
            }
        });
    }

    // Text input typing (only process if text area is visible)
    // Use 'blur' or a debounce mechanism if 'input' triggers too often
    if (textInput) {
        textInput.addEventListener("blur", () => { // Changed from 'input' to 'blur'
            if (!textArea.classList.contains("hidden")) {
                processDataInput(textInput.value.trim() ? false : null);
            }
        });
    }

    // Model template selection change
    if (modelTemplateSelect) {
        // --- MODIFIED LISTENER ---
        modelTemplateSelect.addEventListener("change", async () => { // Make the handler async
            const selected = modelTemplateSelect.value;
            measurementSyntaxBox.value = ""; // Clear boxes when selection changes
            structuralSyntaxBox.value = "";

            switch (selected) {
                case "custom":
                    measurementSyntaxBox.placeholder = "Type measurement model syntax here...";
                    structuralSyntaxBox.placeholder = "Type structural model syntax here...";
                    measurementSyntaxBox.focus(); // Focus the first box for custom entry
                    break;
                case "autosuggest":
                     measurementSyntaxBox.placeholder = "Auto-suggesting generic model...";
                     structuralSyntaxBox.placeholder = "Auto-suggesting generic model...";
                    generateSyntax(); // Call the simple auto-suggest function
                     measurementSyntaxBox.placeholder = measurementSyntaxBox.value ? "Review auto-suggested syntax." : "Could not auto-suggest.";
                     structuralSyntaxBox.placeholder = structuralSyntaxBox.value ? "Review auto-suggested syntax." : "";

                    break;
                case "recommended":
                     measurementSyntaxBox.placeholder = "Loading recommended model...";
                     structuralSyntaxBox.placeholder = "Loading recommended model...";
                    generateRecommendedSyntax(); // Call the specific recommended syntax function
                     measurementSyntaxBox.placeholder = "Review recommended syntax.";
                     structuralSyntaxBox.placeholder = "Review recommended syntax.";
                    break;
                default:
                    // Option "" selected (Select a model template...)
                    measurementSyntaxBox.placeholder = "Select a model template or type syntax...";
                    structuralSyntaxBox.placeholder = "";
            }
        });
        // --- END OF MODIFIED LISTENER ---
    }

}

function createPredictiveAnalysisLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
        <div class="lg:col-span-1">
            <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
            <div class="max-w-3xl mx-auto w-full space-y-8">
                <div class="glass-container p-6">
                    <h3 class="text-2xl font-bold mb-4 text-white">Step 1: Upload Your Data</h3>
                    <div class="input-file-wrapper">
                        <label for="predictiveFile" id="predictiveFileLabel" class="input-file-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                            <span class="file-name">Select .csv or .xlsx file...</span>
                        </label>
                        <input type="file" id="predictiveFile" class="input-file" accept=".csv,.xlsx,.xls">
                    </div>
                    <div id="fileInfo" class="text-sm text-white/70 text-center mt-3"></div>
                </div>
                <div id="configSection" class="glass-container p-6 hidden">
                    <h3 class="text-2xl font-bold mb-4 text-white">Step 2: Configure Prediction</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label for="dateColumnSelect" class="block text-sm font-medium text-gray-200 mb-2">Select Date/Time Column:</label>
                            <div class="select-wrapper"><select id="dateColumnSelect" class="input-field"></select></div>
                        </div>
                        <div>
                            <label for="metricSelect" class="block text-sm font-medium text-gray-200 mb-2">Select Value Column to Predict:</label>
                            <div class="select-wrapper"><select id="metricSelect" class="input-field"></select></div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="horizonSelect" class="block text-sm font-medium text-gray-200 mb-2">Forecast Horizon:</label>
                        <div class="select-wrapper">
                            <select id="horizonSelect" class="input-field">
                                <option value="quarter">Next Quarter (3 months)</option>
                                <option value="6months">Next 6 Months</option>
                                <option value="year" selected>Next Year (12 months)</option>
                                <option value="2years">Next 2 Years (24 months)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="modelSection" class="glass-container p-6 hidden">
                    <h3 class="text-2xl font-bold mb-4 text-white">Step 3: Select Forecasting Model</h3>
                    <div class="space-y-3">
                        <div class="p-4 rounded-lg bg-white/10 border border-white/20"><label><input type="radio" name="model" value="prophet" class="mr-2" checked> <strong>Prophet (Recommended)</strong></label><p class="text-sm text-white/70 pl-6">Best for business forecasting. Automatically handles seasonality, missing data, and outliers.</p></div>
                        <div class="p-4 rounded-lg bg-white/10 border border-white/20"><label><input type="radio" name="model" value="arima" class="mr-2"> <strong>ARIMA (Classic)</strong></label><p class="text-sm text-white/70 pl-6">Industry-standard time series model. Reliable for data with clear trends.</p></div>
                    </div>
                </div>
                <div id="previewSection" class="glass-container p-6 hidden">
                    <h3 class="text-2xl font-bold mb-4 text-white">Data Preview (First 5 Rows)</h3>
                    <div id="dataPreviewTable" class="overflow-x-auto"></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="generateBtn" class="btn btn-primary w-full text-lg py-3" disabled>
                        <span id="generateBtnText"> Generate Forecast</span>
                        <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                    <button id="resetBtn" class="btn btn-secondary w-full text-lg py-3">Reset</button>
                </div>
            </div>
            <div class="mt-12">
                <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                    <div class="text-white/60 p-8 text-center">Your generated forecast will appear here.</div>
                </div>
                <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                    <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                    <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                </div>
            </div>
        </div>`;

        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();
        const fileInput = $("predictiveFile");

        // (Paste the corrected fileInput.addEventListener from above here)
        fileInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            $("predictiveFileLabel").querySelector(".file-name").textContent = file.name;
            $("predictiveFileLabel").classList.add("has-file");
            try {
                const text = await extractTextFromFile(file);
                const lines = text.split(/\r?\n/);
                const columns = lines[0].split(",").map((h) => h.trim().replace(/^"|"$/g, ""));
                $("fileInfo").innerHTML =
                    `<strong>File:</strong> ${file.name}<br><strong>Columns Found:</strong> ${columns.length}`;
                const metricSelect = $("metricSelect");
                const dateColumnSelect = $("dateColumnSelect");
                metricSelect.innerHTML = '<option value="">Select...</option>';
                dateColumnSelect.innerHTML = '<option value="">Select...</option>';
                columns.forEach((col) => {
                    metricSelect.add(new Option(col, col));
                    dateColumnSelect.add(new Option(col, col));
                });
                const previewSection = $("previewSection");
                const dataPreviewTable = $("dataPreviewTable");
                let tableHTML =
                    '<table class="w-full text-left text-sm text-white/80"><thead><tr class="border-b border-white/20">';
                columns.forEach((col) => {
                    tableHTML += `<th class="p-2">${col}</th>`;
                });
                tableHTML += "</tr></thead><tbody>";
                const previewRows = lines.slice(1, 6);
                previewRows.forEach((rowStr) => {
                    tableHTML += "<tr>";
                    rowStr.split(",").forEach((cell) => {
                        tableHTML += `<td class="p-2 border-t border-white/10">${cell}</td>`;
                    });
                    tableHTML += "</tr>";
                });
                tableHTML += "</tbody></table>";
                dataPreviewTable.innerHTML = tableHTML;
                previewSection.classList.remove("hidden");
                $("configSection").classList.remove("hidden");
                $("modelSection").classList.remove("hidden");
                $("generateBtn").disabled = false;
            } catch (err) {
                $("fileInfo").innerHTML =
                    `<p class="text-red-400">Error reading file. Please ensure it is a valid CSV or XLSX.</p>`;
                $("configSection").classList.add("hidden");
                $("modelSection").classList.add("hidden");
                $("generateBtn").disabled = true;
            }
        });

        const resetBtn = $("resetBtn");
        resetBtn.addEventListener("click", () => {
            fileInput.value = "";
            $("predictiveFileLabel").querySelector(".file-name").textContent = "Select .csv or .xlsx file...";
            $("predictiveFileLabel").classList.remove("has-file");
            $("fileInfo").innerHTML = "";
            $("configSection").classList.add("hidden");
            $("modelSection").classList.add("hidden");
            $("previewSection").classList.add("hidden");
            $("generateBtn").disabled = true;
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated forecast will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        });
    }
    
    function createDematelLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
            <div class="lg:col-span-1">
                <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                <div class="max-w-2xl mx-auto w-full">
                    <div class="glass-container p-6 space-y-4">
                        <h3 class="text-xl font-bold mb-4 text-white">System or Problem Description</h3>
                        <div class="input-radio-group">
                            <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                            <label for="textInput" class="input-radio-label">Text Input</label>
                            <input type="radio" name="inputType" id="docUpload" class="input-radio">
                            <label for="docUpload" class="input-radio-label">Document Upload</label>
                        </div>
                        <div id="textInputArea">
                            <textarea id="dematelContent" class="input-field h-48" placeholder="Describe the system and its interacting factors. For example, 'Factors affecting product adoption include perceived usefulness, ease of use, social influence, and cost...'"></textarea>
                        </div>
                        <div id="docUploadArea" class="hidden">
                            <div class="input-file-wrapper">
                                <label for="dematelFile" id="dematelFileLabel" class="input-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                    <span class="file-name">Select .txt or .docx file...</span>
                                </label>
                                <input type="file" id="dematelFile" class="input-file" accept=".txt,.docx">
                            </div>
                        </div>
                        <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                            <span id="generateBtnText">Analyze Causal Factors</span>
                            <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                    </div>
                </div>
                <div class="mt-12">
                    <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                    <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"></div>
                    <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                        <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                        <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                    </div>
                </div>
            </div>`;
        setupInputToggle("dematelFile", "dematelFileLabel", "textInputArea", "docUploadArea");
    }

    function setupInputToggle(fileInputId, fileLabelId, textInputAreaId, docUploadAreaId) {
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // --- THIS IS THE FIX ---
        // Only add radio button listeners if the elements actually exist on the page.
        const textInput = $("textInput");
        const docUpload = $("docUpload");
        if (textInput && docUpload && $(textInputAreaId) && $(docUploadAreaId)) {
            textInput.addEventListener("change", () => {
                $(textInputAreaId).classList.remove("hidden");
                $(docUploadAreaId).classList.add("hidden");
            });
            docUpload.addEventListener("change", () => {
                $(textInputAreaId).classList.add("hidden");
                $(docUploadAreaId).classList.remove("hidden");
            });
        }
        // --- END OF FIX ---

        const fileInput = $(fileInputId);
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $(fileLabelId);
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                } else {
                    fileNameSpan.textContent = "Click to select a file...";
                    label.classList.remove("has-file");
                }
            });
        }
    }

    function frameworkCheckboxChangeHandler() {
        const checkedBoxes = document.querySelectorAll("#frameworkList .method-checkbox:checked");
        const selectionCounter = $("selectionCounter");

        if (checkedBoxes.length > currentSelectionLimit) {
            this.checked = false;
        }

        const finalCheckedCount = document.querySelectorAll("#frameworkList .method-checkbox:checked").length;
        if (selectionCounter) {
            selectionCounter.textContent = `Selected: ${finalCheckedCount} / ${currentSelectionLimit}`;
        }
    }

    function configureFrameworkSelector(limit) {
        currentSelectionLimit = limit;
        const selectionCounter = $("selectionCounter");
        const checkboxes = document.querySelectorAll("#frameworkList .method-checkbox");

        if (!selectionCounter || !checkboxes) return;

        selectionCounter.textContent = `Selected: 0 / ${limit}`;

        const rule = templateRules[currentTemplateId] || {};
        if (!rule.preselectFramework) {
            checkboxes.forEach((cb) => {
                cb.checked = false;
            });
        }
        frameworkCheckboxChangeHandler();
    }

    function getSelectedFrameworks() {
        const checkedBoxes = document.querySelectorAll("#frameworkList .method-checkbox:checked");
        const selectedMethods = [];

        const frameworkMap = {
            "Reframing Thinking": "ReframingThinking",
            "Delphi Method": "DelphiMethod",
            "Blue Ocean Strategy": "BlueOcean",
            "Design Thinking": "DesignThinking",
            "Thinking Hats": "ThinkingHats",
            "Business Model Canvas": "BusinessModelCanvas",
            SCAMPER: "SCAMPER",
            "TRIZ (Theory of Inventive Problem Solving)": "TRIZ"
        };

        checkedBoxes.forEach((checkbox) => {
            const methodText = checkbox.dataset.framework;
            if (frameworkMap[methodText]) {
                selectedMethods.push(frameworkMap[methodText]);
            }
        });
        return selectedMethods.join(",");
    }

    function getSelectedSections() {
        const checkedBoxes = document.querySelectorAll("#analysisList .method-checkbox:checked");
        const sectionMap = {
            Introduction: "introduction",
            "Overview of business": "overview_of_business",
            "process overview": "process_overview",
            "mission statement": "mission_statement",
            "vision analysis": "vision_analysis",
            "vision statement 2": "vision_statement_2",
            "novel strategy part 1": "novel_strategy_part_1",
            "novel strategy part 2": "novel_strategy_part_2",
            "novel strategy part 3": "novel_strategy_part_3"
        };

        if (checkedBoxes.length === 0) {
            return Object.values(sectionMap).join(",");
        }

        const selectedSections = [];
        checkedBoxes.forEach((checkbox) => {
            const sectionText = checkbox.nextElementSibling.textContent.trim();
            if (sectionMap[sectionText]) {
                selectedSections.push(sectionMap[sectionText]);
            }
        });
        return selectedSections.join(",");
    }

    function getFrameworkForTemplate(templateId) {
        const selectedFrameworks = getSelectedFrameworks();
        return selectedFrameworks || "BlueOcean,SCAMPER";
    }

    // =========================================================================
    // ===== ANALYSIS LOGIC FUNCTIONS                                     =====
    // =========================================================================

    /**
     * Extracts text from a user-uploaded file. Supports .txt and .docx.
     */
    async function extractTextFromFile(file) {
        return new Promise((resolve, reject) => {
            if (file.type === "text/plain" || file.name.endsWith(".csv")) {
                // This is the corrected line
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject("Error reading file.");
                reader.readAsText(file);
            } else if (file.name.endsWith(".docx")) {
                if (window.mammoth) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const arrayBuffer = event.target.result;
                        try {
                            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                            resolve(result.value);
                        } catch (err) {
                            reject(`Error reading .docx file: ${err.message}`);
                        }
                    };
                    reader.onerror = () => reject("Error preparing .docx file for reading.");
                    reader.readAsArrayBuffer(file);
                } else {
                    reject(".docx reader library (mammoth.js) not found.");
                }
            } else {
                reject(`Unsupported file type: ${file.name.split(".").pop()}. Please use .txt or .docx.`);
            }
        });
    }

    /**
     * Robustly extracts a JSON object from a string, which might contain extra text.
     */
    function extractJsonRobust(text) {
        try {
            const jsonStart = text.indexOf("{");
            const jsonEnd = text.lastIndexOf("}") + 1;
            if (jsonStart !== -1 && jsonEnd !== -1) {
                const jsonStr = text.substring(jsonStart, jsonEnd);
                return JSON.parse(jsonStr);
            }
        } catch (e) {
            console.warn("Standard JSON parsing failed. The AI response may be malformed.", e);
        }
        throw new Error("Failed to parse a valid JSON object from the AI's response.");
    }

    async function handleGenerate() {
        if (!currentTemplateId) return;

        const analysisResultContainer = $("analysisResult");
        setLoading("generate", true);
        const analysisActionsEl = $("analysisActions");
        if (analysisActionsEl) {
            analysisActionsEl.classList.add("hidden");
        }

        if (currentTemplateId === "swot-tows") {
            await handleSwotTowsAnalysis();
        } else if (currentTemplateId === "archetype-analysis") {
            await handleArchetypeAnalysis();
        } else if (currentTemplateId === "leverage-points") {
            await handleLeveragePointsAnalysis();
        } else if (currentTemplateId === "visualization") {
            // <-- ADD THIS BLOCK
            await handleVisualizationAnalysis_DA();
        } else if (currentTemplateId === "prescriptive-analysis") {
            // <-- ADD THIS BLOCK
            await handlePrescriptiveAnalysis_DA();
        } else if (currentTemplateId === "thinking-system") {
            // <-- ADD THIS BLOCK
            await handleThinkingSystemAnalysis_NS();
        } else if (currentTemplateId === "creative-dissonance") {
            // <-- ADD THIS BLOCK
            await handleCreativeDissonanceAnalysis_NS();
        } else if (currentTemplateId === "pareto-fishbone") {
            await handleParetoFishboneAnalysis();
        } else if (currentTemplateId === "system-actions") {
            // <-- ADD THIS BLOCK
            await handleSystemActionsAnalysis_ST();
        } else if (currentTemplateId === "goals-initiatives") {
            await handleGoalsAndInitiativesAnalysis_SP();
        } else if (currentTemplateId === "living-system") {
            // <-- ADD THIS BLOCK
            await handleLivingSystemAnalysis_NS();
        } else if (currentTemplateId === "system-objectives") {
            // <-- ADD THIS BLOCK
            await handleSystemObjectivesAnalysis_ST();
        } else if (currentTemplateId === "pls-analysis") {
            // <-- ADD THIS BLOCK
            await handlePlsAnalysis_DA();
        } else if (currentTemplateId === "sem-analysis") {
            // <-- ADD THIS BLOCK
            await handleSemAnalysis();
        } else if (currentTemplateId === "predictive-analysis") {
            await handlePredictiveAnalysis();
        } else if (currentTemplateId === "dematel-analysis") {
            await handleDematelAnalysis();
        } else if (currentTemplateId === "descriptive-analysis") {
            // <-- ADD THIS BLOCK
            await handleDescriptiveAnalysis_DA();
        } else if (currentTemplateId === "kpi-events") {
            await handleKpiAnalysis_KE();
        } else if (currentTemplateId === "regression-analysis") {
            // <-- ADD THIS BLOCK
            await handleRegressionAnalysis_DA();
        } else if (currentTemplateId === "novel-goals-initiatives") {
            // <-- ADD THIS BLOCK
            await handleNovelGoalsAnalysis_NS();
        } else if (currentTemplateId === "misc-summary") {
            await handleMiscAnalysis_MSC();
        } else if (currentTemplateId === "action-plans") {
            await handleActionPlansAnalysis_AP();
        } else if (currentTemplateId === "factor-analysis") {
            await handleFactorAnalysis();
        } else if (currentTemplateId === "system-goals-initiatives") {
            await handleSystemGoalsAnalysis();
        } else if (currentTemplateId === "process-mapping") {
            await handleProcessMappingAnalysis();
        } else if (currentTemplateId === "system-thinking-analysis") {
            await handleSystemThinkingAnalysis();
        } else {
            // --- Generic n8n workflow for all other tools ---
            analysisResultContainer.innerHTML = `
                        <div class="text-center text-white/70 p-8">
                            <div class="typing-indicator mb-6">
                                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-4">Generating Your Strategic Analysis</h3>
                            <p class="text-white/80 mb-2">This comprehensive analysis may take 2-5 minutes to complete.</p>
                            <p class="text-white/60 text-sm">Please keep this page open while we process your request.</p>
                        </div>`;

            let fullPrompt = "";
            const formData = new FormData();
            const companyName = $("companyName").value.trim();
            const companyDocumentsFile = $("companyDocumentsFile").files[0];
            const location = $("location").value.trim();
            const framework = getFrameworkForTemplate(currentTemplateId);
            const sections = getSelectedSections();

            if (!companyName || !companyDocumentsFile || !location) {
                analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Please fill out all fields and upload a file.</div>`;
                setLoading("generate", false);
                return;
            }
            fullPrompt = `User Information: - Company Name: ${companyName} - Location: ${location}`;

            // Add context if the field exists
            const contextEl = $("useCaseContext");
            if (contextEl && contextEl.value.trim()) {
                const context = contextEl.value.trim();
                fullPrompt += ` - Context: ${context}`;
                formData.append("context", context);
            }

            formData.append("customerName", companyName);
            formData.append("location", location);
            formData.append("company_documents", companyDocumentsFile.name);
            formData.append("file", companyDocumentsFile);
            formData.append("framework", framework);
            formData.append("sections", sections);
            formData.append("prompt", fullPrompt);
            formData.append("templateId", currentTemplateId);

            try {
                const {
                    data: { session }
                } = await supabase.auth.getSession();
                if (!session) throw new Error("Please log in to generate analysis.");

                const messageId = Date.now();
                pendingAnalysisRequests.set(messageId, analysisResultContainer);
                formData.append("messageId", messageId);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch("https://n8n.data2int.com/webhook/analysis-ev2", {
                    method: "POST",
                    headers: { Authorization: `Bearer ${session.access_token}` },
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                console.log("Analysis request submitted successfully.");
            } catch (error) {
                if (error.name === "AbortError") {
                    console.log("Fetch request timed out as expected. Waiting for WebSocket response.");
                    return;
                }
                console.error("Error submitting analysis request:", error);
                analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                setLoading("generate", false);
            }
        }
    }

    async function handleDescriptiveAnalysis_DA() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Performing Calculations...</h3><p class="text-white/80 mb-2">Calculating descriptive statistics...</p></div>`;
        setLoading("generate", true); // Set loading state

        const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
        // *** MODEL NAME UPDATED HERE ***
        const MODEL_NAME = "qwen3:30b-a3b"; // Switched to Qwen model
        // *******************************

        try {
            const dataFile = $("descriptiveFile").files[0];
            const contextFile = $("descriptiveContextFile").files[0];

            if (!dataFile) {
                throw new Error(" Please upload a CSV data file.");
            }

            const csvText = await extractTextFromFile(dataFile);
            // Use existing robust parseCSV function
            const { header, rows } = parseCSV(csvText);

            if (rows.length === 0) {
                 throw new Error(" The CSV file appears empty or could not be parsed correctly.");
            }

            // --- Client-Side Statistical Calculations (Improved) ---
            console.log(`Calculating stats for ${rows.length} rows and ${header.length} columns.`);
            const numerical_summary = [];
            const categorical_summary = [];
            const visualizations = [];

            // (Keep the existing calculation logic from the previous correct version here)
            header.forEach((col) => {
                const values = rows.map(r => r[col]).filter(v => v !== undefined && v !== null && v !== '');
                if (values.length === 0) { console.warn(`Skipping empty column: ${col}`); return; }
                const numericValues = values.map(v => typeof v === 'string' ? parseFloat(v.replace(/[^0-9.-]+/g,"")) : Number(v)).filter(n => !isNaN(n));
                const isNumeric = (numericValues.length / values.length) > 0.8;

                if (isNumeric && numericValues.length > 1) {
                    const count = numericValues.length;
                    const sum = numericValues.reduce((a, b) => a + b, 0);
                    const mean = sum / count;
                    const sorted = [...numericValues].sort((a, b) => a - b);
                    const median = count % 2 === 0 ? (sorted[count / 2 - 1] + sorted[count / 2]) / 2 : sorted[Math.floor(count / 2)];
                    const min = sorted[0];
                    const max = sorted[sorted.length - 1];
                    const variance = numericValues.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / (count > 1 ? count - 1 : 1);
                    const std_dev = count > 1 ? Math.sqrt(variance) : 0;
                    const q1Index = Math.max(0, Math.floor((count + 1) * 0.25) - 1);
                    const q3Index = Math.min(count - 1, Math.floor((count + 1) * 0.75) - 1);
                    const q1 = sorted[q1Index];
                    const q3 = sorted[q3Index];
                    const iqr = (q3 !== undefined && q1 !== undefined) ? q3 - q1 : undefined;
                    numerical_summary.push({ variable: col, count, mean, median, std_dev, min, max, q1, q3, iqr });
                    visualizations.push({ chart_type: "histogram", variable: col, data: numericValues, title: `Distribution of ${col}` });
                } else {
                    const frequencies = {};
                    values.forEach((v) => { const key = String(v); frequencies[key] = (frequencies[key] || 0) + 1; });
                    const unique_categories = Object.keys(frequencies).length;
                     const modeEntry = Object.entries(frequencies).sort(([,a],[,b]) => b-a)[0];
                     const mode = modeEntry ? modeEntry[0] : "N/A";
                    const freqArray = Object.entries(frequencies).map(([category, count]) => ({ category, count, percentage: (count / values.length) * 100 })).sort((a,b) => b.count - a.count);
                    categorical_summary.push({ variable: col, count: values.length, unique_categories, mode, frequencies: freqArray });
                    const MAX_BAR_CATEGORIES = 15;
                    const topFreq = freqArray.slice(0, MAX_BAR_CATEGORIES);
                    visualizations.push({ chart_type: "bar", variable: col, data: topFreq.reduce((obj, item) => { obj[item.category] = item.count; return obj; }, {}), title: `Frequency of Top ${topFreq.length} Categories in ${col}` + (freqArray.length > MAX_BAR_CATEGORIES ? ' (Truncated)' : '') });
                }
            });

            const summary = {
                rows: rows.length, columns: header.length, numerical_vars: numerical_summary.length, categorical_vars: categorical_summary.length,
                interpretation: `The dataset contains ${rows.length} records across ${header.length} variables (${numerical_summary.length} numerical, ${categorical_summary.length} categorical). Analysis summarizes central tendency, dispersion, and frequencies.`
            };

            // --- LLM Insights Generation ---
            analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6">...</div><h3 class="text-xl font-semibold text-white mb-4">Generating Accurate Business Insights...</h3><p class="text-white/80 mb-2">Applying strict checks to statistical interpretation...</p></div>`;

            let businessContext = "No additional business context provided.";
            if (contextFile) {
                 try { businessContext = await extractTextFromFile(contextFile); } catch(e) { console.warn("Could not read context file:", e.message); }
            }
            if (businessContext.length > 7000) { businessContext = businessContext.substring(0, 7000) + "... (truncated)"; }

            // Prepare summary for prompt
            const statsSummaryForPrompt = {
                overview: summary,
                numerical_highlights: numerical_summary.map(n => ({
                     variable: n.variable,
                     mean: n.mean?.toFixed(2),
                     median: n.median?.toFixed(2),
                     std_dev: n.std_dev?.toFixed(2),
                     min: n.min?.toFixed(2),
                     max: n.max?.toFixed(2)
                 })),
                categorical_highlights: categorical_summary.map(c => ({
                     variable: c.variable,
                     unique_categories: c.unique_categories,
                     mode: c.mode,
                     top_category_pct: (c.frequencies[0]?.percentage || 0).toFixed(1) + '%'
                 }))
            };

            // --- Prompt with Explicit Accuracy Constraints (kept from previous version) ---
            const prompt = `
                You are a meticulous senior data analyst presenting findings from a descriptive analysis. Accuracy is paramount. Use the provided statistics and business context to generate insightful recommendations.

                **BUSINESS CONTEXT:**
                """
                ${businessContext}
                """

                **CALCULATED STATISTICAL SUMMARY:**
                """
                ${JSON.stringify(statsSummaryForPrompt, null, 2)}
                """

                **TASK:**
                Generate **6 to 8** specific, actionable business insights. Each insight MUST be accurate and directly interpret the provided STATISTICAL SUMMARY within the BUSINESS CONTEXT.

                **For each insight:**
                1.  **Observation:** State the specific statistical finding *exactly* as calculated (e.g., "Mean for 'Age' (XX.X) is [correctly state: higher/lower] than Median (YY.Y)"). Verify all numerical comparisons. Do NOT use terms like 'dominance' or 'concentration' for numerical variable means/medians; use range, mean, median, std dev for interpretation.
                2.  **Accurate Interpretation:** Explain the practical meaning.
                    * **SKEWNESS RULE (Apply Strictly):**
                        * If Mean > Median: Interpret as potential **right-skewness** (tail to higher values, possible high outliers).
                        * If Mean < Median: Interpret as potential **left-skewness** (tail to lower values, possible low outliers).
                        * If Mean  Median: Interpret as roughly symmetric.
                    * **Variability:** High Std Dev relative to Mean implies high variability/inconsistency. Low Std Dev implies consistency.
                    * **Categorical Mode:** A high percentage for the mode indicates concentration in that category.
                3.  **Business Implication/Recommendation:** Connect the *accurate* interpretation to the BUSINESS CONTEXT. Suggest potential actions, investigations, or strategic points. **If a finding (e.g., 'Retail_Sales' stats) seems unrelated to the primary Business Context (e.g., an e-commerce description), explicitly note this potential mismatch** but still provide a recommendation based on the statistic itself.

                **CRITICAL REQUIREMENTS:**
                - **NUMERICAL ACCURACY:** All statements about numbers (e.g., comparisons) MUST be correct.
                - **CORRECT INTERPRETATION:** Skewness direction MUST follow the Mean vs. Median rule. Variability interpretation must be logical.
                - **Context Link:** Link insights to BUSINESS CONTEXT where possible, noting mismatches if necessary.
                - **Actionable:** Insights should lead to potential next steps.
                - **Synthesize:** Go beyond reporting numbers; explain *why* they matter.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object with a list of **6 to 8** insight objects:
                {
                  "business_insights": [
                    {
                      "observation": "Accurate observation statement...",
                      "interpretation": "Correct interpretation based on rules...",
                      "business_implication": "Recommendation linked to context (or noting mismatch)..."
                    },
                    // ... 6 to 8 insights total ...
                  ]
                }
            `;

            console.log(`Sending ACCURACY-FOCUSED Descriptive Insights prompt to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 }}) // Ensure num_ctx is appropriate
            });

            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const llmData = await response.json();

            let insightsData;
             try {
                 insightsData = JSON.parse(llmData.response);
                 if (!insightsData.business_insights || !Array.isArray(insightsData.business_insights) || (insightsData.business_insights.length > 0 && typeof insightsData.business_insights[0] !== 'object')) {
                     console.warn("Insights received but not in the expected object format. Attempting fallback.", insightsData.business_insights);
                     if (insightsData.business_insights && insightsData.business_insights.length > 0 && typeof insightsData.business_insights[0] === 'string') {
                          insightsData.business_insights = insightsData.business_insights.map(str => ({ observation: "General Insight", interpretation: str, business_implication: "Review manually." }));
                     } else { throw new Error("Insights format incorrect."); }
                 }
                 console.log(`Successfully parsed ${insightsData.business_insights.length} Insights (Accuracy Check) using ${MODEL_NAME}.`);
             } catch(e) {
                 console.error(`Failed to parse Insights JSON (Accuracy Check) using ${MODEL_NAME}:`, llmData.response, e);
                 insightsData = { business_insights: [{ observation: "Error", interpretation: "Could not generate insights.", business_implication: "Review stats manually." }] };
             }

            // --- Assemble Final Data Object ---
            const finalData = { summary, numerical_summary, categorical_summary, visualizations, business_insights: insightsData.business_insights || [] };

            renderDescriptivePage_DA(analysisResultContainer, finalData); // Use the existing (corrected) renderer

        } catch (error) {
            console.error(`Error during Descriptive Analysis (Accuracy Check) using ${MODEL_NAME}:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        }
    }

    async function handleParetoFishboneAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `
        <div class="text-center text-white/70 p-8">
            <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
            <h3 class="text-xl font-semibold text-white mb-4">Generating Detailed Pareto & Fishbone Analysis...</h3>
            <p class="text-white/80 mb-2">Identifying root causes, prioritizing impact, and suggesting actions...</p>
        </div>`; // Updated text
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = $("docUpload").checked;
        let problemContext = "";

        if (useDoc) {
            const file = $("paretoFile").files[0];
            if (!file) throw new Error("Please select a document (.txt, .docx) to upload.");
            problemContext = await extractTextFromFile(file);
        } else {
            problemContext = $("problemStatement").value.trim(); // Use ID from createParetoLayout
            if (!problemContext) throw new Error("Please enter a problem statement or description in the text area.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (problemContext.length > MAX_CONTEXT_LENGTH) {
            problemContext = problemContext.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`Pareto/Fishbone context truncated.`);
        }

        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are an expert quality management and process improvement consultant. Analyze the user's provided problem description using the Fishbone (Ishikawa) diagram and Pareto Principle (80/20 rule). Infer plausible causes and impacts based *only* on the context provided. ${truncatedNote}

            **USER'S PROBLEM DESCRIPTION:**
            \`\`\`
            ${problemContext}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Problem Statement:** Clearly define the central \`problem_statement\` being analyzed, derived from the context.
            2.  **Fishbone Analysis:** Identify potential root causes categorized under the 6 standard Ms. For each category (Methods, Machines, Materials, Manpower, Measurement, Environment), list 2-4 specific sub-causes (2-5 words each) *inferred solely from the problem description*. If context doesn't suggest causes for a category, return an empty array for it.
            3.  **Pareto Analysis:** Based *only* on the inferred sub-causes and the problem context:
                * Estimate a plausible relative \`impact_score\` (percentage, summing to 100) for each identified sub-cause, reflecting its likely contribution to the main problem statement based on the context.
                * Categorize these causes into:
                    * \`vital_few\`: The top ~20% of causes contributing to ~80% of the impact. Include cause name, estimated impact_score, and fishbone category.
                    * \`useful_many\`: The remaining causes. Include cause name, estimated impact_score, and fishbone category.
                * Provide an \`analysis_summary\` explaining how the vital few dominate the impact, according to the 80/20 principle, based on your estimations.
            4.  **Action Plan (Focus on Vital Few):** Generate an array of 2-3 structured actions targeting the identified \`vital_few\` causes. For each action:
                * \`target_cause\`: The specific vital few cause being addressed.
                * \`action_suggestion\`: A concrete, actionable step to mitigate this cause (e.g., "Implement standardized training", "Upgrade specific software module").
                * \`rationale\`: Explain *how* this action addresses the target cause, referencing the problem context if possible.
                * \`potential_impact\`: Estimate the potential impact on the main problem (High, Medium, Low).
            5.  **Self-Correction:** Before outputting JSON, rigorously check: Is the problem statement accurate? Are all fishbone sub-causes derived *only* from the text? Are impact scores plausible estimations based on context? Does the Pareto categorization correctly reflect the 80/20 split based on *your estimated scores*? Does the action plan focus *only* on the vital few? Is the JSON structure perfect? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT GROUNDING:** All analysis (problem, causes, impacts, actions) MUST be based *exclusively* on the USER'S PROBLEM DESCRIPTION. Do NOT invent information.
            - **PLAUSIBLE ESTIMATION:** Impact scores are estimations based on context, not precise calculations, but should be logical and sum to 100.
            - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys and sub-keys. Use standard 6M fishbone categories.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
            {
              "problem_statement": "e.g., Low Customer Satisfaction Scores",
              "fishbone": {
                "Methods": ["Sub-cause inferred from text 1", "Sub-cause inferred from text 2"],
                "Machines": ["Sub-cause inferred from text 3"],
                "Materials": [], // Example if no context
                "Manpower": ["Sub-cause inferred from text 4", "Sub-cause inferred from text 5"],
                "Measurement": ["Sub-cause inferred from text 6"],
                "Environment": ["Sub-cause inferred from text 7"]
              },
              "pareto_analysis": {
                "vital_few": [ // Top ~20% causes, ~80% impact based on estimations
                  {"cause": "Sub-cause inferred from text 4", "impact_score": 45, "category": "Manpower"},
                  {"cause": "Sub-cause inferred from text 1", "impact_score": 30, "category": "Methods"}
                ],
                "useful_many": [ // Remaining causes
                  {"cause": "Sub-cause inferred from text 6", "impact_score": 10, "category": "Measurement"},
                  {"cause": "Sub-cause inferred from text 3", "impact_score": 8, "category": "Machines"},
                  {"cause": "Sub-cause inferred from text 2", "impact_score": 5, "category": "Methods"},
                  {"cause": "Sub-cause inferred from text 5", "impact_score": 1, "category": "Manpower"},
                  {"cause": "Sub-cause inferred from text 7", "impact_score": 1, "category": "Environment"}
                ],
                "analysis_summary": "Explanation of 80/20 finding based on estimations (e.g., 'The analysis suggests that 'Sub-cause 4' and 'Sub-cause 1' collectively account for an estimated 75% of the impact...')"
              },
              "action_plan": [ // Actions targeting ONLY vital_few
                {
                  "target_cause": "Sub-cause inferred from text 4",
                  "action_suggestion": "e.g., Develop targeted training program",
                  "rationale": "Addresses the primary driver identified (Manpower issue mentioned in context) by...",
                  "potential_impact": "High"
                },
                {
                  "target_cause": "Sub-cause inferred from text 1",
                  "action_suggestion": "e.g., Standardize process documentation",
                  "rationale": "Tackles the second major contributor (Methods issue described as...) by...",
                  "potential_impact": "High"
                }
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED Pareto/Fishbone prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (Pareto/Fishbone):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Pareto/Fishbone) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !parsedData.problem_statement || typeof parsedData.problem_statement !== 'string' ||
                 !parsedData.fishbone || typeof parsedData.fishbone !== 'object' || !parsedData.fishbone.Methods || // Check one standard category
                 !parsedData.pareto_analysis || typeof parsedData.pareto_analysis !== 'object' ||
                 !Array.isArray(parsedData.pareto_analysis.vital_few) || !Array.isArray(parsedData.pareto_analysis.useful_many) || !parsedData.pareto_analysis.analysis_summary ||
                 !Array.isArray(parsedData.action_plan) || // Action plan is required, even if empty based on vital_few
                 // Check structure of first elements if they exist
                 (parsedData.pareto_analysis.vital_few.length > 0 && (typeof parsedData.pareto_analysis.vital_few[0] !== 'object' || !parsedData.pareto_analysis.vital_few[0].hasOwnProperty('cause') || !parsedData.pareto_analysis.vital_few[0].hasOwnProperty('impact_score'))) ||
                 (parsedData.action_plan.length > 0 && (typeof parsedData.action_plan[0] !== 'object' || !parsedData.action_plan[0].hasOwnProperty('target_cause') || !parsedData.action_plan[0].hasOwnProperty('rationale')))
                )
             {
                  console.error("Validation Failed (Enhanced Pareto/Fishbone): Required fields missing or invalid structure.", parsedData);
                  throw new Error(`AI response structure is incorrect or inconsistent (Enhanced Pareto/Fishbone). Check problem, fishbone, pareto (vital/useful/summary), and action_plan. See console logs.`);
             }
             // Simple check on impact scores summing roughly to 100
             const totalScore = [...parsedData.pareto_analysis.vital_few, ...parsedData.pareto_analysis.useful_many].reduce((sum, item) => sum + (item.impact_score || 0), 0);
             if (Math.abs(totalScore - 100) > 5) { // Allow some tolerance
                 console.warn(`Pareto impact scores sum to ${totalScore}, not 100.`);
                 // Don't throw error, but log it. AI might struggle with perfect sums.
             }

             console.log(`Successfully parsed ENHANCED Pareto/Fishbone JSON using ${MODEL_NAME}. Problem: ${parsedData.problem_statement}.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED Pareto/Fishbone JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced Pareto/Fishbone): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results using a new dedicated function
        renderParetoFishbonePage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleParetoFishboneAnalysis (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderParetoFishbonePage(container, data) {
    container.innerHTML = ""; // Clear loading
    // Basic validation
    if (!data || !data.problem_statement || !data.fishbone || !data.pareto_analysis || !data.action_plan) {
        console.error("Incomplete data passed to renderParetoFishbonePage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Pareto/Fishbone results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    const { problem_statement, fishbone, pareto_analysis, action_plan } = data;

    // --- Create Tab Navigation ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="pareto"> Pareto Chart & Summary</button>
        <button class="analysis-tab-btn" data-tab="fishbone"> Fishbone Diagram</button>
        <button class="analysis-tab-btn" data-tab="action"> Action Plan (Vital Few)</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Techniques</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="paretoPanel" class="analysis-tab-panel active"></div>
        <div id="fishbonePanel" class="analysis-tab-panel"></div>
        <div id="actionPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Pareto Chart & Summary Tab ---
    const paretoPanel = $("paretoPanel");
    paretoPanel.innerHTML = `<div class="p-4">
        <h3 class="text-2xl font-bold mb-4 text-center">Pareto Analysis (80/20 Rule)</h3>
         <p class="text-center text-lg italic text-white/80 mb-6">Problem: ${problem_statement}</p>
        <div id="paretoChartContainer" class="w-full h-[550px] plotly-chart bg-black/10 rounded-lg mb-8"></div>
        <h4 class="text-xl font-semibold mb-3">Analysis Summary:</h4>
        <blockquote class="p-3 italic border-l-4 border-gray-500 bg-black/20 text-white/90 text-sm">
            ${pareto_analysis.analysis_summary || "Summary unavailable."}
        </blockquote>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 text-sm">
             <div class="bg-red-900/20 p-3 rounded border border-red-500/50">
                <h5 class="font-bold text-red-300 mb-1"> Vital Few (${pareto_analysis.vital_few.length} causes)</h5>
                <p class="text-xs text-white/70 mb-2">Focus improvement efforts here (~80% of impact).</p>
                <ul class="list-disc list-inside space-y-1">
                    ${pareto_analysis.vital_few.map(item => `<li>${item.cause} (${item.impact_score}%)</li>`).join("")}
                </ul>
             </div>
             <div class="bg-gray-700/20 p-3 rounded border border-gray-500/50">
                 <h5 class="font-bold text-gray-300 mb-1"> Useful Many (${pareto_analysis.useful_many.length} causes)</h5>
                 <p class="text-xs text-white/70 mb-2">Address later or if resources allow (~20% of impact).</p>
                 <ul class="list-disc list-inside space-y-1">
                     ${pareto_analysis.useful_many.map(item => `<li>${item.cause} (${item.impact_score}%)</li>`).join("")}
                 </ul>
             </div>
         </div>
    </div>`;
    // Render the Pareto chart
    try {
        createParetoChartJS(pareto_analysis, "paretoChartContainer"); // Use the existing chart function
    } catch(e) {
        console.error("Error rendering Pareto chart:", e);
        $("paretoChartContainer").innerHTML = "<p class='p-4 text-center text-red-400'>Could not render Pareto chart.</p>";
    }

    // --- 2. Populate Fishbone Diagram Tab (Textual) ---
    const fishbonePanel = $("fishbonePanel");
    let fishboneHtml = `<div class="p-4">
        <h3 class="text-2xl font-bold mb-4 text-center">Fishbone Diagram (Ishikawa) - Potential Causes</h3>
        <p class="text-center text-lg italic text-white/80 mb-6">Problem: ${problem_statement}</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

    const standardCategories = ["Methods", "Machines", "Materials", "Manpower", "Measurement", "Environment"];
    standardCategories.forEach(category => {
        const subCauses = fishbone[category] || [];
        // Highlight vital few causes within the fishbone list
        const causesHtml = subCauses.map(cause => {
            const isVital = pareto_analysis.vital_few.some(item => item.cause.toLowerCase() === cause.toLowerCase());
            return `<li class="${isVital ? 'font-semibold text-red-300' : 'text-white/80'}">${isVital ? ' ' : ''}${cause}</li>`;
        }).join("");

        fishboneHtml += `
            <div class="bg-white/5 p-3 rounded-lg border-t-4 border-indigo-400">
                <h4 class="font-semibold text-lg mb-2 text-indigo-300">${category}</h4>
                ${subCauses.length > 0
                    ? `<ul class="list-disc list-inside space-y-1 text-sm">${causesHtml}</ul>`
                    : `<p class="text-sm italic text-white/60">(No specific causes identified from context)</p>`
                }
            </div>`;
    });

    fishboneHtml += `</div></div>`; // Close grid and p-4
    fishbonePanel.innerHTML = fishboneHtml;


    // --- 3. Populate Action Plan Tab ---
    const actionPanel = $("actionPanel");
    let actionHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Action Plan (Focus on Vital Few)</h3>`;
    if (action_plan && action_plan.length > 0) {
        actionHtml += `<p class="text-sm text-white/70 mb-6 italic">Concentrate resources on addressing these high-impact causes identified in the Pareto analysis.</p>`;
        actionHtml += `<div class="space-y-6">`;
        action_plan.forEach((action, index) => {
             let impactClass = "text-yellow-400"; // Medium default
             if (action.potential_impact?.toLowerCase() === 'high') impactClass = "text-green-400";
             else if (action.potential_impact?.toLowerCase() === 'low') impactClass = "text-red-400";

            actionHtml += `
                <div class="prescription-card border-l-4 border-yellow-500">
                    <h4 class="text-xl font-bold">${index + 1}. ${action.action_suggestion}</h4>
                     <p class="text-xs font-semibold my-1 text-indigo-300">TARGET CAUSE: ${action.target_cause || 'N/A'}</p>
                     <p class="text-xs font-semibold my-1 ${impactClass}">POTENTIAL IMPACT: ${action.potential_impact || 'N/A'}</p>
                    <p class="rationale"><strong>Rationale:</strong> ${action.rationale || 'N/A'}</p>
                </div>`;
        });
        actionHtml += `</div>`;
    } else {
        actionHtml += `<p class="text-center text-white/70 italic">No specific actions were generated for the 'vital few' causes, possibly because none were identified or derivable from the context.</p>`;
    }
    actionHtml += `</div>`;
    actionPanel.innerHTML = actionHtml;

    // --- 4. Populate Learn Techniques Tab ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Pareto & Fishbone Analysis</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-lg font-bold mb-2 text-indigo-300"> Pareto Principle (80/20 Rule)</h4>
                 [Image of Pareto chart example]
                <p class="text-sm text-white/80 mb-3">States that for many outcomes, roughly 80% of consequences come from 20% of causes. In quality improvement, it helps identify the "vital few" causes that have the most significant impact on a problem, distinguishing them from the "useful many."</p>
                <h5 class="text-md font-semibold mb-1">How it's Used Here:</h5>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li>Identifies potential causes from the Fishbone analysis.</li>
                    <li>Estimates the relative impact of each cause on the main problem.</li>
                    <li>Sorts causes by impact score.</li>
                    <li>Calculates cumulative impact percentage.</li>
                    <li>Visually separates the "vital few" (first ~80% cumulative impact) from the "useful many".</li>
                    <li>Directs action planning towards the vital few for maximum efficiency.</li>
                </ul>
            </div>

            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-lg font-bold mb-2 text-indigo-300"> Fishbone Diagram (Ishikawa / Cause-and-Effect)</h4>
                [Image of Fishbone diagram example]
                <p class="text-sm text-white/80 mb-3">A visualization tool used to brainstorm and categorize potential causes of a specific problem (the "effect"). Causes are grouped into major categories to ensure a structured and comprehensive analysis.</p>
                <h5 class="text-md font-semibold mb-1">Standard Categories (6Ms):</h5>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Methods:</strong> Policies, procedures, rules, regulations, laws.</li>
                    <li><strong>Machines:</strong> Equipment, tools, technology used.</li>
                    <li><strong>Materials:</strong> Raw materials, consumables, information.</li>
                    <li><strong>Manpower (People):</strong> Anyone involved in the process; skills, training, motivation.</li>
                    <li><strong>Measurement:</strong> Data generated from the process used for evaluation.</li>
                    <li><strong>Environment (Mother Nature):</strong> Location, time, temperature, workplace culture.</li>
                </ul>
                <p class="text-xs italic mt-2">Note: Categories can sometimes be adapted based on the industry (e.g., 4S for Service).</p>
            </div>
        </div>

         <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
            <h4 class="text-lg font-bold mb-2"> How They Work Together:</h4>
            <p class="text-sm text-white/80">The Fishbone diagram helps brainstorm a wide range of potential causes. The Pareto analysis then helps prioritize which of those causes are likely contributing the most to the problem, allowing teams to focus their improvement efforts effectively.</p>
        </div>
    </div>
    `;

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // Resize chart if the Pareto tab is activated
                const chart = targetPanel.querySelector('.plotly-chart');
                if (chart && chart.layout && typeof Plotly !== 'undefined') {
                    try { Plotly.Plots.resize(chart); } catch (err) { console.error("Resize err:", err); }
                }
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Attempt initial resize for chart in the default active tab (Pareto)
     setTimeout(() => {
         const initialChart = $('paretoChartContainer');
         if (initialChart && initialChart.layout && typeof Plotly !== 'undefined') {
             try { Plotly.Plots.resize(initialChart); } catch (err) { console.error("Initial Resize err:", err); }
         }
     }, 150);


    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}


// Ensure createParetoChartJS is available (it was defined in a previous step, but include it here for completeness if needed)
function createParetoChartJS(paretoData, containerId) {
    const container = $(containerId);
    if (!container) {
        console.error(`Container with ID ${containerId} not found for Pareto chart.`);
        return;
    }
    container.innerHTML = ""; // Clear previous chart

    // Ensure paretoData exists and has the expected structure
    if (!paretoData || (!paretoData.vital_few && !paretoData.useful_many)) {
         container.innerHTML = "<p class='p-4 text-center text-red-400'>Pareto data is missing or incomplete.</p>";
         return;
    }

    const allCauses = (paretoData.vital_few || []).concat(paretoData.useful_many || []);
    if (allCauses.length === 0) {
         container.innerHTML = "<p class='p-4 text-center text-white/70'>No causes identified for Pareto analysis.</p>";
        return;
    }


    allCauses.sort((a, b) => (b.impact_score || 0) - (a.impact_score || 0));

    const causes = allCauses.map((item) => item.cause || "Unknown Cause");
    const impacts = allCauses.map((item) => item.impact_score || 0);
    const categories = allCauses.map((item) => item.category || "Uncategorized");

    const cumulative = impacts.reduce((acc, val) => {
        acc.push((acc.length > 0 ? acc[acc.length - 1] : 0) + val);
        return acc;
    }, []);
    // Ensure totalImpact is not zero before dividing
    const totalImpact = impacts.reduce((a, b) => a + b, 0);
    const cumulativePct = totalImpact > 0 ? cumulative.map((val) => (val / totalImpact) * 100) : cumulative.map(() => 0);


    const trace1 = {
        x: causes,
        y: impacts,
        name: "Impact Score",
        type: "bar",
        text: impacts.map((imp) => `${imp}%`),
        textposition: "outside",
        marker: { color: "var(--primary)" }, // Consistent color
        hovertemplate: "<b>%{x}</b><br>Impact: %{y}%<br>Category: %{customdata}<extra></extra>",
        customdata: categories
    };

    const trace2 = {
        x: causes,
        y: cumulativePct,
        name: "Cumulative %",
        type: "scatter",
        mode: "lines+markers",
        line: { color: "var(--accent)", width: 3 }, // Accent color for line
        marker: { size: 8 },
        yaxis: "y2",
        hovertemplate: "<b>%{x}</b><br>Cumulative: %{y:.1f}%<extra></extra>"
    };

    // Find the index where cumulative percentage crosses 80%
     const eightyPercentIndex = cumulativePct.findIndex(p => p >= 80);
     let vitalFewCount = eightyPercentIndex !== -1 ? eightyPercentIndex + 1 : allCauses.length;
     // Ensure vitalFewCount matches the actual vital_few array length if provided, otherwise use calculated
     vitalFewCount = paretoData.vital_few ? paretoData.vital_few.length : vitalFewCount;


    const layout = {
        title: "Pareto Analysis - Vital Few vs. Useful Many Causes",
        xaxis: { title: "Potential Root Causes", tickangle: -45, automargin: true },
        yaxis: { title: "Estimated Impact Score (%)", gridcolor: "rgba(255,255,255,0.1)" },
        yaxis2: {
            title: "Cumulative Impact (%)",
            overlaying: "y",
            side: "right",
            range: [0, 101],
            gridcolor: "rgba(255,255,255,0.05)",
            zeroline: false
        },
        shapes: [
            // 80% cumulative line
            { type: "line", xref: "paper", x0: 0, x1: 1, yref: "y2", y0: 80, y1: 80, line: { color: "orange", width: 2, dash: "dot" } },
            // Vertical line separating vital few
             vitalFewCount > 0 && vitalFewCount < allCauses.length ? { type: "line", xref: "x", x0: vitalFewCount - 0.5, x1: vitalFewCount - 0.5, yref: "paper", y0: 0, y1: 1, line: { color: "rgba(255, 0, 0, 0.5)", width: 2, dash: "dash" } } : {}
        ],
         annotations: [
             vitalFewCount > 0 ? { xref: 'x', yref: 'paper', x: (vitalFewCount - 1) / 2, y: 1.05, text: ' Vital Few', showarrow: false, font: {color: 'red'} } : {},
             vitalFewCount < allCauses.length ? { xref: 'x', yref: 'paper', x: vitalFewCount + (allCauses.length - vitalFewCount -1) / 2, y: 1.05, text: ' Useful Many', showarrow: false, font: {color: 'grey'} } : {},
              { xref: 'paper', yref: 'y2', x: 0.95, y: 80, text: '80% Impact', showarrow: false, font: {color: 'orange'}, xanchor: 'right', yanchor: 'bottom' }
         ],
        showlegend: true,
        height: 550, // Increased height slightly
        hovermode: "x unified",
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        font: { color: "white" },
        legend: { orientation: "h", y: -0.3 }, // Adjusted legend position
        margin: { t: 60, b: 150, l: 60, r: 60 } // Adjusted margins
    };

    Plotly.newPlot(containerId, [trace1, trace2], layout, { responsive: true });
}


    function createParetoChartJS(paretoData, containerId) {
        const allCauses = (paretoData.vital_few || []).concat(paretoData.useful_many || []);
        if (allCauses.length === 0) return;

        allCauses.sort((a, b) => b.impact_score - a.impact_score);

        const causes = allCauses.map((item) => item.cause);
        const impacts = allCauses.map((item) => item.impact_score);
        const categories = allCauses.map((item) => item.category);

        const cumulative = impacts.reduce((acc, val) => {
            acc.push((acc.length > 0 ? acc[acc.length - 1] : 0) + val);
            return acc;
        }, []);
        const totalImpact = impacts.reduce((a, b) => a + b, 0);
        const cumulativePct = cumulative.map((val) => (val / totalImpact) * 100);

        const trace1 = {
            x: causes,
            y: impacts,
            name: "Impact Score",
            type: "bar",
            text: impacts.map((imp) => `${imp}%`),
            textposition: "outside",
            marker: { color: "var(--primary)" },
            hovertemplate: "<b>%{x}</b><br>Impact: %{y}%<br>Category: %{customdata}<extra></extra>",
            customdata: categories
        };

        const trace2 = {
            x: causes,
            y: cumulativePct,
            name: "Cumulative %",
            type: "scatter",
            mode: "lines+markers",
            line: { color: "var(--accent)", width: 3 },
            marker: { size: 8 },
            yaxis: "y2",
            hovertemplate: "<b>%{x}</b><br>Cumulative: %{y:.1f}%<extra></extra>"
        };

        const layout = {
            title: "Pareto Analysis - 80/20 Root Cause Impact",
            xaxis: { title: "Root Causes", tickangle: -45, automargin: true },
            yaxis: { title: "Impact Score (%)" },
            yaxis2: {
                title: "Cumulative Impact (%)",
                overlaying: "y",
                side: "right",
                range: [0, 101]
            },
            shapes: [
                {
                    type: "line",
                    xref: "paper",
                    x0: 0,
                    x1: 1,
                    yref: "y2",
                    y0: 80,
                    y1: 80,
                    line: { color: "orange", width: 2, dash: "dash" }
                }
            ],
            showlegend: true,
            height: 500,
            hovermode: "x unified",
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(0,0,0,0)",
            font: { color: document.body.classList.contains("light-theme") ? "#1a202c" : "white" }
        };

        Plotly.newPlot(containerId, [trace1, trace2], layout, { responsive: true });
    }

    // =========================================================================
    // ===== SPECIALIZED ANALYSIS LOGIC (SWOT, ARCHETYPE, FACTOR, etc.)   =====
    // =========================================================================


    async function handleNovelGoalsAnalysis_NS() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Mapping Horizons of Growth...</h3><p class="text-white/80 mb-2">Analyzing your ambition using a refined, context-aware prompt...</p></div>`;
        setLoading("generate", true);

        const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Using Llama 3.1 as requested

        try {
            const useDoc = $("docUpload").checked;
            let ambitionText = "";

            if (useDoc) {
                const file = $("novelGoalsFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                ambitionText = await extractTextFromFile(file);
            } else {
                ambitionText = $("novelGoalsContent").value.trim();
                if (!ambitionText) {
                    throw new Error("Please describe your ambition or goal in the text area.");
                }
            }

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            if (ambitionText.length > MAX_CONTEXT_LENGTH) {
                console.warn(`Ambition text truncated to ${MAX_CONTEXT_LENGTH} characters.`);
                ambitionText = ambitionText.substring(0, MAX_CONTEXT_LENGTH);
            }

            // --- Refined Prompt with Stricter Grounding ---
            const prompt = `
                You are an expert corporate strategist specializing in McKinsey's "Three Horizons of Growth" framework. Your task is to analyze the user's provided text and develop a structured strategic plan *strictly grounded* in that text.

                **USER'S PROVIDED CONTEXT:**
                """
                ${ambitionText}
                """

                **TASK:**
                Formulate a Three Horizons plan derived *exclusively* from the details within the USER'S PROVIDED CONTEXT.

                1.  **main_goal**: First, identify the primary goal explicitly stated or strongly implied in the context. Refine this into a single, clear, measurable goal statement (under 25 words) that accurately reflects the context's focus (e.g., if the context is about research, the goal should relate to using research findings).

                2.  **horizons**: Create an array containing exactly three objects, one for each horizon (H1, H2, H3). For each horizon, define initiatives *only if they directly address the main_goal and are supported by specific details in the USER'S PROVIDED CONTEXT*.

                    * **Horizon 1 (Core - ~0-18 Months):** Focus on optimizing or improving the *current business* described in the context. Initiatives MUST relate to elements explicitly mentioned (e.g., improving listed service quality dimensions).
                    * **Horizon 2 (Adjacent - ~12-36 Months):** Focus on leveraging insights or capabilities *mentioned in the context* to build logically adjacent growth related to the main_goal (e.g., using research findings on satisfaction drivers to propose a loyalty program *if loyalty programs are implied or discussed*).
                    * **Horizon 3 (Transformational - ~3-7+ Years):** Focus on exploring future options *suggested by the context* (e.g., researching long-term implications mentioned in the text).

                    For *each* horizon object, provide:
                    * \`horizon_name\`: (e.g., "Horizon 1: Optimize Core CX Research").
                    * \`timeframe\`: (e.g., "0-18 Months").
                    * \`focus\`: A one-sentence description of this horizon's focus *directly tied to the main_goal and the context provided*.
                    * \`initiatives\`: An array of 1-3 specific initiatives. **CRITICAL:** If no initiatives for a specific horizon can be reasonably derived *solely from the provided context* to support the main goal, return an empty array [] for that horizon's \`initiatives\`. For each valid initiative:
                        * \`initiative_name\`: Clear name (under 10 words).
                        * \`description\`: Brief explanation *linking it directly to specific details in the context* and explaining how it supports the horizon's focus.
                        * \`kpis\`: 2-3 specific, measurable KPIs relevant to the initiative and context.

                **ABSOLUTE CONSTRAINTS (VERY IMPORTANT):**
                - **NO FABRICATION:** Do NOT invent initiatives, goals, or focus areas that are not explicitly stated or logically derived from the USER'S PROVIDED CONTEXT.
                - **CONTEXT IS KING:** Your entire response must be based *only* on the text provided in the "USER'S PROVIDED CONTEXT" section.
                - **AVOID GENERIC STRATEGIES:** Do NOT suggest common business strategies (like 'omnichannel expansion', 'subscription models', 'AI implementation', 'sustainability drives', 'new market entry') UNLESS these concepts are *specifically mentioned* or *directly implied as goals* within the user's text. Focus only on what the text provides.
                - **RESEARCH CONTEXT AWARENESS:** If the context is about a research plan (like the example text), the goal and initiatives should relate to executing that research or acting on its *hypothesized* findings, not on unrelated business expansion.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object with the exact structure specified below. Ensure all fields are filled according to the constraints above. Return empty arrays [] for initiatives if none are derivable from the context for a given horizon.
                {
                  "main_goal": "Refined goal statement strictly derived from user context.",
                  "horizons": [
                    { // Horizon 1
                      "horizon_name": "Horizon 1: ...", "timeframe": "0-18 Months", "focus": "...",
                      "initiatives": [ /* Initiatives derived ONLY from context or empty [] */ ]
                    },
                    { // Horizon 2
                      "horizon_name": "Horizon 2: ...", "timeframe": "12-36 Months", "focus": "...",
                      "initiatives": [ /* Initiatives derived ONLY from context or empty [] */ ]
                    },
                    { // Horizon 3
                      "horizon_name": "Horizon 3: ...", "timeframe": "3-7+ Years", "focus": "...",
                      "initiatives": [ /* Initiatives derived ONLY from context or empty [] */ ]
                    }
                  ]
                }
            `;

            console.log("Sending STRICTLY GROUNDED Three Horizons prompt to Llama 3.1...");
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: { num_ctx: 32768 }
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
            const data = await response.json();

            let parsedData;
            try {
                 parsedData = JSON.parse(data.response);
                 console.log("Successfully parsed STRICT Three Horizons JSON response from Llama 3.1.");
            } catch (e) {
                console.error("Failed to parse STRICT Three Horizons JSON response:", data.response, e);
                throw new Error("Invalid JSON received from AI. The AI may have failed to follow the strict formatting or grounding constraints. Please try again or refine the input text.");
            }

            // Validate structure minimally
            if (!parsedData.main_goal || !parsedData.horizons || !Array.isArray(parsedData.horizons) || parsedData.horizons.length !== 3) {
                console.error("Parsed JSON structure is invalid:", parsedData);
                throw new Error("AI response did not follow the required Three Horizons structure despite instructions.");
            }

            renderNovelGoalsPage_NS(analysisResultContainer, parsedData); // Pass to the renderer

        } catch (error) {
            console.error("Error during Novel Goals analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        }
    }

    function parseCSV(csvText) {
        const lines = csvText.trim().split("\n");
        const header = lines[0].split(",").map((h) => h.trim());
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(",").map((v) => v.trim());
            if (values.length === header.length) {
                const row = {};
                for (let j = 0; j < header.length; j++) {
                    const value = values[j];
                    // Attempt to convert to number if possible
                    const numValue = parseFloat(value);
                    row[header[j]] = isNaN(numValue) ? value : numValue;
                }
                rows.push(row);
            }
        }
        return { header, rows };
    }

    
   

    async function handleArchetypeAnalysis() {
        const analysisResultContainer = $("analysisResult");

        analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Performing System Thinking Analysis</h3>
                        <p class="text-white/80 mb-2">This multi-step process may take several minutes.</p>
                        <p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p>
                    </div>`;

        const statusEl = $("analysisStatus");
        const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";

        try {
            statusEl.textContent = "Reading and processing your document...";
            const useDoc = $("docUpload").checked;
            let text = "";

            if (useDoc) {
                const file = $("archetypeFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                text = await extractTextFromFile(file);
            } else {
                text = $("archetypeContent").value;
                if (!text.trim()) throw new Error("Please enter system information in the text area.");
            }
            if (!text) throw new Error("Could not get text from the document or text area.");

            if (text.length > 3000) text = text.substring(0, 3000);

            async function generateOllamaResponse(prompt) {
                const response = await fetch(OLLAMA_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        prompt: prompt,
                        stream: false,
                        format: "json",
                        options: { num_ctx: 32768 }
                    })
                });
                if (!response.ok) throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                const data = await response.json();
                return JSON.parse(data.response); // Expecting valid JSON now
            }

            // Step 1: Extract Concepts
            statusEl.textContent = "Step 1/3: Extracting key system concepts...";
            const conceptPrompt = `
                        Analyze the following text and extract key 2-4 word concepts. For each concept, provide:
                        1. name (2-4 words)
                        2. description (brief)
                        3. effect ("+", "-", or "0")
                        4. influence ("High", "Medium", or "Low")
                        Text: ${text}
                        Return ONLY a valid JSON object with the structure: {"concepts": [{"name": "...", "description": "...", "effect": "...", "influence": "..."}]}`;
            const conceptData = await generateOllamaResponse(conceptPrompt);
            const concepts = conceptData.concepts;
            if (!concepts || concepts.length === 0) throw new Error("No concepts were extracted from the document.");

            // Step 2: Identify Archetypes
            statusEl.textContent = "Step 2/3: Identifying relevant system archetypes...";
            const conceptText = concepts.map((c) => c.name).join(", ");
            const archetypePrompt = `
                        You are a system thinking expert. Analyze the provided text and the key concepts extracted from it to identify the single most fitting system archetype.

                        **System Description/Text:**
                        ${text}

                        **Key Concepts:**
                        [${conceptText}]

                        **Task:**
                        From the list of common archetypes below, select the ONE that best explains the dynamics described in the text.
                        - **Success to the Successful:** One entity gets more resources, which it uses to perform better and get even more resources, starving competitors.
                        - **Limits to Growth:** A reinforcing process of growth eventually meets a balancing process that slows or stops the growth.
                        - **Shifting the Burden:** A short-term solution is used to correct a problem, but it undermines the ability of the system to use a more fundamental, long-term solution.
                        - **Tragedy of the Commons:** Individuals use a shared resource in their own self-interest, leading to its depletion.
                        - **Fixes that Fail:** A fix is applied to a problem that has immediate positive results but unforeseen long-term negative consequences.

                        **Analysis & Response:**
                        Based on the text and concepts, provide a JSON response with the following structure. The description MUST explain *why* the chosen archetype fits the specific situation described in the text.

                        Return ONLY a valid JSON object:
                        {
                          "archetypes": [{
                            "name": "Name of the chosen archetype (e.g., Success to the Successful)",
                            "relevance_score": 10,
                            "description": "A detailed explanation of how the dynamics in the provided text perfectly match the chosen archetype. Reference the key concepts.",
                            "leverage_points": ["Specific leverage point 1", "Specific leverage point 2"],
                            "interventions": ["Specific intervention 1", "Specific intervention 2"]
                          }]
                        }`;
            const archetypeData = await generateOllamaResponse(archetypePrompt);
            let archetypes = archetypeData.archetypes;

            archetypes.sort((a, b) => (b.relevance_score || 0) - (a.relevance_score || 0));
            const topArchetypeCount = Math.max(1, Math.floor(archetypes.length * 0.2));
            const topArchetypes = archetypes.slice(0, topArchetypeCount);

            // --- MODIFICATION START ---
            // Step 3: Analyze Leverage Points with enhanced context-aware prompt
            statusEl.textContent = "Step 3/3: Analyzing high-impact leverage points...";
            const leveragePrompt = `
                        You are a systems thinking strategist. Your task is to identify the most effective leverage point to overcome the central problem described in the provided text.

                        **Context:**
                        The text describes a 'Limits to Growth' situation. The company's growth, driven by its "Direct-to-Consumer Model," has hit a limit, causing sales stagnation.
                        The **primary strategic goal** is to break this limit by diversifying sales channels and entering physical retail stores.

                        **Key Concepts Extracted from the Text:**
                        [${conceptText}]

                        **Task:**
                        From the list of key concepts, identify the single concept that represents the **most powerful solution or intervention** to achieve the strategic goal of successful retail expansion.

                        **CRITICAL INSTRUCTION:** Do NOT select a concept that represents the problem (e.g., 'Direct-to-Consumer Model', 'Scalability and Growth Limitations'). You must select the concept that represents the **SOLUTION**.

                        Provide your response as a valid JSON object with the following structure:
                        {
                          "leverage_points": [{
                            "concept": "The name of the concept that is the best leverage point",
                            "score": 10,
                            "reasoning": "Explain WHY this concept is the key to overcoming the DTC limitation and achieving the retail expansion goal, based on the text.",
                            "actions": ["Action 1 related to the solution", "Action 2 related to the solution", "Action 3 related to the solution"],
                            "impact": "High"
                          }]
                        }`;
            // --- MODIFICATION END ---
            const leverageData = await generateOllamaResponse(leveragePrompt);
            let leveragePoints = leverageData.leverage_points;

            leveragePoints.sort((a, b) => (b.score || 0) - (a.score || 0));
            const topLeverageCount = Math.max(1, Math.floor(leveragePoints.length * 0.2));
            const topLeveragePoints = leveragePoints.slice(0, topLeverageCount);

            // Final step: Render the full page
            statusEl.textContent = "Analysis complete! Rendering results...";
            renderArchetypeAnalysisPage(analysisResultContainer, {
                concepts,
                topArchetypes,
                topLeveragePoints
            });
        } catch (error) {
            console.error("Error during Archetype analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}<br><br><span class="text-sm text-white/60">Please ensure your Ollama server is running and accessible at ${OLLAMA_URL}.</span></div>`;
        } finally {
            setLoading("generate", false);
        }
    }

    

    async function handleProcessMappingAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white">Mapping and Analyzing Your Process...</h3><p class="text-white/80 mb-2">Identifying steps, bottlenecks, and potential optimizations...</p></div>`; // Updated text
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = document.querySelector('input[name="inputType"]:checked').id === "docUpload";
        let content = "";
        if (useDoc) {
            const file = $("processFile").files[0];
            if (!file) throw new Error("Please select a document.");
            content = await extractTextFromFile(file);
        } else {
            content = $("processContent").value.trim();
            if (!content) throw new Error("Please describe the process.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (content.length > MAX_CONTEXT_LENGTH) {
            content = content.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`Process Mapping context truncated.`);
        }

        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are an expert business process analyst. Analyze the following process description provided by the user and model it comprehensively. Focus on identifying bottlenecks and suggesting concrete optimizations based *only* on the provided text. ${truncatedNote}

            **USER'S PROCESS DESCRIPTION:**
            \`\`\`
            ${content}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Process Definition:** Define a clear \`process_name\` based on the description.
            2.  **Identify Steps (8-12 steps):** Extract the sequential steps. For each step, provide:
                * \`id\`: A unique sequential number (1, 2, 3...).
                * \`name\`: A concise action-oriented name (2-5 words).
                * \`description\`: A brief explanation of the step based on the context.
                * \`owner\`: The role or department responsible, as mentioned or implied in the context.
                * \`type\`: Classify as "Start", "Task", "Decision", "End", or "Sub-process" based on context.
            3.  **Define Connections:** Specify the flow between steps. For each connection:
                * \`from\`: The ID of the source step.
                * \`to\`: The ID of the target step.
                * \`label\`: The condition or transition (e.g., "Next", "Yes", "No", "Approved", "Rejected"), inferred from context.
            4.  **Identify Bottlenecks (2-3 bottlenecks):** Pinpoint specific steps or transitions that appear inefficient, slow, or problematic based *only* on the description. For each bottleneck:
                * \`step_name\`: The name of the bottleneck step (or transition description like "Handover from Sales to Ops").
                * \`reason\`: A detailed explanation *citing evidence from the context* why it's considered a bottleneck (e.g., "Context mentions manual data entry here", "Description implies waiting time", "Multiple approvals required as stated in text").
            5.  **Suggest Optimizations (2-3 suggestions):** For the identified bottlenecks or other inefficient steps described, propose specific improvements. For each optimization:
                * \`target_step_name\`: The step the optimization applies to.
                * \`suggestion\`: A clear description of the proposed change (e.g., "Automate data entry", "Implement parallel processing", "Simplify approval workflow").
                * \`rationale\`: Explain *how* this optimization addresses the inefficiency *described in the context*.
                * \`type\`: Categorize the optimization (e.g., "Automation", "Simplification", "Parallelization", "Standardization", "Resource Allocation").
            6.  **Recommend KPIs (4-5 KPIs):** Suggest relevant Key Performance Indicators to measure the process's efficiency and effectiveness, based on the context. For each KPI:
                * \`name\`: Name of the KPI (e.g., "Cycle Time").
                * \`description\`: What it measures specifically in relation to this process.

            7.  **Self-Correction:** Before outputting JSON, rigorously check: Is every piece of information (steps, owners, types, connections, bottlenecks, reasons, optimizations, KPIs) derived *solely* from the user's text? Are connections logical? Are bottleneck reasons and optimization rationales explicitly linked to the text? Is the JSON structure perfect? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT GROUNDING:** All output MUST be based *exclusively* on the provided PROCESS DESCRIPTION. Do NOT invent steps, roles, bottlenecks, or optimizations not supported by the text.
            - **SPECIFICITY:** Be specific in descriptions, reasons, and rationales, referencing the context where possible.
            - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys and sub-keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
            {
              "process_name": "Example: Customer Order Fulfillment",
              "steps": [
                {"id": 1, "name": "Receive Order", "description": "System receives order via web form.", "owner": "System/Sales", "type": "Start"},
                {"id": 2, "name": "Check Inventory", "description": "Warehouse staff manually check stock levels.", "owner": "Warehouse", "type": "Task"},
                {"id": 3, "name": "Stock Available?", "description": "Decision based on inventory check.", "owner": "Warehouse", "type": "Decision"},
                {"id": 4, "name": "Allocate Stock", "description": "If available, reserve items.", "owner": "Warehouse", "type": "Task"},
                {"id": 5, "name": "Notify Backorder", "description": "If unavailable, inform customer.", "owner": "Customer Service", "type": "Task"},
                {"id": 6, "name": "Pack Order", "description": "Warehouse packs the allocated items.", "owner": "Warehouse", "type": "Task"},
                {"id": 7, "name": "Ship Order", "description": "Logistics arranges shipment.", "owner": "Logistics", "type": "Task"},
                {"id": 8, "name": "Send Confirmation", "description": "System sends shipping confirmation.", "owner": "System", "type": "Task"},
                {"id": 9, "name": "Process Complete", "description": "Order fulfillment cycle ends.", "owner": "System", "type": "End"}
              ],
              "connections": [
                {"from": 1, "to": 2, "label": "Next"},
                {"from": 2, "to": 3, "label": "Next"},
                {"from": 3, "to": 4, "label": "Yes"},
                {"from": 3, "to": 5, "label": "No"},
                {"from": 4, "to": 6, "label": "Next"},
                {"from": 5, "to": 9, "label": "End Cycle"}, // Example connection
                {"from": 6, "to": 7, "label": "Ready to Ship"},
                {"from": 7, "to": 8, "label": "Shipped"},
                {"from": 8, "to": 9, "label": "Confirmed"}
              ],
              "bottlenecks": [
                {"step_name": "Check Inventory", "reason": "Context states 'Warehouse staff manually check stock levels', indicating a slow, error-prone step compared to automated checks."},
                {"step_name": "Handover from Warehouse to Logistics", "reason": "The description implies a potential delay between packing ('Pack Order') and shipping ('Ship Order') without specifying a clear trigger or SLA, suggesting a possible bottleneck."}
              ],
              "optimizations": [
                {
                  "target_step_name": "Check Inventory",
                  "suggestion": "Implement a real-time inventory management system.",
                  "rationale": "Replaces the slow 'manual check' mentioned in the context with an automated system, reducing errors and speeding up the decision at step 3 ('Stock Available?').",
                  "type": "Automation"
                },
                {
                  "target_step_name": "Pack Order / Ship Order Transition",
                  "suggestion": "Establish automated notification from Warehouse to Logistics upon packing completion.",
                  "rationale": "Addresses the implied delay between steps 6 and 7 by creating a clear trigger, potentially reducing wait time as suggested by the lack of explicit connection in the description.",
                  "type": "Process Improvement/Automation"
                }
              ],
              "kpis": [
                {"name": "Order Cycle Time", "description": "Total time from 'Receive Order' (Step 1) to 'Send Confirmation' (Step 8)."},
                {"name": "Inventory Check Time", "description": "Time taken specifically for the 'Check Inventory' step (Step 2)."},
                {"name": "Picking and Packing Time", "description": "Time taken for 'Allocate Stock' and 'Pack Order' (Steps 4 & 6)."},
                {"name": "On-Time Shipment Rate", "description": "Percentage of orders shipped by the promised date."},
                {"name": "Order Accuracy Rate", "description": "Percentage of orders shipped without errors (correct items, quantity)."}
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED Process Mapping prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (Process Mapping):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Process Mapping) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !parsedData.process_name || typeof parsedData.process_name !== 'string' ||
                 !Array.isArray(parsedData.steps) || parsedData.steps.length < 3 ||
                 !Array.isArray(parsedData.connections) || parsedData.connections.length < parsedData.steps.length - 1 || // At least n-1 connections usually
                 !Array.isArray(parsedData.bottlenecks) || // Can be empty, but must exist
                 !Array.isArray(parsedData.optimizations) || // Can be empty, but must exist
                 !Array.isArray(parsedData.kpis) || parsedData.kpis.length < 2 || // Expect at least a couple of KPIs
                 // Check structure of first elements if they exist
                 (parsedData.steps.length > 0 && (typeof parsedData.steps[0] !== 'object' || !parsedData.steps[0].hasOwnProperty('id') || !parsedData.steps[0].hasOwnProperty('name') || !parsedData.steps[0].hasOwnProperty('type'))) ||
                 (parsedData.connections.length > 0 && (typeof parsedData.connections[0] !== 'object' || !parsedData.connections[0].hasOwnProperty('from') || !parsedData.connections[0].hasOwnProperty('to'))) ||
                 (parsedData.bottlenecks.length > 0 && (typeof parsedData.bottlenecks[0] !== 'object' || !parsedData.bottlenecks[0].hasOwnProperty('step_name') || !parsedData.bottlenecks[0].hasOwnProperty('reason'))) ||
                 (parsedData.optimizations.length > 0 && (typeof parsedData.optimizations[0] !== 'object' || !parsedData.optimizations[0].hasOwnProperty('suggestion') || !parsedData.optimizations[0].hasOwnProperty('rationale'))) ||
                 (parsedData.kpis.length > 0 && (typeof parsedData.kpis[0] !== 'object' || !parsedData.kpis[0].hasOwnProperty('name') || !parsedData.kpis[0].hasOwnProperty('description')))
                )
             {
                  console.error("Validation Failed (Enhanced Process Mapping): Required fields missing or invalid structure.", parsedData);
                  throw new Error(`AI response structure is incorrect or inconsistent (Enhanced Process Mapping). Check process_name, steps, connections, bottlenecks, optimizations, and kpis. See console logs.`);
             }
             console.log(`Successfully parsed ENHANCED Process Mapping JSON using ${MODEL_NAME}. Found ${parsedData.steps.length} steps.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED Process Mapping JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced Process Mapping): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results
        renderProcessMappingPage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleProcessMappingAnalysis (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderProcessMappingPage(container, data) {
    container.innerHTML = ""; // Clear the loading indicator
    // Add validation for new fields
    if (!data || !data.process_name || !data.steps || !data.connections || !data.bottlenecks || !data.optimizations || !data.kpis) {
        console.error("Incomplete data passed to renderProcessMappingPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Process Map results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    const { process_name, steps, connections, bottlenecks, optimizations, kpis } = data;


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="flowchart"> Process Flowchart</button>
        <button class="analysis-tab-btn" data-tab="details"> Step Details</button>
        <button class="analysis-tab-btn" data-tab="optimizations"> Optimizations</button> <!-- New Tab -->
        <button class="analysis-tab-btn" data-tab="kpis"> KPIs & Bottlenecks</button> <!-- Renamed & Combined -->
        <button class="analysis-tab-btn" data-tab="learn"> Learn Mapping</button> <!-- New Tab -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="flowchartPanel" class="analysis-tab-panel active"></div>
        <div id="detailsPanel" class="analysis-tab-panel"></div>
        <div id="optimizationsPanel" class="analysis-tab-panel"></div> <!-- New Panel -->
        <div id="kpisPanel" class="analysis-tab-panel"></div> <!-- Renamed Panel -->
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New Panel -->
    `;

    // --- 1. Populate Flowchart Panel (Keep as is, but add better icons) ---
    const flowchartPanel = $("flowchartPanel");
    let flowchartHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-6 text-center">${process_name}</h3><div class="space-y-2 max-w-lg mx-auto">`; // Centered flowchart

    const stepMap = new Map(steps.map((step) => [step.id, step]));

    steps.forEach((step, index) => {
        let stepClass = "bg-black/20 p-3 rounded-lg border-l-4 flex items-center gap-3 ";
        let icon = ""; // Default
        switch (step.type.toLowerCase()) {
            case "start": stepClass += "border-green-400"; icon = ""; break;
            case "end": stepClass += "border-red-400"; icon = ""; break;
            case "decision": stepClass += "border-yellow-400"; icon = ""; break;
            case "sub-process": stepClass += "border-purple-400"; icon = ""; break; // Added sub-process
            default: stepClass += "border-blue-400"; icon = ""; // Task
        }
        flowchartHtml += `<div class="${stepClass}">
                            <span class="text-xl">${icon}</span>
                            <div>
                                <p class="font-bold text-md">${step.name}</p>
                                <p class="text-xs text-white/70">Owner: ${step.owner || 'N/A'}</p>
                            </div>
                         </div>`;

        // Add connection arrow and label if not the last step
         // Find connections originating FROM this step
         const outgoingConnections = connections.filter(c => c.from === step.id);
         if (outgoingConnections.length > 0) {
              if (outgoingConnections.length === 1) {
                  // Single outgoing path
                  const connection = outgoingConnections[0];
                  const label = connection.label || "Next";
                  flowchartHtml += `<div class="text-center text-white/50 text-2xl font-light leading-none my-1" aria-hidden="true"> <span class="text-xs font-sans align-middle">${label}</span></div>`;
              } else {
                  // Multiple outgoing paths (likely from a decision)
                  flowchartHtml += `<div class="text-center text-white/50 text-lg font-light leading-none my-1 flex justify-around items-center" aria-hidden="true">`;
                  outgoingConnections.forEach(conn => {
                      const targetStepName = stepMap.get(conn.to)?.name || `Step ${conn.to}`;
                      flowchartHtml += `<span class="text-xs font-sans"> ${conn.label || ''} (to ${targetStepName})</span>`;
                  });
                  flowchartHtml += `</div>`;
              }
         } else if (step.type.toLowerCase() !== 'end' && index < steps.length - 1) {
             // If no connection defined but not the end, assume 'Next'
             flowchartHtml += `<div class="text-center text-white/50 text-2xl font-light leading-none my-1" aria-hidden="true"> <span class="text-xs font-sans align-middle">Next</span></div>`;
         }

    });
    flowchartHtml += "</div></div>"; // Close space-y-2 and p-4
    flowchartPanel.innerHTML = flowchartHtml;

    // --- 2. Populate Step Details Panel (Keep table) ---
    const detailsPanel = $("detailsPanel");
    let detailsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Detailed Step Breakdown</h3><div class="overflow-x-auto"><table class="coeff-table styled-table text-sm">
        <thead><tr><th>ID</th><th>Step Name</th><th>Owner/Role</th><th>Type</th><th>Description</th></tr></thead><tbody>`;
    steps.forEach((step) => {
        detailsHtml += `<tr>
            <td>${step.id}</td>
            <td class="font-semibold">${step.name}</td>
            <td>${step.owner || 'N/A'}</td>
            <td>${step.type}</td>
            <td class="text-white/80">${step.description}</td></tr>`;
    });
    detailsHtml += `</tbody></table></div></div>`;
    detailsPanel.innerHTML = detailsHtml;

    // --- 3. Populate Optimizations Panel (New) ---
    const optimizationsPanel = $("optimizationsPanel");
    let optimizationsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Potential Optimizations</h3>`;
    if (optimizations && optimizations.length > 0) {
        optimizationsHtml += `<p class="text-sm text-white/70 mb-6 italic">Based on the process description, consider these improvements, particularly for identified bottlenecks.</p>`;
        optimizationsHtml += `<div class="space-y-6">`;
        optimizations.forEach((opt, index) => {
            optimizationsHtml += `
                <div class="prescription-card border-l-4 border-green-500">
                    <h4 class="text-xl font-bold">${index + 1}. ${opt.suggestion}</h4>
                     <p class="text-xs font-semibold my-1 text-indigo-300">TARGET STEP: ${opt.target_step_name || 'N/A'} | TYPE: ${opt.type || 'N/A'}</p>
                    <p class="rationale"><strong>Rationale:</strong> ${opt.rationale || 'N/A'}</p>
                </div>`;
        });
        optimizationsHtml += `</div>`;
    } else {
        optimizationsHtml += `<p class="text-center text-white/70 italic">No specific optimization opportunities were clearly identified from the provided process description.</p>`;
    }
    optimizationsHtml += `</div>`;
    optimizationsPanel.innerHTML = optimizationsHtml;

    // --- 4. Populate KPIs & Bottlenecks Panel (New/Combined) ---
    const kpisPanel = $("kpisPanel");
    let kpisHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> KPIs & Bottlenecks</h3>`;
    // Bottlenecks first
    if (bottlenecks && bottlenecks.length > 0) {
        kpisHtml += `<h4 class="text-xl font-semibold mb-3 text-red-300"> Identified Potential Bottlenecks</h4><div class="space-y-3 mb-8">`;
        bottlenecks.forEach((b) => {
            kpisHtml += `<div class="metric-card border-l-4 border-red-400">
                             <p class="font-bold">${b.step_name}</p>
                             <p class="text-sm text-white/80 italic">${b.reason}</p>
                         </div>`;
        });
        kpisHtml += `</div>`;
    } else {
         kpisHtml += `<p class="text-center text-white/70 italic mb-8">No clear bottlenecks were identified from the provided description.</p>`;
    }
    // Then KPIs
    if (kpis && kpis.length > 0) {
        kpisHtml += `<h4 class="text-xl font-semibold mb-3 text-green-300"> Recommended KPIs</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
        kpis.forEach((k) => {
            kpisHtml += `<div class="summary-stat-card text-left p-4 border-l-4 border-green-400">
                            <p class="font-bold text-lg text-white">${k.name}</p>
                            <p class="text-sm text-white/80">${k.description}</p>
                         </div>`;
        });
        kpisHtml += `</div>`;
    } else {
        kpisHtml += `<p class="text-center text-white/70 italic">No specific KPIs were recommended based on the description.</p>`;
    }
    kpisHtml += `</div>`; // Close p-4
    kpisPanel.innerHTML = kpisHtml;


    // --- 5. Populate Learn Mapping Panel (New) ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Process Mapping</h3>
        [Image of a business process map]
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is Process Mapping?</h4>
            <p class="text-sm text-white/80">Process mapping is a technique used to visually represent the sequence of steps, decisions, and handoffs involved in a specific work process from beginning to end. It helps teams understand, analyze, and improve workflows.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Common Symbols (Simplified):</h4>
                <ul class="space-y-2 text-sm">
                    <li><span class="font-mono text-xl mr-2"></span> <strong>Start/End:</strong> Oval shapes indicating the beginning or end points.</li>
                    <li><span class="font-mono text-xl mr-2"></span> <strong>Task/Activity:</strong> Rectangles representing a specific action or step.</li>
                    <li><span class="font-mono text-xl mr-2"></span> <strong>Decision:</strong> Diamonds indicating a point where a choice is made (usually with Yes/No branches).</li>
                    <li><span class="font-mono text-xl mr-2"></span> <strong>Sub-process:</strong> Rectangle with double vertical lines, representing a predefined, separate process.</li>
                    <li><span class="font-mono text-xl mr-2"></span> <strong>Flow Lines:</strong> Arrows showing the direction and sequence of steps.</li>
                    <li><span class="font-mono text-xl mr-2"></span> <strong>Document/Data:</strong> Often represented by a rectangle with a wavy bottom.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Why Map Processes?</h4>
                 <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Clarity & Understanding:</strong> Provides a clear visual representation of how work gets done.</li>
                    <li><strong>Identify Inefficiencies:</strong> Highlights bottlenecks, redundancies, delays, and unnecessary steps.</li>
                    <li><strong>Improvement Foundation:</strong> Serves as a baseline for optimization efforts (simplification, automation).</li>
                    <li><strong>Standardization:</strong> Helps define and communicate standard operating procedures.</li>
                    <li><strong>Training:</strong> Useful tool for onboarding new team members.</li>
                    <li><strong>Role Clarity:</strong> Shows who is responsible for each step.</li>
                 </ul>
            </div>
        </div>

        <details class="styled-details text-sm mt-4">
            <summary class="font-semibold">Tips for Effective Process Mapping</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                <p><strong>1. Define Scope Clearly:</strong> Know where the process starts and ends.</p>
                <p><strong>2. Involve the Right People:</strong> Include those who actually perform the work.</p>
                <p><strong>3. Observe the Real Process:</strong> Don't just rely on documented procedures; see how it actually happens.</p>
                <p><strong>4. Keep it Simple Initially:</strong> Start with a high-level map, then add detail as needed.</p>
                <p><strong>5. Use Consistent Symbols:</strong> Stick to a standard set of shapes for clarity.</p>
                <p><strong>6. Focus on Flow, Not Just Steps:</strong> Show handoffs, decisions, and potential loops.</p>
                <p><strong>7. Validate the Map:</strong> Review with stakeholders to ensure accuracy.</p>
                <p><strong>8. Use it for Action:</strong> The map is a tool for analysis and improvement, not just documentation.</p>
            </div>
        </details>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                 // No Plotly charts expected in this version, so no resize needed
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}

/**
 * Handles the submission of the SEM analysis request to the backend.
 * Sends data (file or text) and separate measurement/structural syntax.
 */
async function handleSemAnalysis() {
    const analysisResultContainer = $("analysisResult"); // Get the results container element
    // Display loading indicator
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><h3 class="text-xl font-semibold text-white">Running Structural Equation Model...</h3></div>`;
    setLoading("generate", true); // Assumes setLoading function exists to disable button and show spinner

    try {
        // --- 1. Get Inputs from UI ---
        const measurementSyntax = $("semMeasurementSyntax").value.trim();
        const structuralSyntax = $("semStructuralSyntax").value.trim();
        const dataFile = $("semFile").files[0]; // Get the selected file object
        const dataText = $("semDataText").value.trim(); // Get pasted text
        const isUsingFile = $("semInputFileToggle").checked; // Check which input type is selected

        let fileToSend = null;
        let dataContentToSend = null; // Use this variable if your backend accepts raw text

        // --- 2. Validate Inputs & Prepare Data Source ---
        if (isUsingFile) {
            if (!dataFile) {
                throw new Error("Please upload a data file (.csv or .xlsx).");
            }
            // Basic file type check (backend should also validate)
            const allowedTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            //if (!allowedTypes.includes(dataFile.type) && !dataFile.name.toLowerCase().endsWith('.csv') && !dataFile.name.toLowerCase().endsWith('.xlsx')) {
            //    throw new Error("Invalid file type. Please upload a CSV or Excel file.");
            //}
            fileToSend = dataFile;
        } else {
            if (!dataText) {
                throw new Error("Please paste your CSV data into the text area.");
            }
            // Decide how to send text data based on backend requirements
            dataContentToSend = dataText; // Sending raw text
            // Alternative: If backend strictly expects a file, create a Blob
            // fileToSend = new Blob([dataText], { type: 'text/csv' });
            // fileToSend.name = "pasted_data.csv"; // Assign a default filename
        }

        // Validate that at least one syntax part is provided
        if (!measurementSyntax && !structuralSyntax) {
            throw new Error("Please provide Measurement Model Syntax and/or Structural Model Syntax.");
        }

        // --- 3. Prepare FormData for Backend ---
        const formData = new FormData();
        formData.append("analysis_type", "sem"); // Identify the analysis type

        // *** Send SYNTAX parts SEPARATELY ***
        formData.append("measurement_syntax", measurementSyntax);
        formData.append("structural_syntax", structuralSyntax);

        // Append the data source (either the file or the text content)
        if (fileToSend) {
            // If sending a file (uploaded or created from text via Blob)
            formData.append("data_file", fileToSend, fileToSend.name);
        } else if (dataContentToSend) {
            // If sending raw text content under a specific form field name
             formData.append("data_text", dataContentToSend);
             // Make sure your backend (main.py) expects "data_text" if you use this
        } else {
            // This case should ideally not be reached if validation above is correct
            throw new Error("No data source (file or text) could be prepared.");
        }


        // --- 4. Send Request to Backend API ---
        // *** Replace with your actual backend API endpoint ***
        const API_URL = "https://analysis.data2int.com/api/data-analysis"; // Example URL

        const response = await fetch(API_URL, {
            method: "POST",
            body: formData,
            // Add Authorization header if your API requires authentication
            // headers: { 'Authorization': `Bearer ${your_auth_token}` }
        });

        // --- 5. Handle Backend Response ---
        if (!response.ok) {
            // Attempt to get detailed error message from backend
            let errorDetail = `API request failed (${response.status})`;
            try {
                const errorJson = await response.json(); // Assumes backend sends JSON errors
                errorDetail += `: ${errorJson.detail || JSON.stringify(errorJson)}`; // Use specific 'detail' field if available
            } catch (e) {
                // If response is not JSON, use the raw text
                errorDetail += `: ${await response.text()}`;
            }
            throw new Error(errorDetail); // Throw error to be caught below
        }

        // If response is OK (2xx status)
        const parsedData = await response.json(); // Expecting JSON response with results

        // Render the results using the SEM-specific rendering function
        // Assumes renderSemAnalysisPage exists and handles the parsedData structure
        renderSemAnalysisPage(analysisResultContainer, parsedData);

    } catch (error) { // Catch errors from input validation, fetch, or response handling
        console.error("Error during SEM analysis:", error);
        // Display the error message in the results container
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"><strong>Error:</strong> ${error.message}</div>`;
    } finally {
        // Ensure loading indicator is turned off regardless of success or failure
        setLoading("generate", false); // Assumes setLoading function exists
    }
}

   async function handlePredictiveAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div></div><div></div><div></div></div><h3 class="text-xl font-semibold text-white">Generating Enhanced Forecast...</h3><p class="text-white/80 mb-2">Applying detailed prompt engineering & accuracy checks...</p></div>`;
    setLoading("generate", true);

    // Define URL and Model (ensure these are correct for your setup)
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    // *** CHOOSE MODEL: qwen or llama ***
    const MODEL_NAME = "llama3.1:latest"; // Use Qwen for potentially better numerical accuracy
    // const MODEL_NAME = "llama3.1:latest"; // Alternative option

    try {
        // 1. Gather all inputs from the UI
        const file = $("predictiveFile").files[0];
        const dateColumn = $("dateColumnSelect").value;
        const metricColumn = $("metricSelect").value;
        const horizon = $("horizonSelect").value;
        const modelType = document.querySelector('input[name="model"]:checked').value;

        if (!file || !dateColumn || !metricColumn) {
            throw new Error(" Please upload a file and select the date and metric columns.");
        }

        const fileContent = await extractTextFromFile(file);
        const periods = { quarter: 3, "6months": 6, year: 12, "2years": 24 }[horizon];
        const horizonText = { quarter: "Next Quarter", "6months": "Next 6 Months", year: "Next Year", "2years": "Next 2 Years" }[horizon];

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000; // Adjust as needed
         let truncatedNote = "";
         let dataSnippet = fileContent;
         if (fileContent.length > MAX_CONTEXT_LENGTH) {
             dataSnippet = fileContent.substring(0, MAX_CONTEXT_LENGTH);
             truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters of data.)`;
             console.warn(`Predictive analysis data truncated.`);
         }

        // 2. Construct the Enhanced Prompt for Ollama
         const prompt = `
            You are a meticulous and highly accurate senior data scientist performing a time-series forecast and analysis for a business user. Your primary goal is precision and providing actionable, data-grounded insights.

            **ANALYSIS INPUTS:**
            * **Data Snippet:** ${truncatedNote}\n\`\`\`csv\n${dataSnippet}\n\`\`\`
            * **Date/Time Column:** "${dateColumn}"
            * **Value Column to Predict:** "${metricColumn}"
            * **Forecast Horizon:** ${periods} months (${horizonText})
            * **Preferred Model:** ${modelType} (Use Prophet principles if possible, otherwise use ARIMA. State which model was ultimately used.)

            **DETAILED TASKS:**
            1.  **Forecast Generation:** Generate a plausible month-by-month forecast for "${metricColumn}" for the next ${periods} months. Include: \`predicted_value\` (float), \`lower_bound\` (float, e.g., 95% CI lower), \`upper_bound\` (float, e.g., 95% CI upper). Ensure bounds realistically reflect forecast uncertainty (wider further out). Format \`period\` as "YYYY-MM".
            2.  **Input Data Summary:** Calculate plausible descriptive statistics for the historical "${metricColumn}" data *consistent with patterns in the snippet*: Mean, Median, Standard Deviation (Std Dev), Minimum (Min), Maximum (Max), and Coefficient of Variation (CV = Std Dev / Mean * 100). Calculate CV percentage.
            3.  **Model Performance Simulation:** Estimate plausible performance metrics by simulating a train/test split (e.g., using last 20% data as test): Model Used (Confirm Prophet or ARIMA), MAPE (%), R-squared (0-1), MAE, and RMSE. Provide an accurate interpretation: "R-squared of [value] indicates that approximately [value*100]% of the variance in the historical data is explained by the model." Note limitations if data seems short/erratic.
            4.  **Detailed & Accurate Insights (Generate 6-8 Objects):** Analyze patterns ONLY within the provided data snippet.

                **For EACH Insight Object (MUST contain these 3 keys):**
                * **\`observation\`:** State the specific statistical finding *exactly* (e.g., "Mean ([value]) is [correctly state: higher/lower] than Median ([value]) for '${metricColumn}'."). Verify all numerical comparisons. Calculate and state CV percentage when discussing variability. State typical confidence interval width (Upper - Lower).
                * **\`accurate_interpretation\`:** Explain the practical meaning based *strictly* on statistical rules:
                    * **SKEWNESS (MANDATORY CHECK):** If Mean > Median, state: "potential **right-skewness** (tail high)". If Mean < Median, state: "potential **left-skewness** (tail low)". If Mean  Median, state: "**roughly symmetric**". DO NOT GUESS.
                    * **VARIABILITY (CV %):** Interpret calculated CV *relatively* (e.g., <15% low, 15-30% moderate, >30% high inconsistency).
                    * **CONFIDENCE INTERVAL:** Wider interval = **less certainty/reliability**. Narrower = **more certainty/reliability**. State this clearly.
                * **\`business_implication\`:** Connect the *accurate interpretation* to potential business actions/investigations. If a finding seems anomalous, note it. Aim for actionable relevance.

            5.  **Self-Correction:** Before outputting JSON, rigorously check: Are all numbers/comparisons correct? Do interpretations strictly follow rules? Are implications logical? Is everything based ONLY on the data snippet? Fix errors.

            **ABSOLUTE CONSTRAINTS:**
            - **NUMERICAL PRECISION & ACCURACY:** Mandatory.
            - **RULE ADHERENCE:** Mandatory for Skewness, CV, CI interpretation.
            - **DATA GROUNDING:** Mandatory. No external knowledge or fabrication.
            - **JSON FORMAT:** Adhere EXACTLY. Ensure ALL FOUR top-level keys are present and insights are objects.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys: "predictions", "data_summary", "model_performance", AND "insights".** The "insights" array MUST contain **6-8 objects**, each with "observation", "accurate_interpretation", and "business_implication" keys.
            {
              "predictions": [ {"period": "YYYY-MM", "predicted_value": 0.0, "lower_bound": 0.0, "upper_bound": 0.0} /* ... */ ],
              "data_summary": { "mean": 0.0, "median": 0.0, "std_dev": 0.0, "min": 0.0, "max": 0.0, "coeff_variation": 0.0 },
              "model_performance": { "model_used": "...", "mape": 0.0, "r_squared": 0.0, "mae": 0.0, "rmse": 0.0, "interpretation": "..." },
              "insights": [
                { // MUST BE THIS OBJECT STRUCTURE
                  "observation": "Accurate observation...",
                  "accurate_interpretation": "Correct interpretation based on rules...", // Key name changed from 'interpretation'
                  "business_implication": "Recommendation..."
                } // ... 6 to 8 INSIGHT OBJECTS ...
              ]
            }
        `;

        // 3. Send the request to Ollama
        console.log(`Sending ENHANCED Predictive Analysis prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } }) // Increased context window
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        try {
            parsedData = JSON.parse(data.response);
            // *** Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Prompt) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData ||
                 !parsedData.predictions || !Array.isArray(parsedData.predictions) ||
                 !parsedData.data_summary || typeof parsedData.data_summary !== 'object' || !parsedData.data_summary.hasOwnProperty('mean') || // Check specific field
                 !parsedData.model_performance || typeof parsedData.model_performance !== 'object' || !parsedData.model_performance.hasOwnProperty('model_used') || // Check specific field
                 !parsedData.insights || !Array.isArray(parsedData.insights) ||
                 // Check insights structure more carefully
                 (parsedData.insights.length > 0 && (
                     typeof parsedData.insights[0] !== 'object' ||
                     !parsedData.insights[0].hasOwnProperty('observation') ||
                     !parsedData.insights[0].hasOwnProperty('accurate_interpretation') || // Check for new key name
                     !parsedData.insights[0].hasOwnProperty('business_implication')
                 )) ||
                 // Check if insight count is reasonable (optional, adjust range if needed)
                  parsedData.insights.length < 4 // Expecting at least a few insights
                )
             {
                  console.error("Validation Failed: Required fields missing or invalid structure/count.", parsedData);
                  throw new Error(`AI response structure is incorrect. Missing or invalid fields (e.g., predictions, data_summary, model_performance, or insights). Check console logs.`);
             }
             console.log(`Successfully parsed ENHANCED Predictive Analysis JSON using ${MODEL_NAME}. Found ${parsedData.insights.length} insights.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED Predictive Analysis JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or required fields missing in AI response: ${e.message}. Check console logs.`);
        }

        // 4. Render the results
        renderPredictiveAnalysisPage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handlePredictiveAnalysis (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops even if rendering fails
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderPredictiveAnalysisPage(container, data) {
    container.innerHTML = ""; // Clear loading state

    // Basic validation
    if (!data || !data.predictions || !data.data_summary || !data.model_performance || !data.insights) {
        console.error("Incomplete data passed to renderPredictiveAnalysisPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    // Added "Learn Forecast" tab
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="summary"> Summary & Performance</button>
        <button class="analysis-tab-btn" data-tab="chart"> Forecast Chart</button>
        <button class="analysis-tab-btn" data-tab="insights"> Key Insights</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Forecast</button>
    `;
    container.appendChild(tabNav);

    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    // Added panel for "Learn Forecast"
    tabContent.innerHTML = `
        <div id="summaryPanel" class="analysis-tab-panel active"></div>
        <div id="chartPanel" class="analysis-tab-panel"></div>
        <div id="insightsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- Render Summary & Performance Tab (Updated) ---
    const summaryPanel = $("summaryPanel");
    const summary = data.data_summary;
    const performance = data.model_performance;
    summaryPanel.innerHTML = `
    <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h3 class="text-2xl font-bold mb-4">Historical Data Summary</h3>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-white/5 p-3 rounded-lg"><p class="text-sm text-white/70">Mean</p><p class="text-xl font-bold">${summary.mean?.toFixed(2) ?? 'N/A'}</p></div>
                    <div class="bg-white/5 p-3 rounded-lg"><p class="text-sm text-white/70">Median</p><p class="text-xl font-bold">${summary.median?.toFixed(2) ?? 'N/A'}</p></div>
                    <div class="bg-white/5 p-3 rounded-lg"><p class="text-sm text-white/70">Min Value</p><p class="text-xl font-bold">${summary.min?.toFixed(2) ?? 'N/A'}</p></div>
                    <div class="bg-white/5 p-3 rounded-lg"><p class="text-sm text-white/70">Max Value</p><p class="text-xl font-bold">${summary.max?.toFixed(2) ?? 'N/A'}</p></div>
                    <div class="bg-white/5 p-3 rounded-lg"><p class="text-sm text-white/70">Std. Deviation</p><p class="text-xl font-bold">${summary.std_dev?.toFixed(2) ?? 'N/A'}</p></div>
                    <div class="bg-white/5 p-3 rounded-lg"><p class="text-sm text-white/70" title="Coefficient of Variation (Std Dev / Mean * 100)">Volatility (CV)</p><p class="text-xl font-bold">${summary.coeff_variation?.toFixed(1) ?? 'N/A'}%</p></div>
                </div>
            </div>
            <div>
                <h3 class="text-2xl font-bold mb-4">Simulated Model Performance</h3>
                 <div class="bg-white/5 p-4 rounded-lg">
                    <ul class="list-disc list-inside space-y-3 text-white/80 text-sm">
                        <li><strong>Model Used:</strong> ${performance.model_used ?? 'N/A'}</li>
                        <li><strong>R-squared (R):</strong> ${performance.r_squared?.toFixed(3) ?? 'N/A'}</li>
                        <li><strong>MAPE:</strong> ${performance.mape?.toFixed(2) ?? 'N/A'}%</li>
                        <li><strong>MAE:</strong> ${performance.mae?.toFixed(2) ?? 'N/A'}</li>
                        <li><strong>RMSE:</strong> ${performance.rmse?.toFixed(2) ?? 'N/A'}</li>
                    </ul>
                    <blockquote class="mt-4 p-3 text-xs italic border-l-2 border-indigo-400 bg-black/20 text-white/70">${performance.interpretation ?? 'Model performance interpretation unavailable.'}</blockquote>
                </div>
            </div>
        </div>
        <div class="mt-8">
            <h3 class="text-2xl font-bold mb-4">Detailed Forecast</h3>
            <div class="overflow-x-auto max-h-96">
                 <table class="w-full text-left styled-table forecast-table text-sm">
                     <thead class="sticky top-0 bg-gray-800/80 backdrop-blur-sm"><tr><th>Period</th><th>Predicted Value</th><th>Lower Bound (Est. 95%)</th><th>Upper Bound (Est. 95%)</th></tr></thead>
                     <tbody>
                        ${data.predictions?.map(p => `<tr>
                            <td>${p.period ?? 'N/A'}</td>
                            <td><strong>${p.predicted_value?.toFixed(2) ?? 'N/A'}</strong></td>
                            <td>${p.lower_bound?.toFixed(2) ?? 'N/A'}</td>
                            <td>${p.upper_bound?.toFixed(2) ?? 'N/A'}</td>
                        </tr>`).join("") ?? '<tr><td colspan="4" class="text-center text-white/60">No prediction data available.</td></tr>'}
                     </tbody>
                 </table>
            </div>
        </div>
    </div>
    `;

    // --- Render Forecast Chart Tab (No changes needed here) ---
    const chartPanel = $("chartPanel");
    chartPanel.innerHTML = `<div class="p-4"><div id="forecastChart" class="w-full h-[500px] plotly-chart"></div></div>`;
    if (data.predictions && data.predictions.length > 0) {
        try {
            const trace1 = {
                x: data.predictions.map(p => p.period),
                y: data.predictions.map(p => p.predicted_value),
                type: 'scatter', mode: 'lines', name: 'Forecast',
                line: { color: 'var(--accent)', width: 3 }
            };
            const trace2 = {
                x: data.predictions.map(p => p.period),
                y: data.predictions.map(p => p.upper_bound),
                type: 'scatter', mode: 'lines', name: 'Upper Bound',
                line: { dash: 'dot', color: 'rgba(255,255,255,0.4)', width: 1 },
                fill: 'none'
            };
            const trace3 = {
                x: data.predictions.map(p => p.period),
                y: data.predictions.map(p => p.lower_bound),
                type: 'scatter', mode: 'lines', name: 'Lower Bound',
                line: { dash: 'dot', color: 'rgba(255,255,255,0.4)', width: 1 },
                fill: 'tonexty', // Fill area between trace3 (Lower) and trace2 (Upper)
                fillcolor: 'rgba(142, 45, 226, 0.15)' // Semi-transparent fill
            };

            Plotly.newPlot('forecastChart', [trace3, trace2, trace1], {
                title: 'Predictive Forecast with Confidence Interval',
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                yaxis: { title: 'Predicted Value', gridcolor: 'rgba(255,255,255,0.1)', zeroline: false },
                xaxis: { title: 'Period', gridcolor: 'rgba(255,255,255,0.1)' },
                legend: { orientation: 'h', y: -0.2 }
            }, { responsive: true });
        } catch (e) {
            console.error("Error rendering Plotly chart:", e);
            chartPanel.innerHTML = `<div class="p-4 text-center text-red-400">Could not render forecast chart.</div>`;
        }
    } else {
        chartPanel.innerHTML = `<div class="p-4 text-center text-white/60">Not enough data to generate chart.</div>`;
    }


    // --- Render Insights Tab (Updated for new object structure) ---
    const insightsPanel = $("insightsPanel");
     let insightsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Key Insights & Observations</h3>`;
     if (data.insights && data.insights.length > 0 && typeof data.insights[0] === 'object') {
         insightsHtml += `<div class="space-y-6">`;
         data.insights.forEach((i, index) => {
             insightsHtml += `
             <div class="insight-card border-l-4 border-indigo-400">
                  <p class="text-xs font-semibold text-indigo-300 mb-1">OBSERVATION ${index + 1}</p>
                 <p class="mb-2"><strong>${i.observation ?? 'N/A'}</strong></p>
                 <p class="mb-2 text-sm text-white/80"><strong>Interpretation:</strong> ${i.accurate_interpretation ?? 'N/A'}</p>
                 <div class="p-3 bg-black/20 rounded mt-3">
                     <p class="text-sm"><strong>Business Implication:</strong> ${i.business_implication ?? 'N/A'}</p>
                 </div>
              </div>`;
         });
         insightsHtml += `</div>`;
     } else {
         insightsHtml += `<p class="text-center text-white/70 italic">No specific insights were generated or they are in an unexpected format.</p>`;
     }
     insightsHtml += `</div>`;
    insightsPanel.innerHTML = insightsHtml;

    // --- Render Learn Forecast Tab (New Content) ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Time-Series Forecasting</h3>

        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is Time-Series Forecasting?</h4>
            <p class="text-sm text-white/80">Time-series forecasting involves analyzing historical data points collected over time (like daily sales, monthly website visits) to predict future values. The core idea is that past patterns can help us anticipate what might happen next.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Key Components Analyzed:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Trend:</strong> The long-term increase or decrease in the data.</li>
                    <li><strong>Seasonality:</strong> Patterns that repeat over a fixed period (e.g., daily, weekly, yearly).</li>
                    <li><strong>Cycles:</strong> Longer-term fluctuations not of a fixed period (e.g., economic cycles).</li>
                    <li><strong>Irregularity (Noise):</strong> Random, unpredictable variations.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Models Used Here:</h4>
                 <p class="text-sm mb-2"><strong>Prophet:</strong> Developed by Facebook, excels with business data having strong seasonality (daily, weekly, yearly) and holiday effects. Handles missing data and outliers well. Generally user-friendly.</p>
                 <p class="text-sm"><strong>ARIMA:</strong> (Autoregressive Integrated Moving Average) A classic statistical model. Powerful for data with clear trends and dependencies between observations. Requires more careful parameter tuning.</p>
            </div>
        </div>

        <div class="bg-black/20 p-4 rounded-lg">
             <h4 class="text-lg font-bold mb-2 text-indigo-300">Data Requirements:</h4>
             <ul class="list-disc list-inside space-y-1 text-sm text-white/80">
                <li><strong>Time Column:</strong> A clear column indicating the date or timestamp for each observation (e.g., 'YYYY-MM-DD', 'MM/DD/YYYY HH:MM'). Consistent format is key.</li>
                <li><strong>Value Column:</strong> The numerical metric you want to forecast (e.g., 'Sales', 'Users', 'Temperature').</li>
                <li><strong>Sufficient History:</strong> Generally, the more historical data, the better. At least 1-2 full cycles of seasonality (e.g., 1-2 years for yearly patterns) is recommended for good results.</li>
             </ul>
        </div>

        <details class="styled-details text-sm">
            <summary class="font-semibold">How to Interpret Results</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-3">
                <p><strong>Forecast Line:</strong> The model's best prediction of future values.</p>
                <p><strong>Confidence Interval (Shaded Area / Upper & Lower Bounds):</strong> Represents the uncertainty. A wider band means less certainty. Actual values are likely (e.g., 95% probability) to fall within this range.</p>
                <p><strong>Performance Metrics (R, MAPE etc.):</strong> Indicate how well the model fit the *historical* data. High R (closer to 1) and low MAPE/MAE/RMSE suggest a good historical fit, but don't guarantee future accuracy.</p>
                <p><strong>Insights:</strong> Help understand patterns in the historical data (like skewness or volatility) which can inform business decisions beyond just the forecast numbers.</p>
                <p><strong> Caution:</strong> Forecasts are predictions, not guarantees. Unexpected events ('black swans') can significantly alter future outcomes. Use forecasts as one input for planning, not as absolute truth.</p>
            </div>
        </details>
    </div>
    `;

    // --- Activate Listeners ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache the result HTML
    $("analysisActions").classList.remove("hidden"); // Show save buttons

    // Re-attach tab switching logic, including chart resizing
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all tabs and panels
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate the clicked tab and corresponding panel
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");

                // If the activated panel is the chart panel, resize the chart
                if (e.target.dataset.tab === "chart") {
                     const chartDiv = $("forecastChart");
                     // Check if Plotly chart exists before resizing
                     if (chartDiv && chartDiv.layout && typeof Plotly !== 'undefined') {
                         try {
                             Plotly.Plots.resize(chartDiv);
                             console.log("Resized forecast chart.");
                         } catch (resizeError) {
                              console.error("Error resizing Plotly chart:", resizeError);
                         }
                     }
                }
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Attempt initial resize after a short delay for Plotly to potentially render
     setTimeout(() => {
         const initialChartDiv = $("forecastChart");
         if (initialChartDiv && initialChartDiv.layout && typeof Plotly !== 'undefined') {
             try {
                  Plotly.Plots.resize(initialChartDiv);
                  console.log("Initial resize of forecast chart attempted.");
             } catch (initialResizeError) {
                  console.error("Error during initial resize:", initialResizeError);
             }
         }
     }, 150); // Delay slightly longer

    // Ensure loading indicator is stopped
    setLoading("generate", false);
}

    
    async function handleDematelAnalysis() {
    const analysisResultContainer = $("analysisResult");
    // Using the exact loading message structure you provided
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div></div><div></div><div></div></div><h3 class="text-xl font-semibold text-white">Running DEMATEL Analysis...</h3><p id="analysisStatus" class="text-white/60 text-sm">This may take a moment.</p></div>`;
    // Added setLoading call
    setLoading("generate", true);

    // Define URL and Model (using llama3.1 as per your function)
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest";

    try {
        // 1. Gather Inputs (using your logic)
        const useDoc = document.querySelector('input[name="inputType"]:checked').id === "docUpload";
        let content = "";
        if (useDoc) {
            const file = $("dematelFile").files[0];
            if (!file) throw new Error("Please select a document.");
            content = await extractTextFromFile(file);
        } else {
            content = $("dematelContent").value.trim();
            if (!content) throw new Error("Please describe the system's factors.");
        }

        // Truncate if necessary (added for safety)
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (content.length > MAX_CONTEXT_LENGTH) {
            content = content.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`DEMATEL analysis context truncated.`);
        }


        // 2. Construct ENHANCED Prompt (based on your numerical approach)
        const prompt = `
            You are an expert systems analyst applying the Decision Making Trial and Evaluation Laboratory (DEMATEL) method. Analyze the user's provided context to identify key factors, model their causal interrelationships numerically, and provide detailed, actionable insights. Accuracy and adherence to DEMATEL principles are paramount. ${truncatedNote}

            **ANALYSIS INPUTS:**
            * **User Context/Factor Description:**\n\`\`\`\n${content}\n\`\`\`

            **DETAILED TASKS:**
            1.  **Factor Identification:** Identify 5 to 7 key, distinct factors relevant to the core issue described *only* in the context. Ensure factors are clearly named (2-4 words max).
            2.  **Simulate Total Influence Matrix (T):** Based *only* on the relationships implied or stated in the context (or plausible defaults if vague), simulate a plausible square **total-influence matrix (T)** where T[i][j] represents the total (direct + indirect) influence of factor i on factor j. Diagonal elements should typically be smaller than off-diagonal. Ensure values are plausible positive numbers.
            3.  **Calculate Influence Metrics:** Based *strictly* on the simulated **total-influence matrix (T)**:
                * Calculate Row Sums (R - Total Dispatch Influence) for each factor.
                * Calculate Column Sums (C - Total Received Influence) for each factor.
                * Calculate Prominence (R+C - Total Importance/Involvement) for each factor.
                * Calculate Relation (R-C - Net Dispatcher/Receiver Role) for each factor.
            4.  **Causal Analysis & Interpretation:**
                * Identify the factor with the **highest Prominence (R+C)** as the most central/critical factor, explaining its role based on the R+C value.
                * Identify factors with **high positive Relation (R-C)** as key "Dispatchers" (causes), explaining their influence based on the R-C value.
                * Identify factors with **high negative Relation (R-C)** as key "Receivers" (effects), explaining their role based on the R-C value.
                * Provide a concise **\`summary\`** explaining the overall causal structure suggested by the R+C and R-C values (e.g., "Factors X (R-C=...) and Y (R-C=...) are primary drivers impacting Z (R-C=...), while Factor A (R+C=...) is most central.").
            5.  **Business Recommendations (Generate 3 distinct recommendations):** Based *only* on the numerical causal analysis (dispatcher/receiver roles) and the context:
                * **\`recommendation\`:** A clear, actionable title focusing on influencing a key "Dispatcher" (high +R-C) or managing/monitoring a key "Receiver" (high -R-C).
                * **\`focus_factor\`:** The primary factor targeted.
                * **\`rationale\`:** Explain *why* this action is strategic, explicitly linking it to the factor's calculated dispatcher/receiver role (R-C value) and the overall system dynamics described in the summary.
                * **\`action_items\`:** List 2-3 concrete, specific first steps a business could take based on the context.
                * **\`kpis_to_track\`:** List 2-3 specific, measurable KPIs relevant to monitoring the impact, ideally linked to receiver factors or the overall goal implied in the context.
            6.  **Self-Correction:** Before outputting JSON, meticulously check: Are factors derived solely from context? Are matrix values plausible? Are R, C, R+C, R-C calculated *correctly* based on T? Does the interpretation accurately classify dispatchers/receivers based on R-C values? Are recommendations (exactly 3) directly and logically linked ONLY to the calculated causal analysis and context? Fix all errors. Ensure JSON structure is perfect.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT GROUNDING:** Factors MUST derive *solely* from the context. Matrix values should be plausible based on implied relationships. Recommendations must link to context.
            - **METHOD ACCURACY:** Adhere to DEMATEL calculation logic (R, C, R+C, R-C derived strictly from T). Interpret roles based on calculated R-C.
            - **ACTIONABILITY & LINKAGE:** Recommendations must target specific factors based on their calculated causal role.
            - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys. Generate exactly 3 recommendations. Factor list length MUST match matrix dimensions and metrics array length.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below. Generate exactly 3 recommendations.**
            {
              "factors": ["Factor A", "Factor B", "Factor C", "Factor D", "Factor E"], // 5-7 factors from context
              "total_influence_matrix": [ // Simulated square matrix T, plausible positive values
                [0.10, 0.25, 0.30, 0.15, 0.20], // Row 1 influence ON others
                [0.40, 0.05, 0.15, 0.35, 0.25], // Row 2 influence ON others
                [0.35, 0.45, 0.08, 0.10, 0.32],
                [0.10, 0.20, 0.40, 0.06, 0.14],
                [0.20, 0.15, 0.25, 0.40, 0.09]
              ],
              "influence_metrics": [ // Calculated strictly from T; array length MUST match factors length
                {"factor": "Factor A", "r_sum": 1.00, "c_sum": 1.15, "prominence": 2.15, "relation": -0.15},
                {"factor": "Factor B", "r_sum": 1.20, "c_sum": 1.05, "prominence": 2.25, "relation": 0.15},
                {"factor": "Factor C", "r_sum": 1.30, "c_sum": 1.10, "prominence": 2.40, "relation": 0.20},
                {"factor": "Factor D", "r_sum": 0.90, "c_sum": 1.00, "prominence": 1.90, "relation": -0.10},
                {"factor": "Factor E", "r_sum": 1.09, "c_sum": 1.11, "prominence": 2.20, "relation": -0.02}
                 // ... for all factors, ensure calculations are correct based on T ...
              ],
              "analysis": {
                "summary": "Overall causal structure interpretation based on R+C / R-C values...", // Generated
                "dispatchers": [ // Factors with highest positive R-C
                    {"factor": "Factor C", "relation_value": 0.20, "reason": "Highest positive R-C indicates strongest net causal influence..."}
                    // Add others if R-C > 0 and relatively high
                ],
                "receivers": [ // Factors with lowest negative R-C
                    {"factor": "Factor A", "relation_value": -0.15, "reason": "Lowest negative R-C indicates primarily receiving influence..."}
                    // Add others if R-C < 0 and relatively low
                ],
                "key_factor": {"factor": "Factor C", "prominence_value": 2.40, "reason": "Highest R+C signifies most central role..."} // Factor with highest R+C
              },
              "business_recommendations": [ // Exactly 3 recommendations linked to analysis
                {
                  "recommendation": "Recommendation Title 1",
                  "focus_factor": "Targeted Factor Name (e.g., a Dispatcher)",
                  "rationale": "Why this action matters based on calculated R-C and summary...",
                  "action_items": ["Specific Step 1 based on context...", "Specific Step 2..."],
                  "kpis_to_track": ["Specific KPI 1 relevant to context...", "Specific KPI 2..."]
                },
                { // Rec 2
                  "recommendation": "Recommendation Title 2",
                  "focus_factor": "Targeted Factor Name",
                  "rationale": "Why this action matters based on calculated R-C and summary...",
                  "action_items": ["Specific Step 1 based on context...", "Specific Step 2..."],
                  "kpis_to_track": ["Specific KPI 1 relevant to context...", "Specific KPI 2..."]
                },
                { // Rec 3
                  "recommendation": "Recommendation Title 3",
                  "focus_factor": "Targeted Factor Name",
                  "rationale": "Why this action matters based on calculated R-C and summary...",
                  "action_items": ["Specific Step 1 based on context...", "Specific Step 2..."],
                  "kpis_to_track": ["Specific KPI 1 relevant to context...", "Specific KPI 2..."]
                }
              ]
            }
        `;

        // 3. Send Request to Ollama (using llama3.1 as per your function)
        console.log(`Sending ENHANCED NUMERICAL DEMATEL prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } }) // Added options for context window
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response:', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation (for numerical approach) ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Numerical DEMATEL) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             const nFactors = parsedData?.factors?.length || 0;
             const nRecs = parsedData?.business_recommendations?.length || 0;

             // Check basic structure and types
            if (!parsedData || typeof parsedData !== 'object') throw new Error("Response is not a valid object.");
            if (!Array.isArray(parsedData.factors) || nFactors < 3 || nFactors > 10) throw new Error(`Invalid or missing 'factors' array (length ${nFactors}).`);
            if (!Array.isArray(parsedData.total_influence_matrix) || parsedData.total_influence_matrix.length !== nFactors) throw new Error("Invalid or missing 'total_influence_matrix' or length mismatch.");
            if (!parsedData.total_influence_matrix.every(row => Array.isArray(row) && row.length === nFactors && row.every(val => typeof val === 'number'))) throw new Error("'total_influence_matrix' has incorrect structure or non-numeric values.");
            if (!Array.isArray(parsedData.influence_metrics) || parsedData.influence_metrics.length !== nFactors) throw new Error("Invalid or missing 'influence_metrics' or length mismatch.");
            if (nFactors > 0 && (typeof parsedData.influence_metrics[0] !== 'object' || typeof parsedData.influence_metrics[0].prominence !== 'number' || typeof parsedData.influence_metrics[0].relation !== 'number')) throw new Error("'influence_metrics' items lack required numeric fields.");
            if (typeof parsedData.analysis !== 'object' || !parsedData.analysis.summary || !Array.isArray(parsedData.analysis.dispatchers) || !Array.isArray(parsedData.analysis.receivers) || typeof parsedData.analysis.key_factor !== 'object') throw new Error("Invalid or missing 'analysis' structure.");
            if (!Array.isArray(parsedData.business_recommendations) || nRecs !== 3) throw new Error(`Invalid or missing 'business_recommendations' array or incorrect count (expected 3, got ${nRecs}).`);
            if (nRecs > 0 && (typeof parsedData.business_recommendations[0] !== 'object' || !parsedData.business_recommendations[0].focus_factor || !parsedData.business_recommendations[0].rationale)) throw new Error("'business_recommendations' items lack required fields.");

             console.log(`Successfully parsed ENHANCED NUMERICAL DEMATEL JSON using ${MODEL_NAME}. Found ${nFactors} factors, ${nRecs} recommendations.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED NUMERICAL DEMATEL JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced Numerical): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results (using the modified render function below)
        renderDematelAnalysisPage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleDematelAnalysis (Enhanced Numerical) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderDematelAnalysisPage(container, data) {
    container.innerHTML = ""; // Clear loading state

    // *** Validation for NUMERICAL data ***
    if (!data || !data.factors || !data.total_influence_matrix || !data.influence_metrics || !data.analysis || !data.business_recommendations ||
        data.factors.length !== data.total_influence_matrix.length || data.factors.length !== data.influence_metrics.length ||
        (data.influence_metrics.length > 0 && (typeof data.influence_metrics[0].prominence !== 'number' || typeof data.influence_metrics[0].relation !== 'number'))) // Check for numbers
    {
        console.error("Inconsistent or incomplete NUMERICAL data passed to renderDematelAnalysisPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete or inconsistent NUMERICAL analysis data received. Cannot render DEMATEL results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    const { factors, total_influence_matrix, influence_metrics, analysis, business_recommendations } = data;

    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    // Adding back 'Influence Matrix' and adding 'Recommendations' + 'Learn'
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="summary"> Summary & Insights</button>
        <button class="analysis-tab-btn" data-tab="diagram"> Causal Diagram</button>
        <button class="analysis-tab-btn" data-tab="metrics"> Influence Metrics</button>
        <button class="analysis-tab-btn" data-tab="matrix"> Total Influence Matrix</button>
        <button class="analysis-tab-btn" data-tab="rec"> Recommendations</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn DEMATEL</button>
    `;
    container.appendChild(tabNav);

    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    // Adding back matrix panel and adding rec + learn panels
    tabContent.innerHTML = `
        <div id="summaryPanel" class="analysis-tab-panel active"></div>
        <div id="diagramPanel" class="analysis-tab-panel"></div>
        <div id="metricsPanel" class="analysis-tab-panel"></div>
        <div id="matrixPanel" class="analysis-tab-panel"></div>
        <div id="recPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Render Summary Tab (Using NUMERICAL analysis data) ---
    const summaryPanel = $("summaryPanel");
    let summaryHtml = `<div class="p-4">
        <h3 class="text-2xl font-bold mb-4">Analysis Summary</h3>
        <blockquote class="p-4 rounded-lg bg-black/20 border-l-4 border-gray-500 mb-6 text-white/90 italic text-sm">${analysis.summary || "Summary unavailable."}</blockquote>`;

    summaryHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-blue-900/20 p-4 rounded border border-blue-500/50">
            <h4 class="text-xl font-semibold mb-3 text-blue-300">Dispatchers (Cause Factors)</h4>
            <p class="text-xs text-white/70 mb-3">Factors with high positive Relation (R-C), strongly influencing others.</p>
            ${analysis.dispatchers?.length > 0
                ? analysis.dispatchers.map( d => `
                    <div class="mb-3 text-sm">
                        <p class="font-bold">${d.factor} (R-C: ${d.relation_value?.toFixed(3) ?? 'N/A'})</p>
                        <p class="text-white/70 text-xs italic">${d.reason}</p>
                    </div>`).join("")
                : '<p class="text-sm italic text-white/60">(None clearly identified)</p>'
            }
        </div>
        <div class="bg-red-900/20 p-4 rounded border border-red-500/50">
            <h4 class="text-xl font-semibold mb-3 text-red-300">Receivers (Effect Factors)</h4>
            <p class="text-xs text-white/70 mb-3">Factors with high negative Relation (R-C), primarily influenced by others.</p>
             ${analysis.receivers?.length > 0
                ? analysis.receivers.map( r => `
                    <div class="mb-3 text-sm">
                        <p class="font-bold">${r.factor} (R-C: ${r.relation_value?.toFixed(3) ?? 'N/A'})</p>
                        <p class="text-white/70 text-xs italic">${r.reason}</p>
                    </div>`).join("")
                : '<p class="text-sm italic text-white/60">(None clearly identified)</p>'
            }
        </div>
    </div>`;

    if (analysis.key_factor) {
        summaryHtml += `<div class="mt-8 bg-yellow-900/20 p-4 rounded border border-yellow-500/50">
            <h4 class="text-xl font-semibold mb-3 text-yellow-300">Most Central Factor</h4>
            <p class="font-bold">${analysis.key_factor.factor} (Prominence: ${analysis.key_factor.prominence_value?.toFixed(3) ?? 'N/A'})</p>
            <p class="text-sm text-white/70 text-xs italic">${analysis.key_factor.reason}</p>
        </div>`;
    }
    summaryHtml += `</div>`; // Close p-4 div
    summaryPanel.innerHTML = summaryHtml;


    // --- 2. Render Causal Diagram Tab (Plotly R+C vs R-C - Numerical) ---
    const diagramPanel = $("diagramPanel");
    diagramPanel.innerHTML = `<div class="p-4">
         <h3 class="text-2xl font-bold mb-4 text-center">DEMATEL Causal Diagram</h3>
         <blockquote class="p-3 italic border-l-4 border-gray-500 bg-black/20 text-white/90 text-sm mb-6 max-w-3xl mx-auto">
             Plotting Prominence (R+C) vs. Relation (R-C) visualizes factor importance and causal role. Factors in the top right are central causes.
         </blockquote>
        <div id="dematelDiagramPlot" class="w-full h-[600px] plotly-chart bg-black/10 rounded-lg"></div>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 text-xs text-center">
             <div class="bg-blue-900/30 p-2 rounded border border-blue-500/50"><strong>Dispatchers (Causes):</strong> High positive R-C. Focus intervention here.</div>
             <div class="bg-red-900/30 p-2 rounded border border-red-500/50"><strong>Receivers (Effects):</strong> High negative R-C. Monitor impact here.</div>
             <div class="bg-yellow-900/30 p-2 rounded border border-yellow-500/50"><strong>Central Factor:</strong> Highest R+C (${analysis.key_factor?.factor || 'N/A'}). Most interconnected.</div>
        </div>
    </div>`;

    // Render Plotly Scatter Chart (using numerical R+C, R-C)
    try {
        const plotData = [{
            x: influence_metrics.map(m => m.prominence ?? 0), // R+C
            y: influence_metrics.map(m => m.relation ?? 0), // R-C
            text: influence_metrics.map(m => m.factor || 'N/A'),
            mode: 'markers+text',
            textposition: 'top right',
            marker: {
                size: 12,
                color: influence_metrics.map(m => m.relation ?? 0),
                colorscale: 'RdBu',
                colorbar: { title: 'Relation (R-C)<br>Cause -> Effect' }
            },
            type: 'scatter'
        }];

        const avgProminence = (influence_metrics.reduce((sum, m) => sum + (m.prominence ?? 0), 0)) / (influence_metrics.length || 1);
        const yRange = [Math.min(...plotData[0].y) - 0.1, Math.max(...plotData[0].y) + 0.1]; // Dynamic y-range

        const layoutDiagram = {
            title: 'DEMATEL Causal Diagram',
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
            xaxis: { title: 'Prominence (R+C) - Importance', gridcolor: 'rgba(255,255,255,0.1)', zeroline: false },
            yaxis: { title: 'Relation (R-C) - Net Causal Role', range: yRange, gridcolor: 'rgba(255,255,255,0.1)', zeroline: true, zerolinecolor: 'rgba(255,255,255,0.5)' },
             annotations: [
                { x: avgProminence, y: yRange[1], text: 'Dispatchers (Causes)', showarrow: false, xanchor: 'left', yanchor: 'top', font: {color: 'rgba(173, 216, 230, 0.7)'} },
                { x: avgProminence, y: yRange[0], text: 'Receivers (Effects)', showarrow: false, xanchor: 'left', yanchor: 'bottom', font: {color: 'rgba(255, 182, 193, 0.7)'} }
             ],
            hovermode: 'closest',
            margin: { t: 50, b: 60, l: 60, r: 30 }
        };
        Plotly.newPlot('dematelDiagramPlot', plotData, layoutDiagram, { responsive: true });
    } catch(e) {
        console.error("Error creating DEMATEL Plotly chart:", e);
        $("dematelDiagramPlot").innerHTML = "<p class='p-4 text-center text-red-400'>Could not render causal diagram.</p>";
    }


    // --- 3. Render Influence Metrics Tab (Numerical) ---
    const metricsPanel = $("metricsPanel");
    let metricsHtml = `<div class="p-4">
        <h3 class="text-2xl font-bold mb-4">Influence Metrics</h3>
         <p class="text-sm text-white/70 mb-6 italic">These metrics quantify the influence dispatched (R), received (C), total involvement (Prominence R+C), and net causal role (Relation R-C) for each factor.</p>
        <div class="overflow-x-auto mb-6">
            <table class="coeff-table styled-table text-sm">
                <thead><tr>
                    <th>Factor</th>
                    <th title="Total influence dispatched by this factor">Dispatch (R)</th>
                    <th title="Total influence received by this factor">Receive (C)</th>
                    <th title="Total involvement (importance)">Prominence (R+C)</th>
                    <th title="Net causal role (+ = Cause, - = Effect)">Relation (R-C)</th>
                </tr></thead>
                <tbody>`;
    // Sort by Prominence (numerical)
    influence_metrics.sort((a,b) => (b.prominence ?? 0) - (a.prominence ?? 0)).forEach(m => {
        let relationClass = '';
        const relationVal = m.relation ?? 0;
        if (relationVal > 0.01) relationClass = 'text-blue-300'; // Threshold for dispatcher color
        else if (relationVal < -0.01) relationClass = 'text-red-300'; // Threshold for receiver color

        metricsHtml += `<tr>
                        <td class="font-semibold">${m.factor || 'N/A'}</td>
                        <td>${m.r_sum?.toFixed(3) ?? 'N/A'}</td>
                        <td>${m.c_sum?.toFixed(3) ?? 'N/A'}</td>
                        <td>${m.prominence?.toFixed(3) ?? 'N/A'}</td>
                        <td class="${relationClass} font-medium">${m.relation?.toFixed(3) ?? 'N/A'}</td>
                    </tr>`;
    });
    metricsHtml += `</tbody></table></div>`;
    metricsHtml += `</div>`; // Close p-4 div
    metricsPanel.innerHTML = metricsHtml;


    // --- 4. Render Total Influence Matrix Tab (Heatmap - Numerical) ---
    const matrixPanel = $("matrixPanel");
    matrixPanel.innerHTML = `<div class="p-4">
        <h3 class="text-2xl font-bold mb-4">Total Influence Matrix (T)</h3>
        <p class="text-sm text-white/70 mb-4 italic">Heatmap showing the total direct and indirect influence of the row factor ON the column factor. Brighter colors indicate stronger influence.</p>
        <div id="dematelMatrixHeatmap" class="w-full h-[600px] plotly-chart bg-black/10 rounded-lg"></div>
    </div>`;

    // Render Plotly Heatmap
    try {
        const heatmapTrace = {
            z: data.total_influence_matrix,
            x: data.factors,
            y: data.factors,
            type: 'heatmap',
            colorscale: 'Plasma', // Or 'Viridis', 'Jet', 'Portland'
            reversescale: false, // Adjust as needed
            hovertemplate: "Influencer (Row): %{y}<br>Influenced (Col): %{x}<br>Total Influence: %{z:.3f}<extra></extra>",
            text: data.total_influence_matrix.map(row => row.map(val => val.toFixed(2))),
            textfont: { color: "white", size: 9 }, // Smaller font size
            texttemplate: "%{text}",
            showscale: true,
            colorbar: { title: 'Total Influence', titleside: 'right' }
        };
        const layoutMatrix = {
            title: { text: 'Total Influence Matrix (T)', y: 0.98 },
            xaxis: { ticks: "", side: "top", automargin: true, tickangle: -45 },
            yaxis: { ticks: "", automargin: true },
            margin: { l: 150, t: 150, b: 50, r: 50 }, // Adjusted margins
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }
        };
        Plotly.newPlot('dematelMatrixHeatmap', [heatmapTrace], layoutMatrix, { responsive: true });
    } catch (e) {
        console.error("Error creating DEMATEL Heatmap:", e);
        $("dematelMatrixHeatmap").innerHTML = "<p class='p-4 text-center text-red-400'>Could not render influence matrix heatmap.</p>";
    }

    // --- 5. Populate Recommendations Panel (using enhanced rationale) ---
    const recPanel = $("recPanel");
    let recHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Actionable Recommendations</h3>`;
    if (business_recommendations && business_recommendations.length > 0) {
        recHtml += `<p class="text-sm text-white/70 mb-6 italic">These recommendations focus on leveraging the calculated causal structure (influencing Dispatchers, managing Receivers) to achieve strategic goals implied in the context.</p>`;
        recHtml += `<div class="space-y-6">`;
        business_recommendations.forEach((rec, index) => {
             // Determine if targeting dispatcher or receiver for styling based on NUMERICAL R-C
             let targetRole = "Neutral";
             const metric = influence_metrics.find(m => m.factor === rec.focus_factor);
             const relationVal = metric?.relation ?? 0;
             if (relationVal > 0.01) targetRole = "Dispatcher";
             else if (relationVal < -0.01) targetRole = "Receiver";

             let cardBorderClass = "border-gray-500";
             if (targetRole === "Dispatcher") cardBorderClass = "border-blue-500";
             else if (targetRole === "Receiver") cardBorderClass = "border-red-500";


            recHtml += `
                <div class="prescription-card border-l-4 ${cardBorderClass}">
                    <h4 class="text-xl font-bold">${index + 1}. ${rec.recommendation ?? 'N/A'}</h4>
                     <p class="text-xs font-semibold my-1 text-indigo-300">TARGET FACTOR: ${rec.focus_factor ?? 'N/A'} (${targetRole}, R-C: ${relationVal.toFixed(3)})</p>
                    <p class="rationale"><strong>Strategic Rationale:</strong> ${rec.rationale ?? 'N/A'}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-yellow-300 mb-2">Action Items</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90">${(rec.action_items || []).map(a => `<li>${a}</li>`).join("")}</ul>
                             ${!(rec.action_items && rec.action_items.length > 0) ? '<p class="text-white/60 italic text-xs">No specific action items defined.</p>' : ''}
                        </div>
                        <div class="bg-black/20 p-3 rounded">
                             <h5 class="font-bold text-yellow-300 mb-2">KPIs to Track</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90 text-xs">${(rec.kpis_to_track || []).map(k => `<li>${k}</li>`).join("")}</ul>
                             ${!(rec.kpis_to_track && rec.kpis_to_track.length > 0) ? '<p class="text-white/60 italic text-xs">No specific KPIs defined.</p>' : ''}
                        </div>
                    </div>
                </div>`;
        });
        recHtml += `</div>`;
    } else {
        recHtml += `<p class="text-center text-white/70 italic">No specific business recommendations generated based on the DEMATEL analysis.</p>`;
    }
    recHtml += `</div>`;
    recPanel.innerHTML = recHtml;


    // --- 6. Populate Learn DEMATEL Tab (Keep as is) ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding DEMATEL</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is DEMATEL?</h4>
            <p class="text-sm text-white/80">The Decision Making Trial and Evaluation Laboratory (DEMATEL) method is a structural modeling technique used to analyze the causal relationships among complex factors. It helps visualize the structure of intricate systems and identify the most influential elements.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Core Concepts:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Factors:</strong> The key elements or variables within the system being studied.</li>
                    <li><strong>Direct Influence:</strong> The immediate impact one factor has on another (often rated by experts).</li>
                    <li><strong>Total Influence (Matrix T):</strong> Captures both direct and indirect influences between all pairs of factors.</li>
                    <li><strong>Dispatch (R):</strong> The sum of influences a factor exerts on *all other* factors (Row Sum of T). High R = Influential Cause.</li>
                    <li><strong>Receive (C):</strong> The sum of influences a factor receives from *all other* factors (Column Sum of T). High C = Easily Influenced Effect.</li>
                    <li><strong>Prominence (R+C):</strong> The total involvement of a factor (sum of influences dispatched and received). High R+C = Central/Important.</li>
                    <li><strong>Relation (R-C):</strong> The net causal role. High positive R-C = Net Cause ("Dispatcher"). High negative R-C = Net Effect ("Receiver").</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Interpretation of Causal Roles:</h4>
                <p class="text-sm mb-2">Analysis typically categorizes factors based on Prominence (Importance) and Relation (Net Cause/Effect):</p>
                 <ul class="list-[circle] list-inside pl-4 text-xs mb-3 space-y-1">
                    <li><strong>Dispatchers (Causes):</strong> Have high positive Relation (R-C). These factors significantly influence others. Interventions targeting dispatchers tend to have widespread effects.</li>
                    <li><strong>Receivers (Effects):</strong> Have high negative Relation (R-C). These factors are primarily influenced by others. They are good indicators of system performance but less effective points for direct intervention.</li>
                    <li><strong>Central Factors:</strong> Have high Prominence (R+C). These are highly interconnected factors, playing a key role in the system's dynamics, whether as causes or effects.</li>
                 </ul>
                 <p class="text-sm mt-3"><strong>Strategic Focus:</strong> Identify the key Dispatchers to understand root causes and leverage points for change. Monitor Receivers to track the impact of interventions.</p>
            </div>
        </div>

        <details class="styled-details text-sm mt-4">
            <summary class="font-semibold">DEMATEL Steps (Simplified)</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                <p>1. Identify key factors.</p>
                <p>2. Create a Direct-Influence Matrix (Z) - often through expert surveys rating influence between pairs (e.g., 0-4 scale).</p>
                <p>3. Normalize the Direct-Influence Matrix (X).</p>
                <p>4. Calculate the Total-Influence Matrix (T = X * (I - X)^-1).</p>
                <p>5. Calculate R (row sums) and C (column sums) from T.</p>
                <p>6. Calculate Prominence (R+C) and Relation (R-C) for each factor.</p>
                <p>7. Analyze R+C and R-C to understand causal structure (e.g., using a causal diagram).</p>
                <p>8. Develop strategies based on dispatcher/receiver roles.</p>
            </div>
        </details>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (copied from your provided function)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
            e.target.classList.add("active");
            const targetPanel = $(e.target.dataset.tab + "Panel");
            targetPanel.classList.add("active");
            // Resize BOTH potential charts when switching tabs
            const diagramChart = targetPanel.querySelector('#dematelDiagramPlot');
            const matrixChart = targetPanel.querySelector('#dematelMatrixHeatmap');
            if (diagramChart && diagramChart.layout && typeof Plotly !== 'undefined') {
                try { Plotly.Plots.resize(diagramChart); } catch (err) { console.error("Resize err (Diagram):", err); }
            }
            if (matrixChart && matrixChart.layout && typeof Plotly !== 'undefined') {
                 try { Plotly.Plots.resize(matrixChart); } catch (err) { console.error("Resize err (Matrix):", err); }
            }
        }
    });

     // Attempt initial resize for chart in the default active tab (summaryPanel - no chart)
     // Attempt initial resize for charts in DIAGRAM and MATRIX tabs after a short delay
     setTimeout(() => {
         const initialDiagramChart = $('dematelDiagramPlot');
         const initialMatrixChart = $('dematelMatrixHeatmap');
         if (initialDiagramChart && initialDiagramChart.layout && typeof Plotly !== 'undefined') {
             try { Plotly.Plots.resize(initialDiagramChart); } catch (err) { console.error("Initial Resize err (Diagram):", err); }
         }
         if (initialMatrixChart && initialMatrixChart.layout && typeof Plotly !== 'undefined') {
             try { Plotly.Plots.resize(initialMatrixChart); } catch (err) { console.error("Initial Resize err (Matrix):", err); }
         }
     }, 150);


    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}   
    // =========================================================================
    // ===== VISUALIZATION & RENDERING FUNCTIONS (FOR SEM)                =====
    // =========================================================================

/**
 * Sets up the tab structure for SEM results ('Estimates', 'Model Fit', 'Effects', 'Diagnostics', 'Comparison', 'Diagram', 'Learn SEM').
 * Calls specific functions to render content into each tab panel.
 * @param {HTMLElement} container - The main container element for results.
 * @param {object} data - Data from the backend (contains CSV strings, DOT string, or error).
 */
function renderSemAnalysisPage(container, data) {
    container.innerHTML = ""; // Clear previous content or loading indicator

    // --- Create Tab Navigation (Added Comparison Tab) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="results"> Estimates</button>
        <button class="analysis-tab-btn" data-tab="fit"> Model Fit</button>
        <button class="analysis-tab-btn" data-tab="effects"> Effects</button>
        <button class="analysis-tab-btn" data-tab="diagnostics"> Diagnostics</button>
        <button class="analysis-tab-btn" data-tab="comparison"> Comparison</button>
        <button class="analysis-tab-btn" data-tab="diagram"> Path Diagram</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn SEM</button>
       `;
    container.appendChild(tabNav);

    // --- Create Tab Content Panels (Added Comparison Panel) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="resultsPanel" class="analysis-tab-panel active p-6"></div>
        <div id="fitPanel" class="analysis-tab-panel p-6"></div>
        <div id="effectsPanel" class="analysis-tab-panel p-6"></div>
        <div id="diagnosticsPanel" class="analysis-tab-panel p-6"></div>
        <div id="comparisonPanel" class="analysis-tab-panel p-6"></div>
        <div id="diagramPanel" class="analysis-tab-panel p-6"></div>
        <div id="learnPanel" class="analysis-tab-panel p-6"></div>
       `;

    // --- Render Content into Panels (Added call to renderSemComparisonTab) ---
    renderSemResultsTab("resultsPanel", data);      // Render parameter estimates
    renderSemFitTab("fitPanel", data);              // Render fit statistics
    renderSemEffectsTab("effectsPanel");            // Render effects explanation
    renderSemDiagnosticsTab("diagnosticsPanel", data.warnings); // Render diagnostics info
    renderSemComparisonTab("comparisonPanel");      // --- NEW --- Render model comparison explanation
    renderSemDiagramTab("diagramPanel", data.path_diagram_dot);
    renderLearnSemTab("learnPanel");                // Render general SEM info

    // --- Cache and Display Actions ---
    analysisCache[currentTemplateId] = container.innerHTML;
    const actionsEl = $("analysisActions");
    if (actionsEl) actionsEl.classList.remove("hidden");

    // --- Add Tab Switching Logic (No change needed here) ---
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON" && !e.target.classList.contains('active')) {
            // Deactivate all buttons and panels
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate the clicked button and corresponding panel
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");

                // Optional: Resize Plotly charts
                const chart = targetPanel.querySelector(".plotly-chart");
                if (chart && typeof Plotly !== 'undefined') {
                    try { Plotly.Plots.resize(chart); } catch (resizeError) { console.error("Plotly resize error:", resizeError); }
                }

                // Resize/fit viz.js diagram
                 const svgContainer = targetPanel.querySelector("svg");
                 if (svgContainer && targetPanelId === 'diagramPanel') {
                     // No specific resize needed for viz.js SVG
                 }
            }
        }
    });
}

/**
 * --- UPDATED FUNCTION (using viz.js) ---
 * Renders the SEM Path Diagram from a DOT string, including an explanatory section.
 * @param {string} containerId - The ID of the HTML element to render into.
 * @param {string} dotString - The pre-styled DOT language string from the backend.
 */
function renderSemDiagramTab(containerId, dotString) {
    const container = $(containerId);
    if (!container) return;

    // --- Start HTML with the Explanation ---
    let html = `
        <div class="mb-8 bg-green-900/20 p-6 rounded-lg border border-green-500/30">
            <h4 class="text-2xl font-bold mb-4 text-green-300"> Understanding the Path Diagram</h4>
            <p class="text-white/80 mb-4">This diagram visually represents the relationships in your SEM model. Here's how to interpret it:</p>
            <ul class="list-none space-y-3 text-white/90">
                <li class="flex items-start">
                    <span class="font-bold w-40 shrink-0">Shapes:</span>
                    <span><strong>Ellipses/Circles</strong> represent latent (unobserved) variables (e.g., 'Marketing'). <strong>Rectangles</strong> represent observed variables (your actual data columns).</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold w-40 shrink-0">Arrows:</span>
                    <span><strong>Single-headed arrows ()</strong> show hypothesized causal paths (regressions or factor loadings). The variable the arrow points *to* is predicted by the variable it comes *from*.</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-40 shrink-0">Numbers on Arrows:</span>
                    <span>These are the **standardized path coefficients (estimates)** showing the strength and direction of the relationship. Below them is the **p-value**, indicating statistical significance (typically p < 0.05 means significant).</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-40 shrink-0">Layout:</span>
                    <span>The arrangement (Top-to-Bottom) helps visualize the flow of influence based on your model specification.</span>
                </li>
            </ul>
        </div>
        <hr class="border-white/20 my-6">
        <h3 class="text-2xl font-bold mb-4">Your Model's Path Diagram</h3>
    `; // Added title for the diagram itself

    // --- Check for the Viz.js library ---
    console.log("--- Checking libraries inside renderSemDiagramTab ---");
    console.log("typeof Viz:", typeof Viz);
    
    if (typeof Viz === 'undefined') {
        console.error("Viz.js is not loaded.");
        html += `
            <div class="p-4">
                <p class="text-red-400"><strong>Error:</strong> Visualization library not loaded. (Viz is undefined)</p>
                {/* ... (rest of the library error message) ... */}
            </div>`;
        container.innerHTML = html; // Show explanation and error
        return;
    }

    // Check for the DOT string
    if (!dotString) {
        html += `<p class="text-yellow-400 p-4">Path diagram data is not available. This can happen if the model failed to fit or if diagram generation failed on the server.</p>`;
        container.innerHTML = html; // Show explanation and warning
        return;
    }

    // Add placeholder for the diagram rendering
    const graphId = "semGraphContainer_" + containerId;
    html += `<div id="${graphId}" class="w-full h-full min-h-[500px] flex justify-center items-center"><div class="text-white/70 p-8 text-center">Rendering path diagram...</div></div>`;
    container.innerHTML = html; // Set initial HTML including explanation and placeholder

    // --- Render the diagram into the placeholder ---
    try {
        const viz = new Viz();
        const graphContainer = $(graphId); // Get the placeholder div

        viz.renderSVGElement(dotString)
            .then(function (svgElement) {
                // --- Success ---
                if (graphContainer) { // Check if container still exists
                    graphContainer.innerHTML = ""; // Clear "Rendering..." text
                    
                    svgElement.style.width = "100%";
                    svgElement.style.height = "100%";
                    // No styling needed as it comes pre-styled from backend

                    graphContainer.appendChild(svgElement);
                }
            })
            .catch(function (error) {
                // --- Render Error ---
                console.error("Viz.js rendering error:", error);
                 if (graphContainer) { // Check if container still exists
                    graphContainer.innerHTML = `<p class="text-red-400 p-4"><strong>Error rendering path diagram:</strong> ${error.message || 'Unknown error'}</p>`;
                 }
            });
    } catch (error) {
        // --- Initialization Error ---
        console.error("Error initializing Viz.js:", error);
         const graphContainer = $(graphId);
         if (graphContainer) {
            graphContainer.innerHTML = `<p class="text-red-400 p-4"><strong>Error initializing path diagram:</strong> ${error.message}</p>`;
         }
    }
}

/**
 * --- UPDATED FUNCTION ---
 * Parses CSV data for fit indices, adds explanatory text, and renders them.
 * @param {string} containerId - The ID of the HTML element to render into.
 * @param {object} data - Backend response containing 'fit_indices_csv_content' or an 'error'.
 */
function renderSemFitTab(containerId, data) {
    const container = $(containerId);
    if (!container) return;

    // --- Start HTML with the Explanation ---
    let html = `
        <div class="mb-8 bg-indigo-900/20 p-6 rounded-lg border border-indigo-500/30">
            <h4 class="text-2xl font-bold mb-4 text-indigo-300"> Assessing Model Fit</h4>
            <p class="text-white/80 mb-4">These statistics check how well your theoretical model matches the actual structure of your data. Look at multiple indices together:</p>
            <ul class="list-none space-y-3 text-white/90">
                <li class="flex items-start">
                    <span class="font-bold w-28 shrink-0">Chi-Square ():</span>
                    <span>Tests exact fit. A **non-significant p-value (> 0.05)** suggests good fit (model matches data), but it's sensitive to large samples.</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold w-28 shrink-0">CFI / TLI:</span>
                    <span>Compare your model to a baseline. ** 0.95 is good fit.**</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-28 shrink-0">RMSEA:</span>
                    <span>Error per degree of freedom. ** 0.06 is good fit**,  0.08 is acceptable.</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-28 shrink-0">SRMR:</span>
                    <span>Average residual correlation. ** 0.08 is good fit.**</span>
                </li>
            </ul>
        </div>
        <hr class="border-white/20 my-6">
        <h3 class="text-2xl font-bold mb-4">Your Model's Fit Indices</h3>
    `; // Added title for the results grid

    // --- Now add the results grid (or error message) ---
    if (data.error) {
        html += `<p class="text-red-400 p-4"><strong>Analysis Error prevented fit calculation:</strong> ${data.error}</p>`;
    } else if (typeof data.fit_indices_csv_content !== 'string') {
        html += `<p class="text-yellow-400 p-4">Warning: Model fit indices are missing or invalid in the backend response.</p>`;
        console.warn("Missing/invalid fit_indices_csv_content:", data);
    } else {
        try {
            if (typeof Papa === 'undefined') {
                 throw new Error("PapaParse library is not loaded.");
            }
            const fitIndicesConfig = { header: true, skipEmptyLines: true, dynamicTyping: true };
            const fitIndicesResult = Papa.parse(data.fit_indices_csv_content, fitIndicesConfig);

            if (fitIndicesResult.errors.length > 0) throw new Error(`Error parsing fit indices CSV: ${fitIndicesResult.errors[0].message}`);

            const fitIndices = fitIndicesResult.data.length > 0 ? fitIndicesResult.data[0] : {};

            html += renderFitIndices(fitIndices); // Use helper for fit indices grid

            // Add warnings related to fit if any exist
            if (data.warnings) {
                html += `<h4 class="text-lg font-semibold mt-6 mb-2">Warnings:</h4><ul class="list-disc list-inside text-yellow-300 text-sm">`;
                for (const key in data.warnings) {
                     html += `<li><strong>${key.replace(/_/g, ' ')}:</strong> ${data.warnings[key]}</li>`;
                }
                 html += `</ul>`;
            }
        } catch (error) {
            console.error("Error displaying SEM fit indices:", error);
            html += `<p class="text-red-400 p-4"><strong>Error displaying fit indices:</strong> ${error.message}</p>`;
        }
    }

    container.innerHTML = html; // Set the final HTML for the tab
}

/**
 * --- UPDATED FUNCTION ---
 * Renders the SEM parameter estimates tab, including an explanation,
 * variable lists, and the main estimates table.
 * @param {string} containerId - The ID of the HTML element to render into.
 * @param {object} data - Backend response containing estimates, fit indices, variables, or an 'error'.
 */
function renderSemResultsTab(containerId, data) {
    const container = $(containerId);
    if (!container) return; // Exit if container not found

    // --- Start HTML with the Explanation ---
    let html = `
        <div class="mb-8 bg-blue-900/20 p-6 rounded-lg border border-blue-500/30">
            <h4 class="text-2xl font-bold mb-4 text-blue-300"> Understanding Parameter Estimates</h4>
            <p class="text-white/80 mb-4">This table shows the calculated strength and significance of each relationship (path) in your model. Key columns include:</p>
            <ul class="list-none space-y-3 text-white/90 text-sm">
                <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">lval / rval:</span>
                    <span>The left-hand and right-hand variables involved in the relationship.</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">op:</span>
                    <span>The operator defining the relationship type: <code>=~</code> (measurement/loading), <code>~</code> (regression/path), <code>~~</code> (variance/covariance).</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">Estimate:</span>
                    <span>The calculated **standardized path coefficient**. It indicates the strength and direction of the relationship in standard deviation units (e.g., a 1 SD change in predictor leads to X SD change in outcome). **Makes effects comparable** across different paths.</span>
                 </li>
                 <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">Std. Err:</span>
                    <span>The standard error of the estimate, indicating its precision (lower is better).</span>
                 </li>
                 <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">z-value:</span>
                    <span>The estimate divided by its standard error. Used to test significance.</span>
                 </li>
                 <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">p-value:</span>
                    <span>The probability of observing the relationship if there were truly no effect. A **p-value < 0.05** is typically considered statistically significant, suggesting the relationship is unlikely due to chance.</span>
                </li>
            </ul>
             <p class="text-xs text-white/60 mt-4"><em>(Note: These estimates are standardized because the input data was scaled before analysis.)</em></p>
        </div>
        <hr class="border-white/20 my-6">
    `;
    // --- END MODIFIED SECTION ---

    // Display error message if present in data
    if (data.error) {
        html += `<p class="text-red-400 p-4"><strong>Analysis Error:</strong> ${data.error}</p>`;
        container.innerHTML = html; // Show explanation and error
        return;
    }

    // Display Observed and Latent Variables
    if (data.model_variables) {
        const observedVars = data.model_variables.observed || [];
        const latentVars = data.model_variables.latent || [];

        html += `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/30">
                    <h4 class="text-lg font-semibold mb-2 text-blue-300">Observed Variables (${observedVars.length})</h4>
                    <p class="text-xs text-white/70 break-words">${observedVars.join(', ') || 'None'}</p>
                </div>
                <div class="bg-purple-900/20 p-4 rounded-lg border border-purple-500/30">
                    <h4 class="text-lg font-semibold mb-2 text-purple-300">Latent Variables (${latentVars.length})</h4>
                    <p class="text-xs text-white/70 break-words">${latentVars.join(', ') || 'None'}</p>
                </div>
            </div>
            <hr class="border-white/20 my-6">
        `;
    }

    // Validate estimates CSV content
    if (typeof data.estimates_csv_content !== 'string') {
        html += `<p class="text-yellow-400 p-4">Warning: SEM parameter estimates are incomplete or missing.</p>`;
        console.warn("Missing/invalid estimates_csv_content:", data);
        container.innerHTML = html; // Show explanation, variables, and warning
        return;
    }

    try {
        // --- Parse Estimates CSV Data ---
        if (typeof Papa === 'undefined') {
             throw new Error("PapaParse library is not loaded.");
        }
        const estimatesConfig = { header: true, skipEmptyLines: true, dynamicTyping: true };
        const estimatesResult = Papa.parse(data.estimates_csv_content, estimatesConfig);
        if (estimatesResult.errors.length > 0) throw new Error(`Error parsing estimates CSV: ${estimatesResult.errors[0].message}`);
        const estimates = estimatesResult.data;

        // --- Build HTML Output for Estimates Table ---
        html += `<h3 class="text-2xl font-bold mb-4">Parameter Estimates Table</h3>`; // Added 'Table' to title
        html += renderHtmlTable(estimates); // Use helper for estimates table

        container.innerHTML = html; // Set the final combined HTML

    } catch (error) { // Catch errors during parsing or rendering helpers
        console.error("Error displaying SEM results:", error);
        // Append error message to existing HTML
        html += `<p class="text-red-400 p-4"><strong>Error displaying estimate results:</strong> ${error.message}</p>`;
        container.innerHTML = html;
    }
}

/**
 * --- NEW FUNCTION ---
 * Renders the explanation for Total, Direct, and Indirect Effects (Mediation).
 * @param {string} containerId - The ID of the HTML element to render into.
 */
function renderSemEffectsTab(containerId) {
    const container = $(containerId);
    if (!container) return;

    container.innerHTML = `
        <div class="bg-teal-900/20 p-6 rounded-lg border border-teal-500/30">
            <h4 class="text-2xl font-bold mb-4 text-teal-300"> Total, Direct & Indirect Effects (Mediation)</h4>
            <p class="text-white/80 mb-4">When a variable (X) influences another variable (Y) *through* an intermediate variable (M), this is called **mediation**. Analyzing effects helps understand these pathways:</p>
            <ul class="list-none space-y-3 text-white/90 text-sm mb-6">
                <li class="flex items-start">
                    <span class="font-bold w-32 shrink-0">Direct Effect:</span>
                    <span>The influence of X directly on Y, ignoring any mediators (e.g., the path X  Y).</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold w-32 shrink-0">Indirect Effect(s):</span>
                    <span>The influence of X on Y that flows *through* one or more mediators (M). Calculated by multiplying the path coefficients along the indirect route (e.g., X  M * M  Y).</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-32 shrink-0">Total Effect:</span>
                    <span>The overall impact of X on Y, combining both the direct and all indirect effects. (Total = Direct + Indirect).</span>
                </li>
            </ul>

            <h5 class="font-semibold text-lg mb-2 text-teal-300">Example Decomposition:</h5>
            <pre class="bg-black/20 p-4 rounded text-sm text-white/90 mb-4 whitespace-pre-wrap">
Marketing  Profit
 Direct Effect:         -0.026 (non-significant)
 Indirect via Online_Sales: 0.318
 Indirect via Retail_Sales: -0.009
 TOTAL Effect:           0.309 

Proportion Mediated: 100% (complete mediation because direct is non-sig.)</pre>

            <h5 class="font-semibold text-lg mb-2 text-teal-300">What it Tells You:</h5>
             <ul class="list-disc list-inside text-white/80 space-y-1 text-sm">
                 <li><strong>How much** of the effect is direct vs. mediated through other variables.</li>
                 <li>The **actual total impact** of a predictor on an outcome, which is often crucial for business decisions.</li>
                 <li>Helps validate (or refute) your **mediation story**  does the intermediate variable truly act as a pathway?</li>
            </ul>
             <p class="text-xs text-white/60 mt-4"><em>(Note: Calculating these effects often requires specific commands or post-estimation analysis in SEM software. They are derived from the standard path estimates.)</em></p>
        </div>
    `;
}

/**
 * --- NEW FUNCTION ---
 * Renders diagnostic information, focusing on warnings like high correlation.
 * @param {string} containerId - The ID of the HTML element to render into.
 * @param {object | null} warnings - The warnings object from the backend response, or null if none.
 */
function renderSemDiagnosticsTab(containerId, warnings) {
    const container = $(containerId);
    if (!container) return;

    let html = `<h3 class="text-2xl font-bold mb-4"> Model Diagnostics & Warnings</h3>`;

    if (!warnings || Object.keys(warnings).length === 0) {
        html += `<div class="p-4 rounded-lg bg-green-900/20 border border-green-500/30 text-green-300">
                    <p> No major warnings detected during the analysis.</p>
                 </div>`;
        container.innerHTML = html;
        return;
    }

    // --- Display High Correlation Warning Specifically ---
    if (warnings.high_correlation) {
        html += `
            <div class="mb-6 bg-yellow-900/30 p-6 rounded-lg border border-yellow-500/30">
                <h4 class="text-xl font-bold mb-3 text-yellow-300">High Correlation Detected (Multicollinearity Warning)</h4>
                <p class="text-white/80 mb-2">The analysis found very high correlations (typically > 0.85 or 0.90) between some of your observed variables:</p>
                <pre class="bg-black/20 p-3 rounded text-sm text-yellow-200 mb-4 whitespace-pre-wrap">${warnings.high_correlation}</pre>
                <h5 class="font-semibold mb-1 text-white/90">Potential Issues:</h5>
                <ul class="list-disc list-inside text-white/80 space-y-1 text-sm mb-3">
                    <li><strong>Unstable Estimates:</strong> Path coefficients (Estimates) might change drastically with small data changes.</li>
                    <li><strong>Inflated Standard Errors:</strong> This can make it harder to find statistically significant relationships (higher p-values), even if a real effect exists.</li>
                    <li><strong>Interpretation Difficulty:</strong> It's hard to isolate the unique effect of one highly correlated variable from the other.</li>
                </ul>
                <h5 class="font-semibold mb-1 text-white/90">Possible Actions:</h5>
                 <ul class="list-disc list-inside text-white/80 space-y-1 text-sm">
                    <li><strong>Review Theory:</strong> Do these variables measure very similar concepts? Is it expected?</li>
                    <li><strong>Combine Variables:</strong> If theoretically sound, consider creating a composite score or factor from the highly correlated variables.</li>
                    <li><strong>Remove Variable(s):</strong> If two variables are redundant, consider removing one, but only if justified by theory (don't remove just to fix the statistic).</li>
                    <li><strong>Acknowledge Limitation:</strong> If removal/combination isn't appropriate, report the high correlation as a limitation when interpreting the results.</li>
                </ul>
            </div>
        `;
    }

    // --- Display Other Warnings ---
    html += `<h4 class="text-xl font-semibold mt-6 mb-3">Other Warnings:</h4>`;
    let otherWarningsFound = false;
    for (const key in warnings) {
        if (key !== 'high_correlation') { // Skip the one we already handled
             otherWarningsFound = true;
             html += `<div class="mb-4 p-4 rounded-lg bg-red-900/20 border border-red-500/30">
                        <h5 class="font-bold text-red-300">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</h5>
                        <p class="text-white/80 text-sm">${warnings[key]}</p>
                      </div>`;
        }
    }

    if (!otherWarningsFound) {
        html += `<p class="text-white/70 text-sm italic">No other specific warnings were generated.</p>`;
    }

    container.innerHTML = html;
}

/**
 * --- NEW FUNCTION ---
 * Renders the explanation for Model Comparison in SEM.
 * @param {string} containerId - The ID of the HTML element to render into.
 */
function renderSemComparisonTab(containerId) {
    const container = $(containerId);
    if (!container) return;

    container.innerHTML = `
        <div class="bg-orange-900/20 p-6 rounded-lg border border-orange-500/30">
            <h4 class="text-2xl font-bold mb-4 text-orange-300"> Comparing Alternative Models</h4>
            <p class="text-white/80 mb-4">Often, there isn't just one single "correct" model. Theory might suggest several plausible ways variables relate. Model comparison helps you determine which specified model best fits your data among a set of alternatives.</p>

            <h5 class="font-semibold text-lg mb-2 text-orange-300">Why Compare Models?</h5>
            <ul class="list-disc list-inside text-white/80 space-y-1 text-sm mb-4">
                <li><strong>Test Competing Theories:</strong> See which theoretical structure is better supported by the data.</li>
                <li><strong>Assess Mediation/Moderation:</strong> Compare a model with mediation paths to one without, or test different moderation effects.</li>
                <li><strong>Improve Parsimony:</strong> Determine if adding or removing paths significantly improves or worsens model fit relative to the change in complexity.</li>
                <li><strong>Refine Understanding:</strong> Explore nuances in relationships by testing slightly different model specifications.</li>
            </ul>

            <h5 class="font-semibold text-lg mb-2 text-orange-300">Common Comparison Methods:</h5>
            <ul class="list-disc list-inside text-white/80 space-y-1 text-sm mb-4">
                <li><strong>Nested Model Comparison (Chi-Square Difference Test):</strong> Used when one model is a simpler version of another (e.g., Model B is Model A with some paths removed). A significant Chi-Square difference suggests the more complex model fits significantly better.</li>
                <li><strong>Information Criteria (AIC, BIC):</strong> Used for comparing non-nested models (models that aren't subsets of each other). The model with the **lower** AIC or BIC value is generally preferred, balancing fit and complexity. BIC penalizes complexity more heavily.</li>
                <li><strong>Comparing Fit Indices:</strong> While not a formal test, you can compare indices like CFI, TLI, RMSEA across models. Look for meaningful improvements in fit alongside theoretical justification.</li>
            </ul>

            <h5 class="font-semibold text-lg mb-2 text-orange-300">How to Do It Here:</h5>
            <p class="text-white/80 text-sm">Currently, this tool runs one model at a time. To compare models:</p>
            <ol class="list-decimal list-inside text-white/80 space-y-1 text-sm">
                <li>Run your first model specification and note its fit indices (especially Chi-Square, AIC, BIC if available).</li>
                <li>Modify the Measurement or Structural Syntax text boxes to define your alternative model.</li>
                <li>Run the analysis again with the same data.</li>
                <li>Compare the fit indices between the runs. Use the guidelines above (Chi-Square difference, lower AIC/BIC) to help decide which model is preferable.</li>
            </ol>
             <p class="text-xs text-white/60 mt-4"><em>(Note: Rigorous model comparison should always be guided by theory, not just statistical fit.)</em></p>
        </div>
    `;
}

/**
 * Renders the static 'Learn SEM' content into the specified container.
 * @param {string} containerId - The ID of the HTML element to render into.
 */
function renderLearnSemTab(containerId) {
    const container = $(containerId);
    if (!container) return; // Exit if container not found

    // Static HTML content explaining SEM
    container.innerHTML = `
        <h3 class="text-3xl font-bold mb-6"> Understanding SEM Analysis</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
            <div class="md:col-span-2 space-y-6">
                <div>
                    <h4 class="text-xl font-bold mb-3"> What is SEM?</h4>
                    <p class="text-white/80 mb-2">Structural Equation Modeling is a powerful statistical technique that allows researchers to test complex theoretical models. It essentially combines:</p>
                    <ul class="list-disc list-inside text-white/80 space-y-1">
                        <li><strong>Factor Analysis:</strong> To understand how well observed variables (like survey items) measure underlying unobserved concepts (latent variables or constructs). This is the <strong>Measurement Model</strong>.</li>
                        <li><strong>Path Analysis / Regression:</strong> To examine the direct and indirect causal relationships hypothesized between different constructs (latent or observed). This is the <strong>Structural Model</strong>.</li>
                    </ul>
                     <p class="text-white/80 mt-2">It allows testing the entire model simultaneously, providing a holistic view of relationships.</p>
                </div>
                <div>
                    <h4 class="text-xl font-bold mb-3"> Common Business Applications:</h4>
                    <ul class="list-disc list-inside text-white/80 space-y-1">
                        <li><strong>Customer Satisfaction/Loyalty:</strong> Modeling drivers like service quality, price perception, and brand image.</li>
                        <li><strong>Employee Engagement:</strong> Understanding factors like leadership, work environment, and compensation.</li>
                        <li><strong>Brand Equity/Image:</strong> Assessing components like awareness, associations, and perceived quality.</li>
                        <li><strong>Marketing Mix Modeling:</strong> Evaluating the combined impact of advertising, promotions, etc., on sales or brand perception.</li>
                        <li><strong>Technology Acceptance:</strong> Testing models like TAM (Technology Acceptance Model).</li>
                        <li><strong>Supply Chain Performance:</strong> Analyzing relationships between supplier integration, logistics, and firm performance.</li>
                    </ul>
                </div>
            </div>

            <div class="md:col-span-1 bg-white/5 p-4 rounded-lg">
                <h4 class="text-xl font-bold mb-3"> Key Components:</h4>
                <ul class="list-disc list-inside text-white/80 space-y-2">
                    <li>
                        <strong>Latent Variables (Ellipses):</strong>
                        <ul class="list-[circle] list-inside pl-4 text-sm">
                            <li>Unobserved concepts (e.g., 'Brand Loyalty').</li>
                            <li>Syntax: <code>Loyalty =~ item1 + item2</code></li>
                        </ul>
                    </li>
                    <li>
                        <strong>Observable Variables (Rectangles):</strong>
                        <ul class="list-[circle] list-inside pl-4 text-sm">
                            <li>Directly measured data (e.g., survey answers).</li>
                        </ul>
                    </li>
                     <li>
                        <strong>Measurement Paths (<code>=~</code>):</strong>
                        <ul class="list-[circle] list-inside pl-4 text-sm">
                             <li>Link latent variables to their indicators.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Structural Paths (<code>~</code>):</strong>
                         <ul class="list-[circle] list-inside pl-4 text-sm">
                            <li>Hypothesized causal relationships between variables.</li>
                        </ul>
                    </li>
                     <li>
                        <strong>Covariances (<code>~~</code>):</strong>
                         <ul class="list-[circle] list-inside pl-4 text-sm">
                            <li>Correlations without assumed causality.</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

        <div class="mb-8">
            <h4 class="text-xl font-bold mb-3"> SEM Analysis Workflow:</h4>
            <ol class="list-decimal list-inside text-white/80 space-y-1">
                <li><strong>Model Specification:</strong> Define constructs and relationships based on theory using syntax.</li>
                <li><strong>Data Collection:</strong> Gather sufficient data (N > 200 often recommended).</li>
                <li><strong>Model Estimation:</strong> The software calculates path coefficients and error terms.</li>
                <li><strong>Model Evaluation:</strong> Assess how well the model fits the data using indices (, RMSEA, CFI, TLI, SRMR).</li>
                <li><strong>Interpretation:</strong> Examine significant paths and overall model fit.</li>
                <li><strong>Modification (Optional):</strong> Adjust model based on theory and modification indices if fit is poor.</li>
            </ol>
        </div>

        <div class="mb-8">
             <h4 class="text-xl font-bold mb-3"> Best Practices:</h4>
            <ul class="list-disc list-inside text-white/80 space-y-1">
                <li><strong>Theory Driven:</strong> Model specification should be based on existing research or strong logical arguments.</li>
                <li><strong>Sample Size:</strong> Ensure adequate sample size (rules of thumb: >200, or 10-20 per estimated parameter).</li>
                <li><strong>Indicators per Factor:</strong> Use at least 3, preferably 4+, indicators per latent variable for stability.</li>
                <li><strong>Model Fit:</strong> Aim for good fit across multiple indices (e.g., RMSEA  0.06, CFI/TLI  0.95, SRMR  0.08, non-significant  p-value > 0.05).</li>
                <li><strong>Parsimony:</strong> Prefer simpler models that fit well over overly complex ones.</li>
            </ul>
        </div>

        <details class="styled-details mt-8">
            <summary> Advanced SEM Tips</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-6">
                <div>
                    <h5 class="text-lg font-semibold text-white/90 mb-2">Model Building Strategy:</h5>
                    <ol class="list-decimal list-inside text-white/80 space-y-1">
                        <li>Start with the measurement model (CFA) to ensure constructs are well-defined before testing structural paths.</li>
                        <li>Gradually add structural paths based on theory.</li>
                        <li>Compare nested models using Chi-Square difference tests.</li>
                        <li>Consider alternative models and compare their fit.</li>
                    </ol>
                </div>
                <div>
                    <h5 class="text-lg font-semibold text-white/90 mb-2"> Common Pitfalls:</h5>
                    <ul class="list-disc list-inside text-white/80 space-y-1">
                        <li><strong>Overfitting:</strong> Specifying too many paths just to improve fit without theoretical justification.</li>
                        <li><strong>Multicollinearity:</strong> Very high correlations between predictor variables (check correlations > 0.85).</li>
                        <li><strong>Heywood Cases:</strong> Impossible results like negative variances ("error variance") or correlations > 1.0, often due to model misspecification or poor data.</li>
                        <li><strong>Identification Issues:</strong> The model has too few knowns (data points) to estimate the unknowns (parameters). Ensure df > 0.</li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-semibold text-white/90 mb-2"> Troubleshooting Poor Fit:</h5>
                    <ul class="list-disc list-inside text-white/80 space-y-1">
                        <li><strong>Check Data:</strong> Look for outliers, non-normality (consider robust estimators like MLR or MLW), missing data patterns.</li>
                        <li><strong>Review Theory:</strong> Is the model theoretically sound? Are important paths missing?</li>
                        <li><strong>Examine Modification Indices:</strong> Suggest potential paths to add, but ONLY add those that make theoretical sense.</li>
                        <li><strong>Simplify Model:</strong> Remove non-significant paths or combine highly correlated constructs if justified.</li>
                        <li><strong>Check Measurement Model:</strong> Ensure indicators load strongly and cleanly onto their intended factors.</li>
                    </ul>
                </div>
            </div>
        </details>
    `;
}

    /**
 * Helper function to convert an array of objects (like parsed CSV data) into an HTML table.
 * @param {object[]} data - Array of row objects.
 * @returns {string} HTML string for the table.
 */
function renderHtmlTable(data) {
    if (!data || data.length === 0) return '<p class="text-white/70">No estimate data available.</p>';

    const headers = Object.keys(data[0]);
    let tableHtml = '<div class="overflow-x-auto"><table class="w-full text-left styled-table text-sm"><thead><tr>';
    headers.forEach(h => { tableHtml += `<th>${h}</th>`; });
    tableHtml += '</tr></thead><tbody>';

    data.forEach(row => {
        tableHtml += '<tr>';
        headers.forEach(h => {
            let value = row[h];
            let displayValue = '';

            if (typeof value === 'number') {
                if (h.toLowerCase().includes('p-value') && value < 0.0001 && value >= 0) {
                    displayValue = "&lt; 0.0001"; // Use HTML entity
                } else if (value % 1 === 0) { // Integer
                    displayValue = value.toString();
                } else { // Decimal - default to 4 places for estimates/stats
                    const precision = (['Estimate', 'Std. Err', 'z-value'].includes(h)) ? 4 : 3;
                    displayValue = value.toFixed(precision);
                }
            } else if (value === null || value === undefined) {
                displayValue = '';
            } else if (value === '-') {
                displayValue = ''; // Replace placeholder dash
            } else {
                displayValue = value.toString(); // Default to string
            }
            tableHtml += `<td>${displayValue}</td>`;
        });
        tableHtml += '</tr>';
    });

    tableHtml += '</tbody></table></div>';
    return tableHtml;
}

    /**
 * Helper function to render fit indices object into a styled grid with interpretations.
 * @param {object} indices - Object containing fit index key-value pairs.
 * @returns {string} HTML string for the grid.
 */
function renderFitIndices(indices) {
    if (!indices || Object.keys(indices).length === 0) return '<p class="text-white/70">No fit indices available.</p>';

    // Configuration for common indices
    const config = {
        'chi2': { label: 'Chi-Square ()', threshold: null, higherIsBetter: null, note: 'Model vs Data diff.' },
        'chi2 p-value': { label: ' p-value', threshold: 0.05, higherIsBetter: true, note: 'Want > 0.05 (fit)' },
        'RMSEA': { label: 'RMSEA', threshold: 0.08, higherIsBetter: false, note: '< 0.08 Good, < 0.06 Exc.' },
        'CFI': { label: 'CFI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Accept, > 0.95 Good' },
        'TLI': { label: 'TLI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Accept, > 0.95 Good' },
        'SRMR': { label: 'SRMR', threshold: 0.08, higherIsBetter: false, note: '< 0.08 Good' },
        'AIC': { label: 'AIC', threshold: null, higherIsBetter: false, note: 'Lower is better (compare)' },
        'BIC': { label: 'BIC', threshold: null, higherIsBetter: false, note: 'Lower is better (compare)' },
        'DoF': { label: 'Degrees of Freedom', threshold: null, higherIsBetter: null, note: 'Model complexity' },
         // Add others as needed, e.g., GFI, AGFI if semopy provides them consistently
         'GFI': { label: 'GFI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Good' },
         'AGFI': { label: 'AGFI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Good' },
         'NFI': { label: 'NFI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Good' },
    };

    let gridHtml = '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">';

    for (const key in indices) {
        if (indices.hasOwnProperty(key)) {
            const valueStr = indices[key];
            let valueNum = parseFloat(valueStr);
            if (isNaN(valueNum)) continue; // Skip non-numeric values

            const idxConfig = config[key] || {
                label: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                threshold: null, higherIsBetter: null, note: ''
            };

            let interpretation = '', colorClass = 'bg-white/5'; // Default style

            // Determine interpretation and color based on threshold
            if (idxConfig.threshold !== null && idxConfig.higherIsBetter !== null) {
                const passesThreshold = (idxConfig.higherIsBetter && valueNum >= idxConfig.threshold) ||
                                       (!idxConfig.higherIsBetter && valueNum <= idxConfig.threshold);
                if (passesThreshold) {
                    interpretation = ' Good Fit';
                    colorClass = 'bg-green-600/10 text-green-300 border border-green-600/30';
                } else {
                    interpretation = ' Potential Issue';
                    colorClass = 'bg-yellow-600/10 text-yellow-300 border border-yellow-600/30';
                }
            }
             // Specific logic for p-value interpretation
             if (key === 'chi2 p-value') {
                if (valueNum >= 0.05) {
                    interpretation = ' Fits Data (p  0.05)';
                    colorClass = 'bg-green-600/10 text-green-300 border border-green-600/30';
                } else {
                    interpretation = ' Differs from Data (p < 0.05)';
                    colorClass = 'bg-yellow-600/10 text-yellow-300 border border-yellow-600/30';
                }
            }


            gridHtml += `
                <div class="p-3 rounded-lg ${colorClass}">
                    <p class="text-sm font-medium text-white/80">${idxConfig.label}</p>
                    <p class="text-xl font-bold text-white">${valueNum.toFixed(3)}</p>
                    ${interpretation ? `<p class="text-xs mt-1 font-semibold">${interpretation}</p>` : ''}
                    ${idxConfig.note ? `<p class="text-xs mt-1 text-white/60">${idxConfig.note}</p>` : ''}
                </div>`;
        }
    }
    gridHtml += '</div>';

    // Footer with general guidelines
    gridHtml += `
        <div class="mt-6 text-xs text-white/60 space-y-1">
            <p><strong>Note:</strong> Fit index interpretation depends on context (sample size, model complexity, theory). Thresholds are common guidelines.</p>
        </div>`;

    return gridHtml;
}

    // =========================================================================
    // ===== VISUALIZATION & RENDERING FUNCTIONS (FOR SEM) END             =====
    // =========================================================================

    function applyParetoAnalysisJS(factors) {
        if (!factors || factors.length === 0) return [];

        const sorted_factors = [...factors].sort((a, b) => b.impact_score - a.impact_score);
        const total_impact = sorted_factors.reduce((sum, f) => sum + f.impact_score, 0);

        if (total_impact === 0) {
            return sorted_factors.map((f, i) => ({ ...f, cumulative_percentage: 0, priority: "Low", rank: i + 1 }));
        }

        let cumulative_impact = 0;
        return sorted_factors.map((factor, i) => {
            cumulative_impact += factor.impact_score;
            const cumulative_percentage = (cumulative_impact / total_impact) * 100;
            return {
                ...factor,
                cumulative_percentage: parseFloat(cumulative_percentage.toFixed(1)),
                priority: cumulative_percentage <= 80 ? "High" : "Low",
                rank: i + 1
            };
        });
    }

    // =========================================================================
    // ===== VISUALIZATION & RENDERING FUNCTIONS                          =====
    // =========================================================================

    async function handleSystemThinkingAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white">Analyzing System Dynamics...</h3><p class="text-white/80 mb-2">Identifying elements, loops, and leverage points based on your description...</p></div>`; // Updated text
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = document.querySelector('input[name="inputType"]:checked').id === "docUpload";
        let content = "";
        if (useDoc) {
            const file = $("systemFile").files[0];
            if (!file) throw new Error("Please select a document.");
            content = await extractTextFromFile(file);
        } else {
            content = $("systemContent").value.trim();
            if (!content) throw new Error("Please describe the system.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (content.length > MAX_CONTEXT_LENGTH) {
            content = content.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`System Thinking analysis context truncated.`);
        }

        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are an expert systems thinking analyst. Analyze the provided system description to identify its underlying structure, feedback loops, and potential leverage points based *only* on the provided text. ${truncatedNote}

            **USER'S SYSTEM DESCRIPTION:**
            \`\`\`
            ${content}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Identify Elements (5-7 elements):** Extract key system elements mentioned or clearly implied. For each element:
                * \`name\`: Concise name (2-4 words).
                * \`type\`: Classify as "Stock" (accumulation), "Flow" (rate of change), "Variable" (influencing factor), or "Parameter" (constant/policy) based on context.
            2.  **Identify Feedback Loops (1 Reinforcing, 1 Balancing):** Identify the *primary* reinforcing loop (driving growth/change) and the *primary* balancing loop (limiting/stabilizing) suggested by the text. For each loop:
                * \`name\`: A descriptive name (e.g., "R1: Word of Mouth Growth", "B1: Service Capacity Limit").
                * \`type\`: "Reinforcing" or "Balancing".
                * \`description\`: Explain the causal chain step-by-step, explicitly mentioning how the elements interact (e.g., "Increased [Element A - Stock] leads to higher [Element B - Variable], which accelerates the [Element C - Flow], further increasing [Element A - Stock]").
                * \`elements\`: List the names of the key elements involved in this specific loop.
            3.  **System Behavior Summary:** Provide a concise \`summary\` explaining how the identified reinforcing and balancing loops interact to produce the overall behavior described or implied in the user's text.
            4.  **Identify Leverage Points (2-3 points):** Pinpoint high-leverage points where interventions could significantly alter the system's behavior, based on the loop analysis. For each point:
                * \`point_name\`: Name of the leverage point (often related to an element or connection).
                * \`target_element\`: The specific element the intervention primarily affects.
                * \`intervention\`: A concrete suggested action based on the context.
                * \`expected_impact\`: Describe the intended effect on the feedback loops (e.g., "Strengthens R1 loop by increasing inflow X", "Weakens B1 loop by reducing constraint Y", "Alters goal of B1").
            5.  **Self-Correction:** Before outputting JSON, rigorously check: Are all elements, loops, and leverage points derived *solely* from the text? Are element types correctly classified based on context? Are loop descriptions causally accurate and reference the identified elements? Does the summary explain the loop interplay? Are interventions linked to leverage points and expected impacts clearly stated in terms of loop effects? Is the JSON structure perfect? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT GROUNDING:** All output MUST be based *exclusively* on the provided SYSTEM DESCRIPTION. Do NOT invent elements, loops, or interventions not supported by the text.
            - **SYSTEMS THINKING PRINCIPLES:** Apply concepts of stocks, flows, feedback loops, and leverage points correctly based on the context.
            - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys and sub-keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
            {
              "elements": [
                {"name": "Customer Base", "type": "Stock"},
                {"name": "New Customers Rate", "type": "Flow"},
                {"name": "Service Quality", "type": "Variable"},
                {"name": "Support Capacity", "type": "Stock"},
                {"name": "Support Ticket Rate", "type": "Flow"},
                {"name": "Company Policy X", "type": "Parameter"}
              ],
              "feedback_loops": [
                {
                  "name": "R1: Word of Mouth Growth",
                  "type": "Reinforcing",
                  "description": "A larger [Customer Base - Stock] leads to potentially higher [Service Quality - Variable] perceptions (if capacity holds), generating positive word-of-mouth which increases the [New Customers Rate - Flow], further growing the [Customer Base - Stock].",
                  "elements": ["Customer Base", "Service Quality", "New Customers Rate"]
                },
                {
                  "name": "B1: Support Capacity Limit",
                  "type": "Balancing",
                  "description": "A growing [Customer Base - Stock] increases the [Support Ticket Rate - Flow]. If this exceeds [Support Capacity - Stock], [Service Quality - Variable] declines, potentially reducing the [New Customers Rate - Flow] and slowing growth of the [Customer Base - Stock].",
                  "elements": ["Customer Base", "Support Ticket Rate", "Support Capacity", "Service Quality", "New Customers Rate"]
                }
              ],
              "summary": "The system shows potential for reinforcing growth (R1) driven by customer base and quality perception. However, this growth is likely limited by the balancing loop (B1) related to support capacity, which negatively impacts service quality when strained, thus counteracting the growth engine.",
              "leverage_points": [
                {
                  "point_name": "Support Capacity Expansion",
                  "target_element": "Support Capacity",
                  "intervention": "Invest in hiring and training more support staff, or implement tools to increase efficiency, as suggested by the capacity limit bottleneck.",
                  "expected_impact": "Weakens the B1 loop by increasing the threshold at which service quality degrades, allowing the R1 growth loop to operate more effectively for longer."
                },
                {
                  "point_name": "Service Quality Monitoring",
                  "target_element": "Service Quality",
                  "intervention": "Implement real-time monitoring of service quality metrics (e.g., response time, CSAT) mentioned implicitly as important.",
                  "expected_impact": "Provides faster feedback within the B1 loop, allowing quicker adjustments to capacity (part of the intervention for B1) before quality drops significantly, thus stabilizing R1."
                },
                 {
                  "point_name": "Influence Policy X",
                  "target_element": "Company Policy X",
                  "intervention": "Re-evaluate 'Company Policy X' identified in the context to see if it inadvertently constrains growth or capacity.",
                  "expected_impact": "Alters a system parameter, potentially weakening the B1 loop or modifying the goal/speed of the R1 loop depending on the policy's function."
                }
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED System Thinking prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (System Thinking):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced System Thinking) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !Array.isArray(parsedData.elements) || parsedData.elements.length < 3 || // Expect a few elements
                 !Array.isArray(parsedData.feedback_loops) || parsedData.feedback_loops.length < 1 || // Expect at least one loop
                 !parsedData.summary || typeof parsedData.summary !== 'string' ||
                 !Array.isArray(parsedData.leverage_points) || parsedData.leverage_points.length < 1 || // Expect at least one point
                 // Check structure of first elements if they exist
                 (parsedData.elements.length > 0 && (typeof parsedData.elements[0] !== 'object' || !parsedData.elements[0].hasOwnProperty('name') || !parsedData.elements[0].hasOwnProperty('type'))) ||
                 (parsedData.feedback_loops.length > 0 && (typeof parsedData.feedback_loops[0] !== 'object' || !parsedData.feedback_loops[0].hasOwnProperty('name') || !parsedData.feedback_loops[0].hasOwnProperty('description') || !Array.isArray(parsedData.feedback_loops[0].elements))) ||
                 (parsedData.leverage_points.length > 0 && (typeof parsedData.leverage_points[0] !== 'object' || !parsedData.leverage_points[0].hasOwnProperty('point_name') || !parsedData.leverage_points[0].hasOwnProperty('intervention') || !parsedData.leverage_points[0].hasOwnProperty('expected_impact')))
                )
             {
                  console.error("Validation Failed (Enhanced System Thinking): Required fields missing or invalid structure.", parsedData);
                  throw new Error(`AI response structure is incorrect or inconsistent (Enhanced System Thinking). Check elements, loops, summary, and leverage points. See console logs.`);
             }
             console.log(`Successfully parsed ENHANCED System Thinking JSON using ${MODEL_NAME}. Found ${parsedData.elements.length} elements.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED System Thinking JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced System Thinking): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results
        renderSystemThinkingPage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleSystemThinkingAnalysis (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderSystemThinkingPage(container, data) {
    container.innerHTML = ""; // Clear the loading indicator

    // Add validation for new fields
    if (!data || !data.elements || !data.feedback_loops || !data.summary || !data.leverage_points) {
        console.error("Incomplete data passed to renderSystemThinkingPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render System Thinking results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    const { elements, feedback_loops, summary, leverage_points } = data;


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="gist"> Gist & Elements</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="loops"> Feedback Loops</button>
        <button class="analysis-tab-btn" data-tab="leverage"> Leverage Points</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn System Thinking</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="gistPanel" class="analysis-tab-panel active"></div>
        <div id="loopsPanel" class="analysis-tab-panel"></div>
        <div id="leveragePanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- 1. Populate Gist & Elements Panel (Updated) ---
    const gistPanel = $("gistPanel");
    let gistHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">System Overview</h3>`;
    gistHtml += `<blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90 mb-6 text-sm">"${summary}"</blockquote>`; // Use enhanced summary
    gistHtml += `<h4 class="text-xl font-semibold mb-3">Key System Elements Identified</h4>`;
    // Table for elements
     gistHtml += `<div class="overflow-x-auto">
                    <table class="coeff-table styled-table text-sm">
                        <thead><tr><th>Element Name</th><th>Type</th><th>Description (Inferred Role)</th></tr></thead>
                        <tbody>`;
    elements.forEach(el => {
         let description = "";
         if (el.type === "Stock") description = "Accumulation over time (e.g., Customers, Inventory, Cash)";
         else if (el.type === "Flow") description = "Rate of change affecting a Stock (e.g., Sales Rate, Production Rate)";
         else if (el.type === "Variable") description = "Factor influencing Flows or other Variables (e.g., Price, Quality)";
         else if (el.type === "Parameter") description = "Constant or policy influencing the system (e.g., Tax Rate, Standard Procedure)";

        gistHtml += `<tr>
                        <td class="font-semibold">${el.name}</td>
                        <td class="font-mono text-xs">${el.type}</td>
                        <td class="text-white/70">${description}</td>
                     </tr>`;
    });
     gistHtml += `</tbody></table></div>`;

    gistHtml += `</div>`; // Close p-4
    gistPanel.innerHTML = gistHtml;

    // --- 2. Populate Feedback Loops Panel (Updated for detail) ---
    const loopsPanel = $("loopsPanel");
    let loopsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Identified Feedback Loops</h3><div class="space-y-6">`; // Increased spacing
    feedback_loops.forEach((loop) => {
        const isReinforcing = loop.type.toLowerCase() === "reinforcing";
        const loopIcon = isReinforcing ? "" : ""; // More distinct icons
        const loopColor = isReinforcing ? "border-green-400" : "border-yellow-400";
        loopsHtml += `
            <div class="bg-black/20 p-4 rounded-lg border-l-4 ${loopColor}">
                <h4 class="text-lg font-bold flex items-center gap-2">${loopIcon} ${loop.name} <span class="text-xs font-light text-white/60">(${loop.type})</span></h4>
                <p class="text-sm text-white/80 my-3 italic"><strong>Causal Chain:</strong> ${loop.description}</p>
                <div class="text-xs text-white/60"><strong>Key Elements Involved:</strong> ${loop.elements.join(", ")}</div>
            </div>`;
    });
    loopsHtml += `</div></div>`; // Close space-y-6 and p-4
    loopsPanel.innerHTML = loopsHtml;

    // --- 3. Populate Leverage Points Panel (Updated for detail) ---
    const leveragePanel = $("leveragePanel");
    let leverageHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> High-Impact Leverage Points</h3>`;
    if (leverage_points && leverage_points.length > 0) {
        leverageHtml += `<p class="text-sm text-white/70 mb-6 italic">Interventions at these points are likely to cause significant shifts in the system's behavior by influencing the core feedback loops.</p>`;
        leverageHtml += `<div class="space-y-6">`;
        leverage_points.forEach((point, index) => {
            leverageHtml += `
                <div class="prescription-card border-l-4 border-indigo-400">
                     <h4 class="text-xl font-bold">${index + 1}. ${point.point_name}</h4>
                     <p class="text-xs font-semibold my-1 text-indigo-300">TARGET ELEMENT: ${point.target_element || 'N/A'}</p>
                     <p class="rationale"><strong>Proposed Intervention:</strong> ${point.intervention || 'N/A'}</p>
                     <div class="p-3 bg-black/20 rounded mt-3 text-sm">
                         <p><strong>Expected Impact on Loops:</strong> ${point.expected_impact || 'N/A'}</p>
                     </div>
                </div>`;
        });
        leverageHtml += `</div>`;
    } else {
        leverageHtml += `<p class="text-center text-white/70 italic">No specific leverage points were clearly identified from the provided system description.</p>`;
    }
    leverageHtml += `</div>`; // Close p-4
    leveragePanel.innerHTML = leverageHtml;


    // --- 4. Populate Learn System Thinking Panel (New) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding System Thinking</h3>
         
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is System Thinking?</h4>
            <p class="text-sm text-white/80">System thinking is a holistic approach to analysis that focuses on how a system's constituent parts interrelate and how systems work over time and within the context of larger systems. It contrasts with traditional analysis, which studies systems by breaking them down into their separate elements.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Key Concepts:</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Interconnectedness:</strong> Elements within a system are interconnected; changing one part affects others.</li>
                    <li><strong>Feedback Loops:</strong> Circular causal relationships that amplify (reinforcing) or stabilize (balancing) change. </li>
                    <li><strong>Stocks & Flows:</strong> Stocks are accumulations (like water in a tub); Flows are the rates that change stocks (like the faucet and drain).</li>
                    <li><strong>Delays:</strong> Time lags between actions and their effects, often causing oscillations or overshoots.</li>
                    <li><strong>Non-linearity:</strong> Cause and effect are not always proportional; small changes can sometimes have large effects (leverage points).</li>
                    <li><strong>Emergence:</strong> System behavior arises from the interactions of its parts and cannot always be predicted by looking at the parts in isolation.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Why Use System Thinking?</h4>
                 <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>See the Bigger Picture:</strong> Understand context and connections.</li>
                    <li><strong>Identify Root Causes:</strong> Move beyond addressing symptoms to find underlying structural issues.</li>
                    <li><strong>Find High-Leverage Interventions:</strong> Identify points where small efforts yield significant results.</li>
                    <li><strong>Anticipate Unintended Consequences:</strong> Recognize how changes might ripple through the system.</li>
                    <li><strong>Understand Dynamic Behavior:</strong> Explain patterns of growth, decline, oscillation, or stability over time.</li>
                    <li><strong>Foster Collaboration:</strong> Provides a shared language to discuss complex problems.</li>
                 </ul>
            </div>
        </div>

         <details class="styled-details text-sm mt-4">
            <summary class="font-semibold">Common System Archetypes (Recurring Patterns)</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                <p><strong>Limits to Growth:</strong> Growth eventually slows or stops due to a limiting factor (a balancing loop).</p>
                <p><strong>Shifting the Burden:</strong> Using a short-term fix distracts from or undermines a fundamental long-term solution.</p>
                <p><strong>Fixes that Fail:</strong> A solution creates unintended consequences elsewhere that worsen the original problem later.</p>
                <p><strong>Tragedy of the Commons:</strong> Individuals overusing a shared resource deplete it for everyone.</p>
                <p><strong>Success to the Successful:</strong> Winners get more resources, enabling them to win even more, while losers fall further behind.</p>
                <p><strong>Escalation:</strong> Two parties react competitively, leading to an accelerating race none desires.</p>
                 <p class="text-xs italic mt-2">Recognizing these patterns helps diagnose systemic issues quickly.</p>
            </div>
        </details>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // No Plotly charts expected in this version, so no resize needed
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}


    async function handleFactorAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `
        <div class="text-center text-white/70 p-8">
            <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
            <h3 class="text-xl font-semibold text-white">Performing Context-Aware Factor Analysis...</h3>
            <p class="text-white/80 mb-2">Identifying Internal (S/W) and External (O/T) factors using AI based *only* on your text...</p>
        </div>`;
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Or qwen3:30b-a3b

    try {
        // 1. Gather Inputs
        const useDoc = $("docUpload").checked;
        let documentText = "";

        if (useDoc) {
            const file = $("factorFile").files[0];
            if (!file) throw new Error("Please select a document to upload.");
            documentText = await extractTextFromFile(file);
        } else {
            documentText = $("factorContent").value.trim();
            if (!documentText.trim()) throw new Error("Please enter business information in the text area.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (documentText.length > MAX_CONTEXT_LENGTH) {
            documentText = documentText.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters of the provided text.)`;
            console.warn(`Factor Analysis context truncated.`);
        }

        // 2. Construct ENHANCED Prompt for LLM
        const prompt = `
            You are a meticulous strategic analyst. Analyze the provided business description based **ONLY** on the text itself. Identify key Internal Factors (Strengths, Weaknesses) and External Factors (Opportunities, Threats). ${truncatedNote}

            **USER'S BUSINESS DESCRIPTION:**
            \`\`\`
            ${documentText}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Identify Internal Factors:** Extract specific Strengths (internal positives) and Weaknesses (internal negatives) **mentioned or clearly implied in the text**. Categorize them (e.g., "Brand & Marketing", "Operations", "Financial", "Human Resources", "Technology"). Provide 4-6 factors for each (S & W).
            2.  **Identify External Factors:** Extract specific Opportunities (external positives) and Threats (external negatives) **mentioned or clearly implied in the text**. Categorize them using PESTEL+ framework (Political, Economic, Social, Technological, Environmental, Legal, Market/Competitive). Provide 4-6 factors for each (O & T).
            3.  **Assign Impact:** For EACH factor identified (Internal & External), assign a plausible \`impact_score\` (integer 1-10, where 10 is highest impact) based **only** on its significance as suggested **by the text**.
            4.  **Provide Description:** For EACH factor, provide a brief \`description\` summarizing the factor **using wording found in or directly inferred from the text**.
            5.  **Self-Correction:** Rigorously check: Is every factor, category, description, and impact score derived **SOLELY** from the provided text? Are factors correctly classified as Internal/External and S/W/O/T based on the text? Is the JSON structure perfect? Fix errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT IS KING:** Base **ALL** output **EXCLUSIVELY** on the provided "USER'S BUSINESS DESCRIPTION". **DO NOT** invent factors, categories, or scores.
            - **SPECIFICITY:** Descriptions must be concise and grounded in the text.
            - **JSON FORMAT:** Adhere EXACTLY.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object.
            {
              "internal_factors": {
                "strengths": [ // 4-6 factors based ONLY on text
                  {"category": "[Category ONLY from text]", "factor": "[Strength ONLY from text]", "description": "[Desc. ONLY from text]", "impact_score": "[Score 1-10 based ONLY on text]"},
                  // ...
                ],
                "weaknesses": [ // 4-6 factors based ONLY on text
                  {"category": "[Category ONLY from text]", "factor": "[Weakness ONLY from text]", "description": "[Desc. ONLY from text]", "impact_score": "[Score 1-10 based ONLY on text]"},
                  // ...
                ]
              },
              "external_factors": {
                "opportunities": [ // 4-6 factors based ONLY on text
                  {"category": "[PESTEL+ Category ONLY from text]", "factor": "[Opportunity ONLY from text]", "description": "[Desc. ONLY from text]", "impact_score": "[Score 1-10 based ONLY on text]"},
                  // ...
                ],
                "threats": [ // 4-6 factors based ONLY on text
                   {"category": "[PESTEL+ Category ONLY from text]", "factor": "[Threat ONLY from text]", "description": "[Desc. ONLY from text]", "impact_score": "[Score 1-10 based ONLY on text]"},
                  // ...
                ]
              }
            }
        `;

        // 3. Call Ollama API
        console.log(`Sending Factor Analysis prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (Factor Analysis):', data.response);
        try {
            parsedData = JSON.parse(data.response);
             // *** Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Factor Analysis) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !parsedData.internal_factors || typeof parsedData.internal_factors !== 'object' ||
                 !Array.isArray(parsedData.internal_factors.strengths) || !Array.isArray(parsedData.internal_factors.weaknesses) ||
                 !parsedData.external_factors || typeof parsedData.external_factors !== 'object' ||
                 !Array.isArray(parsedData.external_factors.opportunities) || !Array.isArray(parsedData.external_factors.threats) ||
                 // Check structure of first factor if lists are not empty
                 (parsedData.internal_factors.strengths.length > 0 && (typeof parsedData.internal_factors.strengths[0] !== 'object' || !parsedData.internal_factors.strengths[0].hasOwnProperty('factor') || !parsedData.internal_factors.strengths[0].hasOwnProperty('impact_score'))) ||
                 (parsedData.internal_factors.weaknesses.length > 0 && (typeof parsedData.internal_factors.weaknesses[0] !== 'object' || !parsedData.internal_factors.weaknesses[0].hasOwnProperty('factor') || !parsedData.internal_factors.weaknesses[0].hasOwnProperty('impact_score'))) ||
                  (parsedData.external_factors.opportunities.length > 0 && (typeof parsedData.external_factors.opportunities[0] !== 'object' || !parsedData.external_factors.opportunities[0].hasOwnProperty('factor') || !parsedData.external_factors.opportunities[0].hasOwnProperty('impact_score'))) ||
                  (parsedData.external_factors.threats.length > 0 && (typeof parsedData.external_factors.threats[0] !== 'object' || !parsedData.external_factors.threats[0].hasOwnProperty('factor') || !parsedData.external_factors.threats[0].hasOwnProperty('impact_score')))
                )
             {
                  console.error("Validation Failed (Factor Analysis): Required fields missing or invalid structure.", parsedData);
                  throw new Error(`AI response structure is incorrect or inconsistent (Factor Analysis). Check internal/external factors arrays and object structures. See console logs.`);
             }
             console.log(`Successfully parsed Factor Analysis JSON using ${MODEL_NAME}.`);

        } catch (e) {
            console.error(`Failed to parse/validate Factor Analysis JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Factor Analysis): ${e.message}. See raw response in console.`);
        }

        // 4. Process AI Output & Apply Pareto
        const allInternalFactors = [
            ...(parsedData.internal_factors.strengths || []).map(f => ({ ...f, type: 'Internal', swot: 'Strength' })),
            ...(parsedData.internal_factors.weaknesses || []).map(f => ({ ...f, type: 'Internal', swot: 'Weakness' }))
        ];
        const allExternalFactors = [
             ...(parsedData.external_factors.opportunities || []).map(f => ({ ...f, type: 'External', swot: 'Opportunity' })),
             ...(parsedData.external_factors.threats || []).map(f => ({ ...f, type: 'External', swot: 'Threat' }))
        ];

        // Ensure impact_score is a number for Pareto function
        const sanitizeScore = (factor) => ({
            ...factor,
            impact_score: Number(factor.impact_score) || 0 // Default to 0 if not a number
        });

        const prioritizedInternal = applyParetoAnalysisJS(allInternalFactors.map(sanitizeScore));
        const prioritizedExternal = applyParetoAnalysisJS(allExternalFactors.map(sanitizeScore));


        // 5. Render Results
        renderFactorAnalysisPage(analysisResultContainer, {
            external: prioritizedExternal,
            internal: prioritizedInternal
        });

    } catch (error) {
        console.error(`Error in handleFactorAnalysis (LLM) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


// Keep applyParetoAnalysisJS as it's used to process AI output
function applyParetoAnalysisJS(factors) {
    if (!factors || factors.length === 0) return [];

    // Ensure impact_score is numeric before sorting
    const validFactors = factors.filter(f => typeof f.impact_score === 'number' && !isNaN(f.impact_score));
    if (validFactors.length === 0) {
        console.warn("No factors with valid numeric impact scores found for Pareto analysis.");
        // Return original factors with default priority/rank if scores were bad
        return factors.map((f, i) => ({ ...f, cumulative_percentage: 0, priority: "Low", rank: i + 1 }));
    }


    const sorted_factors = [...validFactors].sort((a, b) => b.impact_score - a.impact_score);
    const total_impact = sorted_factors.reduce((sum, f) => sum + f.impact_score, 0);

    if (total_impact === 0) {
        // Handle case where all scores are 0
        return sorted_factors.map((f, i) => ({ ...f, cumulative_percentage: 0, priority: "Low", rank: i + 1 }));
    }

    let cumulative_impact = 0;
    return sorted_factors.map((factor, i) => {
        cumulative_impact += factor.impact_score;
        const cumulative_percentage = (cumulative_impact / total_impact) * 100;
        return {
            ...factor,
            cumulative_percentage: parseFloat(cumulative_percentage.toFixed(1)),
            priority: cumulative_percentage <= 80 ? "High" : "Low",
            rank: i + 1
        };
    });
}


// Modified renderFactorAnalysisPage to add Learn Tab
function renderFactorAnalysisPage(container, data) {
    container.innerHTML = ""; // Clear loading state

     // Basic validation
     if (!data || !data.external || !data.internal) {
          console.error("Incomplete data passed to renderFactorAnalysisPage:", data);
          container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Factor Analysis results.</div>`;
          $("analysisActions").classList.add("hidden");
          return;
     }

    const { external, internal } = data;

    // --- Create Tab Navigation (Added Learn Tab) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="summary"> Summary</button> <!-- Summary First -->
        <button class="analysis-tab-btn" data-tab="external"> External Factors</button>
        <button class="analysis-tab-btn" data-tab="internal"> Internal Factors</button>
        <button class="analysis-tab-btn" data-tab="pareto"> 80/20 Analysis</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Factor Analysis</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Added Learn Panel) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="summaryPanel" class="analysis-tab-panel active"></div> <!-- Summary Active -->
        <div id="externalPanel" class="analysis-tab-panel"></div>
        <div id="internalPanel" class="analysis-tab-panel"></div>
        <div id="paretoPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- Populate Tabs (Order Changed) ---
    renderSummaryTab("summaryPanel", external, internal); // Render Summary First
    renderFactorTab("externalPanel", "External Factors (PESTEL+)", external); // Pass External factors
    renderFactorTab("internalPanel", "Internal Factors (Resources & Capabilities)", internal); // Pass Internal factors
    renderParetoTab("paretoPanel", [...external, ...internal]); // Pass combined factors

    // --- 5. Populate Learn Factor Analysis Panel (New) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Factor Analysis (Strategic Context)</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is Strategic Factor Analysis?</h4>
            <p class="text-sm text-white/80">In strategic planning, factor analysis involves systematically identifying and evaluating key internal and external elements that can influence an organization's ability to achieve its objectives. It's often a precursor to SWOT analysis.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2"> External Factor Analysis (PESTEL+)</h4>
                <p class="text-xs text-white/70 mb-2 italic">Understanding the macro-environment.</p>
                <ul class="space-y-1 text-sm">
                    <li><strong>P</strong>olitical: Government stability, policy, regulation, taxes.</li>
                    <li><strong>E</strong>conomic: Growth rates, inflation, interest rates, exchange rates, employment.</li>
                    <li><strong>S</strong>ocial: Demographics, cultural trends, lifestyle changes, consumer attitudes.</li>
                    <li><strong>T</strong>echnological: Innovation, automation, R&D, digital trends.</li>
                    <li><strong>E</strong>nvironmental: Climate change, sustainability, weather, resource availability.</li>
                    <li><strong>L</strong>egal: Laws affecting employment, competition, health & safety, consumer protection.</li>
                    <li><strong>+ Market/Competitive:</strong> Industry trends, market size, competition intensity, supplier/buyer power.</li>
                </ul>
                <p class="text-xs text-white/70 mt-2"><strong>Goal:</strong> Identify Opportunities & Threats.</p>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2"> Internal Factor Analysis (Resources & Capabilities)</h4>
                 <p class="text-xs text-white/70 mb-2 italic">Assessing the organization's own assets and abilities.</p>
                <ul class="space-y-1 text-sm">
                    <li><strong>Financial:</strong> Profitability, cash flow, funding access, cost structure.</li>
                    <li><strong>Physical:</strong> Facilities, equipment, location, raw materials access.</li>
                    <li><strong>Human Resources:</strong> Skills, experience, motivation, culture, leadership.</li>
                    <li><strong>Technological:</strong> IT infrastructure, patents, R&D capabilities, proprietary tech.</li>
                    <li><strong>Organizational:</strong> Structure, processes, reputation, brand equity, partnerships.</li>
                    <li><strong>Marketing & Sales:</strong> Brand recognition, distribution channels, customer relationships.</li>
                 </ul>
                 <p class="text-xs text-white/70 mt-2"><strong>Goal:</strong> Identify Strengths & Weaknesses.</p>
            </div>
        </div>

         <div class="bg-black/20 p-4 rounded-lg mt-6">
            <h4 class="text-lg font-bold mb-2 text-yellow-300"> Applying the 80/20 Rule (Pareto Principle)</h4>
            <p class="text-sm text-white/80">After identifying factors, it's crucial to prioritize. The Pareto Principle suggests that roughly 80% of effects come from 20% of causes. In strategy:</p>
            <ul class="list-disc list-inside space-y-1 text-sm mt-2">
                <li>Identify the few factors (approx. 20%) with the highest potential impact (positive or negative) on your goals.</li>
                <li>Focus strategic efforts primarily on leveraging high-impact strengths/opportunities and mitigating high-impact weaknesses/threats.</li>
                <li>This tool uses the AI-assigned 'impact_score' to perform this prioritization, highlighting the 'High' priority factors that make up the first 80% of cumulative impact.</li>
            </ul>
        </div>

         <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to identify factors from your text and then applies the 80/20 rule based on AI-estimated impact.</p>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (ensure resizing happens)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // Resize charts if they are in the activated panel
                 const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                 chartsInPanel.forEach(chartDiv => {
                      if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                          try {
                              Plotly.Plots.resize(chartDiv);
                          } catch (resizeError) {
                               console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                          }
                      }
                 });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Initial resize for charts in the default active tab (Summary) + hidden tabs
     setTimeout(() => {
          tabContent.querySelectorAll(".analysis-tab-panel").forEach(panel => {
               panel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                   if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                       try {
                            Plotly.Plots.resize(chartDiv);
                       } catch (initialResizeError) {
                            console.error(`Error during initial resize ${chartDiv.id} in panel ${panel.id}:`, initialResizeError);
                       }
                   }
               });
          });
     }, 150); // Delay slightly

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}


// Modified renderFactorTab to use AI categories and factor details
function renderFactorTab(containerId, title, factors) {
    const container = $(containerId);
    let contentHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">${title}</h3>`; // Added p-4

    if (factors && factors.length > 0) {
        // Group factors by AI-provided category
        const categories = factors.reduce((acc, f) => {
            const category = f.category || "Uncategorized"; // Handle missing category
            if (!acc[category]) acc[category] = [];
            acc[category].push(f);
            return acc;
        }, {});

        // Sort categories alphabetically
        const sortedCategories = Object.keys(categories).sort();

        // Chart: Factor Count by Category
        contentHtml += `<div id="${containerId}-chart" class="w-full h-[400px] mb-8 bg-black/10 rounded-lg p-2 plotly-chart"></div>`;

        // Details sections for each category
         sortedCategories.forEach(category => {
            contentHtml += `<div class="mb-6"><details class="styled-details" ${sortedCategories.length <= 3 ? 'open' : ''}> <!-- Open details if few categories -->
                            <summary class="font-semibold text-lg">${category} (${categories[category].length} factors)</summary>
                            <div class="bg-black/20 p-4 rounded-b-lg space-y-4">`; // Use styled-details background
            // Sort factors within category by rank (desc impact)
            categories[category].sort((a, b) => a.rank - b.rank);
            categories[category].forEach((factor) => {
                 const priorityColor = factor.priority === "High" ? "text-red-400" : "text-yellow-400";
                 const swotColor = factor.swot === 'Strength' || factor.swot === 'Opportunity' ? 'text-green-400' : 'text-red-400';
                 contentHtml += `<div class="py-2 border-b border-white/10 last:border-b-0">
                                <p class="flex justify-between items-center">
                                    <span class="font-semibold text-white">${factor.factor}</span>
                                    <span class="text-xs ${priorityColor}"><strong>Rank #${factor.rank}</strong> | Prio: ${factor.priority}</span>
                                </p>
                                <p class="text-sm text-white/80 my-1 italic">${factor.description || 'No description provided.'}</p>
                                <p class="text-xs text-white/60">
                                    <span class="${swotColor}">${factor.swot}</span> |
                                    Score: ${factor.impact_score.toFixed(1)} |
                                    Cumul %: ${factor.cumulative_percentage}%
                                </p>
                            </div>`;
            });
            contentHtml += `</div></details></div>`; // Close details content and details tag
         });

    } else {
        contentHtml += '<p class="text-white/70 italic text-center">No factors identified in this category based on the provided text.</p>';
    }

    contentHtml += `</div>`; // Close p-4
    container.innerHTML = contentHtml;

    // Render Category Chart
    if (factors && factors.length > 0) {
        const categoryCounts = Object.entries(
            factors.reduce((acc, f) => {
                const category = f.category || "Uncategorized";
                acc[category] = (acc[category] || 0) + 1;
                return acc;
            }, {})
        ).sort((a, b) => b[1] - a[1]); // Sort by count desc

        try {
            Plotly.newPlot(
                `${containerId}-chart`,
                [{
                    x: categoryCounts.map(c => c[0]),
                    y: categoryCounts.map(c => c[1]),
                    type: 'bar',
                    marker: { color: 'var(--primary)' }
                }],
                {
                    title: `${title.split('(')[0]} Factors by Category`, // Clean title
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                    xaxis: { automargin: true, tickangle: -30, tickfont: { size: 10 } }, // Smaller font
                    yaxis: { title: 'Number of Factors', gridcolor: 'rgba(255,255,255,0.1)' },
                    margin: { t: 50, b: 80, l: 50, r: 20 } // Adjust margins
                },
                { responsive: true }
            );
        } catch(e) { console.error(`Chart render error for ${containerId}-chart:`, e); $(`${containerId}-chart`).innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }
    }
}


// Modified renderParetoTab to use AI factors and details
function renderParetoTab(containerId, allFactors) {
    const container = $(containerId);
    let contentHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> 80/20 Pareto Analysis - Combined Factors</h3>`; // Added p-4

    if (allFactors && allFactors.length > 0) {
        // Sort ALL factors by rank (desc impact) for the chart
        const sortedFactors = [...allFactors].sort((a, b) => a.rank - b.rank);
        const topFactorsForChart = sortedFactors.slice(0, 20); // Limit chart display for readability

        contentHtml += `<div id="pareto-chart-container" class="w-full h-[600px] mb-8 bg-black/10 rounded-lg p-2 plotly-chart"></div>`;

        const highPriorityFactors = sortedFactors.filter(f => f.priority === "High");
        contentHtml += `<h4 class="text-xl font-semibold mt-8 mb-3 text-center"> High Priority Factors (Top ~80% Impact)</h4>
                        <p class="text-sm text-white/70 mb-6 italic text-center">Focus strategic efforts on these ${highPriorityFactors.length} factors identified by the AI and prioritized using the Pareto principle.</p>`;

        // Display high priority factors in two columns: Internal vs External
        const highInternal = highPriorityFactors.filter(f => f.type === 'Internal');
        const highExternal = highPriorityFactors.filter(f => f.type === 'External');

        contentHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
        // Internal High Priority
        contentHtml += `<div class="bg-black/20 p-4 rounded-lg">
                           <h5 class="font-bold mb-3 text-center text-blue-300">Internal Priorities (${highInternal.length})</h5>
                           <div class="space-y-3">`;
        if (highInternal.length > 0) {
            highInternal.forEach(f => {
                const swotColor = f.swot === 'Strength' ? 'text-green-400' : 'text-red-400';
                 contentHtml += `<div class="text-xs p-2 bg-black/30 rounded">
                                    <p class="flex justify-between items-center">
                                        <span class="font-semibold text-white">${f.factor}</span>
                                        <span class="text-red-400">Rank #${f.rank}</span>
                                    </p>
                                    <p class="text-white/70 italic my-1">${f.description || ''}</p>
                                    <p class="text-white/60"><span class="${swotColor}">${f.swot}</span> | Cat: ${f.category || 'N/A'} | Score: ${f.impact_score.toFixed(1)}</p>
                                 </div>`;
            });
        } else {
            contentHtml += `<p class="text-white/60 italic text-center text-sm">No high priority internal factors identified.</p>`;
        }
        contentHtml += `</div></div>`; // Close internal div

        // External High Priority
        contentHtml += `<div class="bg-black/20 p-4 rounded-lg">
                            <h5 class="font-bold mb-3 text-center text-yellow-300">External Priorities (${highExternal.length})</h5>
                            <div class="space-y-3">`;
        if (highExternal.length > 0) {
            highExternal.forEach(f => {
                const swotColor = f.swot === 'Opportunity' ? 'text-green-400' : 'text-red-400';
                 contentHtml += `<div class="text-xs p-2 bg-black/30 rounded">
                                     <p class="flex justify-between items-center">
                                        <span class="font-semibold text-white">${f.factor}</span>
                                        <span class="text-red-400">Rank #${f.rank}</span>
                                    </p>
                                    <p class="text-white/70 italic my-1">${f.description || ''}</p>
                                    <p class="text-white/60"><span class="${swotColor}">${f.swot}</span> | Cat: ${f.category || 'N/A'} | Score: ${f.impact_score.toFixed(1)}</p>
                                  </div>`;
            });
        } else {
             contentHtml += `<p class="text-white/60 italic text-center text-sm">No high priority external factors identified.</p>`;
        }
        contentHtml += `</div></div>`; // Close external div
        contentHtml += `</div>`; // Close grid

    } else {
        contentHtml += '<p class="text-white/70 italic text-center">No factors available for Pareto analysis.</p>';
    }

    contentHtml += `</div>`; // Close p-4
    container.innerHTML = contentHtml;

    // Render Pareto Chart
    if (allFactors && allFactors.length > 0) {
         // Use the limited, sorted list for the chart
         const sortedFactors = [...allFactors].sort((a, b) => a.rank - b.rank);
         const topFactorsForChart = sortedFactors.slice(0, 20);

        const trace1 = {
            x: topFactorsForChart.map(f => `(#${f.rank}) ${f.factor.substring(0, 30)}...`), // Add rank, shorten name
            y: topFactorsForChart.map(f => f.impact_score),
            name: 'Impact Score',
            type: 'bar',
            marker: { color: topFactorsForChart.map(f => f.priority === 'High' ? 'var(--accent)' : 'var(--primary)') }
        };

        const trace2 = {
            x: topFactorsForChart.map(f => `(#${f.rank}) ${f.factor.substring(0, 30)}...`),
            y: topFactorsForChart.map(f => f.cumulative_percentage),
            name: 'Cumulative %',
            type: 'scatter', mode: 'lines+markers', // Add markers
            yaxis: 'y2',
            line: { color: '#FFF', width: 2 }, // Thicker white line
            marker: {size: 6}
        };

        const layout = {
            title: '80/20 Pareto Analysis - Top 20 Factors by Impact', // Updated title
            xaxis: { tickangle: -45, automargin: true, tickfont: { size: 9 } }, // Even smaller font
            yaxis: { title: 'Impact Score (1-10)', gridcolor: 'rgba(255,255,255,0.1)' },
            yaxis2: { title: 'Cumulative Impact %', overlaying: 'y', side: 'right', range: [0, 101], gridcolor: 'rgba(255,255,255,0.1)', zeroline: false },
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
            legend: { orientation: 'h', y: -0.3 }, // Adjust legend position maybe
            shapes: [{
                type: 'line', xref: 'paper', yref: 'y2', x0: 0, y0: 80, x1: 1, y1: 80,
                line: { color: 'orange', width: 2, dash: 'dash' }
            }],
             margin: { t: 50, b: 120, l: 50, r: 50 } // Adjust margins
        };

        try {
            Plotly.newPlot('pareto-chart-container', [trace1, trace2], layout, { responsive: true });
        } catch(e) { console.error("Pareto chart render error:", e); $("pareto-chart-container").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }
    }
}


// Modified renderSummaryTab to use AI factors
function renderSummaryTab(containerId, external, internal) {
    const container = $(containerId);

     // Ensure factors are arrays
     external = Array.isArray(external) ? external : [];
     internal = Array.isArray(internal) ? internal : [];

    const highPriorityExternal = external.filter(f => f.priority === 'High').length;
    const highPriorityInternal = internal.filter(f => f.priority === 'High').length;

    // Find top categories based on *count* of high-priority items
    const getTopHighPriorityCategory = (factors) => {
         if (!factors || factors.length === 0) return "N/A";
         const highPriority = factors.filter(f => f.priority === 'High');
         if (highPriority.length === 0) return "N/A (None High Priority)";
         const counts = highPriority.reduce((acc, f) => {
              const cat = f.category || "Uncategorized";
              acc[cat] = (acc[cat] || 0) + 1;
              return acc;
         }, {});
         return Object.entries(counts).sort((a,b) => b[1] - a[1])[0][0];
    };

    const topExtCatHighPrio = getTopHighPriorityCategory(external);
    const topIntCatHighPrio = getTopHighPriorityCategory(internal);

    container.innerHTML = `
        <div class="p-4"> <!-- Added p-4 -->
            <h3 class="text-2xl font-bold mb-4"> Executive Summary</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="summary-stat-card"><div class="stat-value">${external.length}</div><div class="stat-label">Total External Factors</div></div>
                <div class="summary-stat-card"><div class="stat-value">${internal.length}</div><div class="stat-label">Total Internal Factors</div></div>
                <div class="summary-stat-card ${highPriorityExternal > 0 ? 'border-l-4 border-red-500' : ''}"><div class="stat-value">${highPriorityExternal}</div><div class="stat-label">High-Priority External</div></div>
                <div class="summary-stat-card ${highPriorityInternal > 0 ? 'border-l-4 border-red-500' : ''}"><div class="stat-value">${highPriorityInternal}</div><div class="stat-label">High-Priority Internal</div></div>
            </div>
            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-xl font-semibold mb-3">Key Insights & Strategic Focus</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li>A total of <strong>${external.length + internal.length}</strong> strategic factors were identified from the text.</li>
                    <li>Pareto analysis highlighted <strong>${highPriorityExternal + highPriorityInternal}</strong> factors (${highPriorityExternal} external, ${highPriorityInternal} internal) as 'High Priority', representing the critical few likely driving ~80% of strategic impact.</li>
                    <li>The most frequent category among high-priority <strong>external</strong> factors appears to be <strong>${topExtCatHighPrio}</strong>. Strategies should consider leveraging opportunities or mitigating threats in this area.</li>
                    <li>The most frequent category among high-priority <strong>internal</strong> factors appears to be <strong>${topIntCatHighPrio}</strong>. Strategies should focus on exploiting related strengths or addressing related weaknesses.</li>
                    <li><strong>Recommendation:</strong> Focus primary strategic efforts on the ${highPriorityExternal + highPriorityInternal} 'High Priority' factors identified in the '80/20 Analysis' tab.</li>
                </ul>
            </div>
         </div>`; // Close p-4
}


// Remove unused JS functions (optional, but good practice)
// function findFactors(...) {}
// function extractExternalFactorsJS(...) {}
// function extractInternalFactorsJS(...) {}
// function calculateFactorImpactJS(...) {}


    function renderFactorTab(containerId, title, factors) {
        const container = $(containerId);
        let contentHtml = `<h3 class="text-2xl font-bold mb-4">${title}</h3>`;

        if (factors && factors.length > 0) {
            const categories = factors.reduce((acc, f) => {
                if (!acc[f.category]) acc[f.category] = [];
                acc[f.category].push(f);
                return acc;
            }, {});

            contentHtml += `<div id="${containerId}-chart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;

            for (const category in categories) {
                contentHtml += `<div class="mb-4"><details class="bg-white/5 p-3 rounded-lg"><summary class="cursor-pointer font-semibold">${category} (${categories[category].length} factors)</summary><div class="mt-2 pl-4">`;
                categories[category].forEach((factor) => {
                    contentHtml += `<div class="py-2 border-b border-white/10 last:border-b-0">
                                <p class="${factor.priority === "High" ? "text-red-300" : "text-yellow-300"}"><strong>Rank #${factor.rank}</strong> - Score: ${factor.impact_score}</p>
                                <p>${factor.factor}</p>
                                <p class="text-sm text-white/60">Priority: ${factor.priority} | Cumulative: ${factor.cumulative_percentage}%</p>
                            </div>`;
                });
                contentHtml += `</div></details></div>`;
            }
        } else {
            contentHtml += '<p class="text-white/70">No factors found in this category.</p>';
        }

        container.innerHTML = contentHtml;

        if (factors && factors.length > 0) {
            const categoryCounts = Object.entries(
                factors.reduce((acc, f) => {
                    acc[f.category] = (acc[f.category] || 0) + 1;
                    return acc;
                }, {})
            ).map(([cat, count]) => ({ category: cat, count: count }));

            Plotly.newPlot(
                `${containerId}-chart`,
                [
                    {
                        x: categoryCounts.map((c) => c.category),
                        y: categoryCounts.map((c) => c.count),
                        type: "bar",
                        marker: { color: "var(--primary)" }
                    }
                ],
                {
                    title: `${title.split(" ")[0]} Factors by Category`,
                    paper_bgcolor: "rgba(0,0,0,0)",
                    plot_bgcolor: "rgba(0,0,0,0)",
                    font: { color: "white" },
                    xaxis: { automargin: true, tickangle: -25 },
                    yaxis: { title: "Number of Factors", gridcolor: "rgba(255,255,255,0.2)" }
                },
                { responsive: true }
            );
        }
    }

    function renderParetoTab(containerId, allFactors) {
        const container = $(containerId);
        let contentHtml = `<h3 class="text-2xl font-bold mb-4"> 80/20 Pareto Analysis</h3>`;

        if (allFactors && allFactors.length > 0) {
            contentHtml += `<div id="pareto-chart-container" class="w-full h-[600px] mb-8 plotly-chart"></div>`;

            const highPriorityFactors = allFactors.filter((f) => f.priority === "High");
            contentHtml += `<h4 class="text-xl font-semibold mt-8 mb-3"> Priority Recommendations</h4>
                                    <p class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6"><strong>80/20 Rule Application:</strong> Focus on the top ${highPriorityFactors.length} factors to address ~80% of the strategic impact.</p>`;

            const extHigh = highPriorityFactors.filter((f) => f.type === "External").slice(0, 5);
            const intHigh = highPriorityFactors.filter((f) => f.type === "Internal").slice(0, 5);

            contentHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><h5 class="font-bold mb-2">Top External Priorities</h5>`;
            extHigh.forEach((f) => {
                contentHtml += `<div class="text-sm mb-2 p-2 bg-white/5 rounded"><strong>${f.category}:</strong> ${f.factor.substring(0, 60)}...</div>`;
            });
            contentHtml += `</div><div><h5 class="font-bold mb-2">Top Internal Priorities</h5>`;
            intHigh.forEach((f) => {
                contentHtml += `<div class="text-sm mb-2 p-2 bg-white/5 rounded"><strong>${f.category}:</strong> ${f.factor.substring(0, 60)}...</div>`;
            });
            contentHtml += `</div></div>`;
        } else {
            contentHtml += '<p class="text-white/70">No factors available for Pareto analysis.</p>';
        }

        container.innerHTML = contentHtml;

        if (allFactors && allFactors.length > 0) {
            const topFactors = [...allFactors].sort((a, b) => b.impact_score - a.impact_score).slice(0, 15);

            const trace1 = {
                x: topFactors.map((f) => `${f.type.substring(0, 3)}: ${f.factor.substring(0, 40)}...`),
                y: topFactors.map((f) => f.impact_score),
                name: "Impact Score",
                type: "bar",
                marker: { color: topFactors.map((f) => (f.priority === "High" ? "var(--accent)" : "var(--primary)")) }
            };

            const trace2 = {
                x: topFactors.map((f) => `${f.type.substring(0, 3)}: ${f.factor.substring(0, 40)}...`),
                y: topFactors.map((f) => f.cumulative_percentage),
                name: "Cumulative %",
                type: "scatter",
                yaxis: "y2",
                line: { color: "#FFF" }
            };

            const layout = {
                title: "80/20 Pareto Analysis - Top Strategic Factors",
                xaxis: { tickangle: -45, automargin: true },
                yaxis: { title: "Impact Score" },
                yaxis2: { title: "Cumulative %", overlaying: "y", side: "right", range: [0, 101] },
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                legend: { orientation: "h", y: -0.4 },
                shapes: [
                    {
                        type: "line",
                        xref: "paper",
                        yref: "y2",
                        x0: 0,
                        y0: 80,
                        x1: 1,
                        y1: 80,
                        line: { color: "orange", width: 2, dash: "dash" }
                    }
                ]
            };

            Plotly.newPlot("pareto-chart-container", [trace1, trace2], layout, { responsive: true });
        }
    }

    function renderSummaryTab(containerId, external, internal) {
        const container = $(containerId);
        const highPriorityExternal = external.filter((f) => f.priority === "High").length;
        const highPriorityInternal = internal.filter((f) => f.priority === "High").length;
        const topExtCat =
            external.length > 0
                ? Object.entries(
                      external.reduce((acc, f) => {
                          acc[f.category] = (acc[f.category] || 0) + 1;
                          return acc;
                      }, {})
                  ).sort((a, b) => b[1] - a[1])[0][0]
                : "N/A";
        const topIntCat =
            internal.length > 0
                ? Object.entries(
                      internal.reduce((acc, f) => {
                          acc[f.category] = (acc[f.category] || 0) + 1;
                          return acc;
                      }, {})
                  ).sort((a, b) => b[1] - a[1])[0][0]
                : "N/A";

        container.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4"> Executive Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="metric-card"><h4 class="font-bold">Total External Factors</h4><p class="text-3xl font-bold">${external.length}</p></div>
                        <div class="metric-card"><h4 class="font-bold">Total Internal Factors</h4><p class="text-3xl font-bold">${internal.length}</p></div>
                        <div class="metric-card critical"><h4 class="font-bold">High-Priority External</h4><p class="text-3xl font-bold">${highPriorityExternal}</p></div>
                        <div class="metric-card critical"><h4 class="font-bold">High-Priority Internal</h4><p class="text-3xl font-bold">${highPriorityInternal}</p></div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-lg">
                        <h4 class="text-xl font-semibold mb-3">Key Insights</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>External Focus:</strong> The most dominant external factors fall under the <strong>${topExtCat}</strong> category.</li>
                            <li><strong>Internal Focus:</strong> Internally, factors related to <strong>${topIntCat}</strong> are most prominent.</li>
                            <li><strong>80/20 Application:</strong> A total of <strong>${highPriorityExternal + highPriorityInternal}</strong> factors have been identified as high-priority, representing the critical 20% that likely drive 80% of strategic impact.</li>
                        </ul>
                    </div>
                 `;
    }

    async function handleKpiAnalysis_KE() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Defining Performance Metrics & Milestones...</h3><p class="text-white/80 mb-2">Identifying key indicators and critical events based *only* on your text...</p></div>`; // Updated text
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = $("docUpload").checked;
        let text = "";
        if (useDoc) {
            const file = $("kpiFile").files[0];
            if (!file) throw new Error("Please select a document.");
            text = await extractTextFromFile(file);
        } else {
            text = $("kpiContent").value.trim();
            if (!text.trim()) throw new Error("Please describe the project or goal.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (text.length > MAX_CONTEXT_LENGTH) {
            text = text.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`KPI & Events analysis context truncated.`);
        }

        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are a performance management and strategy execution expert. Analyze the user's goal/project description based **ONLY** on the provided text. Develop a framework of Key Performance Indicators (KPIs) and critical events derived **strictly** from that text. ${truncatedNote}

            **USER'S GOAL / PROJECT DESCRIPTION:**
            \`\`\`
            ${text}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Refine Goal:** Provide a refined, single-sentence summary of the user's primary goal (\`main_goal\`) **based ONLY on the text**.
            2.  **Define KPIs (4-6 KPIs):** Create an array of \`kpis\`. For each KPI, derive the following **strictly from the user's text**:
                * \`name\`: The name of the KPI **mentioned or logically implied**.
                * \`description\`: A brief explanation of what it measures **in this context**.
                * \`formula\`: How the KPI is calculated (e.g., "(Repeat Customers / Total Customers) * 100") **based on terms in the text**. If not explicitly calculable, describe conceptually (e.g., "Survey score on 7-point scale").
                * \`target\`: A specific, measurable target **mentioned or clearly implied in the text**. If none, state "Target Not Specified in Text".
                * \`type\`: Category (e.g., "Leading", "Lagging", "Financial", "Customer", "Operational") **inferred ONLY from the KPI's role described or implied in the text**.
            3.  **Define Critical Events (3-5 events):** Create an array of major project milestones (\`critical_events\`). For each event, derive the following **strictly from the user's text**:
                * \`event_name\`: Name of the milestone **mentioned or logically implied**.
                * \`description\`: What signifies completion **based on the text**.
                * \`timeline\`: Target timeframe **inferred ONLY from text scope or mentions**.
                * \`importance\`: Assess importance ("High" or "Medium") **based on text**.
            4.  **Performance Summary:** Write a brief \`performance_summary\` (2-3 sentences) linking the key KPIs and critical events back to achieving the main goal, **using ONLY information derived from the text**.
            5.  **Self-Correction:** Rigorously check: Is the goal derived solely from text? Is EVERY detail of KPIs and Events (name, desc, formula, target, type, timeline, importance) **strictly derived ONLY from the user's text**? Is the summary accurate based on text? Is JSON perfect? Fix errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT IS KING:** Base **ALL** output **EXCLUSIVELY** on the provided "USER'S GOAL / PROJECT DESCRIPTION". **DO NOT** invent KPIs, events, targets, formulas, timelines, or summaries. If information isn't in the text, state that appropriately (e.g., in the target field).
            - **NO GENERIC EXAMPLES:** Replace **ALL** placeholder text in the RETURN FORMAT structure below with content generated **strictly from the user's input text**.
            - **JSON FORMAT:** Adhere EXACTLY.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. Replace ALL bracketed placeholders strictly based on the user's input text.
            {
              "main_goal": "[Refined goal statement ONLY from user text]",
              "kpis": [ // 4-6 KPIs derived ONLY from text
                {
                  "name": "[KPI Name ONLY from text]",
                  "description": "[Description ONLY based on text context]",
                  "formula": "[Formula or calculation method ONLY from text]",
                  "target": "[Target ONLY from text or 'Target Not Specified in Text']",
                  "type": "[Leading/Lagging/Financial/etc. inferred ONLY from text]"
                },
                //...
              ],
              "critical_events": [ // 3-5 events derived ONLY from text
                {
                  "event_name": "[Event Name ONLY from text]",
                  "description": "[Completion criteria ONLY from text]",
                  "timeline": "[Timeline inferred ONLY from text]",
                  "importance": "[High/Medium based ONLY on text]"
                },
                //...
              ],
              "performance_summary": "[2-3 sentence summary linking KPIs/Events to goal, using ONLY text-derived info]"
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED KPI & Events prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (KPI & Events - SP):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced KPI & Events SP) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !parsedData.main_goal || typeof parsedData.main_goal !== 'string' || parsedData.main_goal.includes("[") ||
                 !Array.isArray(parsedData.kpis) || parsedData.kpis.length < 2 || // Expect a few KPIs
                 !Array.isArray(parsedData.critical_events) || parsedData.critical_events.length < 1 || // Expect at least one event
                 !parsedData.performance_summary || typeof parsedData.performance_summary !== 'string' || parsedData.performance_summary.includes("[") ||
                 // Check structure of first KPI
                 (parsedData.kpis.length > 0 && (
                     typeof parsedData.kpis[0] !== 'object' ||
                     !parsedData.kpis[0].hasOwnProperty('name') || parsedData.kpis[0].name.includes("[") ||
                     !parsedData.kpis[0].hasOwnProperty('description') || parsedData.kpis[0].description.includes("[") ||
                     !parsedData.kpis[0].hasOwnProperty('formula') || // Allow formula to be complex string
                     !parsedData.kpis[0].hasOwnProperty('target') || // Allow specific string for missing target
                     !parsedData.kpis[0].hasOwnProperty('type') || parsedData.kpis[0].type.includes("[")
                 )) ||
                  // Check structure of first Event
                  (parsedData.critical_events.length > 0 && (
                      typeof parsedData.critical_events[0] !== 'object' ||
                      !parsedData.critical_events[0].hasOwnProperty('event_name') || parsedData.critical_events[0].event_name.includes("[") ||
                      !parsedData.critical_events[0].hasOwnProperty('description') || parsedData.critical_events[0].description.includes("[") ||
                      !parsedData.critical_events[0].hasOwnProperty('timeline') || parsedData.critical_events[0].timeline.includes("[") ||
                      !parsedData.critical_events[0].hasOwnProperty('importance') || !['High', 'Medium'].includes(parsedData.critical_events[0].importance)
                  ))
                )
             {
                  console.error("Validation Failed (Enhanced KPI & Events SP): Required fields missing, invalid structure, or placeholders detected.", parsedData);
                  throw new Error(`AI response structure is incorrect, inconsistent, or contains placeholders (Enhanced KPI & Events SP). Check all fields carefully. See console logs.`);
             }
             console.log(`Successfully parsed ENHANCED KPI & Events (SP) JSON using ${MODEL_NAME}. Found ${parsedData.kpis.length} KPIs.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED KPI & Events (SP) JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced KPI & Events SP): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results
        renderKpiPage_KE(analysisResultContainer, parsedData); // Use the updated renderer

    } catch (error) {
        console.error(`Error in handleKpiAnalysis_KE (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}

    // --- START: Re-implementation of renderKpiPage_KE ---

// Modified renderKpiPage_KE to add more Tabs and display detailed data
function renderKpiPage_KE(container, data) {
    container.innerHTML = ""; // Clear loading state

    // --- Input Data Validation ---
    if (!data || typeof data !== 'object' ||
        !data.main_goal || typeof data.main_goal !== 'string' ||
        !Array.isArray(data.kpis) ||
        !Array.isArray(data.critical_events) ||
        !data.performance_summary || typeof data.performance_summary !== 'string')
    {
        console.error("Incomplete or invalid data passed to renderKpiPage_KE:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete or invalid analysis data received. Cannot render KPI & Events results. Check console for details.</div>`;
        $("analysisActions").classList.add("hidden"); // Ensure save buttons are hidden on error
        return; // Stop execution if data is bad
    }
    // Destructure data *after* validation
    const { main_goal, kpis, critical_events, performance_summary } = data;

    // --- Create Tab Navigation (5 Tabs) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> KPI Dashboard</button>
        <button class="analysis-tab-btn" data-tab="kpiDetails"> KPI Details</button>
        <button class="analysis-tab-btn" data-tab="timeline"> Events Timeline</button>
        <button class="analysis-tab-btn" data-tab="eventDetails"> Event Details</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn KPIs & Milestones</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (5 Panels) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="kpiDetailsPanel" class="analysis-tab-panel"></div>
        <div id="timelinePanel" class="analysis-tab-panel"></div>
        <div id="eventDetailsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate KPI Dashboard Panel ---
    try {
        const dashboardPanel = $("dashboardPanel");
        let dashboardHtml = `<div class="p-4 space-y-8">
            <div class="p-6 rounded-lg bg-black/20 border border-white/10 text-center">
                <h3 class="text-xl font-bold mb-2 text-indigo-300"> Main Goal</h3>
                <p class="text-2xl italic text-white/90">${main_goal}</p>
            </div>
            <blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90 text-sm">
                <strong>Performance Summary:</strong> ${performance_summary}
            </blockquote>
            <h3 class="text-2xl font-bold text-center">Key Performance Indicators</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-${Math.min(kpis.length, 5)} gap-4">`; // Dynamic columns
        if (kpis.length > 0) {
            kpis.forEach((kpi) => {
                 // Validate kpi object structure before accessing properties
                 if (kpi && typeof kpi === 'object' && kpi.hasOwnProperty('name') && kpi.hasOwnProperty('target') && kpi.hasOwnProperty('type')) {
                     const targetDisplay = kpi.target === "Target Not Specified in Text" ? "N/A" : kpi.target;
                     const targetClass = targetDisplay === 'N/A' ? 'text-xl text-white/60' : ''; // Style N/A differently
                     dashboardHtml += `
                        <div class="kpi-card">
                            <div><p class="kpi-name">${kpi.name || 'Unnamed KPI'}</p></div>
                            <div><p class="kpi-target ${targetClass}">${targetDisplay}</p></div>
                            <div><p class="kpi-type">${kpi.type || 'N/A'}</p></div>
                        </div>`;
                 } else {
                      console.warn("Skipping invalid KPI object in dashboard:", kpi);
                 }
            });
        } else {
            dashboardHtml += `<p class="col-span-full text-center text-white/60 italic">No KPIs identified.</p>`;
        }
        dashboardHtml += `</div></div>`; // Close grid and p-4 space-y-8
        dashboardPanel.innerHTML = dashboardHtml;
    } catch (e) {
         console.error("Error rendering Dashboard Panel:", e);
         $("dashboardPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering dashboard.</div>`;
    }

    // --- 2. Populate KPI Details Panel ---
    try {
        const kpiDetailsPanel = $("kpiDetailsPanel");
        let kpiDetailsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> KPI Details</h3>`;
        kpiDetailsHtml += `<div class="overflow-x-auto">
                            <table class="coeff-table styled-table text-sm">
                                <thead><tr><th>KPI Name</th><th>Description</th><th>Formula / Calculation</th><th>Target</th><th>Type</th></tr></thead>
                                <tbody>`;
        if (kpis.length > 0) {
            kpis.forEach((kpi) => {
                 if (kpi && typeof kpi === 'object' && kpi.hasOwnProperty('name')) { // Basic validation
                    const targetDisplay = kpi.target === "Target Not Specified in Text" ? "<i class='text-white/50'>N/A in text</i>" : (kpi.target || 'N/A');
                    kpiDetailsHtml += `<tr>
                                    <td class="font-semibold">${kpi.name || 'Unnamed KPI'}</td>
                                    <td class="text-white/80">${kpi.description || 'N/A'}</td>
                                    <td class="font-mono text-xs">${kpi.formula || 'N/A'}</td>
                                    <td>${targetDisplay}</td>
                                    <td class="text-white/70">${kpi.type || 'N/A'}</td>
                                  </tr>`;
                 } else {
                     console.warn("Skipping invalid KPI object in details table:", kpi);
                 }
            });
        } else {
            kpiDetailsHtml += `<tr><td colspan="5" class="text-center text-white/60 italic p-4">No KPIs were identified from the text.</td></tr>`;
        }
        kpiDetailsHtml += `</tbody></table></div></div>`; // Close table div and p-4
        kpiDetailsPanel.innerHTML = kpiDetailsHtml;
    } catch (e) {
         console.error("Error rendering KPI Details Panel:", e);
         $("kpiDetailsPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering KPI details.</div>`;
    }

    // --- 3. Populate Events Timeline Panel ---
    try {
        const timelinePanel = $("timelinePanel");
        // Use main_goal for title consistency
        let timelineHtml = `<div class="p-4"><h2 class="text-3xl font-bold text-center mb-8">${main_goal} - Critical Events Timeline</h2><div class="action-plan-container flex flex-col items-center">`;
        if (critical_events.length > 0) {
            // Sorting logic included
            const sorted_events = [...critical_events].sort((a, b) => {
                 const getTimeValue = (timeline) => {
                     timeline = String(timeline || '').toLowerCase();
                     if (timeline.includes('week')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 7;
                     if (timeline.includes('month')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 30;
                     if (timeline.includes('q')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 90;
                     return 9999;
                 };
                 return getTimeValue(a.timeline) - getTimeValue(b.timeline);
             });

            sorted_events.forEach((event) => {
                 if (event && typeof event === 'object' && event.hasOwnProperty('event_name')) { // Basic validation
                    const importanceColor = event.importance === 'High' ? '#ef4444' : '#f97316'; // Red for High, Orange for Medium
                    const importanceIcon = event.importance === 'High' ? '' : '';

                    timelineHtml += `
                        <div class="timeline-item">
                            <div class="timeline-dot" style="border-color: ${importanceColor};"></div>
                            <div class="timeline-content border-l-4" style="border-left-color: ${importanceColor};">
                                <p class="text-xs text-indigo-300 font-semibold">${event.timeline || 'N/A'}</p>
                                <h4 class="text-lg font-bold">${event.event_name || 'Unnamed Event'}</h4>
                                <p class="text-xs font-bold mt-1">${importanceIcon} Importance: ${event.importance || 'N/A'}</p>
                            </div>
                        </div>`;
                 } else {
                      console.warn("Skipping invalid event object in timeline:", event);
                 }
            });
        } else {
            timelineHtml += `<p class="text-center text-white/70 italic">No critical events were identified from the text.</p>`;
        }
        timelineHtml += `</div></div>`; // Close container and p-4
        timelinePanel.innerHTML = timelineHtml;
    } catch (e) {
        console.error("Error rendering Timeline Panel:", e);
        $("timelinePanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering timeline.</div>`;
    }

    // --- 4. Populate Event Details Panel ---
    try {
        const eventDetailsPanel = $("eventDetailsPanel");
        let eventDetailsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> Event Details</h3>`;
        eventDetailsHtml += `<div class="overflow-x-auto">
                            <table class="coeff-table styled-table text-sm">
                                <thead><tr><th>Event Name</th><th>Description (Completion Criteria)</th><th>Timeline</th><th>Importance</th></tr></thead>
                                <tbody>`;
        if (critical_events.length > 0) {
            critical_events.forEach((event) => {
                 if (event && typeof event === 'object' && event.hasOwnProperty('event_name')) { // Basic validation
                    const importanceColor = event.importance === 'High' ? 'text-red-400' : 'text-yellow-400';
                    eventDetailsHtml += `<tr>
                                    <td class="font-semibold">${event.event_name || 'Unnamed Event'}</td>
                                    <td class="text-white/80">${event.description || 'N/A'}</td>
                                    <td class="text-white/70">${event.timeline || 'N/A'}</td>
                                    <td><span class="font-bold ${importanceColor}">${event.importance || 'N/A'}</span></td>
                                  </tr>`;
                 } else {
                      console.warn("Skipping invalid event object in details table:", event);
                 }
            });
        } else {
            eventDetailsHtml += `<tr><td colspan="4" class="text-center text-white/60 italic p-4">No event details were identified from the text.</td></tr>`;
        }
        eventDetailsHtml += `</tbody></table></div></div>`; // Close table div and p-4
        eventDetailsPanel.innerHTML = eventDetailsHtml;
    } catch (e) {
        console.error("Error rendering Event Details Panel:", e);
        $("eventDetailsPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering event details.</div>`;
    }

    // --- 5. Populate Learn KPIs & Milestones Panel ---
    try {
        const learnPanel = $("learnPanel");
        // Re-using the content previously generated for this tab
        learnPanel.innerHTML = `
        <div class="p-6 space-y-6 text-white/90">
            <h3 class="text-2xl font-bold text-center mb-4"> Understanding KPIs & Milestones</h3>
             
            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-lg font-bold mb-2 text-indigo-300">Why Track Performance?</h4>
                <p class="text-sm text-white/80">Tracking performance is crucial for strategy execution. Key Performance Indicators (KPIs) measure progress towards goals, while Critical Events (Milestones) mark significant achievements along the way. Together, they provide visibility and enable course correction.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2 text-green-300"> Key Performance Indicators (KPIs)</h4>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><strong>Definition:</strong> Measurable values demonstrating how effectively a company is achieving key business objectives.</li>
                        <li><strong>Characteristics (SMART):</strong> Specific, Measurable, Achievable, Relevant, Time-bound.</li>
                        <li><strong>Types:</strong>
                            <ul class="list-[circle] list-inside pl-4 text-xs">
                               <li><strong>Lagging Indicators:</strong> Measure past performance (e.g., Revenue, Profit, Churn Rate). Show results.</li>
                               <li><strong>Leading Indicators:</strong> Measure activities likely to drive future results (e.g., Website Visits, Sales Leads, Employee Training Hours). Predict success.</li>
                               <li><strong>Financial:</strong> Related to money (e.g., ROI, Margin).</li>
                               <li><strong>Customer:</strong> Related to customer perception/behavior (e.g., CSAT, NPS, Retention).</li>
                               <li><strong>Operational:</strong> Related to internal processes (e.g., Cycle Time, Defect Rate).</li>
                            </ul>
                        </li>
                         <li><strong>Purpose:</strong> Monitor health, identify trends, inform decisions, measure strategic success.</li>
                    </ul>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2 text-yellow-300"> Critical Events (Milestones)</h4>
                     <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><strong>Definition:</strong> Significant points or achievements in a project or strategic initiative timeline.</li>
                        <li><strong>Characteristics:</strong> Clearly defined, mark transition between phases, often represent completion of major deliverables.</li>
                        <li><strong>Examples:</strong> Project Kick-off, Design Approval, Product Launch, Funding Secured, Regulatory Approval, First Customer Acquired.</li>
                        <li><strong>Purpose:</strong> Break down large projects, track progress, provide clear deadlines, facilitate communication, celebrate achievements.</li>
                     </ul>
                </div>
            </div>

             <div class="bg-black/20 p-4 rounded-lg mt-6">
                <h4 class="text-lg font-bold mb-2">Connecting KPIs and Milestones</h4>
                 <ul class="list-disc list-inside space-y-1 text-sm">
                    <li>Milestones mark *when* key things happen; KPIs measure *how well* things are happening or the *results* of those happenings.</li>
                    <li>Achieving milestones should ideally lead to improvements in relevant KPIs.</li>
                    <li>KPI trends can signal potential issues *before* a milestone is missed.</li>
                    <li>Both are essential for effective strategy execution and performance management.</li>
                </ul>
            </div>
             <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to identify potential KPIs and Critical Events based strictly on the goal/project description you provided.</p>
        </div>
        `;
    } catch (e) {
         console.error("Error rendering Learn Panel:", e);
         $("learnPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering learning content.</div>`;
    }

    // --- Final Touches ---
    try {
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                // Deactivate all
                tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

                // Activate clicked
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add("active");
                     // No Plotly charts expected here, no resize needed
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
    } catch (e) {
         console.error("Error setting up final touches (tabs, cache, buttons):", e);
         // Don't overwrite the container if there was a rendering error earlier
         if (!container.innerHTML.includes('text-red-400')) {
              container.innerHTML += `<div class="p-4 text-center text-red-400">Error setting up UI components.</div>`;
         }
    }
    // setLoading('generate', false); // This is handled in the calling function
}


// --- END: Re-implementation of renderKpiPage_KE ---



    function renderFullSwotTowsPage(container, data) {
        container.innerHTML = ""; // Clear loading state
        const { swot_analysis, tows_strategies, key_insights_80_20 } = data;
        if (!swot_analysis || !tows_strategies || !key_insights_80_20) {
            container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete analysis data received.</div>`;
            return;
        }

        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
                    <button class="analysis-tab-btn active" data-tab="swot">SWOT Matrix</button>
                    <button class="analysis-tab-btn" data-tab="tows">TOWS Strategies</button>
                    <button class="analysis-tab-btn" data-tab="insights">80/20 Key Insights</button>
                    <button class="analysis-tab-btn" data-tab="details">Detailed Analysis</button>
                `;
        container.appendChild(tabNav);

        const tabContent = document.createElement("div");
        container.appendChild(tabContent);

        tabContent.innerHTML = `
                    <div id="swotPanel" class="analysis-tab-panel active"></div>
                    <div id="towsPanel" class="analysis-tab-panel"></div>
                    <div id="insightsPanel" class="analysis-tab-panel"></div>
                    <div id="detailsPanel" class="analysis-tab-panel"></div>
                `;

        renderSwotVisualization(swot_analysis, "swotPanel");
        renderTowsVisualization(tows_strategies, "towsPanel");
        render8020Visualization(key_insights_80_20, "insightsPanel");
        renderDetailedAnalysis(swot_analysis, tows_strategies, "detailsPanel");

        analysisCache[currentTemplateId] = container.innerHTML;

        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanel = $(e.target.dataset.tab + "Panel");
                targetPanel.classList.add("active");
                const chart = targetPanel.querySelector(".plotly-chart");
                if (chart) Plotly.Plots.resize(chart);
            }
        });
    }

    async function handleSwotTowsAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `
        <div class="text-center text-white/70 p-8">
            <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
            <h3 class="text-xl font-semibold text-white mb-4">Performing Comprehensive SWOT/TOWS Analysis...</h3>
            <p class="text-white/80 mb-2">Analyzing factors, generating strategies, and identifying priorities based *only* on your text...</p> <!-- Updated text -->
            <p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p>
        </div>`;
    setLoading("generate", true); // Ensure loading state is set

    const statusEl = $("analysisStatus");
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // --- Step 0: Gather Input ---
        statusEl.textContent = "Reading your business content...";
        const useDoc = $("docUpload").checked;
        let businessContent = "";

        if (useDoc) {
            const file = $("swotFile").files[0];
            if (!file) throw new Error("Please select a document to upload.");
            businessContent = await extractTextFromFile(file);
        } else {
            businessContent = $("businessContent").value.trim();
            if (!businessContent.trim()) throw new Error("Please enter business information in the text area.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (businessContent.length > MAX_CONTEXT_LENGTH) {
            businessContent = businessContent.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`SWOT/TOWS analysis context truncated.`);
        }

        // --- Helper: Call Ollama ---
        async function generateOllamaResponse(prompt) {
             console.log(`Sending prompt to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json", // Expect JSON format directly
                    options: { num_ctx: 32768 }
                })
            });
            if (!response.ok) {
                 let errorBody = `Ollama API error ${response.status}`;
                 try { errorBody += `: ${await response.text()}`; } catch(e){}
                 throw new Error(errorBody);
            }
            const data = await response.json();
            console.log('Raw AI Response:', data.response);
             try {
                 const parsed = JSON.parse(data.response);
                 console.log('Successfully parsed AI JSON response.');
                 return parsed;
             } catch (e) {
                 console.error("Failed to parse AI JSON response:", data.response, e);
                 throw new Error("Invalid JSON received from AI. Check AI logs or prompt structure.");
             }
        }

        // --- Step 1: Extract Internal Factors (S/W) with Descriptions ---
        statusEl.textContent = "Step 1/4: Analyzing internal factors (Strengths & Weaknesses)...";
        const internalPrompt = `
            Analyze the following business content based **ONLY** on the text provided. Identify 4-6 specific internal Strengths and 4-6 specific internal Weaknesses. ${truncatedNote}

            **USER'S BUSINESS CONTENT:**
            \`\`\`
            ${businessContent}
            \`\`\`

            **TASK:** For each Strength and Weakness identified **solely from the text**:
            1.  Provide a concise \`factor\` name (2-5 words).
            2.  Provide a brief \`description\` (1 sentence) summarizing the factor **using wording found in or directly inferred from the text**.

            **ABSOLUTE CONSTRAINTS:**
            - Base **ALL** output **EXCLUSIVELY** on the provided "USER'S BUSINESS CONTENT". **DO NOT** invent factors or descriptions.
            - Strengths = internal positive factors the company controls (mentioned in text).
            - Weaknesses = internal negative factors the company needs to address (mentioned in text).

            **RETURN FORMAT:** Provide ONLY a valid JSON object:
            {
              "strengths": [
                {"factor": "[Strength Name ONLY from text]", "description": "[Description ONLY from text wording]"},
                // ... 4-6 total ...
              ],
              "weaknesses": [
                 {"factor": "[Weakness Name ONLY from text]", "description": "[Description ONLY from text wording]"},
                 // ... 4-6 total ...
              ]
            }`;
        const internal_factors = await generateOllamaResponse(internalPrompt);
        // *** Validation ***
        if (!internal_factors || !Array.isArray(internal_factors.strengths) || !Array.isArray(internal_factors.weaknesses) || (internal_factors.strengths.length > 0 && typeof internal_factors.strengths[0] !== 'object') ) {
             console.error("Invalid internal factors structure:", internal_factors);
             throw new Error("AI failed to return valid internal factors. Check response structure.");
        }
        console.log(`Extracted ${internal_factors.strengths.length} Strengths, ${internal_factors.weaknesses.length} Weaknesses.`);


        // --- Step 2: Extract External Factors (O/T) with Descriptions ---
        statusEl.textContent = "Step 2/4: Analyzing external factors (Opportunities & Threats)...";
        const externalPrompt = `
            Analyze the following business content based **ONLY** on the text provided. Identify 4-6 specific external Opportunities and 4-6 specific external Threats. ${truncatedNote}

            **USER'S BUSINESS CONTENT:**
            \`\`\`
            ${businessContent}
            \`\`\`

            **TASK:** For each Opportunity and Threat identified **solely from the text**:
            1.  Provide a concise \`factor\` name (2-5 words).
            2.  Provide a brief \`description\` (1 sentence) summarizing the factor **using wording found in or directly inferred from the text**.

            **ABSOLUTE CONSTRAINTS:**
            - Base **ALL** output **EXCLUSIVELY** on the provided "USER'S BUSINESS CONTENT". **DO NOT** invent factors or descriptions.
            - Opportunities = external positive factors the company can leverage (mentioned in text).
            - Threats = external negative factors that pose risks (mentioned in text).

            **RETURN FORMAT:** Provide ONLY a valid JSON object:
            {
              "opportunities": [
                {"factor": "[Opportunity Name ONLY from text]", "description": "[Description ONLY from text wording]"},
                 // ... 4-6 total ...
              ],
              "threats": [
                 {"factor": "[Threat Name ONLY from text]", "description": "[Description ONLY from text wording]"},
                 // ... 4-6 total ...
              ]
            }`;
        const external_factors = await generateOllamaResponse(externalPrompt);
         // *** Validation ***
         if (!external_factors || !Array.isArray(external_factors.opportunities) || !Array.isArray(external_factors.threats) || (external_factors.opportunities.length > 0 && typeof external_factors.opportunities[0] !== 'object')) {
              console.error("Invalid external factors structure:", external_factors);
              throw new Error("AI failed to return valid external factors. Check response structure.");
         }
        console.log(`Extracted ${external_factors.opportunities.length} Opportunities, ${external_factors.threats.length} Threats.`);

        // Combine into swot_data
        const swot_data = {
            strengths: internal_factors.strengths || [],
            weaknesses: internal_factors.weaknesses || [],
            opportunities: external_factors.opportunities || [],
            threats: external_factors.threats || []
        };

        // --- Step 3: Generate TOWS Strategies with Rationale ---
        statusEl.textContent = "Step 3/4: Generating TOWS strategies...";
         // Attempt to infer primary goal from text (fallback if necessary)
         const goalInferencePrompt = `Based ONLY on the following text, what is the single primary strategic goal or objective? Respond with just the goal statement (max 25 words). TEXT: "${businessContent.substring(0, 1000)}..."`; // Limit context for goal inference
         let primaryGoal = "Achieve sustainable growth and enhance market position."; // Default fallback
         try {
             const goalResponse = await fetch(OLLAMA_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ model: MODEL_NAME, prompt: goalInferencePrompt, stream: false }) });
             if (goalResponse.ok) {
                 const goalData = await goalResponse.json();
                 if (goalData.response) {
                      primaryGoal = goalData.response.trim().replace(/^Goal: /i, ''); // Clean up response
                      console.log("Inferred Primary Goal:", primaryGoal);
                 }
             }
         } catch (goalError) { console.warn("Could not infer primary goal, using default.", goalError); }


        const towsPrompt = `
            You are a strategic business consultant creating a TOWS matrix. Generate actionable strategies based **ONLY** on the provided SWOT factors and the inferred primary strategic goal.

            **Inferred Primary Strategic Goal:** ${primaryGoal}

            **SWOT ANALYSIS (Derived ONLY from User Text):**
            Strengths: ${swot_data.strengths.map(s => `- ${s.factor}: ${s.description}`).join("\n")}
            Weaknesses: ${swot_data.weaknesses.map(w => `- ${w.factor}: ${w.description}`).join("\n")}
            Opportunities: ${swot_data.opportunities.map(o => `- ${o.factor}: ${o.description}`).join("\n")}
            Threats: ${swot_data.threats.map(t => `- ${t.factor}: ${t.description}`).join("\n")}

            **TASK:** Generate 2-3 specific, actionable strategies for each TOWS quadrant (SO, WO, ST, WT). For each strategy:
            1.  Provide a concise \`strategy\` name (action-oriented, 5-10 words).
            2.  Provide a brief \`rationale\` (1-2 sentences) explaining *how* it uses the specific SWOT factors involved (e.g., "Leverages [Specific Strength] to capitalize on [Specific Opportunity]") and *how it supports the primary strategic goal*.

            **ABSOLUTE CONSTRAINTS:**
            - Base strategies **EXCLUSIVELY** on the provided SWOT factors. **DO NOT** introduce external ideas.
            - Ensure each strategy's rationale **explicitly mentions** the specific S/W/O/T factors it combines.
            - Ensure each strategy clearly supports the stated **Primary Strategic Goal**.
            - Ensure the JSON structure is exactly as specified.

            **RETURN FORMAT:** Provide ONLY a valid JSON object:
            {
              "SO_strategies": [
                {"strategy": "[Actionable SO Strategy Name]", "rationale": "Leverages [Strength X] to capitalize on [Opportunity Y] by... This supports the goal of [Primary Goal] by..."},
                // ... 1-2 more ...
              ],
              "WO_strategies": [
                 {"strategy": "[Actionable WO Strategy Name]", "rationale": "Overcomes [Weakness A] by leveraging [Opportunity B] through... This supports the goal of [Primary Goal] by..."},
                 // ... 1-2 more ...
              ],
              "ST_strategies": [
                  {"strategy": "[Actionable ST Strategy Name]", "rationale": "Uses [Strength C] to mitigate [Threat D] via... This supports the goal of [Primary Goal] by..."},
                  // ... 1-2 more ...
              ],
              "WT_strategies": [
                   {"strategy": "[Actionable WT Strategy Name]", "rationale": "Minimizes [Weakness E] and avoids [Threat F] by... This supports the goal of [Primary Goal] by..."},
                   // ... 1-2 more ...
              ]
            }`;
        const tows_strategies = await generateOllamaResponse(towsPrompt);
        // *** Validation ***
         if (!tows_strategies || typeof tows_strategies !== 'object' || !Array.isArray(tows_strategies.SO_strategies) /* Add checks for other quadrants too */ ) {
              console.error("Invalid TOWS strategies structure:", tows_strategies);
              throw new Error("AI failed to return valid TOWS strategies. Check response structure.");
         }
        console.log("Generated TOWS strategies.");


        // --- Step 4: Apply 80/20 rule for key insights ---
        statusEl.textContent = "Step 4/4: Applying 80/20 rule for key insights...";
        // Combine all generated strategies for the insights prompt
        const allStrategies = [].concat(...Object.values(tows_strategies || {}).map(arr => arr || []));

        const insightsPrompt = `
            You are a senior strategy consultant applying the Pareto Principle (80/20 rule) based **ONLY** on the provided SWOT/TOWS analysis derived from user text.

            **Primary Strategic Goal:** ${primaryGoal}

            **SWOT Factors (Derived ONLY from User Text):**
            Strengths: ${swot_data.strengths.map(s => s.factor).join(", ")}
            Weaknesses: ${swot_data.weaknesses.map(w => w.factor).join(", ")}
            Opportunities: ${swot_data.opportunities.map(o => o.factor).join(", ")}
            Threats: ${swot_data.threats.map(t => t.factor).join(", ")}

            **Generated TOWS Strategies (Derived ONLY from User Text & Factors):**
            ${allStrategies.map(s => `- ${s.strategy}: ${s.rationale}`).join("\n")}

            **TASK:** Apply the 80/20 rule to identify the critical few factors and strategies **from the lists above** that will likely drive ~80% of the impact towards achieving the **Primary Strategic Goal**.
            1.  \`strategic_focus\`: Define a single, overarching strategic direction (1 sentence) **based on the analysis** that best achieves the primary goal.
            2.  \`key_strategies\`: Select the 2-3 **most impactful strategies from the 'Generated TOWS Strategies' list** that most directly support the strategic_focus and primary goal. Provide the strategy name and a brief justification why it's key.
            3.  \`critical_factors\`: Identify the 2-3 **most critical SWOT factors from the 'SWOT Factors' list** that underpin the key_strategies or represent major hurdles/enablers for the primary goal. Provide factor name and brief justification.
            4.  \`priority_actions\`: List 2-3 immediate, concrete first steps **logically derived from the key_strategies** to begin execution.

            **ABSOLUTE CONSTRAINTS:**
            - Base **ALL** insights **EXCLUSIVELY** on the provided Goal, SWOT Factors, and TOWS Strategies. **DO NOT** introduce external ideas or factors.
            - Selections (strategies, factors, actions) MUST come directly from or be logically derived ONLY from the provided lists/context.

            **RETURN FORMAT:** Provide ONLY a valid JSON object:
            {
              "strategic_focus": "[Single sentence focus derived ONLY from analysis/goal]",
              "key_strategies": [ // 2-3 strategies PICKED ONLY FROM THE PROVIDED LIST
                {"strategy": "[Name of Strategy 1 from list]", "justification": "Why this specific strategy is key based on analysis..."},
                {"strategy": "[Name of Strategy 2 from list]", "justification": "Why this specific strategy is key based on analysis..."}
              ],
              "critical_factors": [ // 2-3 factors PICKED ONLY FROM THE PROVIDED LIST
                 {"factor": "[Name of Factor 1 from list]", "justification": "Why this specific factor is critical based on analysis..."},
                 {"factor": "[Name of Factor 2 from list]", "justification": "Why this specific factor is critical based on analysis..."}
              ],
              "priority_actions": [ // 2-3 actions DERIVED ONLY from key_strategies
                "[Immediate action derived ONLY from Key Strategy 1]",
                "[Immediate action derived ONLY from Key Strategy 2]"
              ]
            }`;
        const key_insights_80_20 = await generateOllamaResponse(insightsPrompt);
        // *** Validation ***
        if (!key_insights_80_20 || typeof key_insights_80_20 !== 'object' || !key_insights_80_20.strategic_focus || !Array.isArray(key_insights_80_20.key_strategies) || !Array.isArray(key_insights_80_20.critical_factors) || !Array.isArray(key_insights_80_20.priority_actions)) {
            console.error("Invalid 80/20 insights structure:", key_insights_80_20);
            throw new Error("AI failed to return valid 80/20 insights. Check response structure.");
        }
        console.log("Generated 80/20 insights.");

        // --- Final step: Render the full page ---
        statusEl.textContent = "Analysis complete! Rendering results...";
        const finalData = {
            swot_analysis: swot_data,
            tows_strategies: tows_strategies,
            key_insights_80_20: key_insights_80_20
        };
        renderFullSwotTowsPage(analysisResultContainer, finalData); // Use the updated renderer

    } catch (error) {
        console.error("Error during SWOT/TOWS analysis:", error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false); // Ensure loading stops on error
    } finally {
        // Ensure loading stops reliably if missed
        if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
        }
    }
}


// Modified renderFullSwotTowsPage to add Learn Tab and use detailed data
function renderFullSwotTowsPage(container, data) {
    container.innerHTML = ""; // Clear loading state

    // Basic Validation
    if (!data || !data.swot_analysis || !data.tows_strategies || !data.key_insights_80_20) {
        console.error("Incomplete data passed to renderFullSwotTowsPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render SWOT/TOWS results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    const { swot_analysis, tows_strategies, key_insights_80_20 } = data;


    // --- Create Tab Navigation (Added Learn Tab) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="insights"> Key Insights (80/20)</button> <!-- Insights First -->
        <button class="analysis-tab-btn" data-tab="swot"> SWOT Matrix</button>
        <button class="analysis-tab-btn" data-tab="tows"> TOWS Strategies</button>
        <button class="analysis-tab-btn" data-tab="details"> Detailed Analysis</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn SWOT/TOWS</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Added Learn Panel) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="insightsPanel" class="analysis-tab-panel active"></div> <!-- Insights Active -->
        <div id="swotPanel" class="analysis-tab-panel"></div>
        <div id="towsPanel" class="analysis-tab-panel"></div>
        <div id="detailsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- Populate Tabs (Order Changed) ---
    render8020Visualization(key_insights_80_20, "insightsPanel"); // Render Insights First
    renderSwotVisualization(swot_analysis, "swotPanel"); // Uses factor + description
    renderTowsVisualization(tows_strategies, "towsPanel"); // Uses strategy + rationale
    renderDetailedAnalysis(swot_analysis, tows_strategies, "detailsPanel"); // Keep charts

    // --- Populate Learn SWOT/TOWS Panel (New) ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding SWOT & TOWS Analysis</h3>
        [Image of SWOT matrix diagram]
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is SWOT Analysis?</h4>
            <p class="text-sm text-white/80">SWOT is a strategic planning technique used to identify an organization's Strengths, Weaknesses, Opportunities, and Threats related to business competition or project planning. It helps assess the internal and external factors impacting a goal.</p>
            <ul class="list-disc list-inside space-y-1 text-sm mt-2">
                <li><strong>Strengths (Internal, Positive):</strong> Characteristics of the business that give it an advantage over others (e.g., strong brand, skilled workforce).</li>
                <li><strong>Weaknesses (Internal, Negative):</strong> Characteristics that place the business at a disadvantage relative to others (e.g., outdated technology, high debt).</li>
                 <li><strong>Opportunities (External, Positive):</strong> Elements in the environment that the business could exploit to its advantage (e.g., growing market, competitor weakness).</li>
                 <li><strong>Threats (External, Negative):</strong> Elements in the environment that could cause trouble for the business (e.g., new regulations, emerging competitor).</li>
            </ul>
        </div>

         <div class="bg-black/20 p-4 rounded-lg mt-4">
             
            <h4 class="text-lg font-bold mb-2 text-yellow-300">From SWOT to TOWS: Generating Strategy</h4>
            <p class="text-sm text-white/80 mb-2">While SWOT identifies factors, TOWS uses these factors to generate actionable strategies by matching internal capabilities with external possibilities/challenges:</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>SO (Maxi-Maxi): Strengths + Opportunities:</strong> How can strengths be used to maximize opportunities? (Aggressive strategies)</li>
                <li><strong>WO (Mini-Maxi): Weaknesses + Opportunities:</strong> How can opportunities be used to overcome weaknesses? (Turnaround strategies)</li>
                 <li><strong>ST (Maxi-Mini): Strengths + Threats:</strong> How can strengths be used to minimize threats? (Defensive strategies)</li>
                 <li><strong>WT (Mini-Mini): Weaknesses + Threats:</strong> How can weaknesses be minimized and threats avoided? (Survival/Divestment strategies)</li>
            </ul>
             <p class="text-xs text-white/70 mt-2 italic">TOWS helps bridge the gap between analysis (SWOT) and action (Strategy).</p>
        </div>

         <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
            <h4 class="text-lg font-bold mb-2">Why Use SWOT/TOWS?</h4>
             <ul class="list-disc list-inside space-y-1 text-sm">
                <li>Provides a structured framework for situation analysis.</li>
                <li>Helps identify competitive advantages and disadvantages.</li>
                <li>Uncovers potential growth areas and risks.</li>
                <li>Facilitates strategic thinking and discussion.</li>
                <li>Forms a basis for developing actionable strategic plans (TOWS).</li>
            </ul>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to extract SWOT factors from your text and then generate corresponding TOWS strategies, followed by an 80/20 prioritization.</p>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (ensure resizing happens)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // Resize charts if they are in the activated panel
                 const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                 chartsInPanel.forEach(chartDiv => {
                      if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                          try {
                              Plotly.Plots.resize(chartDiv);
                          } catch (resizeError) {
                               console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                          }
                      }
                 });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Initial resize for charts in the default active tab (Insights - no chart) + hidden tabs
     setTimeout(() => {
          tabContent.querySelectorAll(".analysis-tab-panel").forEach(panel => {
               panel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                   if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                       try {
                            Plotly.Plots.resize(chartDiv);
                       } catch (initialResizeError) {
                            console.error(`Error during initial resize ${chartDiv.id} in panel ${panel.id}:`, initialResizeError);
                       }
                   }
               });
          });
     }, 150); // Delay slightly


    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}


// Modified renderSwotVisualization to show factor descriptions
function renderSwotVisualization(swotData, containerId) {
    const container = $(containerId);
    const quadrants = [
        { title: 'Strengths', data: swotData.strengths || [], color: '#2E8B57', icon: '' },
        { title: 'Weaknesses', data: swotData.weaknesses || [], color: '#CD5C5C', icon: '' },
        { title: 'Opportunities', data: swotData.opportunities || [], color: '#4169E1', icon: '' },
        { title: 'Threats', data: swotData.threats || [], color: '#FF8C00', icon: '' }
    ];
    let gridHtml = '<div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">'; // Added p-4, gap-6
    quadrants.forEach(q => {
        const itemsHtml = q.data.length > 0 ? q.data.map(item =>
            `<li class="mb-2">
                <strong class="text-white">${item.factor}</strong>
                <p class="text-xs text-white/70 italic ml-2">- ${item.description || 'No description provided.'}</p>
             </li>`
        ).join('') : '<li>No items identified from text.</li>';

        gridHtml += `
            <div class="bg-black/20 rounded-lg p-4 border-t-4 shadow-lg" style="border-top-color: ${q.color};">
                <h3 class="text-xl font-bold text-center mb-3 flex items-center justify-center gap-2" style="color: ${q.color};">${q.icon} ${q.title}</h3>
                <ul class="space-y-2 text-white/80 text-sm"> <!-- Removed list-disc, list-inside -->
                    ${itemsHtml}
                </ul>
            </div>`;
    });
    gridHtml += '</div>'; // Close grid
    container.innerHTML = gridHtml;
}


// Modified renderTowsVisualization to show rationale
function renderTowsVisualization(towsData, containerId) {
    const container = $(containerId);
     // Ensure towsData exists and has the expected arrays
     towsData = towsData || {};
     const quadrants = [
         { title: 'SO Strategies (Maxi-Maxi)', data: towsData.SO_strategies || [], color: '#32CD32', icon: '' },
         { title: 'WO Strategies (Mini-Maxi)', data: towsData.WO_strategies || [], color: '#FFD700', icon: '' },
         { title: 'ST Strategies (Maxi-Mini)', data: towsData.ST_strategies || [], color: '#87CEEB', icon: '' },
         { title: 'WT Strategies (Mini-Mini)', data: towsData.WT_strategies || [], color: '#DDA0DD', icon: '' }
     ];
    let gridHtml = '<div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">'; // Added p-4, gap-6
    quadrants.forEach(q => {
        const itemsHtml = q.data.length > 0 ? q.data.map(item =>
             `<li class="mb-3">
                <strong class="text-white">${item.strategy}</strong>
                <p class="text-xs text-white/70 italic mt-1 ml-2">- ${item.rationale || 'No rationale provided.'}</p>
             </li>`
        ).join('') : '<li>No strategies generated based on text.</li>';

        gridHtml += `
            <div class="bg-black/20 rounded-lg p-4 border-t-4 shadow-lg" style="border-top-color: ${q.color};">
                <h3 class="text-xl font-bold text-center mb-3 flex items-center justify-center gap-2" style="color: ${q.color};">${q.icon} ${q.title}</h3>
                <ul class="space-y-3 text-white/80 text-sm"> <!-- Removed list markers, increased spacing -->
                    ${itemsHtml}
                </ul>
            </div>`;
    });
    gridHtml += '</div>'; // Close grid
    container.innerHTML = gridHtml;
}


// Modified render8020Visualization to show justifications
function render8020Visualization(insightsData, containerId) {
    const container = $(containerId);
     // Ensure insightsData exists and has expected arrays/strings
     insightsData = insightsData || {};
     const keyStrategies = insightsData.key_strategies || [];
     const criticalFactors = insightsData.critical_factors || [];
     const priorityActions = insightsData.priority_actions || [];

    let contentHtml = `
        <div class="p-4 space-y-8">
            <div class="p-6 rounded-lg bg-black/20 border border-white/10 text-center">
                <h3 class="text-xl font-bold mb-2 text-indigo-300"> Strategic Focus</h3>
                <p class="text-lg italic text-white/90">${insightsData.strategic_focus || "Strategic focus not defined."}</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-black/20 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold mb-3 text-center text-green-400"> Key Strategies (Top 20%)</h4>`;
                    if (keyStrategies.length > 0) {
                         contentHtml += `<ul class="space-y-4">`;
                         keyStrategies.forEach(s => {
                             contentHtml += `<li class="p-2 bg-black/30 rounded">
                                                 <strong class="text-white">${s.strategy}</strong>
                                                 <p class="text-xs text-white/70 italic mt-1">- ${s.justification || 'No justification.'}</p>
                                             </li>`;
                         });
                         contentHtml += `</ul>`;
                    } else {
                         contentHtml += `<p class="text-white/60 italic text-center text-sm">No key strategies identified.</p>`;
                    }
                contentHtml += `</div>
                <div class="bg-black/20 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold mb-3 text-center text-yellow-400"> Critical Factors (Top 20%)</h4>`;
                     if (criticalFactors.length > 0) {
                         contentHtml += `<ul class="space-y-4">`;
                         criticalFactors.forEach(f => {
                              contentHtml += `<li class="p-2 bg-black/30 rounded">
                                                  <strong class="text-white">${f.factor}</strong>
                                                  <p class="text-xs text-white/70 italic mt-1">- ${f.justification || 'No justification.'}</p>
                                              </li>`;
                         });
                         contentHtml += `</ul>`;
                     } else {
                          contentHtml += `<p class="text-white/60 italic text-center text-sm">No critical factors identified.</p>`;
                     }
                contentHtml += `</div>
            </div>

            <div class="p-6 rounded-lg bg-black/20 border border-white/10">
                <h4 class="text-xl font-semibold mb-3 text-center text-blue-400"> Priority Actions (First Steps)</h4>`;
                if (priorityActions.length > 0) {
                    contentHtml += `<ol class="space-y-3 list-decimal list-inside text-white/90 text-center md:text-left md:max-w-xl md:mx-auto">`; // Centered list
                    priorityActions.forEach(a => {
                         contentHtml += `<li>${a}</li>`;
                    });
                    contentHtml += `</ol>`;
                } else {
                     contentHtml += `<p class="text-white/60 italic text-center text-sm">No priority actions identified.</p>`;
                }
            contentHtml += `</div>
        </div>`;
    container.innerHTML = contentHtml;
}

// Keep renderDetailedAnalysis as it focuses on counts/charts which don't need rationale display
function renderDetailedAnalysis(swotData, towsData, containerId) {
    const container = $(containerId);
     // Ensure data exists and has arrays
     swotData = swotData || {};
     towsData = towsData || {};
    const factorCounts = {
        Strengths: (swotData.strengths || []).length,
        Weaknesses: (swotData.weaknesses || []).length,
        Opportunities: (swotData.opportunities || []).length,
        Threats: (swotData.threats || []).length
    };
    const strategyCounts = {
        'SO': (towsData.SO_strategies || []).length, // Use short names for chart
        'WO': (towsData.WO_strategies || []).length,
        'ST': (towsData.ST_strategies || []).length,
        'WT': (towsData.WT_strategies || []).length
    };
    const factorColors = ["#2E8B57", "#CD5C5C", "#4169E1", "#FF8C00"]; // S, W, O, T

    let metricsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> Factor & Strategy Counts</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">`; // Added p-4
    Object.entries(factorCounts).forEach(([key, value], index) => {
        metricsHtml += `<div class="summary-stat-card"><div class="stat-value" style="color:${factorColors[index]}">${value}</div><div class="stat-label">${key}</div></div>`; // Use summary-stat-card
    });
    metricsHtml += `</div>`;

    let chartHtml = `<div id="strategyBarChart" class="w-full h-[400px] bg-black/10 rounded-lg p-2 plotly-chart"></div>`;

    let recommendationsHtml = `<h4 class="text-xl font-semibold mt-8 mb-3 text-center">Summary Insights</h4>
                               <div class="bg-black/20 p-4 rounded-lg max-w-2xl mx-auto">
                                   <ul class="list-disc list-inside space-y-2 text-white/80 text-sm">`;
    recommendationsHtml += factorCounts['Strengths'] >= factorCounts['Weaknesses'] ?
                           "<li>Internal factors suggest a relatively stronger position; focus on leveraging strengths.</li>" :
                           "<li>Internal factors indicate areas for improvement; prioritize addressing key weaknesses.</li>";
    recommendationsHtml += factorCounts['Opportunities'] >= factorCounts['Threats'] ?
                           "<li>External environment appears more favorable; actively pursue identified opportunities.</li>" :
                           "<li>External environment presents challenges; focus on mitigating significant threats.</li>";
     // Add insight based on TOWS strategy counts
     const strategyTotals = Object.values(strategyCounts).reduce((a, b) => a + b, 0);
     if (strategyTotals > 0) {
         const dominantStrategy = Object.entries(strategyCounts).sort((a,b) => b[1] - a[1])[0][0];
         recommendationsHtml += `<li>The analysis generated the most strategies in the <strong>${dominantStrategy}</strong> quadrant, suggesting a potential focus on ${
             dominantStrategy === 'SO' ? 'aggressive growth' :
             dominantStrategy === 'WO' ? 'turnaround/development' :
             dominantStrategy === 'ST' ? 'diversification/defense' :
             'defensive/consolidation'
         }.</li>`;
     }

    recommendationsHtml += `</ul></div></div>`; // Close p-4

    container.innerHTML = metricsHtml + chartHtml + recommendationsHtml;

    // Render Strategy Count Chart
    try {
        const plotData = [{
            x: Object.keys(strategyCounts),
            y: Object.values(strategyCounts),
            type: 'bar',
            marker: { color: ['#32CD32', '#FFD700', '#87CEEB', '#DDA0DD'] } // SO, WO, ST, WT colors
        }];
        const layout = {
            title: 'Number of Generated Strategies by Type',
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
            xaxis: { title: 'Strategy Type', automargin: true },
            yaxis: { title: 'Count', gridcolor: 'rgba(255,255,255,0.1)' },
            margin: { t: 50, b: 50, l: 50, r: 20 }
        };
        Plotly.newPlot('strategyBarChart', plotData, layout, { responsive: true });
    } catch(e) { console.error("Strategy chart err:", e); $("strategyBarChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }
}

    async function handleGoalsAndInitiativesAnalysis_SP() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Building OGSM Framework...</h3><p class="text-white/80 mb-2">Cascading your objective into actionable strategies based *only* on your provided text...</p></div>`; // Updated text
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = $("docUpload").checked;
        let text = "";

        if (useDoc) {
            const file = $("goalsFile").files[0];
            if (!file) throw new Error("Please select a document to upload.");
            text = await extractTextFromFile(file);
        } else {
            text = $("goalsContent").value.trim();
            if (!text.trim()) throw new Error("Please enter your high-level goal or business context in the text area.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (text.length > MAX_CONTEXT_LENGTH) {
            text = text.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`Goals & Initiatives (SP) analysis context truncated.`);
        }

        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are a strategic planning consultant specializing in the OGSM (Objective, Goals, Strategies, Measures) framework. Based **ONLY** on the user's provided context (which might describe a high-level goal or general business situation), create a complete OGSM plan derived strictly from that text. ${truncatedNote}

            **USER'S CONTEXT / HIGH-LEVEL GOAL:**
            \`\`\`
            ${text}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Define Objective:** Refine the user's input or infer from the context a single, clear, overarching, and ideally measurable \`main_objective\` (SMART if possible).
            2.  **Define Goals (3-4 goals):** Identify specific, high-level \`goals\` that support the main_objective, derived **only from the text**.
            3.  **Develop Strategies & Measures:** For EACH goal, develop 1-2 supporting \`strategies\` **based only on actions or directions mentioned/implied in the text**. For EACH strategy:
                * Provide a concise \`strategy_name\` (action-oriented).
                * Provide a brief \`rationale\` (1-2 sentences) explaining *how* this strategy supports the parent goal and main objective, **using evidence ONLY from the text**.
                * List 1-2 specific, measurable \`measures\` (KPIs) **mentioned in, implied by, or logically derived ONLY from the text** to track the strategy's success.
            4.  **Self-Correction:** Rigorously check: Is the objective derived solely from input/context? Are goals/strategies/rationales/measures **strictly based ONLY on the user's text**? Is the structure logical and hierarchical? Is the JSON perfect? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT IS KING:** Base **ALL** output **EXCLUSIVELY** on the provided "USER'S CONTEXT / HIGH-LEVEL GOAL". **DO NOT** invent information, goals, strategies, or KPIs not present or logically implied in the text.
            - **NO GENERIC EXAMPLES:** Replace **ALL** placeholder text in the RETURN FORMAT structure below with content generated **strictly from the user's input text**.
            - **JSON FORMAT:** Adhere EXACTLY.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. Replace ALL bracketed placeholders strictly based on the user's input text.
            {
              "main_objective": "[SMART Objective derived ONLY from user text/context]",
              "goals": [ // 3-4 goals derived ONLY from text
                {
                  "goal_name": "[Goal 1 Name derived ONLY from text]",
                  "strategies": [ // 1-2 strategies per goal derived ONLY from text
                    {
                      "strategy_name": "[Strategy 1.1 Name ONLY from text]",
                      "rationale": "[Rationale linking strategy to goal/objective using ONLY text evidence...]",
                      "measures": ["[Measure/KPI 1.1.1 derived ONLY from text]", "[Measure/KPI 1.1.2 derived ONLY from text]"]
                    },
                    {
                      "strategy_name": "[Strategy 1.2 Name ONLY from text]",
                      "rationale": "[Rationale linking strategy using ONLY text evidence...]",
                      "measures": ["[Measure/KPI 1.2.1 derived ONLY from text]"]
                    }
                  ]
                },
                {
                  "goal_name": "[Goal 2 Name derived ONLY from text]",
                  "strategies": [
                    {
                      "strategy_name": "[Strategy 2.1 Name ONLY from text]",
                      "rationale": "[Rationale linking strategy using ONLY text evidence...]",
                      "measures": ["[Measure/KPI 2.1.1 derived ONLY from text]"]
                    }
                  ]
                }
                // ... potentially 1-2 more goals derived ONLY from text ...
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED OGSM prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (OGSM - SP):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced OGSM SP) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !parsedData.main_objective || typeof parsedData.main_objective !== 'string' || parsedData.main_objective.includes("[") ||
                 !Array.isArray(parsedData.goals) || parsedData.goals.length < 1 ||
                 // Check structure of first goal and its strategies/measures
                 (parsedData.goals.length > 0 && (
                     typeof parsedData.goals[0] !== 'object' ||
                     !parsedData.goals[0].hasOwnProperty('goal_name') || parsedData.goals[0].goal_name.includes("[") ||
                     !Array.isArray(parsedData.goals[0].strategies) || parsedData.goals[0].strategies.length < 1 ||
                     (parsedData.goals[0].strategies.length > 0 && (
                         typeof parsedData.goals[0].strategies[0] !== 'object' ||
                         !parsedData.goals[0].strategies[0].hasOwnProperty('strategy_name') || parsedData.goals[0].strategies[0].strategy_name.includes("[") ||
                         !parsedData.goals[0].strategies[0].hasOwnProperty('rationale') || parsedData.goals[0].strategies[0].rationale.includes("[") ||
                         !Array.isArray(parsedData.goals[0].strategies[0].measures) || parsedData.goals[0].strategies[0].measures.length < 1 ||
                         (parsedData.goals[0].strategies[0].measures.length > 0 && parsedData.goals[0].strategies[0].measures[0].includes("[")) // Check first measure for placeholder
                     ))
                 ))
                )
             {
                  console.error("Validation Failed (Enhanced OGSM SP): Required fields missing, invalid structure, or placeholders detected.", parsedData);
                  throw new Error(`AI response structure is incorrect, inconsistent, or contains placeholders (Enhanced OGSM SP). Check objective, goals, strategies, rationales, and measures. See console logs.`);
             }
             console.log(`Successfully parsed ENHANCED OGSM (SP) JSON using ${MODEL_NAME}. Found ${parsedData.goals.length} goals.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED OGSM (SP) JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced OGSM SP): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results
        renderGoalsAndInitiativesPage_SP(analysisResultContainer, parsedData); // Use the updated renderer

    } catch (error) {
        console.error(`Error in handleGoalsAndInitiativesAnalysis_SP (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


// Modified renderGoalsAndInitiativesPage_SP to add more Tabs and structure content
function renderGoalsAndInitiativesPage_SP(container, data) {
    container.innerHTML = ""; // Clear loading

    // Add validation for new fields
    if (!data || !data.main_objective || !data.goals) {
        console.error("Incomplete data passed to renderGoalsAndInitiativesPage_SP:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render OGSM results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    const { main_objective, goals } = data;

    // --- Create Tab Navigation (Updated with More Tabs) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="cascade"> Cascade View</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="objective"> Objective</button> <!-- New -->
        <button class="analysis-tab-btn" data-tab="goals"> G Goals</button> <!-- New -->
        <button class="analysis-tab-btn" data-tab="strategies"> S Strategies</button> <!-- New -->
        <button class="analysis-tab-btn" data-tab="measures"> M Measures</button> <!-- New -->
        <button class="analysis-tab-btn" data-tab="learn"> Learn OGSM</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated with More Panels) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="cascadePanel" class="analysis-tab-panel active"></div>
        <div id="objectivePanel" class="analysis-tab-panel"></div> <!-- New -->
        <div id="goalsPanel" class="analysis-tab-panel"></div> <!-- New -->
        <div id="strategiesPanel" class="analysis-tab-panel"></div> <!-- New -->
        <div id="measuresPanel" class="analysis-tab-panel"></div> <!-- New -->
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Strategic Cascade Panel (Keep as is) ---
    const cascadePanel = $("cascadePanel");
    let cascadeHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-6 text-center"> Strategic Cascade (OGSM)</h3><div class="cascade-container">
        <div class="cascade-objective">
            <h3 class="text-lg font-bold text-indigo-300">OBJECTIVE</h3>
            <p class="text-xl font-semibold">${main_objective}</p>
        </div>
        <div class="cascade-connector"></div>
        <div class="cascade-goals-grid">`;

    goals.forEach((goal) => {
        cascadeHtml += `<div class="cascade-goal-card">
            <div>
                <h4 class="text-md font-bold text-red-300">GOAL</h4>
                <p class="text-lg font-semibold">${goal.goal_name}</p>
            </div>
            <div class="space-y-3 mt-3">`;
        (goal.strategies || []).forEach((strategy) => {
            cascadeHtml += `<div class="cascade-strategy">
                <h5 class="text-sm font-bold text-yellow-300">STRATEGY</h5>
                <p class="font-semibold">${strategy.strategy_name}</p>
                 <p class="text-xs text-white/70 italic my-1">Rationale: ${strategy.rationale || 'N/A'}</p>
                <div class="mt-2 text-xs text-white/70">
                    <strong>Measures:</strong>
                    <ul class="list-disc list-inside ml-2">${(strategy.measures || []).map(m => `<li>${m}</li>`).join('')}</ul>
                </div>
            </div>`;
        });
        cascadeHtml += `</div></div>`;
    });
    cascadeHtml += `</div></div></div>`;
    cascadePanel.innerHTML = cascadeHtml;

    // --- 2. Populate Objective Panel (New) ---
    const objectivePanel = $("objectivePanel");
    objectivePanel.innerHTML = `
        <div class="p-6">
             <h3 class="text-2xl font-bold mb-4 text-center"> Objective</h3>
             <div class="cascade-objective mx-auto max-w-2xl text-center bg-black/20 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-indigo-300 mb-2">OVERARCHING OBJECTIVE</h3>
                <p class="text-2xl font-semibold italic">${main_objective}</p>
                 <p class="text-xs text-white/60 mt-4">(This sets the primary direction for the entire plan, derived from your input.)</p>
            </div>
        </div>`;


    // --- 3. Populate Goals Panel (New) ---
    const goalsPanel = $("goalsPanel");
    let goalsHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4 text-center"> G Goals</h3>`;
    goalsHtml += `<p class="text-sm text-white/70 mb-6 italic text-center">These are the specific, high-level results needed to achieve the main Objective.</p>`;
    goals.forEach((goal, index) => {
        goalsHtml += `<div class="cascade-goal-card max-w-3xl mx-auto p-4 border-l-4 border-red-400"> <!-- Add styling -->
            <h4 class="text-md font-bold text-red-300">GOAL ${index + 1}</h4>
            <p class="text-lg font-semibold">${goal.goal_name}</p>
            <!-- Optionally add short description here if AI provides it -->
        </div>`;
    });
    goalsHtml += `</div>`;
    goalsPanel.innerHTML = goalsHtml;


    // --- 4. Populate Strategies Panel (New) ---
    const strategiesPanel = $("strategiesPanel");
    let strategiesHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4 text-center"> S Strategies</h3>`;
    strategiesHtml += `<p class="text-sm text-white/70 mb-6 italic text-center">These are the key approaches and choices ('how') to achieve each Goal.</p>`;
    goals.forEach((goal, index) => {
         strategiesHtml += `<div class="mb-6 bg-black/10 p-4 rounded-lg">
                               <h4 class="text-lg font-semibold mb-3 border-b border-white/10 pb-1 text-red-300">For Goal ${index + 1}: ${goal.goal_name}</h4>
                               <div class="space-y-4">`;
        (goal.strategies || []).forEach((strategy, s_index) => {
            strategiesHtml += `<div class="cascade-strategy border border-white/10 p-3 rounded-md">
                <h5 class="text-sm font-bold text-yellow-300">STRATEGY ${index + 1}.${s_index + 1}</h5>
                <p class="font-semibold text-white">${strategy.strategy_name}</p>
                <p class="text-xs text-white/70 italic my-2">${strategy.rationale || 'N/A'}</p>
            </div>`;
        });
         strategiesHtml += `</div></div>`; // Close space-y-4 and mb-6 bg-black/10
    });
    strategiesHtml += `</div>`;
    strategiesPanel.innerHTML = strategiesHtml;


    // --- 5. Populate Measures Panel (New) ---
    const measuresPanel = $("measuresPanel");
    let measuresHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> M Measures (KPIs)</h3>`;
    measuresHtml += `<p class="text-sm text-white/70 mb-6 italic text-center">These metrics track the progress and success of the Strategies.</p>`;
     measuresHtml += `<div class="overflow-x-auto">
                        <table class="coeff-table styled-table text-sm">
                            <thead><tr><th>Measure / KPI</th><th>Related Strategy</th><th>Related Goal</th></tr></thead>
                            <tbody>`;
    let kpiFound = false;
    goals.forEach((goal) => {
        (goal.strategies || []).forEach((strategy) => {
            (strategy.measures || []).forEach(measure => {
                kpiFound = true;
                measuresHtml += `<tr>
                                    <td class="font-semibold text-green-300">${measure}</td>
                                    <td>${strategy.strategy_name}</td>
                                    <td class="text-white/70">${goal.goal_name}</td>
                                 </tr>`;
            });
        });
    });
     if (!kpiFound) {
         measuresHtml += `<tr><td colspan="3" class="text-center text-white/60 italic p-4">No specific measures were identified from the text.</td></tr>`;
     }
    measuresHtml += `</tbody></table></div></div>`;
    measuresPanel.innerHTML = measuresHtml;


    // --- 6. Populate Learn OGSM Panel (Keep as is) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding the OGSM Framework</h3>

        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is OGSM?</h4>
            <p class="text-sm text-white/80">OGSM (Objective, Goals, Strategies, Measures) is a strategic planning framework used to define what an organization wants to achieve and how it plans to get there, ensuring clear alignment from the highest-level objective down to specific metrics.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-4">
                <div>
                    <h4 class="text-lg font-bold text-indigo-300">O - Objective</h4>
                    <p class="text-sm">The single, overarching, ambitious, and qualitatively stated aim for the planning period (e.g., "Become the market leader"). It sets the direction.</p>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-red-300">G - Goals</h4>
                    <p class="text-sm">Specific, measurable (SMART), time-bound results that need to be achieved to reach the Objective (e.g., "Increase market share to 25% by EOY"). They define 'what' success looks like.</p>
                </div>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-4">
                 <div>
                    <h4 class="text-lg font-bold text-yellow-300">S - Strategies</h4>
                    <p class="text-sm">The choices and approaches ('how') that will be employed to achieve the Goals (e.g., "Expand into new geographic regions," "Launch innovative product line"). They describe the path.</p>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-green-300">M - Measures</h4>
                    <p class="text-sm">Specific metrics (KPIs) used to track the progress and success of the Strategies (e.g., "Number of new stores opened," "Revenue from new products"). They monitor performance.</p>
                </div>
            </div>
        </div>

         <div class="bg-black/20 p-4 rounded-lg mt-6">
            <h4 class="text-lg font-bold mb-2">Why Use OGSM?</h4>
             <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Clarity & Focus:</strong> Creates a clear, concise (often one-page) view of the strategic plan.</li>
                <li><strong>Alignment:</strong> Ensures everyone understands the objective and how their work contributes through goals and strategies.</li>
                <li><strong>Actionability:</strong> Translates high-level objectives into concrete strategies and measurable targets.</li>
                <li><strong>Accountability:</strong> Measures provide a clear basis for tracking progress and holding teams accountable.</li>
                <li><strong>Communication:</strong> Simple structure makes it easy to communicate the plan across the organization.</li>
            </ul>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to structure your input context into an OGSM plan, deriving the elements strictly from the text provided.</p>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                 // No Plotly charts expected in this tool
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}






    function renderNovelGoalsPage_NS(container, data) {
        container.innerHTML = ""; // Clear loading state
        const { main_goal, horizons } = data;

        // Basic validation
        if (!main_goal || !horizons || !Array.isArray(horizons) || horizons.length !== 3) {
            container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete or invalid analysis data received. Cannot render Three Horizons plan.</div>`;
            $("analysisActions").classList.add("hidden"); // Hide save buttons
            setLoading("generate", false); // Ensure loading indicator stops
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Use standard tab styling
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
            <button class="analysis-tab-btn" data-tab="horizons"> Horizons Visual</button>
            <button class="analysis-tab-btn" data-tab="details"> Detailed Plan</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Framework</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active"></div>
            <div id="horizonsPanel" class="analysis-tab-panel"></div>
            <div id="detailsPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Dashboard Panel ---
        const dashboardPanel = $("dashboardPanel");
        let dashboardHtml = `<div class="p-4 space-y-8">
            <div class="p-6 rounded-lg bg-white/10 border border-white/20 text-center">
                <h3 class="text-xl font-bold mb-2 text-indigo-300"> Overarching Goal</h3>
                <p class="text-2xl italic text-white/90">${main_goal}</p>
            </div>
            <h3 class="text-2xl font-bold text-center">Initiatives Across Horizons</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">`;

        horizons.forEach((horizon, index) => {
            const colors = ["border-blue-400", "border-yellow-400", "border-red-400"];
            const initiativesList = horizon.initiatives || []; // Ensure it's an array
            dashboardHtml += `<div class="bg-white/5 p-4 rounded-lg border-l-4 ${colors[index]}">
                <h4 class="text-lg font-bold mb-2">${horizon.horizon_name}</h4>
                <p class="text-xs font-semibold text-white/70 mb-3">${horizon.timeframe}</p>
                <p class="text-xs italic text-white/70 mb-3">${horizon.focus}</p>`;
            // Handle empty initiatives list in dashboard
            if (initiativesList.length > 0) {
                 dashboardHtml += `<ul class="list-disc list-inside space-y-2 text-sm text-white/80">
                    ${initiativesList.map(init => `<li>${init.initiative_name}</li>`).join("")}
                </ul>`;
            } else {
                 dashboardHtml += `<p class="text-sm text-white/60 italic mt-2">(No specific initiatives derivable from context for this horizon)</p>`;
            }
            dashboardHtml += `</div>`;
        });
        dashboardHtml += `</div></div>`;
        dashboardPanel.innerHTML = dashboardHtml;


        // --- 2. Populate Horizons Visual Panel ---
        const horizonsPanel = $("horizonsPanel");
        let horizonsHtml = `<div class="horizons-container">
                    <div id="h3-circle" class="horizon-circle"><span class="horizon-label">Horizon 3 (${horizons[2]?.timeframe || '3-7+ Yrs'})</span></div>
                    <div id="h2-circle" class="horizon-circle"><span class="horizon-label">Horizon 2 (${horizons[1]?.timeframe || '12-36 Mos'})</span></div>
                    <div id="h1-circle" class="horizon-circle"><span class="horizon-label">Horizon 1 (${horizons[0]?.timeframe || '0-18 Mos'})</span></div>
                    <div class="main-goal-center">${main_goal}</div>`;

        let initiativeCount = 0;
        // Flatten only initiatives that actually exist
        const allValidInitiatives = horizons.flatMap(h => h.initiatives || []);
        const totalInitiatives = allValidInitiatives.length || 1;

        horizons.forEach((horizon, hIndex) => {
            (horizon.initiatives || []).forEach((initiative) => {
                const baseAngle = Math.PI / 6;
                const angleIncrement = (Math.PI * 1.8) / totalInitiatives;
                const angle = baseAngle + initiativeCount * angleIncrement;
                const radii = [25, 38, 50];
                const radius = radii[hIndex];
                const randomOffset = (Math.random() - 0.5) * 3;
                const effectiveRadius = Math.max(10, Math.min(60, radius + randomOffset));
                const x = 50 + effectiveRadius * Math.cos(angle);
                const y = 50 + effectiveRadius * Math.sin(angle);
                horizonsHtml += `<div class="initiative-point" style="left: ${x.toFixed(2)}%; top: ${y.toFixed(2)}%; transform: translate(-50%, -50%);" title="${initiative.description || initiative.initiative_name}">${initiative.initiative_name}</div>`;
                initiativeCount++;
            });
        });
        horizonsHtml += `</div>`;
        // Add message if no initiatives could be plotted
        if (allValidInitiatives.length === 0) {
             horizonsHtml += `<p class="text-center text-white/70 mt-[-50px] relative z-10">(No initiatives derived from context to plot)</p>`;
        }
        horizonsPanel.innerHTML = horizonsHtml;


        // --- 3. Populate Detailed Plan Panel ---
        const detailsPanel = $("detailsPanel");
        let detailsHtml = `<div class="p-4 space-y-6">
             <div class="p-4 rounded-lg bg-black/20 text-center mb-6">
                <h3 class="text-lg font-bold text-indigo-300"> Overarching Goal</h3>
                <p class="text-xl italic text-white/90">${main_goal}</p>
            </div>`;
        horizons.forEach((horizon) => {
            const initiativesList = horizon.initiatives || []; // Ensure it's an array
            detailsHtml += `<div class="bg-white/10 p-6 rounded-lg shadow-lg mb-6">
                        <h3 class="text-2xl font-bold mb-1">${horizon.horizon_name}</h3>
                        <p class="text-sm text-indigo-300 font-semibold mb-2">${horizon.timeframe}</p>
                        <p class="text-md italic text-white/80 mb-4">${horizon.focus}</p>
                        <h4 class="text-lg font-semibold mb-3 border-b border-white/20 pb-1">Initiatives:</h4>
                        <div class="space-y-4">`;
            // Handle empty initiatives list in detailed view
            if (initiativesList.length > 0) {
                initiativesList.forEach(initiative => {
                     detailsHtml += `<div class="bg-black/20 p-4 rounded">
                                    <p class="font-semibold text-white">${initiative.initiative_name}</p>
                                    <p class="text-xs text-white/70 italic my-1">${initiative.description}</p>
                                    <p class="text-xs text-yellow-300 mt-2"><strong>KPIs:</strong> ${(initiative.kpis || []).join(", ")}</p>
                                </div>`;
                });
            } else {
                 detailsHtml += `<p class="text-sm text-white/60 italic">(No specific initiatives derivable from context for this horizon)</p>`;
            }
            detailsHtml += `</div></div>`; // Close initiatives space-y-4 and horizon bg-white/10
        });
        detailsHtml += `</div>`; // Close details panel p-4 space-y-6
        detailsPanel.innerHTML = detailsHtml;


        // --- 4. Populate Learn Framework Panel ---
        const learnPanel = $("learnPanel");
        // (Keep the exact same HTML content for the learn panel as in the previous response)
        learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding the Three Horizons of Growth</h3>
                <p class="italic text-center">McKinsey's Three Horizons framework provides a structure for companies to manage current performance while maximizing future growth opportunities. It helps balance resources across initiatives with different timeframes and risk profiles.</p>
                <div class="text-center my-4"></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                        <h4 class="text-xl font-bold text-blue-300 mb-2">Horizon 1: Optimize the Core</h4>
                        <p class="text-sm font-semibold mb-2">Timeframe: ~0-18 Months</p>
                        <p class="text-sm mb-3"><strong>Focus:</strong> Defend, extend, and increase the profitability of the existing, core business. Improve efficiency and extract maximum value from current operations.</p>
                        <p class="text-sm"><strong>Characteristics:</strong> Lower risk, incremental improvements, known markets/customers, focus on execution, generates cash flow.</p>
                        <p class="text-sm mt-2"><strong>Example Activities:</strong> Process automation, cost reduction, product line extensions, customer retention programs.</p>
                    </div>
                    <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50">
                        <h4 class="text-xl font-bold text-yellow-300 mb-2">Horizon 2: Build Adjacent Growth</h4>
                        <p class="text-sm font-semibold mb-2">Timeframe: ~12-36 Months</p>
                        <p class="text-sm mb-3"><strong>Focus:</strong> Develop emerging opportunities by leveraging existing capabilities into adjacent markets, products, or services. Build new lines of business.</p>
                        <p class="text-sm"><strong>Characteristics:</strong> Moderate risk, requires investment and new capabilities, potential for substantial growth, builds new revenue streams.</p>
                        <p class="text-sm mt-2"><strong>Example Activities:</strong> Geographic expansion, launching SaaS based on existing tech, entering new customer segments, strategic partnerships.</p>
                    </div>
                    <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/50">
                        <h4 class="text-xl font-bold text-red-300 mb-2">Horizon 3: Create Transformational Options</h4>
                        <p class="text-sm font-semibold mb-2">Timeframe: ~3-7+ Years</p>
                        <p class="text-sm mb-3"><strong>Focus:</strong> Explore and invest in truly disruptive or novel ideas, technologies, or business models that could become the core business of the distant future. Create options.</p>
                        <p class="text-sm"><strong>Characteristics:</strong> High risk & uncertainty, experimental, requires R&D or venture investment, uncertain outcomes but massive potential.</p>
                        <p class="text-sm mt-2"><strong>Example Activities:</strong> Basic research in new tech (AI, quantum), pilot programs for radical business models, minority investments in startups, creating internal innovation labs.</p>
                    </div>
                </div>
                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">Why Use the Three Horizons Framework?</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Balanced Portfolio:</strong> Ensures resources are allocated across short, medium, and long-term growth opportunities.</li>
                        <li><strong>Future-Proofing:</strong> Prevents complacency by forcing focus on future disruption and innovation.</li>
                        <li><strong>Structured Innovation:</strong> Provides a common language and framework for discussing and managing different types of growth initiatives.</li>
                        <li><strong>Resource Allocation:</strong> Helps justify investments in H2 and H3 initiatives that may not yield immediate returns.</li>
                        <li><strong>Avoiding the "Tyranny of the Urgent":</strong> Protects nascent H2/H3 projects from being starved by the demands of the core H1 business.</li>
                    </ul>
                 </div>
            </div>
        `;

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache the result

        // Add event listener for tab switching
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     // const chart = targetPanel.querySelector(".plotly-chart"); // If charts added later
                     // if (chart) Plotly.Plots.resize(chart);
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator AFTER rendering
    }

    async function handleRegressionAnalysis_DA() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div></div><div></div><div></div> </div><h3 class="text-xl font-semibold text-white mb-4">Running Comprehensive Regression...</h3><p class="text-white/80 mb-2">Building model, running diagnostics, and generating actionable insights...</p></div>`;
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    // *** CHOOSE MODEL: qwen or llama ***
    const MODEL_NAME = "llama3.1:latest"; // Use Qwen for potentially better numerical accuracy
    // const MODEL_NAME = "llama3.1:latest"; // Alternative option

    try {
        // 1. Gather Inputs
        const dependentVar = $("dependentVar").value.trim();
        const independentVarsRaw = $("independentVars").value.trim();
        const dataFile = $("regressionFile").files[0];
        const contextFile = $("regressionContextFile").files[0];

        if (!dependentVar || !independentVarsRaw || !dataFile) {
            throw new Error(" Please specify Dependent Variable, at least one Independent Variable, and upload a CSV data file.");
        }
        // Clean up independent vars list
        const independentVars = independentVarsRaw.split(',').map(v => v.trim()).filter(v => v).join(', ');
        if (!independentVars) {
             throw new Error(" Please specify at least one valid Independent Variable.");
        }


        const fileContent = await extractTextFromFile(dataFile);
        let businessContext = "No additional business context document provided.";
        if (contextFile) {
            try {
                 businessContext = await extractTextFromFile(contextFile);
                 console.log("Extracted text from context file for regression.");
            } catch (e) {
                 console.warn("Could not read context file:", e.message);
                 businessContext = `Error reading context file: ${e.message}. Proceeding without document context.`;
            }
        } else {
             console.log("No business context file uploaded for regression.");
        }


        // Truncate if necessary
        const MAX_DATA_LENGTH = 15000; // Keep data snippet reasonable
        const MAX_CONTEXT_LENGTH = 7000; // Context less critical than data for pure regression
        let truncatedNote = "";
        let dataSnippet = fileContent;

        if (fileContent.length > MAX_DATA_LENGTH) {
            dataSnippet = fileContent.substring(0, MAX_DATA_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_DATA_LENGTH} characters of the data file.)`;
            console.warn(`Regression analysis data truncated.`);
        }
         if (businessContext.length > MAX_CONTEXT_LENGTH) {
            businessContext = businessContext.substring(0, MAX_CONTEXT_LENGTH) + "\n... (business context truncated)";
            console.warn(`Regression business context truncated.`);
        }

        // 2. Construct Enhanced Prompt
        const prompt = `
            You are a meticulous senior data analyst performing a comprehensive multiple regression analysis. Accuracy, clear interpretation of statistics, validation of assumptions, and actionable business insights grounded in data are paramount.

            **ANALYSIS INPUTS:**
            * **Dependent Variable (Y):** "${dependentVar}"
            * **Independent Variables (X):** "${independentVars}"
            * **Business Context:** """${businessContext}"""
            * **Data Snippet:** ${truncatedNote}\n\`\`\`csv\n${dataSnippet}\n\`\`\`

            **DETAILED TASKS:**
            1.  **Model Summary & Fit:** Calculate and interpret key model statistics:
                * **R-squared & Adj. R-squared:** Provide values and explain *precisely* what percentage of variance in "${dependentVar}" is explained by the model, considering the number of predictors (Adj. R).
                * **F-statistic & Prob(F-statistic):** Provide values and state clearly whether the overall model is statistically significant (typically p < 0.05).
                * **Regression Equation:** Provide the calculated equation.
                * **Overall Interpretation:** Summarize the model's goodness-of-fit based on these metrics.

            2.  **Variable Importance (if applicable/calculable):** Estimate the relative importance of each independent variable in predicting the dependent variable. Provide a score or ranking and a brief rationale based on model coefficients or other standard methods (e.g., contribution to R). If not directly calculable from standard OLS output, omit this section or state it's based on coefficient magnitude/significance.

            3.  **Coefficients Analysis:** For *each* coefficient (including the Intercept):
                * Provide: Variable Name, Coefficient value, Standard Error, P-value.
                * **Interpretation:** Explain the practical meaning of the coefficient (e.g., "For each one-unit increase in [X variable], ${dependentVar} is predicted to [increase/decrease] by [coefficient value] units, holding other variables constant.").
                * **Significance:** State clearly whether the coefficient is statistically significant (p < 0.05) and its implication (i.e., we are confident this variable has a real effect).

            4.  **Residuals Analysis (Model Diagnostics):**
                * Simulate/generate plausible 'predicted' vs. 'residuals' data points (around 15-20 points consistent with the fit stats).
                * **Interpretation:** Analyze the *pattern* of these residuals. Explicitly check for:
                    * **Linearity:** Do residuals scatter randomly around zero, or show a curve (suggesting non-linear relationship)?
                    * **Homoscedasticity:** Is the spread of residuals roughly constant across predicted values, or does it fan out/in (heteroscedasticity)?
                    * **Normality (Conceptual):** Do residuals seem roughly normally distributed around zero?
                    * **Conclusion:** State whether the basic assumptions of linear regression appear to be met based *only* on the visual pattern of the simulated residuals.

            5.  **Business Recommendations (3-4 recommendations):** Based *only* on the significant coefficients, variable importance, and the provided Business Context:
                * **\`recommendation\`:** A clear, actionable title.
                * **\`insight_link\`:** State which specific significant variable(s) or model finding drives this recommendation.
                * **\`action_items\`:** List 2-3 concrete steps a business could take based on this finding and the context.
                * **\`potential_risks\`:** Briefly mention 1-2 potential risks or considerations for implementing the action.
                * **\`kpis_to_track\`:** List 2-3 KPIs to measure the success of the implemented action.

            6.  **Self-Correction:** Before outputting JSON, rigorously check: Are R/F-stat interpretations correct? Are coefficient p-values interpreted correctly? Does the residual analysis correctly check assumptions? Are recommendations directly linked ONLY to significant findings and business context? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **DATA GROUNDING:** All interpretations and recommendations MUST derive *solely* from the analysis of the provided data snippet, variable definitions, and business context. No external knowledge.
            - **STATISTICAL ACCURACY:** Interpretations of R, F-stat, p-values, and residual patterns must be statistically sound.
            - **ACTIONABILITY & LINKAGE:** Recommendations must be practical and clearly linked back to specific, significant model results.
            - **JSON FORMAT:** Adhere EXACTLY. Include all specified keys and sub-keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
            {
              "model_summary": {
                "dependent_variable": "${dependentVar}",
                "r_squared": 0.0, // Calculated
                "adj_r_squared": 0.0, // Calculated
                "f_statistic": 0.0, // Calculated
                "prob_f_statistic": 0.0, // Calculated
                "regression_equation": "Y = ...", // Calculated
                "interpretation": "Precise interpretation of fit..." // Generated
              },
              "variable_importance": [ // Optional section if calculable, otherwise omit or explain basis
                { "variable": "Var1", "importance_score": 0.0, "rationale": "Based on..." },
                { "variable": "Var2", "importance_score": 0.0, "rationale": "Based on..." }
              ],
              "coefficients": [ // Include Intercept + all Independent Vars
                {
                  "variable": "Intercept", "coefficient": 0.0, "std_error": 0.0, "p_value": 0.0,
                  "interpretation": "Baseline value interpretation...", "significance": "Is it significant? (p<0.05)"
                },
                {
                   "variable": "X1", "coefficient": 0.0, "std_error": 0.0, "p_value": 0.0,
                   "interpretation": "Practical meaning of coefficient...", "significance": "Is it significant? (p<0.05)"
                } // ... for all variables ...
              ],
              "residuals_analysis": { // Renamed key for clarity
                "predicted_vs_residuals": [ // Array of ~15-20 plausible points
                    { "predicted": 0.0, "residual": 0.0 }
                 ],
                "interpretation": "Analysis of pattern for Linearity, Homoscedasticity, Normality. Conclusion on assumptions met/violated..." // Generated
              },
              "business_recommendations": [ // 3-4 recommendations
                {
                  "recommendation": "Action Title",
                  "insight_link": "Driven by significance of [Variable X]...",
                  "action_items": ["Step 1...", "Step 2..."],
                  "potential_risks": "Risk 1...",
                  "kpis_to_track": ["KPI 1...", "KPI 2..."]
                } // ...
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED Regression prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } }) // Increased context
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        try {
            parsedData = JSON.parse(data.response);
             // *** Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Regression) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData ||
                 !parsedData.model_summary || typeof parsedData.model_summary !== 'object' || !parsedData.model_summary.hasOwnProperty('r_squared') ||
                 // variable_importance is optional
                 !parsedData.coefficients || !Array.isArray(parsedData.coefficients) || parsedData.coefficients.length === 0 ||
                 (parsedData.coefficients.length > 0 && (typeof parsedData.coefficients[0] !== 'object' || !parsedData.coefficients[0].hasOwnProperty('p_value'))) ||
                 !parsedData.residuals_analysis || typeof parsedData.residuals_analysis !== 'object' || !parsedData.residuals_analysis.hasOwnProperty('predicted_vs_residuals') || !Array.isArray(parsedData.residuals_analysis.predicted_vs_residuals) ||
                 !parsedData.business_recommendations || !Array.isArray(parsedData.business_recommendations) || parsedData.business_recommendations.length < 2 || // Expect >= 2 recommendations
                 (parsedData.business_recommendations.length > 0 && (typeof parsedData.business_recommendations[0] !== 'object' || !parsedData.business_recommendations[0].hasOwnProperty('insight_link')))
                )
             {
                  console.error("Validation Failed (Regression): Required fields missing or invalid structure/count.", parsedData);
                  throw new Error(`AI response structure is incorrect. Missing/invalid fields (model_summary, coefficients, residuals_analysis, or business_recommendations [>=2]). Check console.`);
             }
             console.log(`Successfully parsed ENHANCED Regression JSON using ${MODEL_NAME}. Found ${parsedData.coefficients.length} coefficients, ${parsedData.business_recommendations.length} recommendations.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED Regression JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or required fields missing in AI response: ${e.message}. Check console logs.`);
        }

        // 4. Render Results
        renderRegressionPage_DA(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleRegressionAnalysis_DA (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderRegressionPage_DA(container, data) {
    container.innerHTML = ""; // Clear loading

     // Basic Validation
     if (!data || !data.model_summary || !data.coefficients || !data.residuals_analysis || !data.business_recommendations) {
         console.error("Incomplete data passed to renderRegressionPage_DA:", data);
         container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render results.</div>`;
         $("analysisActions").classList.add("hidden");
         return;
     }

    const { model_summary, variable_importance, coefficients, residuals_analysis, business_recommendations } = data; // Use new key 'residuals_analysis'

    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    // Added "Learn Regression" tab
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="fit"> Model Fit & Diagnostics</button>
        ${(variable_importance && variable_importance.length > 0) ? '<button class="analysis-tab-btn" data-tab="importance"> Variable Importance</button>' : ''}
        <button class="analysis-tab-btn" data-tab="coeffs"> Coefficient Details</button>
        <button class="analysis-tab-btn" data-tab="rec"> Recommendations</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Regression</button>
    `;
    container.appendChild(tabNav);

    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    // Added "learnPanel" and conditional "importancePanel"
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="fitPanel" class="analysis-tab-panel"></div>
        ${(variable_importance && variable_importance.length > 0) ? '<div id="importancePanel" class="analysis-tab-panel"></div>' : ''}
        <div id="coeffsPanel" class="analysis-tab-panel"></div>
        <div id="recPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Dashboard Panel (Updated interpretation source) ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4">
                <h3 class="text-2xl font-bold mb-4 text-center">Regression Dashboard</h3>
                <div class="cascade-objective mb-6 text-center mx-auto max-w-4xl"><h4 class="text-lg font-bold text-indigo-300">Regression Equation</h4><p class="text-xl font-semibold break-words">${model_summary.regression_equation ?? 'N/A'}</p></div>
                <blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90 mb-8 max-w-4xl mx-auto">${model_summary.interpretation ?? 'Model summary interpretation unavailable.'}</blockquote>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 max-w-2xl mx-auto">
                    <div class="kpi-card"><p class="kpi-name" title="Proportion of variance explained by the model">R-Squared</p><p class="kpi-target">${model_summary.r_squared?.toFixed(3) ?? 'N/A'}</p></div>
                    <div class="kpi-card"><p class="kpi-name" title="R-Squared adjusted for number of predictors">Adj. R-Squared</p><p class="kpi-target">${model_summary.adj_r_squared?.toFixed(3) ?? 'N/A'}</p></div>
                </div>
            </div>`;
    dashboardPanel.innerHTML = dashboardHtml;

    // --- 2. Model Fit & Diagnostics Panel (Updated interpretation source) ---
    const fitPanel = $("fitPanel");
    let fitHtml = `<div class="p-4">
                <h3 class="text-2xl font-bold mb-6 text-center">Model Fit & Diagnostics</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto mb-8">
                    <div class="diagnostic-card" title="Tests if the overall model is statistically significant"><div class="stat-value">${model_summary.f_statistic?.toFixed(2) ?? 'N/A'}</div><div class="stat-label">F-Statistic</div></div>
                    <div class="diagnostic-card" title="P-value for the F-Statistic (low value indicates overall model significance)"><div class="stat-value">${model_summary.prob_f_statistic?.toFixed(3) ?? 'N/A'}</div><div class="stat-label">Prob (F-Statistic)</div></div>
                </div>
                <h4 class="text-xl font-bold mb-2 text-center">Residuals Analysis</h4>
                <blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90 mb-8 max-w-4xl mx-auto">${residuals_analysis.interpretation ?? 'Residual analysis interpretation unavailable.'}</blockquote>
                <div id="residualsPlot" class="w-full h-[500px] plotly-chart bg-black/10 rounded-lg"></div>
            </div>`;
    fitPanel.innerHTML = fitHtml;

     // Render Residuals Plot
     if (residuals_analysis.predicted_vs_residuals && residuals_analysis.predicted_vs_residuals.length > 0) {
         try {
             const residualsTrace = {
                 x: residuals_analysis.predicted_vs_residuals.map(p => p.predicted),
                 y: residuals_analysis.predicted_vs_residuals.map(p => p.residual),
                 mode: 'markers', type: 'scatter', name: 'Residuals',
                 marker: { color: 'rgba(142, 45, 226, 0.6)', size: 8 } // Use theme color semi-transparent
             };
             const residualsLayout = {
                 title: 'Residuals vs. Predicted Values Plot',
                 paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                 xaxis: { title: 'Predicted Values', gridcolor: 'rgba(255,255,255,0.1)', zeroline: false },
                 yaxis: { title: 'Residuals', zerolinecolor: 'var(--accent)', zerolinewidth: 2, gridcolor: 'rgba(255,255,255,0.1)' },
                 margin: { t: 50, b: 50, l: 60, r: 30 }
             };
             Plotly.newPlot('residualsPlot', [residualsTrace], residualsLayout, { responsive: true });
         } catch(e) {
             console.error("Error rendering residuals plot:", e);
             $("residualsPlot").innerHTML = `<div class="p-4 text-center text-red-400">Could not render residuals plot.</div>`;
         }
     } else {
         $("residualsPlot").innerHTML = `<div class="p-4 text-center text-white/60">Residual data points not available for plotting.</div>`;
     }


    // --- 3. Variable Importance Panel (Conditional, updated rationale source) ---
    if (variable_importance && variable_importance.length > 0) {
        const importancePanel = $("importancePanel");
        if (importancePanel) {
            let importanceHtml = `<div class="p-4">
                        <h3 class="text-2xl font-bold mb-4 text-center">Variable Importance</h3>
                        <div id="importancePlot" class="w-full h-[500px] plotly-chart bg-black/10 rounded-lg mb-8"></div>
                        <div class="space-y-4 max-w-3xl mx-auto">`;
             variable_importance.forEach(v => {
                 importanceHtml += `
                     <div class="bg-white/5 p-3 rounded-lg border-l-4 border-indigo-400">
                         <p class="font-bold">${v.variable ?? 'N/A'}</p>
                         <p class="text-sm text-white/80 italic"><strong>Rationale:</strong> ${v.rationale ?? 'Importance rationale not provided.'}</p>
                     </div>`;
             });
             importanceHtml += `</div></div>`;
             importancePanel.innerHTML = importanceHtml;

             // Render Importance Plot
             try {
                 const importanceData = [...variable_importance].sort((a, b) => (a.importance_score ?? 0) - (b.importance_score ?? 0)); // Sort ascending for horizontal bar
                 const importanceTrace = {
                     y: importanceData.map(v => v.variable), // Use y for horizontal bars
                     x: importanceData.map(v => v.importance_score ?? 0), // Use x for values
                     type: 'bar', orientation: 'h', // Set orientation to horizontal
                     marker: { color: 'var(--primary)' }
                 };
                 const importanceLayout = {
                     title: 'Relative Importance of Predictors',
                     paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                     yaxis: { automargin: true }, // Ensure labels fit
                     xaxis: { title: 'Importance Score', gridcolor: 'rgba(255,255,255,0.1)', zeroline: false },
                     margin: { t: 50, b: 50, l: 150, r: 30 } // Increase left margin for labels
                 };
                 Plotly.newPlot('importancePlot', [importanceTrace], importanceLayout, { responsive: true });
             } catch(e) {
                  console.error("Error rendering importance plot:", e);
                  $("importancePlot").innerHTML = `<div class="p-4 text-center text-red-400">Could not render importance plot.</div>`;
             }
        }
    }

    // --- 4. Coefficient Details Panel (Updated significance source) ---
    const coeffsPanel = $("coeffsPanel");
    let coeffsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Coefficient Interpretation Details</h3><div class="space-y-4">`;
    coefficients.forEach((c) => {
        const isSignificant = (c.p_value != null && c.p_value <= 0.05); // Check p-value exists
         // Use significance field from AI if available, otherwise calculate
         const significanceText = c.significance ?? (isSignificant ? "Yes (p<0.05)" : "No (p>=0.05)");
         const borderColor = isSignificant ? "border-green-400" : "border-gray-500";
        coeffsHtml += `
            <div class="bg-white/5 p-4 rounded-lg border-l-4 ${borderColor}">
                <h4 class="text-lg font-bold">${c.variable ?? 'N/A'}</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm mt-2 mb-3">
                    <p><strong>Coefficient:</strong> ${c.coefficient?.toFixed(4) ?? 'N/A'}</p>
                    <p><strong>Std. Error:</strong> ${c.std_error?.toFixed(4) ?? 'N/A'}</p>
                    <p class="${isSignificant ? "text-green-300 font-semibold" : "text-white/70"}"><strong>P-value:</strong> ${c.p_value?.toFixed(3) ?? 'N/A'}</p>
                    <p class="${isSignificant ? "text-green-300 font-semibold" : "text-white/70"}"><strong>Significant?:</strong> ${significanceText}</p>
                </div>
                <p class="text-sm text-white/80 italic"><strong>Interpretation:</strong> ${c.interpretation ?? 'N/A'}</p>
            </div>`;
    });
    coeffsHtml += `</div><p class="text-xs text-white/60 mt-4">* Significance based on p-value < 0.05 threshold.</p></div>`;
    coeffsPanel.innerHTML = coeffsHtml;

    // --- 5. Recommendations Panel (Updated insight link source) ---
    const recPanel = $("recPanel");
    let recHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Actionable Recommendations</h3>`;
     if (business_recommendations.length > 0) {
         recHtml += `<div class="space-y-6">`;
         business_recommendations.forEach((rec, index) => {
             recHtml += `<div class="prescription-card">
                         <h4 class="text-xl font-bold">${index + 1}. ${rec.recommendation ?? 'N/A'}</h4>
                         <p class="rationale"><strong>Driven By:</strong> ${rec.insight_link ?? 'N/A'}</p>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                             <div class="bg-black/20 p-3 rounded">
                                 <h5 class="font-bold text-indigo-300 mb-2">Action Items</h5>
                                 <ul class="list-disc list-inside space-y-1 text-white/90">${(rec.action_items || []).map(a => `<li>${a}</li>`).join("")}</ul>
                             </div>
                             <div class="bg-black/20 p-3 rounded">
                                 <h5 class="font-bold text-indigo-300 mb-2">Potential Risks</h5>
                                 <p class="text-white/90">${rec.potential_risks ?? 'N/A'}</p>
                                 <h5 class="font-bold text-indigo-300 mt-3 mb-2">KPIs to Track</h5>
                                 <p class="text-white/90 text-xs">${(rec.kpis_to_track || []).join(", ")}</p>
                             </div>
                         </div>
                     </div>`;
         });
         recHtml += `</div>`;
     } else {
         recHtml += `<p class="text-center text-white/70 italic">No specific business recommendations generated based on the model results.</p>`;
     }
     recHtml += `</div>`;
    recPanel.innerHTML = recHtml;


    // --- 6. Populate Learn Regression Tab ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Regression Analysis</h3>
        [Image of scatter plot with regression line]
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is Regression Analysis?</h4>
            <p class="text-sm text-white/80">Regression is a statistical method used to model the relationship between a dependent variable (the outcome you want to predict or explain) and one or more independent variables (the factors believed to influence the outcome).</p>
             <p class="text-sm text-white/80 mt-2">Essentially, it tries to find the "best fit" line (or curve) through the data points to describe how changes in the independent variables are associated with changes in the dependent variable.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Key Concepts:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Dependent Variable (Y):</strong> The main variable you're interested in (e.g., Sales, Customer Score).</li>
                    <li><strong>Independent Variables (X):</strong> Predictor variables (e.g., Ad Spend, Website Visits, Temperature).</li>
                    <li><strong>Coefficients ():</strong> Numbers representing the strength and direction of the relationship between each X and Y. A positive coefficient means X increases Y; negative means X decreases Y.</li>
                    <li><strong>Intercept ():</strong> The predicted value of Y when all X variables are zero.</li>
                    <li><strong>R-squared (R):</strong> Measures how well the model fits the data (0 to 1). A value of 0.7 means 70% of the variation in Y is explained by the X variables in the model.</li>
                     <li><strong>Adjusted R-squared:</strong> R-squared adjusted for the number of predictors in the model. More useful when comparing models with different numbers of variables.</li>
                    <li><strong>P-value:</strong> Indicates the statistical significance of a coefficient. A low p-value (typically < 0.05) suggests the variable likely has a real effect on Y.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Interpreting Results:</h4>
                 <p class="text-sm mb-2"><strong>Model Fit (R, F-stat P-value):</strong></p>
                 <ul class="list-[circle] list-inside pl-4 text-xs mb-3">
                    <li>High R suggests a good fit *to the current data*.</li>
                    <li>Low Prob(F-stat) (<0.05) means the overall model is significant (better than random chance).</li>
                 </ul>
                 <p class="text-sm mb-2"><strong>Coefficients & P-values:</strong></p>
                  <ul class="list-[circle] list-inside pl-4 text-xs mb-3">
                    <li>Focus on coefficients with low P-values (<0.05). These represent significant relationships.</li>
                    <li>The coefficient's value tells you the magnitude and direction of the effect.</li>
                 </ul>
                  <p class="text-sm mb-2"><strong>Residuals Plot:</strong></p>
                   <ul class="list-[circle] list-inside pl-4 text-xs">
                    <li>Should show random scatter around zero.</li>
                    <li>Patterns (curves, funnels) indicate model assumption violations (like non-linearity or heteroscedasticity), meaning results might be unreliable.</li>
                 </ul>
            </div>
        </div>

        <details class="styled-details text-sm">
            <summary class="font-semibold">Important Assumptions & Cautions</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-3">
                <p> <strong>Correlation is NOT Causation:</strong> Regression shows association, not necessarily that X *causes* Y.</p>
                <p> linearity <strong>Linearity:</strong> Assumes the relationship between X and Y is roughly linear (check residuals).</p>
                <p> <strong>Homoscedasticity:</strong> Assumes the variance of errors (residuals) is constant across all levels of X (check residuals for fanning).</p>
                <p> <strong>Independence:</strong> Assumes observations are independent of each other (important for time-series data).</p>
                 <p> <strong>Normality of Residuals:</strong> Assumes errors are normally distributed (less critical with large samples, but good to check).</p>
                <p> <strong>Outliers:</strong> Extreme data points can heavily influence results.</p>
                <p> extrapolating <strong>Extrapolation:</strong> Avoid making predictions far outside the range of your original data.</p>
            </div>
        </details>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (including chart resizing)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");

                // Resize any Plotly charts within the newly active panel
                const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                chartsInPanel.forEach(chartDiv => {
                    if (chartDiv.layout && typeof Plotly !== 'undefined') { // Check if it's a rendered Plotly chart
                        try {
                            Plotly.Plots.resize(chartDiv);
                             console.log(`Resized chart ${chartDiv.id} on tab switch.`);
                        } catch (resizeError) {
                            console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                        }
                    }
                });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Attempt initial resize for charts in the default active tab (dashboard has no charts, fit has one)
     setTimeout(() => {
         const activeTabButton = tabNav.querySelector(".analysis-tab-btn.active");
         if (activeTabButton && activeTabButton.dataset.tab === "fit") {
             const residualsChart = $("residualsPlot");
             if (residualsChart && residualsChart.layout && typeof Plotly !== 'undefined') {
                 try { Plotly.Plots.resize(residualsChart); } catch (e) { console.error("Initial resize error (residuals):", e); }
             }
         }
         // Add similar checks if other default tabs have charts
     }, 150);

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Already handled in the calling function's finally block
}

    async function handleLeveragePointsAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `
        <div class="text-center text-white/70 p-8">
            <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
            <h3 class="text-xl font-semibold text-white mb-4">Performing Full System Leverage Analysis</h3>
            <p class="text-white/80 mb-2">Identifying elements, feedback loops, and high-impact intervention points...</p> <!-- Updated text -->
        </div>`;
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = $("docUpload").checked;
        let text = "";

        if (useDoc) {
            const file = $("leverageFile").files[0];
            if (!file) throw new Error("Please select a document to upload.");
            text = await extractTextFromFile(file);
        } else {
            text = $("leverageContent").value.trim();
            if (!text.trim()) throw new Error("Please enter system information in the text area.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (text.length > MAX_CONTEXT_LENGTH) {
            text = text.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`Leverage Points analysis context truncated.`);
        }


        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are a master systems thinking analyst applying principles similar to Donella Meadows' leverage points hierarchy. Your task is to analyze the provided system description, identify its structure, and pinpoint high-impact leverage points based *only* on the provided text. ${truncatedNote}

            **USER'S SYSTEM DESCRIPTION:**
            \`\`\`
            ${text}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Identify Elements (5-7 elements):** Extract key system elements mentioned or clearly implied. For each element:
                * \`name\`: Concise name (2-4 words).
                * \`type\`: Classify as "Stock" (accumulation), "Flow" (rate of change), "Variable" (influencing factor), or "Parameter" (constant/policy) based on context.
            2.  **Identify Feedback Loops (1 Reinforcing, 1 Balancing):** Identify the *primary* reinforcing loop (driving growth/change) and the *primary* balancing loop (limiting/stabilizing) suggested by the text. For each loop:
                * \`name\`: A descriptive name (e.g., "R1: Market Growth Engine", "B1: Resource Constraint").
                * \`type\`: "Reinforcing" or "Balancing".
                * \`description\`: Explain the causal chain step-by-step, explicitly mentioning how the identified elements interact (e.g., "Increased [Element A - Stock] leads to higher [Element B - Variable], which accelerates the [Element C - Flow], further increasing [Element A - Stock]").
                * \`elements\`: List the names of the key elements involved in this specific loop.
            3.  **System Behavior Summary:** Provide a concise \`summary\` explaining how the identified reinforcing and balancing loops interact to produce the overall behavior described or implied in the user's text.
            4.  **Identify Leverage Points (3-4 points, ranked):** Pinpoint high-leverage points where interventions could significantly alter the system's behavior, based *only* on the loop analysis and context. For each point:
                * \`point_name\`: Name of the leverage point (e.g., "Adjusting [Parameter Name]", "Influencing [Variable Name]", "Changing Goal of [Balancing Loop Name]").
                * \`potential_impact_rank\`: Rank the potential impact as "High", "Medium", or "Low" based on systems principles (e.g., changing parameters is often lower leverage than changing goals or loop structure). Provide a brief justification for the rank based on Meadows' concepts if applicable (e.g., "Lower leverage - Parameter Adjustment", "Higher leverage - Goal Change").
                * \`target_element_or_loop\`: The specific element, connection, or loop the intervention primarily affects.
                * \`intervention\`: A concrete suggested action based *only* on the context provided.
                * \`rationale\`: Explain *why* this is a leverage point according to system structure (e.g., "This parameter influences the speed of R1", "This intervention changes the information flow in B1").
                * \`expected_outcome\`: Describe the intended effect on the system's behavior and the identified loops (e.g., "Accelerate growth by strengthening R1", "Stabilize system by reducing oscillations in B1").
            5.  **Self-Correction:** Before outputting JSON, rigorously check: Is everything derived *solely* from the text? Are element types correct? Are loop descriptions causally accurate? Does the summary explain loop interplay? Are leverage points ranked plausibly? Is the intervention rationale clear and linked to system structure/loops? Is the JSON structure perfect? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT GROUNDING:** All output MUST be based *exclusively* on the provided SYSTEM DESCRIPTION. Do NOT invent information.
            - **SYSTEMS PRINCIPLES:** Apply concepts correctly. Leverage point ranking should generally follow Meadows' hierarchy (changing goals > rules > information > parameters).
            - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.** Rank leverage points by potential impact (High first).
            {
              "elements": [ /* ... */ ],
              "feedback_loops": [ /* ... */ ],
              "summary": "...",
              "leverage_points": [ // Ranked High -> Low
                {
                  "point_name": "Shift System Goal",
                  "potential_impact_rank": "High - Goal Change", // Justification included
                  "target_element_or_loop": "B1 Loop Goal",
                  "intervention": "Redefine the success metric for support from 'ticket closure rate' to 'customer retention impact', as implied by churn issues.",
                  "rationale": "Changing the goal of a balancing loop is high leverage; it fundamentally alters behavior by shifting focus from speed to quality.",
                  "expected_outcome": "Shift focus towards actions that improve long-term retention (strengthening R1 indirectly) rather than just closing tickets quickly (weakening B1's negative impact)."
                },
                {
                   "point_name": "Improve Information Flow",
                   "potential_impact_rank": "Medium - Information Flow",
                   "target_element_or_loop": "Service Quality -> New Customers Rate Link",
                   "intervention": "Implement proactive communication about quality issues based on real-time monitoring.",
                   "rationale": "Adding timely, accurate information flow allows the system to self-correct faster, dampening oscillations caused by delays in the B1 loop.",
                   "expected_outcome": "Reduce negative word-of-mouth impact by managing expectations, thus stabilizing the R1 loop."
                },
                {
                  "point_name": "Adjust Support Staffing Parameter",
                  "potential_impact_rank": "Low - Parameter Adjustment",
                  "target_element_or_loop": "Support Capacity",
                  "intervention": "Increase the budget parameter for support staff hiring mentioned in the capacity constraint.",
                  "rationale": "Adjusting parameters (like numbers, buffer sizes) is typically lower leverage but directly addresses the B1 constraint.",
                  "expected_outcome": "Increase the threshold of the B1 loop, allowing more growth before quality degrades, weakening B1's limiting effect."
                }
                // ... potentially one more ...
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED Leverage Points prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (Leverage Points):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Leverage Points) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !Array.isArray(parsedData.elements) || parsedData.elements.length < 3 ||
                 !Array.isArray(parsedData.feedback_loops) || parsedData.feedback_loops.length < 1 ||
                 !parsedData.summary || typeof parsedData.summary !== 'string' ||
                 !Array.isArray(parsedData.leverage_points) || parsedData.leverage_points.length < 1 ||
                 // Check structure of first elements if they exist
                 (parsedData.elements.length > 0 && (typeof parsedData.elements[0] !== 'object' || !parsedData.elements[0].hasOwnProperty('name') || !parsedData.elements[0].hasOwnProperty('type'))) ||
                 (parsedData.feedback_loops.length > 0 && (typeof parsedData.feedback_loops[0] !== 'object' || !parsedData.feedback_loops[0].hasOwnProperty('name') || !parsedData.feedback_loops[0].hasOwnProperty('description') || !Array.isArray(parsedData.feedback_loops[0].elements))) ||
                 (parsedData.leverage_points.length > 0 && (typeof parsedData.leverage_points[0] !== 'object' || !parsedData.leverage_points[0].hasOwnProperty('point_name') || !parsedData.leverage_points[0].hasOwnProperty('potential_impact_rank') || !parsedData.leverage_points[0].hasOwnProperty('intervention') || !parsedData.leverage_points[0].hasOwnProperty('rationale') || !parsedData.leverage_points[0].hasOwnProperty('expected_outcome')))
                )
             {
                  console.error("Validation Failed (Enhanced Leverage Points): Required fields missing or invalid structure.", parsedData);
                  throw new Error(`AI response structure is incorrect or inconsistent (Enhanced Leverage Points). Check elements, loops, summary, and leverage points structure. See console logs.`);
             }
             // Ensure leverage points are sorted High -> Low (simple check on first element if multiple)
             if (parsedData.leverage_points.length > 1 && parsedData.leverage_points[0].potential_impact_rank?.startsWith('Low')) {
                 console.warn("Leverage points may not be correctly sorted by impact rank.");
             }

             console.log(`Successfully parsed ENHANCED Leverage Points JSON using ${MODEL_NAME}. Found ${parsedData.leverage_points.length} leverage points.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED Leverage Points JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced Leverage Points): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results
        renderLeveragePointsPage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleLeveragePointsAnalysis (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderLeveragePointsPage(container, data) {
    container.innerHTML = ""; // Clear the loading indicator

    // Add validation for new fields
    if (!data || !data.elements || !data.feedback_loops || !data.summary || !data.leverage_points) {
        console.error("Incomplete data passed to renderLeveragePointsPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Leverage Points results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    const { elements, feedback_loops, summary, leverage_points } = data;


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="gist"> Gist & Elements</button>
        <button class="analysis-tab-btn" data-tab="loops"> Feedback Loops</button>
        <button class="analysis-tab-btn" data-tab="leverage"> Leverage Points & Interventions</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="learn"> Learn Leverage Points</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="gistPanel" class="analysis-tab-panel active"></div>
        <div id="loopsPanel" class="analysis-tab-panel"></div>
        <div id="leveragePanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- 1. Populate Gist & Elements Panel (Reusing logic from System Thinking) ---
    const gistPanel = $("gistPanel");
    let gistHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">System Overview</h3>`;
    gistHtml += `<blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90 mb-6 text-sm">"${summary}"</blockquote>`;
    gistHtml += `<h4 class="text-xl font-semibold mb-3">Key System Elements Identified</h4>`;
     gistHtml += `<div class="overflow-x-auto">
                    <table class="coeff-table styled-table text-sm">
                        <thead><tr><th>Element Name</th><th>Type</th><th>Description (Inferred Role)</th></tr></thead>
                        <tbody>`;
    elements.forEach(el => {
         let description = "";
         if (el.type === "Stock") description = "Accumulation over time";
         else if (el.type === "Flow") description = "Rate of change affecting a Stock";
         else if (el.type === "Variable") description = "Factor influencing Flows/Variables";
         else if (el.type === "Parameter") description = "Constant or policy";
        gistHtml += `<tr><td class="font-semibold">${el.name}</td><td class="font-mono text-xs">${el.type}</td><td class="text-white/70">${description}</td></tr>`;
    });
     gistHtml += `</tbody></table></div></div>`; // Close table div and p-4
    gistPanel.innerHTML = gistHtml;

    // --- 2. Populate Feedback Loops Panel (Reusing logic from System Thinking) ---
    const loopsPanel = $("loopsPanel");
    let loopsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Identified Feedback Loops</h3><div class="space-y-6">`;
    feedback_loops.forEach((loop) => {
        const isReinforcing = loop.type.toLowerCase() === "reinforcing";
        const loopIcon = isReinforcing ? "" : "";
        const loopColor = isReinforcing ? "border-green-400" : "border-yellow-400";
        loopsHtml += `
            <div class="bg-black/20 p-4 rounded-lg border-l-4 ${loopColor}">
                <h4 class="text-lg font-bold flex items-center gap-2">${loopIcon} ${loop.name} <span class="text-xs font-light text-white/60">(${loop.type})</span></h4>
                <p class="text-sm text-white/80 my-3 italic"><strong>Causal Chain:</strong> ${loop.description}</p>
                <div class="text-xs text-white/60"><strong>Key Elements Involved:</strong> ${loop.elements.join(", ")}</div>
            </div>`;
    });
    loopsHtml += `</div></div>`;
    loopsPanel.innerHTML = loopsHtml;

    // --- 3. Populate Leverage Points Panel (Updated for detailed interventions) ---
    const leveragePanel = $("leveragePanel");
    let leverageHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> High-Impact Leverage Points & Interventions</h3>`;
    if (leverage_points && leverage_points.length > 0) {
        leverageHtml += `<p class="text-sm text-white/70 mb-6 italic">These are ranked intervention points where actions can significantly shift system behavior, ordered from potentially highest to lowest impact based on system principles.</p>`;
        leverageHtml += `<div class="space-y-6">`;
        // Sort points based on High > Medium > Low impact rank for rendering
        const impactOrder = { "High": 1, "Medium": 2, "Low": 3 };
        const sortedLeveragePoints = [...leverage_points].sort((a, b) => {
            const rankA = impactOrder[a.potential_impact_rank?.split(" ")[0]] || 4; // Default to lowest if rank missing
            const rankB = impactOrder[b.potential_impact_rank?.split(" ")[0]] || 4;
            return rankA - rankB;
        });

        sortedLeveragePoints.forEach((point, index) => {
             let borderColor = "border-indigo-400"; // Default
             if (point.potential_impact_rank?.startsWith("High")) borderColor = "border-red-500";
             else if (point.potential_impact_rank?.startsWith("Medium")) borderColor = "border-yellow-500";
             else if (point.potential_impact_rank?.startsWith("Low")) borderColor = "border-blue-500";

            leverageHtml += `
                <div class="prescription-card ${borderColor}">
                     <h4 class="text-xl font-bold">${index + 1}. ${point.point_name}</h4>
                     <p class="text-xs font-semibold my-1 ${borderColor.replace('border-', 'text-')}">${point.potential_impact_rank || 'Impact Undefined'}</p>
                     <p class="text-xs font-semibold my-1 text-white/70">TARGET: ${point.target_element_or_loop || 'N/A'}</p>
                     <p class="rationale mt-3"><strong>Proposed Intervention:</strong> ${point.intervention || 'N/A'}</p>
                     <p class="text-sm text-white/80 mt-2 italic"><strong>System Rationale:</strong> ${point.rationale || 'N/A'}</p>
                     <div class="p-3 bg-black/20 rounded mt-3 text-sm">
                         <p><strong>Expected Outcome:</strong> ${point.expected_outcome || 'N/A'}</p>
                     </div>
                </div>`;
        });
        leverageHtml += `</div>`;
    } else {
        leverageHtml += `<p class="text-center text-white/70 italic">No specific leverage points were clearly identified from the provided system description.</p>`;
    }
    leverageHtml += `</div>`; // Close p-4
    leveragePanel.innerHTML = leverageHtml;


    // --- 4. Populate Learn Leverage Points Panel (New) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Leverage Points</h3>
         
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What are Leverage Points?</h4>
            <p class="text-sm text-white/80">Popularized by Donella Meadows, leverage points are places within a complex system where a small shift in one thing can produce big changes in everything. Intervening at higher leverage points is often more effective, though potentially harder, than intervening at lower ones.</p>
        </div>

        <h4 class="text-xl font-semibold mt-4 mb-2 text-center">Meadows' 12 Places to Intervene (Simplified & Ranked Low to High Impact):</h4>
        <div class="overflow-x-auto">
             <table class="coeff-table styled-table text-sm">
                 <thead><tr><th>#</th><th>Leverage Point Type</th><th>Example Intervention</th><th>Impact Potential</th></tr></thead>
                 <tbody>
                     <tr><td>12</td><td><strong>Constants, Parameters, Numbers</strong></td><td>Adjusting budgets, staff levels, thresholds</td><td>Low</td></tr>
                     <tr><td>11</td><td><strong>Sizes of Buffers/Stocks</strong></td><td>Increasing inventory, server capacity</td><td>Low</td></tr>
                     <tr><td>10</td><td><strong>Structure of Material Stocks/Flows</strong></td><td>Changing physical layout, supply chain routes</td><td>Low-Medium</td></tr>
                     <tr><td>9</td><td><strong>Lengths of Delays</strong></td><td>Reducing response times, speeding up feedback</td><td>Medium</td></tr>
                     <tr><td>8</td><td><strong>Strength of Balancing Feedback Loops</strong></td><td>Implementing quality controls, regulations</td><td>Medium</td></tr>
                     <tr><td>7</td><td><strong>Strength of Reinforcing Feedback Loops</strong></td><td>Boosting marketing for word-of-mouth, R&D investment</td><td>Medium-High</td></tr>
                     <tr><td>6</td><td><strong>Structure of Information Flows</strong></td><td>Improving transparency, communication channels</td><td>Medium-High</td></tr>
                     <tr><td>5</td><td><strong>Rules of the System</strong></td><td>Changing incentives, policies, regulations</td><td>High</td></tr>
                     <tr><td>4</td><td><strong>Power to Add/Change System Structure</strong></td><td>Creating new departments, feedback loops</td><td>High</td></tr>
                     <tr><td>3</td><td><strong>Goals of the System</strong></td><td>Shifting focus from profit to sustainability, speed to quality</td><td>High</td></tr>
                     <tr><td>2</td><td><strong>Mindset or Paradigm</strong></td><td>Changing core beliefs/values (e.g., growth vs. stability)</td><td>Very High</td></tr>
                     <tr><td>1</td><td><strong>Power to Transcend Paradigms</strong></td><td>Realizing no single paradigm is complete</td><td>Highest</td></tr>
                 </tbody>
             </table>
        </div>

         <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
            <h4 class="text-lg font-bold mb-2">How This Tool Applies It:</h4>
            <p class="text-sm text-white/80">This tool analyzes the system description to identify key feedback loops. It then suggests interventions (Leverage Points) targeting specific elements, parameters, or connections within those loops. The 'Potential Impact Rank' attempts to align with Meadows' hierarchy, suggesting whether the intervention targets a relatively low (e.g., parameter change) or potentially higher (e.g., rule/goal change implied by context) point of leverage.</p>
        </div>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}


// --- Keep selection-tag wrapping handleSystemThinkingAnalysis and renderSystemThinkingPage ---
// (The selection tag provided by the user implicitly wraps these two functions)
async function handleSystemThinkingAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white">Analyzing System Dynamics...</h3><p class="text-white/80 mb-2">Identifying elements, loops, and leverage points based on your description...</p></div>`; // Updated text
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = document.querySelector('input[name="inputType"]:checked').id === "docUpload";
        let content = "";
        if (useDoc) {
            const file = $("systemFile").files[0];
            if (!file) throw new Error("Please select a document.");
            content = await extractTextFromFile(file);
        } else {
            content = $("systemContent").value.trim();
            if (!content) throw new Error("Please describe the system.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (content.length > MAX_CONTEXT_LENGTH) {
            content = content.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`System Thinking analysis context truncated.`);
        }

        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are an expert systems thinking analyst. Analyze the provided system description to identify its underlying structure, feedback loops, and potential leverage points based *only* on the provided text. ${truncatedNote}

            **USER'S SYSTEM DESCRIPTION:**
            \`\`\`
            ${content}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Identify Elements (5-7 elements):** Extract key system elements mentioned or clearly implied. For each element:
                * \`name\`: Concise name (2-4 words).
                * \`type\`: Classify as "Stock" (accumulation), "Flow" (rate of change), "Variable" (influencing factor), or "Parameter" (constant/policy) based on context.
            2.  **Identify Feedback Loops (1 Reinforcing, 1 Balancing):** Identify the *primary* reinforcing loop (driving growth/change) and the *primary* balancing loop (limiting/stabilizing) suggested by the text. For each loop:
                * \`name\`: A descriptive name (e.g., "R1: Word of Mouth Growth", "B1: Service Capacity Limit").
                * \`type\`: "Reinforcing" or "Balancing".
                * \`description\`: Explain the causal chain step-by-step, explicitly mentioning how the elements interact (e.g., "Increased [Element A - Stock] leads to higher [Element B - Variable], which accelerates the [Element C - Flow], further increasing [Element A - Stock]").
                * \`elements\`: List the names of the key elements involved in this specific loop.
            3.  **System Behavior Summary:** Provide a concise \`summary\` explaining how the identified reinforcing and balancing loops interact to produce the overall behavior described or implied in the user's text.
            4.  **Identify Leverage Points (2-3 points):** Pinpoint high-leverage points where interventions could significantly alter the system's behavior, based on the loop analysis. For each point:
                * \`point_name\`: Name of the leverage point (often related to an element or connection).
                * \`target_element\`: The specific element the intervention primarily affects.
                * \`intervention\`: A concrete suggested action based on the context.
                * \`expected_impact\`: Describe the intended effect on the feedback loops (e.g., "Strengthens R1 loop by increasing inflow X", "Weakens B1 loop by reducing constraint Y", "Alters goal of B1").
            5.  **Self-Correction:** Before outputting JSON, rigorously check: Are all elements, loops, and leverage points derived *solely* from the text? Are element types correctly classified based on context? Are loop descriptions causally accurate and reference the identified elements? Does the summary explain the loop interplay? Are interventions linked to leverage points and expected impacts clearly stated in terms of loop effects? Is the JSON structure perfect? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT GROUNDING:** All output MUST be based *exclusively* on the provided SYSTEM DESCRIPTION. Do NOT invent elements, loops, or interventions not supported by the text.
            - **SYSTEMS THINKING PRINCIPLES:** Apply concepts of stocks, flows, feedback loops, and leverage points correctly based on the context.
            - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys and sub-keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
            {
              "elements": [
                {"name": "Customer Base", "type": "Stock"},
                {"name": "New Customers Rate", "type": "Flow"},
                {"name": "Service Quality", "type": "Variable"},
                {"name": "Support Capacity", "type": "Stock"},
                {"name": "Support Ticket Rate", "type": "Flow"},
                {"name": "Company Policy X", "type": "Parameter"}
              ],
              "feedback_loops": [
                {
                  "name": "R1: Word of Mouth Growth",
                  "type": "Reinforcing",
                  "description": "A larger [Customer Base - Stock] leads to potentially higher [Service Quality - Variable] perceptions (if capacity holds), generating positive word-of-mouth which increases the [New Customers Rate - Flow], further growing the [Customer Base - Stock].",
                  "elements": ["Customer Base", "Service Quality", "New Customers Rate"]
                },
                {
                  "name": "B1: Support Capacity Limit",
                  "type": "Balancing",
                  "description": "A growing [Customer Base - Stock] increases the [Support Ticket Rate - Flow]. If this exceeds [Support Capacity - Stock], [Service Quality - Variable] declines, potentially reducing the [New Customers Rate - Flow] and slowing growth of the [Customer Base - Stock].",
                  "elements": ["Customer Base", "Support Ticket Rate", "Support Capacity", "Service Quality", "New Customers Rate"]
                }
              ],
              "summary": "The system shows potential for reinforcing growth (R1) driven by customer base and quality perception. However, this growth is likely limited by the balancing loop (B1) related to support capacity, which negatively impacts service quality when strained, thus counteracting the growth engine.",
              "leverage_points": [
                {
                  "point_name": "Support Capacity Expansion",
                  "target_element": "Support Capacity",
                  "intervention": "Invest in hiring and training more support staff, or implement tools to increase efficiency, as suggested by the capacity limit bottleneck.",
                  "expected_impact": "Weakens the B1 loop by increasing the threshold at which service quality degrades, allowing the R1 growth loop to operate more effectively for longer."
                },
                {
                  "point_name": "Service Quality Monitoring",
                  "target_element": "Service Quality",
                  "intervention": "Implement real-time monitoring of service quality metrics (e.g., response time, CSAT) mentioned implicitly as important.",
                  "expected_impact": "Provides faster feedback within the B1 loop, allowing quicker adjustments to capacity (part of the intervention for B1) before quality drops significantly, thus stabilizing R1."
                },
                 {
                  "point_name": "Influence Policy X",
                  "target_element": "Company Policy X",
                  "intervention": "Re-evaluate 'Company Policy X' identified in the context to see if it inadvertently constrains growth or capacity.",
                  "expected_impact": "Alters a system parameter, potentially weakening the B1 loop or modifying the goal/speed of the R1 loop depending on the policy's function."
                }
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED System Thinking prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (System Thinking):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced System Thinking) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !Array.isArray(parsedData.elements) || parsedData.elements.length < 3 || // Expect a few elements
                 !Array.isArray(parsedData.feedback_loops) || parsedData.feedback_loops.length < 1 || // Expect at least one loop
                 !parsedData.summary || typeof parsedData.summary !== 'string' ||
                 !Array.isArray(parsedData.leverage_points) || parsedData.leverage_points.length < 1 || // Expect at least one point
                 // Check structure of first elements if they exist
                 (parsedData.elements.length > 0 && (typeof parsedData.elements[0] !== 'object' || !parsedData.elements[0].hasOwnProperty('name') || !parsedData.elements[0].hasOwnProperty('type'))) ||
                 (parsedData.feedback_loops.length > 0 && (typeof parsedData.feedback_loops[0] !== 'object' || !parsedData.feedback_loops[0].hasOwnProperty('name') || !parsedData.feedback_loops[0].hasOwnProperty('description') || !Array.isArray(parsedData.feedback_loops[0].elements))) ||
                 (parsedData.leverage_points.length > 0 && (typeof parsedData.leverage_points[0] !== 'object' || !parsedData.leverage_points[0].hasOwnProperty('point_name') || !parsedData.leverage_points[0].hasOwnProperty('intervention') || !parsedData.leverage_points[0].hasOwnProperty('expected_impact')))
                )
             {
                  console.error("Validation Failed (Enhanced System Thinking): Required fields missing or invalid structure.", parsedData);
                  throw new Error(`AI response structure is incorrect or inconsistent (Enhanced System Thinking). Check elements, loops, summary, and leverage points. See console logs.`);
             }
             console.log(`Successfully parsed ENHANCED System Thinking JSON using ${MODEL_NAME}. Found ${parsedData.elements.length} elements.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED System Thinking JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced System Thinking): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results
        renderSystemThinkingPage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleSystemThinkingAnalysis (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderSystemThinkingPage(container, data) {
    container.innerHTML = ""; // Clear the loading indicator

    // Add validation for new fields
    if (!data || !data.elements || !data.feedback_loops || !data.summary || !data.leverage_points) {
        console.error("Incomplete data passed to renderSystemThinkingPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render System Thinking results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    const { elements, feedback_loops, summary, leverage_points } = data;


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="gist"> Gist & Elements</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="loops"> Feedback Loops</button>
        <button class="analysis-tab-btn" data-tab="leverage"> Leverage Points</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn System Thinking</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="gistPanel" class="analysis-tab-panel active"></div>
        <div id="loopsPanel" class="analysis-tab-panel"></div>
        <div id="leveragePanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- 1. Populate Gist & Elements Panel (Updated) ---
    const gistPanel = $("gistPanel");
    let gistHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">System Overview</h3>`;
    gistHtml += `<blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90 mb-6 text-sm">"${summary}"</blockquote>`; // Use enhanced summary
    gistHtml += `<h4 class="text-xl font-semibold mb-3">Key System Elements Identified</h4>`;
    // Table for elements
     gistHtml += `<div class="overflow-x-auto">
                    <table class="coeff-table styled-table text-sm">
                        <thead><tr><th>Element Name</th><th>Type</th><th>Description (Inferred Role)</th></tr></thead>
                        <tbody>`;
    elements.forEach(el => {
         let description = "";
         if (el.type === "Stock") description = "Accumulation over time (e.g., Customers, Inventory, Cash)";
         else if (el.type === "Flow") description = "Rate of change affecting a Stock (e.g., Sales Rate, Production Rate)";
         else if (el.type === "Variable") description = "Factor influencing Flows or other Variables (e.g., Price, Quality)";
         else if (el.type === "Parameter") description = "Constant or policy influencing the system (e.g., Tax Rate, Standard Procedure)";

        gistHtml += `<tr>
                        <td class="font-semibold">${el.name}</td>
                        <td class="font-mono text-xs">${el.type}</td>
                        <td class="text-white/70">${description}</td>
                     </tr>`;
    });
     gistHtml += `</tbody></table></div>`;

    gistHtml += `</div>`; // Close p-4
    gistPanel.innerHTML = gistHtml;

    // --- 2. Populate Feedback Loops Panel (Updated for detail) ---
    const loopsPanel = $("loopsPanel");
    let loopsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Identified Feedback Loops</h3><div class="space-y-6">`; // Increased spacing
    feedback_loops.forEach((loop) => {
        const isReinforcing = loop.type.toLowerCase() === "reinforcing";
        const loopIcon = isReinforcing ? "" : ""; // More distinct icons
        const loopColor = isReinforcing ? "border-green-400" : "border-yellow-400";
        loopsHtml += `
            <div class="bg-black/20 p-4 rounded-lg border-l-4 ${loopColor}">
                <h4 class="text-lg font-bold flex items-center gap-2">${loopIcon} ${loop.name} <span class="text-xs font-light text-white/60">(${loop.type})</span></h4>
                <p class="text-sm text-white/80 my-3 italic"><strong>Causal Chain:</strong> ${loop.description}</p>
                <div class="text-xs text-white/60"><strong>Key Elements Involved:</strong> ${loop.elements.join(", ")}</div>
            </div>`;
    });
    loopsHtml += `</div></div>`; // Close space-y-6 and p-4
    loopsPanel.innerHTML = loopsHtml;

    // --- 3. Populate Leverage Points Panel (Updated for detail) ---
    const leveragePanel = $("leveragePanel");
    let leverageHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> High-Impact Leverage Points</h3>`;
    if (leverage_points && leverage_points.length > 0) {
        leverageHtml += `<p class="text-sm text-white/70 mb-6 italic">Interventions at these points are likely to cause significant shifts in the system's behavior by influencing the core feedback loops.</p>`;
        leverageHtml += `<div class="space-y-6">`;
        leverage_points.forEach((point, index) => {
            leverageHtml += `
                <div class="prescription-card border-l-4 border-indigo-400">
                     <h4 class="text-xl font-bold">${index + 1}. ${point.point_name}</h4>
                     <p class="text-xs font-semibold my-1 text-indigo-300">TARGET ELEMENT: ${point.target_element || 'N/A'}</p>
                     <p class="rationale"><strong>Proposed Intervention:</strong> ${point.intervention || 'N/A'}</p>
                     <div class="p-3 bg-black/20 rounded mt-3 text-sm">
                         <p><strong>Expected Impact on Loops:</strong> ${point.expected_impact || 'N/A'}</p>
                     </div>
                </div>`;
        });
        leverageHtml += `</div>`;
    } else {
        leverageHtml += `<p class="text-center text-white/70 italic">No specific leverage points were clearly identified from the provided system description.</p>`;
    }
    leverageHtml += `</div>`; // Close p-4
    leveragePanel.innerHTML = leverageHtml;


    // --- 4. Populate Learn System Thinking Panel (New) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding System Thinking</h3>
         
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is System Thinking?</h4>
            <p class="text-sm text-white/80">System thinking is a holistic approach to analysis that focuses on how a system's constituent parts interrelate and how systems work over time and within the context of larger systems. It contrasts with traditional analysis, which studies systems by breaking them down into their separate elements.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Key Concepts:</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Interconnectedness:</strong> Elements within a system are interconnected; changing one part affects others.</li>
                    <li><strong>Feedback Loops:</strong> Circular causal relationships that amplify (reinforcing) or stabilize (balancing) change. </li>
                    <li><strong>Stocks & Flows:</strong> Stocks are accumulations (like water in a tub); Flows are the rates that change stocks (like the faucet and drain).</li>
                    <li><strong>Delays:</strong> Time lags between actions and their effects, often causing oscillations or overshoots.</li>
                    <li><strong>Non-linearity:</strong> Cause and effect are not always proportional; small changes can sometimes have large effects (leverage points).</li>
                    <li><strong>Emergence:</strong> System behavior arises from the interactions of its parts and cannot always be predicted by looking at the parts in isolation.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Why Use System Thinking?</h4>
                 <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>See the Bigger Picture:</strong> Understand context and connections.</li>
                    <li><strong>Identify Root Causes:</strong> Move beyond addressing symptoms to find underlying structural issues.</li>
                    <li><strong>Find High-Leverage Interventions:</strong> Identify points where small efforts yield significant results.</li>
                    <li><strong>Anticipate Unintended Consequences:</strong> Recognize how changes might ripple through the system.</li>
                    <li><strong>Understand Dynamic Behavior:</strong> Explain patterns of growth, decline, oscillation, or stability over time.</li>
                    <li><strong>Foster Collaboration:</strong> Provides a shared language to discuss complex problems.</li>
                 </ul>
            </div>
        </div>

         <details class="styled-details text-sm mt-4">
            <summary class="font-semibold">Common System Archetypes (Recurring Patterns)</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                <p><strong>Limits to Growth:</strong> Growth eventually slows or stops due to a limiting factor (a balancing loop).</p>
                <p><strong>Shifting the Burden:</strong> Using a short-term fix distracts from or undermines a fundamental long-term solution.</p>
                <p><strong>Fixes that Fail:</strong> A solution creates unintended consequences elsewhere that worsen the original problem later.</p>
                <p><strong>Tragedy of the Commons:</strong> Individuals overusing a shared resource deplete it for everyone.</p>
                <p><strong>Success to the Successful:</strong> Winners get more resources, enabling them to win even more, while losers fall further behind.</p>
                <p><strong>Escalation:</strong> Two parties react competitively, leading to an accelerating race none desires.</p>
                 <p class="text-xs italic mt-2">Recognizing these patterns helps diagnose systemic issues quickly.</p>
            </div>
        </details>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // No Plotly charts expected in this version, so no resize needed
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}



    async function handlePlsAnalysis_DA() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div></div><div></div><div></div> </div><h3 class="text-xl font-semibold text-white mb-4">Running Comprehensive PLS-SEM...</h3><p class="text-white/80 mb-2">Estimating paths, evaluating model fit, and generating insights...</p></div>`;
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    // *** CHOOSE MODEL: qwen or llama ***
    const MODEL_NAME = "qwen3:30b-a3b"; // Qwen might be better for structured analysis
    // const MODEL_NAME = "llama3.1:latest"; // Alternative

    try {
        // 1. Gather Inputs
        const measurementModel = $("plsMeasurementModel").value.trim();
        const structuralModel = $("plsStructuralModel").value.trim();
        const file = $("plsFile").files[0];

        if (!measurementModel || !structuralModel || !file) {
            throw new Error(" Please define the Measurement Model, Structural Model, and upload a CSV data file.");
        }

        const fileContent = await extractTextFromFile(file);

        // Truncate if necessary
        const MAX_DATA_LENGTH = 15000; // Keep reasonable for analysis
        let truncatedNote = "";
        let dataSnippet = fileContent;
        if (fileContent.length > MAX_DATA_LENGTH) {
            dataSnippet = fileContent.substring(0, MAX_DATA_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_DATA_LENGTH} characters of the data file.)`;
            console.warn(`PLS-SEM analysis data truncated.`);
        }

        // 2. Construct Enhanced Prompt
        const prompt = `
            You are an expert data scientist specializing in Partial Least Squares Structural Equation Modeling (PLS-SEM). Analyze the user's defined model and data snippet with high accuracy and provide detailed, actionable interpretations.

            **ANALYSIS INPUTS:**
            * **Measurement Model (Syntax):** \`${measurementModel}\`
            * **Structural Model (Syntax):** \`${structuralModel}\`
            * **Data Snippet:** ${truncatedNote}\n\`\`\`csv\n${dataSnippet}\n\`\`\`

            **DETAILED TASKS:**
            1.  **Model Evaluation (R-squared):** Calculate R-squared values for all endogenous (dependent) latent variables. For each:
                * Provide: Variable Name, R-squared Value.
                * **Interpretation:** Explain *precisely* what percentage of the variance in that variable is explained by its predictors within the model. Assess the explanatory power (e.g., >0.75 substantial, >0.5 moderate, >0.25 weak based on context, adjust if needed).

            2.  **Path Coefficients Analysis:** Estimate and analyze the structural paths. For *each* path:
                * Provide: Path (e.g., "ConstructA -> ConstructB"), Coefficient () value, T-Statistic, P-value.
                * **Interpretation:** Explain the practical meaning of the coefficient (e.g., "A one-unit increase in ConstructA is associated with a [] unit [increase/decrease] in ConstructB, holding other paths constant.").
                * **Significance:** State clearly whether the path is statistically significant (typically p < 0.05) and its implication (we are confident this relationship exists in the data).

            3.  **Reliability & Validity Assessment:** Calculate key metrics for *each* latent construct defined in the measurement model.
                * Provide: Construct Name, Cronbach's Alpha, Composite Reliability (CR), Average Variance Extracted (AVE).
                * **Assessment:** For each metric, state whether it meets common thresholds (Cronbach's Alpha > 0.7, CR > 0.7, AVE > 0.5) and interpret the result (e.g., "AVE of [value] indicates [good/poor] convergent validity, meaning the indicators measure the construct well/poorly.").

            4.  **Business Recommendations (3-4 recommendations):** Based *only* on the **significant path coefficients** and the likely business context implied by the construct names:
                * **\`recommendation\`:** A clear, actionable title.
                * **\`insight_link\`:** State which specific significant path(s) drive this recommendation.
                * **\`action_items\`:** List 2-3 concrete steps a business could take based on this finding.
                * **\`kpis_to_track\`:** List 2-3 KPIs to measure the success of the implemented action, related to the constructs involved.

            5.  **Self-Correction:** Before outputting JSON, meticulously check: Are R interpretations correct? Are path coefficient p-values interpreted correctly? Do reliability/validity assessments correctly compare against thresholds? Are recommendations directly linked ONLY to significant paths? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **DATA GROUNDING:** All results (coefficients, R, metrics) and interpretations MUST derive *solely* from the analysis of the provided data snippet and model structure. No fabrication.
            - **STATISTICAL ACCURACY:** Interpretations of R, p-values, and reliability/validity metrics must be statistically sound and use standard thresholds.
            - **ACTIONABILITY & LINKAGE:** Recommendations must be practical and clearly linked back to specific, significant path results.
            - **JSON FORMAT:** Adhere EXACTLY. Include all specified keys and sub-keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
            {
              "model_evaluation": { // R-squared results
                "r_squared_values": [ // Array for each endogenous variable
                  { "variable": "EndogenousVar1", "r_squared": 0.0 }
                ],
                "interpretation": "Overall interpretation of model's explanatory power..." // Generated
              },
              "path_coefficients": [ // Array for each structural path
                {
                  "path": "ConstructA -> ConstructB", "coefficient": 0.0, "t_statistic": 0.0, "p_value": 0.0,
                  "interpretation": "Practical meaning and significance...", "significant": true/false // Added boolean flag
                } // ... for all paths ...
              ],
              "reliability_validity": [ // Array for each construct
                {
                  "construct": "ConstructA", "cronbachs_alpha": 0.0, "composite_reliability": 0.0, "ave": 0.0,
                  "assessment": "Assessment vs. thresholds (e.g., Good internal consistency (Alpha > 0.7)... Convergent validity met (AVE > 0.5)..." // Generated assessment
                } // ... for all constructs ...
              ],
              // "visual_data" might be hard for LLM, can omit if unreliable, or simplify
              // "visual_data": { "nodes": [ { "id": "<construct_name>" } ] }, // Simplified - just node names
              "business_recommendations": [ // 3-4 recommendations
                {
                  "recommendation": "Action Title",
                  "insight_link": "Driven by significant path [Path Name]...",
                  "action_items": ["Step 1...", "Step 2..."],
                  "kpis_to_track": ["KPI related to ConstructA...", "KPI related to ConstructB..."]
                } // ...
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED PLS-SEM prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } }) // Increased context
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        try {
            parsedData = JSON.parse(data.response);
             // *** Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced PLS-SEM) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData ||
                 !parsedData.model_evaluation || typeof parsedData.model_evaluation !== 'object' || !parsedData.model_evaluation.hasOwnProperty('r_squared_values') || !Array.isArray(parsedData.model_evaluation.r_squared_values) ||
                 !parsedData.path_coefficients || !Array.isArray(parsedData.path_coefficients) || parsedData.path_coefficients.length === 0 ||
                 (parsedData.path_coefficients.length > 0 && (typeof parsedData.path_coefficients[0] !== 'object' || !parsedData.path_coefficients[0].hasOwnProperty('p_value'))) ||
                 !parsedData.reliability_validity || !Array.isArray(parsedData.reliability_validity) || parsedData.reliability_validity.length === 0 ||
                 (parsedData.reliability_validity.length > 0 && (typeof parsedData.reliability_validity[0] !== 'object' || !parsedData.reliability_validity[0].hasOwnProperty('cronbachs_alpha'))) ||
                 !parsedData.business_recommendations || !Array.isArray(parsedData.business_recommendations) || parsedData.business_recommendations.length < 2 || // Expect >= 2 recommendations
                 (parsedData.business_recommendations.length > 0 && (typeof parsedData.business_recommendations[0] !== 'object' || !parsedData.business_recommendations[0].hasOwnProperty('insight_link')))
                 // visual_data is optional
                )
             {
                  console.error("Validation Failed (PLS-SEM): Required fields missing or invalid structure/count.", parsedData);
                  throw new Error(`AI response structure is incorrect. Missing/invalid fields (model_evaluation, path_coefficients, reliability_validity, or business_recommendations [>=2]). Check console.`);
             }
             console.log(`Successfully parsed ENHANCED PLS-SEM JSON using ${MODEL_NAME}. Found ${parsedData.path_coefficients.length} paths, ${parsedData.reliability_validity.length} constructs, ${parsedData.business_recommendations.length} recommendations.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED PLS-SEM JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or required fields missing in AI response: ${e.message}. Check console logs.`);
        }

        // Add user inputs to parsedData for rendering the diagram accurately
        parsedData.userInput = { measurementModel, structuralModel };


        // 4. Render Results
        renderPlsPage_DA(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handlePlsAnalysis_DA (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderPlsPage_DA(container, data) {
    container.innerHTML = ""; // Clear loading

    // Basic Validation
    if (!data || !data.model_evaluation || !data.path_coefficients || !data.reliability_validity || !data.business_recommendations || !data.userInput) {
        console.error("Incomplete data passed to renderPlsPage_DA:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    const { model_evaluation, path_coefficients, reliability_validity, business_recommendations, userInput } = data;
    // Extract constructs from reliability data for diagram rendering
    const constructNames = reliability_validity.map(c => c.construct);


    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    // Added Learn PLS-SEM tab
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="diagram"> Path Model</button>
        <button class="analysis-tab-btn" data-tab="paths"> Path Analysis</button>
        <button class="analysis-tab-btn" data-tab="reliability"> Model Fit & Reliability</button>
        <button class="analysis-tab-btn" data-tab="rec"> Recommendations</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn PLS-SEM</button>
    `;
    container.appendChild(tabNav);

    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    // Added learnPanel
    tabContent.innerHTML = `
        <div id="diagramPanel" class="analysis-tab-panel active"></div>
        <div id="pathsPanel" class="analysis-tab-panel"></div>
        <div id="reliabilityPanel" class="analysis-tab-panel"></div>
        <div id="recPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Path Diagram Panel (Improved Rendering) ---
    const diagramPanel = $("diagramPanel");
    if (constructNames && constructNames.length > 0 && path_coefficients) {
        try {
            // Basic logic to determine exogenous/endogenous based on paths
            const sources = new Set(path_coefficients.map(p => p.path?.split(" -> ")[0]).filter(Boolean));
            const targets = new Set(path_coefficients.map(p => p.path?.split(" -> ")[1]).filter(Boolean));

            const exogenous = constructNames.filter(id => sources.has(id) && !targets.has(id));
            const endogenous = constructNames.filter(id => targets.has(id)); // Simplified: anything targeted is endogenous/mediating
             // Attempt to place mediators in the middle if possible
             const mediators = endogenous.filter(id => sources.has(id));
             const finalOutcomes = endogenous.filter(id => !sources.has(id));


            let diagramHtml = `<div class="path-flow-container">`;

             // Column 1: Exogenous
             diagramHtml += `<div class="path-column"><div class="path-column-title">Predictors (Exogenous)</div>`;
             if (exogenous.length > 0) {
                 diagramHtml += exogenous.map(id => `<div class="path-node-card"><h4>${id}</h4></div>`).join("");
             } else {
                 diagramHtml += `<p class="text-white/60 text-sm italic">(None identified)</p>`;
             }
             diagramHtml += `</div>`;


             // Column 2: Mediators (if any)
             if (mediators.length > 0) {
                 diagramHtml += `<div class="path-column"><div class="path-column-title">Mediators</div>`;
                 diagramHtml += mediators.map(id => {
                     const influences = path_coefficients.filter(p => p.path?.endsWith(` -> ${id}`));
                     return `<div class="path-node-card"><h4>${id}</h4><div class="path-influence-list text-xs">Influenced by:<br>${influences.map(inf => {
                         const isSig = inf.significant ?? ((inf.p_value ?? 1) < 0.05);
                         const coeff = (inf.coefficient ?? 0).toFixed(3);
                         return `<span class="path-influence ${isSig ? "significant" : ""}"><strong>${inf.path?.split(" -> ")[0] ?? "N/A"}</strong> (${coeff})${isSig ? "***" : ""}</span>`;
                     }).join("<br>")}</div></div>`;
                 }).join("");
                 diagramHtml += `</div>`;
             }

             // Column 3: Final Outcomes
             diagramHtml += `<div class="path-column"><div class="path-column-title">Outcomes (Endogenous)</div>`;
              if (finalOutcomes.length > 0) {
                 diagramHtml += finalOutcomes.map(id => {
                     const influences = path_coefficients.filter(p => p.path?.endsWith(` -> ${id}`));
                     return `<div class="path-node-card"><h4>${id}</h4><div class="path-influence-list text-xs">Influenced by:<br>${influences.map(inf => {
                         const isSig = inf.significant ?? ((inf.p_value ?? 1) < 0.05);
                         const coeff = (inf.coefficient ?? 0).toFixed(3);
                         return `<span class="path-influence ${isSig ? "significant" : ""}"><strong>${inf.path?.split(" -> ")[0] ?? "N/A"}</strong> (${coeff})${isSig ? "***" : ""}</span>`;
                     }).join("<br>")}</div></div>`;
                 }).join("");
              } else if (mediators.length === 0 && exogenous.length > 0) {
                 // If no mediators AND no final outcomes, show exogenous ones here again for simple models
                 diagramHtml += exogenous.map(id => {
                     const influences = path_coefficients.filter(p => p.path?.endsWith(` -> ${id}`));
                      if (influences.length > 0) { // Only show if it IS actually an outcome in a simple A->B model
                         return `<div class="path-node-card"><h4>${id}</h4><div class="path-influence-list text-xs">Influenced by:<br>${influences.map(inf => {
                             const isSig = inf.significant ?? ((inf.p_value ?? 1) < 0.05);
                             const coeff = (inf.coefficient ?? 0).toFixed(3);
                             return `<span class="path-influence ${isSig ? "significant" : ""}"><strong>${inf.path?.split(" -> ")[0] ?? "N/A"}</strong> (${coeff})${isSig ? "***" : ""}</span>`;
                         }).join("<br>")}</div></div>`;
                      }
                      return '';
                 }).join("");
             } else {
                 diagramHtml += `<p class="text-white/60 text-sm italic">(None identified as final outcomes)</p>`;
             }
            diagramHtml += `</div></div>`; // Close column and container
            diagramHtml += `<p class="text-xs text-white/60 text-center mt-4">*** Indicates statistical significance (p < 0.05)</p>`;
            diagramPanel.innerHTML = diagramHtml;

        } catch (e) {
            console.error("Error rendering PLS diagram:", e);
            diagramPanel.innerHTML = `<div class="p-4 text-center text-red-400">Path model could not be rendered due to an error.</div>`;
        }

    } else {
        diagramPanel.innerHTML = `<div class="p-4 text-center text-white/60">Path model data is insufficient for rendering.</div>`;
    }


    // --- 2. Populate Path Analysis Panel (Added significance boolean) ---
    const pathsPanel = $("pathsPanel");
    if (path_coefficients && path_coefficients.length > 0) {
        let pathsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Structural Model - Path Coefficients</h3><div class="overflow-x-auto"><table class="coeff-table styled-table text-sm"><thead><tr><th>Path</th><th>Coefficient ()</th><th>T-Statistic</th><th>P-value</th><th>Significant?</th></tr></thead><tbody>`;
        path_coefficients.forEach((p) => {
            // Use AI's significance flag if present, otherwise calculate
            const isSignificant = p.significant ?? ((p.p_value != null) && p.p_value < 0.05);
            pathsHtml += `
                <tr class="${isSignificant ? "text-green-300" : "text-white/70"}">
                    <td class="font-semibold">${p.path || "N/A"}</td>
                    <td>${(p.coefficient ?? 0).toFixed(3)}</td>
                    <td>${(p.t_statistic ?? 0).toFixed(2)}</td>
                    <td>${(p.p_value ?? 1).toFixed(3)}</td>
                    <td class="font-bold">${isSignificant ? "Yes***" : "No"}</td>
                </tr>`;
        });
        pathsHtml += `</tbody></table><p class="text-xs text-white/60 mt-2">*** Significant at p < 0.05</p></div><div class="mt-6 space-y-4">`;
        pathsHtml += `<h4 class="text-xl font-bold mb-2">Interpretation of Paths:</h4>`
        path_coefficients.forEach((p) => {
             const isSignificant = p.significant ?? ((p.p_value != null) && p.p_value < 0.05);
             const borderColor = isSignificant ? "border-green-400" : "border-gray-500";
            pathsHtml += `<div class="bg-white/5 p-3 rounded-lg border-l-4 ${borderColor}">
                            <p class="font-bold">${p.path || "N/A"}</p>
                            <p class="text-sm text-white/80 italic">${p.interpretation || "No interpretation provided."}</p>
                        </div>`;
        });
        pathsHtml += `</div></div>`;
        pathsPanel.innerHTML = pathsHtml;
    } else {
        pathsPanel.innerHTML = `<div class="p-4 text-center text-white/60">Path coefficient data is not available.</div>`;
    }

    // --- 3. Populate Reliability Panel (Added assessment text) ---
    const reliabilityPanel = $("reliabilityPanel");
    if (reliability_validity && reliability_validity.length > 0 && model_evaluation) {
        let reliabilityHtml = `<div class="p-4">
            <h3 class="text-2xl font-bold mb-4">Model Fit & Reliability Assessment</h3>
            <div class="bg-black/20 p-4 rounded-lg mb-6">
                <h4 class="text-lg font-bold mb-2 text-indigo-300">Overall Model Explanatory Power (R)</h4>`;
         if (model_evaluation.r_squared_values && model_evaluation.r_squared_values.length > 0) {
             model_evaluation.r_squared_values.forEach(rsq => {
                 reliabilityHtml += `<p class="text-sm text-white/80"><strong>${rsq.variable}:</strong> ${rsq.r_squared?.toFixed(3) ?? 'N/A'}</p>`;
             });
         } else {
             reliabilityHtml += `<p class="text-sm text-white/70 italic">R-squared values not available.</p>`;
         }
         reliabilityHtml += `<p class="text-sm text-white/80 italic mt-3">${model_evaluation.interpretation || "Overall interpretation unavailable."}</p>
            </div>

            <h4 class="text-xl font-bold mb-3">Construct Reliability & Validity Metrics</h4>
            <div class="overflow-x-auto">
                <table class="coeff-table styled-table text-sm">
                    <thead><tr>
                        <th>Construct</th>
                        <th title="Internal Consistency Reliability">Cronbach's Alpha (>0.7)</th>
                        <th title="Internal Consistency Reliability">Composite Reliability (CR >0.7)</th>
                        <th title="Convergent Validity">Avg. Variance Extracted (AVE >0.5)</th>
                    </tr></thead>
                    <tbody>`;
        reliability_validity.forEach((r) => {
             const alphaOk = (r.cronbachs_alpha ?? 0) >= 0.7;
             const crOk = (r.composite_reliability ?? 0) >= 0.7;
             const aveOk = (r.ave ?? 0) >= 0.5;
            reliabilityHtml += `
                <tr>
                    <td class="font-semibold">${r.construct || "N/A"}</td>
                    <td class="${alphaOk ? 'text-green-300' : 'text-red-300'}">${(r.cronbachs_alpha ?? 0).toFixed(3)} ${alphaOk ? '' : ''}</td>
                    <td class="${crOk ? 'text-green-300' : 'text-red-300'}">${(r.composite_reliability ?? 0).toFixed(3)} ${crOk ? '' : ''}</td>
                    <td class="${aveOk ? 'text-green-300' : 'text-red-300'}">${(r.ave ?? 0).toFixed(3)} ${aveOk ? '' : ''}</td>
                </tr>`;
        });
        reliabilityHtml += `</tbody></table>
            <p class="text-xs text-white/60 mt-2"> Meets common threshold,  Below common threshold.</p>
            </div>
            <div class="mt-6 space-y-4">`;
         reliabilityHtml += `<h4 class="text-xl font-bold mb-2">Assessment Details:</h4>`
         reliability_validity.forEach(r => {
             reliabilityHtml += `<div class="bg-white/5 p-3 rounded-lg border-l-4 ${ (r.cronbachs_alpha >= 0.7 && r.composite_reliability >= 0.7 && r.ave >= 0.5) ? 'border-green-400' : 'border-yellow-400' }">
                                     <p class="font-bold">${r.construct}</p>
                                     <p class="text-sm text-white/80 italic">${r.assessment || "Assessment not provided."}</p>
                                 </div>`;
         });
         reliabilityHtml += `</div></div>`;
        reliabilityPanel.innerHTML = reliabilityHtml;
    } else {
        reliabilityPanel.innerHTML = `<div class="p-4 text-center text-white/60">Model reliability and fit data is not available.</div>`;
    }

    // --- 4. Populate Recommendations Panel (Added insight link) ---
    const recPanel = $("recPanel");
    if (business_recommendations && business_recommendations.length > 0) {
        let recHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Actionable Recommendations</h3><div class="space-y-6">`;
        business_recommendations.forEach((rec, index) => {
            recHtml += `<div class="prescription-card">
                        <h4 class="text-xl font-bold">${index + 1}. ${rec.recommendation || "N/A"}</h4>
                        <p class="rationale"><strong>Driven By:</strong> ${rec.insight_link || "N/A"}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                            <div class="bg-black/20 p-3 rounded">
                                <h5 class="font-bold text-indigo-300 mb-2">Action Items</h5>
                                <ul class="list-disc list-inside space-y-1 text-white/90">${(rec.action_items || []).map(a => `<li>${a}</li>`).join("")}</ul>
                            </div>
                            <div class="bg-black/20 p-3 rounded">
                                <h5 class="font-bold text-indigo-300 mb-2">KPIs to Track</h5>
                                <p class="text-white/90 text-xs">${(rec.kpis_to_track || []).join(", ")}</p>
                            </div>
                        </div>
                    </div>`;
        });
        recHtml += `</div></div>`;
        recPanel.innerHTML = recHtml;
    } else {
        recPanel.innerHTML = `<div class="p-4 text-center text-white/60 italic">No specific business recommendations generated based on the significant paths.</div>`;
    }

    // --- 5. Populate Learn PLS-SEM Tab ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding PLS-SEM</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is PLS-SEM?</h4>
            <p class="text-sm text-white/80">Partial Least Squares Structural Equation Modeling (PLS-SEM) is a statistical method used to analyze complex relationships between observed (indicator) and unobserved (latent) variables.</p>
            <p class="text-sm text-white/80 mt-2">It's particularly useful for:</p>
            <ul class="list-disc list-inside space-y-1 text-sm text-white/80 mt-1 pl-4">
                <li><strong>Prediction-oriented research:</strong> When the goal is to predict key target constructs.</li>
                <li><strong>Complex models:</strong> Handling many constructs and indicators.</li>
                <li><strong>Non-normal data:</strong> It doesn't require data to be normally distributed like traditional SEM (CB-SEM).</li>
                <li><strong>Smaller sample sizes:</strong> Can often work with smaller datasets than CB-SEM.</li>
                <li><strong>Formative constructs:</strong> When indicators are assumed to *cause* the latent variable (less common, but PLS handles it).</li>
            </ul>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Key Components:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Measurement Model:</strong> Links latent variables (constructs) to their observable indicators (like survey items). Assesses reliability and validity.</li>
                    <li><strong>Structural Model:</strong> Defines the hypothesized relationships (paths) *between* the latent variables.</li>
                    <li><strong>Latent Variables:</strong> Unobserved concepts (e.g., Brand Image, Loyalty).</li>
                    <li><strong>Indicators:</strong> Observed variables that measure the latent concepts.</li>
                    <li><strong>Path Coefficients ():</strong> Strength and direction of relationships between latent variables.</li>
                    <li><strong>R-squared (R):</strong> Percentage of variance in an endogenous (dependent) construct explained by its predictors.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Interpreting Key Metrics:</h4>
                 <p class="text-sm mb-2"><strong>Reliability & Validity:</strong></p>
                 <ul class="list-[circle] list-inside pl-4 text-xs mb-3">
                    <li><strong>Cronbach's Alpha / CR (>0.7):</strong> Internal consistency - do indicators for a construct measure the *same* thing reliably?</li>
                    <li><strong>AVE (>0.5):</strong> Convergent validity - does the construct explain more than half the variance of its indicators?</li>
                    <li><em>(Discriminant Validity - Not shown here, checks if constructs are distinct. Often HTMT < 0.9)</em></li>
                 </ul>
                 <p class="text-sm mb-2"><strong>Structural Model:</strong></p>
                  <ul class="list-[circle] list-inside pl-4 text-xs mb-3">
                    <li><strong>Path Coefficients ():</strong> Size indicates strength. Sign indicates direction (+/-).</li>
                    <li><strong>P-values (<0.05):</strong> Indicates statistical significance of the path (relationship likely exists).</li>
                    <li><strong>R-squared:</strong> Explanatory power for dependent constructs (e.g., 0.6 means 60% explained).</li>
                 </ul>
            </div>
        </div>

        <details class="styled-details text-sm">
            <summary class="font-semibold">PLS-SEM vs. CB-SEM (Traditional SEM)</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-3">
                <p><strong>PLS-SEM:</strong> Variance-based, prediction-focused, fewer assumptions (good for exploration, non-normal data, complex models).</p>
                <p><strong>CB-SEM (e.g., LISREL, AMOS):</strong> Covariance-based, theory-testing focused, requires normal data and larger samples (good for confirming established theories).</p>
                <p>Choose PLS-SEM when your primary goal is prediction, your theory is less developed, or your data doesn't meet CB-SEM assumptions.</p>
            </div>
        </details>
    </div>
    `;

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // No charts to resize in this specific PLS render function currently
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}


    function renderDescriptivePage_DA(container, data) {
        container.innerHTML = ""; // Clear loading state
        const { summary, numerical_summary, categorical_summary, visualizations, business_insights } = data;

        // Basic validation
        if (!summary || !numerical_summary || !categorical_summary || !visualizations || !business_insights ) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Incomplete or invalid analysis data received. Cannot render Descriptive Analysis.</div>`;
            $("analysisActions").classList.add("hidden");
            setLoading("generate", false);
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Standard tabs
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="summary"> Summary</button>
            <button class="analysis-tab-btn" data-tab="stats"> Statistics</button>
            <button class="analysis-tab-btn" data-tab="visuals"> Visualizations</button>
            <button class="analysis-tab-btn" data-tab="insights"> Insights</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Stats</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="summaryPanel" class="analysis-tab-panel active"></div>
            <div id="statsPanel" class="analysis-tab-panel"></div>
            <div id="visualsPanel" class="analysis-tab-panel"></div>
            <div id="insightsPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Summary Panel ---
        const summaryPanel = $("summaryPanel");
         const fileName = $("descriptiveFile")?.files[0]?.name || "N/A"; // Get filename if available
        summaryPanel.innerHTML = `<div class="p-4">
            <h3 class="text-2xl font-bold mb-6 text-center">Dataset Overview</h3>
             <p class="text-sm text-center text-white/70 mb-6">Analysis based on file: ${fileName}</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-4xl mx-auto mb-8">
                <div class="summary-stat-card"><div class="stat-value">${summary.rows}</div><div class="stat-label">Rows (Records)</div></div>
                <div class="summary-stat-card"><div class="stat-value">${summary.columns}</div><div class="stat-label">Columns (Variables)</div></div>
                <div class="summary-stat-card"><div class="stat-value">${summary.numerical_vars}</div><div class="stat-label">Numerical Variables</div></div>
                <div class="summary-stat-card"><div class="stat-value">${summary.categorical_vars}</div><div class="stat-label">Categorical Variables</div></div>
            </div>
            <blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 max-w-4xl mx-auto">${summary.interpretation}</blockquote>
        </div>`;

        // --- 2. Populate Statistics Panel ---
        const statsPanel = $("statsPanel");
        let statsHtml = `<div class="p-4 space-y-8">`;
        // Numerical Stats Table
        if (numerical_summary.length > 0) {
            statsHtml += `<h3 class="text-2xl font-bold mb-4">Numerical Variable Summary</h3>
                        <p class="text-sm text-white/70 mb-4">Central tendency, dispersion, and range for numerical columns.</p>
                        <div class="overflow-x-auto">
                            <table class="coeff-table styled-table text-sm"> 
                                <thead><tr>
                                    <th>Variable</th><th>Count</th>
                                    <th title="Average value">Mean</th>
                                    <th title="Middle value when sorted">Median</th>
                                    <th title="Typical spread around the mean">Std. Dev.</th>
                                    <th title="Minimum value">Min</th>
                                    <th title="Maximum value">Max</th>
                                    <th title="25th percentile">Q1</th>
                                    <th title="75th percentile">Q3</th>
                                    <th title="Range of middle 50% (Q3-Q1)">IQR</th>
                                </tr></thead>
                                <tbody>`;
            numerical_summary.forEach((n) => {
                 const formatNum = (num) => num !== undefined && num !== null ? num.toLocaleString(undefined, { maximumFractionDigits: 2 }) : 'N/A';
                statsHtml += `<tr>
                                <td class="font-semibold">${n.variable}</td><td>${n.count}</td>
                                <td>${formatNum(n.mean)}</td><td>${formatNum(n.median)}</td><td>${formatNum(n.std_dev)}</td>
                                <td>${formatNum(n.min)}</td><td>${formatNum(n.max)}</td>
                                <td>${formatNum(n.q1)}</td><td>${formatNum(n.q3)}</td><td>${formatNum(n.iqr)}</td>
                              </tr>`;
            });
            statsHtml += `</tbody></table></div>`;
        }
        // Categorical Stats Tables
        if (categorical_summary.length > 0) {
             statsHtml += `<h3 class="text-2xl font-bold mt-8 mb-4">Categorical Variable Summary</h3>
                           <p class="text-sm text-white/70 mb-4">Counts, unique values, and most frequent categories for non-numerical columns.</p>`;
             categorical_summary.forEach((c) => {
                statsHtml += `<div class="mb-6 bg-white/5 p-4 rounded-lg border border-white/10">
                                <h4 class="text-lg font-semibold mb-2">${c.variable}</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm mb-3">
                                    <p title="Number of non-empty entries"><strong>Count:</strong> ${c.count}</p>
                                    <p title="Number of distinct categories"><strong>Unique Values:</strong> ${c.unique_categories}</p>
                                    <p title="Most frequent category"><strong>Mode:</strong> ${c.mode}</p>
                                </div>
                                <details class="text-xs">
                                    <summary class="cursor-pointer text-indigo-300 hover:text-white">View Frequencies (${c.frequencies.length} categories)</summary>
                                    <div class="overflow-x-auto max-h-48 overflow-y-auto mt-2 styled-table">
                                        <table class="w-full text-xs">
                                            <thead><tr><th>Category</th><th>Count</th><th>Percentage</th></tr></thead>
                                            <tbody>`;
                const MAX_FREQ_DISPLAY = 20;
                let otherCount = 0;
                let otherPct = 0;
                c.frequencies.forEach((f, index) => {
                     if (index < MAX_FREQ_DISPLAY) {
                        statsHtml += `<tr><td>${f.category}</td><td>${f.count}</td><td>${f.percentage.toFixed(1)}%</td></tr>`;
                     } else {
                         otherCount += f.count;
                         otherPct += f.percentage;
                     }
                });
                 if (otherCount > 0) {
                     statsHtml += `<tr class="font-semibold bg-black/20"><td class="italic">Other (${c.frequencies.length - MAX_FREQ_DISPLAY})</td><td>${otherCount}</td><td>${otherPct.toFixed(1)}%</td></tr>`;
                 }
                statsHtml += `</tbody></table></div></details></div>`;
            });
        }
        statsHtml += `</div>`;
        statsPanel.innerHTML = statsHtml;


        // --- 3. Populate Visualizations Panel ---
        const visualsPanel = $("visualsPanel");
        let visualsHtml = `<div class="p-4 space-y-8">
                            <h3 class="text-2xl font-bold mb-4 text-center">Data Distributions & Frequencies</h3>`;
        if (visualizations.length > 0) {
            visualsHtml += `<div class="flex flex-wrap justify-center gap-8">`;
            visualizations.forEach((viz, index) => {
                visualsHtml += `<div class="w-full lg:w-[48%] bg-black/10 rounded-lg p-2 shadow-lg"> 
                                <div id="viz-chart-${index}" class="w-full h-[500px] plotly-chart"></div>
                                <p id="viz-interp-${index}" class="text-xs text-center text-white/70 italic mt-2 p-1"></p>
                             </div>`;
            });
            visualsHtml += `</div>`;
        } else {
             visualsHtml += `<p class="text-center text-white/70">No visualizations could be generated for this data.</p>`;
        }
        visualsHtml += `</div>`;
        visualsPanel.innerHTML = visualsHtml;

        // Render the Plotly charts and add simple interpretations
        visualizations.forEach((viz, index) => {
            const chartContainer = $(`viz-chart-${index}`);
            const interpContainer = $(`viz-interp-${index}`);
            if (!chartContainer || !interpContainer) return;

            let trace, layout, simpleInterp = "";
            try {
                if (viz.chart_type === "histogram" && viz.data.length > 0) {
                     trace = { x: viz.data, type: "histogram", marker: { color: "var(--primary)", line:{color:'rgba(255,255,255,0.3)', width:0.5} } };
                     layout = {
                        title: viz.title, paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)",
                        font: { color: "white" }, xaxis: { title: viz.variable, gridcolor: "rgba(255,255,255,0.1)" }, yaxis: { title: "Frequency", gridcolor: "rgba(255,255,255,0.1)" },
                        bargap: 0.05, margin: { t: 50, b: 50, l: 50, r: 20 }
                     };
                     Plotly.newPlot(chartContainer, [trace], layout, { responsive: true });
                     const stats = numerical_summary.find(s => s.variable === viz.variable);
                     if (stats) {
                         const skew = Math.abs(stats.mean - stats.median) / stats.std_dev > 0.3 ? (stats.mean > stats.median ? 'right-skewed' : 'left-skewed') : 'roughly symmetric';
                         simpleInterp = `Shows distribution of ${viz.variable}. Appears ${skew}. Mean: ${stats.mean.toFixed(2)}, Median: ${stats.median.toFixed(2)}.`;
                     }
                } else if (viz.chart_type === "bar" && Object.keys(viz.data).length > 0) {
                     trace = { x: Object.keys(viz.data), y: Object.values(viz.data), type: "bar", marker: { color: "var(--primary)" } };
                     layout = {
                        title: viz.title, paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)",
                        font: { color: "white" }, xaxis: { title: viz.variable, automargin: true, tickangle: -30, gridcolor: "rgba(255,255,255,0.1)" }, yaxis: { title: "Count", gridcolor: "rgba(255,255,255,0.1)" },
                         margin: { t: 50, b: 80, l: 50, r: 20 }
                     };
                     Plotly.newPlot(chartContainer, [trace], layout, { responsive: true });
                     const stats = categorical_summary.find(s => s.variable === viz.variable);
                     if (stats) {
                         simpleInterp = `Shows counts for ${viz.variable}. Most frequent: '${stats.mode}' (${stats.unique_categories} unique values).`;
                     }
                } else {
                     throw new Error("Invalid chart type or no data");
                }
                 interpContainer.textContent = simpleInterp;
            } catch (chartError) {
                 console.error(`Error rendering chart ${index}:`, chartError);
                 chartContainer.innerHTML = `<div class="p-4 text-center text-red-400">Could not render chart for ${viz.variable}.</div>`;
                 interpContainer.textContent = "";
            }
        });


        // --- 4. Populate Insights Panel ---
        const insightsPanel = $("insightsPanel");
        let insightsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Actionable Business Insights</h3>`;
         let insightsAvailable = false;
         if (business_insights && business_insights.length > 0) {
             const firstInsight = business_insights[0];
             if (typeof firstInsight === 'object' && firstInsight.observation !== "Error") {
                  insightsAvailable = true;
             } else if (typeof firstInsight === 'string' && !firstInsight.toLowerCase().includes("could not")) {
                  // Handle case where AI might still return strings
                  insightsAvailable = true;
                  console.warn("Insights received as strings, expected objects.");
             }
         }

        if (insightsAvailable) {
            insightsHtml += `<div class="space-y-6">`;
            business_insights.forEach((insight, index) => {
                 // Check if insight is an object with the expected structure
                 if (typeof insight === 'object' && insight.observation) {
                     insightsHtml += `<div class="insight-card border-l-4 border-indigo-400">
                                     <p class="text-xs font-semibold text-indigo-300 mb-1">INSIGHT ${index + 1}</p>
                                     <p class="mb-2"><strong>Statistical Observation:</strong> ${insight.observation}</p>
                                     <p class="mb-2 text-sm text-white/80"><strong>Interpretation:</strong> ${insight.interpretation}</p>
                                     <div class="p-3 bg-black/20 rounded mt-3">
                                         <p class="text-sm"><strong>Business Implication / Recommendation:</strong> ${insight.business_implication}</p>
                                     </div>
                                  </div>`;
                 } else {
                     // Fallback for simple string insights
                     insightsHtml += `<div class="insight-card border-l-4 border-gray-500"><p>${String(insight)}</p></div>`;
                 }
            });
            insightsHtml += `</div>`;
         } else {
             insightsHtml += `<p class="text-center text-white/70 italic">No specific business insights were generated or an error occurred. Review the statistical summaries and visualizations manually in the context of your business goals.</p>`;
         }
        insightsHtml += `</div>`;
        insightsPanel.innerHTML = insightsHtml;

        // --- 5. Populate Learn Stats Panel ---
        const learnPanel = $("learnPanel");
         // Reuse the learn panel content
         learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding Descriptive Statistics</h3>
                 <p class="italic text-center">Descriptive statistics summarize the main features of a dataset, providing a quantitative overview without making inferences beyond the data itself.</p>
                 

[Image of Normal distribution bell curve]

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                        <h4 class="text-xl font-bold text-blue-300 mb-2"> Numerical Data Measures</h4>
                        <ul class="list-disc list-inside space-y-2 text-sm">
                            <li><strong>Mean:</strong> The average value (sum / count). Sensitive to outliers.</li>
                            <li><strong>Median:</strong> The middle value when data is sorted. Robust to outliers.</li>
                            <li><strong>Standard Deviation (Std Dev):</strong> Measures the typical spread or dispersion around the mean. Higher value = more spread.</li>
                            <li><strong>Min/Max:</strong> Smallest/Largest values, defining the range.</li>
                            <li><strong>Quartiles (Q1, Q3):</strong> Values dividing sorted data into quarters (25th, 75th percentiles).</li>
                            <li><strong>IQR (Interquartile Range):</strong> Q3 - Q1. Range of the middle 50% of data, robust to outliers.</li>
                            <li><strong>Histogram (Chart):</strong> Visualizes frequency distribution in bins. Shows shape (normal, skewed), center, spread.</li>
                        </ul>
                    </div>
                    <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/50">
                        <h4 class="text-xl font-bold text-green-300 mb-2"> Categorical Data Measures</h4>
                        <ul class="list-disc list-inside space-y-2 text-sm">
                            <li><strong>Frequency (Count):</strong> Number of times each category appears.</li>
                            <li><strong>Percentage (%):</strong> Proportion of each category relative to total.</li>
                            <li><strong>Mode:</strong> The most frequently occurring category.</li>
                            <li><strong>Unique Categories:</strong> Number of distinct categories.</li>
                            <li><strong>Bar Chart (Chart):</strong> Visualizes frequency/percentage per category. Good for comparisons.</li>
                        </ul>
                    </div>
                </div>
                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">Why Use Descriptive Statistics?</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Understand Data:** Get a quick overview of characteristics.</li>
                        <li><strong>Identify Patterns:** Spot trends, common values, outliers.</li>
                        <li><strong>Data Cleaning:** Help identify potential errors (e.g., impossible values).</li>
                        <li><strong>Communication:** Clearly summarize large datasets.</li>
                        <li><strong>Foundation:** Basis for advanced analysis (inferential stats, modeling).</li>
                    </ul>
                 </div>
                 <details class="styled-details mt-6 text-sm">
                     <summary class="font-semibold">Advanced Concepts</summary>
                     <div class="bg-black/20 p-4 rounded-b-lg space-y-3">
                         <p><strong>Skewness:</strong> Measures asymmetry. Mean > Median often means right-skewed (tail to the right). Mean < Median often means left-skewed.</p>
                         <p><strong>Kurtosis:</strong> Measures "tailedness" or peakedness compared to a normal distribution.</p>
                         <p><strong>Coefficient of Variation (CV):</strong> (Std Dev / Mean) * 100%. Relative measure of dispersion, useful for comparing variability between datasets with different means.</p>
                     </div>
                 </details>
            </div>
        `;


        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic (ensure resizing happens)
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                     chartsInPanel.forEach(chartDiv => {
                          if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                              try {
                                  Plotly.Plots.resize(chartDiv);
                              } catch (resizeError) {
                                   console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                              }
                          }
                     });
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        // Initial resize for charts in the default active tab
        setTimeout(() => {
             const activePanel = tabContent.querySelector('.analysis-tab-panel.active');
             if (activePanel) {
                 activePanel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                     if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                         try {
                              Plotly.Plots.resize(chartDiv);
                         } catch (initialResizeError) {
                              console.error(`Error during initial resize ${chartDiv.id}:`, initialResizeError);
                         }
                     }
                 });
             }
        }, 150);

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator AFTER rendering
    }

    async function handlePrescriptiveAnalysis_DA() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div></div><div></div><div></div></div><h3 class="text-xl font-semibold text-white">Running Enhanced Prescriptive Analysis...</h3><p class="text-white/80 mb-2">Linking data insights directly to actionable recommendations...</p></div>`;
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    // *** CHOOSE MODEL: qwen or llama ***
    const MODEL_NAME = "qwen3:30b-a3b"; // Use Qwen for potentially better numerical accuracy
    // const MODEL_NAME = "llama3.1:latest"; // Alternative option

    try {
        // 1. Gather Inputs
        const businessGoal = $("prescriptiveGoal").value.trim();
        const file = $("prescriptiveFile").files[0];

        if (!businessGoal || !file) {
            throw new Error(" Please describe your business goal and upload a CSV data file.");
        }

        const fileContent = await extractTextFromFile(file);

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000; // Adjust as needed
        let truncatedNote = "";
        let dataSnippet = fileContent;
        if (fileContent.length > MAX_CONTEXT_LENGTH) {
            dataSnippet = fileContent.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters of data.)`;
            console.warn(`Prescriptive analysis data truncated.`);
        }

        // 2. Construct Enhanced Prompt
        const prompt = `
            You are a highly skilled prescriptive analytics consultant. Your task is to analyze the user's business goal and the provided dataset to recommend specific, data-driven actions. Precision, data grounding, and actionable insights are critical.

            **ANALYSIS INPUTS:**
            * **Business Goal:** "${businessGoal}"
            * **Data Snippet:** ${truncatedNote}\n\`\`\`csv\n${dataSnippet}\n\`\`\`

            **DETAILED TASKS:**
            1.  **Identify Key Data Insights (3-5 insights):** Analyze the data snippet *first* to find patterns, correlations, or segments directly relevant to achieving the stated business goal. For each insight:
                * **\`insight\`:** State the specific, quantifiable finding from the data (e.g., "Customers in 'Region X' have a 30% higher Average Order Value").
                * **\`implication\`:** Explain *why* this insight is important for achieving the business goal (e.g., "Targeting Region X could significantly boost overall revenue per customer").

            2.  **Develop Prescriptions (3-4 prescriptions):** Based *only* on the identified data insights and the business goal, formulate specific, actionable recommendations. For each prescription:
                * **\`recommendation\`:** A clear, concise action title (e.g., "Launch Targeted Campaign for Region X").
                * **\`rationale\`:** Explain *exactly how* this action leverages a specific data insight (reference the insight) to help achieve the business goal.
                * **\`impact\`:** Estimate the potential impact on the goal ("High", "Medium", "Low").
                * **\`effort\`:** Estimate the implementation effort ("High", "Medium", "Low").
                * **\`action_items\`:** List 2-3 concrete, specific first steps to implement the recommendation.
                * **\`expected_outcome\`:** State a specific, measurable outcome linked to the business goal (e.g., "Increase AOV in Region X by 15% within 6 months").
                * **\`kpis_to_track\`:** List 2-3 specific KPIs to measure the success of *this particular* prescription.

            3.  **Self-Correction:** Before outputting JSON, review: Are insights directly from the data snippet? Do prescriptions logically follow ONLY from insights and the goal? Are outcomes measurable? Are all constraints met? Fix any inconsistencies.

            **ABSOLUTE CONSTRAINTS:**
            - **DATA GROUNDING:** Insights and prescriptions MUST derive *solely* from the provided data snippet and business goal. No external knowledge or assumptions.
            - **LINKAGE:** Clearly link each prescription's rationale back to a specific data insight identified in step 1.
            - **ACTIONABILITY:** Recommendations and action items must be specific and practical.
            - **MEASURABILITY:** Expected outcomes and KPIs must be quantifiable.
            - **JSON FORMAT:** Adhere EXACTLY. Include all specified keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys: "main_goal", "data_insights", AND "prescriptions".** "data_insights" must contain 3-5 objects, and "prescriptions" must contain 3-4 objects, each with ALL specified sub-keys.
            {
              "main_goal": "${businessGoal}",
              "data_insights": [ // 3-5 insight objects
                {
                  "insight": "Specific finding from data...",
                  "implication": "Why this matters for the goal..."
                } // ...
              ],
              "prescriptions": [ // 3-4 prescription objects
                {
                  "recommendation": "Action Title",
                  "rationale": "Links insight X to goal Y...",
                  "impact": "High/Medium/Low",
                  "effort": "High/Medium/Low",
                  "action_items": ["Step 1...", "Step 2..."],
                  "expected_outcome": "Measurable outcome...",
                  "kpis_to_track": ["KPI 1...", "KPI 2..."]
                } // ...
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED Prescriptive Analysis prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        try {
            parsedData = JSON.parse(data.response);
             // *** Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Prescriptive) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData ||
                 !parsedData.main_goal || typeof parsedData.main_goal !== 'string' ||
                 !parsedData.data_insights || !Array.isArray(parsedData.data_insights) || parsedData.data_insights.length < 2 || // Expect at least 2 insights
                 (parsedData.data_insights.length > 0 && (
                     typeof parsedData.data_insights[0] !== 'object' ||
                     !parsedData.data_insights[0].hasOwnProperty('insight') ||
                     !parsedData.data_insights[0].hasOwnProperty('implication')
                 )) ||
                 !parsedData.prescriptions || !Array.isArray(parsedData.prescriptions) || parsedData.prescriptions.length < 2 || // Expect at least 2 prescriptions
                 (parsedData.prescriptions.length > 0 && (
                     typeof parsedData.prescriptions[0] !== 'object' ||
                     !parsedData.prescriptions[0].hasOwnProperty('recommendation') ||
                     !parsedData.prescriptions[0].hasOwnProperty('rationale') ||
                     !parsedData.prescriptions[0].hasOwnProperty('impact') ||
                     !parsedData.prescriptions[0].hasOwnProperty('effort') ||
                     !parsedData.prescriptions[0].hasOwnProperty('action_items') || !Array.isArray(parsedData.prescriptions[0].action_items) ||
                     !parsedData.prescriptions[0].hasOwnProperty('expected_outcome') ||
                     !parsedData.prescriptions[0].hasOwnProperty('kpis_to_track') || !Array.isArray(parsedData.prescriptions[0].kpis_to_track)
                 ))
                )
             {
                  console.error("Validation Failed (Prescriptive): Required fields missing or invalid structure/count.", parsedData);
                  throw new Error(`AI response structure is incorrect. Missing/invalid fields (main_goal, data_insights [>=2], prescriptions [>=2] with all sub-keys). Check console.`);
             }
             console.log(`Successfully parsed ENHANCED Prescriptive Analysis JSON using ${MODEL_NAME}. Found ${parsedData.data_insights.length} insights, ${parsedData.prescriptions.length} prescriptions.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED Prescriptive Analysis JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or required fields missing in AI response: ${e.message}. Check console logs.`);
        }

        // 4. Render Results
        renderPrescriptivePage_DA(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handlePrescriptiveAnalysis_DA (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderPrescriptivePage_DA(container, data) {
    container.innerHTML = ""; // Clear loading state

     // Basic validation
    if (!data || !data.main_goal || !data.data_insights || !data.prescriptions || !Array.isArray(data.data_insights) || !Array.isArray(data.prescriptions)) {
         console.error("Incomplete data passed to renderPrescriptivePage_DA:", data);
         container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render results.</div>`;
         $("analysisActions").classList.add("hidden");
         return;
     }

    const { main_goal, data_insights, prescriptions } = data;


    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    // Added "Learn Prescriptive" tab
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="prescriptions"> Prescriptions</button>
        <button class="analysis-tab-btn" data-tab="insights"> Data Insights</button>
        <button class="analysis-tab-btn" data-tab="matrix"> Prioritization Matrix</button>
        <button class="analysis-tab-btn" data-tab="kpis"> KPI Tracker</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Prescriptive</button>
    `;
    container.appendChild(tabNav);

    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    // Added panel for "Learn Prescriptive"
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="prescriptionsPanel" class="analysis-tab-panel"></div>
        <div id="insightsPanel" class="analysis-tab-panel"></div>
        <div id="matrixPanel" class="analysis-tab-panel"></div>
        <div id="kpisPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Dashboard Panel (No major changes needed, uses existing fields) ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4">
                <div class="p-6 rounded-lg bg-white/10 border border-white/20 text-center mb-8">
                    <h3 class="text-xl font-bold mb-2 text-indigo-300"> Business Goal</h3>
                    <p class="text-2xl italic text-white/90">${main_goal}</p>
                </div>
                <h3 class="text-2xl font-bold text-center mb-4">Recommended Prescriptions</h3>`;
     if (prescriptions.length > 0) {
          dashboardHtml += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-${Math.min(prescriptions.length, 4)} gap-6">`; // Adjust columns based on number
         prescriptions.forEach((p) => {
             dashboardHtml += `<div class="dashboard-prescription-card">
                         <h4 class="text-xl font-bold mb-2">${p.recommendation ?? 'N/A'}</h4>
                         <p class="text-sm text-white/70 mb-4"><strong>Impact:</strong> ${p.impact ?? '?'} | <strong>Effort:</strong> ${p.effort ?? '?'}</p>
                         <p class="font-semibold text-indigo-300 text-sm mt-auto">${p.expected_outcome ?? 'Outcome not specified.'}</p>
                     </div>`;
         });
         dashboardHtml += `</div>`;
     } else {
         dashboardHtml += `<p class="text-center text-white/70 italic">No prescriptions generated.</p>`;
     }
     dashboardHtml += `</div>`;
    dashboardPanel.innerHTML = dashboardHtml;

    // --- 2. Populate Prescriptions Panel (Uses new detailed fields) ---
    const prescriptionsPanel = $("prescriptionsPanel");
    let prescriptionsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Detailed Prescriptions</h3>`;
     if (prescriptions.length > 0) {
         prescriptionsHtml += `<div class="space-y-6">`;
         prescriptions.forEach((p, index) => {
             prescriptionsHtml += `<div class="prescription-card">
                         <h4 class="text-xl font-bold">${index + 1}. ${p.recommendation ?? 'N/A'}</h4>
                         <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${p.impact ?? '?'} | <span class="text-blue-300">Effort:</span> ${p.effort ?? '?'}</p>
                         <p class="rationale"><strong>Rationale (Linked to Data):</strong> ${p.rationale ?? 'N/A'}</p>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                             <div class="bg-black/20 p-3 rounded">
                                 <h5 class="font-bold text-indigo-300 mb-2">Action Items</h5>
                                 <ul class="list-disc list-inside space-y-1 text-white/90">${(p.action_items || []).map(a => `<li>${a}</li>`).join("")}</ul>
                                 ${!(p.action_items && p.action_items.length > 0) ? '<p class="text-white/60 italic text-xs">No specific action items defined.</p>' : ''}
                             </div>
                             <div class="bg-black/20 p-3 rounded">
                                 <h5 class="font-bold text-indigo-300 mb-2">Expected Outcome</h5>
                                 <p class="text-white/90">${p.expected_outcome ?? 'N/A'}</p>
                                 <h5 class="font-bold text-indigo-300 mt-3 mb-2">KPIs to Track</h5>
                                 <p class="text-white/90 text-xs">${(p.kpis_to_track || []).join(", ")}</p>
                                 ${!(p.kpis_to_track && p.kpis_to_track.length > 0) ? '<p class="text-white/60 italic text-xs">No specific KPIs defined.</p>' : ''}
                             </div>
                         </div>
                     </div>`;
         });
         prescriptionsHtml += `</div>`;
     } else {
         prescriptionsHtml += `<p class="text-center text-white/70 italic">No prescriptions generated.</p>`;
     }
     prescriptionsHtml += `</div>`;
    prescriptionsPanel.innerHTML = prescriptionsHtml;


    // --- 3. Populate Insights Panel (Uses new structure) ---
    const insightsPanel = $("insightsPanel");
    let insightsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Key Data Insights Driving Prescriptions</h3>`;
     if (data_insights.length > 0) {
         insightsHtml += `<div class="space-y-6">`;
         data_insights.forEach((i, index) => {
             insightsHtml += `<div class="insight-card border-l-4 border-yellow-400">
                         <p class="text-xs font-semibold text-yellow-300 mb-1">INSIGHT ${index + 1}</p>
                         <p class="text-white/90 mb-3">"${i.insight ?? 'N/A'}"</p>
                         <h4 class="text-sm font-bold text-indigo-300">Business Implication:</h4>
                         <p class="text-white/80 text-sm">${i.implication ?? 'N/A'}</p>
                     </div>`;
         });
         insightsHtml += `</div>`;
     } else {
         insightsHtml += `<p class="text-center text-white/70 italic">No specific data insights were generated.</p>`;
     }
     insightsHtml += `</div>`;
    insightsPanel.innerHTML = insightsHtml;


    // --- 4. Populate Prioritization Matrix Panel (Plotly chart, no changes needed if structure is same) ---
    const matrixPanel = $("matrixPanel");
    matrixPanel.innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> Prescription Prioritization Matrix</h3><div id="matrixPlot" class="w-full h-[600px] plotly-chart"></div></div>`;
     if (prescriptions.length > 0) {
         try {
             const impactMap = { Low: 1, Medium: 2, High: 3 };
             const effortMap = { Low: 1, Medium: 2, High: 3 };
             // Add jitter
             const addJitter = (val) => val + (Math.random() - 0.5) * 0.2;

             const matrixData = {
                 x: prescriptions.map(p => addJitter(effortMap[p.effort] || 1)),
                 y: prescriptions.map(p => addJitter(impactMap[p.impact] || 1)),
                 text: prescriptions.map(p => p.recommendation ?? 'N/A'),
                 mode: 'markers+text',
                 textposition: 'top right', // Adjusted for jitter
                 marker: { size: 18, color: 'var(--primary)', opacity: 0.8 },
                 type: 'scatter' // Ensure scatter type
             };
             const matrixLayout = { /* Keep layout the same */
                 title: { text: "Impact vs. Effort", y:0.95 },
                 paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", font: { color: "white" },
                 xaxis: { title: "Effort Required", range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ["Low", "Medium", "High"], gridcolor: "rgba(255,255,255,0.2)", zeroline: false },
                 yaxis: { title: "Potential Impact", range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ["Low", "Medium", "High"], gridcolor: "rgba(255,255,255,0.2)", zeroline: false },
                 shapes: [ { type: "line", x0: 2, y0: 0.5, x1: 2, y1: 3.5, line: { color: "rgba(255,255,255,0.3)", width: 1, dash: "dot" } }, { type: "line", x0: 0.5, y0: 2, x1: 3.5, y1: 2, line: { color: "rgba(255,255,255,0.3)", width: 1, dash: "dot" } } ],
                 annotations: [ { x: 1, y: 3, text: "Quick Wins", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } }, { x: 3, y: 3, text: "Major Projects", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } }, { x: 1, y: 1, text: "Fill-ins", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } }, { x: 3, y: 1, text: "Thankless Tasks", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } } ]
             };
             Plotly.newPlot('matrixPlot', [matrixData], matrixLayout, { responsive: true });
         } catch(e) {
             console.error("Error rendering prioritization chart:", e);
             matrixPanel.innerHTML += `<p class="text-center text-red-400">Could not render prioritization chart.</p>`;
         }
     } else {
         matrixPanel.innerHTML += `<p class="text-center text-white/70 italic">No prescriptions available to plot.</p>`;
     }


    // --- 5. Populate KPI Tracker Panel (Uses new kpis_to_track) ---
    const kpisPanel = $("kpisPanel");
    let kpisHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Consolidated KPI Tracker</h3>`;
     let kpisAvailable = prescriptions.some(p => p.kpis_to_track && p.kpis_to_track.length > 0);
     if (kpisAvailable) {
         kpisHtml += `<div class="overflow-x-auto"><table class="coeff-table styled-table text-sm">
                     <thead><tr><th>KPI to Track</th><th>Related Prescription</th></tr></thead>
                     <tbody>`;
         prescriptions.forEach((p) => {
             (p.kpis_to_track || []).forEach(kpi => {
                 kpisHtml += `<tr><td>${kpi}</td><td>${p.recommendation ?? 'N/A'}</td></tr>`;
             });
         });
         kpisHtml += `</tbody></table></div>`;
     } else {
         kpisHtml += `<p class="text-center text-white/70 italic">No specific KPIs identified for the proposed prescriptions.</p>`;
     }
     kpisHtml += `</div>`;
    kpisPanel.innerHTML = kpisHtml;

    // --- 6. Populate Learn Prescriptive Tab (New Content) ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Prescriptive Analytics</h3>
         [Image of data analysis types: Descriptive, Diagnostic, Predictive, Prescriptive]
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is Prescriptive Analytics?</h4>
            <p class="text-sm text-white/80">Prescriptive analytics goes beyond predicting future outcomes (predictive analytics) to actually suggest specific actions a user can take to affect those outcomes. It answers the question: <strong>"What should we do about it?"</strong></p>
             <p class="text-sm text-white/80 mt-2">It often combines historical data, business rules, algorithms, machine learning, and simulations to recommend the optimal course of action for a given situation.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Key Differences:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Descriptive:</strong> What happened? (Reports, Dashboards)</li>
                    <li><strong>Diagnostic:</strong> Why did it happen? (Root Cause Analysis)</li>
                    <li><strong>Predictive:</strong> What is likely to happen? (Forecasting, Likelihoods)</li>
                    <li><strong>Prescriptive:</strong> What should we *do*? (Recommendations, Optimization)</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">How it Works (Simplified):</h4>
                 <ol class="list-decimal list-inside space-y-1 text-sm">
                    <li><strong>Goal Definition:</strong> Clearly state the business objective (e.g., increase sales, reduce churn).</li>
                    <li><strong>Data Analysis:</strong> Identify key factors (drivers) in historical data that influence the goal (Data Insights).</li>
                    <li><strong>Model Building (Often):</strong> Use simulations or optimization algorithms to explore how changing drivers affects the outcome.</li>
                    <li><strong>Recommendation Generation:</strong> Suggest specific actions (Prescriptions) based on the analysis, targeting the key drivers.</li>
                    <li><strong>Outcome Estimation:</strong> Predict the likely result of taking the recommended actions.</li>
                 </ol>
            </div>
        </div>

        <div class="bg-black/20 p-4 rounded-lg">
             <h4 class="text-lg font-bold mb-2 text-indigo-300">Components in This Tool:</h4>
             <ul class="list-disc list-inside space-y-1 text-sm text-white/80">
                <li><strong>Business Goal:</strong> Your specified objective.</li>
                <li><strong>Data Insights:</strong> Patterns found in your uploaded data relevant to the goal.</li>
                <li><strong>Prescriptions:</strong> Specific actions recommended by the AI, directly linked to the insights and goal.</li>
                <li><strong>Rationale:</strong> Explanation of *why* each prescription is suggested based on the data.</li>
                <li><strong>Impact/Effort:</strong> High-level estimate to help prioritize actions.</li>
                <li><strong>Expected Outcome & KPIs:</strong> Measurable targets to track success.</li>
             </ul>
        </div>

        <details class="styled-details text-sm">
            <summary class="font-semibold">Business Benefits</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-3">
                <p> <strong>Improved Decision Making:</strong> Provides clear, data-backed recommendations.</p>
                <p> <strong>Optimized Outcomes:</strong> Helps achieve specific business goals more effectively.</p>
                <p> <strong>Increased Efficiency:</strong> Automates the process of finding optimal actions.</p>
                <p> <strong>Risk Mitigation:</strong> Can identify potential negative consequences of certain actions.</p>
                <p> <strong>Actionable Insights:</strong> Translates complex data analysis into concrete steps.</p>
            </div>
        </details>
    </div>
    `;

    // --- Activate Listeners ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache the result HTML
    $("analysisActions").classList.remove("hidden"); // Show save buttons

    // Re-attach tab switching logic, including chart resizing
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");

                // Resize chart if matrix tab is activated
                if (e.target.dataset.tab === "matrix") {
                    const chartDiv = $("matrixPlot");
                     if (chartDiv && chartDiv.layout && typeof Plotly !== 'undefined') {
                         try { Plotly.Plots.resize(chartDiv); } catch (e) { console.error("Resize error:", e); }
                     }
                }
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Attempt initial resize after a short delay for Plotly
     setTimeout(() => {
         const initialMatrixChart = $("matrixPlot");
         // Check if the initial active tab IS the matrix tab before resizing
         if (tabNav.querySelector(".analysis-tab-btn.active")?.dataset.tab === "matrix" &&
             initialMatrixChart && initialMatrixChart.layout && typeof Plotly !== 'undefined') {
             try { Plotly.Plots.resize(initialMatrixChart); } catch (e) { console.error("Initial resize error:", e); }
         }
     }, 150);

    // Ensure loading indicator is stopped
    setLoading("generate", false);
}

    function parseCSV(csvText) {
        const lines = csvText.trim().split("\n");
        const header = lines[0].split(",").map((h) => h.trim());
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(",").map((v) => v.trim());
            if (values.length === header.length) {
                const row = {};
                for (let j = 0; j < header.length; j++) {
                    const value = values[j];
                    // Attempt to convert to number if possible
                    const numValue = parseFloat(value);
                    row[header[j]] = isNaN(numValue) ? value : numValue;
                }
                rows.push(row);
            }
        }
        return { header, rows };
    }

    async function handleActionPlansAnalysis_AP() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Generating Detailed Action Plan...</h3><p class="text-white/80 mb-2">Breaking down your objective into actionable tasks based *only* on your text...</p></div>`; // Updated text
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = $("docUpload").checked;
        let text = "";

        if (useDoc) {
            const file = $("actionPlanFile").files[0];
            if (!file) throw new Error("Please select a document to upload.");
            text = await extractTextFromFile(file);
        } else {
            text = $("actionPlanContent").value.trim();
            if (!text.trim()) throw new Error("Please describe the objective for your action plan.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (text.length > MAX_CONTEXT_LENGTH) {
            text = text.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`Action Plan analysis context truncated.`);
        }

        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are an expert project manager. Analyze the user's objective description based **ONLY** on the provided text and break it down into a detailed, sequential action plan. ${truncatedNote}

            **USER'S OBJECTIVE / PROJECT DESCRIPTION:**
            \`\`\`
            ${text}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Define Project Name:** Create a concise \`project_name\` derived **only from the text**.
            2.  **Develop Action Items (5-7 sequential items):** Create an array of \`action_items\`. For each item, derive the following **strictly from the user's text**:
                * \`task_name\`: Clear, actionable name (under 10 words).
                * \`description\`: Detailed explanation (2-3 sentences) of what needs to be done, **using specifics from the text**.
                * \`owner\`: Department, team, or role responsible, **as mentioned or implied in the text**.
                * \`timeline\`: Specific, sequential timeframe (e.g., "Weeks 1-2", "Month 2", "Q3") **suggested by the text's scope or explicit mentions**.
                * \`priority\`: Task's priority ("High", "Medium", "Low") **inferred from its importance described in the text**.
                * \`resources_needed\`: List key resources (e.g., Budget, Personnel, Technology, Data) **mentioned or clearly implied as necessary in the text**. If none implied, use ["Standard Operating Resources"].
                * \`key_dependency\`: (Optional) Name of another task from this plan that this task **clearly depends on according to the text**. If none, use null.
                * \`kpis_to_track\`: List 1-2 specific metrics **derived ONLY from the text** to measure the successful completion *of this specific task*.
            3.  **Self-Correction:** Rigorously check: Is project name derived from text? Are action items sequential and logical based on text? Is EVERY detail (name, description, owner, timeline, priority, resources, dependency, KPIs) **strictly derived ONLY from the user's text**? Is the JSON perfect? Fix errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT IS KING:** Base **ALL** output **EXCLUSIVELY** on the provided "USER'S OBJECTIVE / PROJECT DESCRIPTION". **DO NOT** invent tasks, roles, timelines, resources, dependencies, or KPIs. If the text lacks detail for a field (e.g., resources), infer reasonably or state appropriately (like "Standard Operating Resources").
            - **NO GENERIC EXAMPLES:** Replace **ALL** placeholder text in the RETURN FORMAT structure below with content generated **strictly from the user's input text**.
            - **JSON FORMAT:** Adhere EXACTLY.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. Replace ALL bracketed placeholders strictly based on the user's input text.
            {
              "project_name": "[Project Name derived ONLY from user text]",
              "action_items": [ // 5-7 items derived ONLY from text
                {
                  "task_name": "[Task 1 Name ONLY from text]",
                  "description": "[Detailed description ONLY from text...]",
                  "owner": "[Owner ONLY from text]",
                  "timeline": "[Timeline inferred ONLY from text scope]",
                  "priority": "[High/Medium/Low based ONLY on text]",
                  "resources_needed": ["[Resource 1 ONLY from text]", "[Resource 2 ONLY from text]"],
                  "key_dependency": null, // or "[Task Name ONLY from text]" if applicable
                  "kpis_to_track": ["[KPI for Task 1 ONLY from text]"]
                },
                {
                  "task_name": "[Task 2 Name ONLY from text]",
                  "description": "[Detailed description ONLY from text...]",
                  "owner": "[Owner ONLY from text]",
                  "timeline": "[Timeline inferred ONLY from text scope]",
                  "priority": "[High/Medium/Low based ONLY on text]",
                  "resources_needed": ["[Resource 3 ONLY from text]"],
                  "key_dependency": "[Task 1 Name ONLY from text]", // Example dependency
                  "kpis_to_track": ["[KPI for Task 2 ONLY from text 1]", "[KPI for Task 2 ONLY from text 2]"]
                }
                // ... 3-5 more items derived ONLY from text ...
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED Action Plan prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (Action Plan - SP):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Action Plan SP) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !parsedData.project_name || typeof parsedData.project_name !== 'string' || parsedData.project_name.includes("[") ||
                 !Array.isArray(parsedData.action_items) || parsedData.action_items.length < 3 || // Expect at least a few actions
                 // Check structure and placeholders in first action item
                  (parsedData.action_items.length > 0 && (
                      typeof parsedData.action_items[0] !== 'object' ||
                      !parsedData.action_items[0].hasOwnProperty('task_name') || parsedData.action_items[0].task_name.includes("[") ||
                      !parsedData.action_items[0].hasOwnProperty('description') || parsedData.action_items[0].description.includes("[") ||
                      !parsedData.action_items[0].hasOwnProperty('owner') || // Allow owner to be missing if not in text
                      !parsedData.action_items[0].hasOwnProperty('timeline') || parsedData.action_items[0].timeline.includes("[") ||
                      !parsedData.action_items[0].hasOwnProperty('priority') || !['High', 'Medium', 'Low'].includes(parsedData.action_items[0].priority) ||
                      !Array.isArray(parsedData.action_items[0].resources_needed) ||
                      !parsedData.action_items[0].hasOwnProperty('key_dependency') || // Allow null
                      !Array.isArray(parsedData.action_items[0].kpis_to_track)
                  ))
                )
             {
                  console.error("Validation Failed (Enhanced Action Plan SP): Required fields missing, invalid structure, or placeholders detected.", parsedData);
                  throw new Error(`AI response structure is incorrect, inconsistent, or contains placeholders (Enhanced Action Plan SP). Check project name and action items structure/content carefully. See console logs.`);
             }
             console.log(`Successfully parsed ENHANCED Action Plan (SP) JSON using ${MODEL_NAME}. Found ${parsedData.action_items.length} action items.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED Action Plan (SP) JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced Action Plan SP): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results
        renderActionPlansPage_AP(analysisResultContainer, parsedData); // Use the updated renderer

    } catch (error) {
        console.error(`Error in handleActionPlansAnalysis_AP (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


// Modified renderActionPlansPage_AP to add MORE Tabs and detailed task view
function renderActionPlansPage_AP(container, data) {
    container.innerHTML = ""; // Clear loading

    // Add validation for new fields
    if (!data || !data.project_name || !data.action_items) {
        console.error("Incomplete data passed to renderActionPlansPage_AP:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Action Plan results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    const { project_name, action_items } = data;

    // --- Create Tab Navigation (Updated with MORE Tabs) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="timeline"> Timeline View</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="details"> Task Details</button>
        <button class="analysis-tab-btn" data-tab="resources"> Resources & Dependencies</button> <!-- New -->
        <button class="analysis-tab-btn" data-tab="tracking"> Priorities & KPIs</button> <!-- New, Renamed -->
        <button class="analysis-tab-btn" data-tab="learn"> Learn Action Planning</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated with MORE Panels) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="timelinePanel" class="analysis-tab-panel active"></div>
        <div id="detailsPanel" class="analysis-tab-panel"></div>
        <div id="resourcesPanel" class="analysis-tab-panel"></div> <!-- New -->
        <div id="trackingPanel" class="analysis-tab-panel"></div> <!-- New -->
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Timeline Panel (Keep as is) ---
    const timelinePanel = $("timelinePanel");
     const sorted_action_items = [...action_items].sort((a, b) => {
         const getTimeValue = (timeline) => {
             timeline = String(timeline || '').toLowerCase(); // Ensure timeline is string
             if (timeline.includes('week')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 7;
             if (timeline.includes('month')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 30;
             if (timeline.includes('q')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 90;
             if (timeline.includes('sprint')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 14;
             return 9999;
         };
         return getTimeValue(a.timeline) - getTimeValue(b.timeline);
     });

    let timelineHtml = `<div class="p-4"><h2 class="text-3xl font-bold text-center mb-8">${project_name} - Timeline View</h2><div class="action-plan-container flex flex-col items-center">`;
    sorted_action_items.forEach((item) => {
        const priorityClass = `priority-${(item.priority || 'medium').toLowerCase()}`;
        let priorityIcon = "";
        if (item.priority === 'High') priorityIcon = "";
        else if (item.priority === 'Medium') priorityIcon = "";

        timelineHtml += `
            <div class="timeline-item">
                <div class="timeline-dot" style="border-color: ${item.priority === 'High' ? '#ef4444' : item.priority === 'Medium' ? '#f97316' : '#3b82f6'};"></div>
                <div class="timeline-content ${priorityClass}">
                    <p class="text-xs text-indigo-300 font-semibold">${item.timeline}</p>
                    <h4 class="text-lg font-bold">${item.task_name}</h4>
                    <p class="text-sm text-white/70"><strong>Owner:</strong> ${item.owner || 'N/A'}</p>
                    <p class="text-xs font-bold mt-1">${priorityIcon} Priority: ${item.priority}</p>
                </div>
            </div>
        `;
    });
    timelineHtml += `</div></div>`;
    timelinePanel.innerHTML = timelineHtml;


    // --- 2. Populate Task Details Panel (Focus on Name, Desc, Owner, Timeline) ---
    const detailsPanel = $("detailsPanel");
    let detailsHtml = `<div class="p-4 space-y-6"><h2 class="text-3xl font-bold mb-6 text-center">${project_name} - Task Details</h2>`;
     if (action_items.length > 0) {
         action_items.forEach((item, index) => {
             detailsHtml += `
                 <div class="action-card bg-black/20 p-4 rounded-lg border-l-4 border-gray-500"> <!-- Neutral border -->
                     <h4 class="text-lg font-bold mb-2">${index + 1}. ${item.task_name}</h4>
                     <p class="text-sm text-white/80 mb-3">${item.description || 'No description.'}</p>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs border-t border-white/10 pt-3">
                         <div><strong>Owner:</strong><br>${item.owner || 'N/A'}</div>
                         <div><strong>Timeline:</strong><br>${item.timeline || 'N/A'}</div>
                     </div>
                 </div>`;
         });
     } else {
          detailsHtml += `<p class="text-center text-white/70 italic">No action items were generated.</p>`;
     }
    detailsHtml += `</div>`;
    detailsPanel.innerHTML = detailsHtml;

    // --- 3. Populate Resources & Dependencies Panel (New) ---
    const resourcesPanel = $("resourcesPanel");
    let resourcesHtml = `<div class="p-4"><h2 class="text-3xl font-bold mb-6 text-center">${project_name} - Resources & Dependencies</h2>`;
    resourcesHtml += `<div class="overflow-x-auto">
                        <table class="coeff-table styled-table text-sm">
                            <thead><tr><th>Task Name</th><th>Resources Needed</th><th>Key Dependency</th></tr></thead>
                            <tbody>`;
     if (action_items.length > 0) {
        action_items.forEach((item) => {
             resourcesHtml += `<tr>
                                 <td class="font-semibold">${item.task_name}</td>
                                 <td class="text-white/80">${(item.resources_needed || []).join(', ') || 'N/A'}</td>
                                 <td class="text-white/70 italic">${item.key_dependency || 'None'}</td>
                              </tr>`;
         });
     } else {
         resourcesHtml += `<tr><td colspan="3" class="text-center text-white/60 italic p-4">No resource or dependency information generated.</td></tr>`;
     }
    resourcesHtml += `</tbody></table></div></div>`;
    resourcesPanel.innerHTML = resourcesHtml;


    // --- 4. Populate Priorities & KPIs Panel (New) ---
    const trackingPanel = $("trackingPanel");
    let trackingHtml = `<div class="p-4"><h2 class="text-3xl font-bold mb-6 text-center">${project_name} - Priorities & KPIs</h2>`;
     trackingHtml += `<div class="overflow-x-auto">
                        <table class="coeff-table styled-table text-sm">
                            <thead><tr><th>Task Name</th><th>Priority</th><th>KPIs to Track</th></tr></thead>
                            <tbody>`;
     if (action_items.length > 0) {
         // Sort by priority High > Medium > Low for this view
         const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };
         const sortedByPriority = [...action_items].sort((a,b) => (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4));

         sortedByPriority.forEach((item) => {
             let priorityColor = "text-blue-400"; // Low
             if (item.priority === 'High') priorityColor = "text-red-400";
             else if (item.priority === 'Medium') priorityColor = "text-yellow-400";

             trackingHtml += `<tr>
                                 <td class="font-semibold">${item.task_name}</td>
                                 <td><span class="font-bold ${priorityColor}">${item.priority}</span></td>
                                 <td class="text-white/80">${(item.kpis_to_track || []).join(', ') || 'N/A'}</td>
                              </tr>`;
         });
     } else {
          trackingHtml += `<tr><td colspan="3" class="text-center text-white/60 italic p-4">No priority or KPI information generated.</td></tr>`;
     }
    trackingHtml += `</tbody></table></div></div>`;
    trackingPanel.innerHTML = trackingHtml;


    // --- 5. Populate Learn Action Planning Panel (Keep as is) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Action Planning</h3>
        [Image of a Gantt chart or project timeline]
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is an Action Plan?</h4>
            <p class="text-sm text-white/80">An action plan is a detailed document outlining the specific tasks, steps, resources, and timelines required to achieve a particular goal or objective. It bridges the gap between strategy and execution.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Key Components of an Action Item:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Specific Task:</strong> What exactly needs to be done? (Verb-noun format is good, e.g., "Develop marketing brief").</li>
                    <li><strong>Owner:</strong> Who is responsible for ensuring the task is completed?</li>
                    <li><strong>Timeline/Due Date:</strong> When should the task be finished?</li>
                    <li><strong>Priority:</strong> How critical is this task relative to others? (High, Medium, Low).</li>
                    <li><strong>Resources:</strong> What is needed (budget, people, tools)?</li>
                    <li><strong>Dependencies:</strong> What other tasks must be completed first?</li>
                    <li><strong>Status/KPIs:</strong> How will completion or success be measured?</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Why Create Action Plans?</h4>
                 <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Clarity & Direction:</strong> Provides a clear roadmap for execution.</li>
                    <li><strong>Accountability:</strong> Assigns responsibility for each task.</li>
                    <li><strong>Prioritization:</strong> Helps focus effort on the most important activities.</li>
                    <li><strong>Resource Planning:</strong> Identifies necessary resources upfront.</li>
                    <li><strong>Progress Tracking:</strong> Allows monitoring of progress towards the goal.</li>
                    <li><strong>Coordination:</strong> Facilitates collaboration by showing dependencies.</li>
                    <li><strong>Risk Management:</strong> Helps anticipate potential roadblocks.</li>
                 </ul>
            </div>
        </div>

        <details class="styled-details text-sm mt-4">
            <summary class="font-semibold">Tips for Effective Action Planning</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                <p><strong>1. Start with SMART Objectives:</strong> Ensure the overall goal is Specific, Measurable, Achievable, Relevant, and Time-bound.</p>
                <p><strong>2. Break Down Large Tasks:</strong> Decompose complex objectives into smaller, manageable action steps.</p>
                <p><strong>3. Be Specific & Action-Oriented:</strong> Use clear verbs for task names.</p>
                <p><strong>4. Assign Single Owners:</strong> Avoid shared responsibility where possible.</p>
                <p><strong>5. Set Realistic Timelines:</strong> Consider dependencies and resource availability.</p>
                <p><strong>6. Identify Dependencies Clearly:</strong> Understand the sequence of tasks.</p>
                <p><strong>7. Define Success Metrics (KPIs):</strong> Know what 'done' looks like for each task.</p>
                <p><strong>8. Review and Update Regularly:</strong> Action plans are living documents; adapt as needed.</p>
            </div>
        </details>
         <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to generate a potential action plan structure based strictly on the objective you provided.</p>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                 // No Plotly charts expected in this tool
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}





    async function handleSystemGoalsAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `
        <div class="text-center text-white/70 p-8">
            <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
            <h3 class="text-xl font-semibold text-white mb-4">Formulating System-Aware Goals & Initiatives</h3>
            <p class="text-white/80 mb-2">Analyzing feedback loops to identify strategic interventions based on your input...</p> <!-- Updated text -->
        </div>`;
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model


    try {
        // 1. Gather Inputs
        const useDoc = $("docUpload").checked;
        let text = "";

        if (useDoc) {
            const file = $("systemGoalsFile").files[0];
            if (!file) throw new Error("Please select a document to upload.");
            text = await extractTextFromFile(file);
        } else {
            text = $("systemGoalsContent").value.trim();
            if (!text.trim()) throw new Error("Please enter system information and desired outcome in the text area.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (text.length > MAX_CONTEXT_LENGTH) {
            text = text.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`System Goals analysis context truncated.`);
        }

        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are a senior strategic consultant specializing in applying systems thinking to business goals. Based *only* on the provided system description and desired outcome, formulate a high-level system goal and develop strategic initiatives grounded in feedback loop analysis. ${truncatedNote}

            **USER'S SYSTEM DESCRIPTION & GOAL CONTEXT:**
            \`\`\`
            ${text}
            \`\`\`

            **DETAILED TASKS:**
            1.  **Define System Goal:** Refine the user's input into a single, concise, measurable \`system_goal\` (SMART goal if possible).
            2.  **Identify Key Loops:** Based *only* on the text, identify the primary \`reinforcing_loop\` (driving towards the goal) and the primary \`balancing_loop\` (hindering or limiting the goal). For each loop:
                * \`name\`: Descriptive name (e.g., "R1: Customer Growth Engine").
                * \`description\`: Explain the causal chain step-by-step, explicitly mentioning elements from the text.
                * \`elements\`: List key elements from the text involved in this loop.
            3.  **Develop Strategic Initiatives (2-3 initiatives):** Create initiatives to achieve the goal by manipulating the identified loops. For each initiative:
                * \`initiative_name\`: Clear, action-oriented name.
                * \`rationale\`: Explain *specifically* how this initiative manipulates the loops (e.g., "Strengthens R1 by enhancing [Element X]", "Weakens B1 by addressing [Element Y constraint mentioned in text]"). Must be grounded in the text.
                * \`objectives\`: List 2-3 specific, actionable objectives for this initiative based on the context.
                * \`kpis\`: List 2-3 specific KPIs to track the success of this initiative, relevant to the objectives and context.
            4.  **Self-Correction:** Rigorously check: Is the goal derived solely from input? Are loops and elements accurately extracted from text? Does initiative rationale *explicitly* reference loop manipulation based on text? Are objectives/KPIs context-specific? Is JSON structure perfect? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT GROUNDING:** All output MUST be based *exclusively* on the provided text. Do NOT invent information.
            - **LOOP MANIPULATION RATIONALE:** Initiative rationale MUST explain how it targets the identified loops based on text evidence.
            - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
            {
              "system_goal": "Increase the customer retention rate from X% to Y% within 18 months, based on the described churn problem.",
              "key_loops": {
                "reinforcing_loop": {
                  "name": "R1: Customer Loyalty Loop",
                  "description": "High product quality mentioned in text leads to greater customer satisfaction, driving positive word-of-mouth and repeat purchases, growing the loyal customer base.",
                  "elements": ["Product Quality", "Customer Satisfaction", "Word-of-Mouth", "Repeat Purchases", "Loyal Customer Base"]
                },
                "balancing_loop": {
                  "name": "B1: Support Strain Loop",
                  "description": "As the customer base grows (mentioned implicitly), support ticket volume increases. Text implies support capacity is limited, causing service quality to drop, leading to frustration and churn, limiting growth.",
                  "elements": ["Customer Base", "Support Tickets", "Support Capacity", "Service Quality", "Churn Rate"]
                }
              },
              "strategic_initiatives": [
                {
                  "initiative_name": "Proactive Quality & Success",
                  "rationale": "Strengthens the R1 'Loyalty Loop' by directly improving 'Product Quality' and 'Customer Satisfaction' mentioned as drivers, while weakening B1 by reducing the 'Support Tickets' flow arising from issues.",
                  "objectives": [
                    "Implement predictive analytics (based on described data) to identify at-risk customers with 90% accuracy.",
                    "Reduce critical bug reports mentioned by 50% via improved QA.",
                    "Launch targeted onboarding for features users struggle with (per text)."
                  ],
                  "kpis": ["Customer Retention Rate", "CSAT Score", "Support Ticket Volume"]
                },
                {
                  "initiative_name": "Scale Support Infrastructure",
                  "rationale": "Directly addresses the limiting factor ('Support Capacity') in the B1 'Support Strain Loop' identified from the text, allowing R1 to function more effectively.",
                  "objectives": [
                    "Decrease average support resolution time by 40% (addressing 'frustration' mentioned).",
                    "Implement AI knowledge base (leveraging 'mentioned data') to deflect 25% common queries."
                  ],
                  "kpis": ["Average Resolution Time", "First Contact Resolution Rate", "Knowledge Base Usage"]
                }
                // ... potentially one more ...
              ]
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED System Goals prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (System Goals):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced System Goals) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

            if (!parsedData || typeof parsedData !== 'object' ||
                 !parsedData.system_goal || typeof parsedData.system_goal !== 'string' ||
                 !parsedData.key_loops || typeof parsedData.key_loops !== 'object' ||
                 !parsedData.key_loops.reinforcing_loop || typeof parsedData.key_loops.reinforcing_loop !== 'object' || !parsedData.key_loops.reinforcing_loop.name ||
                 !parsedData.key_loops.balancing_loop || typeof parsedData.key_loops.balancing_loop !== 'object' || !parsedData.key_loops.balancing_loop.name ||
                 !Array.isArray(parsedData.strategic_initiatives) || parsedData.strategic_initiatives.length < 1 || // Expect at least one initiative
                 // Check structure of first initiative
                 (parsedData.strategic_initiatives.length > 0 && (
                     typeof parsedData.strategic_initiatives[0] !== 'object' ||
                     !parsedData.strategic_initiatives[0].hasOwnProperty('initiative_name') ||
                     !parsedData.strategic_initiatives[0].hasOwnProperty('rationale') ||
                     !Array.isArray(parsedData.strategic_initiatives[0].objectives) ||
                     !Array.isArray(parsedData.strategic_initiatives[0].kpis)
                 ))
               )
            {
                 console.error("Validation Failed (Enhanced System Goals): Required fields missing or invalid structure.", parsedData);
                 throw new Error(`AI response structure is incorrect or inconsistent (Enhanced System Goals). Check goal, loops, and initiatives structure. See console logs.`);
            }
             console.log(`Successfully parsed ENHANCED System Goals JSON using ${MODEL_NAME}. Found ${parsedData.strategic_initiatives.length} initiatives.`);


        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED System Goals JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced System Goals): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results
        renderSystemGoalsPage(analysisResultContainer, parsedData); // Use the updated renderer

    } catch (error) {
        console.error(`Error in handleSystemGoalsAnalysis (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


function renderSystemGoalsPage(container, data) {
    container.innerHTML = ""; // Clear loading

    // Add validation for new fields
    if (!data || !data.system_goal || !data.key_loops || !data.strategic_initiatives || !data.key_loops.reinforcing_loop || !data.key_loops.balancing_loop) {
        console.error("Incomplete data passed to renderSystemGoalsPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render System Goals results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    const { system_goal, key_loops, strategic_initiatives } = data;


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="map"> Strategic Map</button>
        <button class="analysis-tab-btn" data-tab="initiatives"> Initiatives & KPIs</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="learn"> Learn System Goals</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="mapPanel" class="analysis-tab-panel"></div>
        <div id="initiativesPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- 1. Populate Dashboard Panel (Updated) ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4 space-y-8">
        <div class="p-6 rounded-lg bg-black/20 border border-white/10 text-center">
            <h3 class="text-xl font-bold mb-2 text-indigo-300"> Overarching System Goal</h3>
            <p class="text-2xl italic text-white/90">${system_goal}</p>
        </div>
        <h3 class="text-2xl font-bold text-center">Key System Dynamics Affecting Goal</h3>
        <div class="grid md:grid-cols-2 gap-8">
            <div class="bg-black/20 p-4 rounded-lg border-l-4 border-green-400">
                <h4 class="text-lg font-bold flex items-center gap-2"> ${key_loops.reinforcing_loop.name} <span class="text-xs font-light text-white/60">(Reinforcing)</span></h4>
                <p class="text-sm text-white/80 my-3 italic">${key_loops.reinforcing_loop.description}</p>
                <div class="text-xs text-white/60"><strong>Elements:</strong> ${key_loops.reinforcing_loop.elements.join(", ")}</div>
            </div>
            <div class="bg-black/20 p-4 rounded-lg border-l-4 border-yellow-400">
                 <h4 class="text-lg font-bold flex items-center gap-2"> ${key_loops.balancing_loop.name} <span class="text-xs font-light text-white/60">(Balancing)</span></h4>
                <p class="text-sm text-white/80 my-3 italic">${key_loops.balancing_loop.description}</p>
                <div class="text-xs text-white/60"><strong>Elements:</strong> ${key_loops.balancing_loop.elements.join(", ")}</div>
            </div>
        </div>
         <h3 class="text-2xl font-bold text-center mt-6">Strategic Initiatives Overview</h3>
         <div class="grid grid-cols-1 md:grid-cols-${Math.min(strategic_initiatives.length, 3)} gap-6">`; // Adjust columns
            strategic_initiatives.forEach(init => {
                dashboardHtml += `<div class="summary-stat-card text-left p-4">
                                     <p class="font-bold text-lg text-white mb-2">${init.initiative_name}</p>
                                     <p class="text-xs text-indigo-300 italic mb-2">${init.rationale}</p>
                                     <p class="text-xs text-white/70">Objectives: ${init.objectives.length}</p>
                                  </div>`;
            });
         dashboardHtml += `</div>
    </div>`; // Close p-4 space-y-8
    dashboardPanel.innerHTML = dashboardHtml;


    // --- 2. Populate Strategic Map Panel (Reusing existing logic) ---
    const mapPanel = $("mapPanel");
    let mapHtml = `<div class="strategy-map-container p-4">
                <div class="p-4 rounded-lg bg-black/20 border border-white/10 text-center w-full max-w-lg">
                    <h3 class="text-lg font-bold text-indigo-300"> GOAL</h3>
                    <p class="text-2xl italic text-white/90">${system_goal}</p>
                </div>
                <div class="vertical-connector"></div>
                <div class="feedback-loops-grid">
                    <div id="reinforcing-box" class="bg-black/20 p-4 rounded-lg border-2 border-green-400/50 text-center flex flex-col justify-between h-full">
                        <h4 class="text-lg font-bold"> Growth Engine</h4>
                        <p class="text-sm text-white/80 my-2">${key_loops.reinforcing_loop.name}<br><span class="text-xs italic">${key_loops.reinforcing_loop.description.substring(0,100)}...</span></p>
                    </div>
                    <div id="balancing-box" class="bg-black/20 p-4 rounded-lg border-2 border-yellow-400/50 text-center flex flex-col justify-between h-full">
                        <h4 class="text-lg font-bold"> Limiting Factor</h4>
                        <p class="text-sm text-white/80 my-2">${key_loops.balancing_loop.name}<br><span class="text-xs italic">${key_loops.balancing_loop.description.substring(0,100)}...</span></p>
                    </div>
                </div>
                <div class="lines-to-interventions">
                    <h3 class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold text-white z-10 bg-gray-900 px-4 py-2 rounded">Strategic Interventions</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-${strategic_initiatives.length} gap-8 w-full max-w-4xl mt-4">`; // Use actual count

    strategic_initiatives.forEach((initiative) => {
        // Simple indicator logic based on rationale text
        const strengthensReinforcing = initiative.rationale.toLowerCase().includes("strengthen") && initiative.rationale.toLowerCase().includes(key_loops.reinforcing_loop.name.split(':')[0]);
        const weakensBalancing = (initiative.rationale.toLowerCase().includes("weaken") || initiative.rationale.toLowerCase().includes("address")) && initiative.rationale.toLowerCase().includes(key_loops.balancing_loop.name.split(':')[0]);

        let indicatorHtml = "";
        if (strengthensReinforcing && weakensBalancing) {
            indicatorHtml = `<div class="initiative-target-indicator flex items-center justify-center gap-1"><span class="indicator-boost"></span><span class="indicator-mitigate"></span></div>`;
        } else if (strengthensReinforcing) {
            indicatorHtml = `<div class="initiative-target-indicator indicator-boost"></div>`;
        } else if (weakensBalancing) {
            indicatorHtml = `<div class="initiative-target-indicator indicator-mitigate"></div>`;
        }

        mapHtml += `<div class="relative pt-8">
                    ${indicatorHtml}
                    <div class="bg-black/20 p-4 rounded-lg h-full border border-white/10 flex items-center justify-center text-center">
                        <h4 class="text-md font-bold text-white/90">${initiative.initiative_name}</h4>
                    </div>
                </div>`;
    });

    mapHtml += `</div></div>`;
    mapPanel.innerHTML = mapHtml;


    // --- 3. Populate Initiatives & KPIs Panel (Updated) ---
    const initiativesPanel = $("initiativesPanel");
    let initiativesHtml = `<div class="p-4 space-y-6">`;
    strategic_initiatives.forEach((initiative, index) => {
        initiativesHtml += `
            <div class="prescription-card border-l-4 border-blue-500">
                <h3 class="text-2xl font-bold mb-2">Initiative ${index + 1}: ${initiative.initiative_name}</h3>
                <p class="rationale"><strong>Systems Rationale:</strong> ${initiative.rationale}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                    <div class="bg-black/20 p-3 rounded">
                        <h5 class="font-bold text-yellow-300 mb-2">Specific Objectives</h5>
                        <ul class="list-disc list-inside space-y-1 text-white/90">${initiative.objectives.map((obj) => `<li>${obj}</li>`).join("")}</ul>
                    </div>
                    <div class="bg-black/20 p-3 rounded">
                        <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                        <ul class="list-disc list-inside space-y-1 text-white/90">${initiative.kpis.map((kpi) => `<li>${kpi}</li>`).join("")}</ul>
                    </div>
                </div>
            </div>
        `;
    });
    initiativesHtml += `</div>`;
    initiativesPanel.innerHTML = initiativesHtml;


    // --- 4. Populate Learn System Goals Panel (New) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Setting Goals in a Systems Context</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Why System Goals?</h4>
            <p class="text-sm text-white/80">Traditional goal setting often focuses on isolated metrics. System goals consider the interconnected nature of the organization. They aim to influence the underlying structure (feedback loops, delays, stocks, flows) to achieve desired outcomes sustainably, rather than just treating symptoms.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Connecting Goals to Loops:</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Identify Dynamics:</strong> First, understand the key reinforcing (growth) and balancing (limiting) loops driving current behavior related to your desired outcome.</li>
                    <li><strong>Target Loops:</strong> Frame your goal and subsequent initiatives around manipulating these loops.
                        <ul class="list-[circle] list-inside pl-4 text-xs">
                           <li>To accelerate growth? -> Strengthen the reinforcing loop(s).</li>
                           <li>To overcome constraints? -> Weaken the balancing loop(s) or increase their limits.</li>
                           <li>To stabilize fluctuations? -> Strengthen balancing loops or add delays to reinforcing loops.</li>
                        </ul>
                    </li>
                    <li><strong>Anticipate Side Effects:</strong> Consider how interventions might affect *other* parts of the system or create new loops.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">From Goal to Action (System View):</h4>
                 <ol class="list-decimal list-inside space-y-1 text-sm">
                    <li><strong>Define System Goal:</strong> High-level desired state, considering system dynamics.</li>
                    <li><strong>Analyze Loops:</strong> Identify key R & B loops influencing the goal.</li>
                    <li><strong>Identify Leverage Points:</strong> Find where interventions will be most effective on the loops.</li>
                    <li><strong>Develop Initiatives:</strong> Design actions specifically targeting those leverage points to manipulate loops.</li>
                    <li><strong>Define Objectives:</strong> Break initiatives into smaller, measurable steps.</li>
                    <li><strong>Select KPIs:</strong> Choose metrics that track both initiative progress *and* the behavior of the targeted loops/elements.</li>
                    <li><strong>Monitor & Adapt:</strong> Observe system behavior and adjust interventions as needed.</li>
                 </ol>
            </div>
        </div>

        <details class="styled-details text-sm mt-4">
            <summary class="font-semibold">Example: Reducing Customer Churn</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                <p><strong>Traditional Goal:</strong> Reduce churn by 15%.</p>
                <p><strong>System Goal:</strong> Reduce churn by 15% by strengthening the 'Customer Loyalty' (R) loop and weakening the 'Support Strain' (B) loop.</p>
                <p><strong>Initiative (Strengthen R):</strong> Improve product onboarding -> increases satisfaction -> increases loyalty.</p>
                <p><strong>Initiative (Weaken B):</strong> Increase support staff -> increases capacity -> maintains service quality under load -> reduces frustration -> reduces churn.</p>
                <p class="text-xs italic mt-2">Notice how initiatives explicitly link to loop manipulation.</p>
            </div>
        </details>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                 // No Plotly charts expected in this tool, so no resize needed
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}

async function handleMiscAnalysis_MSC() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Compiling Final Report Sections...</h3><p class="text-white/80 mb-2">Generating summary, risks, governance, and conclusion based *only* on your provided document...</p></div>`; // Updated text
    setLoading("generate", true);

    // Define URL and Model
    const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
    const MODEL_NAME = "llama3.1:latest"; // Consistent model

    try {
        // 1. Gather Inputs
        const useDoc = $("docUpload").checked;
        let text = "";
        if (useDoc) {
            const file = $("miscFile").files[0];
            if (!file) throw new Error("Please select a document.");
            text = await extractTextFromFile(file);
        } else {
            text = $("miscContent").value.trim();
            if (!text.trim()) throw new Error("Please provide your document content.");
        }

        // Truncate if necessary
        const MAX_CONTEXT_LENGTH = 15000; // Allow larger context for final summary
        let truncatedNote = "";
        if (text.length > MAX_CONTEXT_LENGTH) {
            text = text.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            console.warn(`Misc analysis context truncated.`);
        }

        // 2. Construct ENHANCED Prompt
        const prompt = `
            You are a senior business strategist finalizing a strategic plan document. Analyze the provided document **based ONLY on the text itself** and compile the final key sections. ${truncatedNote}

            **USER'S STRATEGIC DOCUMENT:**
            \`\`\`
            ${text}
            \`\`\`

            **DETAILED TASKS:**
            Compile the final sections **strictly derived from the user's text**:
            1.  **Executive Summary (\`executive_summary\`):** Write a comprehensive, multi-sentence summary covering the core problem/opportunity, strategic goal, key initiatives/strategies proposed, and expected outcomes **as described in the text**. Ensure it accurately reflects the document's main points.
            2.  **Risk Assessment (\`risk_assessment\`):** Identify 3-4 major risks **mentioned or clearly implied in the text**. For each risk:
                * \`risk\`: Description **from the text**.
                * \`impact\`: Potential impact ("High", "Medium", "Low") **inferred ONLY from the text's description**.
                * \`likelihood\`: Likelihood ("High", "Medium", "Low") **inferred ONLY from the text's description**.
                * \`justification\`: Briefly explain (1 sentence) the reasoning for the impact/likelihood ratings **based ONLY on text evidence**.
                * \`mitigation\`: Specific mitigation strategy **mentioned or logically derived ONLY from the text**.
            3.  **Governance (\`governance\`):** Identify 3-4 key stakeholders or teams **mentioned in the text**. For each:
                * \`stakeholder\`: Name of team/role **from the text**.
                * \`responsibilities\`: List 2-3 specific responsibilities related to plan execution **explicitly stated or clearly implied in the text**.
            4.  **Conclusion (\`conclusion\`):** Write a comprehensive concluding section summarizing the strategic importance, reinforcing key success factors **mentioned in the text**, and providing a forward-looking statement **based ONLY on the text's narrative**.
            5.  **Self-Correction:** Rigorously check: Is EVERY detail (summary points, risks, justifications, mitigations, stakeholders, responsibilities, conclusion themes) **strictly derived ONLY from the user's text**? Are impact/likelihood justifications text-based? Is the JSON perfect? Fix all errors.

            **ABSOLUTE CONSTRAINTS:**
            - **CONTEXT IS KING:** Base **ALL** output **EXCLUSIVELY** on the provided "USER'S STRATEGIC DOCUMENT". **DO NOT** invent information.
            - **NO GENERIC EXAMPLES:** Replace **ALL** placeholder text in the RETURN FORMAT with content generated **strictly from the user's input text**.
            - **JSON FORMAT:** Adhere EXACTLY.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. Replace ALL bracketed placeholders strictly based on the user's input text.
            {
              "executive_summary": "[Comprehensive summary derived ONLY from user text, covering problem/goal/strategy/outcome...]",
              "risk_assessment": [ // 3-4 risks derived ONLY from text
                {
                  "risk": "[Risk description ONLY from text]",
                  "impact": "[High/Medium/Low based ONLY on text]",
                  "likelihood": "[High/Medium/Low based ONLY on text]",
                  "justification": "[Reason for ratings based ONLY on text evidence]",
                  "mitigation": "[Mitigation strategy ONLY from text]"
                },
                //...
              ],
              "governance": [ // 3-4 stakeholders derived ONLY from text
                {
                  "stakeholder": "[Stakeholder/Team Name ONLY from text]",
                  "responsibilities": [
                    "[Responsibility 1 ONLY from text]",
                    "[Responsibility 2 ONLY from text]"
                  ]
                },
                //...
              ],
              "conclusion": "[Comprehensive conclusion summarizing importance, success factors, and outlook, based ONLY on user text...]"
            }
        `;

        // 3. Send Request to Ollama
        console.log(`Sending ENHANCED Misc Sections prompt to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (Misc - SP):', data.response); // Log raw response
        try {
            parsedData = JSON.parse(data.response);
             // *** Refined Robust Validation ***
             console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Misc SP) ---');
             console.log(JSON.stringify(parsedData, null, 2));
             console.log('------------------------------------');

             if (!parsedData || typeof parsedData !== 'object' ||
                 !parsedData.executive_summary || typeof parsedData.executive_summary !== 'string' || parsedData.executive_summary.includes("[") ||
                 !Array.isArray(parsedData.risk_assessment) || parsedData.risk_assessment.length < 1 ||
                 !Array.isArray(parsedData.governance) || parsedData.governance.length < 1 ||
                 !parsedData.conclusion || typeof parsedData.conclusion !== 'string' || parsedData.conclusion.includes("[") ||
                 // Check structure of first risk
                 (parsedData.risk_assessment.length > 0 && (
                     typeof parsedData.risk_assessment[0] !== 'object' ||
                     !parsedData.risk_assessment[0].hasOwnProperty('risk') || parsedData.risk_assessment[0].risk.includes("[") ||
                     !parsedData.risk_assessment[0].hasOwnProperty('impact') || !['High', 'Medium', 'Low'].includes(parsedData.risk_assessment[0].impact) ||
                     !parsedData.risk_assessment[0].hasOwnProperty('likelihood') || !['High', 'Medium', 'Low'].includes(parsedData.risk_assessment[0].likelihood) ||
                     !parsedData.risk_assessment[0].hasOwnProperty('justification') || parsedData.risk_assessment[0].justification.includes("[") || // Added justification check
                     !parsedData.risk_assessment[0].hasOwnProperty('mitigation') || parsedData.risk_assessment[0].mitigation.includes("[")
                 )) ||
                  // Check structure of first governance item
                  (parsedData.governance.length > 0 && (
                      typeof parsedData.governance[0] !== 'object' ||
                      !parsedData.governance[0].hasOwnProperty('stakeholder') || parsedData.governance[0].stakeholder.includes("[") ||
                      !Array.isArray(parsedData.governance[0].responsibilities) || parsedData.governance[0].responsibilities.length < 1 ||
                      (parsedData.governance[0].responsibilities.length > 0 && parsedData.governance[0].responsibilities[0].includes("["))
                  ))
                )
             {
                  console.error("Validation Failed (Enhanced Misc SP): Required fields missing, invalid structure, or placeholders detected.", parsedData);
                  throw new Error(`AI response structure is incorrect, inconsistent, or contains placeholders (Enhanced Misc SP). Check all sections carefully. See console logs.`);
             }
             console.log(`Successfully parsed ENHANCED Misc Sections (SP) JSON using ${MODEL_NAME}.`);

        } catch (e) {
            console.error(`Failed to parse/validate ENHANCED Misc Sections (SP) JSON using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (Enhanced Misc SP): ${e.message}. See raw response in console.`);
        }

        // 4. Render Results
        renderMiscPage_MSC(analysisResultContainer, parsedData); // Use the updated renderer

    } catch (error) {
        console.error(`Error in handleMiscAnalysis_MSC (Enhanced) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        // Ensure loading stops reliably
         if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
         }
    }
}


// Modified renderMiscPage_MSC to add Learn Tab and display details
function renderMiscPage_MSC(container, data) {
    container.innerHTML = ""; // Clear loading

    // Add validation for new fields
    if (!data || !data.executive_summary || !data.risk_assessment || !data.governance || !data.conclusion) {
        console.error("Incomplete data passed to renderMiscPage_MSC:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Final Sections.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    const { executive_summary, risk_assessment, governance, conclusion } = data;

    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="summary"> Executive Summary</button>
        <button class="analysis-tab-btn" data-tab="risks"> Risk Assessment</button>
        <button class="analysis-tab-btn" data-tab="gov"> Governance</button>
        <button class="analysis-tab-btn" data-tab="conclusion"> Conclusion</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Finalizing Plans</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="summaryPanel" class="analysis-tab-panel active"></div>
        <div id="risksPanel" class="analysis-tab-panel"></div>
        <div id="govPanel" class="analysis-tab-panel"></div>
        <div id="conclusionPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- 1. Populate Summary Panel ---
    const summaryPanel = $("summaryPanel");
    summaryPanel.innerHTML = `<div class="p-4"><blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90">${executive_summary}</blockquote></div>`;

    // --- 2. Populate Risks Panel (Added Justification) ---
    const risksPanel = $("risksPanel");
    let risksHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> Risk Assessment</h3><div class="overflow-x-auto">
        <table class="w-full text-left styled-table text-sm"> <!-- Use styled-table -->
            <thead>
                <tr>
                    <th>Risk Description</th>
                    <th class="text-center">Impact</th>
                    <th class="text-center">Likelihood</th>
                    <th>Justification</th>
                    <th>Mitigation Strategy</th>
                </tr>
            </thead>
            <tbody>`;
    if (risk_assessment.length > 0) {
        risk_assessment.forEach((item) => {
            const impactClass = `risk-level-${(item.impact || "low").toLowerCase()}`;
            const likelihoodClass = `risk-level-${(item.likelihood || "low").toLowerCase()}`;
            risksHtml += `<tr>
                <td>${item.risk || 'N/A'}</td>
                <td class="text-center"><span class="risk-pill ${impactClass}">${item.impact || '?'}</span></td>
                <td class="text-center"><span class="risk-pill ${likelihoodClass}">${item.likelihood || '?'}</span></td>
                <td class="text-xs text-white/70 italic">${item.justification || 'N/A'}</td> <!-- Added justification -->
                <td class="text-xs text-white/80">${item.mitigation || 'N/A'}</td>
            </tr>`;
        });
    } else {
         risksHtml += `<tr><td colspan="5" class="text-center text-white/60 italic p-4">No risks identified from the text.</td></tr>`;
    }
    risksHtml += `</tbody></table></div></div>`;
    risksPanel.innerHTML = risksHtml;

    // --- 3. Populate Governance Panel (Clearer Structure) ---
    const govPanel = $("govPanel");
    let govHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> Governance & Responsibilities</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`; // Allow 3 columns
     if (governance.length > 0) {
        governance.forEach((item) => {
            govHtml += `<div class="bg-black/20 p-4 rounded-lg border border-white/10"> <!-- Use card style -->
                <h4 class="text-lg font-bold mb-3 border-b border-white/10 pb-1">${item.stakeholder || 'Unnamed Stakeholder'}</h4>
                <p class="text-xs font-semibold text-indigo-300 mb-2">Key Responsibilities:</p>
                <ul class="list-disc list-inside space-y-1 text-sm text-white/80">${(item.responsibilities || []).map(r => `<li>${r}</li>`).join('')}</ul>
            </div>`;
        });
     } else {
         govHtml += `<p class="col-span-full text-center text-white/60 italic">No governance details identified from the text.</p>`;
     }
    govHtml += `</div></div>`; // Close grid and p-4
    govPanel.innerHTML = govHtml;

    // --- 4. Populate Conclusion Panel ---
    const conclusionPanel = $("conclusionPanel");
    conclusionPanel.innerHTML = `<div class="p-4"><blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90">${conclusion}</blockquote></div>`;

    // --- 5. Populate Learn Finalizing Plans Panel (New) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Finalizing Your Strategic Plan</h3>
         
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Why are these Final Sections Important?</h4>
            <p class="text-sm text-white/80">While the core strategy is crucial, these final sections synthesize the plan, address potential roadblocks, assign accountability, and provide a concluding perspective, making the plan more robust and actionable.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2 text-blue-300"> Executive Summary</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Purpose:</strong> Provides a concise overview for stakeholders (especially executives) who may not read the entire document.</li>
                    <li><strong>Content:</strong> Should cover the problem/opportunity, main objective, key strategies/initiatives, and expected high-level outcomes/impact.</li>
                    <li><strong>Goal:</strong> Quickly convey the essence and value of the plan.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2 text-red-300"> Risk Assessment</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Purpose:</strong> Identifies potential internal and external factors that could hinder the plan's success.</li>
                    <li><strong>Content:</strong> Description of risks, assessment of their potential Impact and Likelihood, and planned Mitigation strategies.</li>
                    <li><strong>Goal:</strong> Proactively anticipate challenges and prepare contingency plans.</li>
                </ul>
            </div>
             <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2 text-yellow-300"> Governance</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Purpose:</strong> Defines who is responsible for overseeing and executing different parts of the plan.</li>
                    <li><strong>Content:</strong> Identifies key stakeholders (teams, roles, committees) and clarifies their specific Responsibilities in implementation and monitoring.</li>
                    <li><strong>Goal:</strong> Ensure clear accountability and effective coordination during execution.</li>
                </ul>
            </div>
             <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2 text-green-300"> Conclusion</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Purpose:</strong> Summarizes the strategic importance and provides a final perspective.</li>
                    <li><strong>Content:</strong> Reinforce the 'why' behind the plan, reiterate key success factors, and offer a confident, forward-looking statement.</li>
                    <li><strong>Goal:</strong> End the plan on a strong, motivating note, emphasizing the potential benefits.</li>
                </ul>
            </div>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to extract and synthesize these final sections based strictly on the content of your input document.</p>
    </div>
    `;


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                 // No Plotly charts expected
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}


   function renderArchetypeAnalysisPage(container, data) {
        container.innerHTML = "";
        const { concepts, topArchetypes, topLeveragePoints } = data;
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="concepts"> Concepts</button><button class="analysis-tab-btn" data-tab="network"> Network</button><button class="analysis-tab-btn" data-tab="archetypes"> Archetypes</button><button class="analysis-tab-btn" data-tab="leverage"> Leverage Points</button>`;
        container.appendChild(tabNav);
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `<div id="conceptsPanel" class="analysis-tab-panel active"></div><div id="networkPanel" class="analysis-tab-panel"></div><div id="archetypesPanel" class="analysis-tab-panel"></div><div id="leveragePanel" class="analysis-tab-panel"></div>`;
        renderConceptsTab(concepts, "conceptsPanel");
        renderNetworkTab(concepts, "networkPanel");
        renderArchetypesTab(topArchetypes, "archetypesPanel");
        renderLeveragePointsTab(topLeveragePoints, "leveragePanel");

        analysisCache[currentTemplateId] = container.innerHTML;

        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanel = $(e.target.dataset.tab + "Panel");
                targetPanel.classList.add("active");
                const chart = targetPanel.querySelector(".plotly-chart");
                if (chart) Plotly.Plots.resize(chart);
            }
        });
    }

    function renderConceptsTab(concepts, containerId) {
        const container = $(containerId);
        const positiveCount = concepts.filter((c) => c.effect === "+").length;
        const negativeCount = concepts.filter((c) => c.effect === "-").length;
        const neutralCount = concepts.filter((c) => c.effect === "0").length;
        let tableHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><div class="metric-card"><h4 class="font-bold">Positive Effects</h4><p class="text-3xl font-bold">${positiveCount}</p></div><div class="metric-card"><h4 class="font-bold">Negative Effects</h4><p class="text-3xl font-bold">${negativeCount}</p></div><div class="metric-card"><h4 class="font-bold">Neutral Effects</h4><p class="text-3xl font-bold">${neutralCount}</p></div></div><div id="effectPieChart" class="w-full h-[400px] mb-8 plotly-chart"></div><h3 class="text-2xl font-bold mb-4">Extracted Concepts</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-white/20"><tr><th class="p-2">Concept</th><th class="p-2">Description</th><th class="p-2">Effect</th><th class="p-2">Influence</th></tr></thead><tbody>`;
        concepts.forEach((c) => {
            tableHtml += `<tr class="border-b border-white/10"><td class="p-2 font-semibold">${c.name}</td><td class="p-2 text-sm text-white/80">${c.description}</td><td class="p-2 text-center">${c.effect}</td><td class="p-2">${c.influence}</td></tr>`;
        });
        tableHtml += "</tbody></table></div>";
        container.innerHTML = tableHtml;
        Plotly.newPlot(
            "effectPieChart",
            [
                {
                    values: [positiveCount, negativeCount, neutralCount],
                    labels: ["Positive", "Negative", "Neutral"],
                    type: "pie",
                    marker: { colors: ["#2E8B57", "#CD5C5C", "#808080"] },
                    hole: 0.4
                }
            ],
            {
                title: "Distribution of Concept Effects",
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                legend: { orientation: "h", y: -0.1 }
            },
            { responsive: true }
        );
    }

    function renderNetworkTab(concepts, containerId) {
        const container = $(containerId);
        container.innerHTML = `<div id="conceptNetworkChart" class="w-full h-[600px] plotly-chart"></div>`;
        const nodes = concepts.map((c) => ({ id: c.name, ...c }));
        const edges = [];
        for (let i = 0; i < nodes.length; i++) {
            for (let j = i + 1; j < nodes.length; j++) {
                edges.push({ source: nodes[i].id, target: nodes[j].id });
            }
        }
        const positions = {};
        nodes.forEach((node, i) => {
            const angle = (i / nodes.length) * 2 * Math.PI;
            positions[node.id] = { x: nodes.length * 15 * Math.cos(angle), y: nodes.length * 15 * Math.sin(angle) };
        });
        const edge_x = [];
        const edge_y = [];
        edges.forEach((edge) => {
            edge_x.push(positions[edge.source].x, positions[edge.target].x, null);
            edge_y.push(positions[edge.source].y, positions[edge.target].y, null);
        });
        const node_x = [];
        const node_y = [];
        const node_text = [];
        const node_color = [];
        nodes.forEach((node) => {
            node_x.push(positions[node.id].x);
            node_y.push(positions[node.id].y);
            node_text.push(`${node.name}<br>Influence: ${node.influence}`);
            if (node.effect === "+") node_color.push("green");
            else if (node.effect === "-") node_color.push("red");
            else node_color.push("gray");
        });
        const edgeTrace = {
            x: edge_x,
            y: edge_y,
            mode: "lines",
            line: { width: 0.5, color: "#888" },
            hoverinfo: "none"
        };
        const nodeTrace = {
            x: node_x,
            y: node_y,
            mode: "markers+text",
            text: nodes.map((n) => n.name),
            textposition: "bottom center",
            hoverinfo: "text",
            hovertext: node_text,
            marker: { size: 20, color: node_color }
        };
        Plotly.newPlot(
            "conceptNetworkChart",
            [edgeTrace, nodeTrace],
            {
                title: "Concept Network Visualization",
                showlegend: false,
                hovermode: "closest",
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                xaxis: { showgrid: false, zeroline: false, showticklabels: false },
                yaxis: { showgrid: false, zeroline: false, showticklabels: false }
            },
            { responsive: true }
        );
    }

    function renderArchetypesTab(topArchetypes, containerId) {
        const container = $(containerId);
        let contentHtml = `<h3 class="text-2xl font-bold mb-4"> 80/20 Analysis - Most Relevant Archetypes</h3><p class="text-white/70 mb-6">This analysis focuses on the top 20% of system archetypes that are most likely driving 80% of the system's behavior.</p><div id="archetypeBarChart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
        topArchetypes.forEach((archetype) => {
            contentHtml += `<div class="metric-card mb-4"><h4 class="text-xl font-bold"> ${archetype.name}</h4><p class="text-sm font-semibold text-yellow-300 mb-2">Relevance Score: ${archetype.relevance_score}/10</p><p class="text-sm text-white/80 mb-3">${archetype.description}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div><h5 class="font-semibold">Leverage Points:</h5><ul class="list-disc list-inside">${archetype.leverage_points.map((lp) => `<li>${lp}</li>`).join("")}</ul></div><div><h5 class="font-semibold">Interventions:</h5><ul class="list-disc list-inside">${archetype.interventions.map((i) => `<li>${i}</li>`).join("")}</ul></div></div></div>`;
        });
        container.innerHTML = contentHtml;
        const chartData = topArchetypes.map((a) => ({ Archetype: a.name, "Relevance Score": a.relevance_score || 0 }));
        Plotly.newPlot(
            "archetypeBarChart",
            [
                {
                    x: chartData.map((d) => d.Archetype),
                    y: chartData.map((d) => d["Relevance Score"]),
                    type: "bar",
                    marker: { color: chartData.map((d) => d["Relevance Score"]), colorscale: "Viridis" }
                }
            ],
            {
                title: "Archetype Relevance Scores (Top 20%)",
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                xaxis: { automargin: true },
                yaxis: { title: "Relevance Score" }
            },
            { responsive: true }
        );
    }

    function renderLeveragePointsTab(topLeveragePoints, containerId) {
        const container = $(containerId);
        let contentHtml = `<h3 class="text-2xl font-bold mb-4"> 80/20 Analysis - Top Leverage Points</h3><p class="text-white/70 mb-6">These are the top 20% of concepts where small changes can lead to the largest (80%) improvements in the system.</p><div id="leverageBarChart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
        topLeveragePoints.forEach((point) => {
            let priorityClass = "";
            if (point.impact === "High" && point.score >= 8) priorityClass = "critical";
            else if (point.score >= 6) priorityClass = "high";
            contentHtml += `<div class="metric-card ${priorityClass} mb-4"><h4 class="text-xl font-bold">${point.concept}</h4><p class="text-sm font-semibold text-yellow-300 mb-2">Leverage Score: ${point.score}/10 | Expected Impact: ${point.impact}</p><p class="text-sm text-white/80 mb-3"><strong>Reasoning:</strong> ${point.reasoning}</p><div><h5 class="font-semibold text-sm">Recommended Actions:</h5><ul class="list-disc list-inside text-sm">${point.actions.map((a) => `<li>${a}</li>`).join("")}</ul></div></div>`;
        });
        container.innerHTML = contentHtml;
        const chartData = topLeveragePoints.map((p) => ({
            Concept: p.concept,
            "Leverage Score": p.score || 0,
            Impact: p.impact
        }));
        Plotly.newPlot(
            "leverageBarChart",
            [
                {
                    x: chartData.map((d) => d.Concept),
                    y: chartData.map((d) => d["Leverage Score"]),
                    type: "bar",
                    marker: {
                        color: chartData.map((d) => {
                            if (d.Impact === "High") return "#2E8B57";
                            if (d.Impact === "Medium") return "#FF8C00";
                            return "#DC143C";
                        })
                    }
                }
            ],
            {
                title: "Leverage Point Scores (Top 20%)",
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                xaxis: { automargin: true },
                yaxis: { title: "Leverage Score" }
            },
            { responsive: true }
        );
    }
    // =========================================================================
    // ===== END OF ANALYSIS LOGIC & RENDERING                            =====
    // =========================================================================

    function handleWebSocketMessage(data) {
        const container = pendingAnalysisRequests.get(parseInt(data.messageId));
        if (!container) return;

        if (data.error) {
            container.innerHTML = `<div class="p-4 text-center text-red-400">Workflow error: ${data.error}</div>`;
            pendingAnalysisRequests.delete(parseInt(data.messageId));
            setLoading("generate", false);
            return;
        }

        if (data.progress && !data.result && data.templateId !== "pareto-fishbone") {
            container.innerHTML = `
                    <div class="text-center text-white/70 p-4">
                        <div class="typing-indicator mb-4">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                        <p class="mb-2"> ${data.progress}</p>
                        <p class="text-sm text-white/50">Analysis in progress...</p>
                    </div>`;
            return;
        }

        // Handle complex data for pareto-fishbone
        if (data.templateId === "pareto-fishbone" && data.fishbone && data.pareto) {
            container.innerHTML = ""; // Clear loading
            const fishboneData = data.fishbone;
            const paretoData = data.pareto;

            // Create Tab Interface
            const tabNav = document.createElement("div");
            tabNav.className = "flex border-b border-white/20 -mx-10 px-6";
            tabNav.innerHTML = `
                        <button class="analysis-tab-btn active" data-tab="pareto"> Pareto Chart</button>
                        <button class="analysis-tab-btn" data-tab="fishbone"> Fishbone Diagram</button>
                        <button class="analysis-tab-btn" data-tab="details"> Analysis Details</button>
                        <button class="analysis-tab-btn" data-tab="plan"> Action Plan</button>
                    `;
            container.appendChild(tabNav);

            const tabContent = document.createElement("div");
            container.appendChild(tabContent);

            // Create Tab Panels
            tabContent.innerHTML = `
                        <div id="paretoPanel" class="analysis-tab-panel active"></div>
                        <div id="fishbonePanel" class="analysis-tab-panel"></div>
                        <div id="detailsPanel" class="analysis-tab-panel"></div>
                        <div id="planPanel" class="analysis-tab-panel"></div>
                    `;

            // Populate Pareto Tab
            const paretoPanel = $("paretoPanel");
            const paretoChartDiv = document.createElement("div");
            paretoChartDiv.id = "paretoChartContainer";
            paretoChartDiv.className = "plotly-chart";
            paretoPanel.appendChild(paretoChartDiv);
            createParetoChartJS(paretoData, "paretoChartContainer");

            // Populate Fishbone Tab
            const fishbonePanel = $("fishbonePanel");
            if (data.fishbone_image) {
                fishbonePanel.innerHTML = `<img id="fishbone_img" src="data:image/png;base64,${data.fishbone_image}" class="w-full h-auto rounded-lg" alt="Fishbone Diagram">`;
            } else {
                fishbonePanel.innerHTML = `<p class="text-white/70">Fishbone image not available.</p>`;
            }

            // Populate Details Tab
            const detailsPanel = $("detailsPanel");
            let detailsHtml = `<h3 class="text-2xl font-bold mb-4">Analysis Summary</h3>`;
            if (paretoData.analysis_summary) {
                detailsHtml += `<div class="p-4 rounded-lg bg-white/5 mb-6 text-white/80 italic">${paretoData.analysis_summary}</div>`;
            }
            detailsHtml += `<h4 class="text-xl font-semibold mb-3">Category Breakdown</h4>`;
            for (const [category, sub_causes] of Object.entries(fishboneData)) {
                detailsHtml += `<details class="bg-white/5 p-3 rounded-lg mb-2"><summary class="cursor-pointer font-semibold">${category} (${sub_causes.length} causes)</summary><ul class="mt-2 pl-4">`;
                sub_causes.forEach((cause) => {
                    const isVital = (paretoData.vital_few || []).some(
                        (item) => cause.toLowerCase() === item.cause.toLowerCase()
                    );
                    detailsHtml += `<li class="mb-1">${isVital ? "" : ""} ${cause}</li>`;
                });
                detailsHtml += `</ul></details>`;
            }
            detailsPanel.innerHTML = detailsHtml;

            // Populate Action Plan Tab
            const planPanel = $("planPanel");
            let planHtml = `<h3 class="text-2xl font-bold mb-4">Recommended Action Plan</h3>
                                    <div class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6"> <strong>80/20 Rule:</strong> Focus 80% of your resources on the 'Vital Few' causes for maximum impact!</div>
                                    <h4 class="text-xl font-semibold mb-3 border-b border-red-500/50 pb-2 text-red-300"> IMMEDIATE FOCUS (Vital Few)</h4>`;
            (paretoData.vital_few || []).forEach((cause) => {
                planHtml += `<div class="mb-4">
                                        <p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p>
                                        <p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> HIGH </p>
                                     </div>`;
            });
            planHtml += `<h4 class="text-xl font-semibold mt-8 mb-3 border-b border-white/20 pb-2"> SECONDARY ACTIONS (Useful Many)</h4>`;
            (paretoData.useful_many || []).forEach((cause) => {
                planHtml += `<div class="mb-4">
                                        <p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p>
                                        <p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> Medium/Low</p>
                                     </div>`;
            });
            planPanel.innerHTML = planHtml;

            analysisCache[currentTemplateId] = container.innerHTML;

            // Add Tab Switching Logic
            tabNav.addEventListener("click", (e) => {
                if (e.target.tagName === "BUTTON") {
                    tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                    tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));

                    e.target.classList.add("active");
                    const targetPanelId = e.target.dataset.tab + "Panel";
                    const targetPanel = $(targetPanelId);
                    targetPanel.classList.add("active");
                    const chart = targetPanel.querySelector(".plotly-chart");
                    if (chart) Plotly.Plots.resize(chart);
                }
            });
        } else if (data.result) {
            // Handle simple text result for other templates
            container.innerHTML = `<div id="analysisContent" class="whitespace-pre-wrap">${data.result}</div>`;
            analysisCache[currentTemplateId] = container.innerHTML;
        }

        const analysisActionsEl = $("analysisActions");
        if (analysisActionsEl) analysisActionsEl.classList.remove("hidden");

        pendingAnalysisRequests.delete(parseInt(data.messageId));
        setLoading("generate", false);
    }

    // --- Auth Logic using Supabase ---
    async function handleLogin() {
        const email = $("loginEmail").value.trim();
        const password = $("loginPassword").value;
        const loginMessageEl = $("loginMessage");

        if (!email || !password) {
            showMessage("loginMessage", "Please fill in all fields", "error");
            return;
        }

        setLoading("login", true);
        loginMessageEl.classList.add("hidden");

        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) {
            showMessage("loginMessage", error.message, "error");
        } else {
            showMessage("loginMessage", "Login successful! Redirecting...", "success");
            setTimeout(() => navigateTo("home"), 1500);
        }
        setLoading("login", false);
    }

    async function handleRegister() {
        const firstName = $("registerFirstName").value.trim();
        const lastName = $("registerLastName").value.trim();
        const email = $("registerEmail").value.trim();
        const password = $("registerPassword").value;
        const confirmPassword = $("registerConfirmPassword").value;

        if (!firstName || !lastName || !email || !password || !confirmPassword) {
            showMessage("registerMessage", "Please fill in all fields", "error");
            return;
        }
        if (password !== confirmPassword) {
            showMessage("registerMessage", "Passwords do not match", "error");
            return;
        }
        if (password.length < 6) {
            showMessage("registerMessage", "Password must be at least 6 characters long", "error");
            return;
        }

        setLoading("register", true);
        try {
            const { data, error } = await supabase.functions.invoke("create-user-v3", {
                body: {
                    email,
                    password,
                    metadata: {
                        first_name: firstName,
                        last_name: lastName
                    }
                }
            });

            if (error || !data?.user) {
                showMessage("registerMessage", error?.message || "User creation failed.", "error");
                return;
            }

            $("registerForm").reset();
            navigateTo("emailVerification");
        } catch (err) {
            console.error("Register error:", err);
            showMessage("registerMessage", "An error occurred during registration. Please try again.", "error");
        } finally {
            setLoading("register", false);
        }
    }

    async function handleLogout() {
        await supabase.auth.signOut();
        navigateTo("login");
    }

    // --- UI Helpers ---
    function setLoading(type, isLoading) {
        const btn = $(type + "Btn");
        if (!btn) return;

        const textEl = $(type + "BtnText");
        const spinner = $(type + "Spinner");

        btn.disabled = isLoading;
        if (spinner) spinner.classList.toggle("hidden", !isLoading);

        if (textEl) {
            if (isLoading) {
                // Store original text if it's not already stored
                if (!btn.dataset.originalText) {
                    btn.dataset.originalText = textEl.textContent;
                }
                textEl.textContent = "Analyzing...";
            } else {
                // Restore original text
                textEl.textContent = btn.dataset.originalText || "Generate Analysis";
                // Clear the data attribute after use
                delete btn.dataset.originalText;
            }
        }
    }

    function showMessage(id, msg, type) {
        const el = $(id);
        if (!el) return;
        el.textContent = msg;
        el.className = type === "error" ? "error-message" : "success-message";
        if (msg) {
            el.classList.remove("hidden");
        } else {
            el.classList.add("hidden");
        }
        if (type === "success" && msg) {
            setTimeout(() => el.classList.add("hidden"), 4000);
        }
    }

    // --- Three.js Animation Logic ---
    let scene, camera, renderer, group;
    const particlesData = [];
    let positions, colors;
    let particlesGeometry;
    let pointCloud;
    let particlePositions;
    let linesMesh;
    let animationFrameId;

    const NUM_PARTICLES = 1000;
    const AREA_SIZE = 3000;
    const AREA_HALF = AREA_SIZE / 2;
    const MIN_DISTANCE = 200;

    let mouseX = 0,
        mouseY = 0;

    function createCircleTexture(size, color) {
        const canvas = document.createElement("canvas");
        canvas.width = size;
        canvas.height = size;
        const context = canvas.getContext("2d");
        const gradient = context.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2);
        gradient.addColorStop(0, color);
        gradient.addColorStop(0.7, color);
        gradient.addColorStop(1, "rgba(0,0,0,0)");
        context.fillStyle = gradient;
        context.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
        context.fill();
        return new THREE.CanvasTexture(canvas);
    }

    function initThreeJS() {
        const canvas = $("threeJsCanvas");
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000);
        camera.position.z = 3000;

        scene = new THREE.Scene();
        group = new THREE.Group();
        scene.add(group);

        const particleTexture = createCircleTexture(64, "rgba(173, 216, 230, 1)");

        const pMaterial = new THREE.PointsMaterial({
            color: 0xffffff,
            size: 7,
            blending: THREE.AdditiveBlending,
            transparent: true,
            sizeAttenuation: false,
            map: particleTexture
        });

        particlesGeometry = new THREE.BufferGeometry();
        particlePositions = new Float32Array(NUM_PARTICLES * 3);

        for (let i = 0; i < NUM_PARTICLES; i++) {
            const x = Math.random() * AREA_SIZE - AREA_HALF;
            const y = Math.random() * AREA_SIZE - AREA_HALF;
            const z = Math.random() * AREA_SIZE - AREA_HALF;

            particlePositions[i * 3] = x;
            particlePositions[i * 3 + 1] = y;
            particlePositions[i * 3 + 2] = z;

            particlesData.push({
                velocity: new THREE.Vector3(
                    (Math.random() - 0.5) * 0.5,
                    (Math.random() - 0.5) * 0.5,
                    (Math.random() - 0.5) * 0.5
                ),
                numConnections: 0
            });
        }

        particlesGeometry.setDrawRange(0, NUM_PARTICLES);
        particlesGeometry.setAttribute(
            "position",
            new THREE.BufferAttribute(particlePositions, 3).setUsage(THREE.DynamicDrawUsage)
        );

        pointCloud = new THREE.Points(particlesGeometry, pMaterial);
        group.add(pointCloud);

        const lineGeometry = new THREE.BufferGeometry();
        positions = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);
        colors = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);

        lineGeometry.setAttribute("position", new THREE.BufferAttribute(positions, 3).setUsage(THREE.DynamicDrawUsage));
        lineGeometry.setAttribute("color", new THREE.BufferAttribute(colors, 3).setUsage(THREE.DynamicDrawUsage));
        lineGeometry.computeBoundingSphere();
        lineGeometry.setDrawRange(0, 0);

        const lineMaterial = new THREE.LineBasicMaterial({
            vertexColors: true,
            blending: THREE.AdditiveBlending,
            transparent: true,
            opacity: 0.4
        });

        linesMesh = new THREE.LineSegments(lineGeometry, lineMaterial);
        group.add(linesMesh);

        renderer = new THREE.WebGLRenderer({
            canvas: canvas,
            antialias: true,
            alpha: true
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);

        startAnimationLoop();

        window.addEventListener("resize", onWindowResize);
        window.addEventListener("mousemove", onDocumentMouseMove);
    }

    function startAnimationLoop() {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);

        function loop() {
            animateThreeJS();
            animationFrameId = requestAnimationFrame(loop);
        }
        loop();
    }

    function onDocumentMouseMove(event) {
        mouseX = (event.clientX / window.innerWidth) * 2 - 1;
        mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
    }

    function animateThreeJS() {
        let vertexpos = 0;
        let colorpos = 0;
        let numConnected = 0;

        for (let i = 0; i < NUM_PARTICLES; i++) {
            particlesData[i].numConnections = 0;
        }

        for (let i = 0; i < NUM_PARTICLES; i++) {
            const particleData = particlesData[i];
            particlePositions[i * 3] += particleData.velocity.x;
            particlePositions[i * 3 + 1] += particleData.velocity.y;
            particlePositions[i * 3 + 2] += particleData.velocity.z;

            if (particlePositions[i * 3 + 1] < -AREA_HALF || particlePositions[i * 3 + 1] > AREA_HALF)
                particleData.velocity.y = -particleData.velocity.y;
            if (particlePositions[i * 3] < -AREA_HALF || particlePositions[i * 3] > AREA_HALF)
                particleData.velocity.x = -particleData.velocity.x;
            if (particlePositions[i * 3 + 2] < -AREA_HALF || particlePositions[i * 3 + 2] > AREA_HALF)
                particleData.velocity.z = -particleData.velocity.z;

            for (let j = i + 1; j < NUM_PARTICLES; j++) {
                const dx = particlePositions[i * 3] - particlePositions[j * 3];
                const dy = particlePositions[i * 3 + 1] - particlePositions[j * 3 + 1];
                const dz = particlePositions[i * 3 + 2] - particlePositions[j * 3 + 2];
                const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

                if (dist < MIN_DISTANCE) {
                    const alpha = 1.0 - dist / MIN_DISTANCE;
                    positions[vertexpos++] = particlePositions[i * 3];
                    positions[vertexpos++] = particlePositions[i * 3 + 1];
                    positions[vertexpos++] = particlePositions[i * 3 + 2];
                    positions[vertexpos++] = particlePositions[j * 3];
                    positions[vertexpos++] = particlePositions[j * 3 + 1];
                    positions[vertexpos++] = particlePositions[j * 3 + 2];

                    const lineColor = new THREE.Color(0xadd8e6);
                    colors[colorpos++] = lineColor.r * alpha;
                    colors[colorpos++] = lineColor.g * alpha;
                    colors[colorpos++] = lineColor.b * alpha;
                    colors[colorpos++] = lineColor.r * alpha;
                    colors[colorpos++] = lineColor.g * alpha;
                    colors[colorpos++] = lineColor.b * alpha;
                    numConnected++;
                }
            }
        }

        linesMesh.geometry.setDrawRange(0, numConnected * 2);
        linesMesh.geometry.attributes.position.needsUpdate = true;
        linesMesh.geometry.attributes.color.needsUpdate = true;
        pointCloud.geometry.attributes.position.needsUpdate = true;

        const rotationSpeed = 0.03;
        group.rotation.y += (mouseX * 0.05 - group.rotation.y) * rotationSpeed;
        group.rotation.x += (mouseY * 0.05 - group.rotation.x) * rotationSpeed;
        group.rotation.y += 0.0001;
        group.rotation.x += 0.00005;

        renderer.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // --- AI Analysis Examples Carousel Logic ---
    let currentExampleIndex = 0;
    const analysisExamples = document.querySelectorAll(".analysis-example-item");
    const prevExampleBtn = $("prevExampleBtn");
    const nextExampleBtn = $("nextExampleBtn");
    const exampleCounter = $("exampleCounter");

    function showAnalysisExample(index) {
        analysisExamples.forEach((item, i) => {
            item.classList.toggle("hidden", i !== index);
        });
        prevExampleBtn.disabled = index === 0;
        nextExampleBtn.disabled = index === analysisExamples.length - 1;
        exampleCounter.textContent = `${index + 1} of ${analysisExamples.length}`;
    }

    if (prevExampleBtn) {
        prevExampleBtn.addEventListener("click", () => {
            if (currentExampleIndex > 0) {
                currentExampleIndex--;
                showAnalysisExample(currentExampleIndex);
            }
        });
    }
    if (nextExampleBtn) {
        nextExampleBtn.addEventListener("click", () => {
            if (currentExampleIndex < analysisExamples.length - 1) {
                currentExampleIndex++;
                showAnalysisExample(currentExampleIndex);
            }
        });
    }
    if (analysisExamples.length > 0) {
        showAnalysisExample(currentExampleIndex);
    }

    // --- Initial Setup ---
    const versionModal = $("versionChoiceModal");
    const selectFreeBtn = $("selectFreeVersion");
    const selectPaidBtn = $("selectPaidVersion");
    const closeModalBtn = $("closeModalBtn");

    selectFreeBtn.addEventListener("click", () => {
        currentSelectionLimit = 1;
        proceedFromModal();
    });

    selectPaidBtn.addEventListener("click", () => {
        currentSelectionLimit = 3;
        proceedFromModal();
    });

    closeModalBtn.addEventListener("click", () => {
        versionModal.classList.add("hidden");
    });

    $("loginBtn").addEventListener("click", handleLogin);
    $("registerBtn").addEventListener("click", handleRegister);

    if (window.location.hash.includes("access_token")) {
        navigateTo("home");
    } else {
        navigateTo("home");
    }

    setupHomeTabs();
    attachHomeCardListeners();

    initThreeJS();

    // --- Dashboard Widget ---
    (function initDashboardWidget() {
        const PRESENCE_PREFIX = "sage_presence_";
        const HEARTBEAT_MS = 10000;
        const STALE_MS = 30000;
        const TAB_ID = crypto && crypto.randomUUID ? crypto.randomUUID() : Date.now() + "-" + Math.random();

        function heartbeat() {
            try {
                localStorage.setItem(PRESENCE_PREFIX + TAB_ID, String(Date.now()));
            } catch (e) {}
        }

        function cleanupStale() {
            const now = Date.now();
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.startsWith(PRESENCE_PREFIX)) {
                        const ts = Number(localStorage.getItem(k) || "0");
                        if (!ts || now - ts > STALE_MS) localStorage.removeItem(k);
                    }
                }
            } catch (e) {}
        }

        function countOnline() {
            const now = Date.now();
            let cnt = 0;
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.startsWith(PRESENCE_PREFIX)) {
                        const ts = Number(localStorage.getItem(k) || "0");
                        if (ts && now - ts <= STALE_MS) cnt++;
                    }
                }
            } catch (e) {}
            return cnt;
        }

        heartbeat();
        const hb = setInterval(() => {
            heartbeat();
            cleanupStale();
        }, HEARTBEAT_MS);
        window.addEventListener("beforeunload", () => {
            try {
                localStorage.removeItem(PRESENCE_PREFIX + TAB_ID);
            } catch (e) {}
            clearInterval(hb);
        });

        function updateDashboard() {
            const usersEl = document.getElementById("dashUsersOnline");
            const serverDot = document.getElementById("dashServerDot");
            const serverText = document.getElementById("dashServerText");
            const wsStatusEl = document.getElementById("wsStatus");

            if (usersEl) usersEl.textContent = String(countOnline());

            let statusText = "Unknown",
                statusClass = "bg-yellow-400";
            if (wsStatusEl) {
                const t = wsStatusEl.textContent.trim().toLowerCase();
                if (t.includes("connected")) {
                    statusText = "Connected";
                    statusClass = "bg-green-400";
                } else if (t.includes("disconnected") || t.includes("failed") || t.includes("error")) {
                    statusText = "Disconnected";
                    statusClass = "bg-red-400";
                } else if (t.includes("connecting")) {
                    statusText = "Connecting";
                    statusClass = "bg-yellow-400";
                }
            }

            if (serverText) serverText.textContent = statusText;
            if (serverDot) serverDot.className = "inline-block w-3 h-3 rounded-full " + statusClass;
        }
        setInterval(updateDashboard, 2000);
        updateDashboard();
    })();
});

    </script>

</body>

</html>
