<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SAGE AI - Strategy Assistant</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/lite.render.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4/dist/panzoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.33.1/dist/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs" type="module"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.plot.ly/plotly-3.3.0.min.js"></script>

    <style>
        /* --- THEME COLORS (CSS VARIABLES) --- */
        :root {
            /* Default (Purple/Pink) */
            --grad-1: #C33764;
            --grad-2: #1D2671;
            --primary: #8E2DE2;
            --primary-hover: #4A00E0;
            --accent: #C33764;
            --text-highlight: #a5b4fc; /* Matches indigo-300 */
        }

        /* 1. Ocean (Deep Navy -> Vibrant Cyan) */
        body.theme-ocean {
            --grad-1: #021B79; --grad-2: #0575E6;
            --primary: #00D2FF; --primary-hover: #009ec3; --accent: #2E3192; --text-highlight: #7dd3fc;
        }

        /* 2. Sunset (Hot Pink -> Intense Orange) */
        body.theme-sunset {
            --grad-1: #ee0979; --grad-2: #ff6a00;
            --primary: #FFD200; --primary-hover: #ffaa00; --accent: #ff6a00; --text-highlight: #fff3cd;
        }

        /* 3. Cyber (Pitch Black -> Neon Matrix Teal) */
        body.theme-cyber {
            --grad-1: #000000; --grad-2: #144355;
            --primary: #00ff00; --primary-hover: #00cc00; --accent: #00ffff; --text-highlight: #00ff00;
        }

        /* 4. Forest (Dark Pine -> Bright Fern) */
        body.theme-forest {
            --grad-1: #051937; --grad-2: #008793;
            --primary: #55efc4; --primary-hover: #00b894; --accent: #a3e635; --text-highlight: #86efac;
        }

        /* 5. Royal (Deep Violet -> Midnight Blue) */
        body.theme-royal {
            --grad-1: #2b5876; --grad-2: #4e4376;
            --primary: #F7B733; --primary-hover: #d49b20; --accent: #FFD700; --text-highlight: #FDE68A;
        }

        /* 6. Crimson (Blackened Red -> Bright Blood Red) */
        body.theme-crimson {
            --grad-1: #2b0404; --grad-2: #c75050;
            --primary: #ff4d4d; --primary-hover: #cc0000; --accent: #ff9f9f; --text-highlight: #fca5a5;
        }

        /* 7. Coffee (Dark Espresso -> Warm Latte) */
        body.theme-coffee {
            --grad-1: #2c221c; --grad-2: #a67c52;
            --primary: #d4a373; --primary-hover: #b0875d; --accent: #faedcd; --text-highlight: #e2c09f;
        }

        /* 8. Aurora (Night Sky Black -> Borealis Green/Teal) */
        body.theme-aurora {
            --grad-1: #000000; --grad-2: #1D976C;
            --primary: #93F9B9; --primary-hover: #1D976C; --accent: #00dbde; --text-highlight: #69ff97;
        }

        /* 9. Midnight (Deep Space Black -> Galactic Purple) */
        body.theme-midnight {
            --grad-1: #020024; --grad-2: #4e4ecb;
            --primary: #00d4ff; --primary-hover: #0088cc; --accent: #764ba2; --text-highlight: #c084fc;
        }

        /* 10. Candy (Vibrant Purple -> Hot Pink) */
        body.theme-candy {
            --grad-1: #4d2e53; --grad-2: #a672d4;
            --primary: #ff9a9e; --primary-hover: #ff6a88; --accent: #fad0c4; --text-highlight: #ffffff;
        }

        /* 11. Slate (Deep Charcoal -> Metallic Silver) */
        body.theme-slate {
            --grad-1: #1c1c1c; --grad-2: #4b4b4b;
            --primary: #d1d5db; --primary-hover: #9ca3af; --accent: #ffffff; --text-highlight: #f3f4f6;
        }

        /* --- GLOBAL THEME OVERRIDES (Comprehensive) --- */

        /* 1. TEXT & LOGO OVERRIDES */
        /* Forces the "SAGE AI" logo and any gradient text to use the theme colors */
        .text-transparent.bg-clip-text,
        a.text-transparent.bg-clip-text {
            background-image: linear-gradient(to right, var(--primary), var(--accent), var(--primary)) !important;
        }

        /* Replaces all "Indigo-300" text (used heavily in headers/subtitles) */
        .text-indigo-300, .text-purple-400, .text-pink-400, .text-blue-300, .text-green-300, .text-yellow-300 {
            color: var(--text-highlight) !important;
            transition: color 0.5s ease;
        }
        
        /* Hover states for links */
        .hover\:text-indigo-300:hover {
            color: var(--primary) !important;
        }

        /* 2. BACKGROUND GLOWS & GRADIENTS */
        /* This targets the glowing blur effect behind the Hero Title, Contact Card, and About Card */
        .from-indigo-500, .via-purple-500, .to-pink-500 {
            --tw-gradient-from: var(--primary) !important;
            --tw-gradient-to: var(--accent) !important;
            --tw-gradient-stops: var(--primary), var(--accent), var(--primary) !important;
        }
        
        /* Overrides specific background colors used in "How it Works" circles (About Us) */
        .bg-indigo-600, .bg-purple-600, .bg-pink-600, .bg-blue-600 {
            background-color: var(--primary) !important;
        }
        
        /* 3. INPUT FIELDS & FORMS (Contact Us / Feedback) */
        /* Changes the border color when you click an input */
        .focus\:border-indigo-500:focus {
            border-color: var(--primary) !important;
        }
        
        /* Changes the background color on focus/hover for inputs */
        .focus\:bg-indigo-500:focus, .hover\:bg-indigo-600:hover {
            background-color: var(--primary-hover) !important;
        }

        /* 4. BUTTON SHADOWS */
        /* Updates the colored shadow behind primary buttons */
        .shadow-indigo-500\/40, .shadow-indigo-500\/30, .shadow-indigo-500\/50 {
            --tw-shadow-color: color-mix(in srgb, var(--primary) 40%, transparent) !important;
            box-shadow: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -2px var(--tw-shadow-color) !important;
        }

        /* 5. BORDERS & DIVIDERS */
        .border-indigo-500, .border-white\/20, .border-white\/10 {
            /* Subtle tinting of borders to match theme */
            border-color: color-mix(in srgb, var(--primary) 30%, rgba(255,255,255,0.1)) !important;
        }

        /* 6. MODAL BACKGROUNDS */
        /* Ensures the Feedback/Settings/Contact modals use the main gradient */
        .feedback-modal-container {
            background: linear-gradient(-45deg, var(--grad-1), var(--grad-2)) !important;
            background-size: 400% 400%;
            animation: gradientBG 18s ease infinite;
            border-color: rgba(255,255,255,0.2) !important;
        }
        
        /* 7. NAVIGATION HOVER */
        .nav-link:hover {
            background: linear-gradient(90deg, var(--primary), var(--accent)) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            color: transparent !important;
        }
        
        /* 8. GENERIC UTILITY OVERRIDES */
        /* Any text-indigo-X needs to shift to the theme highlight */
        [class*="text-indigo-"] {
            color: var(--text-highlight) !important;
        }
        
        /* Any bg-indigo-X needs to shift to the primary color */
        [class*="bg-indigo-"] {
             background-color: var(--primary) !important;
        }


        /* --- PREVIEW SQUARES FOR SETTINGS --- */
        .theme-preview {
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid rgba(255,255,255,0.1);
            position: relative;
        }
        .theme-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }
        .theme-preview.active-theme {
            border-color: #fff;
            box-shadow: 0 0 0 2px #fff;
        }

        /* --- THEME FIX: FORCE BACKGROUND REFRESH --- */
        /* This selector matches any body tag with a class starting with "theme-" */
        body[class*="theme-"] {
            background-image: linear-gradient(-45deg, var(--grad-1), var(--grad-2)) !important;
            background-size: 400% 400%; /* Ensure size stays correct */
        }

        /* --- Base & Animated Background --- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, var(--grad-1), var(--grad-2));
            background-size: 400% 400%;
            animation: gradientBG 18s ease infinite;
            color: #f9fafb;
            width: 100vw;
        }

        /* Firefox Fix (Keeps logic consistent) */
        @supports (-moz-appearance:none) {
            .site-scaler {
                width: 100%;
                /* CALCULATION: 100vh divided by 0.85 (zoom) = ~117.65vh.
                This forces the container to be exactly the height of the 
                viewport even when zoomed out.
                */
                min-height: 117.65vh; 
                
                display: flex;
                flex-direction: column;
                zoom: 85%;
            }
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .page {
            display: none;
        }

        /* Hide all pages by default */
        .page.active {
            animation: fadeIn .5s ease-out;
        }

        /* Specific display rules for active pages */
        #home.active,
        #templates.active,
        #templateDetail.active,
        #examplesPage.active,
        #adminDashboard.active,
        #about.active {
            display: block;
            /* Content pages */
        }

        #login.active,
        #signup.active,
        #emailVerification.active,
        #emailVerifiedSuccess.active,
        #emailVerifiedAlready.active,
        #passwordResetRequest.active,
        #passwordResetUpdate.active,
        #about.active,
        #privacyPolicy.active,
        #termsOfService.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        /* --- Glass & Card Effects --- */
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.75rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            transition: all .3s ease;
            text-align: center;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .template-card,
        .project-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: all .3s ease;
            cursor: pointer;
        }

        .template-card:hover,
        .project-card:hover {
            transform: translateY(-5px);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .project-card-content {
            display: -webkit-box;
           -webkit-line-clamp: 3;
           line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* --- Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(220, 38, 38, 0.5);
            color: #fca5a5;
        }

        .btn-danger:hover {
            background: rgba(220, 38, 38, 0.7);
            color: #fff;
        }

        .btn-tertiary {
            background: transparent;
            color: #c7d2fe;
            text-decoration: underline;
        }

        .btn-tertiary:hover {
            color: #fff;
        }

        /* --- NEW: Button for Use Sample --- */
        .btn-sample {
            padding: 0.25rem 0.75rem; /* Small padding */
            font-size: 0.75rem;        /* Small text */
            border-radius: 0.5rem;     /* Matches .btn */
            font-weight: 600;          /* Matches .btn */
            cursor: pointer;
            transition: all .2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;

            /* --- The New Prominent Style --- */
            background-color: #10B981;
            color: white;
            border: 1px solid #10B981;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .btn-sample:hover {
            background-color: #059669;
            border-color: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* Style for when it's loaded */
        .btn-sample:disabled {
            background-color: rgba(5, 150, 105, 0.8);
            color: #a7f3d0;
            border-color: transparent;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- Forms & Inputs --- */
        .input-field {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-field:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .error-message {
            color: #fca5a5;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(220, 38, 38, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .success-message {
            color: #a7f3d0;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(5, 150, 105, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        /* --- Loading Spinners --- */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 2rem;
        }

        .typing-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            animation: typing 1.4s infinite ease-in-out
        }

        .typing-dot:nth-child(1) {
            animation-delay: -.32s
        }

        .typing-dot:nth-child(2) {
            animation-delay: -.16s
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0s
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(.8);
                opacity: .5
            }

            40% {
                transform: scale(1);
                opacity: 1
            }
        }

        /* --- Three.js Canvas Styling --- */
        #threeJsCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            display: block;
            pointer-events: none;
        }

        /* --- SCALER: Applies Zoom & Sticky Footer Logic --- */
        .site-scaler {
            display: flex;
            flex-direction: column;
            
            /* DEFAULT (Chrome/Edge/Safari) */
            width: 100%;
            min-height: 117.65vh; /* Compensates for zoom */
            zoom: 85%;
        }

        /* --- FIREFOX SPECIFIC FIX --- */
        @supports (-moz-appearance:none) {
            .site-scaler {
                /* 1. Disable standard zoom */
                zoom: 1;

                /* 2. Scale using transform */
                transform: scale(0.85);
                transform-origin: top center;

                /* 3. Compensate Width & Height 
                (100% / 0.85 = 117.647%) 
                This ensures the content fills the screen edge-to-edge 
                after being scaled down. */
                width: 117.647%;
                min-height: 117.647vh;

                /* 4. Prevent horizontal scrollbar caused by the wide container */
                margin-bottom: -17.647vh; /* Pull bottom up to remove dead space */
            }
            
            /* Ensure body clips the "wide" container so no scrollbar appears */
            body {
                overflow-x: hidden;
            }
        }


        /* Carousel specific styles */
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 9999px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: background 0.3s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .carousel-button:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .carousel-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .carousel-button.left {
            left: -6rem;
        }

        .carousel-button.right {
            right: -6rem;
        }

        @media (max-width: 768px) {
            .carousel-button.left {
                left: 0.5rem;
            }

            .carousel-button.right {
                right: 0.5rem;
            }
        }

        .analysis-example-item {
            padding: 2.5rem;
            margin-bottom: 0;
        }

        .analysis-example-item h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .analysis-example-item ul,
        .analysis-example-item ol {
            list-style-position: inside;
            margin-left: 1.25rem;
            margin-bottom: 1rem;
        }

        .analysis-example-item li {
            margin-bottom: 0.5rem;
        }

        .feature-card .feature-description ul,
        .feature-card .feature-description ol,
        .feature-card .feature-description p {
            text-align: center;
        }

        /* WebSocket connection status indicator */
        .ws-status {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .ws-status.connected {
            background: rgba(5, 150, 105, 0.8);
            color: #a7f3d0;
        }

        .ws-status.disconnected {
            background: rgba(220, 38, 38, 0.8);
            color: #fca5a5;
        }

        .ws-status.connecting {
            background: rgba(245, 158, 11, 0.8);
            color: #fbbf24;
        }

        /* Glassy Checkboxes */
        .method-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .method-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
        }
        .method-checkbox:disabled + span {
            opacity: 0.5;
        }

        .method-checkbox:checked {
            background: color-mix(in srgb, var(--primary) 80%, transparent);
            border-color: color-mix(in srgb, var(--accent) 90%, transparent);
            box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 70%, transparent);
            transform: scale(1.15);
        }

        .method-checkbox:hover:not(:disabled) {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.7);
        }
        
        /* --- Custom File Input --- */
        .input-file-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .input-file {
            position: absolute;
            font-size: 50px;
            opacity: 0;
            right: 0;
            top: 0;
            cursor: pointer;
        }
        .input-file-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
        }
        .input-file-btn:hover {
             background: rgba(255, 255, 255, 0.1);
             border-color: var(--accent);
        }
        .input-file-btn.has-file {
            color: white;
            border-color: var(--accent);
            background: color-mix(in srgb, var(--primary) 20%, transparent);
        }
        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 0.5rem;
        }

        /* --- Interactive Hover for Guide Cards --- */
        #about .glass-container {
            transition: all 0.3s ease-in-out;
        }

        #about .glass-container:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Footer Styling */
        footer {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .main-content {
            /* flex-grow: 1 pushes the footer down to the bottom */
            flex: 1 0 auto; 
            display: flex;
            flex-direction: column;
        }
        footer {
            flex-shrink: 0;
            width: 100%;
            margin-top: auto; /* Extra safety to push it down */
        }

        /* --- Analysis Results Tab Styling --- */
        .analysis-tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .analysis-tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }
        .analysis-tab-btn.active {
            color: white;
            font-weight: 600;
            border-bottom-color: var(--accent);
        }
        .analysis-tab-panel {
            display: none;
            padding-top: 1.5rem;
            animation: fadeIn 0.5s;
        }
        .analysis-tab-panel.active {
            display: block;
        }

        /* --- Home Page Tab Styling --- */
        .home-tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }
        .home-tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .home-tab-btn.active {
            color: white;
            font-weight: 600;
            border-bottom-color: var(--primary);
        }
        .home-tab-panel {
            display: none;
            animation: fadeIn 0.5s;
        }
        .home-tab-panel.active {
            display: grid;
        }

        /* SWOT Tool specific styles */
        .input-radio-group {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 0.25rem;
        }
        .input-radio-label {
            flex: 1;
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .input-radio-label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .input-radio:checked + .input-radio-label {
            background: var(--primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .input-radio {
            display: none;
        }

        /* Archetype & Factor Analysis Tool Specific Styles */
        .metric-card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
            margin-bottom: 1rem;
        }
        .metric-card.critical {
            border-left-color: #dc143c;
        }
        .metric-card.high {
            border-left-color: #ff8c00;
        }

        /* --- Strategic Map Diagram Styles --- */
        .strategy-map-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem; /* 24px */
            padding-bottom: 2rem; /* Add some padding to the bottom */
        }

        /* Generic vertical line connecting sections */
        .vertical-connector {
            width: 2px;
            background-color: rgba(255, 255, 255, 0.4);
            height: 40px; /* Standard height for connectors */
            position: relative;
        }
        /* Downward arrow head for generic connectors */
        .vertical-connector::after {
            content: '';
            position: absolute;
            left: -5px;
            bottom: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid rgba(255, 255, 255, 0.4);
        }

        /* Container for the Feedback Loops, allowing horizontal alignment */
        .feedback-loops-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 2rem; /* Spacing between loop boxes */
            width: 100%;
            max-width: 900px; /* Control max width for better readability */
        }
        @media (max-width: 768px) {
            .feedback-loops-grid {
                grid-template-columns: 1fr; /* Stack on smaller screens */
            }
        }

        /* Lines from feedback loops to interventions header */
        .lines-to-interventions {
            display: flex;
            justify-content: center;
            width: 100%;
            height: 40px; /* Space for the lines */
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        /* Line from Reinforcing Loop */
        .lines-to-interventions::before {
            content: '';
            position: absolute;
            left: 25%; /* Roughly center of the left box */
            top: 0;
            width: 2px;
            height: 100%;
            background-color: rgba(46, 139, 87, 0.6); /* Greenish for reinforcing */
        }

        /* Line from Balancing Loop */
        .lines-to-interventions::after {
            content: '';
            position: absolute;
            right: 25%; /* Roughly center of the right box */
            top: 0;
            width: 2px;
            height: 100%;
            background-color: rgba(255, 140, 0, 0.6); /* Orangish for balancing */
        }

        /* Individual initiative connection indicators */
        .initiative-target-indicator {
            position: absolute;
            top: -25px; /* Position above the card */
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem; /* Larger icon */
            line-height: 1;
        }
        /* Specific colors for indicators */
        .indicator-boost { color: #28a745; /* Bootstrap success green */ }
        .indicator-mitigate { color: #ffc107; /* Bootstrap warning yellow */ }

        /* --- Strategic Cascade Styles --- */
        .cascade-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            padding: 2rem 1rem;
        }
        .cascade-objective {
            width: 100%;
            max-width: 700px;
            text-align: center;
            padding: 1.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            border-top: 4px solid var(--primary);
        }
        .cascade-connector {
            width: 2px;
            height: 40px;
            background: rgba(255,255,255,0.3);
        }
        .cascade-goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            width: 100%;
            max-width: 1200px;
        }
        .cascade-goal-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--accent);
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .cascade-strategy {
            background: rgba(0,0,0,0.2);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

        /* --- Action Plan Timeline Styles --- */
        .action-plan-container {
            position: relative;
            padding: 2rem 0;
        }
        .action-plan-container::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            transform: translateX(-50%);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 2.5rem;
            width: 50%;
        }
        .timeline-item:nth-child(odd) {
            padding-right: 2.5rem;
            align-self: flex-start;
        }
        .timeline-item:nth-child(even) {
            padding-left: 2.5rem;
            align-self: flex-end;
        }
        .timeline-dot {
            content: '';
            position: absolute;
            top: 1rem;
            width: 20px;
            height: 20px;
            background: var(--background-dark);
            border-radius: 50%;
            border: 4px solid var(--primary);
        }
        .timeline-item:nth-child(odd) .timeline-dot {
            right: -10px;
            transform: translateX(50%);
        }
        .timeline-item:nth-child(even) .timeline-dot {
            left: -10px;
            transform: translateX(-50%);
        }
        .timeline-content {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.75rem;
        }
        .priority-high { border-left: 4px solid #dc2626; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #2563eb; }

        /* --- KPI Dashboard Styles --- */
        .kpi-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .kpi-card .kpi-name {
            font-size: 1.125rem;
            font-weight: bold;
            color: white;
        }
        .kpi-card .kpi-target {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0.5rem 0;
            line-height: 1.2;
        }
        .kpi-card .kpi-type {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.1);
            align-self: center;
        }

        /* --- Misc Tool: Risk Table Styles --- */
        .risk-pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            min-width: 80px;
        }
        .risk-level-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        .risk-level-medium {
            background-color: rgba(249, 115, 22, 0.2);
            color: #fdba74;
        }
        .risk-level-low {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        /* --- Strategic Horizons Visual Styles --- */
        .horizons-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1 / 1;
            margin: 2rem auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .horizon-circle {
            position: absolute;
            border-style: dashed;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #h3-circle { width: 100%; height: 100%; border: 2px dashed rgba(255, 255, 255, 0.2); }
        #h2-circle { width: 70%; height: 70%; border: 2px dashed rgba(255, 255, 255, 0.3); }
        #h1-circle { width: 40%; height: 40%; border: 2px dashed rgba(255, 255, 255, 0.4); }
        .horizon-label {
            position: absolute;
            top: 10px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
        }
        .main-goal-center {
            width: 33%; /* Increased size */
            height: 33%; /* Increased size */
            background: rgba(var(--primary-rgb), 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
            font-weight: bold;
            font-size: 0.9rem; /* Adjusted font size */
            z-index: 10;
        }
        .initiative-point {
            position: absolute;
            background: rgba(0,0,0,0.5);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 130px; /* Added max-width for wrapping */
            text-align: center;
        }
        .initiative-point:hover {
            transform: scale(1.1) translate(-50%, -50%); /* Adjusted for proper scaling */
            background: var(--primary);
            z-index: 20;
        }

        /* --- Regression Analysis Table Styles --- */
        .coeff-table {
            width: 100%;
            text-align: left;
            border-collapse: collapse;
        }
        .coeff-table th, .coeff-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .coeff-table th {
            font-weight: 600;
            background-color: rgba(0,0,0,0.2);
        }
        .coeff-table .significant {
            color: #6ee7b7; /* A light green for significant p-values */
            font-weight: bold;
        }

        /* --- PLS-SEM Path Diagram Styles (New Flow Method) --- */
        .path-flow-container {
            display: flex;
            justify-content: space-between;
            gap: 2rem;
            padding: 2rem;
        }
        .path-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .path-column-title {
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 1rem;
        }
        .path-node-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            width: 100%;
            text-align: center;
        }
        .path-node-card h4 {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
        }
        .path-influence-list {
            margin-top: 1rem;
            font-size: 0.9rem;
            text-align: left;
        }
        .path-influence-list strong {
            color: white;
        }
        .path-influence {
            color: rgba(255,255,255,0.7);
        }
        .path-influence.significant {
            color: var(--accent);
            font-weight: bold;
        }

        /* --- Descriptive Analysis Styles --- */
        .summary-stat-card {
            background: rgba(0,0,0,0.25);
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .summary-stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
        }
        .summary-stat-card .stat-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.8);
            margin-top: 0.5rem;
        }

        /* --- Styling for SEM Learn Tab --- */
        .styled-table {
            border-collapse: collapse;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .styled-table th,
        .styled-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .styled-table thead th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: white;
        }
        .styled-table tbody tr:last-child td {
            border-bottom: none;
        }
        .styled-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        .styled-details {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
        }
        .styled-details summary {
            padding: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 0.5rem;
        }
        .styled-details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .styled-details summary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .styled-details pre {
            white-space: pre-wrap; /* Allow syntax to wrap */
        }
        /* --- Styling for SEM Analysis Model Tab --- */
        .model-section-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 1.5rem;
            height: 100%;
        }

        /* --- Prescriptive Analysis Styles --- */
        .prescription-card {
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            border-left: 5px solid var(--primary);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .prescription-card h4 {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        .prescription-card .rationale {
            font-style: italic;
            color: rgba(255,255,255,0.8);
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
        }

        /* --- Prescriptive Analysis - Enhanced Styles --- */
        .dashboard-prescription-card {
            background: rgba(0,0,0,0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border-left: 4px solid var(--accent);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .insight-card {
            background: rgba(0,0,0,0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Regression Analysis - Enhanced Styles --- */
        .diagnostic-card {
            background: rgba(0,0,0,0.2);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .diagnostic-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }
        .diagnostic-card .stat-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.25rem;
        }
        /* --- Visualization Tool Styles --- */
        .viz-interpretation-box {
            background: rgba(0,0,0,0.2);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            border-top: 2px solid var(--primary);
        }
        /* --- System Thinking Objectives Styles --- */
        .st-dashboard-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            padding: 2rem;
        }
        .st-objective-card {
            background: rgba(var(--primary-rgb), 0.2);
            border: 1px solid var(--primary);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }
        .st-goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            position: relative;
        }
        .st-goal-card {
            background: rgba(0,0,0,0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .st-loops-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        /* --- System Thinking Actions Styles --- */
        .action-card {
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .action-card.short-term { border-left: 5px solid #f59e0b; }
        .action-card.long-term { border-left: 5px solid #2563eb; }
        
        .action-card h4 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .archetype-card {
            background: rgba(var(--primary-rgb), 0.2);
            border: 1px solid var(--primary);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }
        /* --- Creative Dissonance Styles --- */
        .dissonance-map-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            gap: 2rem;
        }
        .dissonance-pole {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .dissonance-gap {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        .dissonance-point {
            background: rgba(var(--primary-rgb), 0.2);
            border: 1px solid var(--primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
        }
        /* --- Living System Analysis Styles --- */
        .ls-dashboard-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 500px;
            padding: 2rem;
        }
        .ls-core {
            width: 200px;
            height: 200px;
            background: rgba(var(--primary-rgb), 0.3);
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }
        .ls-system-node {
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
        }
        .ls-health-robust { border-top: 4px solid #22c55e; } /* green */
        .ls-health-strained { border-top: 4px solid #f97316; } /* orange */
        .ls-health-fragile { border-top: 4px solid #ef4444; } /* red */
        /* --- Thinking System (Ladder of Inference) Styles --- */
        .ladder-container {
            display: flex;
            flex-direction: column-reverse; /* Build the ladder from the bottom up */
            align-items: center;
            gap: 0.5rem;
            padding: 2rem;
        }
        .ladder-rung {
            width: 100%;
            max-width: 600px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .ladder-rung h4 {
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .ladder-rung p {
            font-size: 1.125rem;
            font-style: italic;
            color: rgba(255,255,255,0.9);
        }
        .ladder-arrow {
            font-size: 2rem;
            color: rgba(255,255,255,0.4);
            transform: rotate(90deg);
        }
        
        /* --- Predictive Styling --- */

        /* --- Custom Select Dropdown Styling --- */
        .select-wrapper {
            position: relative;
        }

        select.input-field {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 2.5rem; /* Make space for the arrow */
        }

        /* Custom Arrow using SVG */
        .select-wrapper::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 1rem;
            width: 1rem;
            height: 1rem;
            transform: translateY(-50%);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='rgba(255,255,255,0.7)' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none; /* Allows clicks to go through to the select element */
        }

        /* Style the dropdown options list */
        select.input-field option {
            background: #1d2671; /* A dark color from your gradient */
            color: #f9fafb;
        }

        /* --- Predictive Forecast Table Styling --- */
        .forecast-table thead th {
            background-color: #3b429f; /* Blue from your image */
            color: white;
        }

        .forecast-table tbody td {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }

        .forecast-table tbody td strong {
            color: #f0f0f0; /* Slightly brighter for emphasis */
            font-weight: 600;
        }

        #mermaidPanel {
            width: 100%;
            height: 500px; /* Adjust height as needed */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem;	/* The amount of rounding you want to apply */
            overflow: hidden; /* So content inside is also rounded */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            background-color: rgba(30, 30, 30, 0.8); 	/* Slightly transparent background */
            padding: 1.5rem;
        }

        #fishboneCy {
            position: relative;
            width: 90%;
            height: 500px; /* Adjust height as needed */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem;	/* The amount of rounding you want to apply */
            overflow: hidden; /* So content inside is also rounded */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            background-color: rgba(25, 25, 25, 0.8); 	/* Slightly transparent background */
            padding: 1.5rem;
            margin: auto;
        }

        .diagram-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin: auto;
            padding: 20px 32px;
            background: transparent;
        }

        .diagram-fit-btn, .diagram-reset-btn, .diagram-export-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .diagram-fit-btn:hover, .diagram-reset-btn:hover, .diagram-export-btn:hover {
            background: #5568d3;
        }

        .diagram-fit-btn:active, .diagram-reset-btn:active, .diagram-export-btn:active {
            transform: scale(0.98);
        }

        .error {
            color: #e74c3c;
            margin-top: 8px;
            font-size: 14px;
        }

        #cy-tooltip {
            pointer-events: none !important;
        }

        /* --- Feedback Tab Styles --- */
        .feedback-tabs {
            display: flex;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }
        .feedback-tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px; /* Aligns with the border */
        }
        .feedback-tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }
        .feedback-tab-btn.active {
            color: white;
            font-weight: 600;
            border-bottom-color: var(--primary);
        }

        .feedback-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .feedback-card:hover {
            transform: translateY(-3px);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .feedback-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-right: 0.5rem;
            line-height: 1.2;
        }
        /* Re-using your risk-pill colors and adding new ones */
        .tag-priority-high { background-color: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .tag-priority-medium { background-color: rgba(249, 115, 22, 0.2); color: #fdba74; }
        .tag-priority-low { background-color: rgba(59, 130, 246, 0.2); color: #93c5fd; }

        .tag-status-open { background-color: rgba(34, 197, 94, 0.2); color: #86efac; }
        .tag-status-in progress { background-color: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .tag-status-pending { background-color: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .tag-status-resolved { background-color: rgba(168, 85, 247, 0.2); color: #d8b4fe; }

        .tag-type { background-color: rgba(255, 255, 255, 0.1); color: #e5e7eb; }

        .star-rating {
            display: flex;
            align-items: center;
            gap: 0.15rem;
            color: #f59e0b; /* Amber/Yellow */
        }
        .star-rating .star-empty {
            color: rgba(255, 255, 255, 0.3);
        }

        /* Beautiful Feedback Modal Styles */

        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .feedback-modal.modal-open {
            opacity: 1;
        }

        .feedback-modal-container {
            width: 90vw;
            max-width: 1000px;
            max-height: 90vh;
            background: linear-gradient(-45deg, var(--grad-1), var(--grad-2));
            background-size: 400% 400%;
            animation: gradientBG 18s ease infinite;
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .feedback-modal.modal-open .feedback-modal-container {
            transform: scale(1);
        }

        .modal-header {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .modal-title-section {
            flex: 1;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin: 0 0 0.5rem 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            line-height: 1.2;
        }

        .modal-rating {
            margin-top: 0.5rem;
        }

        .modal-close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            margin-left: 1rem;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .modal-body {
        /* Responsive padding: smaller on mobile */
        padding: 1rem; 
        max-height: 80vh;
        overflow-y: auto;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .modal-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .modal-content-section {
            margin-bottom: 1rem;
        }

        .modal-section-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            margin-bottom: 1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .modal-feedback-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1rem;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-info-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .modal-info-card:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .modal-info-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-info-value {
            font-size: 1rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.25rem;
        }

        .modal-info-sub {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
            overflow-wrap: break-word;
        }

        .modal-actions-section,
        .modal-status-section {
            margin-bottom: 1.25rem;
        }

        .modal-notes-section {
            margin-bottom: 0;
        }

        .modal-action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .modal-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-decoration: none;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-btn:active {
            transform: translateY(0);
        }

        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white;
            border-color: var(--primary);
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--primary));
            border-color: var(--primary-hover);
        }

        .modal-btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: #10b981;
        }

        .modal-btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            border-color: #059669;
        }

        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-color: rgba(255, 255, 255, 0.25);
        }

        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .modal-btn-icon {
            font-size: 1.25rem;
        }

        .modal-status-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .modal-select {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .modal-select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .modal-select option {
            background: var(--grad-2);
            color: white;
        }

        .modal-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .modal-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .modal-textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .modal-message {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-message-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #86efac;
        }

        .modal-message-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }

        /* Enhanced feedback tags in modal */
        .modal-tags .feedback-tag {
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .modal-tags .feedback-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        /* Enhanced star rating in modal */
        .modal-rating .star-rating {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .modal-rating .star-rating .star-filled {
            color: #fbbf24;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        @media (min-width: 768px) {
            .modal-body {
            padding: 1.5rem 1.5rem 3.5rem;
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .feedback-modal-container {
                width: 95vw;
                max-height: 95vh;
                border-radius: 1rem;
            }
            
            .modal-header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .modal-close-btn {
                position: absolute;
                top: 1rem;
                right: 1rem;
                margin: 0;
            }
            
            .modal-body {
                padding: 1.5rem 1.5rem 3.5rem; /* <-- Add the 3.5rem bottom padding */
                max-height: 80vh; /* <-- Match your 80vh height */
            }
            
            .modal-title {
                font-size: 1.5rem;
                padding-right: 3rem;
            }
            
            .modal-action-buttons {
                grid-template-columns: 1fr;
            }
            
            .modal-status-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .modal-info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Smooth animations */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes modalFadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        /* Hero Canvas Animation */
        #heroCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Floating Labels */
        .floating-label {
            position: absolute;
            left: 1rem;
            top: 1rem;
            color: rgba(255, 255, 255, 0.6);
            pointer-events: none;
            transition: all 0.2s ease;
            background: linear-gradient(-45deg, var(--grad-1), var(--grad-2));
            padding: 0 0.25rem;
        }

        .input-field:focus + .floating-label,
        .input-field:not(:placeholder-shown) + .floating-label {
            top: -0.5rem;
            left: 0.75rem;
            font-size: 0.75rem;
            color: var(--accent);
        }

        /* Enhanced Tool Cards */
        .feature-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .feature-card:hover::before {
            left: 100%;
        }

        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /* Live Stats Animation */
        .stat-item {
            position: relative;
            overflow: hidden;
        }

        .stat-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-item:hover::after {
            transform: scaleX(1);
        }

        /* Enhanced Buttons */
        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        /* --- ENHANCED HOME TABS ANIMATION --- */

        /* The Button Itself */
        .home-tab-btn {
            position: relative;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            padding: 0.75rem 1rem;
            transition: color 0.3s ease, text-shadow 0.3s ease;
            /* Remove old border transition to prevent conflict */
            border-bottom: 2px solid transparent; 
        }

        .home-tab-btn:hover {
            color: white;
        }

        /* The Sliding Glow Line (Pseudo-element) */
        .home-tab-btn::after {
            content: '';
            position: absolute;
            bottom: -2px; /* Align perfectly with the bottom */
            left: 0;
            width: 100%;
            height: 3px;
            /* Premium Gradient */
            background: linear-gradient(90deg, var(--primary), var(--accent));
            box-shadow: 0 -2px 10px rgba(142, 45, 226, 0.4); /* Subtle glow upwards */
            /* Animation State: Hidden */
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Active State */
        .home-tab-btn.active {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); /* Text glow */
        }

        /* Animation State: Visible */
        .home-tab-btn.active::after {
            transform: scaleX(1);
            transform-origin: left;
        }

        /* Content Panel Transitions */
        .home-tab-panel {
            opacity: 0;
            transform: translateY(15px); /* Start slightly lower */
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            display: none; /* Hidden by default */
        }

        /* Class to trigger the fade-in-up */
        .home-tab-panel.active-anim {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsive Grid */
        @media (max-width: 768px) {
            .home-tab-btn {
                font-size: 0.875rem;
                padding: 0.5rem 1rem;
            }
            
            .feature-card {
                margin-bottom: 1rem;
            }
        }

        /* Dark mode adjustments */
        @media (prefers-color-scheme: dark) {
            .feature-card {
                background: rgba(0, 0, 0, 0.3);
            }
        }

       /* --- CLICK ME ANIMATION FOR TOOLS --- */
        
        .home-template-link {
            position: relative;
            z-index: 1;
            overflow: hidden; /* Keeps the badge cut off cleanly at the edges */
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* The "Click Me" Badge - OBLIQUE TOP RIGHT */
        .home-template-link::after {
            content: " Click Me!";
            position: absolute;
            
            /* Position: Top Right Corner */
            top: 12px;
            right: -12px;  /* Pull it slightly off-screen for that "tucked" look */
            
            /* Oblique Angle */
            transform: rotate(35deg);
            
            /* Badge Styling */
            background: #F59E0B; 
            color: #000000;      
            font-weight: 800;
            
            /* Small & Unobtrusive */
            font-size: 0.5rem; 
            padding: 3px 15px; /* Wider padding makes it look like a ribbon */
            
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 99px;
            
            /* Effects */
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 20;
            pointer-events: none; 
            
            /* Animation */
            animation: badgePulseOblique 2s infinite;
        }

        /* Updated Pulse Animation that preserves the Rotation */
        @keyframes badgePulseOblique {
            0% { 
                transform: rotate(35deg) scale(1); 
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); 
            }
            70% { 
                transform: rotate(35deg) scale(1.1); /* Gentle pulse */
                box-shadow: 0 0 0 4px rgba(245, 158, 11, 0); 
            }
            100% { 
                transform: rotate(35deg) scale(1); 
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); 
            }
        }

        /* HOVER STATE: Highlight the whole card */
        .home-template-link:hover {
            transform: translateY(-5px) scale(1.02);
            background: rgba(255, 255, 255, 0.12);
            border-color: #F59E0B; 
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 
                        0 0 15px rgba(245, 158, 11, 0.2);
        }

        .home-template-link:hover h3,
        .home-template-link:hover p {
            opacity: 0.9;
        }

        /* --- Blog Article Styling --- */
        
        /* 1. Make the container readable but wide */
        #blogDetailContent {
            max-width: 1000px; /* Wider reading area */
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3); /* Slightly darker background for readability */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 2. Typography for the injected article content */
        .article-content {
            color: #f3f4f6; /* Tailwind gray-100 */
            line-height: 1.8;
            font-size: 1.125rem; /* Tailwind text-lg */
        }

        /* Headings */
        .article-content h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: linear-gradient(90deg, #a78bfa, #f472b6); /* Purple to Pink gradient */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .article-content h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            color: #818cf8; /* Indigo-400 */
        }

        .article-content h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 0.75rem;
            color: #34d399; /* Emerald-400 */
        }

        /* Paragraphs & Lists */
        .article-content p {
            margin-bottom: 1.5rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .article-content ul, 
        .article-content ol {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
            list-style-position: outside;
        }

        .article-content ul { list-style-type: disc; }
        .article-content ol { list-style-type: decimal; }

        .article-content li {
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .article-content strong {
            color: white;
            font-weight: 700;
        }

        /* Blockquotes */
        .article-content blockquote {
            border-left: 4px solid #f472b6; /* Pink border */
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem 1.5rem;
            margin: 2rem 0;
            font-style: italic;
            color: rgba(255, 255, 255, 0.8);
            border-radius: 0 0.5rem 0.5rem 0;
        }

        /* Citations (Superscript style) */
        .citation {
            font-size: 0.75em;
            color: #9ca3af; /* Gray-400 */
            vertical-align: super;
            margin-left: 2px;
        }

        /* --- NEW ADMIN LAYOUT: Vertical Command Center --- */

        /* 1. The Grid Wrapper */
        .admin-layout-wrapper {
            display: grid;
            grid-template-columns: 280px 1fr; /* Sidebar | Content */
            gap: 2rem;
            min-height: 600px;
        }

        /* 2. Left Sidebar Navigation */
        .admin-sidebar {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: fit-content;
            position: sticky;
            top: 100px; /* Stick on scroll */
            backdrop-filter: blur(10px);
        }

        .admin-sidebar-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-nav-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Sidebar Buttons */
        .admin-side-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem;
            border-radius: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s ease;
            text-align: left;
            background: transparent;
            border: 1px solid transparent;
        }

        .admin-side-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            transform: translateX(5px);
        }

        .admin-side-btn.active {
            background: linear-gradient(90deg, rgba(142, 45, 226, 0.2), transparent);
            border-left: 4px solid var(--primary);
            color: white;
            font-weight: 600;
        }

        .admin-btn-icon {
            font-size: 1.25rem;
            margin-right: 1rem;
            width: 24px;
            text-align: center;
        }

        /* 3. Right Content Area */
        .admin-content-area {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* 4. HUD (Heads Up Display) Stats Row */
        .admin-hud-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .admin-hud-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .admin-hud-val {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            line-height: 1.2;
        }

        .admin-hud-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.25rem;
        }

        /* 5. Refresh Button Styling within Sidebar */
        .admin-refresh-wrapper {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Mobile Responsiveness */
        @media (max-width: 1024px) {
            .admin-layout-wrapper {
                grid-template-columns: 1fr; /* Stack vertically */
            }
            .admin-sidebar {
                position: relative;
                top: 0;
            }
            .admin-nav-group {
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }
            .admin-side-btn {
                width: auto;
                white-space: nowrap;
                border-left: 1px solid transparent; /* Reset border for mobile */
            }
            .admin-side-btn.active {
                border-left: 1px solid transparent;
                border-bottom: 4px solid var(--primary);
                background: linear-gradient(0deg, rgba(142, 45, 226, 0.2), transparent);
            }
        }

            /* --- New Metric Tile Styling --- */

        /* The grid container for the metrics */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 columns by default */
            gap: 1rem;
        }

        /* Individual Metric Tile */
        .metric-tile {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
        }

        .metric-tile:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .metric-tile.full-width {
            grid-column: span 2; /* Spans across */
        }

        .metric-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-value {
            font-family: 'Monaco', 'Consolas', monospace; /* Tech font */
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.green { background-color: #10B981; box-shadow: 0 0 8px #10B981; }
        .status-dot.blue { background-color: #3B82F6; box-shadow: 0 0 8px #3B82F6; }
        .status-dot.purple { background-color: #8B5CF6; box-shadow: 0 0 8px #8B5CF6; }

        /* Specific Colors for Values */
        .val-green { color: #34D399; }
        .val-blue { color: #60A5FA; }
        .val-purple { color: #A78BFA; }
        .val-yellow { color: #FBBF24; }

        /* --- User Management Specific Styles --- */

        /* The Control Bar (Search & Filters) */
        .admin-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .admin-search-wrapper {
            flex-grow: 1;
            position: relative;
            min-width: 250px;
        }

        .admin-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
        }

        .admin-search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem; /* Space for icon */
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            transition: all 0.2s;
        }

        .admin-search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.4);
        }

        /* Tier Badges */
        .tier-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .tier-basic {
            background: rgba(148, 163, 184, 0.2);
            color: #cbd5e1;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .tier-premium {
            background: rgba(250, 204, 21, 0.2);
            color: #fde047;
            border: 1px solid rgba(250, 204, 21, 0.3);
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.1);
        }

        .tier-admin {
            background: rgba(168, 85, 247, 0.2);
            color: #d8b4fe;
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.1);
        }

        /* Table Overrides for this view */
        .user-row {
            transition: background 0.2s;
        }
        .user-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .user-uid {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* --- Subscription Tab Specifics --- */

        /* Nested Sub-Tab Navigation (Pill Style) */
        .sub-nav-container {
            display: flex;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.25rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            width: fit-content;
            margin-bottom: 1.5rem;
        }

        .sub-nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s;
        }

        .sub-nav-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .sub-nav-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Finance Cards */
        .finance-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        /* Status Badges for Payments */
        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-active { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.3); }
        .status-canceled { background: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid rgba(100, 116, 139, 0.3); }
        .status-past_due { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .status-trialing { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }

        /* --- FORCE GRADIENT REPAINT --- */
        /* This forces the browser to re-read the variables and redraw the gradient 
           whenever one of these classes is active. */
        body.theme-ocean, 
        body.theme-sunset, 
        body.theme-cyber, 
        body.theme-forest, 
        body.theme-royal, 
        body.theme-crimson, 
        body.theme-coffee, 
        body.theme-aurora, 
        body.theme-midnight, 
        body.theme-candy, 
        body.theme-slate {
            background-image: linear-gradient(-45deg, var(--grad-1), var(--grad-2)) !important;
            background-size: 400% 400%;
            background-attachment: fixed; /* Ensures it covers full scroll */
        }
    </style>
</head>

<body>
    <canvas id="threeJsCanvas"></canvas>

    <div class="site-scaler">
    <div class="main-content">
        <div id="wsStatus" class="ws-status disconnected">Disconnected</div>
        <div id="adminModeIndicator" class="fixed top-40 right-5 p-2 px-3 bg-yellow-500 text-white text-xs font-bold rounded-full shadow-lg z-50" style="display: none;">ADMIN MODE</div>

       <nav class="bg-black/10 backdrop-blur-md border-b border-white/10 sticky top-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center h-16">
            <a href="#" class="text-2xl font-bold text-white tracking-wider nav-link transition-all duration-300 hover:scale-105 hover:text-transparent hover:bg-clip-text hover:bg-gradient-to-r hover:from-indigo-400 hover:via-purple-400 hover:to-pink-400 drop-shadow-sm" data-page="home">
                SAGE AI
            </a>
            
            <div class="flex items-center gap-6">
                <div class="hidden md:flex items-center space-x-1">
                    <a href="#" class="text-white/80 px-3 py-2 rounded-md text-sm font-medium nav-link transition-all hover:text-white hover:bg-white/10" data-page="home">Home</a>
                    <a href="#" class="text-white/80 px-3 py-2 rounded-md text-sm font-medium nav-link transition-all hover:text-white hover:bg-white/10" data-page="blog">Blog</a>
                    <a href="#" class="text-white/80 px-3 py-2 rounded-md text-sm font-medium nav-link transition-all hover:text-white hover:bg-white/10" data-page="feedback">Feedback</a>
                </div>

                <div id="authSection">
                    <div id="loggedOutState">
                        <a href="#" class="btn btn-primary px-4 py-2 text-sm nav-link transition-all hover:shadow-lg hover:shadow-indigo-500/40" data-page="login">Sign In</a>
                    </div>

                    <div id="loggedInState" class="relative hidden">
                        <button id="profileMenuBtn" class="flex items-center justify-center w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold shadow-lg border border-white/20 transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900">
                            <span id="userInitials">U</span>
                        </button>

                        <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 origin-top-right rounded-xl bg-[#1a1b26] border border-white/10 shadow-2xl ring-1 ring-black ring-opacity-5 focus:outline-none backdrop-blur-xl z-50" role="menu">
                            
                            <div class="px-4 py-4 border-b border-white/10">
                                <p class="text-sm text-white font-bold" id="dropdownName">User Name</p>
                                <p class="text-xs text-white/60 truncate" id="dropdownEmail">email@example.com</p>
                            </div>

                            <div class="py-1">
                                <a href="#" id="openEditProfileBtn" class="text-white hover:bg-white/10 block px-4 py-2 text-sm transition-colors">
                                     Edit Profile
                                </a>
                                <a href="#" id="dropdownAdminLink" class="text-yellow-400 hover:bg-white/10 hover:text-yellow-300 hidden px-4 py-2 text-sm nav-link" data-page="adminDashboard">
                                     Admin Dashboard
                                </a>

                                <a href="#" id="manageSubscriptionLink" class="text-gray-300 hover:bg-white/10 hover:text-white block px-4 py-2 text-sm transition-colors">
                                     Manage Subscription
                                </a>
                                <a href="#" id="openSettingsBtn" class="block px-4 py-2 text-sm text-white hover:bg-white/10" role="menuitem"> 
                                     Settings
                                </a>
                            </div>

                            <div class="py-1 border-t border-white/10">
                                <a href="#" class="text-red-400 hover:bg-red-500/10 block px-4 py-2 text-sm nav-link" data-page="logout">
                                     Sign out
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="md:hidden flex items-center">
                    <button id="mobileMenuBtn" class="text-white hover:text-indigo-300 focus:outline-none">
                        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="mobileMenu" class="md:hidden hidden bg-black/90 backdrop-blur-xl border-b border-white/10">
        <div class="px-4 pt-2 pb-6 space-y-2 flex flex-col">
            <a href="#" class="text-white/90 block px-3 py-3 rounded-md text-base font-medium nav-link" data-page="home">Home</a>
            <a href="#" class="text-white/90 block px-3 py-3 rounded-md text-base font-medium nav-link" data-page="blog">Blog</a>
            <a href="#" class="text-white/90 block px-3 py-3 rounded-md text-base font-medium nav-link" data-page="feedback">Feedback</a>
        </div>
    </div>
</nav>

    <div id="settingsModal" class="feedback-modal">
        <div class="feedback-modal-container" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close-btn" id="closeSettingsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <h4 class="text-lg font-bold mb-4 text-white">Appearance</h4>
                <p class="text-sm text-white/70 mb-6">Choose a gradient theme for your workspace.</p>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    
                    <div class="theme-option" data-theme="default">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #C33764, #1D2671);"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Default</p>
                    </div>
                    
                    <div class="theme-option" data-theme="ocean">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #2E3192, #1BFFFF);"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Ocean</p>
                    </div>
                    
                    <div class="theme-option" data-theme="sunset">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #FF512F, #DD2476);"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Sunset</p>
                    </div>
                    
                    <div class="theme-option" data-theme="cyber">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #0F2027, #2C5364); border: 1px solid #00f260;"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Cyber</p>
                    </div>

                    <div class="theme-option" data-theme="forest">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #134E5E, #71B280);"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Forest</p>
                    </div>

                    <div class="theme-option" data-theme="royal">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #141E30, #243B55); border: 1px solid #F7B733;"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Royal</p>
                    </div>

                    <div class="theme-option" data-theme="crimson">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #870000, #190A05);"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Crimson</p>
                    </div>

                    <div class="theme-option" data-theme="coffee">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #3c2f2f, #755c47);"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Coffee</p>
                    </div>

                    <div class="theme-option" data-theme="aurora">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #000000, #0f9b0f); border: 1px solid #00ff00;"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Aurora</p>
                    </div>

                    <div class="theme-option" data-theme="midnight">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #0f0c29, #302b63);"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Midnight</p>
                    </div>

                    <div class="theme-option" data-theme="candy">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #A18CD1, #FBC2EB);"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Candy</p>
                    </div>

                    <div class="theme-option" data-theme="slate">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #232526, #414345);"></div>
                        <p class="text-xs text-center mt-2 text-white/80">Slate</p>
                    </div>

                </div>

                <div class="mt-8 pt-4 border-t border-white/10">
                    <p class="text-xs text-white/40 text-center">Select a theme to apply it immediately.</p>
                </div>
            </div>
        </div>
    </div>

        <div id="versionChoiceModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-[100] feedback-modal">
            <div class="glass-container w-full max-w-lg text-center feedback-modal-container">
                <h2 class="text-3xl font-bold mb-4">Choose Your Version</h2>
                <p class="text-white/80 mb-8">Select a version to proceed with your analysis.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="selectFreeVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Free Version</h3>
                        <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Basic analysis</li>
                            <li>Select 1 of 8 frameworks</li>
                        </ul>
                    </div>
                    <div id="selectPaidVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Paid Version</h3>
                         <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Comprehensive analysis</li>
                            <li>Select up to 3 of 8 frameworks</li>
                        </ul>
                    </div>
                </div>
                 <button id="closeModalBtn" class="btn btn-secondary mt-8">Cancel</button>
            </div>
        </div>

        <div id="stripePaymentModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm items-center justify-center z-[110] feedback-modal hidden" style="display: none;">
            <div class="glass-container w-full max-w-5xl p-8 feedback-modal-container relative flex flex-col justify-between min-h-[80vh] max-h-[95vh] overflow-y-auto">
                
                <button id="closeStripeModalBtn" class="absolute top-4 right-4 text-white/60 hover:text-white text-2xl z-50 transition-colors">&times;</button>
                
                <div class="text-center mt-2">
                    <h2 class="text-3xl font-bold mb-2 text-white tracking-tight">Choose Your Plan</h2>
                    <p class="text-white/70 text-sm max-w-xl mx-auto">Select the strategic tier that best fits your needs.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 my-6 flex-grow items-center">
                    
                    <div class="bg-white/5 p-6 rounded-xl border border-white/10 hover:border-purple-400 transition-all duration-300 hover:-translate-y-2 flex flex-col relative group h-full justify-between">
                        <div>
                            <div class="text-center mb-4">
                                <div class="w-12 h-12 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-purple-500/40 transition-colors">
                                    <span class="text-2xl"></span>
                                </div>
                                <h3 class="text-xl font-bold text-white">Individual</h3>
                                <p class="text-white/60 text-xs mt-1">For solo strategists</p>
                            </div>
                            <ul class="text-xs text-white/70 space-y-3 mb-6 pl-2">
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> Basic Frameworks</li>
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> Single User</li>
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> Email Support</li>
                            </ul>
                        </div>
                        <a href="https://buy.stripe.com/test_cNi7sLaJbdt946R5lybsc00" target="_blank" class="btn btn-secondary w-full py-3 text-sm border-purple-500/50 hover:bg-purple-500/20 font-semibold tracking-wide">
                            Select Individual
                        </a>
                    </div>

                    <div class="bg-gradient-to-b from-blue-900/40 to-white/5 p-6 rounded-xl border-2 border-blue-500/50 hover:border-blue-400 transition-all duration-300 hover:-translate-y-2 flex flex-col relative transform scale-105 shadow-2xl z-10 h-full justify-between">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg uppercase tracking-wide">
                            Most Popular
                        </div>
                        <div>
                            <div class="text-center mb-4 mt-2">
                                <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="text-2xl"></span>
                                </div>
                                <h3 class="text-xl font-bold text-white">Small Business</h3>
                                <p class="text-white/60 text-xs mt-1">For growing teams</p>
                            </div>
                            <ul class="text-xs text-white/70 space-y-3 mb-6 pl-2">
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> All Frameworks</li>
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> Up to 5 Users</li>
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> Priority Support</li>
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> Export to PDF/DOCX</li>
                            </ul>
                        </div>
                        <a href="https://buy.stripe.com/7sY9ATg3v0Gnbzj4hubsc01" target="_blank" class="btn btn-primary w-full py-3 text-sm font-bold shadow-lg tracking-wide">
                            Select Small Business
                        </a>
                    </div>

                    <div class="bg-white/5 p-6 rounded-xl border border-white/10 hover:border-yellow-400 transition-all duration-300 hover:-translate-y-2 flex flex-col group h-full justify-between">
                        <div>
                            <div class="text-center mb-4">
                                <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-yellow-500/40 transition-colors">
                                    <span class="text-2xl"></span>
                                </div>
                                <h3 class="text-xl font-bold text-white">Enterprise</h3>
                                <p class="text-white/60 text-xs mt-1">For organizations</p>
                            </div>
                            <ul class="text-xs text-white/70 space-y-3 mb-6 pl-2">
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> Custom Solutions</li>
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> Unlimited Users</li>
                                <li class="flex items-center"><span class="text-green-400 mr-2 font-bold"></span> Dedicated Account Mgr</li>
                            </ul>
                        </div>
                        <a href="https://buy.stripe.com/6oUdR96sVfBhcDn3dqbsc01" target="_blank" class="btn btn-secondary w-full py-3 text-sm border-yellow-500/50 hover:bg-yellow-500/20 font-semibold tracking-wide">
                            Select Enterprise
                        </a>
                    </div>

                </div>
                
                <div class="flex flex-col items-center justify-center gap-4 pb-2">
                    
                    <div class="flex items-center gap-2 opacity-50 hover:opacity-100 transition-opacity">
                        <span class="text-[10px] text-white/60 font-medium">Secure Payment by</span>
                        <img src="https://images.ctfassets.net/fzn2n1nzq965/2WOM2d46aE6u8i6e6O6k46/e0e94e548552818112573a179aa986d3/stripe-badge-white.png" alt="Stripe" class="h-4 grayscale hover:grayscale-0 transition-all">
                    </div>

                    <div class="flex items-center gap-2 animate-fadeIn bg-black/30 p-1.5 rounded-full border border-white/10 hover:border-white/20 transition-colors">
                        <input type="text" id="promoCodeInput" 
                                class="bg-transparent border-none text-xs text-white placeholder-white/30 focus:outline-none px-3 w-32 text-center" 
                                placeholder="Have a code?">
                        <button id="applyPromoBtn" 
                                class="bg-white/10 hover:bg-indigo-600 text-white text-[10px] font-bold px-4 py-1.5 rounded-full transition-all hover:shadow-lg">
                            APPLY
                        </button>
                    </div>
                    <p id="promoMessage" class="text-center text-[10px] font-medium hidden h-4"></p>
                </div>
            </div>
        </div>

        <div id="userManagementModal" class="feedback-modal">
    <div class="feedback-modal-container" style="max-width: 600px;">
        <div id="userModalContent">
            <div class="modal-header">
                <h3 class="modal-title">Loading...</h3>
                <button class="modal-close-btn" id="closeUserModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="flex items-center justify-center p-10">
                    <div class="loading-spinner mr-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="bulkActionModal" class="feedback-modal">
    <div class="feedback-modal-container" style="max-width: 500px;">
        <div id="bulkModalContent">
             </div>
    </div>
</div>

        <div id="home" class="page active container mx-auto px-4 py-8 md:px-6 md:py-16">
            <div class="relative w-full max-w-12xl mx-auto mb-16 animate-fadeIn z-10">
                <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl blur opacity-30 animate-pulse"></div>
                
                <div class="relative p-1 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 border border-white/20 shadow-2xl backdrop-blur-xl">
                    <div class="p-8 md:p-10 text-center">
                        <h1 class="text-4xl md:text-6xl font-extrabold text-white leading-tight mb-4 tracking-tight drop-shadow-lg">
                            AI-Powered Strategic Business and Policy Development Tools
                        </h1>
                        <p class="text-lg md:text-xl text-white/80 max-w-3xl mx-auto leading-relaxed">
                            Select a category to explore our comprehensive suite of strategic planning tools and methodologies.
                        </p>
                    </div>
                </div>
            </div>
            
            <div id="homeTabsNav" class="flex flex-wrap justify-center space-x-1 md:space-x-2 border-b-2 border-white/10 mt-16 mb-12">
                <button class="home-tab-btn active" data-tab="strategicPlanning">Strategic Planning</button>
                <button class="home-tab-btn" data-tab="systemThinking">System Thinking</button>
                <button class="home-tab-btn" data-tab="novelStrategies">Novel Strategies</button>
                <button class="home-tab-btn" data-tab="dataAnalysis">Data Analysis</button>
            </div>

            <div id="homeTabsContent">
                <div id="strategicPlanning" class="home-tab-panel active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="mission-vision">
                        <h3 class="text-xl font-bold mb-2">AI Mission Vision</h3><p class="text-white/70 text-sm">Define your organization's core purpose and future aspirations.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="factor-analysis">
                        <h3 class="text-xl font-bold mb-2">AI Factor Analysis</h3><p class="text-white/70 text-sm">Assess internal strengths and weaknesses & external opportunities and threats.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="swot-tows">
                        <h3 class="text-xl font-bold mb-2">AI SWOT/TOWS Analysis</h3><p class="text-white/70 text-sm">Develop strategies by matching internal factors to external factors.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="goals-initiatives">
                        <h3 class="text-xl font-bold mb-2">AI Goals & Strategic Initiatives</h3><p class="text-white/70 text-sm">Set high-level goals and the key initiatives to achieve them.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="objectives">
                        <h3 class="text-xl font-bold mb-2">AI Objectives</h3><p class="text-white/70 text-sm">Formulate specific, measurable, achievable, relevant, and time-bound objectives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="action-plans">
                        <h3 class="text-xl font-bold mb-2">AI Action Plans</h3><p class="text-white/70 text-sm">Detail the resources, tasks, and timelines required for execution.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="kpi-events">
                        <h3 class="text-xl font-bold mb-2">AI KPI & Critical Events</h3><p class="text-white/70 text-sm">Define key performance indicators and track critical milestones.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="misc-summary">
                        <h3 class="text-xl font-bold mb-2">AI Strategic Planning</h3><p class="text-white/70 text-sm">Compile summaries, risk assessments, governance, and conclusions.</p>
                    </div>
                </div>

                <div id="systemThinking" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="process-mapping">
                        <h3 class="text-xl font-bold mb-2">AI Process Mapping</h3><p class="text-white/70 text-sm">Visualize and analyze the flow of activities in a process.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="pareto-fishbone">
                        <h3 class="text-xl font-bold mb-2">AI Fishbone/Pareto Analysis</h3><p class="text-white/70 text-sm">Identify root causes and prioritize the most significant issues.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-thinking-analysis">
                        <h3 class="text-xl font-bold mb-2">AI System Thinking Analysis</h3><p class="text-white/70 text-sm">Understand the complex interconnections within your organization.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="leverage-points">
                        <h3 class="text-xl font-bold mb-2">AI Leverage Points</h3><p class="text-white/70 text-sm">Identify areas where small changes can yield significant results.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="archetype-analysis">
                        <h3 class="text-xl font-bold mb-2">AI Archetypes Analysis</h3><p class="text-white/70 text-sm">Recognize and address recurring patterns of behavior in your system.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-goals-initiatives">
                        <h3 class="text-xl font-bold mb-2">AI Goals/Strategic Initiatives</h3><p class="text-white/70 text-sm">Align system-level goals with broader strategic initiatives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-objectives">
                        <h3 class="text-xl font-bold mb-2">AI Objectives</h3><p class="text-white/70 text-sm">Define clear objectives for improving system performance.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-actions">
                        <h3 class="text-xl font-bold mb-2">AI Actions</h3><p class="text-white/70 text-sm">Outline concrete actions to implement system-level changes.</p>
                    </div>
                </div>
                
                <div id="novelStrategies" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="novel-goals-initiatives">
                        <h3 class="text-2xl font-bold mb-2">AI Goals & Strategic Initiatives</h3><p class="text-white/70">Define ambitious goals and innovative initiatives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="all-framework">
                        <h3 class="text-2xl font-bold mb-2">AI All Frameworks</h3><p class="text-white/70">Access a comprehensive suite of strategic frameworks.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="creative-dissonance">
                        <h3 class="text-2xl font-bold mb-2">AI Creative Dissonance</h3><p class="text-white/70">Leverage the gap between vision and reality to spark innovation.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="living-system">
                        <h3 class="text-2xl font-bold mb-2">AI Living System</h3><p class="text-white/70">Apply principles of living systems to foster organizational adaptability.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="thinking-system">
                        <h3 class="text-2xl font-bold mb-2">AI Thinking System</h3><p class="text-white/70">Develop a holistic approach to problem-solving and decision-making.</p>
                    </div>
                </div>

                <div id="dataAnalysis" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="descriptive-analysis"><h3 class="text-xl font-bold mb-2">AI Descriptive</h3><p class="text-white/70 text-sm">Summarize historical data to understand what has happened.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="predictive-analysis"><h3 class="text-xl font-bold mb-2">AI Predictive</h3><p class="text-white/70 text-sm">Use statistical models to forecast future outcomes.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="prescriptive-analysis"><h3 class="text-xl font-bold mb-2">AI Prescriptive</h3><p class="text-white/70 text-sm">Advise on possible outcomes and recommend actions.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="visualization"><h3 class="text-xl font-bold mb-2">AI Visualization</h3><p class="text-white/70 text-sm">Create graphical representations of data for insights.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="regression-analysis"><h3 class="text-xl font-bold mb-2">AI Regression</h3><p class="text-white/70 text-sm">Model relationships between variables for prediction.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="pls-analysis"><h3 class="text-xl font-bold mb-2">AI-Based PLS</h3><p class="text-white/70 text-sm">Apply Partial Least Squares for structural equation modeling.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="sem-analysis"><h3 class="text-xl font-bold mb-2">AI-Based SEM</h3><p class="text-white/70 text-sm">Structural Equation Modeling for complex variable relationships.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="dematel-analysis"><h3 class="text-xl font-bold mb-2">AI-Based DEMATEL</h3><p class="text-white/70 text-sm">Understand causal relationships between complex factors.</p></div>
                </div>
            </div>
            <!-- START OF BOOK SECTION !-->
            <div class="glass-container feature-card mt-16 mb-12 overflow-hidden">
                <h2 class="text-4xl font-bold mb-4 text-indigo-300 text-center">Science and Art of Strategy</h2>
                <div class="flex flex-col md:flex-row items-center gap-8">
                    <div class="w-full md:w-1/3">
                        <div class="w-full rounded-lg">
                            <img src="images/Notebook-Book-Cover-8.jpg" alt="Science and Art of Strategy book cover" class="w-full max-w-xs h-auto rounded-lg mx-auto">
                        </div>
                    </div>
                    <div class="w-full md:w-2/3 text-white/80">
                        <p>This book explores the subject of strategy. It aims to become the premier guide on how to develop drawer plans to support strategy and/or public policy. The three parts of the book are Science of Strategy, Art of Strategy, and the Execution of Strategy. Science of Strategy focuses on the fundamental of developing a strategic plan. The art of strategy explores the dynamic and complex nature of the environment and how an intricate understanding of the human brain could be useful in developing novel strategies. The last part places emphasis on the importance of the leadership and methodologies that could be useful to see through the successful implementation of the strategic plans. The book explores the importance of business intelligence, systems thinking, leverage or center of gravities, complex adaptive systems, wargaming, game theory, leadership, intuition, and the tipping point in developing and executing strategies.</p>
                        <p class="mt-3">This first edition only serves to lay out a broad framework on the some of the most important considerations and tools that could be used to develop winning strategies. It focuses on how to think rather than to provide a laundry list of strategies that could be implemented in any organization. The aim is for corporations to rigorously exploring their own unique capabilities and circumstances to develop novel strategies that would fit their own specific context.</p>
                        <div class="mt-6">
                            <a href="https://www.amazon.com/Science-Art-Strategy-Systems-Approach/dp/199950836X/ref=sr_1_1?sr=8-1" target="_blank" class="btn btn-primary">Buy Now</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END OF BOOK SECTION -->

            <!-- START OF LEADERSHIP / SYSTEM SECTION -->
            <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="feature-card p-6">
                    <h3 class="text-xl font-bold mb-3">Strategic Leadership</h3>
                    <blockquote class="text-sm text-white/70 italic border-l-2 border-indigo-300 pl-4 text-left mb-4">
                        Two qualities are indispensable: first, an intellect that, even in the darkest hour, retains some glimmerings of the inner light which leads to truth; and second, the courage to follow this faint light wherever it may lead.<br>
                        <cite class="not-italic block text-right mt-2"> Cart von Clausewitz</cite>
                    </blockquote>
                    <p class="text-white/70 text-sm text-left">
                        Leadership qualities are essentially the courage, determination, self-control, coup deoeil and a comprehensive winning mindset that is not easily perturbed or defeated.
                    </p>
                </div>

                <div class="feature-card p-6">
                    <h3 class="text-xl font-bold mb-3">Thinking & Living System</h3>
                    <p class="text-white/70 text-sm text-left">
                        Understanding structures, interconnections/relationships, and feedback loops will allow us to map a complex system to derive unique insights and discoveries that could be used to develop interventions, shifts, or policy decisions that will dramatically change the system in the most effective way.
                    </p>
                    <p class="text-white/70 text-sm text-left mt-3">
                        As a complex adaptive system, it is an open and living system that adapts and evolves with the environment.
                    </p>
                </div>

                <div class="feature-card p-6">
                    <h3 class="text-xl font-bold mb-3">Data Science</h3>
                    <p class="text-white/70 text-sm text-left mb-3">
                        With Artificial Intelligence and Machine Learning, Data Science can be used to develop strategies using the following:
                    </p>
                    <ul class="text-white/70 text-sm list-disc list-inside text-left mx-auto max-w-xs">
                        <li>Visualizations</li>
                        <li>Multiple Regression</li>
                        <li>ARIMA</li>
                        <li>Neural Networks</li>
                        <li>Structural Equation Modelling</li>
                        <li>DEMATEL</li>
                        <li>Artificial Intelligence</li>
                    </ul>
                </div>

                <div class="feature-card p-6">
                    <h3 class="text-xl font-bold mb-3">Novel Strategies</h3>
                    <p class="text-white/70 text-sm text-left mb-3">
                        Developing novels strategies involve thinking out of the box through the following techniques:
                    </p>
                    <ul class="text-white/70 text-sm list-disc list-inside text-left mx-auto max-w-xs">
                        <li>Reframing Thinking</li>
                        <li>Delphi Method</li>
                        <li>Blue Ocean</li>
                        <li>Design Thinking</li>
                        <li>Thinking Hats</li>
                        <li>CATWOE Thinking</li>
                        <li>MOONSHOT Thinking</li>
                    </ul>
                </div>
                <!-- END OF LEADERSHIP / SYSTEM SECTION -->
            </div>

            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="feature-card p-6 bg-white/5 border-2 border-dashed border-white/10 hover:border-white/30 transition-all duration-300 group cursor-default">
                    <div class="text-3xl mb-3 opacity-50 group-hover:opacity-100 transition-opacity"></div>
                    <h3 class="text-xl font-bold mb-2 text-white/60 group-hover:text-white transition-colors">Future Module</h3>
                    <p class="text-white/40 text-sm group-hover:text-white/70 transition-colors">
                        Advanced simulation and wargaming tools are currently in development.
                    </p>
                </div>

                <div class="feature-card p-6 bg-white/5 border-2 border-dashed border-white/10 hover:border-white/30 transition-all duration-300 group cursor-default">
                    <div class="text-3xl mb-3 opacity-50 group-hover:opacity-100 transition-opacity"></div>
                    <h3 class="text-xl font-bold mb-2 text-white/60 group-hover:text-white transition-colors">Future Module</h3>
                    <p class="text-white/40 text-sm group-hover:text-white/70 transition-colors">
                        Deep-dive organizational DNA mapping and cultural analysis tools coming soon.
                    </p>
                </div>

                <div class="feature-card p-6 bg-white/5 border-2 border-dashed border-white/10 hover:border-white/30 transition-all duration-300 group cursor-default">
                    <div class="text-3xl mb-3 opacity-50 group-hover:opacity-100 transition-opacity"></div>
                    <h3 class="text-xl font-bold mb-2 text-white/60 group-hover:text-white transition-colors">Future Module</h3>
                    <p class="text-white/40 text-sm group-hover:text-white/70 transition-colors">
                        Autonomous strategic agent integration for real-time decision support.
                    </p>
                </div>
            </div>

            <!-- Contact Us block (Start) -->
            <div class="mx-auto mt-24 mb-16 relative animate-fadeIn">
                <div class="glass-container feature-card overflow-hidden w-full"> 
                    <div class="p-8 md:p-10">
                        <h2 class="text-4xl font-bold mb-4 text-white text-center">Contact Us</h2>
                        <p class="text-white/70 mb-8 text-center max-w-2xl mx-auto">
                            Interested in learning more or require strategic services? Get in touch.
                        </p>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                               
                                <div>
                                    <label for="contactFirstName" class="block text-sm font-medium text-gray-200 mb-2">First Name</label>
                                    <input type="text" id="contactFirstName" class="input-field bg-black/20 border-white/20 focus:border-indigo-400 placeholder-white/30" placeholder="Enter your first name" required>
                                </div>
                                <div>
                                    <label for="contactLastName" class="block text-sm font-medium text-gray-200 mb-2">Last Name</label>
                                    <input type="text" id="contactLastName" class="input-field bg-black/20 border-white/20 focus:border-indigo-400 placeholder-white/30" placeholder="Enter your last name" required>
                                </div>
                        
                            </div>

                            <div>
                                <label for="contactCompanyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label>
                                <input type="text" id="contactCompanyName" class="input-field bg-black/20 border-white/20 focus:border-indigo-400 placeholder-white/30" placeholder="Enter your company's name">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="contactEmail" class="block text-sm font-medium text-gray-200 mb-2">Contact Email Address</label>
                                    <input type="email" id="contactEmail" class="input-field bg-black/20 border-white/20 focus:border-indigo-400 placeholder-white/30" placeholder="Enter your email" required>
      
                                </div>
                                <div>
                                    <label for="contactPhone" class="block text-sm font-medium text-gray-200 mb-2">Phone Number (Optional)</label>
                                    <input type="tel" id="contactPhone" class="input-field bg-black/20 border-white/20 focus:border-indigo-400 placeholder-white/30" placeholder="(123) 456-7890">
                                </div>
                            </div>

                            <div>
                                <label for="contactSubject" class="block text-sm font-medium text-gray-200 mb-2">Subject</label>
                              
                                <input type="text" id="contactSubject" class="input-field bg-black/20 border-white/20 focus:border-indigo-400 placeholder-white/30" placeholder="What is this regarding?" required>
                            </div>

                            <div>
                                <label for="contactMessage" class="block text-sm font-medium text-gray-200 mb-2">Message</label>
                                <textarea id="contactMessage" class="input-field h-32 bg-black/20 border-white/20 focus:border-indigo-400 placeholder-white/30" placeholder="How can I help you?"></textarea>
                            </div>
                            
                            <div id="contactMessageResult" class="hidden"></div>

                            <button id="contactSubmitBtn" class="btn btn-primary w-full shadow-lg hover:shadow-indigo-500/30 transition-all duration-300 mt-4">
                            
                                <span id="contactSubmitBtnText">Send Message</span>
                                <span id="contactSubmitSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Contact Us block (End) -->
        
        <div id="about" class="page container mx-auto px-4 py-10 flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-5xl relative animate-fadeIn my-auto">
                <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl blur opacity-30 animate-pulse"></div>
                
                <div class="relative p-1 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 border border-white/20 shadow-2xl backdrop-blur-xl">
                    <div class="p-8 md:p-12 space-y-12">
                        
                        <div class="text-center space-y-4">
                            <h1 class="text-4xl md:text-6xl font-extrabold text-white tracking-tight">About S.A.G.E.</h1>
                            <p class="text-xl text-indigo-300 font-medium tracking-wide">Strategy. Analysis. Growth. Execution.</p>
                            <p class="text-white/80 max-w-3xl mx-auto leading-relaxed text-lg">
                                S.A.G.E. is an advanced AI-powered strategic thought partner designed to bridge the gap between complex business theory and actionable execution. We democratize access to high-level consulting frameworks, enabling anyone to analyze systems and formulate winning strategies.
                            </p>
                        </div>

                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="bg-black/20 p-6 rounded-xl border border-white/10 hover:bg-white/5 transition-colors">
                                <div class="text-3xl mb-3"></div>
                                <h3 class="text-lg font-bold text-white mb-2">System Thinking</h3>
                                <p class="text-white/60 text-sm">Moving beyond linear cause-and-effect to understand the complex loops and structures that drive organizational behavior.</p>
                            </div>
                            <div class="bg-black/20 p-6 rounded-xl border border-white/10 hover:bg-white/5 transition-colors">
                                <div class="text-3xl mb-3"></div>
                                <h3 class="text-lg font-bold text-white mb-2">AI-Powered Insight</h3>
                                <p class="text-white/60 text-sm">Leveraging state-of-the-art Large Language Models to synthesize vast amounts of context into clear, actionable directives.</p>
                            </div>
                            <div class="bg-black/20 p-6 rounded-xl border border-white/10 hover:bg-white/5 transition-colors">
                                <div class="text-3xl mb-3"></div>
                                <h3 class="text-lg font-bold text-white mb-2">Strategic Rigor</h3>
                                <p class="text-white/60 text-sm">Grounded in proven methodologies like OGSM, SWOT/TOWS, and Blue Ocean Strategy to ensure professional-grade output.</p>
                            </div>
                        </div>

                        <div>
                            <h2 class="text-2xl font-bold text-center mb-8 text-white">How to Use S.A.G.E.</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex items-start p-4 bg-white/5 rounded-lg border border-white/10">
                                    <div class="flex-shrink-0 w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center font-bold text-white mr-4">1</div>
                                    <div>
                                        <h4 class="font-bold text-indigo-200">Choose Your Tool</h4>
                                        <p class="text-sm text-white/70 mt-1">Select from Strategic Planning, System Thinking, or Data Analysis modules on the Home page.</p>
                                    </div>
                                </div>
                                <div class="flex items-start p-4 bg-white/5 rounded-lg border border-white/10">
                                    <div class="flex-shrink-0 w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center font-bold text-white mr-4">2</div>
                                    <div>
                                        <h4 class="font-bold text-purple-200">Provide Context</h4>
                                        <p class="text-sm text-white/70 mt-1">Use the <strong>Text Input</strong> to paste details or <strong>Upload a File</strong> (.txt, .docx, .pdf) for deep analysis.</p>
                                    </div>
                                </div>
                                <div class="flex items-start p-4 bg-white/5 rounded-lg border border-white/10">
                                    <div class="flex-shrink-0 w-8 h-8 bg-pink-600 rounded-full flex items-center justify-center font-bold text-white mr-4">3</div>
                                    <div>
                                        <h4 class="font-bold text-pink-200">Configure & Generate</h4>
                                        <p class="text-sm text-white/70 mt-1">Select specific frameworks (e.g., Blue Ocean, SCAMPER) if available, then click Generate.</p>
                                    </div>
                                </div>
                                <div class="flex items-start p-4 bg-white/5 rounded-lg border border-white/10">
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center font-bold text-white mr-4">4</div>
                                    <div>
                                        <h4 class="font-bold text-blue-200">Analyze & Export</h4>
                                        <p class="text-sm text-white/70 mt-1">Review the interactive dashboard, charts, and reports. Export to PDF or DOCX for your team.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center pt-4 border-t border-white/10">
                            <p class="text-white/60 italic mb-4">"The best way to predict the future is to create it."</p>
                            <div class="flex justify-center gap-4">
                                <button class="btn btn-primary nav-link" data-page="home">Start Analyzing</button>
                                <button class="btn btn-secondary nav-link" data-page="blog">Read the Blog</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Policy Page (Enhanced) -->
        <div id="privacyPolicy" class="page container mx-auto px-4 py-10 flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-5xl relative animate-fadeIn my-auto">
                <!-- Glow Effect -->
                <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl blur opacity-30 animate-pulse"></div>
                
                <div class="relative p-1 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 border border-white/20 shadow-2xl backdrop-blur-xl">
                    <div class="p-8 md:p-12 space-y-10">
                        
                        <!-- Header -->
                        <div class="text-center space-y-4">
                            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">Privacy Policy</h1>
                            <p class="text-xl text-indigo-300 font-medium tracking-wide">Your Data, Protected.</p>
                            <p class="text-white/60 text-sm">Last Updated: October 2024</p>
                        </div>

                        <!-- Info Collection Grid -->
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-6 text-center">1. Information We Collect</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="bg-black/20 p-6 rounded-xl border border-white/10 hover:bg-white/5 transition-colors">
                                    <div class="text-3xl mb-3"></div>
                                    <h4 class="text-lg font-bold text-white mb-2">Identity & Contact</h4>
                                    <p class="text-white/60 text-sm">First name, last name, email address, and login credentials used to manage your account.</p>
                                </div>
                                <div class="bg-black/20 p-6 rounded-xl border border-white/10 hover:bg-white/5 transition-colors">
                                    <div class="text-3xl mb-3"></div>
                                    <h4 class="text-lg font-bold text-white mb-2">Strategic Input</h4>
                                    <p class="text-white/60 text-sm">Business context, uploaded documents (.txt, .docx, .pdf), and strategic goals provided for analysis.</p>
                                </div>
                                <div class="bg-black/20 p-6 rounded-xl border border-white/10 hover:bg-white/5 transition-colors">
                                    <div class="text-3xl mb-3"></div>
                                    <h4 class="text-lg font-bold text-white mb-2">Usage Data</h4>
                                    <p class="text-white/60 text-sm">Interaction logs, feature usage statistics, and session durations to improve system performance.</p>
                                </div>
                                <div class="bg-black/20 p-6 rounded-xl border border-white/10 hover:bg-white/5 transition-colors">
                                    <div class="text-3xl mb-3"></div>
                                    <h4 class="text-lg font-bold text-white mb-2">Cookies</h4>
                                    <p class="text-white/60 text-sm">Essential cookies for authentication and session management. We do not use tracking cookies for ads.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Usage Section -->
                        <div class="bg-white/5 p-8 rounded-2xl border border-white/10">
                            <h3 class="text-2xl font-bold text-white mb-4">2. How We Use Your Data</h3>
                            <ul class="space-y-3 text-white/80">
                                <li class="flex items-start gap-3">
                                    <span class="text-green-400 mt-1"></span>
                                    <span><strong>Service Delivery:</strong> To generate strategic insights, SWOT analyses, and frameworks based on your inputs.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span class="text-green-400 mt-1"></span>
                                    <span><strong>Account Management:</strong> To manage subscriptions, payments (via Stripe), and authentication (via Supabase).</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span class="text-green-400 mt-1"></span>
                                    <span><strong>AI Improvement:</strong> Anonymized aggregation of query patterns to refine prompt engineering. We do not train models on your specific proprietary data.</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Security & Contact -->
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-xl font-bold text-white mb-3">3. Data Security</h3>
                                <p class="text-white/70 text-sm leading-relaxed">
                                    We employ enterprise-grade encryption for data at rest and in transit. Your strategic documents are processed temporarily and are not permanently stored in our public datasets. Access controls ensure only you can view your generated reports.
                                </p>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white mb-3">4. Contact Us</h3>
                                <p class="text-white/70 text-sm leading-relaxed mb-4">
                                    Have questions about your privacy? Reach out to our data protection team directly.
                                </p>
                                <button class="btn btn-secondary text-xs nav-link" data-page="feedback">Contact Support</button>
                            </div>
                        </div>

                        <div class="text-center pt-6 border-t border-white/10">
                            <button class="btn btn-primary nav-link" data-page="home">Back to Workspace</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terms of Service Page (Themed) -->
        <div id="termsOfService" class="page container mx-auto px-4 py-10 flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-5xl relative animate-fadeIn my-auto">
                <!-- Glow Effect (Updated to use Theme Hooks: indigo/purple/pink) -->
                <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl blur opacity-30 animate-pulse"></div>
        
                <div class="relative p-1 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 border border-white/20 shadow-2xl backdrop-blur-xl">
                    <div class="p-8 md:p-12 space-y-10">
                        <!-- Header -->
                        <div class="text-center space-y-4">
                            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">Terms of Service</h1>
                            <!-- Updated color class to text-indigo-300 to catch the theme variable -->
                            <p class="text-xl text-indigo-300 font-medium tracking-wide">Usage Rules & Guidelines</p>
                            <p class="text-white/60 text-sm">Last Updated: October 2024</p>
                        </div>

                        <!-- Critical AI Disclaimer (Themed) -->
                        <!-- Updated bg, border, and text classes to match theme variables -->
                        <div class="bg-indigo-500/10 p-6 rounded-xl border-l-4 border-indigo-500">
                            <div class="flex items-start gap-4">
                                <div class="text-3xl"></div>
                                <div>
                                    <h3 class="text-xl font-bold text-indigo-300 mb-2">1. Artificial Intelligence Disclaimer</h3>
                                    <p class="text-white/80 text-sm leading-relaxed">
                                        S.A.G.E. utilizes advanced Large Language Models to generate strategic content. AI can occasionally produce incorrect, biased, or "hallucinated" information. 
                                        <strong>You acknowledge that S.A.G.E. is a decision-support tool, not a replacement for professional human judgment.</strong> 
                                        You verify all outputs independently before making financial or strategic business decisions. We accept no liability for losses resulting from reliance on this tool.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Terms Grid -->
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="bg-black/20 p-6 rounded-xl border border-white/10">
                                <h4 class="text-lg font-bold text-white mb-2">2. Access & Accounts</h4>
                                <p class="text-white/60 text-sm">You must provide accurate registration information. You are responsible for maintaining the security of your account credentials and for all activities that occur under your account.</p>
                            </div>
                            <div class="bg-black/20 p-6 rounded-xl border border-white/10">
                                <h4 class="text-lg font-bold text-white mb-2">3. Intellectual Property</h4>
                                <p class="text-white/60 text-sm">The S.A.G.E. platform, code, and branding are our property. However, the <strong>strategic reports generated specifically for you</strong> based on your unique inputs belong to you.</p>
                            </div>
                            <div class="bg-black/20 p-6 rounded-xl border border-white/10">
                                <h4 class="text-lg font-bold text-white mb-2">4. Prohibited Use</h4>
                                <p class="text-white/60 text-sm">You may not use the service for unlawful purposes, to generate hate speech, or to attempt to reverse-engineer the underlying AI prompts and systems.</p>
                            </div>
                        </div>

                        <!-- Subscription & Termination -->
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-xl font-bold text-white mb-2">5. Subscription & Payments</h3>
                                <p class="text-white/70 text-sm">
                                    Premium features require a paid subscription via Stripe. Subscriptions auto-renew unless cancelled. Refunds are handled on a case-by-case basis within 14 days of purchase for technical failures only.
                                </p>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white mb-2">6. Termination</h3>
                                <p class="text-white/70 text-sm">
                                    We reserve the right to suspend or terminate accounts that violate these terms, abuse the API rate limits, or engage in suspicious activity, without prior notice.
                                </p>
                            </div>
                        </div>

                        <div class="text-center pt-6 border-t border-white/10">
                            <button class="btn btn-primary nav-link" data-page="home">Accept & Return Home</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div id="editProfileModal" class="feedback-modal">
            <div class="feedback-modal-container" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Profile</h3>
                    <button class="modal-close-btn" id="closeEditProfileBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="flex flex-col items-center mb-6">
                            <div id="modalAvatarPreview" class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-3xl font-bold text-white shadow-lg border-2 border-white/20 overflow-hidden mb-3">
                                <span id="modalAvatarInitials">U</span>
                                <img id="modalAvatarImg" src="" alt="Profile" class="w-full h-full object-cover hidden">
                            </div>
                            <p class="text-xs text-white/50">Profile Preview</p>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-200 mb-2">First Name</label><input type="text" id="editProfileFirstName" class="input-field bg-black/20 border-white/20 focus:border-indigo-400"></div>
                        <div><label class="block text-sm font-medium text-gray-200 mb-2">Last Name</label><input type="text" id="editProfileLastName" class="input-field bg-black/20 border-white/20 focus:border-indigo-400"></div>
                        <div><label class="block text-sm font-medium text-gray-200 mb-2">Avatar Image URL</label><input type="url" id="editProfileAvatarUrl" class="input-field bg-black/20 border-white/20 focus:border-indigo-400" placeholder="https://..."></div>
                        <div id="editProfileMessage" class="hidden text-center text-sm font-bold p-2 rounded"></div>
                        <button id="saveProfileBtn" class="btn btn-primary w-full mt-4 shadow-lg"><span id="saveProfileBtnText">Save Changes</span><span id="saveProfileSpinner" class="loading-spinner hidden ml-2"></span></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="login" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Sign In</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="loginEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="loginEmail" class="input-field" placeholder="Enter your email" required>
                        </div>
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="loginPassword" class="input-field" placeholder="Enter your password"
                                required>
                        </div>
                        <button id="loginBtn" class="btn btn-primary w-full">
                            <span id="loginBtnText">Sign In</span>
                            <span id="loginSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="loginMessage" class="hidden"></div>
                    </div>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Don't have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="signup">Create Account</button>
                        <button class="btn-tertiary nav-link text-sm mt-2" data-page="passwordResetRequest">Forgot Password?</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="signup" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Create Account</h2>
                    <form id="registerForm" class="space-y-4">
                        <div>
                            <label for="registerFirstName" class="block text-sm font-medium text-gray-200 mb-2">First
                                Name</label>
                            <input type="text" id="registerFirstName" class="input-field"
                                placeholder="Enter your First Name" required>
                        </div>
                        <div>
                            <label for="registerLastName" class="block text-sm font-medium text-gray-200 mb-2">Last
                                Name</label>
                            <input type="text" id="registerLastName" class="input-field" placeholder="Enter your Last Name"
                                required>
                        </div>
                        <div>
                            <label for="registerEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="registerEmail" class="input-field" placeholder="Enter your email"
                                required>
                        </div>
                        <div>
                            <label for="registerPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="registerPassword" class="input-field" placeholder="Create a password"
                                required>
                        </div>
                        <div>
                            <label for="registerConfirmPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Confirm Password</label>
                            <input type="password" id="registerConfirmPassword" class="input-field"
                                placeholder="Confirm your password" required>
                        </div>
                        <button type="button" id="registerBtn" class="btn btn-primary w-full">
                            <span id="registerBtnText">Create Account</span>
                            <span id="registerSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="registerMessage" class="hidden"></div>
                    </form>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Already have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="login">Sign In</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="emailVerification" class="page flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container text-center">
                    <h2 class="text-3xl font-bold mb-6 text-white">Check Your Email</h2>
                    <p class="text-white/80 mb-6">Thank you for registering! We've sent a verification link to your email address. Please check your inbox and click the link to complete your registration.</p>
                    <p class="text-white/60 text-sm mb-6">Don't forget to check your spam folder.</p>
                    <div class="text-center">
                        <button class="btn-tertiary nav-link" data-page="login">Return to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="feedback" class="page flex items-center justify-center min-h-[80vh] py-10">
            <div class="w-full max-w-lg relative animate-fadeIn">
                <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl blur opacity-30 animate-pulse"></div>
                
                <div class="relative p-1 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 border border-white/20 shadow-2xl backdrop-blur-xl">
                    <div class="p-8">
                        <h2 class="text-3xl font-bold mb-2 text-center text-white">Give Us Feedback</h2>
                        <p class="text-white/70 mb-6 text-center text-sm">We value your input to help S.A.G.E. grow.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="feedbackToolName" class="block text-sm font-medium text-gray-200 mb-2">Which tool is this for?</label>
                                <div class="select-wrapper"> 
                                    <select id="feedbackToolName" class="input-field bg-black/20 border-white/20 focus:border-indigo-400">
                                        <option value="general">General Website / Other</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label for="feedbackReason" class="block text-sm font-medium text-gray-200 mb-2">Reason</label>
                                <div class="select-wrapper">
                                    <select id="feedbackReason" class="input-field bg-black/20 border-white/20 focus:border-indigo-400">
                                        <option value="">-- Select a reason --</option>
                                        <option value="Bug / Error">Bug / Error</option>
                                        <option value="Suggestion / Improvement">Suggestion / Improvement</option>
                                        <option value="Not Satisfied">Not Satisfied</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">Rating (Optional)</label>
                                <div class="input-radio-group text-sm bg-black/20 p-1 rounded-lg">
                                    <input type="radio" name="feedbackRating" id="rating0" value="0" class="input-radio" checked>
                                    <label for="rating0" class="input-radio-label hover:bg-white/10">N/A</label>
                                    
                                    <input type="radio" name="feedbackRating" id="rating1" value="1" class="input-radio">
                                    <label for="rating1" class="input-radio-label hover:bg-white/10">1 </label>
                                    
                                    <input type="radio" name="feedbackRating" id="rating2" value="2" class="input-radio">
                                    <label for="rating2" class="input-radio-label hover:bg-white/10">2 </label>
                                    
                                    <input type="radio" name="feedbackRating" id="rating3" value="3" class="input-radio">
                                    <label for="rating3" class="input-radio-label hover:bg-white/10">3 </label>
                                    
                                    <input type="radio" name="feedbackRating" id="rating4" value="4" class="input-radio">
                                    <label for="rating4" class="input-radio-label hover:bg-white/10">4 </label>
                                    
                                    <input type="radio" name="feedbackRating" id="rating5" value="5" class="input-radio">
                                    <label for="rating5" class="input-radio-label hover:bg-white/10">5 </label>
                                </div>
                            </div>

                            <div>
                                <label for="feedbackTextPage" class="block text-sm font-medium text-gray-200 mb-2">Details (min. 10 chars)</label>
                                <textarea id="feedbackTextPage" class="input-field h-32 bg-black/20 border-white/20 focus:border-indigo-400 placeholder-white/30" placeholder="Type your feedback here..."></textarea>
                            </div>
                            
                            <div id="feedbackMessagePage" class="hidden"></div>
                            
                            <button id="submitFeedbackPageBtn" class="btn btn-primary w-full shadow-lg hover:shadow-indigo-500/30 transition-all duration-300">
                                <span id="submitFeedbackPageBtnText">Submit Feedback</span>
                                <span id="submitFeedbackPageSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            
                            <div class="text-center mt-4">
                                <button class="btn-tertiary nav-link text-xs opacity-70 hover:opacity-100" data-page="home">Back to Home</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="templateDetail" class="page container mx-auto px-6 py-16">
            <button class="btn btn-secondary mb-8 nav-link" data-page="home">&larr; Back to Home</button>
            <div id="templateDetailContent" class="grid lg:grid-cols-2 gap-12">
                </div>
        </div>

        <div id="adminDashboard" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">Admin Dashboard</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Live analytics for S.A.G.E.</p>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Users Online</h3>
                    <p id="dashUsersOnline" class="text-4xl font-bold"></p>
                    <p class="text-white/60 text-sm mt-2">Approximate active visitors.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Total Queries</h3>
                    <p id="dashQueryCount" class="text-4xl font-bold">0</p>
                    <p class="text-white/60 text-sm mt-2">From live database stats.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Server Status</h3>
                    <div class="flex items-center gap-3">
                        <span id="dashServerDot" class="inline-block w-3 h-3 rounded-full bg-yellow-400"></span>
                        <span id="dashServerText">Checking</span>
                    </div>
                    <p class="text-white/60 text-sm mt-2">Reflects WebSocket connection.</p>
                </div>
            </div>

            <div class="glass-container mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Live Database Statistics</h3>
                    <button id="refreshStatsBtn" class="btn btn-primary">
                        <span id="refreshStatsBtnText">Refresh Stats</span>
                        <span id="refreshStatsSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                </div>

                <div id="statisticsContainer" class="grid md:grid-cols-2 gap-x-8 gap-y-4 text-white/90">
                    <div>
                        <h4 class="text-xl font-semibold mb-3 border-b border-white/20 pb-2">Database Status</h4>
                        <ul class="space-y-2">
                            <li><strong>Total Users:</strong> <span id="statTotalUsers"></span></li>
                            <li><strong>Active Users (1h):</strong> <span id="statActiveUsers"></span></li>
                            <li><strong>Total Queries:</strong> <span id="statTotalQueries"></span></li>
                            <li><strong>Database Size:</strong> <span id="statDbSize"></span></li>
                            <li><strong>Avg. Processing Time:</strong> <span id="statAvgTime"></span></li>
                            <li><strong>Last Recorded:</strong> <span id="statRecordedAt"></span></li>
                        </ul>
                    </div>
                    <div id="pineconeStatsContainer" class="hidden">
                        <h4 class="text-xl font-semibold mb-3 border-b border-white/20 pb-2">Vector Store Status</h4>
                        <ul class="space-y-2">
                            <li><strong>Index Name:</strong> <span id="statPineconeName"></span></li>
                            <li><strong>Total Vectors:</strong> <span id="statTotalVectors"></span></li>
                            <li><strong>Book Vectors:</strong> <span id="statBookVectors"></span></li>
                            <li><strong>Dimension:</strong> <span id="statPineconeDimension"></span></li>
                            <li><strong>Status:</strong> <span id="statPineconeStatus"></span></li>
                            <li><strong>Cloud/Region:</strong> <span id="statPineconeCloud"></span></li>
                        </ul>
                    </div>
                </div>
                <div id="statsMessage" class="hidden mt-4"></div>
            </div>
        </div>

        <div id="subscriptionInfo" class="page container mx-auto px-6 py-16">
            <div class="max-w-6xl mx-auto">
                
                <div class="text-center mb-12">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-300 to-purple-300">
                        Strategic Capacity & Billing
                    </h1>
                    <p class="text-lg text-white/70 max-w-2xl mx-auto">
                        Manage your plan, track usage limits, and upgrade your strategic capabilities.
                    </p>
                </div>

                <div id="subInfoLoading" class="text-center p-10">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-white/60">Retrieving subscription profile...</p>
                </div>

                <div id="subInfoContent" class="hidden space-y-8">

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <div class="glass-container p-6 relative overflow-hidden group border-t-4 border-indigo-500">
                            <h3 class="text-indigo-300 text-xs font-bold uppercase tracking-wider mb-2">Current Plan</h3>
                            <div id="subPlanName" class="text-3xl font-bold text-white mb-1">--</div>
                            <div id="subStatusBadge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-700 text-gray-300">
                                Loading...
                            </div>
                            <p id="subRenewalDate" class="text-xs text-white/50 mt-3">--</p>
                        </div>

                        <div class="glass-container p-6 relative overflow-hidden md:col-span-2 border-t-4 border-green-500">
                            <div class="flex justify-between items-end mb-2">
                                <div>
                                    <h3 class="text-green-300 text-xs font-bold uppercase tracking-wider mb-1">Monthly Analysis Credits</h3>
                                    <div class="text-3xl font-bold text-white">
                                        <span id="subUsageCount">0</span>
                                        <span class="text-lg text-white/40 font-normal">/ <span id="subUsageLimit">--</span></span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-white/50">Resets at 12am</p>
                                </div>
                            </div>
                            
                            <div class="w-full bg-white/10 rounded-full h-4 mb-4 overflow-hidden border border-white/5">
                                <div id="usageProgressBar" class="bg-gradient-to-r from-green-400 to-emerald-500 h-4 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                            </div>
                            
                            <p class="text-xs text-white/70">
                                <span class="font-semibold text-white">1 Credit</span> = 1 Full Strategic Analysis Generation (e.g., SWOT, OGSM, Predictive Model).
                            </p>
                        </div>
                    </div>

                    <div id="premiumActions" class="hidden">
                        <div class="glass-container p-8 border-l-4 border-purple-500 flex flex-col md:flex-row justify-between items-center gap-6">
                            <div>
                                <h3 class="text-xl font-bold text-white mb-2">Manage Your Subscription</h3>
                                <p class="text-white/70 text-sm">
                                    Update payment methods, download invoices, or cancel your plan via the secure Stripe Portal.
                                </p>
                            </div>
                            <button id="openStripePortalBtn" class="btn btn-secondary border-white/20 hover:bg-white/10 px-6 py-3">
                                 Open Billing Portal
                            </button>
                        </div>
                    </div>

                    <div id="upgradeSection" class="hidden">
                        </div>

                </div>
            </div>
        </div>

        <div id="examplesPage" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">AI Analysis Examples</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">See how S.A.G.E. can transform complex data
                into actionable strategic insights with these example outputs.</p>

            <div id="analysisCarousel" class="relative max-w-4xl mx-auto glass-container p-0">
                <div class="analysis-example-item">
                    <h2 class="text-3xl font-bold mb-4">Example: SWOT Analysis for "GlobalTech Solutions"</h2>
                    <div class="text-white/70">
                        <h3>STRENGTHS:</h3>
                        <ul>
                            <li><strong>Strong R&D Department:</strong> GlobalTech consistently innovates, holding numerous
                                patents in AI and quantum computing.</li>
                            <li><strong>Global Presence:</strong> Established offices and client base across North America,
                                Europe, and Asia.</li>
                            <li><strong>Talented Workforce:</strong> Highly skilled engineers and data scientists, fostering
                                a culture of excellence.</li>
                        </ul>

                        <h3>WEAKNESSES:</h3>
                        <ul>
                            <li><strong>High Operating Costs:</strong> Extensive R&D and global infrastructure lead to
                                significant overheads.</li>
                            <li><strong>Limited Marketing Reach:</strong> Reliance on word-of-mouth and niche industry
                                events, missing broader market segments.</li>
                            <li><strong>Bureaucratic Processes:</strong> Slow decision-making due to multi-layered approval
                                systems.</li>
                        </ul>

                        <h3>OPPORTUNITIES:</h3>
                        <ul>
                            <li><strong>Emerging Markets:</strong> Untapped potential in developing economies for AI-driven
                                solutions.</li>
                            <li><strong>Strategic Partnerships:</strong> Collaboration with hardware manufacturers to integrate
                                    AI software.</li>
                            <li><strong>Government Grants:</strong> Increased funding for AI research and development
                                initiatives.</li>
                        </ul>

                        <h3>THREATS:</h3>
                        <ul>
                            <li><strong>Intense Competition:</strong> Rapidly evolving tech landscape with new startups and
                                established giants.</li>
                            <li><strong>Talent Drain:</strong> High demand for skilled AI professionals leading to
                                competitive recruitment.</li>
                            <li><strong>Regulatory Changes:</strong> Evolving data privacy and AI ethics regulations
                                impacting product development.</li>
                        </ul>

                        <h3>Strategic Recommendations:</h3>
                        <ol>
                            <li><strong>Optimize Cost Structure:</strong> Implement agile methodologies to reduce R&D cycle
                                times and explore automation in operational processes.</li>
                            <li><strong>Expand Marketing Channels:</strong> Invest in digital marketing and content strategy
                                to reach a wider audience and enhance brand visibility.</li>
                            <li><strong>Forge Key Alliances:</strong> Actively pursue partnerships with complementary
                                technology providers to expand market reach and product offerings.</li>
                        </ol>
                    </div>
                </div>

                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Market Entry Strategy for "EcoCycle Innovations" into
                        Southeast Asia</h2>
                    <div class="text-white/70">
                        <h3>MARKET ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Market Size & Growth:</strong> Southeast Asia's recycling and waste management
                                market is projected to grow at a CAGR of 8% over the next five years, driven by increasing
                                environmental awareness and government initiatives.</li>
                            <li><strong>Customer Segments:</strong> Key segments include industrial waste generators,
                                municipal waste facilities, and commercial enterprises seeking sustainable solutions.</li>
                            <li><strong>Market Maturity:</strong> Varies by country; Singapore and Malaysia are more mature,
                                while Vietnam and Indonesia are emerging.</li>
                        </ul>

                        <h3>COMPETITIVE LANDSCAPE:</h3>
                        <ul>
                            <li><strong>Key Players:</strong> Dominated by local players with strong government ties and a
                                few international waste management giants.</li>
                            <li><strong>Competitive Advantages:</strong> Local players often have lower operational costs
                                and established networks. EcoCycle's advanced waste-to-energy technology offers a unique
                                value proposition.</li>
                        </ul>

                        <h3>ENTRY STRATEGY OPTIONS:</h3>
                        <ol>
                            <li><strong>Joint Venture (JV) with Local Partner:</strong> Recommended approach. A JV allows
                                EcoCycle to leverage local expertise, navigate regulatory complexities, and gain immediate
                                market access.
                                <ul>
                                    <li><strong>Pros:</strong> Reduced risk, faster market penetration, access to local
                                        networks.</li>
                                    <li><strong>Cons:</strong> Potential for cultural clashes, profit sharing.</li>
                                </ul>
                            </li>
                            <li><strong>Greenfield Investment:</strong> Building new facilities.
                                <ul>
                                    <li><strong>Pros:</strong> Full control, tailor-made operations.</li>
                                    <li><strong>Cons:</strong> High capital investment, long lead times, significant
                                        regulatory hurdles.</li>
                                </ul>
                            </li>
                        </ol>

                        <h3>Implementation Roadmap:</h3>
                        <ul>
                            <li><strong>Phase 1 (Months 1-6):</strong> Partner identification and due diligence. Focus on
                                countries with favorable regulatory environments (e.g., Malaysia, Thailand).</li>
                            <li><strong>Phase 2 (Months 7-18):</strong> JV formation and pilot project initiation. Secure
                                initial contracts with industrial clients.</li>
                            <li><strong>Phase 3 (Months 19-36):</strong> Scale operations, expand service offerings, and explore
                                    opportunities in other SEA markets.</li>
                        </ul>
                    </div>
                </div>

                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Digital Transformation Roadmap for "RetailX"</h2>
                    <div class="text-white/70">
                        <h3>VISION & OBJECTIVES:</h3>
                        <ul>
                            <li><strong>Vision:</strong> To become a leading omnichannel retailer, leveraging digital
                                technologies to enhance customer experience, optimize operations, and drive sustainable
                                growth.</li>
                            <li><strong>Objectives:</strong> Increase online sales by 30% within 2 years, reduce operational
                                costs by 15% through automation, and improve customer satisfaction scores by 20%.</li>
                        </ul>

                        <h3>CURRENT STATE ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Digital Capabilities:</strong> Fragmented legacy systems, limited e-commerce
                                capabilities, manual inventory management.</li>
                            <li><strong>Pain Points:</strong> Inconsistent customer experience across channels, inefficient
                                supply chain, lack of real-time data for decision-making.</li>
                        </ul>

                        <h3>KEY PILLARS OF TRANSFORMATION:</h3>
                        <ol>
                            <li><strong>Customer Experience:</strong> Unify online and offline channels, personalize
                                customer journeys.</li>
                            <li><strong>Operational Efficiency:</strong> Automate back-office processes, optimize supply
                                chain.</li>
                            <li><strong>Data & Analytics:</strong> Implement robust data infrastructure, leverage AI for
                                insights.</li>
                            <li><strong>Culture & Talent:</strong> Foster digital-first mindset, upskill workforce.</li>
                        </ol>

                        <h3>INITIATIVES & TECHNOLOGIES:</h3>
                        <ul>
                            <li><strong>Customer Experience:</strong> CRM implementation (Salesforce), E-commerce platform
                                upgrade (Shopify Plus), AI-powered chatbots.</li>
                            <li><strong>Operational Efficiency:</strong> ERP system integration (SAP), Warehouse Management
                                System (WMS), Robotic Process Automation (RPA) for routine tasks.</li>
                            <li><strong>Data & Analytics:</strong> Data Lake/Warehouse (Snowflake), Business Intelligence
                                tools (Tableau), Predictive Analytics.</li>
                            <li><strong>Culture & Talent:</strong> Digital literacy training, change management programs.</li>
                        </ul>

                        <h3>PHASED IMPLEMENTATION PLAN:</h3>
                        <ul>
                            <li><strong>Short-term (0-6 months):</strong> CRM implementation, basic e-commerce upgrade,
                                pilot RPA for finance.</li>
                            <li><strong>Mid-term (6-18 months):</strong> Full ERP integration, advanced e-commerce features,
                                initial data lake setup, comprehensive digital training.</li>
                            <li><strong>Long-term (18+ months):</strong> AI-driven personalization, predictive supply chain,
                                expansion into new digital services.</li>
                        </ul>

                        <h3>MEASUREMENT & KPIs:</h3>
                        <ul>
                            <li>Online Conversion Rate, Customer Lifetime Value, Order Fulfillment Time, Inventory Accuracy,
                                Employee Digital Proficiency.</li>
                        </ul>
                    </div>
                </div>

                <button id="prevExampleBtn" class="carousel-button left">&larr;</button>
                <button id="nextExampleBtn" class="carousel-button right">&rarr;</button>
            </div>
            <div class="text-center text-white/80 mt-4">
                <span id="exampleCounter">1 of 3</span>
            </div>

            <div class="text-center mt-12">
                 <button class="btn btn-primary nav-link" data-page="home">Back to Tools</button>
            </div>
        </div>

        <div id="blog" class="page container mx-auto px-6 py-16">
            <h1 class="text-5xl md:text-6xl font-extrabold text-white leading-tight mb-12 text-center">
                S.A.G.E. Blog
            </h1>
            <div id="blogCardContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="feature-card p-6 blog-article-link cursor-pointer" data-article-id="caos">
                    <h3 class="text-xl font-bold mb-2">Collective Appreciation of Strategy (CAOS)</h3>
                    <p class="text-white/70 text-sm">A process to analyze situations, identify challenges, and develop novel strategies.</p>
                </div>
                <div class="feature-card p-6 blog-article-link cursor-pointer" data-article-id="science-of-strategy">
                    <h3 class="text-xl font-bold mb-2">The Science of Strategy</h3>
                    <p class="text-white/70 text-sm">Understanding the systematic study and application of strategic principles to achieve long-term goals.</p>
                </div>
                <div class="feature-card p-6 blog-article-link cursor-pointer" data-article-id="mission-analysis">
                    <h3 class="text-xl font-bold mb-2">What is Mission Analysis?</h3>
                    <p class="text-white/70 text-sm">The process of breaking down a complex mission to understand what needs to be done and how to do it.</p>
                </div>
                <div class="feature-card p-6 blog-article-link cursor-pointer" data-article-id="strategic-mission">
                    <h3 class="text-xl font-bold mb-2">What is a Strategic Mission?</h3>
                    <p class="text-white/70 text-sm">Provides a clear and compelling sense of purpose, outlining core values, objectives, and goals.</p>
                </div>
                <div class="feature-card p-6 blog-article-link cursor-pointer" data-article-id="strategic-vision">
                    <h3 class="text-xl font-bold mb-2">What is a Strategic Vision?</h3>
                    <p class="text-white/70 text-sm">A powerful tool that helps organizations clarify their long-term objectives and aspirations.</p>
                </div>
                <div class="feature-card p-6 blog-article-link cursor-pointer" data-article-id="art-of-strategy">
                    <h3 class="text-xl font-bold mb-2">Science and Art of Strategy</h3>
                    <p class="text-white/70 text-sm">An essay by LTC Gurbachan Singh exploring the multi-disciplinary nature of warfare and strategy.</p>
                </div>
                <div class="feature-card p-6 blog-article-link cursor-pointer" data-article-id="operational-art">
                    <h3 class="text-xl font-bold mb-2">Operational Art in the Malayan Campaign</h3>
                    <p class="text-white/70 text-sm">A historical analysis of the Malayan Campaign through the lens of Operational Art by LTC Gurbachan Singh.</p>
                </div>
                <div class="feature-card p-6 blog-article-link cursor-pointer" data-article-id="strategic-leadership">
                    <h3 class="text-xl font-bold mb-2">Strategic Leadership</h3>
                    <p class="text-white/70 text-sm">Examining the critical role of leadership in formulating and executing effective strategy.</p>
                </div>
                <div class="feature-card p-6 blog-article-link cursor-pointer" data-article-id="innovation-nexus">
                    <h3 class="text-xl font-bold mb-2">The Strategy, Innovation & Entrepreneurship Nexus</h3>
                    <p class="text-white/70 text-sm">A draft thesis exploring the relationship between innovation, entrepreneurship, and strategy in SMEs.</p>
                </div>
            </div>
        </div>
        <div id="blogDetail" class="page container mx-auto px-6 py-16">
            <button class="btn btn-secondary mb-8 nav-link" data-page="blog">&larr; Back to Blog</button>
            <div id="blogDetailContent" class="glass-container p-6 md:p-10"></div>
        </div>

        <div id="emailVerifiedSuccess" class="page flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container text-center">
                    <h2 class="text-3xl font-bold mb-6 text-white"> Email Verified!</h2>
                    <p class="text-white/80 mb-6">
                        Thank you! Your email has been successfully verified. You can now log in to your account.
                    </p>
                    <div class="text-center">
                        <button class="btn btn-primary nav-link" data-page="login">Proceed to Login</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="emailVerifiedAlready" class="page flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container text-center">
                    <h2 class="text-3xl font-bold mb-6 text-white"> Already Verified</h2>
                    <p class="text-white/80 mb-6">
                        It looks like your email has already been verified. You're all set!
                    </p>
                    <div class="text-center">
                        <button class="btn btn-primary nav-link" data-page="login">Return to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="passwordResetRequest" class="page flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Reset Password</h2>
                    <p class="text-white/80 mb-6 text-center">Enter your email address and we will send you a link to reset your password.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="passwordResetEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="passwordResetEmail" class="input-field" placeholder="Enter your email" required>
                        </div>
                        <button id="passwordResetRequestBtn" class="btn btn-primary w-full">
                            <span id="passwordResetRequestBtnText">Send Reset Link</span>
                            <span id="passwordResetRequestSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="passwordResetRequestMessage" class="hidden"></div>
                    </div>
                    <div class="text-center mt-6">
                        <button class="btn-tertiary nav-link" data-page="login">Back to Login</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="passwordResetUpdate" class="page flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Create New Password</h2>
                    <p class="text-white/80 mb-6 text-center">Enter your new password below. You will be logged out after completion.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="passwordUpdatePassword" class="block text-sm font-medium text-gray-200 mb-2">New Password</label>
                            <input type="password" id="passwordUpdatePassword" class="input-field" placeholder="Create a new password" required>
                        </div>
                        <div>
                            <label for="passwordUpdateConfirmPassword" class="block text-sm font-medium text-gray-200 mb-2">Confirm New Password</label>
                            <input type="password" id="passwordUpdateConfirmPassword" class="input-field" placeholder="Confirm your new password" required>
                        </div>
                        <button id="passwordUpdateBtn" class="btn btn-primary w-full">
                            <span id="passwordUpdateBtnText">Update Password</span>
                            <span id="passwordUpdateSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="passwordUpdateMessage" class="hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedbackDetailModal" class="feedback-modal">
            <div class="feedback-modal-container">
                <div id="feedbackModalContent">
                    <!-- Content will be injected by JavaScript -->
                    <div class="modal-header">
                        <div class="modal-title-section">
                            <h3 class="modal-title">Loading...</h3>
                        </div>
                        <button class="modal-close-btn" id="modalCloseBtn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="flex items-center justify-center p-10">
                            <div class="loading-spinner mr-3"></div>
                            <span class="text-white/80">Loading details...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Modal -->
        <div id="contactDetailModal" class="feedback-modal">
            <div class="feedback-modal-container" style="max-width: 1000px;"> <div id="contactModalContent">
                    <div class="modal-header">
                        <div class="modal-title-section">
                            <h3 class="modal-title">Loading...</h3>
                        </div>
                        <button class="modal-close-btn" id="modalCloseContactBtn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="flex items-center justify-center p-10">
                            <div class="loading-spinner mr-3"></div>
                            <span class="text-white/80">Loading contact message...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="mt-auto py-8">
        <div class="container mx-auto text-center text-white/70">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="hover:text-white nav-link" data-page="about">About</a>
                <a href="#" class="hover:text-white nav-link" data-page="privacyPolicy">Privacy Policy</a>
                <a href="#" class="hover:text-white nav-link" data-page="termsOfService">Terms of Service</a>
            </div>
            <p>&copy; 2025 S.A.G.E. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">   
// =========================================================
// SCRIPT
// =========================================================
import { renderMermaidDiagram, renderFishboneDiagram } from '../js/diagrams/diagram-rendering.mjs';

document.addEventListener("DOMContentLoaded", () => {

    // --- Supabase Configuration ---
    const SUPABASE_URL = "https://supabase.sageaios.com";
    const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNjQwOTk1MjAwLCJleHAiOjE5NTYzNTUyMDB9.KHXKQpsN6MNB08H_IPxP4Gh0gjcsvXG9IeJuK3XpnAU";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        db: { schema: 'publicv2' }
    });

    // --- GLOBAL DOWNLOAD HELPER (Uses Python Backend) ---
    window.triggerBackendDownload = async function(category, filename) {
        // Construct the backend URL
        const url = `https://analysis.sageaios.com/api/samples/${category}/${filename}`;
        
        // Get the button element to show status
        const btn = event.currentTarget;
        const originalText = btn.innerText;
        
        try {
            btn.innerText = "Downloading...";
            btn.disabled = true;
            btn.style.opacity = "0.7";

            // Fetch the file as a "blob" (binary large object)
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Backend 404: File not found at ${url}`);
            }

            const blob = await response.blob();
            
            // Create a temporary invisible link to trigger the save
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = downloadUrl;
            a.download = filename; // The name the file will have on the user's computer
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            window.URL.revokeObjectURL(downloadUrl);
            a.remove();

            // Success Feedback
            btn.innerText = " Saved";
            btn.style.background = "rgba(16, 185, 129, 0.2)"; // Green tint
            btn.style.borderColor = "rgba(16, 185, 129, 0.5)";
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.background = ""; // Reset styles
                btn.style.borderColor = "";
            }, 2000);

        } catch (error) {
            console.error("Download failed:", error);
            alert("Download failed: " + error.message);
            btn.innerText = "Error ";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            }, 2000);
        }
    };

    

    // --- DOM Element References ---
    const $ = (id) => document.getElementById(id);
    const pages = document.querySelectorAll(".page");
    let currentTemplateId = null;
    let websocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectDelay = 3000;
    let pendingAnalysisRequests = new Map();

    // --- User Session State ---
    let userLoggedIn = false;
    let currentUser = null;
    let activeObservers = [];
    let currentUserTier = 'basic'; // <--- 1. ADD THIS VARIABLE

    // --- Admin Dashboard ---
    let statsInterval = null; // Admin Dashboard Stats Timer
    let currentFeedbackItems = []; // Caches the feedback list
    let currentContactItems = []; // Caches the contact list

    // --- NEW: Variables for merging async results ---
    let pendingOllamaResult = null;
    let pendingN8nResult = null;
    let currentAnalysisMessageId = null;
    let currentAnalysisContext = null;

    // --- Version Control State ---
    let currentSelectionLimit = 1; // Default to paid
    let selectedTemplateForModal = null;
    let preFillData = ""; // Used to pass context from home card to template detail

    // --- Analysis Cache ---
    const analysisCache = {};

    // --- Regression Analysis ---
    let currentRegressionRowCount = 0; // Stores the row count for ratio validation

    // --- Stripe ---
    const stripe = Stripe('pk_test_51SUzA4Dv9QN5xDTmXlUbWtgQxo2SZwZGGEf47pJZfUrND5pPV3LOaFX8aUELfzEVwPK67YvDvPZQfItugXa70ord00d27aMudy'); 
    let elements;

    // --- Usage ---
    let currentUserUsage = 0;
    const maxUsage = 3;

    // --- EDIT PROFILE LOGIC ---
    const editProfileModal = document.getElementById("editProfileModal");
    const openEditProfileBtn = document.getElementById("openEditProfileBtn");
    const closeEditProfileBtn = document.getElementById("closeEditProfileBtn");
    const saveProfileBtn = document.getElementById("saveProfileBtn");

    if (openEditProfileBtn) {
        openEditProfileBtn.addEventListener("click", (e) => {
            e.preventDefault();
            document.getElementById("profileDropdown").classList.add("hidden");
            if (!currentUser) return;

            const meta = currentUser.user_metadata || {};
            document.getElementById("editProfileFirstName").value = meta.first_name || "";
            document.getElementById("editProfileLastName").value = meta.last_name || "";
            document.getElementById("editProfileAvatarUrl").value = meta.avatar_url || "";

            updateModalPreview(meta.first_name, meta.last_name, meta.avatar_url);
            editProfileModal.style.display = 'flex';
            setTimeout(() => editProfileModal.classList.add('modal-open'), 10);
        });
    }

    function updateModalPreview(first, last, url) {
        const initialsEl = document.getElementById("modalAvatarInitials");
        const imgEl = document.getElementById("modalAvatarImg");
        if (url) {
            imgEl.src = url;
            imgEl.classList.remove("hidden");
            initialsEl.classList.add("hidden");
        } else {
            let initials = "U";
            if (first) {
                initials = first.charAt(0).toUpperCase();
                if (last) initials += last.charAt(0).toUpperCase();
            }
            initialsEl.textContent = initials;
            initialsEl.classList.remove("hidden");
            imgEl.classList.add("hidden");
        }
    }

    ['editProfileFirstName', 'editProfileLastName', 'editProfileAvatarUrl'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', () => {
            updateModalPreview(
                document.getElementById("editProfileFirstName").value,
                document.getElementById("editProfileLastName").value,
                document.getElementById("editProfileAvatarUrl").value
            );
        });
    });

    if (saveProfileBtn) {
        saveProfileBtn.addEventListener("click", async () => {
            const firstName = document.getElementById("editProfileFirstName").value.trim();
            const lastName = document.getElementById("editProfileLastName").value.trim();
            const avatarUrl = document.getElementById("editProfileAvatarUrl").value.trim();
            const msgEl = document.getElementById("editProfileMessage");
            
            saveProfileBtn.disabled = true;
            document.getElementById("saveProfileBtnText").textContent = "Saving...";
            document.getElementById("saveProfileSpinner").classList.remove("hidden");
            msgEl.className = "hidden";

            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) throw new Error("Not logged in.");

                // 1. Update Auth Metadata
                const { data: authData, error: authError } = await supabase.auth.updateUser({
                    data: { first_name: firstName, last_name: lastName, avatar_url: avatarUrl }
                });
                if (authError) throw authError;

                // 2. Update Public Database
                const { error: dbError } = await supabase
                    .from('users')
                    .update({ first_name: firstName, last_name: lastName }) // Add avatar_url here if column exists
                    .eq('auth_user_id', session.user.id);
                
                if (dbError) console.warn("DB sync warning:", dbError);

                currentUser = authData.user;
                updateNavBar();
                
                msgEl.textContent = "Profile updated!";
                msgEl.className = "text-green-400 bg-green-900/20 p-2 rounded block mb-2";
                
                setTimeout(() => {
                    editProfileModal.classList.remove('modal-open');
                    setTimeout(() => editProfileModal.style.display = 'none', 300);
                    saveProfileBtn.disabled = false;
                    document.getElementById("saveProfileBtnText").textContent = "Save Changes";
                    document.getElementById("saveProfileSpinner").classList.add("hidden");
                    msgEl.className = "hidden";
                }, 1500);

            } catch (err) {
                console.error(err);
                msgEl.textContent = err.message;
                msgEl.className = "text-red-400 bg-red-900/20 p-2 rounded block mb-2";
                saveProfileBtn.disabled = false;
                document.getElementById("saveProfileBtnText").textContent = "Save Changes";
                document.getElementById("saveProfileSpinner").classList.add("hidden");
            }
        });
    }

    if (closeEditProfileBtn) {
        closeEditProfileBtn.addEventListener("click", () => {
            editProfileModal.classList.remove('modal-open');
            setTimeout(() => editProfileModal.style.display = 'none', 300);
        });
    }

    // --- GLOBAL STATE FOR SAMPLES ---
    window.tempSampleDataFile = null;    // Holds the CSV File object
    window.tempSampleContextFile = null; // Holds the Text/Context File object

    // --- SETTINGS & THEME LOGIC ---
    
    const settingsModal = document.getElementById("settingsModal");
    const openSettingsBtn = document.getElementById("openSettingsBtn");
    const closeSettingsBtn = document.getElementById("closeSettingsBtn");
    const themeOptions = document.querySelectorAll(".theme-option");

    // 1. Open Settings Modal
    if (openSettingsBtn && settingsModal) {
        openSettingsBtn.addEventListener("click", (e) => {
            e.preventDefault();
            // Close profile dropdown if open
            const dropdown = document.getElementById("profileDropdownContainer")?.querySelectorAll("div")[1];
            if(dropdown) dropdown.classList.add("hidden");
            const userMenuBtn = document.getElementById("user-menu-button");
            if(userMenuBtn) userMenuBtn.setAttribute("aria-expanded", "false");

            // Open Modal
            settingsModal.style.display = 'flex';
            setTimeout(() => settingsModal.classList.add('modal-open'), 10);
        });
    }

    // 2. Close Settings Modal
    if (closeSettingsBtn && settingsModal) {
        closeSettingsBtn.addEventListener("click", () => {
            settingsModal.classList.remove('modal-open');
            setTimeout(() => settingsModal.style.display = 'none', 300);
        });
    }

    // 3. Apply Theme Function (Final)
    function applyTheme(themeName) {
        // 1. Define ALL possible theme classes
        const allThemes = [
            "theme-ocean", "theme-sunset", "theme-cyber", 
            "theme-forest", "theme-royal", "theme-crimson", 
            "theme-coffee", "theme-aurora", "theme-midnight", 
            "theme-candy", "theme-slate"
        ];

        // 2. REMOVE all theme classes first (resets to default)
        document.body.classList.remove(...allThemes);
        
        // 3. ADD the new theme class (unless it's 'default')
        if (themeName && themeName !== 'default') {
            document.body.classList.add(`theme-${themeName}`);
        }

        // 4. Update the visual selection in the modal
        document.querySelectorAll(".theme-preview").forEach(el => el.classList.remove("active-theme"));
        const activeOption = document.querySelector(`.theme-option[data-theme="${themeName}"] .theme-preview`);
        if (activeOption) activeOption.classList.add("active-theme");

        // 5. Save preference
        localStorage.setItem("sage_theme", themeName);
    }

    // 4. Attach Click Listeners to Theme Options
    if (themeOptions) {
        themeOptions.forEach(option => {
            option.addEventListener("click", () => {
                const theme = option.dataset.theme;
                applyTheme(theme);
            });
        });
    }

    // 5. Load Saved Theme on Page Load
    const savedTheme = localStorage.getItem("sage_theme") || "default";
    applyTheme(savedTheme);

    // --- Template Data ---
    const templates = {
        "custom-template": {
            title: "Custom Strategy Generator",
            description: "Design your own strategic analysis by defining the type of strategy, company, and location.",
            isPremium: true
        },
        "vision-mission-goals": {
            title: "Vision & Mission Planning",
            description: "A unified tool to define your organization's guiding purpose, future state, and core goals."
        },
        swot: {
            title: "SWOT Analysis",
            description: "Analyze your organization's Strengths, Weaknesses, Opportunities, and Threats."
        },
        "swot-tows": {
            title: "SWOT/TOWS Analysis",
            description:
                "Develop strategies by matching internal factors (Strengths, Weaknesses) to external factors (Opportunities, Threats)."
        },
        "pareto-fishbone": {
            title: "Pareto & Fishbone Analysis",
            description:
                "A combined approach to identify the root causes of problems (Fishbone) and prioritize them based on impact (Pareto)."
        },
        "external-analysis": {
            title: "External Analysis",
            description:
                "Analyze the external environment (market, competition, trends) to identify opportunities and threats."
        },
        "internal-analysis": {
            title: "Internal Analysis",
            description:
                "Evaluate your organization's internal strengths and weaknesses in resources, capabilities, and core competencies."
        },
        "advanced-system-analysis": {
            title: "Advanced System Analysis",
            description:
                "Model complex systems to understand interdependencies, feedback loops, and high-leverage intervention points."
        },
        "archetype-analysis": {
            title: "Archetype Analysis",
            description:
                "Identify and analyze recurring patterns of behavior (archetypes) within your system or market."
        },
        "creative-dissonance": {
            title: "Creative Dissonance Analysis",
            description:
                "Explore the gap between your current reality and desired future to fuel innovation and strategic change."
        },
        "reframing-thinking": {
            title: "Reframing Thinking Analysis",
            description:
                "Apply the reframing technique to look at problems from new perspectives and unlock creative solutions."
        },
        "delphi-method": {
            title: "Delphi Method Analysis",
            description:
                "Utilize the Delphi method to gather and synthesize expert opinions for forecasting and decision-making."
        },
        "blue-ocean": {
            title: "Blue Ocean Strategy",
            description: "Focuses on creating uncontested market space rather than competing in existing industries."
        },
        "design-thinking": {
            title: "Design Thinking",
            description: "A human-centered, iterative process for creative problem-solving and innovation."
        },
        "thinking-hats": {
            title: "Thinking Hats Analysis",
            description: "Apply Edward de Bono's system for parallel thinking to explore an issue comprehensively."
        },
        scamper: {
            title: "SCAMPER Analysis",
            description:
                "A creative thinking technique using seven prompts (Substitute, Combine, Adapt, Modify, Put to another use, Eliminate, Reverse) to innovate."
        },
        triz: {
            title: "TRIZ Analysis",
            description:
                "A systematic approach based on the study of global patent patterns to find innovative solutions to technical problems."
        },
        "regression-analysis": {
            title: "Regression Analysis",
            description:
                "Use statistical regression to model and analyze the relationships between variables for predictive insights."
        },
        "pls-analysis": {
            title: "PLS Analysis",
            description:
                "Apply Partial Least Squares (PLS) for structural equation modeling, especially with complex models and non-normal data."
        },
        "dematel-analysis": {
            title: "Dematel Analysis",
            description:
                "Understand causal relationships between complex factors to identify core problems and effective leverage points."
        },
        competitor: {
            title: "Competitor Analysis",
            description: "Deep dive into competitor strategies, market positioning, and competitive advantages."
        },
        "market-entry": {
            title: "Market Entry Strategy",
            description: "Evaluate market opportunities, entry barriers, and develop a roadmap for market penetration."
        },
        risk: {
            title: "Risk Assessment",
            description: "Identify, evaluate, and develop mitigation strategies for business risks."
        },
        "business-model": {
            title: "Business Model Canvas",
            description: "Design and analyze your business model using the proven 9-building-block framework."
        },
        "digital-transformation": {
            title: "Digital Transformation Roadmap",
            description: "Plan your organization's journey towards digital maturity."
        },
        "predictive-analysis": {
            title: "Predictive Analysis",
            description:
                "Upload your dataset (e.g., CSV) to forecast future trends and outcomes based on historical data."
        }
    };

    // --- Template UI Rules ---
    const templateRules = {
        "thinking-system": { useThinkingSystemLayout_NS: true },
        "sem-analysis": { useSemAnalysisLayout: true },
        "predictive-analysis": { usePredictiveAnalysisLayout: true },
        "living-system": { useLivingSystemLayout_NS: true },
        "creative-dissonance": { useCreativeDissonanceLayout_NS: true },
        "system-actions": { useSystemActionsLayout_ST: true },
        "system-objectives": { useSystemObjectivesLayout_ST: true },
        "descriptive-analysis": { useDescriptiveLayout_DA: true },
        visualization: { useVisualizationLayout_DA: true },
        "pls-analysis": { usePlsLayout_DA: true },
        "mission-vision": { hideAnalysisSection: true, hideFrameworks: true },
        "regression-analysis": { useRegressionLayout_DA: true },
        "novel-goals-initiatives": { useNovelGoalsLayout_NS: true },
        "misc-summary": { useMiscLayout_MSC: true },
        "kpi-events": { useKpiLayout_KE: true },
        "action-plans": { useActionPlansLayout_AP: true },
        objectives: { hideAnalysisSection: true, hideFrameworks: true },
        "goals-initiatives": { useGoalsAndInitiativesLayout_SP: true },
        swot: { hideAnalysisSection: true },
        "swot-tows": { useSwotLayout: true },
        "leverage-points": { useLeveragePointsLayout: true },
        "system-goals-initiatives": { useSystemGoalsLayout: true },
        "archetype-analysis": { useArchetypeLayout: true },
        "factor-analysis": { useFactorAnalysisLayout: true },
        "process-mapping": { useProcessMappingLayout: true },
        "system-thinking-analysis": { useSystemThinkingLayout: true },
        competitor: { hideAnalysisSection: true },
        "market-entry": { hideAnalysisSection: true },
        risk: { hideAnalysisSection: true },
        "pareto-fishbone": { useParetoLayout: true, hideAnalysisSection: true, hideFrameworks: true },
        "external-analysis": { hideAnalysisSection: true },
        "internal-analysis": { hideAnalysisSection: true },
        "prescriptive-analysis": { usePrescriptiveLayout_DA: true },
        "dematel-analysis": { useDematelLayout: true },
        "digital-transformation": { hideAnalysisSection: true },
        "delphi-method": { preselectFramework: "Delphi Method", hideAnalysisSection: true },
        "blue-ocean": { preselectFramework: "Blue Ocean Strategy", hideAnalysisSection: true },
        "design-thinking": { preselectFramework: "Design Thinking", hideAnalysisSection: true },
        "thinking-hats": { preselectFramework: "Thinking Hats", hideAnalysisSection: true },
        "business-model": { preselectFramework: "Business Model Canvas", hideAnalysisSection: true },
        scamper: { preselectFramework: "SCAMPER", hideAnalysisSection: true },
        triz: { preselectFramework: "TRIZ (Theory of Inventive Problem Solving)", hideAnalysisSection: true },
        "reframing-thinking": { preselectFramework: "Reframing Thinking", hideAnalysisSection: true }
    };

    // WebSocket Management Functions
    function initializeWebSocket() {
        const wsStatus = document.getElementById("wsStatus");

        try {
            websocket = new WebSocket("wss://n8n-api.sageaios.com/ws");

            wsStatus.textContent = "Connecting...";
            wsStatus.className = "ws-status connecting";

            websocket.onopen = function (event) {
                console.log("WebSocket connected successfully");
                wsStatus.textContent = "Connected";
                wsStatus.className = "ws-status connected";
                reconnectAttempts = 0;
            };

            websocket.onmessage = function (event) {
                console.log("Received WebSocket message:", event.data);

                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error("Error parsing WebSocket message:", error);
                }
            };

            websocket.onclose = function (event) {
                console.log("WebSocket connection closed:", event.code, event.reason);
                wsStatus.textContent = "Disconnected";
                wsStatus.className = "ws-status disconnected";

                if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        console.log(`WebSocket reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                        initializeWebSocket();
                    }, reconnectDelay);
                }
            };

            websocket.onerror = function (error) {
                console.error("WebSocket error:", error);
                wsStatus.textContent = "Error";
                wsStatus.className = "ws-status disconnected";
            };
        } catch (error) {
            console.error("Failed to initialize WebSocket:", error);
            wsStatus.textContent = "Failed";
            wsStatus.className = "ws-status disconnected";
        }
    }

    // --- HELPER: Fetch file from Python Backend ---
    async function fetchFileAsObject(relativePath) {
        // relativePath example: "predictive/predictive-sample-data.csv"
        
        // 1. Construct the Backend URL
        const API_BASE = "https://analysis.sageaios.com/api/samples";
        const url = `${API_BASE}/${relativePath}`;

        console.log(`Attempting to fetch sample from: ${url}`);

        try {
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Backend 404: File not found at ${url}`);
            }

            const blob = await response.blob();
            // Extract filename from path
            const fileName = relativePath.substring(relativePath.lastIndexOf('/') + 1);
            
            return new File([blob], fileName, { type: blob.type });
        } catch (error) {
            console.error("Sample fetch error:", error);
            throw error;
        }
    }

    // --- Use Sample Handler (Populates Inputs & Globals) ---
    async function handleUseSampleClick(e) {
        const button = e.currentTarget;
        const templateId = button.dataset.templateId;
        if (!templateId) return;

        // Store original text to restore it later
        const originalText = " Use Sample"; 
        
        button.disabled = true;
        button.innerHTML = `<span class="loading-spinner" style="width: 12px; height: 12px; margin-right: 5px;"></span> Loading...`;
        
        // 1. Reset Globals
        window.isSampleModeActive = false; 
        window.tempSampleDataFile = null;
        window.tempSampleContextFile = null;

        // Helper: "Force Upload" a file into an input element
        const forceInputFile = (inputId, fileObj) => {
            const input = $(inputId);
            if (!input || !fileObj) return;

            // The Trick: Use DataTransfer to simulate a user upload
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(fileObj);
            input.files = dataTransfer.files;

            // Trigger visual update on the label
            const labelId = inputId + "Label"; 
            const label = $(labelId);
            if (label) {
                const nameSpan = label.querySelector(".file-name");
                if (nameSpan) nameSpan.textContent = fileObj.name;
                label.classList.add("has-file");
            }
        };

        // Helper to build preview table
        const buildPreview = (csvText) => {
            if (!csvText) return '<tbody><tr><td class="p-4 text-center text-white/60">Empty file.</td></tr></tbody>';
            const lines = csvText.split(/[\r\n]+/).filter(Boolean);
            if (lines.length < 1) return '<tbody><tr><td class="p-4 text-center text-white/60">No data.</td></tr></tbody>';
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            let html = '<thead class="bg-white/10 text-xs uppercase"><tr>' + headers.map(h => `<th class="px-4 py-2">${h}</th>`).join('') + '</tr></thead><tbody>';
            lines.slice(1, 6).forEach((line, i) => {
                const vals = line.split(',');
                html += `<tr class="border-t border-white/10 ${i%2===0?'bg-white/5':''}">${vals.map(v => `<td class="px-4 py-2">${v}</td>`).join('')}</tr>`;
            });
            return html + '</tbody>';
        };

        try {
            await new Promise(r => setTimeout(r, 300));
            let dataFile, contextFile, dataText, contextText;

            switch (templateId) {
                case "descriptive-analysis":
                    dataFile = await fetchFileAsObject('descriptive/descriptive-sample-data.csv');
                    contextFile = await fetchFileAsObject('descriptive/descriptive-sample-doc.txt');
                    forceInputFile("descriptiveFile", dataFile);
                    forceInputFile("descriptiveContextFile", contextFile);
                    window.tempSampleDataFile = dataFile;
                    window.tempSampleContextFile = contextFile;
                    dataText = await dataFile.text();
                    contextText = await contextFile.text();
                    $("descriptivePreviewTable").innerHTML = buildPreview(dataText);
                    $("descriptiveDataPreview").classList.remove("hidden");
                    $("descriptiveContextText").value = contextText;
                    break;
                
                case "visualization":
                    dataFile = await fetchFileAsObject('visualization/visualization-sample.csv');
                    contextFile = await fetchFileAsObject('visualization/visualization-sample-doc.txt');
                    forceInputFile("vizFile", dataFile);
                    forceInputFile("vizContextFile", contextFile);
                    window.tempSampleDataFile = dataFile;
                    window.tempSampleContextFile = contextFile;
                    dataText = await dataFile.text();
                    contextText = await contextFile.text();
                    $("vizPreviewTable").innerHTML = buildPreview(dataText);
                    $("vizDataPreview").classList.remove("hidden");
                    $("vizRequestText").value = contextText;
                    break;

                case "prescriptive-analysis":
                    dataFile = await fetchFileAsObject('prescriptive/prescriptive-sample-data.csv');
                    contextFile = await fetchFileAsObject('prescriptive/prescriptive-sample-doc.txt');
                    forceInputFile("prescriptiveFile", dataFile);
                    forceInputFile("prescriptiveContextFile", contextFile);
                    window.tempSampleDataFile = dataFile;
                    window.tempSampleContextFile = contextFile;
                    dataText = await dataFile.text();
                    contextText = await contextFile.text();
                    $("prescriptivePreviewTable").innerHTML = buildPreview(dataText);
                    $("prescriptiveDataPreview").classList.remove("hidden");
                    $("prescriptiveGoalText").value = contextText;
                    break;

                case "predictive-analysis":
                    dataFile = await fetchFileAsObject('predictive/predictive-sample-data.csv');
                    
                    // 1. Set Global (Critical for backend if file mode is used)
                    window.tempSampleDataFile = dataFile;
                    
                    // 2. Get Text content
                    dataText = await dataFile.text();
                    
                    // 3. Populate UI - TEXT AREA (Visual Feedback)
                    $("predictiveDataText").value = dataText;

                    // 4. Populate UI - FILE INPUT (So it is ready if they switch tabs)
                    forceInputFile("predictiveFile", dataFile);
                    
                    // 5. Force UI to Text Mode initially (Ensure it's visible)
                    $("predictiveInputTextToggle").checked = true;
                    $("predictiveInputFileToggle").checked = false;
                    $("predictiveTextInputArea").classList.remove("hidden");
                    $("predictiveFileUploadArea").classList.add("hidden");

                    // 6. Previews & Dropdowns
                    $("predictivePreviewTable").innerHTML = buildPreview(dataText);
                    $("predictiveDataPreview").classList.remove("hidden");
                    
                    const headers = dataText.split('\n')[0].split(',');
                    $("assumedDateColName").textContent = headers[0];
                    
                    const targetSelect = $("predictiveTargetColumn");
                    targetSelect.innerHTML = "";
                    headers.slice(1).forEach(h => targetSelect.add(new Option(h, h)));
                    targetSelect.value = headers[1];
                    targetSelect.disabled = false;
                    break;

                case "regression-analysis":
                    dataFile = await fetchFileAsObject('regression/regression-sample.csv');
                    contextFile = await fetchFileAsObject('regression/regression-sample-doc.txt');

                    // 1. Set Globals
                    window.tempSampleDataFile = dataFile;
                    window.tempSampleContextFile = contextFile;

                    // 2. Get Text Content
                    dataText = await dataFile.text();
                    contextText = await contextFile.text();

                    // 3. Populate UI - Text Areas
                    $("regressionContextText").value = contextText;
                    const regDataTextArea = document.getElementById("regressionDataText");
                    if(regDataTextArea) regDataTextArea.value = dataText;

                    // 4. Populate File Inputs (background)
                    forceInputFile("regressionFile", dataFile);
                    forceInputFile("regressionContextFile", contextFile);

                    // 5. Force UI to Text Mode
                    const regTextToggle = $("textInput");
                    const regFileToggle = $("docUpload");
                    const regTextArea = $("regressionContextTextArea");
                    const regFileArea = $("regressionContextFileArea");
                    
                    if(regTextToggle && regTextArea) {
                        regTextToggle.checked = true;
                        regTextArea.classList.remove("hidden");
                        if(regFileArea) regFileArea.classList.add("hidden");
                    }

                    // 6. Generate Preview
                    $("regressionPreviewTable").innerHTML = buildPreview(dataText);
                    $("regressionDataPreview").classList.remove("hidden");

                    // 7. POPULATE & SELECT VARIABLES
                    const regHeaders = dataText.split('\n')[0].split(',').map(h => h.trim());
                    const regDepSelect = $("dependentVar");
                    const regIndepContainer = $("independentVarsContainer");
                    
                    // Clear previous
                    regDepSelect.innerHTML = "";
                    regIndepContainer.innerHTML = "";
                    
                    // --- FIX: MATCHING THE SCREENSHOT EQUATION ---
                    // Y (Target) is 'marketing_spend'
                    // X (Predictors) includes 'sales_revenue'
                    const sampleTarget = "marketing_spend";
                    const samplePredictors = ["sales_revenue", "product_price", "customer_rating", "region"];

                    regHeaders.forEach(h => {
                        // Add to Dependent Dropdown
                        regDepSelect.add(new Option(h, h));

                        // Add to Independent Checkboxes
                        const isChecked = samplePredictors.includes(h) ? "checked" : "";
                        
                        regIndepContainer.innerHTML += `
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="method-checkbox independent-var-checkbox" value="${h}" ${isChecked}>
                                <span>${h}</span>
                            </label>`;
                    });

                    // Set Dependent Value
                    regDepSelect.value = sampleTarget;
                    regDepSelect.disabled = false;
                    break;

                case "pls-analysis":
                case "sem-analysis":
                    const isPls = templateId === "pls-analysis";
                    const path = isPls ? 'pls/pls-sample-data.csv' : 'sem/sem-sample-data.csv';
                    const prefix = isPls ? "pls" : "sem";
                    
                    // 1. Fetch File
                    dataFile = await fetchFileAsObject(path);
                    window.tempSampleDataFile = dataFile;

                    // 2. Get Text Content
                    dataText = await dataFile.text();
                    
                    // 3. Populate UI - TEXT AREA (Visual Feedback)
                    $(`${prefix}DataText`).value = dataText;

                    // 4. Populate UI - FILE INPUT (Background)
                    forceInputFile(prefix + "File", dataFile);

                    // 5. Force UI to Text Mode (Ensure it's visible)
                    $(`${prefix}InputTextToggle`).checked = true;
                    $(`${prefix}InputFileToggle`).checked = false;
                    $(`${prefix}TextInputArea`).classList.remove("hidden");
                    $(`${prefix}FileUploadArea`).classList.add("hidden");

                    // 6. Previews
                    $(`${prefix}PreviewTable`).innerHTML = buildPreview(dataText);
                    $(`${prefix}DataPreview`).classList.remove("hidden");
                    
                    // 7. Set Model Template & Syntax
                    $(`${prefix}ModelTemplate`).innerHTML = `<option value="custom">Custom Syntax</option>`;
                    $(`${prefix}ModelTemplate`).value = "custom";
                    
                    if (isPls) {
                         $(`${prefix}MeasurementSyntax`).value = "Quality =~ qual1 + qual2 + qual3\nSatisfaction =~ sat1 + sat2 + sat3\nLoyalty =~ loy1 + loy2 + loy3";
                    } else {
                         $(`${prefix}MeasurementSyntax`).value = "Marketing_Performance =~ Ad_Spend_USD + Brand_Awareness_Pct\nSales_Performance =~ Online_Sales_USD + Retail_Sales_USD + Total_Sales_USD\nCustomer_Metrics =~ New_Customers_Count + Sales_Per_Customer";
                    }
                    $(`${prefix}StructuralSyntax`).value = "Sales_Performance ~ Marketing_Performance\nCustomer_Metrics ~ Marketing_Performance + Sales_Performance\nProfit_USD ~ Sales_Performance + Customer_Metrics";
                    break;

                case "dematel-analysis":
                    contextFile = await fetchFileAsObject('dematel/dematel-sample-doc.txt');
                    
                    // 1. Set Globals
                    window.tempSampleContextFile = contextFile;
                    
                    // 2. Get Text Content
                    contextText = await contextFile.text();

                    // 3. Populate Text Area (Visible View)
                    $("dematelContent").value = contextText;

                    // 4. Populate File Input (Background View)
                    forceInputFile("dematelFile", contextFile);

                    // 5. FIX: Populate the File Preview Box (Background View)
                    // This ensures that if you toggle to "Document Upload", the preview is valid and visible.
                    const dematelPreview = $("dematelFilePreview");
                    const dematelPreviewContainer = $("dematelFilePreviewContainer");
                    
                    if (dematelPreview && dematelPreviewContainer) {
                        const first10Lines = contextText.split('\n').slice(0, 10).join('\n');
                        dematelPreview.textContent = first10Lines;
                        dematelPreviewContainer.classList.remove("hidden");
                    }

                    // 6. Force UI to TEXT INPUT Mode
                    $("dematelInputTextToggle").checked = true;    // Check Text Input
                    $("dematelInputFileToggle").checked = false;   // Uncheck File Upload
                    $("dematelTextInputArea").classList.remove("hidden"); // Show Text Area
                    $("dematelFileUploadArea").classList.add("hidden");   // Hide File Area
                    break;
            }

            window.isSampleModeActive = true;
            button.innerHTML = ` Sample Loaded!`;
            
            // --- FIX START: Re-enable the button after 2 seconds ---
            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            }, 1000);
            // --- FIX END ---

        } catch (error) {
            console.error("Error in handleUseSampleClick:", error);
            alert(`Failed to load sample data: ${error.message}`);
            window.isSampleModeActive = false;
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    async function fetchOllama(systemPrompt, userContext, analysisType) {
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const OLLAMA_MODEL = "llama3.1:latest";
        const MAX_CONTEXT_LENGTH = 100000;
        let userPrompt = userContext;
        let truncatedNote = "";

        if (userPrompt.length > MAX_CONTEXT_LENGTH) {
            userPrompt = userPrompt.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
        }

        const fullPrompt = `${systemPrompt}\n\n${userPrompt}\n\n${truncatedNote}`;
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                model: OLLAMA_MODEL,
                prompt: fullPrompt,
                stream: false,
                format: "json",
                options: { num_ctx: 32768 }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log(`Raw AI Response ${analysisType}:`, data.response); // Log raw response
        return JSON.parse(data.response);
    }


    async function fetchGroq(systemPrompt, userContext, analysisType) {
        const GROQ_URL = "https://matt-groq.data2int.com/api/groq/chat";
        const GROQ_MODEL = "llama-3.1-8b-instant";
        const messages = [
                {"role": "system", "content": `${systemPrompt}`},
                {"role": "user", "content": `${userContext}`}
            ]

            const response = await fetch(GROQ_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    model: GROQ_MODEL, 
                    messages: messages, 
                    stream: false, 
                    response_format: { type: "json_object" }
                })
            });

            if (!response.ok) {
                let errorBody = `Groq API Proxy error ${response.status}`;
                try { errorBody += `: ${await response.text()}`; } catch (e) {}
                throw new Error(errorBody);
            }
            
            const data = await response.json();
            console.log(`Raw AI Response ${analysisType}:`, data.response); // Log raw response
            return JSON.parse(data.choices[0].message.content);
    }


    async function fetchOpenRouter(systemPrompt, userContext, jsonSchema, analysisType) {
        const OPRT_URL = "https://matt-groq.data2int.com/api/oprt/chat";
        const OPRT_MODEL = "openai/gpt-oss-20b:free";
        const messages = [
                {"role": "user", "content": `${systemPrompt}\n\n${userContext}`}
            ]

        console.log("JSON Schema: ", jsonSchema);

            const response = await fetch(OPRT_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    model: OPRT_MODEL, 
                    messages: messages, 
                    stream: false, 
                    response_format: jsonSchema
                })
            });

            if (!response.ok) {
                let errorBody = `Open Router API Proxy error ${response.status}`;
                try { errorBody += `: ${await response.text()}`; } catch (e) {}
                throw new Error(errorBody);
            }
            
            console.log(`Fetched from model: ${OPRT_MODEL}`);
            const data = await response.json();
            console.log(`Raw AI Response ${analysisType}:`, data.response); // Log raw response
            return JSON.parse(data.choices[0].message.content);
    }


    async function fetchLLM(provider, systemPrompt, userContext, jsonSchema, analysisType) {
        try {
            if (provider === "ollama") {
                return await fetchOllama(systemPrompt, userContext, analysisType);
            } else if (provider === "groq") {
                return await fetchGroq(systemPrompt, userContext, analysisType);
            } else if (provider == "open-router") {
                return await fetchOpenRouter(systemPrompt, userContext, jsonSchema, analysisType);
            }
        } catch (error) {
            console.error(`Error calling ${provider}:`, error);
            throw error;
        }
    }

    function fitDiagram(cy) {
        cy.fit(null, 60);
    }

    function resetZoom(cy) {
        cy.zoom(1);
        cy.center();
    }

    function exportPNG(cy, filename = 'diagram.png') {
        const png = cy.png({ full: true, scale: 2, bg: '#383838cc' });
        const link = document.createElement('a');
        link.href = png;
        link.download = filename;
        link.click();
    }

   // =========================================================
    // ===== REVISED EXPORT FUNCTIONS (Using html2canvas) =====
    // =========================================================

    // --- REVISED PDF Export Logic (Image-based) ---
    async function handleSaveAsPdf(filename = "SAGE_Analysis.pdf") {
        // 1. Check Libraries
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
            alert("Error: jsPDF library not loaded."); return;
        }
        if (typeof window.html2canvas === 'undefined') {
            alert("Error: html2canvas library not loaded."); return;
        }

        const { jsPDF } = window.jspdf;
        const analysisResultElement = $("analysisResult");

        if (!analysisResultElement || !analysisResultElement.hasChildNodes() || analysisResultElement.innerText.includes("Your generated analysis will appear here.")) {
            alert("No analysis content found to save.");
            return;
        }

        alert("Preparing PDF screenshot... Please wait.");
        console.log("Starting PDF generation via html2canvas...");

        try {
            // 2. Use html2canvas to capture the element
            const canvas = await html2canvas(analysisResultElement, {
                scale: 2, // Increase scale for better resolution
                useCORS: true, // If you ever load images from other domains
                logging: true // Enable logging for debugging
            });

            console.log("Canvas generated from HTML content.");

            // 3. Convert canvas to image data
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;

            // 4. Create PDF and add image (potentially sliced)
            const doc = new jsPDF({
                orientation: imgWidth > imgHeight ? 'l' : 'p', // Use landscape if wider
                unit: 'pt',
                format: 'a4'
            });

            const pdfPageWidth = doc.internal.pageSize.getWidth();
            const pdfPageHeight = doc.internal.pageSize.getHeight();
            const margin = 20; // Small margin for image

            // Calculate image dimensions to fit page width
            const availableWidth = pdfPageWidth - margin * 2;
            const availableHeight = pdfPageHeight - margin * 2;

            const aspectRatio = imgHeight / imgWidth;
            let pdfImgWidth = availableWidth;
            let pdfImgHeight = pdfImgWidth * aspectRatio;

            // If scaled image is taller than available page height, scale based on height instead
            if (pdfImgHeight > availableHeight) {
                pdfImgHeight = availableHeight;
                pdfImgWidth = pdfImgHeight / aspectRatio;
            }

            // Calculate how many pages are needed based on the *original* canvas height
            // relative to the scaled height that fits *within* one PDF page.
            const totalPdfHeight = (imgHeight / imgWidth) * pdfImgWidth; // Total height the image would occupy in PDF units if not sliced
            const pageHeightToFitOneSlice = pdfImgHeight; // The height of one slice as it appears on the PDF page
            const numPages = Math.ceil(totalPdfHeight / pageHeightToFitOneSlice);


             console.log(`Original Canvas: ${imgWidth}x${imgHeight} | PDF Image Size per page: ${pdfImgWidth.toFixed(0)}x${pageHeightToFitOneSlice.toFixed(0)} | Total PDF Height: ${totalPdfHeight.toFixed(0)} | Pages: ${numPages}`);

            // Add image slices page by page
            let currentCanvasY = 0; // Position on the source canvas
            for (let i = 1; i <= numPages; i++) {
                if (i > 1) {
                    doc.addPage();
                }
                // Calculate the portion of the canvas to draw for this page
                const sourceHeight = Math.min(imgHeight - currentCanvasY, (pageHeightToFitOneSlice / pdfImgWidth) * imgWidth); // Height on original canvas for this slice

                // Create a temporary canvas for the slice
                const sliceCanvas = document.createElement('canvas');
                sliceCanvas.width = imgWidth;
                sliceCanvas.height = sourceHeight;
                const sliceCtx = sliceCanvas.getContext('2d');

                // Draw the slice from the main canvas
                sliceCtx.drawImage(canvas, 0, currentCanvasY, imgWidth, sourceHeight, 0, 0, imgWidth, sourceHeight);

                const sliceDataUrl = sliceCanvas.toDataURL('image/png');

                 // Add the slice image to the PDF page
                 const slicePdfHeight = (sourceHeight / imgWidth) * pdfImgWidth; // Calculate height of this slice in PDF units
                 doc.addImage(sliceDataUrl, 'PNG', margin, margin, pdfImgWidth, slicePdfHeight);

                currentCanvasY += sourceHeight; // Move to the next slice position
                 console.log(`Added page ${i}/${numPages}. Slice height (canvas): ${sourceHeight.toFixed(0)}, Slice height (pdf): ${slicePdfHeight.toFixed(0)}`);
            }


            console.log("Adding image(s) to PDF complete.");

            // 5. Save the PDF
            doc.save(filename);
            console.log("PDF saved successfully.");

        } catch (error) {
            console.error("!!! Error generating PDF with html2canvas:", error);
            alert("Failed to generate PDF. Check console for details. Ensure content is visible.");
        }
    }


    // --- REVISED DOCX Export Logic (Image-based) ---
    async function handleSaveAsDocx(filename = "SAGE_Analysis.docx") {
        // 1. Check Libraries
        if (typeof window.docx === 'undefined' || typeof window.docx.Document === 'undefined' || typeof window.docx.Packer === 'undefined') {
            alert("Error: docx library not loaded."); return;
        }
        if (typeof window.saveAs === 'undefined') {
            alert("Error: FileSaver.js library not loaded."); return;
        }
        if (typeof window.html2canvas === 'undefined') {
            alert("Error: html2canvas library not loaded."); return;
        }

        const { Document, Packer, Paragraph, ImageRun, AlignmentType, convertInchesToTwip } = window.docx;
        const saveAs = window.saveAs;
        const analysisResultElement = $("analysisResult");

        if (!analysisResultElement || !analysisResultElement.hasChildNodes() || analysisResultElement.innerText.includes("Your generated analysis will appear here.")) {
            alert("No analysis content found to save.");
            return;
        }

        alert("Preparing DOCX screenshot... Please wait.");
        console.log("Starting DOCX generation via html2canvas...");

        try {
            // 2. Use html2canvas to capture the element
            const canvas = await html2canvas(analysisResultElement, {
                scale: 2, // Higher resolution
                useCORS: true,
                logging: true
            });
            console.log("Canvas generated from HTML content.");

            // 3. Convert canvas to image buffer for docx
            const dataUrl = canvas.toDataURL('image/png');
            const base64Data = dataUrl.split(',')[1];
            const imageBuffer = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));

            // 4. Create DOCX Document with the image
            // A4 paper is approx 8.27 x 11.69 inches. Margins typically 1 inch.
            // Available width approx 6.27 inches. Let's use 6.0 for a bit more margin.
            const docPageWidthTwips = convertInchesToTwip(6.0);
            const aspectRatio = canvas.height / canvas.width;
            const imageWidthTwips = docPageWidthTwips;
            const imageHeightTwips = imageWidthTwips * aspectRatio;

             console.log(`Adding image to DOCX. DOCX Width (Twips): ${imageWidthTwips}, DOCX Height (Twips): ${imageHeightTwips.toFixed(0)}`);

            const doc = new Document({
                sections: [{
                    properties: { /* Define page size/margins if needed */ },
                    children: [
                        new Paragraph({
                            children: [
                                new ImageRun({
                                    data: imageBuffer,
                                    transformation: {
                                        width: imageWidthTwips,
                                        height: imageHeightTwips
                                    },
                                })
                            ],
                            alignment: AlignmentType.CENTER
                        })
                    ]
                }]
            });

            // 5. Pack and Save
            console.log("Packing DOCX...");
            const blob = await Packer.toBlob(doc);
            saveAs(blob, filename);
            console.log("DOCX saved successfully.");

        } catch (error) {
            console.error("!!! Error generating DOCX with html2canvas:", error);
            alert("Failed to generate DOCX. Check console for details. Ensure content is visible.");
        }
    }

    // =========================================================
    // ===== END OF REVISED EXPORT FUNCTIONS ===================
    // =========================================================

    // Initialize WebSocket connection
    initializeWebSocket();

    // --- Mobile Menu Logic ---
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const mobileMenu = document.getElementById("mobileMenu");

    if (mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener("click", () => {
            mobileMenu.classList.toggle("hidden");
        });
        
        // Close menu when a link is clicked
        const mobileLinks = mobileMenu.querySelectorAll(".nav-link");
        mobileLinks.forEach(link => {
            link.addEventListener("click", () => {
                mobileMenu.classList.add("hidden");
            });
        });
    }

    async function checkUserTierFromDB(userId) {
        console.log(">>> Checking real DB tier for:", userId);
        try {
            const { data: userData, error: userError } = await supabase
                .from('users') 
                .select('tier, usage_count') 
                .eq('auth_user_id', userId)
                .maybeSingle();
            
            if (!userError && userData) {
                // Update the GLOBAL variables (no 'let' keyword here)
                currentUserTier = (userData.tier || 'basic').toLowerCase();
                currentUserUsage = userData.usage_count || 0;

                console.log(">>> Real Tier Loaded:", currentUserTier);

                if (currentUserTier === 'premium' || currentUserTier === 'admin') {
                    currentSelectionLimit = 3;
                    updateNavBar(); 
                } else {
                    currentSelectionLimit = 1;
                }
            }
        } catch (err) {
            console.error(">>> DB Check Error:", err);
        }
    }

    /**
     * Gatekeeper Function (DYNAMIC LIMITS FROM DB):
     * - Fetches the specific usage_limit from the stripe_plans table.
     * - Admin: Unlimited
     */
    async function checkAndIncrementUsage() {
        // 1. Ensure session
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session || !session.user) {
            navigateTo("login");
            return false;
        }

        const user = session.user;

        // 2. Fetch usage, tier, AND the linked plan's usage_limit
        //    We use Supabase's relational query syntax: stripe_plans ( usage_limit )
        const { data: dbUser, error: dbError } = await supabase
            .from('users')
            .select('usage_count, tier, stripe_plans ( usage_limit )')
            .eq('auth_user_id', user.id)
            .single();

        if (dbError || !dbUser) {
            console.error("Usage check failed:", dbError);
            return false; // Fail safe
        }

        const tier = (dbUser.tier || 'basic').toLowerCase();
        const currentCount = dbUser.usage_count || 0;

        // 3. Determine Dynamic Limit
        let limit = 3; // Default fallback for Basic/No Plan

        if (tier === 'admin') {
            limit = 999999; // Admin Override
        } else if (dbUser.stripe_plans && dbUser.stripe_plans.usage_limit) {
            // USE THE DB VALUE FROM THE JOINED TABLE
            limit = dbUser.stripe_plans.usage_limit;
        }

        console.log(`>>> Usage Check: ${currentCount} / ${limit} (Tier: ${tier})`);

        // 4. Check Limit
        if (currentCount >= limit) {
            console.log(`>>> Limit reached. Blocking.`);
            
            let message = `You have reached your usage limit of ${limit} analyses.`;
            if (tier === 'basic') {
                message += `\n\nUpgrade to Premium for more capacity.`;
            } else {
                message += `\n\nPlease contact support or wait for your next billing cycle.`;
            }
            
            alert(message);
            
            // If basic, prompt to upgrade
            if (tier === 'basic') {
                openStripePlanModal();
            }
            return false; // STOP EXECUTION
        }

        // 5. Increment Usage
        supabase.from('users')
            .update({ usage_count: currentCount + 1 })
            .eq('auth_user_id', user.id)
            .then(({ error }) => {
                if (error) console.error("Background usage increment failed:", error);
            });

        return true; // ALLOW ACCESS
    }

    // --- AUTH STATE CHANGE LISTENER ---
    supabase.auth.onAuthStateChange(async (event, session) => {
        console.log("=== AUTH STATE CHANGE START ===");
        console.log(`Auth Event: ${event}`);

        if (event === "SIGNED_IN" && session) {
            userLoggedIn = true;
            currentUser = session.user;

            updateNavBar();
            console.log(">>> NavBar updated");
        
            // 1. Default to Basic (Secure default)
            currentSelectionLimit = 1;
            console.log(">>> Default Selection limit set");

            // 2. Check Metadata (Fast check)
            // Checks if you manually set their role to 'admin' or 'premium' in Supabase dashboard
            const tier = currentUser.app_metadata?.tier || currentUser.user_metadata?.tier;
            const role = currentUser.app_metadata?.role;
            console.log(">>> Metadata tier:", tier);
            console.log(">>> Metadata role:", role);

            if (tier === 'premium' || tier === 'admin' || role === 'admin') {
                console.log(">>> TAKING METADATA PATH - skipping DB query");
                console.log(`User has privileged metadata (${tier || role}). Unlocking Premium.`);
                currentSelectionLimit = maxUsage;
            } 
            // 3. Check Database Subscription (Robust check)
            // This verifies the actual Stripe data synced to your 'public.subscriptions' table
            else {
                console.log(">>> Triggering async DB check");
                checkUserTierFromDB(currentUser.id);
            }
            console.log(">>> About to handle URL hash");
                        
            // 4. Handle URL Hash (Password Resets / Email Confirmations)
            const hash = window.location.hash;
            if (hash && hash.includes("access_token")) {
                if (hash.includes("type=recovery")) {
                    console.log("Recovery link detected. Redirecting to password update...");
                    window.history.replaceState(null, null, ' '); // Clear hash
                    navigateTo("passwordResetUpdate");
                    return; // Stop here, don't go to home
                } 
                // For normal logins/confirmations, clear hash and go home
                window.history.replaceState(null, null, ' ');
                navigateTo("home");
            }

        } else if (event === "SIGNED_OUT") {
            // Lock everything down on logout
            userLoggedIn = false;
            currentUser = null;
            currentSelectionLimit = 1; 
            console.log("User signed out. Limits reset to Basic.");
        }
        
        // Update UI elements (Nav bar, etc.)
        updateNavBar();
        console.log("=== AUTH STATE CHANGE END ===");
    });

    // --- Navigation Logic ---
    function navigateTo(pageId) {
        pages.forEach((page) => {
            page.classList.remove("active", "flex", "block");
            page.style.display = "none";
        });

        if (statsInterval) {
            clearInterval(statsInterval);
            statsInterval = null;
            console.log("Stopped admin stats auto-refresh.");
        }

        if (pageId === "adminDashboard") {
            createAdminDashboardTabs(); 
        }

        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add("active");
            
            // FIX: Removed 'feedback' AND 'about' from this list.
            // This allows them to use the Flexbox centering classes defined in their HTML.
            if (["home", "templates", "templateDetail", "examplesPage", "adminDashboard", 
                    "blog", "blogDetail"].includes(pageId)) { 
                targetPage.style.display = "block";
            } else {
                targetPage.style.display = "flex";
            }

            setupPageAnimations(pageId);

            if (pageId === "adminDashboard") {
                fetchAndDisplayStatistics();
            }
            window.scrollTo(0, 0);
        }
    }

    // --- Navbar & Profile Logic ---

    // Toggle Dropdown
    const profileBtn = document.getElementById('profileMenuBtn');
    const profileDropdown = document.getElementById('profileDropdown');

    if(profileBtn) {
        profileBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            profileDropdown.classList.toggle('hidden');
        });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (profileDropdown && !profileDropdown.classList.contains('hidden')) {
            if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.add('hidden');
            }
        }
    });

    // Close dropdown when a link inside is clicked
    if(profileDropdown) {
        profileDropdown.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                profileDropdown.classList.add('hidden');
            });
        });
    }

    // =========================================================
    // =====       SUBSCRIPTION & PLANS LOGIC              =====
    // =========================================================

    /**
     * 1. Main Function: Fetch User Data & Toggle Views (FINAL - Admin Logic Added)
     * - Free: No footer on left card.
     * - Premium: Shows Billing Date on left card.
     * - Admin: Shows "Lifetime Access" on left card, "Unlimited" on right card.
     */
    async function fetchAndRenderSubscriptionPage() {
        const loadingEl = document.getElementById("subInfoLoading");
        const contentEl = document.getElementById("subInfoContent");
        const upgradeSection = document.getElementById("upgradeSection");
        const premiumActions = document.getElementById("premiumActions");

        if (loadingEl) loadingEl.classList.remove("hidden");
        if (contentEl) contentEl.classList.add("hidden");

        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) throw new Error("Not logged in");

            // A. Fetch User Data
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('usage_count, tier, status, stripe_customer_id, current_period_end, cancel_at_period_end, plan_id') 
                .eq('auth_user_id', session.user.id)
                .single();

            if (userError) throw userError;

            // B. Fetch All Active Plans
            const { data: allPlans } = await supabase
                .from('stripe_plans')
                .select('*')
                .eq('active', true);

            // C. Determine Current Plan
            const tier = (userData?.tier || 'basic').toLowerCase();
            const userPlanId = userData?.plan_id;     

            const isPremium = tier !== 'basic' && tier !== 'free';

            // --- TIER MAPPING ---
            let currentPlan = null;

            if (userPlanId && allPlans) {
                currentPlan = allPlans.find(p => p.id === userPlanId);
            }
            if (!currentPlan && tier === 'premium' && allPlans) {
                currentPlan = allPlans.find(p => p.name === 'Individual');
            }

            // D. Construct Display Data
            const displayData = {
                name: currentPlan ? currentPlan.name : (tier === 'admin' ? 'Admin Access' : 'Free Tier'),
                price: currentPlan ? `$${(currentPlan.price / 100).toFixed(2)}` : '$0.00',
                interval: '/month', 
                features: currentPlan?.features || (isPremium 
                    ? ['Advanced Frameworks', 'Priority Support', 'Export PDF/DOCX'] 
                    : ['Basic Analysis', '1 Framework Selection'])
            };

            // --- E. Render Detailed Current Plan Card ---
            const planNameEl = document.getElementById("subPlanName");
            if (planNameEl) {
                const cardContainer = planNameEl.closest('.glass-container');
                
                // 1. Status Badge
                let badgeText = "FREE";
                let badgeClass = "bg-gray-500/20 text-gray-300 border border-gray-500/30";
                
                if (tier === 'admin') {
                    badgeText = "ADMIN";
                    badgeClass = "bg-red-500/20 text-red-300 border border-red-500/30";
                } else if (isPremium) {
                    if (userData.cancel_at_period_end) {
                        badgeText = "CANCELING";
                        badgeClass = "bg-yellow-500/20 text-yellow-300 border border-yellow-500/30";
                    } else {
                        badgeText = "ACTIVE";
                        badgeClass = "bg-green-500/20 text-green-300 border border-green-500/30";
                    }
                }

                // 2. Footer Logic (Distinct for Admin)
                let footerHtml = ""; 
                
                if (tier === 'admin') {
                     footerHtml = `
                        <div class="mt-auto pt-4 border-t border-white/10 flex justify-between items-center">
                            <span class="text-white/50 text-xs uppercase tracking-wide font-bold">Account Status</span>
                            <span class="text-white font-mono text-sm">Lifetime Access</span>
                        </div>`;
                } else if (userData.current_period_end) {
                    const dateObj = new Date(userData.current_period_end);
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const dateString = `${year}/${month}/${day}`;

                    const label = userData.cancel_at_period_end ? "Access Expires" : "Next Billing Cycle";
                    
                    footerHtml = `
                        <div class="mt-auto pt-4 border-t border-white/10 flex justify-between items-center">
                            <span class="text-white/50 text-xs uppercase tracking-wide font-bold">${label}</span>
                            <span class="text-white font-mono text-sm">${dateString}</span>
                        </div>`;
                } else if (isPremium) {
                    // Fallback for premium without date
                    footerHtml = `
                        <div class="mt-auto pt-4 border-t border-white/10 flex justify-between items-center">
                            <span class="text-white/50 text-xs uppercase tracking-wide font-bold">Billing Status</span>
                            <span class="text-white font-mono text-sm">Active</span>
                        </div>`;
                }
                // NOTE: Free tier falls through here with empty footerHtml

                // 3. Inject HTML
                if (cardContainer) {
                    let borderColor = 'border-gray-500';
                    if (tier === 'admin') borderColor = 'border-red-500'; // Special border for Admin
                    else if (displayData.name === 'Enterprise') borderColor = 'border-yellow-500';
                    else if (displayData.name === 'Small Business') borderColor = 'border-indigo-500';
                    else if (displayData.name === 'Individual') borderColor = 'border-purple-500';

                    cardContainer.className = `glass-container p-6 relative overflow-hidden flex flex-col h-full border-t-4 ${borderColor}`;
                    
                    cardContainer.innerHTML = `
                        <div class="flex justify-between items-start mb-4 border-b border-white/10 pb-4">
                            <div>
                                <h3 class="text-white/50 text-xs font-bold uppercase tracking-wider mb-1">Current Subscription</h3>
                                <div class="text-2xl font-bold text-white">${displayData.name}</div>
                            </div>
                            <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${badgeClass}">
                                ${badgeText}
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <span class="text-4xl font-bold text-white">${displayData.price}</span>
                            <span class="text-white/50 text-sm">${displayData.interval}</span>
                        </div>

                        <div class="flex-grow mb-6">
                            <p class="text-xs text-white/40 uppercase font-semibold mb-3">Included Features:</p>
                            <ul class="space-y-2 text-sm text-white/80">
                                ${(displayData.features || []).map(feat => `
                                    <li class="flex items-start">
                                        <span class="text-green-400 mr-2 font-bold"></span>
                                        <span class="leading-tight">${feat.replace(/^"|"$/g, '')}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        ${footerHtml}
                    `;
                }
            }

            // --- F. Update Usage Bar & Right Card Texts ---
            const usageCount = userData?.usage_count || 0;
            
            let usageLimit = 3; 
            if (displayData.name === 'Small Business') usageLimit = 50; 
            if (displayData.name === 'Enterprise' || tier === 'admin') usageLimit = 9999;
            
            const usageDisplayLimit = usageLimit === 9999 ? "" : usageLimit;

            const usageEl = document.getElementById("subUsageCount");
            const limitEl = document.getElementById("subUsageLimit");
            const progressBar = document.getElementById("usageProgressBar");
            
            // 1. Update Right Card Header
            const usageCardHeader = progressBar?.closest('.glass-container')?.querySelector('h3');
            if (usageCardHeader) usageCardHeader.textContent = "Daily Analysis Credits";

            // 2. Update Right Card "Reset" Text (Check Admin)
            const resetTextEl = progressBar?.closest('.glass-container')?.querySelector('.text-right p');
            if (resetTextEl) {
                if (tier === 'admin') {
                    resetTextEl.textContent = "Unlimited Access"; // Admin Text
                } else {
                    resetTextEl.textContent = "Resets at 12am";   // Regular User Text
                }
            }

            if (usageEl) usageEl.textContent = usageCount;
            if (limitEl) limitEl.textContent = usageDisplayLimit;

            if (progressBar) {
                let percentage = Math.min((usageCount / usageLimit) * 100, 100);
                if (usageLimit === 9999) percentage = 5;

                progressBar.className = "h-4 rounded-full transition-all duration-1000 ease-out"; 
                if (isPremium || tier === 'admin') {
                    progressBar.classList.add('bg-gradient-to-r', 'from-purple-500', 'to-indigo-500');
                } else {
                    if (percentage >= 100) progressBar.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                    else if (percentage > 60) progressBar.classList.add('bg-gradient-to-r', 'from-yellow-400', 'to-orange-500');
                    else progressBar.classList.add('bg-gradient-to-r', 'from-green-400', 'to-emerald-500');
                }
                setTimeout(() => { progressBar.style.width = `${percentage}%`; }, 100);
            }

            // G. Toggle Sections
            if (isPremium || tier === 'admin') {
                if (upgradeSection) upgradeSection.classList.add("hidden");
                if (premiumActions) premiumActions.classList.remove("hidden");
            } else {
                if (upgradeSection) {
                    upgradeSection.classList.remove("hidden");
                    if (typeof fetchAndRenderUpgradeSection === 'function') fetchAndRenderUpgradeSection();
                }
                if (premiumActions) premiumActions.classList.add("hidden");
            }

            if (loadingEl) loadingEl.classList.add("hidden");
            if (contentEl) contentEl.classList.remove("hidden");

        } catch (err) {
            console.error("Sub Info Error:", err);
            if (loadingEl) loadingEl.innerHTML = `<p class="text-red-400">Error loading subscription: ${err.message}</p>`;
        }
    }

    /**
     * 2. Helper: Render Upgrade Options (SMART LINKS VERSION)
     * Uses 'payment_link' from DB for subscription.
     */
    async function fetchAndRenderUpgradeSection() {
        const container = document.getElementById("upgradeSection");
        if (!container) return;
        
        container.innerHTML = `<div class="text-center text-white/50 py-8"><div class="loading-spinner"></div> Loading upgrade options...</div>`;

        try {
            // A. Fetch Active Plans
            const { data: plans, error } = await supabase
                .from('stripe_plans')
                .select('*')
                .eq('active', true)
                .order('price', { ascending: true });

            if (error) throw error;
            
            if (!plans || plans.length === 0) {
                container.innerHTML = `<div class="text-center text-white/60">No plans available at this time.</div>`;
                return;
            }

            // Helper for feature checkmarks
            const getFeat = (plan, keyword) => {
                if(!plan.features) return '<span class="text-white/20"></span>';
                const match = plan.features.find(f => f.toLowerCase().includes(keyword));
                if(match) return match.replace(/Access |Up to /gi, "").trim();
                return '<span class="text-white/20"></span>';
            };

            // B. Generate Cards HTML
            const cardsHtml = plans.map(plan => {
                const isPopular = plan.is_popular;
                const priceDisplay = `$${(plan.price / 100).toFixed(0)}`; 
                const cardBorder = isPopular ? 'border-indigo-500 shadow-[0_0_30px_rgba(99,102,241,0.2)]' : 'border-white/10';
                const bgClass = isPopular ? 'bg-gradient-to-b from-indigo-900/40 to-gray-900/40' : 'bg-white/5';
                
                // --- SMART LINK LOGIC ---
                let targetUrl = '#';
                let isExternal = false;

                if (plan.payment_link && currentUser && currentUser.id) {
                    try {
                        const url = new URL(plan.payment_link);
                        // Attach User ID so Webhook knows who paid
                        url.searchParams.set('client_reference_id', currentUser.id);
                        // Pre-fill Email
                        if (currentUser.email) url.searchParams.set('prefilled_email', currentUser.email);
                        targetUrl = url.toString();
                        isExternal = true;
                    } catch (e) {
                        console.error("Invalid payment link:", plan.payment_link);
                    }
                }

                return `
                    <div class="relative flex flex-col p-6 rounded-2xl border ${cardBorder} ${bgClass} transition-all hover:-translate-y-1 h-full">
                        ${isPopular ? '<div class="absolute -top-3 left-1/2 -translate-x-1/2 px-3 py-1 rounded-full bg-indigo-500 text-white text-xs font-bold shadow-lg">MOST POPULAR</div>' : ''}
                        
                        <div class="mb-4">
                            <h3 class="text-xl font-bold text-white">${plan.name}</h3>
                            <div class="mt-2 flex items-baseline">
                                <span class="text-4xl font-bold text-white">${priceDisplay}</span>
                                <span class="text-white/50 ml-1">/mo</span>
                            </div>
                        </div>

                        <ul class="space-y-3 mb-8 flex-grow">
                            ${(plan.features || []).slice(0, 5).map(f => `
                                <li class="flex items-start text-sm text-white/80">
                                    <span class="text-green-400 mr-2 font-bold"></span> 
                                    ${f.replace(/^"|"$/g, '')}
                                </li>
                            `).join('')}
                        </ul>

                        <a href="${targetUrl}" ${isExternal ? 'target="_blank"' : ''} class="btn ${isPopular ? 'btn-primary' : 'btn-secondary'} w-full text-center justify-center py-3 font-semibold tracking-wide transition-colors">
                            Choose ${plan.name}
                        </a>
                    </div>`;
            }).join('');

            // C. Render Comparison Table (Optional)
            // ... (Comparison table code remains same as previous versions) ...
            // For brevity, I'll just render the cards container here
            
            container.innerHTML = `<div class="glass-container border-0 p-0 bg-transparent"><div class="grid grid-cols-1 md:grid-cols-3 gap-6">${cardsHtml}</div></div>`;

        } catch (err) {
            console.error("Plan Fetch Error:", err);
            container.innerHTML = `<div class="text-red-400 text-center">Error loading plans.</div>`;
        }
    }

    /**
     * 3. Helper: Portal Redirection
     */
    const portalBtn = document.getElementById("openStripePortalBtn");
    if (portalBtn) {
        portalBtn.addEventListener("click", async () => {
            const originalText = portalBtn.textContent;
            portalBtn.disabled = true;
            portalBtn.textContent = "Loading...";
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) throw new Error("Please log in.");

                const response = await fetch('https://supabase.sageaios.com/functions/v1/create-portal-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });
                const result = await response.json();
                if (result.url) window.location.href = result.url;
                else throw new Error(result.error || "Failed to get URL");
            } catch (err) {
                alert("Error: " + err.message);
                portalBtn.disabled = false;
                portalBtn.textContent = originalText;
            }
        });
    }

    function updateNavBar() {
        const loggedOutState = document.getElementById("loggedOutState");
        const loggedInState = document.getElementById("loggedInState");
        
        const dropdownName = document.getElementById("dropdownName");
        const dropdownEmail = document.getElementById("dropdownEmail");
        const userInitials = document.getElementById("userInitials");
        
        // The Admin link is now inside the dropdown
        const dropdownAdminLink = document.getElementById("dropdownAdminLink"); 
        const adminIndicator = document.getElementById("adminModeIndicator");

        // Also handle mobile menu visibility if you want to hide "Sign In" on mobile when logged in
        // (Optional based on your preference, but good for UX)

        if (userLoggedIn && currentUser) {
            // 1. Show Profile Circle, Hide Login Button
            if(loggedOutState) loggedOutState.classList.add('hidden');
            if(loggedInState) loggedInState.classList.remove('hidden');

            // 2. Populate User Details
            const email = currentUser.email || "";
            const meta = currentUser.user_metadata || {};
            const firstName = meta.first_name || "";
            const lastName = meta.last_name || "";
            
            if (firstName || lastName) {
                if(dropdownName) dropdownName.textContent = `${firstName} ${lastName}`;
            } else {
                if(dropdownName) dropdownName.textContent = email.split('@')[0];
            }

            if(dropdownEmail) dropdownEmail.textContent = email;

            // Initials
            let initials = "U";
            if (firstName) {
                initials = firstName.charAt(0).toUpperCase();
                if (lastName) initials += lastName.charAt(0).toUpperCase();
            } else if (email) {
                initials = email.substring(0, 2).toUpperCase();
            }
            if(userInitials) userInitials.textContent = initials;

            // 3. Admin Check (Toggle link in dropdown)
            const isAdmin = currentUser.app_metadata?.role === 'admin' || currentUser.app_metadata?.tier === 'admin';
            
            if (dropdownAdminLink) {
                if (isAdmin) {
                    dropdownAdminLink.classList.remove('hidden');
                    dropdownAdminLink.classList.add('block');
                } else {
                    dropdownAdminLink.classList.add('hidden');
                    dropdownAdminLink.classList.remove('block');
                }
            }
            
            if (adminIndicator) {
                adminIndicator.style.display = isAdmin ? "block" : "none";
            }

        } else { 
            // LOGGED OUT
            if(loggedOutState) loggedOutState.classList.remove('hidden');
            if(loggedInState) loggedInState.classList.add('hidden');
            
            if(adminIndicator) adminIndicator.style.display = "none";
        }
        
        attachNavLinkListeners();
    }

    // --- Listener for the "Manage Subscription" link (UPDATED) ---
    const manageSubBtn = document.getElementById("manageSubscriptionLink");
    
    if (manageSubBtn) {
        manageSubBtn.addEventListener("click", (e) => {
            e.preventDefault();
            
            // 1. Close the profile dropdown
            const dropdown = document.getElementById("profileDropdown");
            if(dropdown) dropdown.classList.add("hidden");

            // 2. Navigate to the new local Subscription Page
            navigateTo("subscriptionInfo");

            // 3. Trigger the data fetch
            fetchAndRenderSubscriptionPage();
        });
    }

   /**
     * UNIVERSAL MERGE FUNCTION (v7.1 - FIX)
     * - Checks if both async calls (Ollama + n8n) are complete.
     * - Checks `currentTemplateId` to decide *how* to merge.
     * - Calls the correct renderer for the current tool.
     */
    function attemptMergeAndRender() {
        // Check if both results are in
        if (!pendingOllamaResult || !pendingN8nResult) {
            console.log("Attempted merge, but one result is still pending...");
            const statusEl = $("analysisStatus");
            if (statusEl) {
                if (pendingOllamaResult) statusEl.textContent = "Deep analysis complete. Waiting for n8n workflow data...";
                if (pendingN8nResult) statusEl.textContent = "n8n data received. Waiting for deep analysis from Ollama...";
            }
            return; // Not ready yet
        }

        console.log("Both n8n and Ollama results received. Merging...");
        
        let finalData;
        const analysisResultContainer = $("analysisResult");

        if (currentTemplateId === 'mission-vision') {
            // --- Merge Logic for Mission Vision ---
            finalData = pendingOllamaResult; // Base is Ollama
            const secondaryData = pendingN8nResult; // n8n data is secondary

            // Merge Values
            const baseValues = new Set(finalData.values.map(v => v.value.toLowerCase().trim()));
            secondaryData.values.forEach(v_str => {
                const clean_v_str = v_str.toLowerCase().trim();
                if (v_str && !baseValues.has(clean_v_str)) {
                    finalData.values.push({ value: v_str, description: "Extracted from base analysis." });
                    baseValues.add(clean_v_str); 
                }
            });

            // Merge Goals (n8n goals are objects now)
            const baseGoals = new Set(finalData.goals.map(g => g.goal_name.toLowerCase().trim()));
            secondaryData.goals.forEach(g_obj => {
                const goalString = g_obj.goal_name;
                if (!goalString) return; 
                const clean_g_str = goalString.toLowerCase().trim();
                
                if (!baseGoals.has(clean_g_str)) {
                    finalData.goals.push(g_obj); // Add the *entire enriched object*
                    baseGoals.add(clean_g_str); 
                }
            });
            
            // Render
            renderMissionVisionPage(analysisResultContainer, finalData);

        } else if (currentTemplateId === 'objectives') {
            // --- Merge Logic for Objectives ---
            // We just combine them into one object. No de-duplication needed.
            finalData = {
                ollama_data: pendingOllamaResult, // The deep {main_goal, smart_objectives}
                n8n_data: pendingN8nResult         // The array of table rows [{...}, {...}]
            };

            // Render
            renderObjectivesPage(analysisResultContainer, finalData);
        
        } else {
            console.error(`AttemptMergeAndRender: Unknown currentTemplateId: ${currentTemplateId}`);
        }

        // --- 4. Clean up state ---
        pendingOllamaResult = null;
        pendingN8nResult = null;
        currentAnalysisMessageId = null;
        currentAnalysisContext = null; 
        setLoading("generate", false); 
    }

  /**
     * NEW HELPER FUNCTION (v7.5 - JS PARSER)
     * Replaces the AI-based `fetchN8nTableAsJson` function.
     * This 100% reliable JS function parses the Markdown table from n8n.
     */
    function parseMarkdownTable(markdownText) {
        console.log("Parsing n8n Markdown table with local JS parser...");
        try {
            // Get all lines that start with '|'
            const lines = markdownText.trim().split('\n')
                                    .map(l => l.trim())
                                    .filter(l => l.startsWith('|'));

            if (lines.length < 3) { // Must have header, separator, and at least one data row
                throw new Error(`Not enough table lines found (found ${lines.length}).`);
            }

            // Get headers from the first line
            // .slice(1, -1) removes the empty strings from the start/end
            const headers = lines[0].split('|').slice(1, -1).map(h => h.trim());
            if (headers.length === 0) {
                throw new Error("Could not parse headers from table.");
            }

            // Get data lines (skip header and separator row)
            const dataLines = lines.slice(2);
            const jsonData = [];

            for (const line of dataLines) {
                const values = line.split('|').slice(1, -1).map(v => v.trim());
                if (values.length === headers.length) {
                    const rowObj = {};
                    headers.forEach((header, index) => {
                        rowObj[header] = values[index];
                    });
                    jsonData.push(rowObj);
                }
            }
            
            console.log(`Successfully parsed ${jsonData.length} rows from n8n table.`);
            return jsonData; // This is the array: [{...}, {...}, ...]

        } catch (err) {
            console.error("JavaScript Markdown parser failed:", err);
            return [{ "Error": "Failed to parse n8n Markdown table.", "Data": markdownText }];
        }
    }

    // --- Attach Navigation Link Listeners ---
    function attachNavLinkListeners() {
        document.querySelectorAll(".nav-link").forEach((link) => {
            link.removeEventListener("click", handleNavLinkClick);
            link.addEventListener("click", handleNavLinkClick);
        });
    }

    function handleNavLinkClick(e) {
        e.preventDefault();
        const pageId = this.getAttribute("data-page");

        if (pageId === "logout") {
            handleLogout();
            return;
        }

        if (pageId === "templates") {
            navigateTo("home");
            return;
        }

        if ((pageId === "login" || pageId === "signup") && userLoggedIn) {
            navigateTo("home");
            return;
        }
        navigateTo(pageId);
    }

function createAdminDashboardTabs() {
    const dashboardContainer = document.getElementById("adminDashboard");
    if (!dashboardContainer) return;

    // --- ADDED: Rate Fetcher (Invisible, does not affect layout) ---
    if (!window.exchangeRates) {
        window.exchangeRates = null; 
        fetch('https://open.er-api.com/v6/latest/USD')
            .then(res => res.json())
            .then(data => {
                console.log(" Rates Fetched");
                window.exchangeRates = data.rates;
                if (window.lastOverviewData) renderOverviewTab(window.lastOverviewData);
            })
            .catch(console.error);
    }
    // ---------------------------------------------------------------

    dashboardContainer.innerHTML = '';

    const dashboardHTML = `
        <div class="admin-layout-wrapper">
            
            <aside class="admin-sidebar">
                <div class="admin-sidebar-header">
                    <h2 class="text-2xl font-bold text-white">S.A.G.E. Admin</h2>
                    <p class="text-xs text-white/50 mt-1">Control Panel</p>
                </div>
                <div id="adminSidebarNav" class="admin-nav-group">
                    <button class="admin-side-btn active" data-tab="dbStats"><span class="admin-btn-icon"></span><span>Database Stats</span></button>
                    <button class="admin-side-btn" data-tab="users"><span class="admin-btn-icon"></span><span>Users</span></button>
                    <button class="admin-side-btn" data-tab="feedback"><span class="admin-btn-icon"></span><span>Feedback</span></button>
                    <button class="admin-side-btn" data-tab="contacts"><span class="admin-btn-icon"></span><span>Contacts</span></button>
                    <button class="admin-side-btn" data-tab="subscriptions"><span class="admin-btn-icon"></span><span>Subscriptions</span></button>
                </div>
                <div class="admin-refresh-wrapper">
                    <button id="refreshStatsBtn" class="btn btn-secondary w-full text-xs flex items-center justify-center gap-2">
                        <span id="refreshStatsBtnText">Refresh Data</span>
                        <span id="refreshStatsSpinner" class="loading-spinner hidden" style="width:12px;height:12px;"></span>
                    </button>
                    <div class="mt-4 flex items-center justify-center gap-2 text-xs text-white/60 bg-black/20 py-2 rounded">
                        <span id="dashServerDot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <span id="dashServerText">System Online</span>
                    </div>
                </div>
            </aside>

            <main class="admin-content-area">
                
                <div class="admin-hud-grid">
                    <div class="admin-hud-card">
                        <div class="admin-hud-val val-blue" id="dashUsersOnline">--</div>
                        <div class="admin-hud-label">Live Visitors</div>
                    </div>
                    <div class="admin-hud-card">
                        <div class="admin-hud-val val-yellow" id="dashQueryCount">--</div>
                        <div class="admin-hud-label">Total Queries</div>
                    </div>
                    <div class="admin-hud-card">
                        <div class="admin-hud-val val-purple" id="headerDbSize">--</div>
                        <div class="admin-hud-label">DB Storage</div>
                    </div>
                    <div class="admin-hud-card">
                        <div class="admin-hud-val val-green" id="headerVectors">--</div>
                        <div class="admin-hud-label">AI Vectors</div>
                    </div>
                </div>

                <div id="adminTabsContent" class="flex-grow">
                    
                    <div id="dbStatsPanel" class="home-tab-panel active">
                        <div class="glass-container p-8">
                            <h3 class="text-xl font-bold mb-6 text-white border-b border-white/10 pb-4 flex items-center">
                                <span class="text-2xl mr-3"></span> Database Health Metrics
                            </h3>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                
                                <div>
                                    <h4 class="text-sm font-bold text-blue-400 uppercase tracking-widest mb-4 pl-1">PostgreSQL</h4>
                                    <div class="metric-grid">
                                        <div class="metric-tile">
                                            <span class="metric-label"><span class="status-dot blue"></span>Total Users</span>
                                            <span class="metric-value" id="statTotalUsers">Loading...</span>
                                        </div>
                                        <div class="metric-tile">
                                            <span class="metric-label"><span class="status-dot green"></span>Active (1h)</span>
                                            <span class="metric-value val-green" id="statActiveUsers">Loading...</span>
                                        </div>
                                        <div class="metric-tile">
                                            <span class="metric-label">Total Queries</span>
                                            <span class="metric-value val-yellow" id="statTotalQueries">Loading...</span>
                                        </div>
                                        <div class="metric-tile">
                                            <span class="metric-label">Avg Query Time</span>
                                            <span class="metric-value" id="statAvgTime">Loading...</span>
                                        </div>
                                        <div class="metric-tile full-width">
                                            <div class="flex justify-between items-end">
                                                <div>
                                                    <span class="metric-label">Database Size</span>
                                                    <span class="metric-value val-purple" id="statDbSize">Loading...</span>
                                                </div>
                                                <div class="text-xs text-white/40 text-right">
                                                    Snapshot: <span id="statRecordedAt" class="font-mono">--</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="pineconeStatsContainer" class="hidden">
                                    <h4 class="text-sm font-bold text-green-400 uppercase tracking-widest mb-4 pl-1">Pinecone (AI Memory)</h4>
                                    <div class="metric-grid">
                                        <div class="metric-tile full-width">
                                            <span class="metric-label">Index Name</span>
                                            <span class="metric-value text-sm" id="statPineconeName">--</span>
                                        </div>
                                        <div class="metric-tile">
                                            <span class="metric-label"><span class="status-dot green"></span>Total Vectors</span>
                                            <span class="metric-value val-green" id="statTotalVectors">--</span>
                                        </div>
                                        <div class="metric-tile">
                                            <span class="metric-label">Book Namespc</span>
                                            <span class="metric-value" id="statBookVectors">--</span>
                                        </div>
                                        <div class="metric-tile">
                                            <span class="metric-label">Dimensions</span>
                                            <span class="metric-value val-blue" id="statPineconeDimension">--</span>
                                        </div>
                                        <div class="metric-tile">
                                            <span class="metric-label">Status</span>
                                            <span class="metric-value val-green" id="statPineconeStatus">--</span>
                                        </div>
                                        <div id="statPineconeCloud" class="hidden"></div>
                                    </div>
                                </div>

                            </div> <div id="statsMessage" class="mt-4 hidden"></div>
                        </div>
                    </div>

                    <div id="usersPanel" class="home-tab-panel"></div>
                    <div id="feedbackPanel" class="home-tab-panel"></div>
                    <div id="contactsPanel" class="home-tab-panel"></div>
                    <div id="subscriptionsPanel" class="home-tab-panel"></div>
                    
                </div>
            </main>
        </div>
    `;

    dashboardContainer.innerHTML = dashboardHTML;

    const refreshBtn = document.getElementById("refreshStatsBtn");
    if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
            if(typeof fetchAndDisplayStatistics === 'function') fetchAndDisplayStatistics();
            const activeTab = document.querySelector(".admin-side-btn.active")?.dataset.tab;
            if(activeTab === 'users' && typeof fetchAndRenderUsers === 'function') fetchAndRenderUsers(1);
            if(activeTab === 'feedback' && typeof fetchAndRenderFeedback === 'function') fetchAndRenderFeedback();
            if(activeTab === 'contacts' && typeof fetchAndRenderContacts === 'function') fetchAndRenderContacts(1);
            if(activeTab === 'subscriptions' && typeof fetchAndRenderSubscriptions === 'function') fetchAndRenderSubscriptions('overview');
        });
    }

    const dbObserver = new MutationObserver((mutations) => {
        const src = document.getElementById("statDbSize");
        const dest = document.getElementById("headerDbSize");
        if (src && dest) dest.textContent = src.textContent;
    });
    const dbTarget = document.getElementById("statDbSize");
    if(dbTarget) dbObserver.observe(dbTarget, { childList: true, characterData: true, subtree: true });

    const vecObserver = new MutationObserver((mutations) => {
        const src = document.getElementById("statTotalVectors");
        const dest = document.getElementById("headerVectors");
        if (src && dest) dest.textContent = src.textContent;
    });
    const vecTarget = document.getElementById("statTotalVectors");
    if(vecTarget) vecObserver.observe(vecTarget, { childList: true, characterData: true, subtree: true });

    setupSidebarLogic();
    if(typeof fetchAndDisplayStatistics === 'function') fetchAndDisplayStatistics();

    setTimeout(() => {
        const defaultPanel = document.getElementById("dbStatsPanel");
        if (defaultPanel) {
            defaultPanel.style.display = "block";
            requestAnimationFrame(() => {
                defaultPanel.style.opacity = "1";
                defaultPanel.style.transform = "translateY(0)";
            });
        }
    }, 50);
}

// Helper to handle sidebar switching
function setupSidebarLogic() {
    const btns = document.querySelectorAll(".admin-side-btn");
    const panels = document.querySelectorAll("#adminTabsContent .home-tab-panel");

    btns.forEach(btn => {
        btn.addEventListener("click", () => {
            // 1. UI Toggle
            btns.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            // 2. Panel Toggle
            const targetId = btn.dataset.tab;
            panels.forEach(p => {
                if (p.id === targetId + "Panel") {
                    p.classList.add("active");
                    p.style.display = "block"; // Explicitly show
                    
                    // Animation effect
                    p.style.opacity = "0";
                    p.style.transform = "translateY(10px)";
                    setTimeout(() => {
                         p.style.transition = "all 0.3s ease";
                         p.style.opacity = "1";
                         p.style.transform = "translateY(0)";
                    }, 50);

                    // 3. Trigger Data Loads
                    if (targetId === 'users' && typeof renderViewDatabaseTab === 'function') renderViewDatabaseTab();
                    if (targetId === 'feedback' && typeof renderFeedbackTab === 'function') renderFeedbackTab();
                    if (targetId === 'contacts' && typeof renderContactsTab === 'function') renderContactsTab();
                    if (targetId === 'subscriptions' && typeof renderSubscriptionsTab === 'function') renderSubscriptionsTab();
                    
                } else {
                    p.classList.remove("active");
                    p.style.display = "none";
                }
            });
        });
    });
}

// =========================================================
// ===== ADMIN DASHBOARD - USERS TAB (COMPLETE) =====
// =========================================================

/**
 * Builds the Users tab UI, including the new "Create New User" button.
 */
async function renderViewDatabaseTab() {
    console.log("DEBUG: renderViewDatabaseTab() called");
    const usersPanel = $("usersPanel");
    if (!usersPanel) return;

    // 1. Build the UI (Added Header)
    usersPanel.innerHTML = `
        <div class="glass-container p-6">
            <h2 class="text-3xl font-bold mb-4">User Management</h2>
            
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="flex-grow">
                    <input type="text" id="adminUserSearch" class="input-field" placeholder="Search email or name...">
                </div>
                <div class="flex-shrink-0">
                    <select id="adminTierFilter" class="input-field">
                        <option value="">All Tiers</option>
                        <option value="basic">Basic</option>
                        <option value="premium">Premium</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="flex-shrink-0">
                    <select id="adminSortBy" class="input-field">
                        <option value="created_at" selected>Sort by: Created At</option>
                        <option value="last_name">Sort by: Last Name</option>
                        <option value="email">Sort by: Email</option>
                    </select>
                </div>
                <div class="flex-shrink-0">
                    <button id="adminManageBtn" class="btn btn-primary w-full md:w-auto" disabled>
                         Manage
                    </button>
                </div>
                <div class="flex-shrink-0">
                    <button id="adminCreateUserBtn" class="btn btn-secondary w-full md:w-auto">
                         Create New User
                    </button>
                </div>
            </div>

            <div id="adminUserTableContainer" class="overflow-x-auto">
                <div class="flex items-center justify-center p-10">
                    <div class="loading-spinner mr-3"></div>
                    <span class="text-white/80">Fetching user data...</span>
                </div>
            </div>
        </div>
    `;

    // 2. Attach event listeners
    const searchInput = $("adminUserSearch");
    const tierFilter = $("adminTierFilter");
    const sortSelect = $("adminSortBy");

    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => fetchAndRenderUsers(1), 500);
    });

    tierFilter.addEventListener('change', () => fetchAndRenderUsers(1));
    sortSelect.addEventListener('change', () => fetchAndRenderUsers(1));

    $("adminCreateUserBtn").addEventListener('click', () => openCreateUserModal());

    // 3. Initial Load
    await fetchAndRenderUsers();
}

/**
 * Renders the user table and wires up the "Manage" button logic.
 */
function renderUserTable(container, users, pagination) {
    if (!Array.isArray(users) || users.length === 0) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center p-16 text-white/40">
                <div class="text-4xl mb-2"></div>
                <p>No users found matching your criteria.</p>
            </div>`;
        return;
    }

    let tableHtml = `
        <table class="w-full text-left border-collapse">
            <thead class="bg-white/5 text-xs uppercase text-white/50 font-semibold tracking-wider">
                <tr>
                    <th class="p-4 w-10"><input type="checkbox" id="selectAllUsers" class="method-checkbox" /></th>
                    <th class="p-4">User Identity</th>
                    <th class="p-4">Email Address</th>
                    <th class="p-4">Access Tier</th>
                    <th class="p-4">Joined</th>
                    <th class="p-4 w-20">Actions</th>
                </tr>
            </thead>
            <tbody class="text-sm divide-y divide-white/5">
    `;

    users.forEach(user => {
        const displayName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Unknown';
        const uid = user.auth_user_id || user.id;
        const shortUid = uid ? uid.substring(0, 8) + '...' : 'N/A';
        
        // Determine Badge Style
        const tier = (user.tier || 'basic').toLowerCase();
        let badgeClass = 'tier-basic';
        if (tier === 'admin') badgeClass = 'tier-admin';
        if (tier === 'premium') badgeClass = 'tier-premium';

        tableHtml += `
            <tr class="user-row group">
                <td class="p-4">
                    <input type="checkbox" class="user-checkbox method-checkbox" data-id="${user.id}" />
                </td>
                <td class="p-4">
                    <div class="font-bold text-white">${displayName}</div>
                    <div class="user-uid mt-1 inline-block" title="${uid}">${shortUid}</div>
                </td>
                <td class="p-4 text-white/80">
                    ${user.email || 'N/A'}
                </td>
                <td class="p-4">
                    <span class="tier-badge ${badgeClass}">${tier}</span>
                </td>
                <td class="p-4 text-white/60">
                    ${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}
                    <div class="text-xs text-white/40">${user.created_at ? new Date(user.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}</div>
                </td>
                <td class="p-4">
                    <button class="btn btn-secondary p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity text-xs" onclick="openUserManagementModal('${user.id}')" title="Edit User">
                        
                    </button>
                </td>
            </tr>
        `;
    });

    tableHtml += `</tbody></table>`;

    // Pagination Controls (Styled)
    if (pagination && pagination.totalPages > 1) {
        tableHtml += `
            <div class="flex justify-between items-center p-4 bg-white/5 border-t border-white/10">
                <span class="text-xs text-white/50">
                    Showing page ${pagination.page} of ${pagination.totalPages} (${pagination.total} users)
                </span>
                <div class="flex gap-2">
                    <button class="btn btn-secondary text-xs py-1 px-3 pagination-btn" ${pagination.page <= 1 ? 'disabled' : ''} data-page="${pagination.page - 1}">
                         Prev
                    </button>
                    <button class="btn btn-secondary text-xs py-1 px-3 pagination-btn" ${pagination.page >= pagination.totalPages ? 'disabled' : ''} data-page="${pagination.page + 1}">
                        Next 
                    </button>
                </div>
            </div>
        `;
    }

    container.innerHTML = tableHtml;

    // --- Re-attach Logic for Selection and Pagination (Required for functionality) ---
    
    // 1. Pagination Click Logic
    container.querySelectorAll('.pagination-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const newPage = parseInt(e.target.dataset.page);
            if(!isNaN(newPage)) fetchAndRenderUsers(newPage);
        });
    });

    // 2. Manage Button Logic (Re-implemented from previous logic block)
    const manageBtn = document.getElementById("adminManageBtn");
    const allUserCheckboxes = container.querySelectorAll('.user-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllUsers');

    function updateManageButton() {
        const checked = container.querySelectorAll('.user-checkbox:checked');
        const count = checked.length;
        
        if (count === 0) {
            manageBtn.disabled = true;
            manageBtn.classList.add('opacity-50', 'cursor-not-allowed');
            manageBtn.innerHTML = ` Manage Selected`;
            manageBtn.onclick = null;
        } else {
            manageBtn.disabled = false;
            manageBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            if (count === 1) {
                manageBtn.innerHTML = ` Edit User`;
                manageBtn.onclick = () => openUserManagementModal(checked[0].dataset.id);
            } else {
                manageBtn.innerHTML = ` Manage (${count})`;
                // Re-attach bulk action logic if you have it, or leave placeholder
                manageBtn.onclick = () => { /* Open bulk modal logic here if needed */ };
            }
        }
        
        if(selectAllCheckbox) {
            selectAllCheckbox.checked = count > 0 && count === allUserCheckboxes.length;
        }
    }

    if(selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => {
            allUserCheckboxes.forEach(cb => cb.checked = e.target.checked);
            updateManageButton();
        });
    }

    allUserCheckboxes.forEach(cb => cb.addEventListener('change', updateManageButton));
}


// Re-defining handleUserUpdate to ensure it matches the IDs in the new modal HTML above
async function handleUserUpdate(userId) {
    const btn = document.getElementById("saveUserChangesBtn");
    const msg = document.getElementById("editUserMessage");
    const originalText = btn.innerText;
    
    btn.disabled = true;
    btn.innerHTML = `<span class="loading-spinner mr-2"></span> Saving...`;
    msg.className = "hidden";

    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error("Not logged in");

        const updates = {
            first_name: document.getElementById("editFirstName").value,
            last_name: document.getElementById("editLastName").value,
            email: document.getElementById("editEmail").value,
            tier: document.getElementById("editTier").value
        };

        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-users-secure/users/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify(updates)
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Update failed");

        msg.textContent = "Profile updated successfully!";
        msg.className = "p-3 rounded text-sm text-center bg-green-500/20 text-green-300 border border-green-500/30 block";
        
        // Refresh the main table behind the modal
        if(typeof fetchAndRenderUsers === 'function') fetchAndRenderUsers(1);

    } catch (error) {
        console.error(error);
        msg.textContent = error.message;
        msg.className = "p-3 rounded text-sm text-center bg-red-500/20 text-red-300 border border-red-500/30 block";
    } finally {
        btn.disabled = false;
        btn.innerText = originalText;
    }
}
/**
 * Fetches user data from the API and calls the renderer.
 */
async function fetchAndRenderUsers(page = 1, limit = 20) {
    console.log("DEBUG: fetchAndRenderUsers() called for page:", page);
    const tableContainer = $("adminUserTableContainer");
    
    tableContainer.innerHTML = `
        <div class="flex items-center justify-center p-10">
            <div class="loading-spinner mr-3"></div>
            <span class="text-white/80">Fetching secure user data...</span>
        </div>
    `;

    try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error("You are not logged in. Please log in as an admin.");

        // Get filter values from the UI
        const searchTerm = $("adminUserSearch").value.trim();
        const tierValue = $("adminTierFilter").value;
        const sortByValue = $("adminSortBy").value;
        const sortOrderValue = 'desc';

        const params = new URLSearchParams({
            page: page,
            limit: limit,
            sortBy: sortByValue,
            sortOrder: sortOrderValue
        });
        if (searchTerm) params.append('search', searchTerm);
        if (tierValue) params.append('tier', tierValue);

        const url = `${SUPABASE_URL}/functions/v1/admin-users-secure/users?${params.toString()}`;
        console.log("DEBUG: Fetching URL:", url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            }
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || `Failed to fetch users: ${response.statusText}`);
        }
        console.log("DEBUG: fetchAndRenderUsers() success, rendering table...");
        renderUserTable(tableContainer, data.data, data.pagination);

    } catch (error) {
        console.error("Error in fetchAndRenderUsers:", error);
        tableContainer.innerHTML = `
            <div class="p-6 text-center">
                <h4 class="text-xl font-bold text-red-400 mb-2">Error Fetching User Data</h4>
                <pre class="bg-black/30 p-2 rounded mt-2 text-red-300 text-xs">${error.message}</pre>
            </div>`;
    }
}

/**
 * UPDATED: Fetches a single user's data and opens the edit modal.
 * Now includes the "Delete User" button.
 */
async function openUserManagementModal(userId) {
    console.log("DEBUG: openUserManagementModal() called for userId:", userId);
    const modal = document.getElementById("userManagementModal");
    const modalContent = document.getElementById("userModalContent");
    
    if (!modal || !modalContent) return;

    // 1. Open Modal with Animation
    modal.style.display = 'flex';
    // Small delay to allow display:flex to apply before adding opacity class
    setTimeout(() => modal.classList.add('modal-open'), 10);

    const closeModal = () => {
        modal.classList.remove('modal-open');
        setTimeout(() => modal.style.display = 'none', 300);
    };

    // Render Loading State
    modalContent.innerHTML = `
        <div class="modal-header">
            <div class="modal-title-section">
                <h3 class="modal-title">Edit User</h3>
            </div>
            <button class="modal-close-btn" id="tempCloseUserBtn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="flex items-center justify-center p-10">
                <div class="loading-spinner mr-3"></div>
                <span class="text-white/80">Fetching profile...</span>
            </div>
        </div>
    `;
    document.getElementById("tempCloseUserBtn").onclick = closeModal;

    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error("Not logged in");

        const url = `https://supabase.sageaios.com/functions/v1/admin-users-secure/users/${userId}`;
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            }
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to fetch user");
        
        const user = data.data; 
        const displayName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'No Name';

        // 2. Render Styled Content
        modalContent.innerHTML = `
            <div class="modal-header">
                <div class="modal-title-section">
                    <h3 class="modal-title">Edit Profile</h3>
                    <p class="text-sm text-white/60">Manage account details and access.</p>
                </div>
                <button class="modal-close-btn" id="closeUserModalBtn">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="modal-info-grid">
                    <div class="modal-info-card">
                        <h5 class="modal-info-label">User Identity</h5>
                        <div class="modal-info-value">${displayName}</div>
                        <div class="modal-info-sub">${user.email}</div>
                    </div>
                    <div class="modal-info-card">
                        <h5 class="modal-info-label">Account Created</h5>
                        <div class="modal-info-value">${new Date(user.created_at).toLocaleDateString()}</div>
                        <div class="modal-info-sub">${new Date(user.created_at).toLocaleTimeString()}</div>
                    </div>
                </div>

                <div class="modal-content-section">
                    <h4 class="modal-section-title">Account Details</h4>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1 uppercase tracking-wide">First Name</label>
                                <input type="text" id="modalUserFirstName" class="input-field bg-white/5 border-white/10 focus:bg-white/10" value="${user.first_name || ''}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1 uppercase tracking-wide">Last Name</label>
                                <input type="text" id="modalUserLastName" class="input-field bg-white/5 border-white/10 focus:bg-white/10" value="${user.last_name || ''}">
                            </div>
                        </div>
                        <div>
                             <label class="block text-xs font-medium text-gray-400 mb-1 uppercase tracking-wide">Email Address</label>
                             <input type="email" id="modalUserEmail" class="input-field bg-white/5 border-white/10 focus:bg-white/10" value="${user.email || ''}">
                        </div>
                    </div>
                </div>

                <div class="modal-status-section border-t border-white/10 pt-4">
                    <h4 class="modal-section-title">Access Level</h4>
                    <div class="modal-status-controls">
                        <select id="modalUserTier" class="modal-select">
                            <option value="basic" ${user.tier === 'basic' ? 'selected' : ''}>Basic Tier</option>
                            <option value="premium" ${user.tier === 'premium' ? 'selected' : ''}>Premium Tier</option>
                            <option value="admin" ${user.tier === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        <button id="modalUpdateUserBtn" class="modal-btn modal-btn-primary py-2">Save Changes</button>
                    </div>
                </div>

                <div id="userModalMessage" class="hidden"></div>

                ${user.tier !== 'admin' ? `
                <div class="modal-notes-section mt-6 pt-4 border-t border-red-500/20">
                    <h4 class="modal-section-title text-red-300">Danger Zone</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="modalDisableUserBtn" class="modal-btn modal-btn-secondary hover:border-yellow-500 hover:text-yellow-400">
                            ${user.disabled ? 'Enable Access' : 'Disable Access'}
                        </button>
                        <button id="modalDeleteUserBtn" class="modal-btn" style="background: rgba(220, 38, 38, 0.15); border-color: rgba(220, 38, 38, 0.3); color: #fca5a5;">
                            Delete Account
                        </button>
                    </div>
                </div>
                ` : ''}
            </div>
        `;

        // 3. Attach Listeners
        setTimeout(() => {
            document.getElementById("closeUserModalBtn").onclick = closeModal;
            document.getElementById("modalUpdateUserBtn").onclick = () => handleUserUpdate(user.id);
            
            if (user.tier !== 'admin') {
                document.getElementById("modalDisableUserBtn").onclick = () => handleUserDisable(user.id, user.email, closeModal);
                document.getElementById("modalDeleteUserBtn").onclick = () => handleUserDelete(user.id, user.auth_user_id, user.email, closeModal);
            }
        }, 50);

    } catch (error) {
        console.error("Error:", error);
        modalContent.innerHTML = `
            <div class="modal-header"><div class="modal-title-section"><h3 class="modal-title">Error</h3></div><button class="modal-close-btn" id="errCloseBtn">&times;</button></div>
            <div class="modal-body"><div class="modal-message modal-message-error">${error.message}</div></div>`;
        document.getElementById("errCloseBtn").onclick = closeModal;
    }
}

window.openUserManagementModal = openUserManagementModal;

/**
 * Handles the PUT /users/:id request to update a user.
 */
async function handleUserUpdate(userId) {
    console.log("DEBUG: handleUserUpdate() called for userId:", userId);
    const messageEl = $("userModalMessage");
    const updateBtn = $("modalUpdateUserBtn");
    const originalBtnText = updateBtn.innerHTML;
    updateBtn.disabled = true;
    updateBtn.innerHTML = `<span class="loading-spinner mr-2"></span> Saving...`;

    try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error("Not logged in");

        // Get new data from modal fields
        const updatedData = {
            first_name: $("modalUserFirstName").value,
            last_name: $("modalUserLastName").value,
            email: $("modalUserEmail").value,
            tier: $("modalUserTier").value
        };
        console.log("DEBUG: Sending update data:", updatedData);

        // Call PUT /users/:id
        const url = `${SUPABASE_URL}/functions/v1/admin-users-secure/users/${userId}`;
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify(updatedData)
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to update user");

        console.log("DEBUG: User update successful");
        showMessage("userModalMessage", "User updated successfully!", "success");
        await fetchAndRenderUsers(); // Refresh the main user table

    } catch (error) {
        console.error("Error in handleUserUpdate:", error);
        showMessage("userModalMessage", error.message, "error");
    } finally {
        updateBtn.disabled = false;
        updateBtn.innerHTML = originalBtnText;
    }
}

/**
 * Handles the PUT /users/:id/disable request.
 */
async function handleUserDisable(userId, userEmail, closeModalCallback) {
    console.log("DEBUG: handleUserDisable() called for userId:", userId);
    if (!confirm(`Are you sure you want to disable this user?\n\nEmail: ${userEmail}\nID: ${userId}\n\nThis action is reversible and does NOT delete data.`)) {
        console.log("DEBUG: Disable cancelled by user.");
        return;
    }

    const messageEl = $("userModalMessage");
    const disableBtn = $("modalDisableUserBtn");
    const originalBtnText = disableBtn.innerHTML;
    disableBtn.disabled = true;
    disableBtn.innerHTML = `<span class="loading-spinner mr-2"></span> Disabling...`;

    try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error("Not logged in");
        
        // Call PUT /users/:id/disable
        const url = `${SUPABASE_URL}/functions/v1/admin-users-secure/users/${userId}/disable`;
        console.log("DEBUG: Calling disable endpoint:", url);
        
        const response = await fetch(url, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}` 
            }
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to disable user");

        console.log("DEBUG: User disable successful");
        showMessage("userModalMessage", `User ${data.disabled_user?.email || ''} disabled successfully.`, "success");
        await fetchAndRenderUsers(); // Refresh the main user table
        setTimeout(closeModalCallback, 1500); // Close modal on success

    } catch (error) {
        console.error("Error in handleUserDisable:", error);
        showMessage("userModalMessage", error.message, "error");
    } finally {
        disableBtn.disabled = false;
        disableBtn.innerHTML = originalBtnText;
    }
}

/**
 * NEW: Handles the DELETE /users/:id request to permanently delete a user.
 */
async function handleUserDelete(userId, authUserId, userEmail, closeModalCallback) {
    console.log("DEBUG: handleUserDelete() called for userId:", userId);
    const warningMessage = `ARE YOU SURE you want to PERMANENTLY DELETE this user?\n\nEmail: ${userEmail}\nID: ${userId}\n\nThis action is IRREVERSIBLE and will delete their auth record and all data.`;
    
    if (!confirm(warningMessage)) {
        console.log("DEBUG: Delete cancelled by user.");
        return;
    }

    const messageEl = $("userModalMessage");
    const deleteBtn = $("modalDeleteUserBtn");
    const originalBtnText = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="loading-spinner mr-2"></span> Deleting...';

    try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error("Not logged in");

        // Call DELETE /users/:id
        const url = `${SUPABASE_URL}/functions/v1/admin-users-secure/users/${userId}`;
        console.log("DEBUG: Calling DELETE endpoint:", url);
        
        const response = await fetch(url, {
            method: 'DELETE',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}` 
            }
        });

        const data = await response.json();

        // --- THIS IS THE FIX ---
        // We now check for 'data.details' to get the *real* error message
        // from the server's catch block.
        if (!response.ok) {
            throw new Error(data.details || data.error || "Failed to delete user");
        }
        // --- END OF FIX ---

        console.log("DEBUG: User delete successful");
        showMessage("userModalMessage", "User permanently deleted.", "success");
        await fetchAndRenderUsers(1); // Refresh the main user table
        setTimeout(closeModalCallback, 1500); // Close modal on success

    } catch (error) {
        console.error("Error in handleUserDelete:", error);
        // This will now show the *specific* server error
        showMessage("userModalMessage", error.message, "error");
    } finally {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalBtnText;
    }
}

/**
 * NEW: Opens the user modal in "Create" mode.
 */
function openCreateUserModal() {
    const modal = $("userManagementModal");
    const modalContent = $("userModalContent");
    if (!modal || !modalContent) return;

    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('modal-open'), 10);
    
    const closeModal = () => {
        modal.classList.remove('modal-open');
        setTimeout(() => modal.style.display = 'none', 300);
    };

    modalContent.innerHTML = `
        <div class="modal-header">
            <h3 class="modal-title">Create New User</h3>
            <button class="modal-close-btn" id="closeCreateModalBtn">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                    <input type="email" id="modalUserEmail" class="input-field" placeholder="new.user@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-2">Temporary Password</label>
                    <input type="password" id="modalUserPassword" class="input-field" placeholder="Minimum 6 characters">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-2">First Name</label>
                        <input type="text" id="modalUserFirstName" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-2">Last Name</label>
                        <input type="text" id="modalUserLastName" class="input-field">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-200 mb-2">User Tier</label>
                    <select id="modalUserTier" class="modal-select">
                        <option value="basic" selected>Basic</option>
                        <option value="premium">Premium</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div id="userModalMessage" class="hidden"></div>
                
                <div class="pt-4 mt-4 border-t border-white/10">
                    <button id="modalCreateUserBtn" class="modal-btn modal-btn-success w-full">Create User</button>
                </div>
            </div>
        </div>
    `;

    setTimeout(() => {
        $("closeCreateModalBtn").onclick = closeModal;
        $("modalCreateUserBtn").onclick = () => handleUserCreate();
    }, 50);
}

/**
 * Handles the POST request to create a new user via the admin API.
 */
async function handleUserCreate() {
    console.log("DEBUG: handleUserCreate() called");
    
    const createBtn = document.getElementById("modalCreateUserBtn");
    const messageEl = document.getElementById("userModalMessage");
    
    // Reset UI
    const originalBtnText = createBtn.innerHTML;
    createBtn.disabled = true;
    createBtn.innerHTML = `<span class="loading-spinner mr-2"></span> Creating...`;
    
    if (messageEl) {
        messageEl.style.display = 'none';
        messageEl.className = '';
    }

    try {
        // 1. Gather Inputs
        const email = document.getElementById("modalUserEmail").value.trim();
        const password = document.getElementById("modalUserPassword").value;
        const firstName = document.getElementById("modalUserFirstName").value.trim();
        const lastName = document.getElementById("modalUserLastName").value.trim();
        const tier = document.getElementById("modalUserTier").value;

        // 2. Validation
        if (!email || !password || !firstName) {
            throw new Error("Email, Password, and First Name are required.");
        }
        if (password.length < 6) {
            throw new Error("Password must be at least 6 characters.");
        }

        // 3. Get Session
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error("Not logged in");

        // 4. API Call (POST /users)
        const url = `${SUPABASE_URL}/functions/v1/admin-users-secure/users`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({
                email,
                password,
                first_name: firstName,
                last_name: lastName,
                tier
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to create user");

        // 5. Success
        if (messageEl) {
            messageEl.textContent = "User created successfully!";
            messageEl.className = "modal-message modal-message-success";
            messageEl.style.display = "block";
        }

        // Refresh list and close modal
        await fetchAndRenderUsers(1);
        
        setTimeout(() => {
            const modal = document.getElementById("userManagementModal");
            if (modal) {
                modal.classList.remove('modal-open');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        }, 1500);

    } catch (error) {
        console.error("Error creating user:", error);
        if (messageEl) {
            messageEl.textContent = error.message;
            messageEl.className = "modal-message modal-message-error";
            messageEl.style.display = "block";
        } else {
            alert(error.message);
        }
    } finally {
        createBtn.disabled = false;
        createBtn.innerHTML = originalBtnText;
    }
}

/**
 * NEW: Handles bulk actions from the bulk action modal.
 */
async function handleBulkUserUpdate(action, userIds) {
    console.log("DEBUG: handleBulkUserUpdate() called for action:", action);
    const messageEl = $("bulkModalMessage");
    const confirmBtn = $("modalConfirmBulkBtn");
    
    // Add a confirmation for the delete action
    if (action === 'delete-users') {
        if (!confirm(`Are you sure you want to PERMANENTLY DELETE ${userIds.length} users? This action cannot be undone.`)) {
            console.log("DEBUG: Bulk delete cancelled by user.");
            return;
        }
    }
    
    // Set loading state
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<span class="loading-spinner mr-2"></span> Processing...';
    showMessage("bulkModalMessage", "Processing... Please wait.", "success");

    try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error("Not logged in");

        // Calls the new 'bulk-update' endpoint
        const url = `${SUPABASE_URL}/functions/v1/admin-users-secure/users/bulk-update`;
        console.log("DEBUG: Calling bulk update endpoint:", url);
        
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({
                action: action,
                userIds: userIds
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to perform bulk action");

        console.log("DEBUG: Bulk update successful");
        showMessage("bulkModalMessage", `Successfully processed ${data.count || 0} users. ${data.skipped_admins?.length || 0} admins were skipped.`, "success");
        await fetchAndRenderUsers(1); // Refresh the main user table

        // Automatically close the modal on success
        setTimeout(() => {
            $("bulkActionModal").classList.add("hidden");
        }, 1500);

    } catch (error) {
        console.error("Error in handleBulkUserUpdate:", error);
        showMessage("bulkModalMessage", error.message, "error");
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = 'Apply Action';
    }
}

// =========================================================
// ===== END OF ADMIN DASHBOARD - USERS TAB =====
// =========================================================

// --- BEAUTIFUL FEEDBACK MODAL IMPLEMENTATION ---

/**
 * Helper function to generate star ratings.
 */
function getStars(rating) {
    let stars = '';
    const maxStars = 5;
    const numRating = parseInt(rating);
    if (isNaN(numRating) || numRating < 1) return '<div></div>';
    
    for (let i = 1; i <= maxStars; i++) {
        stars += `<span class="${i <= numRating ? 'star-filled' : 'star-empty'}"></span>`;
    }
    return `<div class="star-rating">${stars}</div>`;
}

/**
 * Helper function to generate status/type tags.
 */
function getTag(label, value, tagType = 'type') {
    if (!value) return '';
    const className = String(value).toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    return `<span class="feedback-tag tag-${tagType}-${className}">${value}</span>`;
}

/**
 * Main controller for the Feedback Tab.
 */
function renderFeedbackTab() {
    console.log("DEBUG: renderFeedbackTab() called."); 
    const panel = document.getElementById("feedbackPanel");
    if (!panel) return;

    // 1. Build the Layout (Header + Toolbar + Table Container)
    panel.innerHTML = `
        <div class="glass-container p-6 min-h-[600px]"> 
            
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-white">Feedback Inbox</h2>
                    <p class="text-white/60 text-sm mt-1">User suggestions and bug reports</p>
                </div>
                <div id="feedbackStatusTabs" class="flex bg-black/20 p-1 rounded-lg">
                    <button class="px-4 py-1.5 text-xs font-medium rounded-md bg-white/10 text-white shadow" data-status="">All</button>
                    <button class="px-4 py-1.5 text-xs font-medium rounded-md text-white/60 hover:text-white hover:bg-white/5" data-status="Open">Open</button>
                    <button class="px-4 py-1.5 text-xs font-medium rounded-md text-white/60 hover:text-white hover:bg-white/5" data-status="In Progress">In Progress</button>
                    <button class="px-4 py-1.5 text-xs font-medium rounded-md text-white/60 hover:text-white hover:bg-white/5" data-status="Resolved">Resolved</button>
                </div>
            </div>
            
            <div class="admin-toolbar">
                <div class="admin-search-wrapper">
                    <span class="admin-search-icon"></span>
                    <input type="text" id="feedbackSearch" class="admin-search-input" placeholder="Search content or user...">
                </div>

                <div class="flex gap-2">
                    <select id="feedbackTypeFilter" class="input-field bg-black/20 border-white/10 text-sm py-2" style="width: auto;">
                        <option value="">All Types</option>
                        <option value="Bug / Error">Bug / Error</option>
                        <option value="Suggestion / Improvement">Suggestion</option>
                        <option value="Not Satisfied">Complaint</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            
            <div id="feedbackCardContainer" class="overflow-hidden rounded-xl border border-white/10 bg-black/20">
                <div class="flex items-center justify-center p-20">
                    <div class="loading-spinner mr-3"></div>
                    <span class="text-white/60">Loading feedback...</span>
                </div>
            </div>
        </div>
    `;

    // 2. Attach Event Listeners
    const statusTabs = panel.querySelector("#feedbackStatusTabs");
    const searchInput = panel.querySelector("#feedbackSearch");
    const typeFilter = panel.querySelector("#feedbackTypeFilter");

    // Tab Click Logic
    statusTabs.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Visual Update
            statusTabs.querySelectorAll("button").forEach(btn => {
                btn.className = "px-4 py-1.5 text-xs font-medium rounded-md text-white/60 hover:text-white hover:bg-white/5";
            });
            e.target.className = "px-4 py-1.5 text-xs font-medium rounded-md bg-white/10 text-white shadow";
            
            // Set active status for fetch logic (you might need to store this in a variable or read from DOM in fetch)
            statusTabs.dataset.activeStatus = e.target.dataset.status; 
            fetchAndRenderFeedback();
        }
    });

    let searchTimeout;
    searchInput.addEventListener("input", () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => fetchAndRenderFeedback(), 500);
    });

    typeFilter.addEventListener("change", () => fetchAndRenderFeedback());

    // 3. Initial Fetch
    fetchAndRenderFeedback();
}

/**
 * Fetches feedback data from the SECURE EDGE FUNCTION.
 */
async function fetchAndRenderFeedback() {
    const container = document.getElementById("feedbackCardContainer");
    if (!container) return;

    container.innerHTML = `
        <div class="flex items-center justify-center p-20">
            <div class="loading-spinner mr-3"></div>
            <span class="text-white/60">Fetching feedback...</span>
        </div>
    `;

    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error("Not logged in.");

        // 1. Get Filter Values
        // Read from the data attribute we set in the click listener above, or default to empty
        const statusTabs = document.getElementById("feedbackStatusTabs");
        const status = statusTabs ? (statusTabs.dataset.activeStatus || "") : "";
        
        const searchTerm = document.getElementById("feedbackSearch").value.trim();
        const reason = document.getElementById("feedbackTypeFilter").value;

        // 2. Build URL
        const params = new URLSearchParams({
            page: 1, 
            limit: 50,
            sortBy: 'created_at', // Usually better to see newest first
            sortOrder: 'desc'
        });
        if (status) params.append('status', status);
        if (reason) params.append('reason', reason);
        if (searchTerm) params.append('search', searchTerm);

        const url = `${SUPABASE_URL}/functions/v1/admin-feedback-secure/feedback?${params.toString()}`;

        // 3. Fetch
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            }
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to fetch feedback");

        currentFeedbackItems = data.data || []; // Update cache
        renderFeedbackTable(container, currentFeedbackItems); // Call the NEW table renderer

    } catch (error) {
        console.error("Error fetching feedback:", error);
        container.innerHTML = `<div class="p-10 text-center text-red-400">Error: ${error.message}</div>`;
    }
}

/**
 * Renders the individual feedback cards into the container.
 */
function renderFeedbackTable(container, feedbackItems) {
    if (!feedbackItems || feedbackItems.length === 0) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center p-16 text-white/40">
                <div class="text-4xl mb-2"></div>
                <p>No feedback found matching filters.</p>
            </div>`;
        return;
    }

    // Helper for stars
    const getStarsSimple = (rating) => {
        if (!rating) return '<span class="text-white/20">-</span>';
        return '<span class="text-yellow-400"></span>'.repeat(rating) + '<span class="text-white/10"></span>'.repeat(5-rating);
    };

    let tableHtml = `
        <table class="w-full text-left border-collapse">
            <thead class="bg-white/5 text-xs uppercase text-white/50 font-semibold tracking-wider">
                <tr>
                    <th class="p-4">Date</th>
                    <th class="p-4">User</th>
                    <th class="p-4">Type</th>
                    <th class="p-4">Preview</th>
                    <th class="p-4">Rating</th>
                    <th class="p-4">Status</th>
                    <th class="p-4 w-20">Action</th>
                </tr>
            </thead>
            <tbody class="text-sm divide-y divide-white/5">
    `;

    feedbackItems.forEach(item => {
        const user = item.users;
        const displayName = (user && user.first_name) ? `${user.first_name} ${user.last_name}` : (user?.email || 'Anonymous');
        
        // Badge Styles
        let statusClass = 'bg-white/10 text-white/70';
        if (item.status === 'New' || item.status === 'Open') statusClass = 'bg-green-500/20 text-green-300 border border-green-500/30';
        if (item.status === 'In Progress') statusClass = 'bg-blue-500/20 text-blue-300 border border-blue-500/30';
        if (item.status === 'Resolved') statusClass = 'bg-purple-500/20 text-purple-300 border border-purple-500/30';

        let typeIcon = '';
        if (item.reason === 'Bug / Error') typeIcon = '';
        if (item.reason === 'Suggestion / Improvement') typeIcon = '';
        if (item.reason === 'Not Satisfied') typeIcon = '';

        tableHtml += `
            <tr class="user-row group hover:bg-white/5 transition-colors">
                <td class="p-4 text-white/60 whitespace-nowrap">
                    ${new Date(item.created_at).toLocaleDateString()}
                </td>
                <td class="p-4 font-medium text-white/90">
                    ${displayName}
                </td>
                <td class="p-4">
                    <div class="flex items-center gap-2 text-white/80">
                        <span>${typeIcon}</span> <span>${item.reason}</span>
                    </div>
                </td>
                <td class="p-4 text-white/60 truncate max-w-xs">
                    ${item.content}
                </td>
                <td class="p-4 text-xs">
                    ${getStarsSimple(item.rating)}
                </td>
                <td class="p-4">
                    <span class="px-2 py-1 rounded text-xs font-bold ${statusClass} uppercase tracking-wide">${item.status}</span>
                </td>
                <td class="p-4">
                    <button class="btn btn-secondary p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity text-xs view-feedback-btn" data-id="${item.id}" title="View Details">
                        
                    </button>
                </td>
            </tr>
        `;
    });

    tableHtml += `</tbody></table>`;
    
    // Add footer count
    tableHtml += `
        <div class="p-4 bg-white/5 border-t border-white/10 text-xs text-white/40 text-center">
            Showing ${feedbackItems.length} items
        </div>
    `;

    container.innerHTML = tableHtml;

    // Attach Listeners
    container.querySelectorAll('.view-feedback-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.dataset.id;
            openFeedbackModal(id);
        });
    });
}

/**
 * Opens the beautiful feedback modal.
 */
function openFeedbackModal(feedbackId) {
    console.log(`DEBUG: openFeedbackModal() called for ID: ${feedbackId}`);
    
    const modal = $("feedbackDetailModal");
    const modalContent = $("feedbackModalContent");
    
    if (!modal || !modalContent) {
        console.error("DEBUG: Modal elements not found!");
        return;
    }

    const item = currentFeedbackItems.find(f => f.id == feedbackId);
    if (!item) {
        console.error(`DEBUG: Failed to find feedbackId ${feedbackId} in cache!`);
        alert("Error: Could not find feedback data.");
        return;
    }

    console.log("DEBUG: Found item in cache. Building modal content...", item);
    
    // Show modal with animation
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('modal-open'), 10);
    
    const user = item.users;
    const displayName = (user && user.first_name) ? `${user.first_name} ${user.last_name || ''}`.trim() : (user && user.email) ? user.email.split('@')[0] : 'Anonymous';
    const displayEmail = user ? user.email : 'N/A';

    modalContent.innerHTML = `
        <div class="modal-header">
            <div class="modal-title-section">
                <h3 class="modal-title">${item.reason || 'Feedback'}</h3>
                <div class="modal-rating">${getStars(item.rating)}</div>
            </div>
            <button class="modal-close-btn" id="modalCloseBtn">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="modal-tags">
                ${getTag('Type', item.reason, 'type')}
                ${getTag('Priority', item.priority, 'priority')}
                ${getTag('Status', item.status, 'status')}
            </div>
            
            <div class="modal-content-section">
                <h4 class="modal-section-title">Feedback Content</h4>
                <div class="modal-feedback-content">
                    ${item.content}
                </div>
            </div>
            
            <div class="modal-info-grid">
                <div class="modal-info-card">
                    <h5 class="modal-info-label">From</h5>
                    <div class="modal-info-value">${displayName}</div>
                    <div class="modal-info-sub">${displayEmail}</div>
                </div>
                <div class="modal-info-card">
                    <h5 class="modal-info-label">Submitted</h5>
                    <div class="modal-info-value">${new Date(item.created_at).toLocaleDateString()}</div>
                    <div class="modal-info-sub">${new Date(item.created_at).toLocaleTimeString()}</div>
                </div>
                <div class="modal-info-card">
                    <h5 class="modal-info-label">Status</h5>
                    <div class="modal-info-value">${item.status}</div>
                </div>
                <div class="modal-info-card">
                    <h5 class="modal-info-label">Category</h5>
                    <div class="modal-info-value">${item.tool_name}</div>
                </div>
            </div>

            <div class="modal-status-section">
                <h4 class="modal-section-title">Update Status</h4>
                <div class="modal-status-controls">
                    <select id="modalStatusSelect" class="modal-select">
                        <option value="Open" ${item.status === 'Open' ? 'selected' : ''}>Open</option>
                        <option value="In Progress" ${item.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Resolved" ${item.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                    </select>
                    <button id="modalUpdateBtn" class="modal-btn modal-btn-primary">Update</button>
                </div>
            </div>
            
            <div class="modal-notes-section">
                <h4 class="modal-section-title">Internal Notes</h4>
                <textarea id="modalNotes" class="modal-textarea" placeholder="Add internal notes about this feedback...">${item.admin_notes || ''}</textarea>
                <button id="modalSaveNotesBtn" class="modal-btn modal-btn-secondary">Save Notes (Soon)</button>
            </div>
        </div>
    `;

    console.log("DEBUG: Modal content generated. Attaching listeners...");

    // Attach event listeners
    setTimeout(() => {
        const closeBtn = $("modalCloseBtn");
        const updateBtn = $("modalUpdateBtn");
        const saveNotesBtn = $("modalSaveNotesBtn");
        
        // Close button handler
        if (closeBtn) {
            closeBtn.onclick = () => {
                console.log("DEBUG: Close button clicked");
                closeFeedbackModal();
            };
        }

        if (updateBtn) {
            updateBtn.onclick = async () => {
                const statusSelect = $("modalStatusSelect");
                const newStatus = statusSelect ? statusSelect.value : 'Open';
                console.log(`DEBUG: 'Update Status' clicked. New status: ${newStatus}`);
                await handleUpdateFeedbackStatus(item.id, newStatus, null);
            };
        }

        if (saveNotesBtn) {
            // Make the button functional and remove "(Soon)"
            saveNotesBtn.textContent = "Save Notes";
            saveNotesBtn.onclick = () => {
                console.log("DEBUG: 'Save Notes' clicked");
                // Pass the feedback item's ID to your new handler
                handleSaveFeedbackNotes(item.id); 
            };
        }
    }, 100);
}

/**
 * Closes the feedback modal.
 */
function closeFeedbackModal() {
    console.log("DEBUG: closeFeedbackModal() called");
    const modal = $("feedbackDetailModal");
    if (modal) {
        modal.classList.remove('modal-open');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

/**
 * Shows messages in the modal.
 */
function showModalMessage(message, type) {
    const messageEl = $("modalMessage");
    if (messageEl) {
        messageEl.style.display = "block";
        messageEl.className = `modal-message ${type === "error" ? "modal-message-error" : "modal-message-success"}`;
        messageEl.textContent = message;
        
        setTimeout(() => {
            messageEl.style.display = "none";
        }, 3000);
    }
}

/**
 * Handles updating the status of a feedback item via the SECURE EDGE FUNCTION.
 */
async function handleUpdateFeedbackStatus(feedbackId, newStatus, closeCallback) {
    console.log(`DEBUG: handleUpdateFeedbackStatus() called. ID: ${feedbackId}, New Status: ${newStatus}`); 
    const updateBtn = $("modalUpdateBtn");
    
    if(updateBtn) updateBtn.disabled = true;
    showModalMessage("Updating...", "success");
    
    try {
        // 1. Get session token
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error("Not logged in");

        // 2. Call the secure Edge Function
        const url = `${SUPABASE_URL}/functions/v1/admin-feedback-secure/feedback/${feedbackId}`;
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || "Failed to update status");
        }
            
        console.log("DEBUG: Supabase update success:", data.data); 
        showModalMessage(`Status updated to "${newStatus}"!`, "success");
        
        // 3. Refresh the list from the server
        await fetchAndRenderFeedback();
        
        if (closeCallback) {
            setTimeout(closeCallback, 1500);
        }

    } catch (error) {
        console.error("Error updating status:", error);
        showModalMessage(error.message, "error");
    } finally {
        if(updateBtn) updateBtn.disabled = false;
    }
}

/**
 * Handles saving the internal admin notes via the SECURE EDGE FUNCTION.
 */
async function handleSaveFeedbackNotes(feedbackId) {
    console.log(`DEBUG: handleSaveFeedbackNotes() called for ID: ${feedbackId}`);
    
    const notesText = $("modalNotes").value.trim();
    const saveBtn = $("modalSaveNotesBtn");
    if (!saveBtn) return;

    const originalBtnText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="loading-spinner mr-2"></span> Saving...';
    
    showModalMessage("Saving notes...", "success"); 

    try {
        // 1. Get session token
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error("You are not authenticated.");

        // 2. Call the secure Edge Function
        const url = `${SUPABASE_URL}/functions/v1/admin-feedback-secure/feedback/${feedbackId}`;
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({ admin_notes: notesText }) // Send only the notes
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || "Failed to save notes");
        }
        
        const updatedNotes = data.data?.admin_notes;

        // 3. Update the local cache
        const index = currentFeedbackItems.findIndex(f => f.id == feedbackId);
        if (index !== -1) {
            currentFeedbackItems[index].admin_notes = updatedNotes;
            console.log("DEBUG: Local cache updated with new notes.");
        }
        
        // 4. Show success
        showModalMessage("Notes saved successfully!", "success");

    } catch (error) {
        console.error("Error saving notes:", error);
        showModalMessage(error.message, "error");
    } finally {
        // 5. Reset button
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalBtnText;
    }
}

// Global click handler to close modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = $("feedbackDetailModal");
    if (modal && e.target === modal) {
        closeFeedbackModal();
    }
});

// Global escape key handler
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const modal = $("feedbackDetailModal");
        if (modal && modal.style.display === 'flex') {
            closeFeedbackModal();
        }
    }
});

// --- END OF BEAUTIFUL MODAL FUNCTIONS ---

/**
 * Main controller for the Contacts Tab.
 * Builds the UI and triggers the first data fetch.
 */
function renderContactsTab() {
    console.log("DEBUG: renderContactsTab() called.");
    const panel = document.getElementById("contactsPanel");
    if (!panel) return;

    // 1. Build Layout
    panel.innerHTML = `
        <div class="glass-container p-6 min-h-[600px]"> 
            
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-white">Contact Inbox</h2>
                    <p class="text-white/60 text-sm mt-1">Messages from the contact form</p>
                </div>
                <div id="contactStatusTabs" class="flex bg-black/20 p-1 rounded-lg">
                    <button class="px-4 py-1.5 text-xs font-medium rounded-md bg-white/10 text-white shadow" data-status="">All</button>
                    <button class="px-4 py-1.5 text-xs font-medium rounded-md text-white/60 hover:text-white hover:bg-white/5" data-status="New">New</button>
                    <button class="px-4 py-1.5 text-xs font-medium rounded-md text-white/60 hover:text-white hover:bg-white/5" data-status="Replied">Replied</button>
                    <button class="px-4 py-1.5 text-xs font-medium rounded-md text-white/60 hover:text-white hover:bg-white/5" data-status="Archived">Archived</button>
                </div>
            </div>
            
            <div class="admin-toolbar">
                <div class="admin-search-wrapper">
                    <span class="admin-search-icon"></span>
                    <input type="text" id="contactSearch" class="admin-search-input" placeholder="Search subject, email, or name...">
                </div>

                <div class="flex gap-2">
                    <select id="contactSortBy" class="input-field bg-black/20 border-white/10 text-sm py-2" style="width: auto;">
                        <option value="created_at">Newest First</option>
                        <option value="last_name">Last Name</option>
                        <option value="company_name">Company</option>
                    </select>
                </div>
            </div>
            
            <div id="contactCardContainer" class="overflow-hidden rounded-xl border border-white/10 bg-black/20">
                <div class="flex items-center justify-center p-20">
                    <div class="loading-spinner mr-3"></div>
                    <span class="text-white/60">Loading messages...</span>
                </div>
            </div>
        </div>
    `;

    // 2. Attach Listeners
    const statusTabs = panel.querySelector("#contactStatusTabs");
    const searchInput = panel.querySelector("#contactSearch");
    const sortSelect = panel.querySelector("#contactSortBy");

    // Tab Logic
    statusTabs.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            statusTabs.querySelectorAll("button").forEach(btn => {
                btn.className = "px-4 py-1.5 text-xs font-medium rounded-md text-white/60 hover:text-white hover:bg-white/5";
            });
            e.target.className = "px-4 py-1.5 text-xs font-medium rounded-md bg-white/10 text-white shadow";
            
            // Store status for the fetch function
            statusTabs.dataset.activeStatus = e.target.dataset.status;
            fetchAndRenderContacts(1);
        }
    });

    let searchTimeout;
    searchInput.addEventListener("input", () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => fetchAndRenderContacts(1), 500);
    });

    sortSelect.addEventListener("change", () => fetchAndRenderContacts(1));

    // 3. Initial Fetch
    fetchAndRenderContacts(1);
}

    /**
 * Renders the Subscriptions tab with nested navigation (Overview, Transactions, Subscriptions, Customers).
 */
function renderSubscriptionsTab() {
    const panel = document.getElementById("subscriptionsPanel");
    if (!panel) return;

    // Get persisted currency (Default CAD)
    const storedCurrency = window.currentSelectedCurrency || 'CAD';
    const isSel = (cur) => cur === storedCurrency ? 'selected' : '';

    // 1. Build the UI
    panel.innerHTML = `
        <div class="glass-container p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Payments Dashboard</h2>
                <div class="text-sm text-white/60 italic">
                    Read-only view (Mirroring Stripe)
                </div>
            </div>

            <div class="flex space-x-6 border-b border-white/10 mb-6" id="subTabsNav">
                <button class="sub-tab-btn active pb-2 border-b-2 border-indigo-400 font-medium text-white" data-target="overview">Overview</button>
                <button class="sub-tab-btn pb-2 border-b-2 border-transparent text-white/60 hover:text-white transition-all" data-target="transactions">Transactions</button>
                <button class="sub-tab-btn pb-2 border-b-2 border-transparent text-white/60 hover:text-white transition-all" data-target="subscriptions">Subscriptions</button>
                <button class="sub-tab-btn pb-2 border-b-2 border-transparent text-white/60 hover:text-white transition-all" data-target="customers">Customers</button>
            </div>

            <div id="sub-overview" class="sub-panel block animate-fadeIn">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10 relative group hover:border-indigo-500/50 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-indigo-500/20 rounded text-indigo-300 text-xl">$</div>
                            
                            <select id="adminCurrencySelect" class="bg-black/40 text-xs text-white/90 border border-white/10 rounded px-2 py-1 focus:outline-none focus:border-indigo-500 cursor-pointer hover:bg-black/60 transition-colors z-20">
                                <option value="CAD" ${isSel('CAD')}> CAD</option>
                                <option value="USD" ${isSel('USD')}> USD</option>
                                <option value="SGD" ${isSel('SGD')}> SGD</option>
                                <option value="EUR" ${isSel('EUR')}> EUR</option>
                                <option value="GBP" ${isSel('GBP')}> GBP</option>
                                <option value="AUD" ${isSel('AUD')}> AUD</option>
                                <option value="JPY" ${isSel('JPY')}> JPY</option>
                            </select>
                        </div>
                        <p class="text-sm text-white/60">Monthly Revenue (MRR)</p>
                        <h3 id="overviewMRR" class="text-2xl font-bold mt-1">--</h3>
                    </div>

                    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-blue-500/20 rounded text-blue-300 text-xl"></div>
                        </div>
                        <p class="text-sm text-white/60">Active Subscriptions</p>
                        <h3 id="overviewActiveSubs" class="text-2xl font-bold mt-1">--</h3>
                    </div>
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-purple-500/20 rounded text-purple-300 text-xl"></div>
                        </div>
                        <p class="text-sm text-white/60">Total Customers</p>
                        <h3 id="overviewCustomers" class="text-2xl font-bold mt-1">--</h3>
                    </div>
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-pink-500/20 rounded text-pink-300 text-xl"></div>
                        </div>
                        <p class="text-sm text-white/60">Avg. Order Value</p>
                        <h3 id="overviewAOV" class="text-2xl font-bold mt-1">--</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-2 bg-white/5 p-4 rounded-lg border border-white/10">
                        <h3 class="text-lg font-bold mb-4">Revenue Growth (12 Months)</h3>
                        <div id="mrrTrendChart" class="w-full h-[300px]"></div>
                    </div>
                    
                    <div class="lg:col-span-1 bg-white/5 p-4 rounded-lg border border-white/10 flex flex-col">
                        <h3 class="text-lg font-bold mb-4">Recent Activity</h3>
                        <div class="overflow-y-auto flex-grow max-h-[300px]">
                            <table class="w-full text-left text-sm">
                                <tbody id="overviewTransactionsTable">
                                    <tr><td class="p-4 text-center text-white/40 italic">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sub-transactions" class="sub-panel hidden animate-fadeIn">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Transaction History</h3>
                    <button id="refreshTransBtn" class="btn btn-secondary text-xs"> Refresh</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left styled-table text-sm">
                        <thead>
                            <tr>
                                <th class="p-3">Status</th>
                                <th class="p-3">Amount</th>
                                <th class="p-3">Method</th>
                                <th class="p-3">Customer Email</th>
                                <th class="p-3">Date</th>
                                <th class="p-3">ID</th>
                            </tr>
                        </thead>
                        <tbody id="fullTransactionsTable">
                             <tr><td colspan="6" class="p-10 text-center text-white/40">Loading transactions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="sub-subscriptions" class="sub-panel hidden animate-fadeIn">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="flex-grow">
                        <input type="text" id="subscriptionSearch" class="input-field" placeholder="Search email, ID, or product...">
                    </div>
                    <div class="flex-shrink-0">
                        <select id="subscriptionStatusFilter" class="input-field">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="past_due">Past Due</option>
                            <option value="canceled">Canceled</option>
                            <option value="trialing">Trialing</option>
                        </select>
                    </div>
                    <div class="flex-shrink-0">
                         <button id="refreshSubsBtn" class="btn btn-secondary h-full"> Refresh</button>
                    </div>
                </div>
                <div id="subscriptionTableContainer" class="overflow-x-auto min-h-[300px]">
                    <div class="flex items-center justify-center p-10">
                        <div class="loading-spinner mr-3"></div>
                        <span class="text-white/80">Loading subscription data...</span>
                    </div>
                </div>
            </div>

            <div id="sub-customers" class="sub-panel hidden animate-fadeIn">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="flex-grow">
                        <input type="text" id="customerSearch" class="input-field" placeholder="Search customer email...">
                    </div>
                    <div class="flex-shrink-0">
                         <button id="refreshCustBtn" class="btn btn-secondary h-full"> Refresh</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left styled-table text-sm">
                        <thead>
                            <tr>
                                <th class="p-3">Email</th>
                                <th class="p-3">Customer ID</th>
                                <th class="p-3">Created At</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable">
                            <tr><td colspan="3" class="p-10 text-center text-white/40">Loading customers...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    setupSubscriptionSubTabLogic();

    // Attach Listener for new dropdown
    const currencySelect = document.getElementById("adminCurrencySelect");
    if (currencySelect) {
        currencySelect.addEventListener("change", () => {
            window.currentSelectedCurrency = currencySelect.value;
            if (window.lastOverviewData) renderOverviewTab(window.lastOverviewData);
        });
    }

    const subSearch = document.getElementById("subscriptionSearch");
    const subFilter = document.getElementById("subscriptionStatusFilter");
    const subRefresh = document.getElementById("refreshSubsBtn");
    
    if (subSearch) subSearch.addEventListener("input", debounce(() => fetchAndRenderSubscriptions('subscriptions'), 500));
    if (subFilter) subFilter.addEventListener("change", () => fetchAndRenderSubscriptions('subscriptions'));
    if (subRefresh) subRefresh.addEventListener("click", () => fetchAndRenderSubscriptions('subscriptions'));

    const transRefresh = document.getElementById("refreshTransBtn");
    if (transRefresh) transRefresh.addEventListener("click", () => fetchAndRenderSubscriptions('transactions'));

    const custSearch = document.getElementById("customerSearch");
    const custRefresh = document.getElementById("refreshCustBtn");
    if (custSearch) custSearch.addEventListener("input", debounce(() => fetchAndRenderSubscriptions('customers'), 500));
    if (custRefresh) custRefresh.addEventListener("click", () => fetchAndRenderSubscriptions('customers'));

    fetchAndRenderSubscriptions('overview');
}

    function setupSubscriptionSubTabLogic() {
    const navButtons = document.querySelectorAll('#subTabsNav .sub-tab-btn');
    const panels = document.querySelectorAll('.sub-panel');

    navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            // 1. Toggle Button Styles
            navButtons.forEach(b => {
                b.classList.remove('active', 'border-indigo-400', 'text-white');
                b.classList.add('border-transparent', 'text-white/60');
            });
            btn.classList.add('active', 'border-indigo-400', 'text-white');
            btn.classList.remove('border-transparent', 'text-white/60');

            // 2. Toggle Panels
            const targetId = btn.dataset.target;
            panels.forEach(p => {
                if (p.id === targetId) {
                    p.classList.remove('hidden');
                } else {
                    p.classList.add('hidden');
                }
            });
        });
    });
}

/**
 * Master fetcher for the Payments Dashboard.
 * Routes requests based on the active tab (overview, transactions, subscriptions, customers).
 */
async function fetchAndRenderSubscriptions(tabName = 'overview', page = 1) {
    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        // Show Loading State on buttons
        const refreshBtnId = tabName === 'transactions' ? 'refreshTransBtn' : 
                             tabName === 'customers' ? 'refreshCustBtn' : 'refreshSubsBtn';
        const refreshBtn = document.getElementById(refreshBtnId);
        const originalText = refreshBtn ? refreshBtn.textContent : '';
        if (refreshBtn) { refreshBtn.textContent = "..."; refreshBtn.disabled = true; }

        // Prepare Search Params
        const params = new URLSearchParams({
            tab: tabName,
            page: page.toString(),
            limit: '20'
        });

        // Add filters
        if (tabName === 'subscriptions') {
            const search = document.getElementById("subscriptionSearch")?.value || '';
            const status = document.getElementById("subscriptionStatusFilter")?.value || '';
            if (search) params.append('search', search);
            if (status) params.append('status', status);
        } else if (tabName === 'customers') {
            const search = document.getElementById("customerSearch")?.value || '';
            if (search) params.append('search', search);
        }

        // --- DYNAMIC ENDPOINT SELECTION ---
        let endpointUrl = `https://supabase.sageaios.com/functions/v1/admin-subscriptions-secure?${params.toString()}`;

        // If we are on the overview tab, use our new analytics function for the 12-month data
        if (tabName === 'overview') {
            endpointUrl = `https://supabase.sageaios.com/functions/v1/stripe-analytics`;
        }
        // ----------------------------------

        // Call Edge Function
        const response = await fetch(endpointUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            }
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to fetch data');

        // Route to Renderers (Now passing Pagination Data!)
        if (tabName === 'overview') {
            renderOverviewTab(result);
        } else if (tabName === 'transactions') {
            // Stripe API returns 'has_more' instead of total pages
            renderTransactionsTab(result.data, result.has_more, result.last_id);
        } else if (tabName === 'subscriptions') {
            renderSubscriptionsTable(
                document.getElementById("subscriptionTableContainer"), 
                result.data || [], 
                result.pagination // Passing pagination info
            );
        } else if (tabName === 'customers') {
            renderCustomersTab(result.data, result.pagination);
        }

        if (refreshBtn) { refreshBtn.textContent = originalText; refreshBtn.disabled = false; }

    } catch (error) {
        console.error("Dashboard Fetch Error:", error);
        
        // Optional: Reset button state on error so it doesn't stay stuck on "..."
        const refreshBtnId = tabName === 'transactions' ? 'refreshTransBtn' : 
                             tabName === 'customers' ? 'refreshCustBtn' : 'refreshSubsBtn';
        const refreshBtn = document.getElementById(refreshBtnId);
        if (refreshBtn) {
             refreshBtn.textContent = "Error";
             setTimeout(() => {
                 refreshBtn.disabled = false; 
                 refreshBtn.textContent = " Refresh";
             }, 2000);
        }
    }
}

/**
 * Renders the specific Subscriptions List table
 */
function renderSubscriptionsTab() {
    const panel = document.getElementById("subscriptionsPanel");
    if (!panel) return;

    // 1. Get persisted currency or default to CAD
    const storedCurrency = window.currentSelectedCurrency || 'CAD';
    const isSel = (cur) => cur === storedCurrency ? 'selected' : '';

    panel.innerHTML = `
        <div class="glass-container p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Payments Dashboard</h2>
                <div class="text-sm text-white/60 italic">
                    Read-only view (Mirroring Stripe)
                </div>
            </div>

            <div class="flex space-x-6 border-b border-white/10 mb-6" id="subTabsNav">
                <button class="sub-tab-btn active pb-2 border-b-2 border-indigo-400 font-medium text-white" data-target="overview">Overview</button>
                <button class="sub-tab-btn pb-2 border-b-2 border-transparent text-white/60 hover:text-white transition-all" data-target="transactions">Transactions</button>
                <button class="sub-tab-btn pb-2 border-b-2 border-transparent text-white/60 hover:text-white transition-all" data-target="subscriptions">Subscriptions</button>
                <button class="sub-tab-btn pb-2 border-b-2 border-transparent text-white/60 hover:text-white transition-all" data-target="customers">Customers</button>
            </div>

            <div id="sub-overview" class="sub-panel block animate-fadeIn">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10 relative group hover:border-indigo-500/50 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-indigo-500/20 rounded text-indigo-300 text-xl">$</div>
                            
                            <select id="adminCurrencySelect" class="bg-black/40 text-xs text-white/90 border border-white/10 rounded px-2 py-1 focus:outline-none focus:border-indigo-500 cursor-pointer hover:bg-black/60 transition-colors z-20">
                                <option value="CAD" ${isSel('CAD')}> CAD</option>
                                <option value="USD" ${isSel('USD')}> USD</option>
                                <option value="SGD" ${isSel('SGD')}> SGD</option>
                                <option value="EUR" ${isSel('EUR')}> EUR</option>
                                <option value="GBP" ${isSel('GBP')}> GBP</option>
                                <option value="AUD" ${isSel('AUD')}> AUD</option>
                                <option value="JPY" ${isSel('JPY')}> JPY</option>
                            </select>
                        </div>
                        <p class="text-sm text-white/60">Monthly Revenue (MRR)</p>
                        <h3 id="overviewMRR" class="text-2xl font-bold mt-1">--</h3>
                    </div>

                    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-blue-500/20 rounded text-blue-300 text-xl"></div>
                        </div>
                        <p class="text-sm text-white/60">Active Subscriptions</p>
                        <h3 id="overviewActiveSubs" class="text-2xl font-bold mt-1">--</h3>
                    </div>
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-purple-500/20 rounded text-purple-300 text-xl"></div>
                        </div>
                        <p class="text-sm text-white/60">Total Customers</p>
                        <h3 id="overviewCustomers" class="text-2xl font-bold mt-1">--</h3>
                    </div>
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <div class="p-2 bg-pink-500/20 rounded text-pink-300 text-xl"></div>
                        </div>
                        <p class="text-sm text-white/60">Avg. Order Value</p>
                        <h3 id="overviewAOV" class="text-2xl font-bold mt-1">--</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-2 bg-white/5 p-4 rounded-lg border border-white/10">
                        <h3 class="text-lg font-bold mb-4">Revenue Growth (12 Months)</h3>
                        <div id="mrrTrendChart" class="w-full h-[300px]"></div>
                    </div>
                    
                    <div class="lg:col-span-1 bg-white/5 p-4 rounded-lg border border-white/10 flex flex-col">
                        <h3 class="text-lg font-bold mb-4">Recent Activity</h3>
                        <div class="overflow-y-auto flex-grow max-h-[300px]">
                            <table class="w-full text-left text-sm">
                                <tbody id="overviewTransactionsTable">
                                    <tr><td class="p-4 text-center text-white/40 italic">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sub-transactions" class="sub-panel hidden animate-fadeIn">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Transaction History</h3>
                    <button id="refreshTransBtn" class="btn btn-secondary text-xs"> Refresh</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left styled-table text-sm">
                        <thead>
                            <tr>
                                <th class="p-3">Status</th>
                                <th class="p-3">Amount</th>
                                <th class="p-3">Method</th>
                                <th class="p-3">Customer Email</th>
                                <th class="p-3">Date</th>
                                <th class="p-3">ID</th>
                            </tr>
                        </thead>
                        <tbody id="fullTransactionsTable">
                             <tr><td colspan="6" class="p-10 text-center text-white/40">Loading transactions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="sub-subscriptions" class="sub-panel hidden animate-fadeIn">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="flex-grow">
                        <input type="text" id="subscriptionSearch" class="input-field" placeholder="Search email, ID, or product...">
                    </div>
                    <div class="flex-shrink-0">
                        <select id="subscriptionStatusFilter" class="input-field">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="past_due">Past Due</option>
                            <option value="canceled">Canceled</option>
                            <option value="trialing">Trialing</option>
                        </select>
                    </div>
                    <div class="flex-shrink-0">
                         <button id="refreshSubsBtn" class="btn btn-secondary h-full"> Refresh</button>
                    </div>
                </div>
                <div id="subscriptionTableContainer" class="overflow-x-auto min-h-[300px]">
                    <div class="flex items-center justify-center p-10">
                        <div class="loading-spinner mr-3"></div>
                        <span class="text-white/80">Loading subscription data...</span>
                    </div>
                </div>
            </div>

            <div id="sub-customers" class="sub-panel hidden animate-fadeIn">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="flex-grow">
                        <input type="text" id="customerSearch" class="input-field" placeholder="Search customer email...">
                    </div>
                    <div class="flex-shrink-0">
                         <button id="refreshCustBtn" class="btn btn-secondary h-full"> Refresh</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left styled-table text-sm">
                        <thead>
                            <tr>
                                <th class="p-3">Email</th>
                                <th class="p-3">Customer ID</th>
                                <th class="p-3">Created At</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable">
                            <tr><td colspan="3" class="p-10 text-center text-white/40">Loading customers...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    setupSubscriptionSubTabLogic();

    // Add Listener for the new dropdown
    const currencySelect = document.getElementById("adminCurrencySelect");
    if (currencySelect) {
        currencySelect.addEventListener("change", () => {
            window.currentSelectedCurrency = currencySelect.value;
            if (window.lastOverviewData) {
                renderOverviewTab(window.lastOverviewData);
            }
        });
    }

    // Re-attach other listeners (search, filter, refresh)
    const subSearch = document.getElementById("subscriptionSearch");
    const subFilter = document.getElementById("subscriptionStatusFilter");
    const subRefresh = document.getElementById("refreshSubsBtn");
    if (subSearch) subSearch.addEventListener("input", debounce(() => fetchAndRenderSubscriptions('subscriptions'), 500));
    if (subFilter) subFilter.addEventListener("change", () => fetchAndRenderSubscriptions('subscriptions'));
    if (subRefresh) subRefresh.addEventListener("click", () => fetchAndRenderSubscriptions('subscriptions'));

    const transRefresh = document.getElementById("refreshTransBtn");
    if (transRefresh) transRefresh.addEventListener("click", () => fetchAndRenderSubscriptions('transactions'));

    const custSearch = document.getElementById("customerSearch");
    const custRefresh = document.getElementById("refreshCustBtn");
    if (custSearch) custSearch.addEventListener("input", debounce(() => fetchAndRenderSubscriptions('customers'), 500));
    if (custRefresh) custRefresh.addEventListener("click", () => fetchAndRenderSubscriptions('customers'));

    // Load data
    fetchAndRenderSubscriptions('overview');
}

function renderOverviewTab(data) {
    window.lastOverviewData = data;

    const currencySelect = document.getElementById("adminCurrencySelect");
    const targetCurrency = currencySelect ? currencySelect.value : (window.currentSelectedCurrency || 'CAD');

    const getRate = (currencyCode) => {
        if (window.exchangeRates && window.exchangeRates[currencyCode]) {
            return window.exchangeRates[currencyCode];
        }
        const FALLBACKS = { 'USD': 1.0, 'CAD': 1.40, 'SGD': 1.35, 'EUR': 0.92, 'GBP': 0.79, 'AUD': 1.55, 'JPY': 150.0 };
        return FALLBACKS[currencyCode] || 1.0;
    };

    const convert = (amount, sourceCurrency) => {
        if (!amount) return 0;
        if (sourceCurrency === targetCurrency) return amount;
        
        const sourceRate = getRate(sourceCurrency); 
        const targetRate = getRate(targetCurrency); 
        
        const amountInUSD = amount / sourceRate;
        return amountInUSD * targetRate;
    };

    if (data.stats) {
        const { mrr, active_count, total_customers, avg_order_value, currency } = data.stats;
        const sourceCurrency = currency || 'USD'; 

        const convertedMRR = convert(mrr / 100, sourceCurrency);
        const convertedAOV = convert(parseFloat(avg_order_value), sourceCurrency);

        const mrrEl = document.getElementById("overviewMRR");
        if (mrrEl) mrrEl.textContent = convertedMRR.toLocaleString('en-US', { style: 'currency', currency: targetCurrency });
        
        const aovEl = document.getElementById("overviewAOV");
        if (aovEl) aovEl.textContent = convertedAOV.toLocaleString('en-US', { style: 'currency', currency: targetCurrency });

        const activeEl = document.getElementById("overviewActiveSubs");
        if (activeEl) activeEl.textContent = active_count;

        const custEl = document.getElementById("overviewCustomers");
        if (custEl) custEl.textContent = total_customers;
    }

    if (data.trend && document.getElementById("mrrTrendChart")) {
        const sourceCurrency = data.stats.currency || 'USD';

        let xValues = data.trend.map(t => t.month);
        let yValues = data.trend.map(t => convert(t.mrr, sourceCurrency));

        // --- DYNAMIC JPY/CURRENCY SCALING ---
        const maxRevenue = Math.max(...yValues, 0);
        
        // 1. Determine Scale: "High Value" currencies (JPY) need bigger steps
        const isHighValue = ['JPY', 'KRW', 'VND'].includes(targetCurrency);
        
        // 2. Set Milestone Step: 100,000 for JPY, 1,000 for others
        const milestoneStep = isHighValue ? 100000 : 1000;

        // 3. Calculate Ceiling (Round up to next milestone)
        const yAxisMax = (Math.floor(maxRevenue / milestoneStep) + 1) * milestoneStep;
        // ------------------------------------

        const monthsNeeded = 12 - xValues.length;
        if (monthsNeeded > 0) {
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let currentFirstMonthIndex = monthNames.indexOf(xValues[0]);
            if (currentFirstMonthIndex === -1) currentFirstMonthIndex = 0;

            for (let i = 1; i <= monthsNeeded; i++) {
                let prevIndex = (currentFirstMonthIndex - i + 12) % 12;
                xValues.unshift(monthNames[prevIndex]);
                yValues.unshift(0);
            }
        }

        const trace = {
            x: xValues,
            y: yValues,
            type: 'scatter',
            mode: 'lines', 
            fill: 'tozeroy', 
            fillcolor: 'rgba(167, 139, 250, 0.1)', 
            line: { color: '#A78BFA', width: 3, shape: 'spline', smoothing: 1.3 },
            hovertemplate: `<b>%{x}</b><br>Revenue: %{y:$.2f} ${targetCurrency}<extra></extra>` 
        };

        const layout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'rgba(255,255,255,0.6)', family: 'Inter, sans-serif', size: 11 },
            margin: { t: 20, r: 20, b: 40, l: 60 }, 
            xaxis: { showgrid: true, gridcolor: 'rgba(255,255,255,0.05)', zeroline: false, showline: false, fixedrange: true, range: [-0.5, 11.5] },
            yaxis: { 
                gridcolor: 'rgba(255,255,255,0.05)', 
                zeroline: false, 
                fixedrange: true,
                // Force correct range based on currency type
                range: [0, yAxisMax], 
                autorange: false 
            },
            showlegend: false,
            hovermode: 'x unified', 
            hoverlabel: { bgcolor: '#111827', bordercolor: 'rgba(255,255,255,0.1)', font: { color: '#ffffff' } }
        };
        
        const config = { responsive: true, displayModeBar: false };
        Plotly.newPlot('mrrTrendChart', [trace], layout, config);
    }

    // 5. Update Recent Transactions
    const txnTable = document.getElementById("overviewTransactionsTable");
    if (txnTable && data.transactions) {
        let html = '';
        if (data.transactions.length === 0) {
            html = `<tr><td class="p-4 text-center text-white/40 italic">No recent transactions.</td></tr>`;
        } else {
            const sourceCurrency = data.stats.currency || 'USD';

            data.transactions.forEach(tx => {
                const isSuccess = tx.status === 'paid' || tx.status === 'succeeded';
                const convertedAmount = convert(tx.amount / 100, sourceCurrency);
                const displayAmount = convertedAmount.toLocaleString('en-US', { style: 'currency', currency: targetCurrency });

                html += `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                        <td class="p-3">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-white">${displayAmount}</span>
                                <span class="text-xs text-white/50">${new Date(tx.created).toLocaleDateString()}</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-xs text-white/70 truncate max-w-[120px]" title="${tx.customer_email}">${tx.customer_email}</span>
                                <span class="text-[10px] px-1.5 py-0.5 rounded ${isSuccess ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${tx.status}</span>
                            </div>
                        </td>
                    </tr>`;
            });
        }
        txnTable.innerHTML = html;
    }
}

function renderTransactionsTab(transactions, hasMore, lastId) {
    const tableBody = document.getElementById("fullTransactionsTable");
    // We need to find the container holding the table to append pagination buttons, 
    // or just replace the whole innerHTML of the container if you prefer.
    // For safety, let's just update the tbody and handle "Load More" manually if needed.
    
    // Actually, looking at the HTML structure, it's better to replace the table rows
    if (!tableBody) return;

    if (!transactions || transactions.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-white/40">
            <div class="flex flex-col items-center">
                <span class="text-2xl mb-2"></span>
                <span>No transactions found.</span>
            </div>
        </td></tr>`;
        return;
    }

    let html = '';
    transactions.forEach(tx => {
        const statusColor = tx.status === 'succeeded' ? 'text-green-400 bg-green-500/20 border-green-500/30' : 'text-yellow-400 bg-yellow-500/20 border-yellow-500/30';
        html += `
            <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                <td class="p-3"><span class="px-2 py-1 rounded text-xs border ${statusColor}">${tx.status}</span></td>
                <td class="p-3 font-bold">$${(tx.amount / 100).toFixed(2)} <span class="text-xs font-normal text-white/50">${tx.currency.toUpperCase()}</span></td>
                <td class="p-3 text-sm capitalize">${tx.payment_method} ${tx.last4 ? ' ' + tx.last4 : ''}</td>
                <td class="p-3 text-sm text-white/80">${tx.customer_email}</td>
                <td class="p-3 text-sm text-white/60">${new Date(tx.created).toLocaleString()}</td>
                <td class="p-3 font-mono text-xs text-white/50">${tx.id.slice(0, 12)}...</td>
            </tr>`;
    });
    tableBody.innerHTML = html;
}

function renderCustomersTab(customers, pagination) {
    const tableBody = document.getElementById("customersTable");
    if (!tableBody) return;

    if (!customers || customers.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" class="p-10 text-center text-white/40">No customers found.</td></tr>`;
        return;
    }

    // Update Table Header (Add Status/Plan)
    const thead = tableBody.parentElement.querySelector("thead tr");
    if (thead) {
        thead.innerHTML = `
            <th class="p-3">Customer</th>
            <th class="p-3">Current Plan</th>
            <th class="p-3">Status</th>
            <th class="p-3">Joined</th>
        `;
    }

    let html = '';
    customers.forEach(cust => {
        // Style based on status
        const statusStyles = {
            'active': 'bg-green-500/20 text-green-400 border-green-500/30',
            'trialing': 'bg-blue-500/20 text-blue-400 border-blue-500/30',
            'past_due': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
            'canceled': 'bg-gray-500/20 text-gray-400 border-gray-500/30',
            'none': 'bg-white/5 text-white/40 border-white/10'
        };
        const badgeClass = statusStyles[cust.subscription_status] || statusStyles['none'];

        html += `
            <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                <td class="p-3">
                    <div class="font-medium text-white">${cust.email}</div>
                    <div class="text-xs text-white/50 font-mono">${cust.stripe_customer_id}</div>
                </td>
                <td class="p-3 text-white/90">${cust.plan_name}</td>
                <td class="p-3">
                    <span class="px-2 py-1 rounded text-xs border ${badgeClass} uppercase tracking-wide">
                        ${cust.subscription_status}
                    </span>
                </td>
                <td class="p-3 text-sm text-white/60">${new Date(cust.created_at).toLocaleDateString()}</td>
            </tr>`;
    });
    
    // Pagination (Same as before)
    if (pagination && pagination.totalPages > 1) {
        html += `
            <tr>
                <td colspan="4" class="p-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-white/50">Page ${pagination.page} of ${pagination.totalPages}</span>
                        <div class="flex gap-2">
                            <button class="btn btn-secondary text-xs py-1 px-3" 
                                ${pagination.page <= 1 ? 'disabled' : ''} 
                                onclick="fetchAndRenderSubscriptions('customers', ${pagination.page - 1})">Prev</button>
                            <button class="btn btn-secondary text-xs py-1 px-3" 
                                ${pagination.page >= pagination.totalPages ? 'disabled' : ''} 
                                onclick="fetchAndRenderSubscriptions('customers', ${pagination.page + 1})">Next</button>
                        </div>
                    </div>
                </td>
            </tr>`;
    }

    tableBody.innerHTML = html;
}

    function setupSubscriptionSubTabLogic() {
    const navButtons = document.querySelectorAll('#subTabsNav .sub-tab-btn');
    const panels = document.querySelectorAll('.sub-panel');

    navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            // 1. Update UI State
            navButtons.forEach(b => {
                b.classList.remove('active', 'border-indigo-400', 'text-white');
                b.classList.add('border-transparent', 'text-white/60');
            });
            btn.classList.add('active', 'border-indigo-400', 'text-white');
            btn.classList.remove('border-transparent', 'text-white/60');

            // 2. Show/Hide Panels
            const targetId = "sub-" + btn.dataset.target;
            panels.forEach(p => {
                p.style.display = (p.id === targetId) ? "block" : "none";
            });

            // 3. Fetch Data for the specific tab
            fetchAndRenderSubscriptions(btn.dataset.target);
        });
    });
}

// Helper for debounce
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

/**
 * Fetches contact data from the SECURE EDGE FUNCTION.
 */
async function fetchAndRenderContacts(page = 1) {
    const container = document.getElementById("contactCardContainer");
    if (!container) return;

    container.innerHTML = `
        <div class="flex items-center justify-center p-20">
            <div class="loading-spinner mr-3"></div>
            <span class="text-white/80">Fetching messages...</span>
        </div>
    `;

    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error("Not logged in.");

        // 1. Get Filters
        const statusTabs = document.getElementById("contactStatusTabs");
        const status = statusTabs ? (statusTabs.dataset.activeStatus || "") : "";
        
        const searchTerm = document.getElementById("contactSearch").value.trim();
        const sortBy = document.getElementById("contactSortBy").value;

        const params = new URLSearchParams({
            page: page,
            limit: 20,
            sortBy: sortBy,
            sortOrder: 'desc'
        });
        if (status) params.append('status', status);
        if (searchTerm) params.append('search', searchTerm);

        const url = `${SUPABASE_URL}/functions/v1/admin-contacts-secure/contacts?${params.toString()}`;

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            }
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to fetch contacts");

        currentContactItems = data.data || []; 
        renderContactsTable(container, data.data, data.pagination); // Call the NEW table renderer

    } catch (error) {
        console.error("Error fetching contacts:", error);
        container.innerHTML = `<div class="p-10 text-center text-red-400">Error: ${error.message}</div>`;
    }
}

/**
 * Renders the contacts as a table (similar to Users tab).
 */
function renderContactsTable(container, contacts, pagination) {
    if (!contacts || contacts.length === 0) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center p-16 text-white/40">
                <div class="text-4xl mb-2"></div>
                <p>No messages found.</p>
            </div>`;
        return;
    }

    let tableHtml = `
        <table class="w-full text-left border-collapse">
            <thead class="bg-white/5 text-xs uppercase text-white/50 font-semibold tracking-wider">
                <tr>
                    <th class="p-4">Date</th>
                    <th class="p-4">From</th>
                    <th class="p-4">Subject</th>
                    <th class="p-4">Status</th>
                    <th class="p-4 w-20">Action</th>
                </tr>
            </thead>
            <tbody class="text-sm divide-y divide-white/5">
    `;

    contacts.forEach(item => {
        const displayName = `${item.first_name || ''} ${item.last_name || ''}`.trim() || 'Unknown';
        const company = item.company_name ? `<div class="text-xs text-white/40 mt-0.5">${item.company_name}</div>` : '';
        
        let statusClass = 'bg-white/10 text-white/60';
        if (item.status === 'New') statusClass = 'bg-green-500/20 text-green-300 border border-green-500/30';
        if (item.status === 'Replied') statusClass = 'bg-blue-500/20 text-blue-300 border border-blue-500/30';
        if (item.status === 'Archived') statusClass = 'bg-white/5 text-white/40 border border-white/10';

        tableHtml += `
            <tr class="user-row group hover:bg-white/5 transition-colors">
                <td class="p-4 text-white/60 whitespace-nowrap">
                    ${new Date(item.created_at).toLocaleDateString()}
                    <div class="text-xs text-white/30">${new Date(item.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                </td>
                <td class="p-4">
                    <div class="font-bold text-white">${displayName}</div>
                    <div class="text-xs text-white/50">${item.email}</div>
                    ${company}
                </td>
                <td class="p-4 font-medium text-white/90">
                    ${item.subject}
                    <div class="text-xs text-white/40 truncate max-w-xs font-normal mt-0.5">${item.message.substring(0, 50)}...</div>
                </td>
                <td class="p-4">
                    <span class="px-2 py-1 rounded text-xs font-bold ${statusClass} uppercase tracking-wide">${item.status}</span>
                </td>
                <td class="p-4">
                    <button class="btn btn-secondary p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity text-xs view-contact-btn" data-id="${item.id}" title="Read Message">
                        
                    </button>
                </td>
            </tr>
        `;
    });

    tableHtml += `</tbody></table>`;

    // Pagination
    if (pagination && pagination.totalPages > 1) {
        tableHtml += `
            <div class="flex justify-between items-center p-4 bg-white/5 border-t border-white/10">
                <span class="text-xs text-white/50">
                    Page ${pagination.page} of ${pagination.totalPages}
                </span>
                <div class="flex gap-2">
                    <button class="btn btn-secondary text-xs py-1 px-3 pagination-btn-contact" ${pagination.page <= 1 ? 'disabled' : ''} data-page="${pagination.page - 1}">
                         Prev
                    </button>
                    <button class="btn btn-secondary text-xs py-1 px-3 pagination-btn-contact" ${pagination.page >= pagination.totalPages ? 'disabled' : ''} data-page="${pagination.page + 1}">
                        Next 
                    </button>
                </div>
            </div>
        `;
    }

    container.innerHTML = tableHtml;

    // Attach View Listeners (Safe approach)
    container.querySelectorAll('.view-contact-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const contactId = e.currentTarget.dataset.id;
            openContactModal(contactId);
        });
    });

    // Attach Pagination Listeners
    container.querySelectorAll('.pagination-btn-contact').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const newPage = parseInt(e.target.dataset.page);
            if(!isNaN(newPage)) fetchAndRenderContacts(newPage);
        });
    });
}

/**
 * Opens the modal for a specific contact message.
 */
function openContactModal(contactId) {
    console.log(`DEBUG: openContactModal() called for ID: ${contactId}`);
    
    const modal = $("contactDetailModal");
    const modalContent = $("contactModalContent");
    if (!modal || !modalContent) return;

    const item = currentContactItems.find(c => c.id == contactId);
    if (!item) {
        alert("Error: Could not find contact data.");
        return;
    }

    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('modal-open'), 10);
    
    const displayName = `${item.first_name || ''} ${item.last_name || ''}`.trim() || 'N/A';

    // --- REPLACED: New Modal HTML with Reply Text Area ---
    modalContent.innerHTML = `
        <div class="modal-header">
            <div class="modal-title-section">
                <h3 class="modal-title">${item.subject || 'Contact Submission'}</h3>
            </div>
            <button class="modal-close-btn" id="modalCloseContactBtn">&times;</button>
        </div>
        
        <div class="modal-body" style="max-height: 80vh; padding: 1.5rem 1.5rem 3.5rem;">
            <div class="modal-tags">
                <span class="feedback-tag ${item.status === 'New' ? 'tag-status-open' : 'tag-status-resolved'}">${item.status}</span>
                ${item.company_name ? `<span class="feedback-tag tag-type">${item.company_name}</span>` : ''}
            </div>
            
            <div class="modal-content-section" style="margin-bottom: 1.25rem;">
                <h4 class="modal-section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Message Content</h4>
                <div class="modal-feedback-content" style="font-size: 0.9rem; padding: 1rem;">
                    ${item.message}
                </div>
            </div>
            
            <div class="modal-info-grid" style="margin-bottom: 1.5rem;">
                <div class="modal-info-card" style="padding: 0.75rem 1rem;">
                    <h5 class="modal-info-label" style="font-size: 0.7rem; margin-bottom: 0.25rem;">From</h5>
                    <div class="modal-info-value" style="font-size: 0.875rem;">${displayName}</div>
                    <div class="modal-info-sub" style="font-size: 0.7rem; overflow-wrap: break-word;">${item.email}</div>
                </div>
                <div class="modal-info-card" style="padding: 0.75rem 1rem;">
                    <h5 class="modal-info-label" style="font-size: 0.7rem; margin-bottom: 0.25rem;">Submitted</h5>
                    <div class="modal-info-value" style="font-size: 0.875rem;">${new Date(item.created_at).toLocaleDateString()}</div>
                    <div class="modal-info-sub" style="font-size: 0.7rem;">${new Date(item.created_at).toLocaleTimeString()}</div>
                </div>
                <div class="modal-info-card" style="padding: 0.75rem 1rem;">
                    <h5 class="modal-info-label" style="font-size: 0.7rem; margin-bottom: 0.25rem;">Status</h5>
                    <div class="modal-info-value" style="font-size: 0.875rem;">${item.status}</div>
                </div>
            </div>

            <div class="modal-status-section" style="margin-bottom: 1.25rem; border-top: 1px solid rgba(255,255,255,0.1); paddingTop: 1rem;">
                <h4 class="modal-section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Send Reply</h4>
                <textarea id="adminReplyMessage" class="modal-textarea" style="min-height: 120px;" placeholder="Type your reply here..."></textarea>
                <div class="flex justify-end">
                    <button id="sendReplyBtn" class="btn btn-primary py-2 px-4 text-sm">
                        <span id="sendReplyBtnText"> Send Email via Resend</span>
                        <span id="sendReplySpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                </div>
            </div>
            
            <div id="contactModalMessage" class="modal-message" style="display: none;"></div>

            <div class="modal-status-section" style="margin-bottom: 1.25rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                <h4 class="modal-section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Update Status (Internal)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="modal-status-controls w-full">
                        <select id="modalContactStatusSelect" class="modal-select" style="padding: 0.75rem 1rem;">
                            <option value="New" ${item.status === 'New' ? 'selected' : ''}>Mark as New</option>
                            <option value="Replied" ${item.status === 'Replied' ? 'selected' : ''}>Mark as Replied</option>
                            <option value="Archived" ${item.status === 'Archived' ? 'selected' : ''}>Mark as Archived</option>
                        </select>
                        <button id="modalUpdateContactBtn" class="modal-btn modal-btn-secondary" style="padding: 0.75rem 1.25rem; font-size: 0.9rem;">Update</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Attach event listeners
    setTimeout(() => {
        const closeBtn = $("modalCloseContactBtn");
        const updateBtn = $("modalUpdateContactBtn");
        const sendReplyBtn = $("sendReplyBtn");
        
        if (closeBtn) closeBtn.onclick = closeContactModal;
        
        if (updateBtn) {
            updateBtn.onclick = () => {
                const statusSelect = $("modalContactStatusSelect");
                const newStatus = statusSelect ? statusSelect.value : 'New';
                handleUpdateContactStatus(item.id, newStatus, null); // Don't close immediately on status update
            };
        }

        // --- NEW: Handle Send Reply ---
        if (sendReplyBtn) {
            sendReplyBtn.onclick = async () => {
                const replyMessage = $("adminReplyMessage").value.trim();
                const messageEl = $("contactModalMessage");
                const btnText = $("sendReplyBtnText");
                const spinner = $("sendReplySpinner");

                if (!replyMessage) {
                    showContactModalMessage("Please enter a reply message.", "error");
                    return;
                }

                // UI Loading State
                sendReplyBtn.disabled = true;
                btnText.textContent = "Sending...";
                spinner.classList.remove("hidden");

                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) throw new Error("Not logged in");

                    // Call the new Edge Function
                    const response = await fetch('https://supabase.sageaios.com/functions/v1/admin-contacts-email-secure', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            to: item.email,
                            message: replyMessage,
                            original_subject: item.subject
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) throw new Error(result.error || "Failed to send email.");

                    // Success!
                    showContactModalMessage("Email sent successfully!", "success");
                    $("adminReplyMessage").value = ""; // Clear textarea
                    
                    // Auto-update status to "Replied"
                    await handleUpdateContactStatus(item.id, 'Replied', null);
                    
                    // Update the dropdown visually to match
                    const statusSelect = $("modalContactStatusSelect");
                    if(statusSelect) statusSelect.value = "Replied";

                } catch (error) {
                    console.error("Send Reply Error:", error);
                    showContactModalMessage(error.message, "error");
                } finally {
                    sendReplyBtn.disabled = false;
                    btnText.textContent = " Send Email via Resend";
                    spinner.classList.add("hidden");
                }
            };
        }
    }, 100);
}

/**
 * Closes the contact modal.
 */
function closeContactModal() {
    const modal = $("contactDetailModal");
    if (modal) {
        modal.classList.remove('modal-open');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

/**
 * Handles updating the status of a contact item via the SECURE EDGE FUNCTION.
 */
async function handleUpdateContactStatus(contactId, newStatus, closeCallback) {
    console.log(`DEBUG: handleUpdateContactStatus() called. ID: ${contactId}, New Status: ${newStatus}`); 
    const updateBtn = $("modalUpdateContactBtn");
    
    if(updateBtn) updateBtn.disabled = true;
    showContactModalMessage("Updating...", "success");
    
    try {
        // 1. Get session token
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) throw sessionError;
        if (!session) throw new Error("Not logged in");

        // 2. Call the secure Edge Function
        const url = `${SUPABASE_URL}/functions/v1/admin-contacts-secure/contacts/${contactId}`;
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || "Failed to update status");
        }
            
        console.log("DEBUG: Contact update success:", data.data); 
        showContactModalMessage(`Status updated to "${newStatus}"!`, "success");
        
        // 3. Refresh the main contact list from the server
        await fetchAndRenderContacts(1); // Go back to page 1
        
        if (closeCallback) {
            setTimeout(closeCallback, 1500);
        }

    } catch (error) {
        console.error("Error updating contact status:", error);
        showContactModalMessage(error.message, "error");
    } finally {
        if(updateBtn) updateBtn.disabled = false;
    }
}

/**
 * Shows messages in the contact modal.
 */
function showContactModalMessage(message, type) {
    const messageEl = $("contactModalMessage");
    if (messageEl) {
        messageEl.style.display = "block";
        messageEl.className = `modal-message ${type === "error" ? "modal-message-error" : "modal-message-success"}`;
        messageEl.textContent = message;
        
        setTimeout(() => {
            messageEl.style.display = "none";
        }, 3000);
    }
}

// Global click handler to close contact modal
document.addEventListener('click', (e) => {
    const modal = $("contactDetailModal");
    if (modal && e.target === modal) {
        closeContactModal();
    }
});

// Global escape key handler for contact modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const modal = $("contactDetailModal");
        if (modal && modal.style.display === 'flex') {
            closeContactModal();
        }
    }
});

    // --- Admin Dashboard Stats Logic ---
    const refreshStatsBtn = $("refreshStatsBtn");
    if (refreshStatsBtn) {
        refreshStatsBtn.addEventListener("click", fetchAndDisplayStatistics);
    }

    async function fetchAndDisplayStatistics() {
        if (!userLoggedIn) {
            showMessage("statsMessage", "You must be logged in to refresh statistics.", "error");
            return;
        }

        const btn = $("refreshStatsBtn");
        const textEl = $("refreshStatsBtnText");
        const spinner = $("refreshStatsSpinner");

        btn.disabled = true;
        spinner.classList.remove("hidden");
        textEl.textContent = "Loading...";
        showMessage("statsMessage", "", "success");

        try {
            const { data, error } = await supabase.functions.invoke("statistics", {
                body: { update: true }
            });

            if (error) {
                throw error;
            }

            if (data && data.success) {
                const dbStatus = data.database_status;
                if (dbStatus) {
                    $("statTotalUsers").textContent = dbStatus.total_users ?? "N/A";
                    $("statActiveUsers").textContent = dbStatus.log_in_users ?? "N/A";
                    $("statTotalQueries").textContent = dbStatus.total_queries ?? "N/A";
                    $("dashQueryCount").textContent = dbStatus.total_queries ?? "0";
                    $("statDbSize").textContent = dbStatus.database_size ?? "N/A";
                    $("statAvgTime").textContent = dbStatus.avg_p_time
                        ? parseFloat(dbStatus.avg_p_time).toFixed(2) + " ms"
                        : "N/A";
                    $("statRecordedAt").textContent = dbStatus.recorded_at
                        ? new Date(dbStatus.recorded_at).toLocaleString()
                        : "N/A";
                }

                const pineconeStatus = data.pinecone_status;
                const pineconeContainer = $("pineconeStatsContainer");
                if (pineconeStatus && pineconeStatus.status) {
                    pineconeContainer.classList.remove("hidden");
                    $("statPineconeName").textContent = pineconeStatus.name ?? "N/A";
                    $("statTotalVectors").textContent = pineconeStatus.total_vectors ?? "N/A";
                    $("statBookVectors").textContent = pineconeStatus.book_namespace_vectors ?? "N/A";
                    $("statPineconeDimension").textContent = pineconeStatus.dimension ?? "N/A";
                    $("statPineconeStatus").textContent = pineconeStatus.status ?? "N/A";
                    $("statPineconeCloud").textContent =
                        `${pineconeStatus.cloud_provider ?? ""} (${pineconeStatus.region ?? ""})`;
                } else {
                    pineconeContainer.classList.add("hidden");
                }
                showMessage("statsMessage", "Statistics updated successfully!", "success");
            } else {
                throw new Error(data.error || "Failed to fetch statistics.");
            }
        } catch (error) {
            console.error("Error fetching statistics:", error);
            showMessage("statsMessage", `Error: ${error.message}`, "error");
        } finally {
            btn.disabled = false;
            spinner.classList.add("hidden");
            textEl.textContent = "Refresh Stats";
        }
    }

async function handleContactSubmit() {
    // 1. Gather Inputs (IDs are from lines 62-65 in the HTML snippet)
    const firstName = $("contactFirstName").value.trim();
    const lastName = $("contactLastName").value.trim();
    const companyName = $("contactCompanyName").value.trim();
    const email = $("contactEmail").value.trim();
    const phone = $("contactPhone").value.trim();
    const subject = $("contactSubject").value.trim();
    const message = $("contactMessage").value.trim();
    const messageResultEl = $("contactMessageResult");

    // Basic client-side validation (matching Edge Function requirements)
    if (!firstName || !lastName || !email || !subject || !message || message.length < 5) {
        showMessage("contactMessageResult", "Please fill in all required fields, and ensure the message is at least 5 characters long.", "error");
        messageResultEl.classList.remove("hidden");
        return;
    }

    // 2. Set loading state
    setLoading("contactSubmit", true);
    messageResultEl.classList.add("hidden");

    try {
        // 3. Prepare JSON payload
        const payload = {
            first_name: firstName,
            last_name: lastName,
            company_name: companyName, // Passes null/empty string if not provided
            email: email,
            phone: phone, // Passes null/empty string if not provided
            subject: subject,
            message: message
        };

        // 4. Call the Supabase Edge Function via HTTP POST
        // Note: The function name here must match the deployed function endpoint
        const FUNCTION_ENDPOINT = "https://supabase.data2int.com/functions/v1/insert-contact"; 
        
        const response = await fetch(FUNCTION_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // API Key/Authorization is generally not needed if the function is public,
                // but the service role key is used internally by the function itself.
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        // 5. Handle response (2xx success vs. 4xx/5xx error)
        if (!response.ok) {
            // Error details from the Edge Function's own error response
            throw new Error(data.details || data.error || `HTTP Error ${response.status}`);
        }

        // Success: Clear form and show message
        $("contactFirstName").value = "";
        $("contactLastName").value = "";
        $("contactCompanyName").value = "";
        $("contactEmail").value = "";
        $("contactPhone").value = "";
        $("contactSubject").value = "";
        $("contactMessage").value = "";
        
        showMessage("contactMessageResult", "Thank you! Your message has been sent to the admin team.", "success");
        messageResultEl.classList.remove("hidden");

    } catch (e) {
        // Display detailed error message from the try block
        console.error("Contact submission failed:", e);
        showMessage("contactMessageResult", `Submission failed: ${e.message}`, "error");
        messageResultEl.classList.remove("hidden");
    } finally {
        setLoading("contactSubmit", false);
    }
}

   // --- Home Page Card & Tab Logic (Enhanced) ---
    function setupHomeTabs() {
        const tabsNav = document.getElementById("homeTabsNav");
        const contentContainer = document.getElementById("homeTabsContent");
        if (!tabsNav || !contentContainer) return;

        const tabBtns = tabsNav.querySelectorAll(".home-tab-btn");
        const tabPanels = contentContainer.querySelectorAll(".home-tab-panel");

        // 1. Initial State: Ensure the active tab is visible
        tabPanels.forEach((panel) => {
            if (panel.classList.contains("active")) {
                panel.style.display = "grid";
                // Force reflow to apply initial state
                requestAnimationFrame(() => {
                    panel.classList.add("active-anim");
                });
            } else {
                panel.style.display = "none";
                panel.classList.remove("active-anim");
            }
        });

        // 2. Click Listener
        tabsNav.addEventListener("click", (e) => {
            const btn = e.target.closest(".home-tab-btn");
            if (!btn) return;
            
            const targetTabId = btn.dataset.tab;

            // A. Update Buttons (Trigger CSS Sliding Glow)
            tabBtns.forEach((b) => b.classList.toggle("active", b.dataset.tab === targetTabId));

            // B. Switch Panels with Animation
            tabPanels.forEach((panel) => {
                if (panel.id === targetTabId) {
                    // 1. Make it visible in the DOM (but transparent due to CSS)
                    panel.classList.add("active");
                    panel.style.display = "grid";
                    
                    // 2. Trigger Reflow/Animation Frame to start the transition
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            panel.classList.add("active-anim"); // Triggers opacity: 1, translateY: 0
                        });
                    });
                    
                    // 3. Re-trigger card animations for a cascading effect
                    const cards = panel.querySelectorAll('.feature-card');
                    if(typeof animateElements === 'function') {
                        // Reset cards slightly so they animate in again
                        cards.forEach(c => { c.style.opacity = '0'; c.style.transform = 'translateY(20px)'; });
                        animateElements(cards);
                    }

                } else {
                    // Hide others immediately to prevent layout jumping
                    panel.classList.remove("active", "active-anim");
                    panel.style.display = "none"; 
                }
            });
        });
    }

    // ============================================================
    // 1. PAYMENT MODAL LOGIC (Defines the modal behavior)
    // ============================================================
    async function openStripePlanModal() {
        console.log(">>> Opening Stripe Payment Modal...");
        const modal = document.getElementById("stripePaymentModal");
        if (!modal) {
            console.error(" Error: stripePaymentModal element not found in DOM.");
            return;
        }

        // Show Modal Immediately
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('modal-open'), 10);

        // Populate Plans
        const gridContainer = modal.querySelector('.grid');
        
        // Validation Check to prevent the syntax error
        if (!gridContainer) {
            console.error(" Error: Grid container not found in modal.");
            return;
        }

        // Reset Content
        gridContainer.innerHTML = `<div class="col-span-full text-center text-white/50 py-12"><div class="loading-spinner mb-2"></div><p>Loading latest plans...</p></div>`;

        try {
            const { data: plans, error } = await supabase
                .from('stripe_plans')
                .select('*')
                .eq('active', true)
                .order('price', { ascending: true });

            if (error) throw error;

            if (!plans || plans.length === 0) {
                gridContainer.innerHTML = `<div class="col-span-full text-center text-white/60">No plans available.</div>`;
                return;
            }

            const cardsHtml = plans.map(plan => {
                const priceDisplay = (plan.price / 100).toFixed(0);
                let cardClasses = "bg-white/5 border border-white/10 hover:border-purple-400 transition-all duration-300 hover:-translate-y-2";
                let btnClass = "btn-secondary border-purple-500/50 hover:bg-purple-500/20";
                let icon = "";
                let popularBadge = "";

                if (plan.name.toLowerCase().includes('business') || plan.is_popular) {
                    cardClasses = "bg-gradient-to-b from-blue-900/40 to-white/5 border-2 border-blue-500/50 hover:border-blue-400 transform scale-105 shadow-xl z-10 transition-all duration-300 hover:-translate-y-2";
                    btnClass = "btn-primary shadow-lg";
                    icon = "";
                    popularBadge = `<div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg uppercase tracking-wide">Most Popular</div>`;
                } else if (plan.name.toLowerCase().includes('enterprise')) {
                    cardClasses = "bg-white/5 border border-white/10 hover:border-yellow-400 transition-all duration-300 hover:-translate-y-2";
                    btnClass = "btn-secondary border-yellow-500/50 hover:bg-yellow-500/20";
                    icon = "";
                }

                // Smart Link Logic
                let targetUrl = '#';
                if (plan.payment_link && currentUser && currentUser.id) {
                    try {
                        const url = new URL(plan.payment_link);
                        url.searchParams.set('client_reference_id', currentUser.id);
                        if (currentUser.email) url.searchParams.set('prefilled_email', currentUser.email);
                        targetUrl = url.toString();
                    } catch (e) { console.error("Invalid link:", plan.payment_link); }
                }

                const featuresHtml = (plan.features || []).map(f => 
                    `<li class="flex items-center"><span class="text-green-400 mr-2"></span> ${f.replace(/^"|"$/g, '')}</li>`
                ).join('');

                return `
                    <div class="${cardClasses} flex flex-col relative group p-6 rounded-xl">
                        ${popularBadge}
                        <div class="text-center mb-4 ${popularBadge ? 'mt-2' : ''}">
                            <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-3 transition-colors">
                                <span class="text-2xl">${icon}</span>
                            </div>
                            <h3 class="text-xl font-bold text-white">${plan.name}</h3>
                            <p class="text-white/60 text-sm mt-1">${plan.description || 'Unlock features'}</p>
                        </div>
                        <div class="text-center mb-6">
                            <span class="text-3xl font-bold text-white">$${priceDisplay}</span>
                            <span class="text-white/50">/mo</span>
                        </div>
                        <ul class="text-sm text-white/70 space-y-2 mb-6 flex-grow text-left pl-2">
                            ${featuresHtml}
                        </ul>
                        <a href="${targetUrl}" target="_blank" class="btn ${btnClass} w-full py-2 text-center justify-center">
                             Select ${plan.name}
                        </a>
                    </div>
                `;
            }).join('');

            gridContainer.innerHTML = cardsHtml;

        } catch (err) {
            console.error("Error rendering modal plans:", err);
            gridContainer.innerHTML = `<div class="col-span-full text-center text-red-400">Failed to load plans.</div>`;
        }
    }

    // ============================================================
    // 2. CLICK LISTENER LOGIC (Controls access to tools)
    // ============================================================
    function attachHomeCardListeners() {
        const cards = document.querySelectorAll(".home-template-link");

        cards.forEach((card) => {
            // Clone to remove old listeners
            const newCard = card.cloneNode(true);
            card.parentNode.replaceChild(newCard, card);
            
            newCard.addEventListener("click", () => {
                const templateId = newCard.dataset.templateId;
                preFillData = newCard.dataset.preFill || "";

                // Auth Check
                if (!userLoggedIn) {
                    showMessage("loginMessage", "Please log in to use the analysis tools.", "error");
                    navigateTo("login");
                    return;
                }

                // --- PREMIUM CHECK ---
                // Uses the global 'currentUserTier' variable set by checkUserTierFromDB
                const isPrivileged = 
                    currentUserTier === 'premium' || 
                    currentUserTier === 'admin';

                if (isPrivileged) {
                    console.log(`User is ${currentUserTier}. Bypassing version modal.`);
                    currentSelectionLimit = 3; 
                    selectedTemplateForModal = templateId; 
                    showTemplateDetail(templateId); // Go straight to tool
                    return; 
                }

                // --- BASIC USER FLOW ---
                selectedTemplateForModal = templateId;                    
                const modal = $("versionChoiceModal");
                if (modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => modal.classList.add('modal-open'), 10);
                }
            });
        });

        // --- Modal Button Listeners ---

        const selectFreeBtn = $("selectFreeVersion");
        if (selectFreeBtn) {
            selectFreeBtn.onclick = () => {
                currentSelectionLimit = 1; 
                proceedFromModal();      
            };
        }

        const selectPaidBtn = $("selectPaidVersion");
        if (selectPaidBtn) {
            selectPaidBtn.onclick = () => {
                const choiceModal = $("versionChoiceModal");
                choiceModal.classList.remove('modal-open');
                
                setTimeout(() => {
                    choiceModal.style.display = 'none';
                    
                    // Double Check Logic
                    const isPrivileged = 
                        currentUserTier === 'premium' || 
                        currentUserTier === 'admin';

                    if (isPrivileged) {
                        console.log("User is Premium. Bypassing payment.");
                        currentSelectionLimit = 3; 
                        proceedFromModal();      
                    } else {
                        console.log("User is Basic. Triggering Payment Modal.");
                        openStripePlanModal(); // Calls the function defined above
                    }
                }, 300);
            };
        }
    }

/**
 * Helper to toggle loading state on the Pay button
 */
function setPaymentLoading(isLoading) {
    const btn = document.getElementById("submitPaymentBtn");
    const spinner = document.getElementById("paySpinner");
    const text = document.getElementById("payBtnText");
    
    if (!btn || !spinner || !text) return;

    btn.disabled = isLoading;
    if (isLoading) {
        spinner.classList.remove("hidden");
        text.textContent = "Processing...";
    } else {
        spinner.classList.add("hidden");
        text.textContent = "Pay Now";
    }
}

// Logic to Close the Plan Selection Modal
const closeStripeBtn = document.getElementById("closeStripeModalBtn");
if (closeStripeBtn) {
    closeStripeBtn.onclick = () => {
        const modal = document.getElementById("stripePaymentModal");
        modal.classList.remove('modal-open');
        setTimeout(() => {
            modal.style.display = 'none';
            modal.classList.add('hidden');
        }, 300);
    };
}

    function proceedFromModal() {
        // --- MODIFIED LINES ---
        const modal = $("versionChoiceModal");
        modal.classList.remove('modal-open'); // Start fade-out
        setTimeout(() => modal.style.display = 'none', 300); // Hide after animation
        // --- END MODIFICATION ---
        if (selectedTemplateForModal) {
            showTemplateDetail(selectedTemplateForModal);
        }
    }

    // --- Template Detail Page Logic ---

    // Helper function to reattach action listeners (you may already have this)
    function reattachActionListeners() {
        // Add your existing save PDF/DOCX functionality here
        const savePdfBtn = document.getElementById("savePdfBtn");
        const saveDocxBtn = document.getElementById("saveDocxBtn");
        
        if (savePdfBtn) {
            savePdfBtn.addEventListener("click", () => {
                // Your existing PDF save functionality
                console.log("Saving as PDF...");
            });
        }
        
        if (saveDocxBtn) {
            saveDocxBtn.addEventListener("click", () => {
                // Your existing DOCX save functionality
                console.log("Saving as DOCX...");
            });
        }
    }

    function reattachTabListeners(container) {
        const tabNav = container.querySelector(".flex.border-b");
        const tabContent = container.querySelector("div:not(.flex)");
        if (tabNav && tabContent) {
            tabNav.addEventListener("click", (e) => {
                if (e.target.tagName === "BUTTON") {
                    tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                    tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                    e.target.classList.add("active");
                    const targetPanelId = e.target.dataset.tab + "Panel";
                    const targetPanel = $(targetPanelId);
                    if (targetPanel) {
                        targetPanel.classList.add("active");
                        const chart = targetPanel.querySelector(".plotly-chart");
                        if (chart) {
                            Plotly.Plots.resize(chart);
                        }
                    }
                }
            });
        }
    }

    function showTemplateDetail(templateId) {
        currentTemplateId = templateId;
        const rule = templateRules[templateId] || {};

        // Dynamically get template info from the clicked card if not in the predefined list
        let template = templates[templateId];
        if (!template) {
            const card = document.querySelector(`.home-template-link[data-template-id="${templateId}"]`);
            if (card) {
                const title = card.querySelector("h3").innerText;
                const descriptionEl = card.querySelector("p");
                const description = descriptionEl
                    ? descriptionEl.innerText
                    : `Generate a detailed analysis for ${title}.`;
                template = { title: title, description: description };
                templates[templateId] = template; // Cache it
            } else {
                // Generic fallback if card isn't found
                template = {
                    title: templateId.replace(/-/g, " ").replace(/\b\w/g, (l) => l.toUpperCase()),
                    description: `Generate a detailed analysis.`
                };
                templates[templateId] = template;
            }
        }

        // Handle special layouts that replace the whole content area
        if (rule.useSwotLayout) {
            createSwotTowsLayout(template);
        } else if (rule.useArchetypeLayout) {
            createArchetypeAnalysisLayout(template);
        } else if (rule.useThinkingSystemLayout_NS) {
            // <-- ADD THIS BLOCK
            createThinkingSystemLayout_NS(template);
        } else if (rule.useLivingSystemLayout_NS) {
            // <-- ADD THIS BLOCK
            createLivingSystemLayout_NS(template);
        } else if (rule.useVisualizationLayout_DA) {
            // <-- ADD THIS BLOCK
            createVisualizationLayout_DA(template);
        } else if (currentTemplateId === "all-framework") {
            createAllFrameworkLayout(template);
        // ---  END OF NEW BLOCK  ---

        } else if (currentTemplateId === "mission-vision") {
            createMissionVisionLayout(template);
        } else if (rule.useSystemObjectivesLayout_ST) {
            // <-- ADD THIS BLOCK
            createSystemObjectivesLayout_ST(template);
        } else if (currentTemplateId === "objectives") {
            createObjectivesLayout(template);
        // ---  END OF NEW BLOCK  ---
        } else if (rule.useCreativeDissonanceLayout_NS) {
            // <-- ADD THIS BLOCK
            createCreativeDissonanceLayout_NS(template);
        } else if (rule.useSystemActionsLayout_ST) {
            // <-- ADD THIS BLOCK
            createSystemActionsLayout_ST(template);
        } else if (rule.usePrescriptiveLayout_DA) {
            // <-- ADD THIS BLOCK
            createPrescriptiveLayout_DA(template);
        } else if (rule.usePlsLayout_DA) {
            // <-- ADD THIS BLOCK
            createPlsLayout_DA(template);
        } else if (rule.useDescriptiveLayout_DA) {
            // <-- ADD THIS BLOCK
            createDescriptiveLayout_DA(template);
        } else if (rule.useFactorAnalysisLayout) {
            createFactorAnalysisLayout(template);
        } else if (rule.useSemAnalysisLayout) {
            // <-- ADD THIS BLOCK
            createSemAnalysisLayout(template);
        } else if (rule.useActionPlansLayout_AP) {
            createActionPlansLayout_AP(template);
        } else if (rule.useLeveragePointsLayout) {
            createLeveragePointsLayout(template);
        } else if (rule.useMiscLayout_MSC) {
            createMiscLayout_MSC(template);
        } else if (rule.useNovelGoalsLayout_NS) {
            // <-- ADD THIS BLOCK
            createNovelGoalsLayout_NS(template);
        } else if (rule.useKpiLayout_KE) {
            createKpiLayout_KE(template);
        } else if (rule.useGoalsAndInitiativesLayout_SP) {
            createGoalsAndInitiativesLayout_SP(template);
        } else if (rule.useRegressionLayout_DA) {
            // <-- ADD THIS BLOCK
            createRegressionLayout_DA(template);
        } else if (rule.useParetoLayout) {
            createParetoLayout(template);
        } else if (rule.useProcessMappingLayout) {
            createProcessMappingLayout(template);
        } else if (rule.useSystemGoalsLayout) {
            createSystemGoalsLayout(template);
        } else if (rule.useSystemThinkingLayout) {
            createSystemThinkingLayout(template);
        } else if (rule.usePredictiveAnalysisLayout) {
            createPredictiveAnalysisLayout(template);
        } else if (rule.useDematelLayout) {
            createDematelLayout(template);
        } else {
            createDefaultLayout(template, rule);
        }

        // --- NEW: Attach "Use Sample" button listeners ---
        document.querySelectorAll(".btn-use-sample").forEach(btn => {
            btn.removeEventListener("click", handleUseSampleClick); // Avoid duplicates
            btn.addEventListener("click", handleUseSampleClick);
        });

        navigateTo("templateDetail");
    }

   function createDefaultLayout(template, rule) {
    const contentContainer = document.getElementById("templateDetailContent");
    contentContainer.className = "grid lg:grid-cols-2 gap-12"; 
    contentContainer.innerHTML = `
                <div>
                    <h1 id="templateTitle" class="text-4xl font-bold mb-4">${template.title}</h1>
                    <p id="templateDescription" class="text-white/80 mb-8">${template.description}</p>
                    <div class="glass-container p-6">
                        <div id="templateFormFields" class="space-y-4"></div>
                        
                        <div id="analysisSectionsContainer" class="glass-container mt-8" style="display: ${rule.hideAnalysisSection ? "none" : "block"}">
                            <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Analysis Sections</h4>
                            <p class="text-white/70 text-center mb-4">Choose the components for your report.</p>
                            <ul id="analysisList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Introduction</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Overview of business</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>process overview</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>mission statement</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision analysis</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision statement 2</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 1</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 2</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 3</span></li>
                            </ul>
                        </div>
                        
                        <div id="methodsConsideredContainer" class="glass-container mt-8" style="display: ${rule.hideFrameworks ? "none" : "block"}">
                            <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Frameworks</h4>
                            <p id="selectionCounter" class="text-white/70 text-center mb-4">Selected: 0 / 3</p>
                            <ul id="frameworkList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Reframing Thinking"><span>Reframing Thinking</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Delphi Method"><span>Delphi Method</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Blue Ocean Strategy"><span>Blue Ocean Strategy</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Design Thinking"><span>Design Thinking</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Thinking Hats"><span>Thinking Hats</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Business Model Canvas"><span>Business Model Canvas</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="SCAMPER"><span>SCAMPER</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="TRIZ (Theory of Inventive Problem Solving)"><span>TRIZ (Theory of Inventive Problem Solving)</span></li>
                            </ul>
                        </div>

                        <button id="generateBtn" class="btn btn-primary w-full mt-4">
                            <span id="generateBtnText">Generate Analysis</span>
                            <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>

                        <div class="text-center mt-4">
                            <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                        </div>
                    </div>
                </div>
                <div>
                    <h2 class="text-3xl font-bold mb-4">Generated Analysis</h2>
                    <div id="analysisResult" class="glass-container min-h-[300px] whitespace-pre-wrap overflow-x-auto">
                    </div>
                    <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                         <button id="savePdfBtn" class="btn btn-secondary">PDF</button>
                         <button id="saveDocxBtn" class="btn btn-secondary">DOCX</button>
                    </div>
                </div>
            `;

    // Populate fields
    populateDefaultFormFields(currentTemplateId);

    // Restore cache if exists
    if (analysisCache[currentTemplateId]) {
        document.getElementById("analysisResult").innerHTML = analysisCache[currentTemplateId];
        document.getElementById("analysisActions").classList.remove("hidden");
        // Re-attach tab listeners if result has tabs
        if (window.reattachTabListeners) window.reattachTabListeners(document.getElementById("analysisResult"));
    } else {
        document.getElementById("analysisResult").innerHTML =
            '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
        document.getElementById("analysisActions").classList.add("hidden");
    }

    // Configure frameworks
    configureFrameworkSelector(currentSelectionLimit);

    // Re-attach generate listener
    document.getElementById("generateBtn").addEventListener("click", handleGenerate);
    
    // Re-attach export listeners
    if (window.reattachActionListeners) window.reattachActionListeners();

    // CRITICAL FIX: Enable the toggle logic for the newly created elements
    setupInputToggle("companyDocumentsFile", "companyDocumentsFileLabel", "defaultTextInputArea", "defaultDocUploadArea");

    // Attach feedback listener
    const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
    if (feedbackLink) {
        feedbackLink.addEventListener("click", (e) => {
            e.preventDefault();
            if (typeof navigateTo === 'function') navigateTo('feedback');
        });
    }
}

    function populateDefaultFormFields(templateId) {
        const templateFormFields = $("templateFormFields");
        templateFormFields.innerHTML = ""; // Clear previous fields

        // For Fishbone/Pareto (Special case kept intact)
        if (templateId === "pareto-fishbone") {
            templateFormFields.innerHTML = `
                <div>
                    <label for="problemStatement" class="block text-sm font-medium text-gray-200 mb-2">Problem Statement</label>
                    <input type="text" id="problemStatement" class="input-field" placeholder="e.g., Low Customer Satisfaction" required>
                </div>`;
            return;
        }

        // Default form for ALL other tools
        // We construct a dynamic placeholder based on the template ID
        let textPlaceholder = "Paste your business context, strategic goals, or problem description here...";
        if(templateId === 'mission-vision') textPlaceholder = "Describe your company, purpose, and aspirations...";
        
        let formHtml = `
            <div>
                <label for="companyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label>
                <input type="text" id="companyName" class="input-field" placeholder="e.g., Innovate Inc." required>
            </div>
            
            <div>
                <label for="location" class="block text-sm font-medium text-gray-200 mb-2">Location</label>
                <input type="text" id="location" class="input-field" placeholder="e.g., Global" required>
            </div>

            <div class="input-radio-group mt-4">
                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                <label for="textInput" class="input-radio-label">Text Input</label>
                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                <label for="docUpload" class="input-radio-label">Document Upload</label>
            </div>

            <div id="defaultTextInputArea" class="mt-4">
                <label for="useCaseContext" class="block text-sm font-medium text-gray-200 mb-2">Context / Description</label>
                <textarea id="useCaseContext" class="input-field h-48" placeholder="${textPlaceholder}"></textarea>
            </div>

            <div id="defaultDocUploadArea" class="hidden mt-4">
                <label for="companyDocumentsFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Company Documents</label>
                <div class="input-file-wrapper">
                    <label for="companyDocumentsFile" id="companyDocumentsFileLabel" class="input-file-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                        <span class="file-name">Click to select a file...</span>
                    </label>
                    <input type="file" id="companyDocumentsFile" class="input-file">
                </div>
            </div>
        `;

        templateFormFields.innerHTML = formHtml;

        // Attach internal file listener immediately for visual feedback
        const fileInput = $("companyDocumentsFile");
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $("companyDocumentsFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                } else {
                    fileNameSpan.textContent = "Click to select a file...";
                    label.classList.remove("has-file");
                }
            });
        }
    }

    function createSystemGoalsLayout(template) {
            const contentContainer = $("templateDetailContent");
            contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Single column layout
            contentContainer.innerHTML = `
                        <div class="lg:col-span-1">
                            <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        
                            <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                                <h3 class="text-xl font-bold mb-4 text-white">System & Goal Description</h3>
                                
                                <div class="mb-2">
                                    <label for="systemGoalsLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                    <input type="text" id="systemGoalsLocation" class="input-field" placeholder="e.g., Corporate HQ, Specific Plant, Global Supply Chain">
                                </div>
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="systemGoalsContent" class="input-field h-48" placeholder="Describe your system, its current state, and what you want to achieve. For example: 'Our software company is growing fast, but customer churn is high. We want to increase customer retention by 30%.'"></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="systemGoalsFile" id="systemGoalsFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .docx or .txt file...</span>
                                        </label>
                                        <input type="file" id="systemGoalsFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Formulate Initiatives</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                                <div class="text-center mt-4">
                                        <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                                </div>
                            </div>
                            
                            <div class="mt-12">
                                <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                                <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                                </div>
                                <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                    <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                    <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                                </div>
                            </div>
                        </div>
                    `;

            // Re-attach all necessary event listeners for the new elements
            setupInputToggle("systemGoalsFile", "systemGoalsFileLabel", "textInputArea", "docUploadArea");

            // Attach listener for the feedback link
            const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
            if (feedbackLink) {
                feedbackLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    if (typeof navigateTo === 'function') {
                        navigateTo('feedback');
                    } else {
                        console.error("navigateTo function is not defined.");
                    }
                });     
            } else {
                console.warn("Feedback link not found inside createSystemGoalsLayout");
            }
        }

    function createGoalsAndInitiativesLayout_SP(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">High-Level Goal or Vision</h3>
                             
                             <div class="mb-2">
                                <label for="goalsLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="goalsLocation" class="input-field" placeholder="e.g., Global, North America, Online, Specific City">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="goalsContent" class="input-field h-48" placeholder="Describe your main business objective or long-term vision. For example: 'Become the #1 provider of eco-friendly cleaning supplies in North America by 2030.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="goalsFile" id="goalsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="goalsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Build Strategic Plan</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("goalsFile", "goalsFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createGoalsAndInitiativesLayout_SP");
        }
    }

    function createActionPlansLayout_AP(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Objective or Initiative to Plan</h3>
                             
                             <div class="mb-2">
                                <label for="actionLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="actionLocation" class="input-field" placeholder="e.g., Global, North America, Online, Specific City">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="actionPlanContent" class="input-field h-48" placeholder="Describe the goal or objective you want to create an action plan for. For example: 'Launch a new mobile application for our e-commerce store within the next 6 months.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="actionPlanFile" id="actionPlanFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="actionPlanFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Create Action Plan</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Generated Action Plan</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("actionPlanFile", "actionPlanFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createActionPlansLayout_AP");
        }
    }

   function createKpiLayout_KE(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Project or Goal Description</h3>
                             
                             <div class="mb-2">
                                <label for="kpiLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="kpiLocation" class="input-field" placeholder="e.g., Global, North America, Online, Specific City">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="kpiContent" class="input-field h-48" placeholder="Describe the project, goal, or strategic initiative you want to track. For example: 'Launch a new customer loyalty program to increase repeat purchase rate.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="kpiFile" id="kpiFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="kpiFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Define KPIs & Events</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Performance Framework</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("kpiFile", "kpiFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createKpiLayout_KE");
        }
    }

    function createNovelGoalsLayout_NS(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe Your Overarching Ambition or Goal</h3>
                             
                             <div class="mb-2">
                                <label for="novelGoalsLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="novelGoalsLocation" class="input-field" placeholder="e.g., Global, Emerging Markets, Silicon Valley">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="novelGoalsContent" class="input-field h-48" placeholder="Provide a high-level, ambitious goal. For example: 'To transition our company from a traditional hardware manufacturer to a leading software-as-a-service provider in the IoT space.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="novelGoalsFile" id="novelGoalsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="novelGoalsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Map Strategic Horizons</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Horizons of Growth Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("novelGoalsFile", "novelGoalsFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createNovelGoalsLayout_NS");
        }
    }

    function createRegressionLayout_DA(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                   <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
      
                   <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-xl font-bold text-white">Analysis Setup</h3>
                                <div class="flex items-center space-x-2">
                                    <button type="button" id="regressionExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                                    
                                    <button type="button" onclick="triggerBackendDownload(\'regression\', \'regression-sample-doc.txt\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .txt</button>
                                    <button type="button" onclick="triggerBackendDownload(\'regression\', \'regression-sample.csv\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .csv</button>
                                    <button type="button" id="useRegressionSampleBtn" class="btn-sample btn-use-sample" data-template-id="regression-analysis"> Use Sample</button>
                                </div>
                            </div>

                            <div id="regressionExamples" class="hidden mb-4 p-3 bg-black/20 border border-white/15 rounded-lg">
                                <div id="regressionExampleContent" class="text-white/80">Loading example...</div>
                            </div>

                             <div class="space-y-4">
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-200 mb-2">Company Context (Optional)</label>
                                    <div class="input-radio-group">
                                        <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                        <label for="textInput" class="input-radio-label">Text Input</label>
                                        <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                        <label for="docUpload" class="input-radio-label">Document Upload</label>
                                    </div>
                                </div>

                                <div id="regressionContextTextArea">
                                    <label for="regressionContextText" class="block text-sm font-medium text-gray-200 mb-2">Paste Context Here</label>
                                    <textarea id="regressionContextText" class="input-field h-32" placeholder="Paste your company context, business plan, or problem description here..."></textarea>
                                </div>
                                
                                <div id="regressionContextFileArea" class="hidden">
                                    <label for="regressionContextFile" class="block text-sm font-medium text-gray-200 mb-2">Company Document (.txt, .docx)</label>
                                    <div class="input-file-wrapper">
                                        <label for="regressionContextFile" id="regressionContextFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select context document...</span>
                                        </label>
                                        <input type="file" id="regressionContextFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <div>
                                    <label for="regressionFile" class="block text-sm font-medium text-gray-200 mb-2" title="Must be a .csv file. All columns for analysis must be numeric. Ensure no spaces in headers (e.g., use 'Marketing_Spend').">
                                        Upload Data File (.csv)
                                    </label>
                                    <div class="input-file-wrapper">
                                        <label for="regressionFile" id="regressionFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv data file...</span>
                                        </label>
                                        <input type="file" id="regressionFile" class="input-file" accept=".csv">
                                    </div>
                                    <div id="regressionFileError" class="text-red-400 text-sm mt-2"></div>
                                    <div id="regressionDataWarning" class="text-yellow-400 text-sm mt-2"></div>
                                </div>

                                <div id="regressionDataPreview" class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-200">Data Preview (First 5 Rows)</label>
                                    <div class="overflow-x-auto rounded-lg border border-white/20">
                                        <table class="min-w-full text-left text-sm text-white/90" id="regressionPreviewTable">
                                            <tbody>
                                                <tr>
                                                    <td class="p-4 text-center text-white/60" colspan="100%">Upload a .csv file to see a preview.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div>
                                    <label for="dependentVar" class="block text-sm font-medium text-gray-200 mb-2" title="This is the 'outcome' variable you want to predict (e.g., 'Sales'). It must be numeric.">
                                        Dependent Variable (Y)
                                    </label>
                                    <div class="select-wrapper">
                                        <select id="dependentVar" class="input-field" disabled>
                                            <option value="">-- Upload data to see variables --</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-200 mb-2" title="These are the 'predictor' variables you think influence your outcome (e.g., 'Marketing_Spend', 'Website_Traffic'). They must be numeric.">
                                        Independent Variables (X)
                                    </label>
                                    <div id="independentVarsContainer" class="max-h-40 overflow-y-auto space-y-1 p-3 bg-black/20 rounded-lg border border-white/20">
                                        <p class="text-sm text-white/60 text-center">-- Upload data to see variables --</p>
                                    </div>
                                </div>

                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                 <span id="generateBtnText"> Run Regression Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Regression Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

        // --- All Helper Functions are LOCAL to this function ---

        const getHeadersFromText = (text) => {
            if (!text || typeof text !== 'string' || !text.trim()) throw new Error("Input text is empty.");
            const firstLine = text.split(/[\r\n]+/)[0];
            if (!firstLine || !firstLine.trim()) throw new Error("First line (header) is empty.");

            let headers = firstLine.split(',').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length <= 1) headers = firstLine.split(';').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length <= 1) headers = firstLine.split('\t').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length === 0) throw new Error("Could not parse headers (tried comma, semicolon, tab).");
            return headers;
        };
        
        const showDataPreview = (csvText, tableId, containerId) => {
            const previewContainer = $(containerId);
            const previewTable = $(tableId);
            if (!previewContainer || !previewTable) return;

            try {
                const lines = csvText.split(/[\r\n]+/).filter(Boolean); 
                const rows = lines.slice(0, 6); 
                
                if (rows.length < 2) { 
                    previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Data file is empty or has no data rows.</td></tr></tbody>';
                    previewContainer.classList.remove("hidden"); 
                    return; 
                }

                const headers = getHeadersFromText(rows[0]);
                let tableHTML = '<thead class="bg-white/10 text-xs uppercase"><tr>';
                headers.forEach(h => { tableHTML += `<th scope="col" class="px-4 py-2">${h}</th>`; });
                tableHTML += '</tr></thead><tbody>';

                rows.slice(1).forEach((line, rowIndex) => {
                    let cells = line.split(',');
                    if (cells.length !== headers.length) cells = line.split(';');
                    if (cells.length !== headers.length) cells = line.split('\t');

                    tableHTML += `<tr class="border-t border-white/10 ${rowIndex % 2 === 0 ? 'bg-white/5' : ''}">`;
                    headers.forEach((_, cellIndex) => {
                        tableHTML += `<td class="px-4 py-2">${cells[cellIndex] === undefined ? '' : cells[cellIndex]}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody>';
                previewTable.innerHTML = tableHTML;
                previewContainer.classList.remove("hidden");
            } catch (e) {
                console.error("Error showing data preview:", e);
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-red-400" colspan="100%">Error reading data preview.</td></tr></tbody>';
                previewContainer.classList.remove("hidden");
            }
        };

        const updateRegressionVariables = (headers) => {
            const dependentSelect = $("dependentVar");
            const independentContainer = $("independentVarsContainer");
            const errorEl = $("regressionFileError"); // Get the error element
            if (!dependentSelect || !independentContainer || !errorEl) return;

            dependentSelect.innerHTML = ''; 
            independentContainer.innerHTML = ''; 
            errorEl.textContent = ""; // Clear errors

            let dependentFound = false;
            const excludePatterns = ['id', 'date', 'time', 'timestamp', 'index', 'row'];
            
            headers.forEach((header, index) => {
                const option = new Option(header, header);
                dependentSelect.add(option);

                const checkboxHtml = `
                     <label class="flex items-center space-x-2 text-sm text-white/90 p-1.5 rounded hover:bg-white/10">
                        <input type="checkbox" class="method-checkbox independent-var-checkbox" value="${header}">
                        <span>${header}</span>
                    </label>`;
                independentContainer.innerHTML += checkboxHtml;

                if (!dependentFound && !excludePatterns.some(pattern => header.toLowerCase().includes(pattern))) {
                    dependentSelect.value = header;
                    dependentFound = true;
                }
            });

            if (!dependentFound && headers.length > 0) {
                 dependentSelect.value = headers[0];
            }

            const allCheckboxes = independentContainer.querySelectorAll('.independent-var-checkbox');

            const syncCheckboxes = () => {
                const selectedDependent = dependentSelect.value;
                errorEl.textContent = ""; // Clear any previous errors on change

                allCheckboxes.forEach(cb => {
                    if (cb.value === selectedDependent) {
                        cb.checked = false;
                        cb.disabled = true;
                    } else {
                        cb.disabled = false;
                    }
                });
                independentContainer.dispatchEvent(new Event('change'));
            };
            
            const initialSelectedDependent = dependentSelect.value;
            allCheckboxes.forEach(cb => {
                if (cb.value === initialSelectedDependent) {
                    cb.checked = false;
                    cb.disabled = true;
                } else if (!excludePatterns.some(pattern => cb.value.toLowerCase().includes(pattern))) {
                    cb.checked = true;
                } else {
                    cb.checked = false; 
                }
            });

            dependentSelect.removeEventListener('change', syncCheckboxes); 
            dependentSelect.addEventListener('change', syncCheckboxes);

            independentContainer.removeEventListener('change', handleIndepChange); 
            independentContainer.addEventListener('change', handleIndepChange);
            
            function handleIndepChange(e) {
                if (e.target.matches('.independent-var-checkbox') || e.type === 'change') {
                    
                    const warningEl = $("regressionDataWarning");
                    if (warningEl) warningEl.textContent = "";

                    const numFeatures = independentContainer.querySelectorAll('.independent-var-checkbox:checked').length;
                    const numObservations = currentRegressionRowCount;
                    
                    if (numFeatures === 0) {
                        errorEl.textContent = ""; 
                        return;
                    }

                    const ratio = numObservations / numFeatures;

                    if (numObservations >= 30 && ratio < 10) {
                         errorEl.textContent = `Warning: Data ratio is low (${ratio.toFixed(1)}-to-1). A 10-to-1 ratio (or ${numFeatures * 10} rows) is recommended.`;
                         errorEl.className = "text-yellow-400 text-sm mt-2"; 
                    } else if (numObservations < 30) {
                         errorEl.textContent = `Warning: Insufficient data (${numObservations} rows). 30+ recommended.`;
                         errorEl.className = "text-yellow-400 text-sm mt-2";
                    } else {
                         errorEl.textContent = ""; 
                         errorEl.className = "text-red-400 text-sm mt-2"; 
                    }
                }
            }
            
            dependentSelect.disabled = false;
            independentContainer.dispatchEvent(new Event('change'));
        };


        const processDataInput_Regression = async (file) => {
            const errorEl = $("regressionFileError");
            const warningEl = $("regressionDataWarning"); 
            const dependentSelect = $("dependentVar");
            const independentContainer = $("independentVarsContainer");
            const previewContainer = $("regressionDataPreview");
            const previewTable = $("regressionPreviewTable");
            
            errorEl.textContent = ""; 
            if (warningEl) warningEl.textContent = ""; 

            dependentSelect.disabled = true;
            dependentSelect.innerHTML = '<option value="">-- Processing data... --</option>';
            independentContainer.innerHTML = "";
            
            previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Processing data...</td></tr></tbody>';
            previewContainer.classList.remove("hidden");

            currentRegressionRowCount = 0; 
            
            if (!file) {
                 dependentSelect.innerHTML = '<option value="">-- Upload data file --</option>';
                 independentContainer.innerHTML = '<p class="text-sm text-white/60 text-center">-- Upload data file --</p>';
                 previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Upload a .csv file to see a preview.</td></tr></tbody>';
                 return;
            }

            try {
                const textContent = await extractTextFromFile(file); 
                const originalHeaders = getHeadersFromText(textContent);

                const lines = textContent.split(/[\r\n]+/).filter(Boolean);
                
                currentRegressionRowCount = lines.length - 1; 

                if (currentRegressionRowCount < 10) { 
                    errorEl.textContent = "Warning: Small dataset (<10 rows). Regression will be unreliable.";
                    errorEl.className = "text-yellow-400 text-sm mt-2"; 
                } 
                else if (currentRegressionRowCount < 30) {
                    if (warningEl) warningEl.textContent = `Warning: Insufficient data (${currentRegressionRowCount} rows). A minimum of 30 rows is recommended.`;
                }

                showDataPreview(textContent, 'regressionPreviewTable', 'regressionDataPreview');
                updateRegressionVariables(originalHeaders); 

            } catch (err) {
                console.error("Regression input processing failed:", err);
                errorEl.textContent = `Error: ${err.message}.`;
                errorEl.className = "text-red-400 text-sm mt-2"; 
                if (warningEl) warningEl.textContent = "";
                dependentSelect.disabled = true;
                dependentSelect.innerHTML = '<option value="">-- Error reading data --</option>';
                independentContainer.innerHTML = '<p class="text-sm text-red-400 text-center">Error reading data.</p>';
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-red-400" colspan="100%">Error reading data preview.</td></tr></tbody>';
                previewContainer.classList.remove("hidden");
            }
        };

        // --- Attach Event Listeners ---
        
        const examplesBtn = $("regressionExamplesBtn");
        const examplesDiv = $("regressionExamples");
        const exampleContentEl = $("regressionExampleContent");

        if (examplesBtn && examplesDiv && exampleContentEl) {
            examplesBtn.addEventListener("click", () => {
                const isHidden = examplesDiv.classList.toggle("hidden");
                examplesBtn.textContent = isHidden ? "View Examples" : "Hide Examples";

                if (!isHidden && exampleContentEl.textContent === "Loading example...") {
                    exampleContentEl.innerHTML = `
                        <div class="text-xs font-medium text-white/90 mb-2"> How to Use Regression Analysis</div>
                        <div class="space-y-2 text-xs">
                            <div class="mb-4">
                                 <div class="flex items-center mb-2">
                                    <span class="text-green-400 mr-2"></span>
                                    <span class="text-sm font-medium text-green-400">GOOD EXAMPLE</span>
                                    <span class="text-xs text-white/60 ml-2">(Results in clear, significant findings)</span>
                                </div>
                                <div class="bg-green-900/20 border border-green-500/30 rounded p-3">
                                    <div class="text-xs text-white/90 mb-2"><strong>CSV Data (Snippet):</strong></div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-xs text-white/90">
Date,Sales,Marketing_Spend,Website_Traffic,Customer_Service_Calls<br>
2023-01-01,50000,5000,15000,300<br>
2023-02-01,52000,5200,15500,320<br>
2023-03-01,60000,6000,18000,280
                                    </div>
                                    <div class="text-xs text-white/90 mt-3 mb-1"><strong>Selected Variables:</strong></div>
                                    <div class="text-xs text-white/80">
                                         <strong>Dependent (Y):</strong> Sales<br>
                                         <strong>Independent (X):</strong> Marketing_Spend, Website_Traffic
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex items-center mb-2">
                                    <span class="text-red-400 mr-2"></span>
                                     <span class="text-sm font-medium text-red-400">BAD EXAMPLE</span>
                                    <span class="text-xs text-white/60 ml-2">(Results in errors or unreliable findings)</span>
                                </div>
                                <div class="bg-red-900/20 border border-red-500/30 rounded p-3">
                                    <div class="text-xs text-white/90 mb-2"><strong>CSV Data (Snippet with issues):</strong></div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-xs text-white/90">
Date,Sales,Marketing,Traffic<br>
Jan 1, "$50,000", "$5k", "15,000 visitors"<br>
Feb 1, "$52,000", "$5.2k", "15,500 visitors"
                                     </div>
                                    <div class="text-xs text-white/90 mt-3 mb-1"><strong>Issues:</strong></div>
                                    <div class="text-xs text-red-300 font-medium space-y-1">
                                        <div> <strong>Non-Numeric Data:</strong> 'Sales' and 'Marketing' columns contain '$' and 'k', which will cause errors. Data must be numbers only (e.g., 50000, 5000).</div>
                                        <div> <strong>Messy Data:</strong> 'Traffic' column contains text ("visitors") and commas. It should be a clean number (e.g., 15000).</div>
                                        <div> <strong>Bad Column Names:</strong> 'Marketing Spend' (with a space) is better as 'Marketing_Spend'.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t border-white/20 pt-3">
                                <div class="text-xs font-medium text-white/90 mb-2"> How to Get the Best Results:</div>
                                <div class="text-xs text-white/80 space-y-1">
                                    <div> <strong>Clean your data first!</strong> All columns used in the analysis (Y and X) must contain **numbers only**.</div>
                                    <div> Remove all text, commas (in numbers), and currency symbols ($, ) from your data columns.</div>
                                    <div> Use clear column names with **no spaces** (e.g., 'Website_Traffic' instead of 'Website Traffic').</div>
                                    <div> Ensure you have enough data (30+ rows recommended).</div>
                                </div>
                            </div>
                        </div>`;
                }
            });
        }
        
        const regressionFileInput = $("regressionFile");
        if (regressionFileInput) {
            regressionFileInput.addEventListener("change", (e) => {
                const label = $("regressionFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                    processDataInput_Regression(e.target.files[0]);
                } else {
                    fileNameSpan.textContent = "Select .csv data file...";
                    label.classList.remove("has-file");
                    processDataInput_Regression(null);
                }
            });
        }
        
        // --- MODIFICATION START ---
        // Call setupInputToggle for the new context inputs
        setupInputToggle("regressionContextFile", "regressionContextFileLabel", "regressionContextTextArea", "regressionContextFileArea");
        // --- MODIFICATION END ---

        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createRegressionLayout_DA");
        }
    }

    function createPlsLayout_DA(template) {
    const contentContainer = $("templateDetailContent");
    contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Single column layout

    // --- HTML Structure ---
    contentContainer.innerHTML = `
        <div class="lg:col-span-1">
            <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

        <div class="max-w-2xl mx-auto w-full">
            <div class="glass-container p-6 space-y-6">
                
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xl font-bold text-white">Analysis Configuration</h3>
                    <div class="flex items-center space-x-2">
                        <button type="button" id="plsConfigExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                        <button type="button" onclick="triggerBackendDownload(\'pls\', \'pls-sample-data.csv\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .csv</button>
                        <button type="button" id="usePlsSampleBtn" class="btn-sample btn-use-sample" data-template-id="pls-analysis"> Use Sample</button>
                    </div>
                </div>

                <div id="plsConfigExamples" class="hidden mb-4 p-3 bg-black/20 border border-white/15 rounded-lg">
                    <div class="text-xs font-medium text-white/90 mb-2"> Configuration Examples</div>
                    <div class="space-y-2 text-xs">
                        <div id="exampleContent" class="text-white/80">Loading example...</div>
                    </div>
                </div>

                    <div class="input-radio-group">
                        <input type="radio" name="plsInputType" id="plsInputTextToggle" class="input-radio" checked>
                        <label for="plsInputTextToggle" class="input-radio-label">Text Input</label>
                        <input type="radio" name="plsInputType" id="plsInputFileToggle" class="input-radio">
                        <label for="plsInputFileToggle" class="input-radio-label">Document Upload</label>
                    </div>

                    <div id="plsFileUploadArea" class="hidden">
                        <label for="plsFile" class="block text-sm font-medium text-gray-200 mb-2">Data File (.csv, .xlsx)</label>
                        <div class="input-file-wrapper">
                            <label for="plsFile" id="plsFileLabel" class="input-file-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                <span class="file-name">Select data file...</span>
                            </label>
                            <input type="file" id="plsFile" class="input-file" accept=".csv,.xlsx">
                        </div>
                        <div id="plsFileError" class="text-red-400 text-sm mt-2"></div>
                    </div>

                    <div id="plsTextInputArea">
                        <label for="plsDataText" class="block text-sm font-medium text-gray-200 mb-2">Paste CSV Data</label>
                        <textarea id="plsDataText" class="input-field h-48" placeholder="Date,Var1,Var2...\n2023-01-01,10,20..."></textarea>
                        <div id="plsTextError" class="text-red-400 text-sm mt-2"></div>
                    </div>

                    <div id="plsDataPreview" class="space-y-2">
                        <label class="block text-sm font-medium text-gray-200">Data Preview (First 5 Rows)</label>
                        <div class="overflow-x-auto rounded-lg border border-white/20">
                            <table class="min-w-full text-left text-sm text-white/90" id="plsPreviewTable">
                                <tbody>
                                    <tr>
                                        <td class="p-4 text-center text-white/60" colspan="100%">Upload or paste data to see a preview.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <label for="plsModelTemplate" class="block text-sm font-medium text-gray-200 mb-2">Model Template</label>
                        <select id="plsModelTemplate" class="input-field" disabled>
                            <option value="">-- Upload or paste data first --</option>
                        </select>
                    </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label for="plsMeasurementSyntax" class="block text-sm font-medium text-gray-200">Measurement Model Syntax</label>
                        <button type="button" id="plsMeasurementExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                    </div>
                    <div id="plsMeasurementExamples" class="hidden mb-2 p-3 bg-black/20 border border-white/15 rounded-lg">
                        <div class="text-xs font-medium text-white/90 mb-2"> Measurement Model Examples</div>
                        <div class="space-y-2 text-xs">
                            <div>
                                <div class="text-white/80 mb-1">Basic Factor Structure:</div>
                                <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                    Quality =~ qual1 + qual2 + qual3 + qual4<br>Loyalty =~ loy1 + loy2 + loy3
                                </div>
                            </div>
                            <div>
                                <div class="text-white/80 mb-1">With Fixed Loadings (if needed):</div>
                                <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                    Performance =~ 1*perf1 + perf2 + perf3<br>Satisfaction =~ 1*sat1 + sat2 + sat3
                                </div>
                            </div>
                        </div>
                    </div>
                    <textarea id="plsMeasurementSyntax" class="input-field h-32" placeholder="e.g., Factor1 =~ varA + varB\nFactor2 =~ varC + varD..."></textarea>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label for="plsStructuralSyntax" class="block text-sm font-medium text-gray-200">Structural Model Syntax</label>
                        <button type="button" id="plsStructuralExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                    </div>
                    <div id="plsStructuralExamples" class="hidden mb-2 p-3 bg-black/20 border border-white/15 rounded-lg">
                        <div class="text-xs font-medium text-white/90 mb-2"> Structural Model Examples</div>
                        <div class="space-y-2 text-xs">
                            <div>
                                <div class="text-white/80 mb-1">Simple Regression:</div>
                                <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                    Loyalty ~ Quality + Satisfaction
                                </div>
                            </div>
                            <div>
                                <div class="text-white/80 mb-1">Mediation Model:</div>
                                <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                    Loyalty ~ c*Quality + b*Satisfaction<br>Satisfaction ~ a*Quality<br><br>indirect := a*b<br>total := c + (a*b)
                                </div>
                            </div>
                        </div>
                    </div>
                    <textarea id="plsStructuralSyntax" class="input-field h-32" placeholder="e.g., Factor1 ~ Factor2\nObservedVar ~ Factor1..."></textarea>
                </div>

                    <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                        <span id="generateBtnText"> Run PLS-SEM Analysis</span>
                        <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                    <div class="text-center mt-4">
                            <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                    </div>
                </div>
            </div>

            <div class="mt-12">
                <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"> {/* Results will be injected here */} </div>
                <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                    <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                    <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                </div>
            </div>
        </div>`;

    // --- Attach Core Event Listeners ---
    $("generateBtn").addEventListener("click", handleGenerate); 
    reattachActionListeners(); 

    // --- Add Example Toggle Event Listeners ---
    $("plsConfigExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("plsConfigExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        
        if (isHidden) {
            const exampleContent = $("exampleContent");
            const exampleText = `qual1,qual2,qual3,sat1,sat2,loy1,loy2
5,6,5,4,5,5,6
7,7,6,6,7,7,6
4,5,4,3,4,4,4
6,6,7,5,6,6,7
5,4,5,4,4,5,5`;

            exampleContent.innerHTML = `
                <div class="bg-black/30 p-2 rounded font-mono text-white/90 text-xs whitespace-pre-wrap">${exampleText}</div>
                <div class="text-white/60 text-xs mt-2 space-y-1">
                    <div class="font-medium text-white/80">PLS-SEM Data Requirements:</div>
                    <div> <strong>Clean column names:</strong> No spaces or symbols (use underscores)</div>
                    <div> <strong>Numeric data only:</strong> All measurement variables must be numbers</div>
                    <div> <strong>Sample size:</strong> PLS is flexible, but 100+ rows is recommended for stability</div>
                    <div> <strong>No missing values:</strong> Ensure data is complete</div>
                </div>
            `;
        }
        
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

    $("plsMeasurementExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("plsMeasurementExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

    $("plsStructuralExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("plsStructuralExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

        // --- Restore Cached Results (if any) ---
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult")); 
        } else {
            $("analysisResult").innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // --- Get References to PLS-Specific DOM Elements ---
        const fileInput = $("plsFile");
        const textInput = $("plsDataText");
        const measurementSyntaxBox = $("plsMeasurementSyntax");
        const structuralSyntaxBox = $("plsStructuralSyntax");
        const fileError = $("plsFileError");
        const textError = $("plsTextError");
        const fileToggle = $("plsInputFileToggle");
        const textToggle = $("plsInputTextToggle");
        const fileArea = $("plsFileUploadArea");
        const textArea = $("plsTextInputArea");
        const dataPreviewContainer = $("plsDataPreview");
        const previewTable = $("plsPreviewTable");
        const modelTemplateSelect = $("plsModelTemplate");
        let fullHeaders = []; 

        // --- PLS Helper Functions ---

        const getHeadersFromText = (text) => {
            if (!text || typeof text !== 'string' || !text.trim()) throw new Error("Input text is empty.");
            const firstLine = text.split(/[\r\n]+/)[0];
            if (!firstLine || !firstLine.trim()) throw new Error("First line (header) is empty.");

            let headers = firstLine.split(',').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length <= 1) headers = firstLine.split(';').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length <= 1) headers = firstLine.split('\t').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length === 0) throw new Error("Could not parse headers (tried comma, semicolon, tab).");
            return headers;
        };

        const showDataPreview = (csvText) => {
            try {
                const lines = csvText.split(/[\r\n]+/).filter(Boolean); 
                const rows = lines.slice(0, 6); 
                
                if (rows.length < 2) { 
                    previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Data file is empty or has no data rows.</td></tr></tbody>';
                    dataPreviewContainer.classList.remove("hidden"); 
                    return; 
                }

                const headers = getHeadersFromText(rows[0]);
                let tableHTML = '<thead class="bg-white/10 text-xs uppercase"><tr>';
                headers.forEach(h => { tableHTML += `<th scope="col" class="px-4 py-2">${h}</th>`; });
                tableHTML += '</tr></thead><tbody>';

                rows.slice(1).forEach((line, rowIndex) => {
                    let cells = line.split(',');
                    if (cells.length !== headers.length) cells = line.split(';');
                    if (cells.length !== headers.length) cells = line.split('\t');

                    tableHTML += `<tr class="border-t border-white/10 ${rowIndex % 2 === 0 ? 'bg-white/5' : ''}">`;
                    headers.forEach((_, cellIndex) => {
                        tableHTML += `<td class="px-4 py-2">${cells[cellIndex] === undefined ? '' : cells[cellIndex]}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody>';
                previewTable.innerHTML = tableHTML;
                dataPreviewContainer.classList.remove("hidden"); 
            } catch (e) {
                console.error("Error showing data preview:", e);
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-red-400" colspan="100%">Error reading data preview.</td></tr></tbody>';
                dataPreviewContainer.classList.remove("hidden"); 
            }
        };

    const generateRecommendedSyntax = () => {
        const fullSyntax = `
# Measurement Model (Sample)
Quality =~ qual1 + qual2 + qual3 + qual4
Satisfaction =~ sat1 + sat2 + sat3
Loyalty =~ loy1 + loy2 + loy3

# Structural Model (Sample)
Satisfaction ~ Quality
Loyalty ~ Quality + Satisfaction`;
        populateSyntaxBoxes(fullSyntax);
    };

    const generateSyntax = () => {
        if (fullHeaders.length === 0) { 
            alert("Data headers not found for auto-suggestion."); 
            return; 
        }
        const excludePatterns = ['id', 'date', 'time', 'timestamp', 'index', 'row'];
        const analyticalHeaders = fullHeaders.filter(h => 
            !excludePatterns.some(pattern => h.toLowerCase().includes(pattern))
        );
        
        // --- NEW SMARTER LOGIC ---
        const groupedFactors = new Map();
        const prefixRegex = /^([a-zA-Z_]+)/; 

        analyticalHeaders.forEach(header => {
            const match = header.match(prefixRegex);
            if (match) {
                const prefix = match[1]; 
                if (!groupedFactors.has(prefix)) {
                    groupedFactors.set(prefix, []);
                }
                groupedFactors.get(prefix).push(header);
            }
        });

        const validFactors = new Map();
        for (const [prefix, indicators] of groupedFactors.entries()) {
            if (indicators.length > 1) { 
                const factorName = prefix.charAt(0).toUpperCase() + prefix.slice(1);
                validFactors.set(factorName, indicators);
            }
        }

        if (validFactors.size < 2) {
            populateSyntaxBoxes(`# Could not auto-group headers by prefix.\n# Need at least 2 groups with 2+ items each.\n# Available: ${analyticalHeaders.join(', ')}`);
            return;
        }

        let measurementPart = `# Auto-suggested model based on column prefixes\n`;
        const factorNames = [];
        for (const [factorName, indicators] of validFactors.entries()) {
            measurementPart += `${factorName} =~ ${indicators.join(' + ')}\n`;
            factorNames.push(factorName);
        }

        let structuralPart = `# Auto-suggested structural paths (chain model)\n`;
        if (factorNames.length === 2) {
            structuralPart += `${factorNames[1]} ~ ${factorNames[0]}`;
        } else {
            for (let i = 1; i < factorNames.length; i++) {
                structuralPart += `${factorNames[i]} ~ ${factorNames[i-1]}\n`;
            }
            if (factorNames.length > 2) {
                 structuralPart += `${factorNames[factorNames.length-1]} ~ ${factorNames[0]}\n`;
            }
        }
       
        let fullSyntax = measurementPart.trim() + '\n\n' + structuralPart.trim();
        populateSyntaxBoxes(fullSyntax);
    };

    const populateSyntaxBoxes = (fullSyntax) => {
        const lines = fullSyntax.split('\n');
        let structuralStartIndex = -1;
        
        for(let i=0; i < lines.length; i++) {
            const trimmedLine = lines[i].trim();
            if (trimmedLine.includes('~') && !trimmedLine.includes('=~')) {
                structuralStartIndex = i;
                break;
            }
        }

        let measurement = [];
        let structural = [];

        if (structuralStartIndex === -1) {
            measurement = lines;
        } else {
            measurement = lines.slice(0, structuralStartIndex);
            structural = lines.slice(structuralStartIndex);
        }
        
        const filterComments = (arr) => arr.filter(line => !line.trim().startsWith('#')).join('\n').trim();

        measurementSyntaxBox.value = filterComments(measurement);
        structuralSyntaxBox.value = filterComments(structural);
        
        measurementSyntaxBox.placeholder = measurementSyntaxBox.value ? measurementSyntaxBox.placeholder : "e.g., F1 =~ x1+x2";
        structuralSyntaxBox.placeholder = structuralSyntaxBox.value ? structuralSyntaxBox.placeholder : "e.g., F1 ~ F2";
    };

    const updateModelTemplates = (headers) => {
        fullHeaders = headers;
        modelTemplateSelect.innerHTML = '';
        modelTemplateSelect.add(new Option("Select a model template...", ""));
        modelTemplateSelect.add(new Option("Custom Syntax (Type below)", "custom"));
        modelTemplateSelect.add(new Option("Auto-Suggest (Group by Prefix)", "autosuggest")); 
        modelTemplateSelect.disabled = false;
    };

        const processDataInput = async (isFileInput) => {
            let textContent = null;
            let originalHeaders = [];
            const errorEl = isFileInput === null ? null : (isFileInput ? fileError : textError);
            const inputEl = isFileInput === null ? null : (isFileInput ? fileInput : textInput);

            if (fileError) fileError.textContent = "";
            if (textError) textError.textContent = "";

            modelTemplateSelect.disabled = true;
            modelTemplateSelect.innerHTML = '<option value="">-- Processing data... --</option>';
            previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Processing data...</td></tr></tbody>';
            dataPreviewContainer.classList.remove("hidden"); 
            
            measurementSyntaxBox.value = ""; 
            structuralSyntaxBox.value = "";
            measurementSyntaxBox.placeholder = "Upload or paste data to see model templates...";
            structuralSyntaxBox.placeholder = "";

            if (isFileInput === null) {
                modelTemplateSelect.innerHTML = '<option value="">-- Upload or paste data first --</option>';
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Upload or paste data to see a preview.</td></tr></tbody>';
                return;
            }

            try {
                if (isFileInput) {
                    const file = inputEl.files[0];
                    if (!file) {
                        modelTemplateSelect.innerHTML = '<option value="">-- Upload or paste data first --</option>';
                        previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Upload or paste data to see a preview.</td></tr></tbody>';
                        return;
                    }
                    textContent = await extractTextFromFile(file);
                } else {
                    textContent = textInput.value;
                    if (!textContent.trim()) {
                        modelTemplateSelect.innerHTML = '<option value="">-- Upload or paste data first --</option>';
                        previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Upload or paste data to see a preview.</td></tr></tbody>';
                        return;
                    }
                }

            originalHeaders = getHeadersFromText(textContent);

            const lines = textContent.split(/[\r\n]+/).filter(Boolean);
            const dataRows = lines.slice(1); 
            
            if (dataRows.length < 10) {
                if (errorEl) errorEl.textContent = "Warning: Very small dataset. Need at least 10 rows for reliable analysis.";
            }
            
            let numericColumnsCount = 0;
            if (dataRows.length > 0) {
                 const firstRow = dataRows[0].split(/[,;\t]/);
                firstRow.forEach((cell, index) => {
                    if (!isNaN(parseFloat(cell)) && isFinite(cell)) {
                        numericColumnsCount++;
                    }
                });
            }
            
            let nonDateHeaders = originalHeaders.filter(h => !h.toLowerCase().includes('date') && !h.toLowerCase().includes('id'));
            if (nonDateHeaders.length > 0 && numericColumnsCount < nonDateHeaders.length) {
                 if (errorEl) errorEl.textContent = "Warning: Some columns appear non-numeric. PLS-SEM requires numeric data for all indicators.";
            }

                showDataPreview(textContent);
                updateModelTemplates(originalHeaders);

            if (dataRows.length >= 10 && numericColumnsCount >= 3) {
                modelTemplateSelect.value = "autosuggest";
                modelTemplateSelect.dispatchEvent(new Event('change'));
            }

            } catch (err) {
                console.error("Input processing failed:", err);
                if (errorEl) errorEl.textContent = `Error: ${err.message}.`;
                modelTemplateSelect.disabled = true;
                modelTemplateSelect.innerHTML = '<option value="">-- Error reading data --</option>';
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-red-400" colspan="100%">Error reading data preview.</td></tr></tbody>';
                dataPreviewContainer.classList.remove("hidden");
                measurementSyntaxBox.placeholder = "Error reading input data.";
                structuralSyntaxBox.placeholder = "";
            }
        };

        // --- Attach Input Event Listeners ---

        fileToggle.addEventListener("change", () => {
            fileArea.classList.remove("hidden");
            textArea.classList.add("hidden");
            processDataInput(fileInput.files.length > 0 ? true : null); 
        });
        textToggle.addEventListener("change", () => {
            fileArea.classList.add("hidden");
            textArea.classList.remove("hidden");
            processDataInput(textInput.value.trim() ? false : null); 
        });

        if (fileInput) {
            fileInput.addEventListener("change", () => {
                const label = $("plsFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (fileInput.files.length > 0) {
                    fileNameSpan.textContent = fileInput.files[0].name;
                    label.classList.add("has-file");
                    processDataInput(true); 
                } else { 
                    fileNameSpan.textContent = "Select data file...";
                    label.classList.remove("has-file");
                    processDataInput(null); 
                }
            });
        }

        if (textInput) {
            textInput.addEventListener("blur", () => { 
                if (!textArea.classList.contains("hidden")) {
                    processDataInput(textInput.value.trim() ? false : null);
                }
            });
        }

        if (modelTemplateSelect) {
            modelTemplateSelect.addEventListener("change", async () => { 
                const selected = modelTemplateSelect.value;
                measurementSyntaxBox.value = ""; 
                structuralSyntaxBox.value = "";

                switch (selected) {
                    case "custom":
                        measurementSyntaxBox.placeholder = "Type measurement model syntax here...";
                        structuralSyntaxBox.placeholder = "Type structural model syntax here...";
                        measurementSyntaxBox.focus(); 
                        break;
                    case "autosuggest":
                        measurementSyntaxBox.placeholder = "Auto-suggesting generic model...";
                        structuralSyntaxBox.placeholder = "Auto-suggesting generic model...";
                        generateSyntax(); 
                        measurementSyntaxBox.placeholder = measurementSyntaxBox.value ? "Review auto-suggested syntax." : "Could not auto-suggest.";
                        structuralSyntaxBox.placeholder = structuralSyntaxBox.value ? "Review auto-suggested syntax." : "";
                        break;
                    default:
                        measurementSyntaxBox.placeholder = "Select a model template or type syntax...";
                        structuralSyntaxBox.placeholder = "";
                }
            });
        }

        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found in createPlsLayout_DA");
        }
    }

    function createDescriptiveLayout_DA(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
   
                     <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-xl font-bold text-white">Upload Your Dataset & Context</h3>
                                <div class="flex items-center space-x-2">
                                    <button type="button" id="descConfigExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                                    <button type="button" onclick="triggerBackendDownload(\'descriptive\', \'descriptive-sample-doc.txt\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .txt</button>
                                    <button type="button" onclick="triggerBackendDownload(\'descriptive\', \'descriptive-sample-data.csv\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .csv</button>
                                    <button type="button" id="useDescSampleBtn" class="btn-sample btn-use-sample" data-template-id="descriptive-analysis"> Use Sample</button>
                                </div>
                            </div>
 
                            <div id="descConfigExamples" class="hidden mb-4 p-3 bg-black/20 border border-white/15 rounded-lg">
                                <div class="text-xs font-medium text-white/90 mb-2"> How to Use Descriptive Analysis</div>
                                <div class="space-y-2 text-xs">
                                    <div id="descExampleContent" class="text-white/80">Loading example...</div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-200 mb-2">Company Context</label>
                                    <div class="input-radio-group">
                                        <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                        <label for="textInput" class="input-radio-label">Text Input</label>
                                        <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                        <label for="docUpload" class="input-radio-label">Document Upload</label>
                                    </div>
                                </div>

                                <div id="descriptiveContextTextArea">
                                    <label for="descriptiveContextText" class="block text-sm font-medium text-gray-200 mb-2">Paste Context Here</label>
                                    <textarea id="descriptiveContextText" class="input-field h-32" placeholder="Paste your company context, business plan, or problem description here..."></textarea>
                                </div>

                                <div id="descriptiveContextFileArea" class="hidden">
                                    <label for="descriptiveContextFile" class="block text-sm font-medium text-gray-200 mb-2">Company Document (.txt, .docx)</label>
                                    <div class="input-file-wrapper">
                                        <label for="descriptiveContextFile" id="descriptiveContextFileLabel" class="input-file-btn">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select context document...</span>
                                        </label>
                                         <input type="file" id="descriptiveContextFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <div>
                                    <label for="descriptiveFile" class="block text-sm font-medium text-gray-200 mb-2">Data File (.csv)</label>
                                     <div class="input-file-wrapper">
                                        <label for="descriptiveFile" id="descriptiveFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv data file...</span>
                                        </label>
                                         <input type="file" id="descriptiveFile" class="input-file" accept=".csv">
                                    </div>
                                    <div id="descriptiveFileError" class="text-red-400 text-sm mt-2"></div>
                                </div>
                                
                                <div id="descriptiveDataPreview" class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-200">Data Preview (First 5 Rows)</label>
                                    <div class="overflow-x-auto rounded-lg border border-white/20">
                                        <table class="min-w-full text-left text-sm text-white/90" id="descriptivePreviewTable">
                                            <tbody>
                                                <tr>
                                                    <td class="p-4 text-center text-white/60" colspan="100%">Upload a .csv file to see a preview.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
        
                             <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Analyze Data</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Descriptive Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                 `;

        // --- All Helper Functions are LOCAL to this function ---

        const getHeadersFromText = (text) => {
            if (!text || typeof text !== 'string' || !text.trim()) throw new Error("Input text is empty.");
            const firstLine = text.split(/[\r\n]+/)[0];
            if (!firstLine || !firstLine.trim()) throw new Error("First line (header) is empty.");

            let headers = firstLine.split(',').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length <= 1) headers = firstLine.split(';').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length <= 1) headers = firstLine.split('\t').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length === 0) throw new Error("Could not parse headers (tried comma, semicolon, tab).");
            return headers;
        };
        
        const showDataPreview = (csvText, tableId, containerId) => {
            const previewContainer = $(containerId);
            const previewTable = $(tableId);
            if (!previewContainer || !previewTable) return;

            try {
                const lines = csvText.split(/[\r\n]+/).filter(Boolean);
                const rows = lines.slice(0, 6); 
                
                if (rows.length < 2) { 
                    previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Data file is empty or has no data rows.</td></tr></tbody>';
                    previewContainer.classList.remove("hidden"); 
                    return; 
                }

                const headers = getHeadersFromText(rows[0]);
                let tableHTML = '<thead class="bg-white/10 text-xs uppercase"><tr>';
                headers.forEach(h => { tableHTML += `<th scope="col" class="px-4 py-2">${h}</th>`; });
                tableHTML += '</tr></thead><tbody>';

                rows.slice(1).forEach((line, rowIndex) => {
                    let cells = line.split(',');
                    if (cells.length !== headers.length) cells = line.split(';');
                    if (cells.length !== headers.length) cells = line.split('\t');

                    tableHTML += `<tr class="border-t border-white/10 ${rowIndex % 2 === 0 ? 'bg-white/5' : ''}">`;
                    headers.forEach((_, cellIndex) => {
                        tableHTML += `<td class="px-4 py-2">${cells[cellIndex] === undefined ? '' : cells[cellIndex]}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody>';
                previewTable.innerHTML = tableHTML;
                previewContainer.classList.remove("hidden");
            } catch (e) {
                console.error("Error showing data preview:", e);
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-red-400" colspan="100%">Error reading data preview.</td></tr></tbody>';
                previewContainer.classList.remove("hidden");
            }
        };

        const processDataInput_Descriptive = async (file) => {
            const errorEl = $("descriptiveFileError");
            const previewContainer = $("descriptiveDataPreview");
            const previewTable = $("descriptivePreviewTable");
            
            errorEl.textContent = "";
            previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Processing data...</td></tr></tbody>';
            previewContainer.classList.remove("hidden");

            if (!file) {
                 previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Upload a .csv file to see a preview.</td></tr></tbody>';
                 return;
            }

            try {
                const textContent = await extractTextFromFile(file); 
                const originalHeaders = getHeadersFromText(textContent);

                const lines = textContent.split(/[\r\n]+/).filter(Boolean);
                if (lines.length < 10) {
                    errorEl.textContent = "Warning: Small dataset (<10 rows). Analysis may be unreliable.";
                }

                showDataPreview(textContent, 'descriptivePreviewTable', 'descriptiveDataPreview');

            } catch (err) {
                console.error("Descriptive input processing failed:", err);
                errorEl.textContent = `Error: ${err.message}.`;
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-red-400" colspan="100%">Error reading data preview.</td></tr></tbody>';
                previewContainer.classList.remove("hidden");
            }
        };

        // === Simplified attachListener for context file ===
        const attachListener = (inputId, labelId) => {
            const fileInput = $(inputId);
            if (fileInput) {
                fileInput.addEventListener("change", (e) => {
                    const label = $(labelId);
                    const fileNameSpan = label.querySelector(".file-name");
                    if (e.target.files.length > 0) {
                        fileNameSpan.textContent = e.target.files[0].name;
                        label.classList.add("has-file");
                    } else {
                        fileNameSpan.textContent = "Select a file...";
                        label.classList.remove("has-file");
                    }
                });
            }
        };
        
        // === MODIFICATION START ===
        // Call setupInputToggle for the new radio buttons
        // This handles the show/hide logic AND the "descriptiveContextFile" listener
        setupInputToggle("descriptiveContextFile", "descriptiveContextFileLabel", "descriptiveContextTextArea", "descriptiveContextFileArea");
        
        // We no longer need the manual attachListener for descriptiveContextFile
        // attachListener("descriptiveContextFile", "descriptiveContextFileLabel");
        
        // === MODIFICATION END ===


        // === NEW: Event listener for the descriptive data file ===
        const descriptiveFileInput = $("descriptiveFile");
        if (descriptiveFileInput) {
            descriptiveFileInput.addEventListener("change", (e) => {
                const label = $("descriptiveFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                    processDataInput_Descriptive(e.target.files[0]); // Process the file
                } else {
                    fileNameSpan.textContent = "Select .csv data file...";
                    label.classList.remove("has-file");
                    processDataInput_Descriptive(null); // Reset
                }
            });
        }

        // --- Add Example Toggle ---
        const examplesBtn = $("descConfigExamplesBtn");
        const examplesDiv = $("descConfigExamples");
        const exampleContentEl = $("descExampleContent");

        if (examplesBtn && examplesDiv && exampleContentEl) {
            examplesBtn.addEventListener("click", () => {
                const isHidden = examplesDiv.classList.toggle("hidden");
                examplesBtn.textContent = isHidden ? "View Examples" : "Hide Examples";

                if (!isHidden && exampleContentEl.textContent === "Loading example...") {
                    exampleContentEl.innerHTML = `
                         <div class="mb-4">
                            <div class="flex items-center mb-2">
                                <span class="text-green-400 mr-2"></span>
                                <span class="text-sm font-medium text-green-400">GOOD EXAMPLE</span>
                                <span class="text-xs text-white/60 ml-2">(Results in comprehensive statistical insights with clear patterns)</span>
                            </div>
                            <div class="bg-green-900/20 border border-green-500/30 rounded p-3 mb-3">
                                <div class="text-xs text-white/90 mb-2"><strong>Company Context (Text Input or .txt):</strong></div>
                                 <div class="text-xs text-white/80 mb-3">
                                    "TechFlow Solutions seeks to understand performance drivers affecting customer satisfaction and revenue growth. 
                                    Key areas of focus: regional performance variations, employee productivity trends, and customer retention patterns. 
                                    Strategic priority: identify underperforming segments and optimization opportunities."
                                </div>
                                <div class="text-xs text-white/90 mb-2"><strong>CSV Data (quarterly metrics):</strong></div>
                                <div class="bg-black/30 p-2 rounded font-mono text-xs text-white/90">
Quarter,Revenue_Millions,Customer_Count,Satisfaction_Score,Employee_Count,Regional_Performance
Q1_2023,12.5,285,4.2,125,North
Q2_2023,13.8,295,4.1,132,North  
Q3_2023,15.2,310,4.5,140,South
Q4_2023,16.9,325,4.8,145,West</div>
                            </div>
                         </div>
                        
                        <div class="border-t border-white/20 pt-3">
                            <div class="text-xs font-medium text-white/90 mb-2"> How to Use This Tool:</div>
                            <div class="text-xs text-white/80 space-y-1">
                                <div> <strong>Provide Context:</strong> Use the text input or file upload to describe your business goals or what you're looking for.</div>
                                <div> <strong>Provide Data:</strong> Upload the raw .csv file you want to analyze.</div>
                                <div> <strong>AI Links Both:</strong> The AI will analyze the CSV data *and* use your context to provide relevant business insights.</div>
                            </div>
                        </div>
                     `;
                }
            });
        }
        // --- End of Example Toggle ---

        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createDescriptiveLayout_DA");
        }
    }

    function createPrescriptiveLayout_DA(template) {
    const contentContainer = $("templateDetailContent");
    contentContainer.className = "grid lg:grid-cols-1 gap-12";
    contentContainer.innerHTML = `
                <div class="lg:col-span-1">
                     <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                     <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                     
                         <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-bold text-white">Prescriptive Setup</h3>
                            <div class="flex items-center space-x-2">
                                <button type="button" id="prescriptiveExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                                <button type="button" onclick="triggerBackendDownload(\'prescriptive\', \'prescriptive-sample-doc.txt\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .txt</button>
                                <button type="button" onclick="triggerBackendDownload(\'prescriptive\', \'prescriptive-sample-data.csv\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .csv</button>
                                <button type="button" id="usePrescriptiveSampleBtn" class="btn-sample btn-use-sample" data-template-id="prescriptive-analysis"> Use Sample</button>
                            </div>
                        </div>

                        <div id="prescriptiveExamples" class="hidden mb-4 p-3 bg-black/20 border border-white/15 rounded-lg">
                            <div id="prescriptiveExampleContent" class="text-white/80">Loading example...</div>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- === ADDED TOGGLE SECTION START === -->
                            <div>
                                <label class="block text-sm font-medium text-gray-200 mb-2">Business Goal / Context</label>
                                <div class="input-radio-group">
                                    <input type="radio" name="prescriptiveInputType" id="prescriptiveInputTextToggle" class="input-radio" checked>
                                    <label for="prescriptiveInputTextToggle" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="prescriptiveInputType" id="prescriptiveInputFileToggle" class="input-radio">
                                    <label for="prescriptiveInputFileToggle" class="input-radio-label">Document Upload</label>
                                </div>
                            </div>

                            <div id="prescriptiveTextInputArea">
                                <label for="prescriptiveGoalText" class="block text-sm font-medium text-gray-200 mb-2">What is your business goal?</label>
                                <textarea id="prescriptiveGoalText" class="input-field h-24" placeholder="Be specific. For example: 'Increase customer retention by 15% in the next quarter.' or 'Reduce operational costs in the logistics department by 10%.'"></textarea>
                            </div>

                            <div id="prescriptiveFileInputArea" class="hidden">
                                <label for="prescriptiveContextFile" class="block text-sm font-medium text-gray-200 mb-2">Context Document (.txt, .docx)</label>
                                <div class="input-file-wrapper">
                                    <label for="prescriptiveContextFile" id="prescriptiveContextFileLabel" class="input-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                    <span class="file-name">Select context document...</span>
                                    </label>
                                    <input type="file" id="prescriptiveContextFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <!-- === ADDED TOGGLE SECTION END === -->
                            
                            <div>
                                <label for="prescriptiveFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                <div class="input-file-wrapper">
                                    <label for="prescriptiveFile" id="prescriptiveFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .csv file...</span>
                                    </label>
                                    <input type="file" id="prescriptiveFile" class="input-file" accept=".csv">
                                </div>
                                <div id="prescriptiveFileError" class="text-red-400 text-sm mt-2"></div>
                            </div>
                        </div>
                        
                        <!-- Data Preview Section -->
                        <div id="prescriptiveDataQualityWarning" class="hidden error-message p-3 text-sm mt-4"></div>
                        <div id="prescriptiveDataPreview" class="hidden space-y-2 mt-4">
                            <label class="block text-sm font-medium text-gray-200">Data Preview (First 5 Rows)</label>
                            <div class="overflow-x-auto rounded-lg border border-white/20">
                                <table class="min-w-full text-left text-sm text-white/90" id="prescriptivePreviewTable">
                                </table>
                            </div>
                        </div>

                        <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                            <span id="generateBtnText"> Generate Prescriptions</span>
                            <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div class="text-center mt-4">
                            <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                        </div>
                    </div>
                    <div class="mt-12">
                         <h2 class="text-3xl font-bold mb-4 text-center">Prescriptive Analysis Results</h2>
                         <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                         <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                            <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                            <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                        </div>
                    </div>
                </div>
            `;
    
    // This helper function is fine and doesn't need changes
    setupInputToggle("prescriptiveFile", "prescriptiveFileLabel", null, null);

    // === TOGGLE EVENT LISTENERS ===
    const prescriptiveInputTextToggle = $("prescriptiveInputTextToggle");
    const prescriptiveInputFileToggle = $("prescriptiveInputFileToggle");
    const prescriptiveTextInputArea = $("prescriptiveTextInputArea");
    const prescriptiveFileInputArea = $("prescriptiveFileInputArea");

    if (prescriptiveInputTextToggle && prescriptiveInputFileToggle) {
        prescriptiveInputTextToggle.addEventListener("change", () => {
            prescriptiveTextInputArea.classList.remove("hidden");
            prescriptiveFileInputArea.classList.add("hidden");
        });
        prescriptiveInputFileToggle.addEventListener("change", () => {
            prescriptiveTextInputArea.classList.add("hidden");
            prescriptiveFileInputArea.classList.remove("hidden");
        });
    }

    // Context file input listener
    const contextFileInput = $("prescriptiveContextFile");
    if (contextFileInput) {
        contextFileInput.addEventListener("change", (e) => {
            const label = $("prescriptiveContextFileLabel");
            const fileNameSpan = label.querySelector(".file-name");
            if (e.target.files.length > 0) {
                fileNameSpan.textContent = e.target.files[0].name;
                label.classList.add("has-file");
            } else {
                fileNameSpan.textContent = "Select context document...";
                label.classList.remove("has-file");
            }
        });
    }

    // === CSV DATA FILE INPUT LISTENER WITH PREVIEW ===
    const dataFileInput = $("prescriptiveFile");
    const dataFileLabel = $("prescriptiveFileLabel");
    const fileError = $("prescriptiveFileError");

    if (dataFileInput && dataFileLabel && fileError) {
        dataFileInput.addEventListener("change", async function(e) {
            const fileNameSpan = dataFileLabel.querySelector(".file-name");
            const qualityWarning = $("prescriptiveDataQualityWarning");
            const previewContainer = $("prescriptiveDataPreview");
            const previewTable = $("prescriptivePreviewTable");

            fileError.textContent = "";
            qualityWarning.classList.add("hidden");
            previewContainer.classList.add("hidden");

            if (fileNameSpan) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    fileNameSpan.textContent = file.name;
                    dataFileLabel.classList.add("has-file");
                    
                    // Validate file type
                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        fileError.textContent = "Please select a CSV file (.csv)";
                        return;
                    }
                    
                    // Validate file size (10MB limit)
                    const maxSize = 10 * 1024 * 1024;
                    if (file.size > maxSize) {
                        fileError.textContent = "File size must be less than 10MB";
                        return;
                    }
                    
                    try {
                        // Read the file as text
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const csvText = e.target.result;
                            
                            // Show data preview - ALL LOGIC INLINE
                            let warnings = [];
                            const lines = csvText.split(/[\r\n]+/).filter(line => line.trim() !== '');
                            const rows = lines.slice(0, 6); // Header + 5 data rows
                            
                            const dataRowCount = lines.length - 1;
                            if (dataRowCount < 10) {
                                warnings.push(`Small dataset (only ${dataRowCount} rows). Results may be limited.`);
                            }

                            if (rows.length < 2) {
                                previewContainer.classList.add("hidden");
                                if(dataRowCount === 0) {
                                    warnings.push("File appears to be empty or missing data rows.");
                                }
                            } else {
                                // Parse headers - ALL INLINE
                                const firstLine = rows[0];
                                let headers = firstLine.split(',').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
                                if (headers.length <= 1) headers = firstLine.split(';').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
                                if (headers.length <= 1) headers = firstLine.split('\t').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
                                
                                if (headers.length === 0) {
                                    throw new Error("Could not parse headers.");
                                }

                                let tableHTML = '<thead class="bg-white/10 text-xs uppercase"><tr>';
                                headers.forEach(h => { tableHTML += `<th scope="col" class="px-4 py-2">${h}</th>`; });
                                tableHTML += '</tr></thead><tbody>';

                                let nullCount = 0;
                                let messyDataCount = 0;

                                rows.slice(1).forEach((line, rowIndex) => {
                                    let cells = line.split(',');
                                    if (cells.length !== headers.length) cells = line.split(';');
                                    if (cells.length !== headers.length) cells = line.split('\t');

                                    tableHTML += `<tr class="border-t border-white/10 ${rowIndex % 2 === 0 ? 'bg-white/5' : ''}">`;
                                    headers.forEach((_, cellIndex) => {
                                        const cellValue = cells[cellIndex]?.trim() ?? '';
                                        let displayValue = cellValue;
                                        
                                        if (cellValue === '' || cellValue.toLowerCase() === 'null' || cellValue.toLowerCase() === 'na') {
                                            nullCount++;
                                            displayValue = `<span class="text-yellow-400 italic" title="Null/Missing Value">NULL</span>`;
                                        } else if (/[$,%"]/.test(cellValue) && !isNaN(parseFloat(cellValue.replace(/[$,%"]/g, '')))) {
                                            messyDataCount++;
                                            displayValue = `<span class="text-orange-400" title="Messy Data (contains symbols)">${cellValue}</span>`;
                                        }

                                        tableHTML += `<td class="px-4 py-2 whitespace-nowrap overflow-hidden text-ellipsis max-w-[150px]" title="${cellValue}">${displayValue}</td>`;
                                    });
                                    tableHTML += '</tr>';
                                });
                                tableHTML += '</tbody>';
                                previewTable.innerHTML = tableHTML;
                                previewContainer.classList.remove("hidden");

                                if (nullCount > 0) {
                                    warnings.push(`Spotted ${nullCount} missing values (NULL) in the preview.`);
                                }
                                if (messyDataCount > 0) {
                                    warnings.push(`Spotted ${messyDataCount} numerical values with symbols ($, %, etc.). Consider cleaning the data.`);
                                }
                            }

                            // Display warnings
                            if (warnings.length > 0) {
                                qualityWarning.innerHTML = "<strong> Data Quality Warnings:</strong><ul class='list-disc list-inside mt-1'>" + warnings.map(w => `<li>${w}</li>`).join('') + "</ul>";
                                qualityWarning.classList.remove("hidden");
                            } else {
                                qualityWarning.classList.add("hidden");
                            }
                        };
                        
                        reader.onerror = function() {
                            fileError.textContent = "Error reading file";
                        };
                        
                        reader.readAsText(file);
                        
                    } catch (err) {
                        fileError.textContent = `Error reading file: ${err.message}`;
                        previewContainer.classList.add("hidden");
                        qualityWarning.classList.add("hidden");
                    }
                } else {
                    fileNameSpan.textContent = "Select .csv file...";
                    dataFileLabel.classList.remove("has-file");
                }
            }
        });
    }

    // --- Examples button listener ---
    const examplesBtn = $("prescriptiveExamplesBtn");
    const examplesDiv = $("prescriptiveExamples");
    const exampleContentEl = $("prescriptiveExampleContent");

    if (examplesBtn && examplesDiv && exampleContentEl) {
        examplesBtn.addEventListener("click", () => {
            const isHidden = examplesDiv.classList.toggle("hidden");
            examplesBtn.textContent = isHidden ? "View Examples" : "Hide Examples";

            if (!isHidden && exampleContentEl.textContent === "Loading example...") {
                exampleContentEl.innerHTML = `
                    <div class="mb-4">
                        <div class="flex items-center mb-2">
                            <span class="text-green-400 mr-2"></span>
                            <span class="text-sm font-medium text-green-400">GOOD EXAMPLE</span>
                            <span class="text-xs text-white/60 ml-2">(Results in specific, data-driven actions)</span>
                        </div>
                        <div class="bg-green-900/20 border border-green-500/30 rounded p-3">
                            <div class="text-xs text-white/90 mb-2"><strong>Business Goal (Context):</strong></div>
                            <div class="text-xs text-white/80 mb-3">
                                "We need to reduce customer churn by 10% this quarter."
                            </div>
                            <div class="text-xs text-white/90 mb-2"><strong>CSV Data (Snippet):</strong></div>
                            <div class="bg-black/30 p-2 rounded font-mono text-xs text-white/90">
CustomerID,Tenure_Months,Support_Tickets,Used_Feature_X,Churned<br>
1001,24,1,Yes,No<br>
1002,3,8,No,Yes<br>
1003,36,2,Yes,No<br>
1004,6,5,No,Yes
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-white/20 pt-3">
                        <div class="text-xs font-medium text-white/90 mb-2"> How to Get the Best Results:</div>
                        <div class="text-xs text-white/80 space-y-1">
                            <div> <strong>Have a clear goal.</strong> "Reduce churn" is better than "Analyze customers".</div>
                            <div> <strong>Include an outcome column.</strong> The data should have the variable you want to affect (e.g., 'Churned', 'Sales', 'Cost').</div>
                            <div> <strong>Include driver columns.</strong> The data needs factors you can control or influence (e.g., 'Support_Tickets', 'Used_Feature_X').</div>
                        </div>
                    </div>
                `;
            }
        });
    }

    // Attach listener for the feedback link
    const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
    if (feedbackLink) {
        feedbackLink.addEventListener("click", (e) => {
            e.preventDefault();
            if (typeof navigateTo === 'function') {
                navigateTo('feedback');
            } else {
                console.error("navigateTo function is not defined.");
            }
        });
    } else {
        console.warn("Feedback link not found inside createPrescriptiveLayout_DA");
    }
}

    /**
     * --- UPDATED (V15 - Final Fix) ---
     * Creates the layout for the Visualization tool.
     * --- USER REQUESTED FORMATTING UPDATE V3 ---
     * - Added "Download Sample .txt" link next to the CSV link.
     */
    function createVisualizationLayout_DA(template) {
    // Helper function to safely get element
    function safeGetElement(id) {
        try {
             return document.getElementById(id);
        } catch (e) {
            console.error("Error getting element:", id, e);
            return null;
        }
    }
    
    const contentContainer = safeGetElement("templateDetailContent");
    if (!contentContainer) {
        console.error("Content container not found");
        return;
    }
    
    contentContainer.className = "grid lg:grid-cols-1 gap-12";
    
    const htmlContent = [
        '<div class="lg:col-span-1">',
        '<h1 class="text-4xl font-bold text-center mb-2">' + (template.title || 'Visualization') + '</h1>',
        '<p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">' + (template.description || '') + '</p>',
        '<div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">',
        
        // --- CHANGED BLOCK START ---
        // Added the "Download Sample .txt" link here
        '<div class="flex items-center justify-between mb-2">',
        '<h3 class="text-xl font-bold text-white">Visualization Setup</h3>',
        '<div class="flex items-center space-x-2">', 
            '<button type="button" id="vizConfigExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>',
            // Added the new .txt link
            '<button type="button" onclick="triggerBackendDownload(\'visualization\', \'visualization-sample-doc.txt\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .txt</button>',
            '<button type="button" onclick="triggerBackendDownload(\'visualization\', \'visualization-sample.csv\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .csv</button>',
            '<button type="button" id="useVizSampleBtn" class="btn-sample btn-use-sample" data-template-id="visualization"> Use Sample</button>',
        '</div>',
        '</div>',
        // --- CHANGED BLOCK END ---
        
        // --- Good vs. Bad Examples ---
        '<div id="vizConfigExamples" class="hidden mb-4 p-3 bg-black/20 border border-white/15 rounded-lg">',
        '<div class="text-xs font-medium text-white/90 mb-3"> How to Get the Best Results</div>',
        // Good Example
        '<div class="mb-4">', 
        '<div class="flex items-center mb-2">',
        '<span class="text-green-400 mr-2"></span>',
        '<span class="text-sm font-medium text-green-400">GOOD EXAMPLE</span>',
        '<span class="text-xs text-white/60 ml-2">(Results in relevant, accurate charts)</span>',
        '</div>',
        '<div class="bg-green-900/20 border border-green-500/30 rounded p-3">',
        '<div class="text-xs text-white/90 mb-2"><strong>Context Text (Your Request):</strong></div>',
        '<div class="text-xs text-white/80 mb-3">',
        '"Show me the sales revenue trend over time. Also, how does marketing spend correlate with sales revenue? And which product category has the highest total sales?"',
        '</div>',
        '<div class="text-xs text-white/90 mb-2"><strong>CSV Data (Snippet):</strong></div>',
        '<div class="bg-black/30 p-2 rounded font-mono text-xs text-white/90">',
        'Date,Region,Marketing_Spend,Sales_Revenue,Product_Category<br>',
        '2024-01-01,North,5000,78500,Electronics<br>',
        '2024-02-01,North,5200,79200,Apparel<br>',
        '2024-03-01,West,7100,107000,Home Goods',
        '</div>',
        '</div>',
        '</div>',
        // MODIFIED: Bad Example (with annotations)
        '<div class="mb-4">',
        '<div class="flex items-center mb-2">',
        '<span class="text-red-400 mr-2"></span>',
        '<span class="text-sm font-medium text-red-400">BAD EXAMPLE</span>',
        '<span class="text-xs text-white/60 ml-2">(Results in generic, unhelpful charts)</span>',
        '</div>',
        '<div class="bg-red-900/20 border border-red-500/30 rounded p-3">',
        '<div class="text-xs text-white/80 mb-3">',
        '<strong>Context Text:</strong> "Here\'s my data. Show me charts. I want to see what\'s happening." <span class="text-red-300 italic text-xs">(Vague, not specific)</span>',
        '</div>',
        '<div class="text-xs text-white/90 mb-2"><strong>CSV Data (Snippet):</strong></div>',
        '<div class="bg-black/30 p-2 rounded font-mono text-xs text-white/90">',
        'Date,Sales,Marketing ($),Region<br>',
        'Jan 1, "$5,000", "100", N/A <span class="text-red-300 italic text-xs">(Messy data: $, commas, inconsistent dates)</span><br>',
        'Feb 1, "$6,200", "120", North<br>',
        'Mar 1, "7000", "110", West',
        '</div>',
        '</div>',
        '</div>',
        '<div class="border-t border-white/20 pt-3">',
        '<div class="text-xs font-medium text-white/90 mb-2"> How to Write Your Request:</div>',
        '<div class="text-xs text-white/80 space-y-1">',
        '<div> <strong>Be specific:</strong> Ask clear questions (e.g., "correlate X and Y," "show trend of Z").</div>',
        '<div> <strong>Clean your data:</strong> Ensure numbers are just numbers (no $, %, or commas).</div>',
        '<div> <strong>Use clean headers:</strong> Use simple column names (e.g., Marketing_Spend not Marketing ($)).</div>',
        '</div>',
        '</div>',

        // --- MOVED BLOCK START ---
        // The Data Requirements Checklist is now inside the "vizConfigExamples" div
        '<div class="mt-4 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">',
        '<div class="mb-2">',
            '<h4 class="text-sm font-medium text-blue-300"> Data Requirements Checklist</h4>',
        '</div>',
        '<ul class="list-disc list-inside text-xs text-white/80 space-y-1">',
        '<li><strong>File Format:</strong> CSV (UTF-8 encoded).</li>',
        '<li><strong>Headers:</strong> Must be in the **first row**. Use simple names (e.g., `Sales_Revenue`, not `Sales ($)`).</li>',
        '<li><strong>Numbers:</strong> Must be **numbers only** (no $, ,, or % symbols).</li>',
        '<li><strong>Dates:</strong> Must be in a **consistent format** (e.g., YYYY-MM-DD or MM/DD/YYYY).</li>',
        '<li><strong>Categorical:</strong> Must have **consistent spelling** (e.g., "North", not "North" and "N.").</li>',
        '<li><strong>Data Quality:</strong> Check for missing values (nulls) or extreme outliers.</li>',
        '<li><strong>Limits:</strong> Recommended 30-50+ rows for reliable insights. Max file size ~5MB.</li>',
        '</ul>',
        '</div>',
        // --- MOVED BLOCK END ---

        '</div>',
        // --- End Examples Div ---

        // === ADDED TOGGLE SECTION START ===
        '<div class="space-y-4">',
            '<div>',
                '<label class="block text-sm font-medium text-gray-200 mb-2">Visualization Request / Context</label>',
                '<div class="input-radio-group">',
                    '<input type="radio" name="vizInputType" id="vizInputTextToggle" class="input-radio" checked>',
                    '<label for="vizInputTextToggle" class="input-radio-label">Text Input</label>',
                    '<input type="radio" name="vizInputType" id="vizInputFileToggle" class="input-radio">',
                    '<label for="vizInputFileToggle" class="input-radio-label">Document Upload</label>',
                '</div>',
            '</div>',

            '<div id="vizTextInputArea">',
                '<label for="vizRequestText" class="block text-sm font-medium text-gray-200 mb-2">What do you want to visualize?</label>',
                '<textarea id="vizRequestText" class="input-field h-24" placeholder="Be specific. For example: \'Show the relationship between Marketing Spend and Sales Revenue\', or \'Visualize the distribution of customer ages by product category.\'"></textarea>',
            '</div>',

            '<div id="vizFileInputArea" class="hidden">',
                '<label for="vizContextFile" class="block text-sm font-medium text-gray-200 mb-2">Context Document (.txt, .docx)</label>',
                '<div class="input-file-wrapper">',
                    '<label for="vizContextFile" id="vizContextFileLabel" class="input-file-btn">',
                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>',
                    '<span class="file-name">Select context document...</span>',
                    '</label>',
                    '<input type="file" id="vizContextFile" class="input-file" accept=".txt,.docx">',
                '</div>',
            '</div>',
        // === ADDED TOGGLE SECTION END ===

            '<div>',
            '<label for="vizFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>',
            '<div class="input-file-wrapper">',
            '<label for="vizFile" id="vizFileLabel" class="input-file-btn">',
            '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16">',
            '<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>',
            '<path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>',
            '</svg>',
            '<span class="file-name">Select .csv file...</span>',
            '</label>',
            '<input type="file" id="vizFile" class="input-file" accept=".csv">',
            '</div>',
            '<div id="vizFileError" class="text-red-400 text-sm mt-2"></div>',
            '</div>',
        '</div>',



        '<div id="vizDataQualityWarning" class="hidden error-message p-3 text-sm mt-4"></div>',
        '<div id="vizDataPreview" class="hidden space-y-2 mt-4">',
        '<label class="block text-sm font-medium text-gray-200">Data Preview (First 5 Rows)</label>',
        '<div class="overflow-x-auto rounded-lg border border-white/20">',
        '<table class="min-w-full text-left text-sm text-white/90" id="vizPreviewTable">',
        '</table>',
        '</div>',
        '</div>',
        '<button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">',
        '<span id="generateBtnText"> Generate Visualizations</span>',
        '<span id="generateSpinner" class="loading-spinner hidden ml-2"></span>',
        '</button>',
        
        // --- Feedback Link (V12) ---
        '<div class="text-center mt-4">',
        '<a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>',
        '</div>',

        '</div>', // This closes <div class="glass-container ...
        '<div class="mt-12">',
        '<h2 class="text-3xl font-bold mb-4 text-center">Data Visualizations</h2>',
        '<div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>',
        '<div id="analysisActions" class="text-center mt-4 space-x-2 hidden">',
        '<button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>',
        '<button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>',
        '</div>',
        '</div>',
        '</div>',
    ].join('');
    
    contentContainer.innerHTML = htmlContent;

    // --- Helper functions for preview (V9) ---
    const getHeadersFromText = (text) => {
        const firstLine = text.split(/[\r\n]+/)[0];
        let headers = firstLine.split(',').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
        if (headers.length <= 1) headers = firstLine.split(';').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
        if (headers.length <= 1) headers = firstLine.split('\t').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
        if (headers.length === 0) throw new Error("Could not parse headers.");
        return headers;
    };

    const showDataPreview = (csvText) => {
        const previewContainer = safeGetElement("vizDataPreview");
        const previewTable = safeGetElement("vizPreviewTable");
        const qualityWarning = safeGetElement("vizDataQualityWarning");
        if (!previewContainer || !previewTable || !qualityWarning) return;

        let warnings = [];

        try {
            const lines = csvText.split(/[\r\n]+/).filter(line => line.trim() !== '');
            const rows = lines.slice(0, 6); 
            
            // --- Your Data Quality Logic ---
            const dataRowCount = lines.length - 1;
            if (dataRowCount < 30) {
                warnings.push(`Insufficient data for reliable visualization (only ${dataRowCount} rows).`);
            } else if (dataRowCount < 50) {
                warnings.push(`Limited dataset (${dataRowCount} rows). Basic charts only.`);
            }
            // --- END Your Logic ---

            if (rows.length < 2) {
                previewContainer.classList.add("hidden");
                if(dataRowCount === 0) {
                    warnings.push("File appears to be empty or missing data rows.");
                }
            } else {
                const headers = getHeadersFromText(rows[0]);
                let tableHTML = '<thead class="bg-white/10 text-xs uppercase"><tr>';
                headers.forEach(h => { tableHTML += `<th scope="col" class="px-4 py-2">${h}</th>`; });
                tableHTML += '</tr></thead><tbody>';

                let nullCount = 0;
                let messyDataCount = 0;

                rows.slice(1).forEach((line, rowIndex) => {
                    let cells = line.split(',');
                    if (cells.length !== headers.length) cells = line.split(';');
                    if (cells.length !== headers.length) cells = line.split('\t');

                    tableHTML += `<tr class="border-t border-white/10 ${rowIndex % 2 === 0 ? 'bg-white/5' : ''}">`;
                    headers.forEach((_, cellIndex) => {
                        const cellValue = cells[cellIndex]?.trim() ?? '';
                        let displayValue = cellValue;
                        
                        if (cellValue === '' || cellValue.toLowerCase() === 'null' || cellValue.toLowerCase() === 'na') {
                            nullCount++;
                            displayValue = `<span class="text-yellow-400 italic" title="Null/Missing Value">NULL</span>`;
                        } else if (/[$,%"]/.test(cellValue) && !isNaN(parseFloat(cellValue.replace(/[$,%"]/g, '')))) {
                            messyDataCount++;
                            displayValue = `<span class="text-orange-400" title="Messy Data (contains symbols)">${cellValue}</span>`;
                        }

                        tableHTML += `<td class="px-4 py-2 whitespace-nowrap overflow-hidden text-ellipsis max-w-[150px]" title="${cellValue}">${displayValue}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody>';
                previewTable.innerHTML = tableHTML;
                previewContainer.classList.remove("hidden");

                if (nullCount > 0) {
                    warnings.push(`Spotted ${nullCount} missing values (NULL) in the preview.`);
                }
                if (messyDataCount > 0) {
                    warnings.push(`Spotted ${messyDataCount} numerical values with symbols ($, %, etc.). Please clean the data.`);
                }
            }

            // Display warnings
            if (warnings.length > 0) {
                qualityWarning.innerHTML = "<strong> Data Quality Warnings:</strong><ul class='list-disc list-inside mt-1'>" + warnings.map(w => `<li>${w}</li>`).join('') + "</ul>";
                qualityWarning.classList.remove("hidden");
            } else {
                qualityWarning.classList.add("hidden");
            }

        } catch (e) {
            console.error("Error showing data preview:", e);
            previewContainer.classList.add("hidden");
            qualityWarning.textContent = `Error during preview: ${e.message}`;
            qualityWarning.classList.remove("hidden");
        }
    };
    // --- END HELPERS ---
    
    // --- Attaching Event Listeners ---
    setTimeout(function() {
        try {
            // === ADDED TOGGLE EVENT LISTENERS START ===
            // 0. Input type toggle
            const vizInputTextToggle = safeGetElement("vizInputTextToggle");
            const vizInputFileToggle = safeGetElement("vizInputFileToggle");
            const vizTextInputArea = safeGetElement("vizTextInputArea");
            const vizFileInputArea = safeGetElement("vizFileInputArea");

            if (vizInputTextToggle && vizInputFileToggle) {
                vizInputTextToggle.addEventListener("change", () => {
                    vizTextInputArea.classList.remove("hidden");
                    vizFileInputArea.classList.add("hidden");
                });
                vizInputFileToggle.addEventListener("change", () => {
                    vizTextInputArea.classList.add("hidden");
                    vizFileInputArea.classList.remove("hidden");
                });
            }

            // 0.5. Context file input listener
            const contextFileInput = safeGetElement("vizContextFile");
            if (contextFileInput) {
                contextFileInput.addEventListener("change", (e) => {
                    const label = safeGetElement("vizContextFileLabel");
                    const fileNameSpan = label.querySelector(".file-name");
                    if (e.target.files.length > 0) {
                        fileNameSpan.textContent = e.target.files[0].name;
                        label.classList.add("has-file");
                    } else {
                        fileNameSpan.textContent = "Select context document...";
                        label.classList.remove("has-file");
                    }
                });
            }
            // === ADDED TOGGLE EVENT LISTENERS END ===

            // 1. Examples toggle
            const examplesBtn = safeGetElement("vizConfigExamplesBtn");
            const examplesDiv = safeGetElement("vizConfigExamples");
            if (examplesBtn && examplesDiv) {
                examplesBtn.addEventListener("click", function() {
                    const isHidden = examplesDiv.classList.toggle("hidden");
                    examplesBtn.textContent = isHidden ? "View Examples" : "Hide Examples";
                });
            }

            // 2. File input handler
            const fileInput = safeGetElement("vizFile");
            const fileLabel = safeGetElement("vizFileLabel");
            const fileError = safeGetElement("vizFileError");

            if (fileInput && fileLabel && fileError) {
                fileInput.addEventListener("change", async function(e) {
                    const fileNameSpan = fileLabel.querySelector(".file-name");
                    const qualityWarning = safeGetElement("vizDataQualityWarning");
                    const previewContainer = safeGetElement("vizDataPreview");

                    fileError.textContent = "";
                    qualityWarning.classList.add("hidden");
                    previewContainer.classList.add("hidden");

                    if (fileNameSpan) {
                        if (e.target.files.length > 0) {
                            const file = e.target.files[0];
                            fileNameSpan.textContent = file.name;
                            fileLabel.classList.add("has-file");
                            
                            try {
                                if (typeof Papa === 'undefined') {
                                    throw new Error("CSV parsing library (PapaParse) not loaded.");
                                }
                                const text = await extractTextFromFile(file);
                                showDataPreview(text); 
                            } catch (err) {
                                fileError.textContent = `Error reading file: ${err.message}`;
                                previewContainer.classList.add("hidden");
                                qualityWarning.classList.add("hidden");
                            }
                        } else {
                            fileNameSpan.textContent = "Select .csv file...";
                            fileLabel.classList.remove("has-file");
                        }
                    }
                });
            }

            // 3. Generate button handler
            const generateBtn = safeGetElement("generateBtn");
            if (generateBtn && typeof handleGenerate === 'function') {
                generateBtn.addEventListener("click", handleGenerate);
            }

            // 4. Save button listeners
            if (typeof reattachActionListeners === 'function') {
                reattachActionListeners();
            }

            // 5. Handle analysis cache
            const analysisResult = safeGetElement("analysisResult");
            const analysisActions = safeGetElement("analysisActions");

            // --- NEW: Animate the new content ---
            const newElementsToAnimate = contentContainer.querySelectorAll(
                '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
            );
            animateElements(newElementsToAnimate);
            
            if (analysisResult && analysisActions) {
                if (typeof analysisCache !== 'undefined' && 
                    typeof currentTemplateId !== 'undefined' && 
                    analysisCache[currentTemplateId]) {
                    
                    analysisResult.innerHTML = analysisCache[currentTemplateId];
                    analysisActions.classList.remove("hidden");
                    
                    if (typeof reattachTabListeners === 'function') {
                        reattachTabListeners(analysisResult);
                    }
                    
                    setTimeout(() => {
                        const chartsInPanel = analysisResult.querySelectorAll('.plotly-chart');
                        chartsInPanel.forEach(chartDiv => {
                            if (chartDiv.layout && typeof Plotly !== 'undefined') {
                                try { Plotly.Plots.resize(chartDiv); } catch (resizeError) { console.error(`Error resizing cached chart ${chartDiv.id}:`, resizeError); }
                            }
                        });
                    }, 150);

                } else {
                    analysisResult.innerHTML = 
                        '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    analysisActions.classList.add("hidden");
                }
            }
            
            // --- THIS IS THE FIX ---
            // 6. Attach listener for the feedback link
            const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
            if (feedbackLink) {
                feedbackLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    
                    // This just calls the navigateTo function.
                    // It relies on your main `MapsTo` function to be
                    // the *simplified one* (without memory logic)
                    // and your `submitFeedbackPageBtn` listener
                    // to be the *simplified one* (that just goes home).
                    if (typeof navigateTo === 'function') {
                        navigateTo('feedback');
                    } else {
                        console.error("navigateTo function is not defined.");
                    }
                });
            } else {
                console.warn("Feedback link not found inside createVisualizationLayout_DA");
            }
            // --- END FIX ---


        } catch (error) {
            console.error("Error setting up visualization layout:", error);
        }
    }, 100);
}

    /**
     * Creates the UI for the S.M.A.R.T. Objectives tool.
     * --- UPDATED ---
     * Now includes companyName and location fields to match the default form
     * and satisfy the n8n workflow's requirements, while keeping the custom UI.
     */
    function createObjectivesLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide Business Goal or Context</h3>
                             
                             <div>
                                <label for="companyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label>
                                <input type="text" id="companyName" class="input-field" placeholder="e.g., ${preFillData || 'Innovate Inc.'}" required>
                             </div>
                             <div>
                                <label for="location" class="block text-sm font-medium text-gray-200 mb-2">Location</label>
                                <input type="text" id="location" class="input-field" placeholder="e.g., Global" required>
                             </div>
                             <div>
                                <label for="companyDocumentsFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Context Document</label>
                                <div class="input-file-wrapper">
                                    <label for="companyDocumentsFile" id="companyDocumentsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Click to select a file...</span>
                                    </label>
                                    <input type="file" id="companyDocumentsFile" class="input-file" accept=".txt,.docx">
                                </div>
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Manual Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio" disabled>
                                <label for="docUpload" class="input-radio-label opacity-50 cursor-not-allowed">Use Document Above</label>
                            </div>
                            <div id="textInputArea">
                                <label for="objectivesContent" class="block text-sm font-medium text-gray-200 mb-2">Or Paste Context Here</label>
                                <textarea id="objectivesContent" class="input-field h-48" placeholder="Describe your high-level goal, project, or business context... (Note: Uploading a document above is recommended)"></textarea>
                            </div>
                            
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Formulate S.M.A.R.T. Objectives</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Generated Objectives Framework</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        
        // Re-attach event listeners
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();
        
        // --- Setup Logic for this specific page ---
        const fileInput = $("companyDocumentsFile"); // Re-using the same ID is fine
        const textInputToggle = $("textInput");
        const docUploadToggle = $("docUpload");
        const textArea = $("textInputArea");
        
        // Radio button logic
        textInputToggle.addEventListener("change", () => {
            textArea.classList.remove("hidden");
        });
        docUploadToggle.addEventListener("change", () => {
            textArea.classList.add("hidden");
        });

        // File input logic
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $("companyDocumentsFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                    // Automatically select "Use Document Above"
                    docUploadToggle.checked = true;
                    docUploadToggle.disabled = false;
                    docUploadToggle.nextElementSibling.classList.remove("opacity-50", "cursor-not-allowed");
                    textInputToggle.checked = false;
                    textArea.classList.add("hidden");
                } else {
                    fileNameSpan.textContent = "Click to select a file...";
                    label.classList.remove("has-file");
                    // Revert to text input
                    docUploadToggle.checked = false;
                    docUploadToggle.disabled = true;
                    docUploadToggle.nextElementSibling.classList.add("opacity-50", "cursor-not-allowed");
                    textInputToggle.checked = true;
                    textArea.classList.remove("hidden");
                }
            });
        }
        
        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult")); // Re-attach tab listeners for the 4-tab layout
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated objectives framework will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // Attach listener for the feedback link manually (Safeguard)
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.removeEventListener("click", handleNavLinkClick); // Avoid duplicates
            feedbackLink.addEventListener("click", handleNavLinkClick);
        }
    }

    /**
     * HANDLER: Objectives (DEEP ANALYSIS v4 - True Async)
     * - Triggers both the deep Ollama call and the n8n workflow.
     * - Relies on `handleWebSocketMessage` to catch the n8n data.
     * - Relies on `attemptMergeAndRender` to combine the results.
     */
   async function handleObjectivesAnalysis() {
        const analysisResultContainer = document.getElementById("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8">
                                                <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                                                <h3 class="text-xl font-semibold text-white mb-4">Running Dual S.M.A.R.T. Analysis...</h3>
                                                <p id="analysisStatus" class="text-white/80 mb-2">Initializing n8n and Ollama requests...</p>
                                             </div>`;
        setLoading("generate", true);

        // --- 1. Reset state and create a unique ID for this analysis ---
        pendingOllamaResult = null;
        pendingN8nResult = null;
        currentAnalysisMessageId = `analysis_${Date.now()}`;
        currentAnalysisContext = null; 
        console.log(`Starting analysis with ID: ${currentAnalysisMessageId}`);

        let text = ""; 
        const n8nFormData = new FormData(); 

        try {
            // 2. Gather Inputs
            // Note: createObjectivesLayout uses 'docUpload' radio
            const useDoc = document.getElementById("docUpload").checked;
            
            // Get common fields
            const companyName = document.getElementById("companyName").value.trim() || "The organization";
            const location = document.getElementById("location").value.trim() || "unspecified location";

            if (useDoc) {
                // --- FILE MODE ---
                const fileInput = document.getElementById("companyDocumentsFile");
                const file = fileInput ? fileInput.files[0] : null;
                
                if (!file) throw new Error("Please select a document.");
                
                // Read text for Ollama (Client-side Deep Analysis)
                text = await extractTextFromFile(file);
                
                // Append actual file for n8n (RAG/Workflow)
                n8nFormData.append("file", file, file.name);
            } else {
                // --- TEXT INPUT MODE (VIRTUAL FILE) ---
                const textInput = document.getElementById("objectivesContent"); // Specific ID for Objectives layout
                text = textInput ? textInput.value.trim() : "";
                
                if (!text) throw new Error("Please provide your high-level goal or context.");
                
                // Create a Virtual File (Blob) so n8n treats it EXACTLY like a file upload
                // This prevents the 500 error caused by missing binary data
                const textBlob = new Blob([text], { type: 'text/plain' });
                n8nFormData.append("file", textBlob, "context_input.txt");
            }
            
            // Append Metadata
            n8nFormData.append("customerName", companyName);
            n8nFormData.append("location", location);
            n8nFormData.append("messageId", currentAnalysisMessageId); 

            // Create full context for Ollama
            let fullContext = `Company: ${companyName}\nLocation: ${location}\n\nContext:\n${text}`;
            currentAnalysisContext = fullContext; 

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) throw new Error("Please log in to generate analysis.");

            // 3. Define the TWO fetch functions

            // --- Function A: Trigger n8n Workflow ---
            async function triggerN8N_Objectives() {
                const N8N_OBJECTIVES_URL = "https://n8n.data2int.com/webhook/objectives-v1";
                console.log(`Sending data to n8n workflow at ${N8N_OBJECTIVES_URL}...`);
                
                const response = await fetch(N8N_OBJECTIVES_URL, {
                    method: "POST",
                    headers: { 'Authorization': `Bearer ${session.access_token}` },
                    body: n8nFormData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`n8n Trigger Error: ${response.status} - ${errorText}`);
                }
                
                // Check if immediate JSON returned (some workflows do this instead of WS)
                // We log it but rely on the WebSocket for the table data usually
                const n8nJson = await response.json();
                console.log("n8n workflow triggered, received immediate response:", n8nJson);
            }

            // --- Function B: Call Ollama Directly (Deep Analysis) ---
            async function fetchOllama_Objectives() {
                const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
                const MODEL_NAME = "llama3.1:latest";
                
                let ollamaText = fullContext;
                const MAX_CONTEXT_LENGTH = 15000;
                if (ollamaText.length > MAX_CONTEXT_LENGTH) {
                    ollamaText = ollamaText.substring(0, MAX_CONTEXT_LENGTH);
                }

                const prompt = `
                    You are an expert strategic planner. Analyze the user's provided goal/context **based ONLY on the text itself** and formulate a set of 3-5 detailed S.M.A.R.T. objectives.

                    **USER'S GOAL / CONTEXT:**
                    \`\`\`
                    ${ollamaText}
                    \`\`\`

                    **VALIDATION:**
                    If the text is gibberish/nonsense, return the INVALID JSON.

                    **DETAILED TASKS:**
                    1.  **Refine Main Goal:** Provide a concise, 1-sentence summary of the user's primary goal (\`main_goal\`) **based ONLY on the text**.
                    2.  **Formulate S.M.A.R.T. Objectives:** Create an array of 3-5 \`smart_objectives\`. For EACH objective, provide the following **strictly derived from the user's text**:
                        * \`objective_name\`: A clear, concise name for the objective.
                        * \`smart_breakdown\`: A nested object detailing each component:
                            * \`specific\`: What exactly will be achieved? (Be very specific, using details from the text).
                            * \`measurable\`: How will success be measured? (Identify the key metric mentioned or implied in the text).
                            * \`achievable\`: Why is this achievable? (Reference resources, strengths, or context from the text).
                            * \`relevant\`: Why is this relevant to the \`main_goal\`? (Link it directly to the user's context).
                            * \`time_bound\`: What is the timeframe? (Infer a realistic timeframe, e.g., "within 6 months", "by EOY", based on the text's scope).
                        * \`key_actions\`: A list of 2-3 high-level action items **from the text** needed to start this objective.
                        * \`potential_risks\`: A list of 1-2 potential risks **from the text** that could endanger this specific objective.
                    3.  **Self-Correction:** Rigorously check: Is the main goal from text? Is EVERY detail of the SMART breakdown (S, M, A, R, T), key actions, and risks **strictly derived ONLY from the user's text**? Is the JSON perfect? Fix errors.

                    **ABSOLUTE CONSTRAINTS:**
                    - **CONTEXT IS KING:** Base **ALL** output **EXCLUSIVELY** on the provided "USER'S GOAL / CONTEXT". **DO NOT** invent information.
                    - **JSON FORMAT:** Adhere EXACTLY.

                    **RETURN FORMAT:**
                    Provide ONLY a valid JSON object.
                    {
                      "main_goal": "[Refined main goal summary ONLY from user text]",
                      "smart_objectives": [
                        {
                          "objective_name": "[Objective 1 Name ONLY from text]",
                          "smart_breakdown": {
                            "specific": "[Specific goal detail ONLY from text...]",
                            "measurable": "[Metric/KPI ONLY from text...]",
                            "achievable": "[Reason it's achievable ONLY from text...]",
                            "relevant": "[Relevance to main goal ONLY from text...]",
                            "time_bound": "[Timeframe inferred ONLY from text...]"
                          },
                          "key_actions": ["[Action 1 ONLY from text]", "[Action 2 ONLY from text]"],
                          "potential_risks": ["[Risk 1 ONLY from text]"]
                        }
                      ]
                    }
                `;

                console.log(`Sending S.M.A.R.T. Objectives prompt directly to ${MODEL_NAME}...`);
                const response = await fetch(OLLAMA_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
                });

                if (!response.ok) {
                    let errorBody = `API error ${response.status}`;
                    try { errorBody += `: ${await response.text()}`; } catch (e) {}
                    throw new Error(errorBody);
                }
                
                const data = await response.json();
                const ollamaJson = JSON.parse(data.response); // Ollama returns JSON *inside* a string
                if (!ollamaJson.main_goal || !ollamaJson.smart_objectives) {
                     throw new Error("Direct Ollama call returned an invalid JSON structure.");
                }
                
                pendingOllamaResult = ollamaJson; 
                attemptMergeAndRender(); 
            }
            
            // 4. Trigger both functions.
            triggerN8N_Objectives().catch(err => {
                console.error("n8n Trigger Failed:", err.message);
                pendingN8nResult = []; // Fulfill n8n with an empty array on failure
                attemptMergeAndRender(); 
            });
            
            fetchOllama_Objectives().catch(err => {
                console.error("Ollama Call Failed:", err.message);
                pendingOllamaResult = {
                    main_goal: "Deep analysis failed.",
                    smart_objectives: []
                };
                attemptMergeAndRender(); 
            });

        } catch (error) {
            console.error(`Error in handleObjectivesAnalysis (Setup):`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
            currentAnalysisContext = null; 
        }
    }

   /**
     * RENDERER: Objectives (DEEP ANALYSIS v4 - 5 TABS)
     * - Renders the 5-tab layout.
     * - Tabs 1-3 are populated from the deep `data.ollama_data`
     * - Tab 4 is populated from the parsed `data.n8n_data`
     */
    function renderObjectivesPage(container, data) {
        // --- THIS IS THE FIX FOR SPACING ---
        container.style.whiteSpace = 'normal';
        // --- END OF FIX ---
        
        container.innerHTML = ""; // Clear loading indicator

        const { ollama_data, n8n_data } = data;

        // --- Validation ---
        if (!ollama_data || !ollama_data.main_goal || !Array.isArray(ollama_data.smart_objectives) ||
            !Array.isArray(n8n_data)) {
            console.error("Invalid data passed to renderObjectivesPage:", data);
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Merged analysis data is incomplete or has the wrong structure.</div>`;
            $("analysisActions").classList.add("hidden");
            return;
        }
        
        const { main_goal, smart_objectives } = ollama_data;

        // --- Create Tab Navigation (5 Tabs) ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
            <button class="analysis-tab-btn" data-tab="details"> S.M.A.R.T. Details</button>
            <button class="analysis-tab-btn" data-tab="plan"> Actions & Risks</button>
            <button class="analysis-tab-btn" data-tab="n8n"> n8n Table</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn S.M.A.R.T.</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels (5 Panels) ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        // Added padding (p-4 or p-6) to each panel
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active p-4 md:p-6"></div>
            <div id="detailsPanel" class="analysis-tab-panel p-4 md:p-6"></div>
            <div id="planPanel" class="analysis-tab-panel p-4 md:p-6"></div>
            <div id="n8nPanel" class="analysis-tab-panel p-4 md:p-6"></div>
            <div id="learnPanel" class="analysis-tab-panel p-4 md:p-6"></div>
        `;

        // --- 1. Populate Dashboard Panel ---
        const dashboardPanel = $("dashboardPanel");
        let dashboardHtml = `<div class="space-y-8">
            <div class="p-6 rounded-lg bg-black/20 border border-white/10 text-center glass-container max-w-3xl mx-auto">
                <h3 class="text-xl font-bold mb-2 text-indigo-300"> Main Goal (from Context)</h3>
                <p class="text-2xl italic text-white/90">${main_goal}</p>
            </div>
            <h3 class="text-2xl font-bold text-center">Formulated S.M.A.R.T. Objectives (${smart_objectives.length})</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
        
        if (smart_objectives.length > 0) {
            smart_objectives.forEach((obj) => {
                const breakdown = obj.smart_breakdown || {};
                dashboardHtml += `
                    <div class="kpi-card">
                        <div><p class="kpi-name">${obj.objective_name || 'Unnamed Objective'}</p></div>
                        <div class="my-4">
                            <p class="text-xs text-white/70">Measurable By:</p>
                            <p class="text-lg font-bold text-indigo-300">${breakdown.measurable || 'N/A'}</p>
                        </div>
                        <div><p class="kpi-type">${breakdown.time_bound || 'N/A'}</p></div>
                    </div>`;
            });
        } else {
            dashboardHtml += `<p class="col-span-full text-center text-white/60 italic">No S.M.A.R.T. objectives were generated by the deep analysis.</p>`;
        }
        dashboardHtml += `</div></div>`;
        dashboardPanel.innerHTML = dashboardHtml;

        // --- 2. Populate S.M.A.R.T. Details Panel ---
        const detailsPanel = $("detailsPanel");
        let detailsHtml = `<div class="space-y-6"><h3 class="text-2xl font-bold mb-4 text-center"> S.M.A.R.T. Details</h3>`;
        if (smart_objectives.length > 0) {
            smart_objectives.forEach((obj) => {
                const s = obj.smart_breakdown || {}; 
                detailsHtml += `
                    <div class="bg-black/20 p-5 rounded-lg border-l-4 border-indigo-400 glass-container max-w-4xl mx-auto">
                        <h4 class="text-xl font-bold mb-4">${obj.objective_name || 'Unnamed Objective'}</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                            <div class="border-b border-white/10 pb-2"><strong>S (Specific):</strong><br><span class="text-white/80">${s.specific || 'N/A'}</span></div>
                            <div class="border-b border-white/10 pb-2"><strong>M (Measurable):</strong><br><span class="text-white/80">${s.measurable || 'N/A'}</span></div>
                            <div class="border-b border-white/10 pb-2"><strong>A (Achievable):</strong><br><span class="text-white/80">${s.achievable || 'N/A'}</span></div>
                            <div class="border-b border-white/10 pb-2"><strong>R (Relevant):</strong><br><span class="text-white/80">${s.relevant || 'N/A'}</span></div>
                            <div class="border-b border-white/10 pb-2 col-span-full"><strong>T (Time-bound):</strong><br><span class="text-white/80">${s.time_bound || 'N/A'}</span></div>
                        </div>
                    </div>
                `;
            });
        }
        detailsHtml += `</div>`;
        detailsPanel.innerHTML = detailsHtml;

        // --- 3. Populate Actions & Risks Panel ---
        const planPanel = $("planPanel");
        let planHtml = `<div class="space-y-6"><h3 class="text-2xl font-bold mb-4 text-center"> Actions & Risks</h3>`;
        if (smart_objectives.length > 0) {
            smart_objectives.forEach((obj) => {
                planHtml += `
                    <div class="prescription-card max-w-4xl mx-auto">
                        <h4 class="text-xl font-bold">${obj.objective_name || 'Unnamed Objective'}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                            <div class="bg-black/20 p-3 rounded">
                                <h5 class="font-bold text-green-300 mb-2">Key Actions</h5>
                                <ul class="list-disc list-inside space-y-1 text-white/90">
                                    ${(obj.key_actions && obj.key_actions.length > 0) 
                                        ? obj.key_actions.map(a => `<li>${a}</li>`).join('') 
                                        : '<li>No specific actions identified.</li>'}
                                </ul>
                            </div>
                            <div class="bg-black/20 p-3 rounded">
                                <h5 class="font-bold text-red-300 mb-2">Potential Risks</h5>
                                <ul class="list-disc list-inside space-y-1 text-white/90">
                                    ${(obj.potential_risks && obj.potential_risks.length > 0) 
                                        ? obj.potential_risks.map(r => `<li>${r}</li>`).join('') 
                                        : '<li>No specific risks identified.</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        planHtml += `</div>`;
        planPanel.innerHTML = planHtml;

        // --- 4. Populate n8n Table Panel (NEW) ---
        const n8nPanel = $("n8nPanel");
        let n8nHtml = `<div class="space-y-6">
                        <h3 class="text-3xl font-bold text-center mb-8"> n8n Workflow Output</h3>
                        <p class="text-center text-white/70 italic text-sm max-w-2xl mx-auto -mt-6">
                            This is the raw, table-based output from the base ` + "`objectives-v1`" + ` workflow, as parsed by the AI.
                        </p>
                        <div class="max-w-6xl mx-auto overflow-x-auto">
                            <table class="coeff-table styled-table text-sm">`;
        
        if (n8n_data.length > 0) {
            const headers = Object.keys(n8n_data[0]);
            n8nHtml += `<thead><tr>`;
            headers.forEach(h => {
                n8nHtml += `<th>${h}</th>`;
            });
            n8nHtml += `</tr></thead><tbody>`;

            n8n_data.forEach(row => {
                n8nHtml += `<tr>`;
                headers.forEach(h => {
                    n8nHtml += `<td class="text-white/80">${row[h] || 'N/A'}</td>`;
                });
                n8nHtml += `</tr>`;
            });
            n8nHtml += `</tbody>`;
        } else {
            n8nHtml += `<tbody><tr><td class="text-center text-white/70 italic p-4">No data was returned from the n8n workflow.</td></tr></tbody>`;
        }
        n8nHtml += `</table></div></div>`;
        n8nPanel.innerHTML = n8nHtml;


        // --- 5. Populate Learn S.M.A.R.T. Panel ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
        <div class="space-y-6 text-white/90 glass-container max-w-4xl mx-auto p-6 md:p-10">
            <h3 class="text-3xl font-bold text-center mb-4"> Understanding S.M.A.R.T. Objectives</h3>
            
            

[Image of S.M.A.R.T. acronym breakdown]


            <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                <h4 class="text-xl font-bold mb-2 text-indigo-300">What does S.M.A.R.T. stand for?</h4>
                <p class="text-sm text-white/80">S.M.A.R.T. is a mnemonic acronym used to guide the setting of goals and objectives. To be S.M.A.R.T., an objective must be:</p>
            </div>

            <div class="space-y-4">
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-blue-400">
                    <h4 class="text-lg font-bold text-blue-300">S - Specific</h4>
                    <p class="text-sm text-white/80">Clearly state what needs to be accomplished. Answer the "W" questions: Who, What, Where, When, Which, Why.</p>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-green-400">
                    <h4 class="text-lg font-bold text-green-300">M - Measurable</h4>
                    <p class="text-sm text-white/80">Define concrete criteria for measuring progress and success. How will you know when it's done? (e.g., "Increase sales by 10%").</p>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-yellow-400">
                    <h4 class="text-lg font-bold text-yellow-300">A - Achievable</h4>
                    <p class="text-sm text-white/80">The objective should be challenging but realistic and attainable given available resources, constraints, and time.</p>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-red-400">
                    <h4 class="text-lg font-bold text-red-300">R - Relevant</h4>
                    <p class="text-sm text-white/80">The objective must align with the broader business goals and overall strategy. It must be worthwhile.</p>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-purple-400">
                    <h4 class="text-lg font-bold text-purple-300">T - Time-bound</h4>
                    <p class="text-sm text-white/80">The objective must have a clear target date or timeframe (e.g., "by the end of Q3", "within 6 months"). This creates urgency.</p>
                </div>
            </div>
            
             <div class="bg-black/20 p-4 rounded-lg mt-6 border border-white/10">
                <h4 class="text-lg font-bold mb-2">Why Use S.M.A.R.T.?</h4>
                 <ul class="list-disc list-inside space-y-1 text-sm">
                    <li>Provides clarity and focus for everyone involved.</li>
                    <li>Eliminates ambiguity and sets clear expectations.</li>
                    <li>Makes it easy to track progress and identify when you've succeeded.</li>
                    <li>Ensures that objectives are aligned with the company's main goals.</li>
                </ul>
            </div>
        </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache the merged result
        $("analysisActions").classList.remove("hidden"); // Show the 'Save PDF' / 'Save DOCX' buttons

        // Add tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add("active");
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });
    }

    async function handleVisualizationAnalysis_DA() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div></div><div></div><div></div> </div><h3 class="text-xl font-semibold text-white mb-4">Performing Visualization Analysis...</h3><p class="text-white/80 mb-2">Loading data, performing calculations, and generating insights...</p></div>`;
        setLoading("generate", true);
        $("analysisActions").classList.add("hidden");
        const API_URL = "https://analysis.sageaios.com/api/visualization";
        
        try {
            const formData = new FormData();

            if (window.isSampleModeActive === true && window.tempSampleDataFile) {
                console.log("Using Global Sample Data for Visualization");
                formData.append("data_file", window.tempSampleDataFile, window.tempSampleDataFile.name);
                if (window.tempSampleContextFile) {
                    formData.append("context_file", window.tempSampleContextFile, window.tempSampleContextFile.name);
                }
            } else {
                // --- MANUAL MODE ---
                const dataFile = $("vizFile").files[0];
                if (!dataFile) {
                    throw new Error(" Please upload a CSV data file.");
                }
                formData.append("data_file", dataFile, dataFile.name);

                const isUsingFile = $("vizInputFileToggle").checked;
                if (isUsingFile) {
                    const contextFile = $("vizContextFile").files[0];
                    if (contextFile) {
                        formData.append("context_file", contextFile, contextFile.name);
                    }
                } else {
                    const vizRequestText = $("vizRequestText").value.trim();
                    if (vizRequestText) {
                        const contextBlob = new Blob([vizRequestText], { type: 'text/plain' });
                        formData.append("context_file", contextBlob, "visualization_context.txt");
                    }
                }
            }
            
            // 4. Send Request
            const response = await fetch(API_URL, {
                method: "POST",
                body: formData,
            });
            if (!response.ok) {
                let errorDetail = `API Error: ${response.status}`;
                try {
                    const errorJson = await response.json();
                    errorDetail = errorJson.detail || `API Error: ${response.status} - ${response.statusText}`;
                } catch (e) {
                    errorDetail = `API Error: ${response.status} - ${response.statusText}`;
                }
                throw new Error(errorDetail);
            }
            const parsedData = await response.json();
            
            if (parsedData.metadata && parsedData.metadata.error) {
                throw new Error(`Backend Analysis Error: ${parsedData.metadata.error_message}`);
            }
            // 5. Render
            renderVisualizationPage_DA(analysisResultContainer, parsedData);
        } catch (error) {
            console.error(`Error in handleVisualizationAnalysis_DA (Backend):`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        }
        finally {
            window.isSampleModeActive = false; // Reset the flag
            if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
            }
        }
    }

    /**
     * --- UPDATED (V15) ---
     * Renders the full Visualization Analysis page.
     * - ADDS a "Warnings & Diagnostics" tab.
     * - MOVES the data quality and correlation warnings from the
     * "Summary" tab to the new "Warnings" tab.
     * - Calls a new helper, renderVizWarningsPanel, to populate it.
     */
    function renderVisualizationPage_DA(container, data) {
        container.innerHTML = ""; // Clear loading state

        const { dataset_info, visualizations, suggestions, insights, metadata } = data;

        // Basic validation
        if (!dataset_info || !visualizations || !suggestions || !insights) {
            console.error("Incomplete data passed to renderVisualizationPage_DA:", data);
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Incomplete or invalid analysis data received. Cannot render Visualization results.</div>`;
            $("analysisActions").classList.add("hidden");
            setLoading("generate", false);
            return;
        }

        // --- 1. Define Chart Theme (Same as before) ---
        const colorPrimary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#8E2DE2';
        const colorAccent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#C33764';
        const colorGrad2 = getComputedStyle(document.documentElement).getPropertyValue('--grad-2').trim() || '#1D2671';
        const colorPalette = [colorPrimary, colorAccent, '#3B82F6', '#10B981', '#F59E0B', '#4A00E0', '#EF4444', colorGrad2];
        const baseLayout = {
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(0,0,0,0.1)",
            font: { color: "white", size: 14, family: "'Inter', sans-serif" },
            title: { 
                font: { size: 20, color: 'white' },
                pad: { t: 5, b: 20 },
                x: 0.05, 
                xanchor: 'left'
            },
            xaxis: {
                title: { text: '', font: { size: 16, color: 'rgba(255,255,255,0.7)' } },
                gridcolor: "rgba(255,255,255,0.1)",
                automargin: true,
                tickangle: -30,
                zeroline: false,
                tickfont: { size: 13, color: 'rgba(255,255,255,0.8)' }
            },
            yaxis: {
                title: { text: '', font: { size: 16, color: 'rgba(255,255,255,0.7)' } },
                gridcolor: "rgba(255,255,255,0.1)",
                automargin: true,
                zeroline: false,
                tickfont: { size: 13, color: 'rgba(255,255,255,0.8)' }
            },
            margin: { t: 60, b: 100, l: 80, r: 40 }, 
            showlegend: true,
            legend: {
                font: { size: 12, color: 'white' },
                orientation: 'h',
                y: -0.3, 
                yanchor: 'top',
                bgcolor: 'rgba(0,0,0,0.2)',
                bordercolor: 'rgba(255,255,255,0.2)',
                borderwidth: 1,
                padding: 4
            },
            hoverlabel: {
                bgcolor: '#111827',
                bordercolor: 'rgba(255,255,255,0.3)',
                font: { size: 14, color: 'white' }
            }
        };

        // --- 2. Create Tab Navigation (ADDED "Warnings" tab) ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="summary"> Summary & Insights</button>
            <button class="analysis-tab-btn" data-tab="visuals"> Visualizations</button>
            <button class="analysis-tab-btn" data-tab="suggestions"> Suggestions</button>
            <button class="analysis-tab-btn" data-tab="warnings"> Warnings & Diagnostics</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Viz</button>
        `;
        container.appendChild(tabNav);

        // --- 3. Create Tab Panels (ADDED "warningsPanel") ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="summaryPanel" class="analysis-tab-panel active"></div>
            <div id="visualsPanel" class="analysis-tab-panel"></div>
            <div id="suggestionsPanel" class="analysis-tab-panel"></div>
            <div id="warningsPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 4. Populate Summary & Insights Panel (CLEANED) ---
        const summaryPanel = $("summaryPanel");
        let summaryHtml = `<div class="p-4 space-y-8">
            <h3 class="text-2xl font-bold mb-6 text-center">Dataset Overview</h3>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-4xl mx-auto mb-8">
                <div class="summary-stat-card"><div class="stat-value">${dataset_info.rows}</div><div class="stat-label">Rows</div></div>
                <div class="summary-stat-card"><div class="stat-value">${dataset_info.columns}</div><div class="stat-label">Columns</div></div>
                <div class="summary-stat-card"><div class="stat-value">${Object.values(dataset_info.column_info).filter(c => c.data_type === 'numerical').length}</div><div class="stat-label">Numerical Cols</div></div>
                <div class="summary-stat-card"><div class="stat-value">${Object.values(dataset_info.column_info).filter(c => c.data_type === 'categorical').length}</div><div class="stat-label">Categorical Cols</div></div>
            </div>
            
            <h3 class="text-2xl font-bold mb-4"> Actionable Insights (from AI)</h3>

            <p class="text-sm text-white/70 italic mb-6">For important caveats about this analysis, please see the <strong>" Warnings & Diagnostics"</strong> tab.</p>


            <div class="space-y-6">`;
        if (insights.length > 0 && insights[0].observation !== "Error") {
            insights.forEach((insight, index) => {
                summaryHtml += `<div class="insight-card border-l-4 border-indigo-400">
                    <p class="text-xs font-semibold text-indigo-300 mb-1">INSIGHT ${index + 1}</p>
                    <p class="mb-2"><strong>Observation:</strong> ${insight.observation}</p>
                    <p class="mb-2 text-sm text-white/80"><strong>Interpretation:</strong> ${insight.interpretation}</p>
                    <div class="p-3 bg-black/20 rounded mt-3">
                        <p class="text-sm"><strong>Recommendation:</strong> ${insight.recommendation}</p>
                    </div>
                </div>`;
            });
        } else {
            summaryHtml += `<p class="text-center text-white/70 italic">No specific AI insights were generated based on the context.</p>`;
        }
        summaryHtml += `</div></div>`;
        summaryPanel.innerHTML = summaryHtml;

        // --- 5. Populate Visualizations Panel (HTML Structure) (Unchanged) ---
        const visualsPanel = $("visualsPanel");
        let visualsHtml = `<div class="p-4 space-y-8">
                            <h3 class="text-2xl font-bold mb-4 text-center">Generated Visualizations</h3>`;
        if (visualizations.length > 0) {
            visualsHtml += `<div class="flex flex-wrap justify-center gap-8">`;
            
            visualizations.forEach((viz, index) => {
                // ... (code for rendering chart/table placeholders is unchanged) ...
                if (viz.error) {
                    visualsHtml += `<div class="w-full lg:w-[48%] bg-black/10 rounded-lg p-2 shadow-lg"> 
                        <div class="p-4 text-center text-red-400">
                            <h4 class="font-bold mb-2">${viz.title || 'Chart Error'}</h4>
                            Could not render chart: ${viz.error}
                        </div>
                    </div>`;
                } else if (viz.chart_type === "frequency_table") {
                    visualsHtml += `<div class="w-full lg:w-[48%] bg-black/10 rounded-lg p-4 shadow-lg">
                                      <h4 class="text-lg font-bold mb-3 text-center">${viz.title}</h4>
                                      <div class="overflow-y-auto max-h-[480px]">
                                        <table class="coeff-table styled-table text-sm w-full">
                                          <thead><tr><th>Value</th><th>Freq.</th><th>%</th><th>Cumul. %</th></tr></thead>
                                          <tbody>`;
                    (viz.data.table || []).forEach(row => {
                        visualsHtml += `<tr>
                                          <td>${row.value}</td>
                                          <td>${row.frequency}</td>
                                          <td>${row.percentage.toFixed(1)}%</td>
                                          <td>${row.cumulative_percentage.toFixed(1)}%</td>
                                        </tr>`;
                    });
                    visualsHtml += `</tbody></table></div>
                                    <p class="text-xs text-center text-white/70 italic mt-2 p-1">${viz.suggestion_reason || ''}</p>
                                  </div>`;
                } else {
                    visualsHtml += `<div class="w-full lg:w-[48%] bg-black/10 rounded-lg p-2 shadow-lg"> 
                                    <div id="viz-chart-${index}" class="w-full h-[500px] plotly-chart"></div>
                                    <p class="text-xs text-center text-white/70 italic mt-2 p-1">${viz.suggestion_reason || ''}</p>
                                  </div>`;
                }
            });
            visualsHtml += `</div>`;
        } else {
            visualsHtml += `<p class="text-center text-white/70">No visualizations were generated.</p>`;
        }
        visualsHtml += `</div>`;
        visualsPanel.innerHTML = visualsHtml;

        // --- 6. Populate Suggestions Panel (Unchanged) ---
        const suggestionsPanel = $("suggestionsPanel");
        let suggestionsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Further Visualization Suggestions</h3>`;
        suggestionsHtml += `
            <blockquote class="p-3 italic border-l-4 border-blue-400 bg-blue-900/20 text-blue-200 text-sm mb-6">
                <strong>Note:</strong> These are general suggestions based on your data's column types. 
                Cross-reference these ideas with the specific findings in the <strong>"Summary & Insights"</strong> tab for more targeted analysis.
            </blockquote>
        `;
        if (suggestions && suggestions.length > 0) {
            suggestionsHtml += `<div class="overflow-x-auto">
                                <table class="coeff-table styled-table text-sm">
                                 <thead><tr><th>Suggested Chart</th><th>Columns Involved</th><th>Reason</th></tr></thead>
                                <tbody>`;
            suggestions.forEach((s) => {
                suggestionsHtml += `<tr>
                    <td class="font-semibold">${s.title}</td>
                    <td class="text-white/80">${s.columns.join(', ')}</td>
                    <td class="text-white/70 italic">${s.reason}</td>
                </tr>`;
            });
            suggestionsHtml += `</tbody></table></div>`;
        } else {
            suggestionsHtml += `<p class="text-center text-white/70 italic">No further suggestions could be generated.</p>`;
        }
        suggestionsHtml += `</div>`;
        suggestionsPanel.innerHTML = suggestionsHtml;

        // --- 7. NEW: Populate Warnings Panel ---
        const warningsPanel = $("warningsPanel");
        renderVizWarningsPanel(warningsPanel, dataset_info); // Call new helper function

        // --- 8. Populate Learn Viz Panel (Unchanged) ---
        const learnPanel = $("learnPanel");
        renderLearnVizPanel(learnPanel, dataset_info); 

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- 9. Tab Switching & Chart Rendering Logic (Unchanged) ---
        analysisCache[currentTemplateId] = container.innerHTML;

        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add("active");
                    const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                    chartsInPanel.forEach(chartDiv => {
                        if (chartDiv.layout && typeof Plotly !== 'undefined') {
                            try { Plotly.Plots.resize(chartDiv); } catch (resizeError) { console.error(`Error resizing chart ${chartDiv.id}:`, resizeError); }
                        }
                    });
                }
            }
        });
        
        // ... (Chart rendering setTimeout block remains exactly the same) ...
        setTimeout(() => {
             const visualsTabPanel = $("visualsPanel");
             if (visualsTabPanel) {
                 visualsTabPanel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                     if (!chartDiv.layout && typeof Plotly !== 'undefined') {
                         const index = parseInt(chartDiv.id.split('-')[2]);
                         const viz = visualizations[index];
                         if (viz && !viz.error && viz.chart_type !== 'frequency_table') {
                             try {
                                 let traces = [];
                                 let layout = JSON.parse(JSON.stringify(baseLayout)); 
                                 layout.title.text = viz.title;
                                 layout.xaxis.title.text = viz.x_label;
                                 layout.yaxis.title.text = viz.y_label;

                                // (all the if/else if blocks for chart types...)
                                if (viz.chart_type === "histogram" && viz.data.values) {
                                    traces = [{ x: viz.data.values, type: "histogram", marker: { color: colorPrimary, line:{color:'rgba(255,255,255,0.3)', width:0.5} } }];
                                    layout.bargap = 0.05;
                                    layout.showlegend = false;
                                } else if (viz.chart_type === "bar" && viz.data.categories) {
                                    traces = [{ 
                                        x: viz.data.categories, 
                                        y: viz.data.values, 
                                        type: "bar", 
                                        marker: { 
                                            color: viz.data.categories.map((_, i) => colorPalette[i % colorPalette.length])
                                        } 
                                    }];
                                    layout.showlegend = false;
                                } else if (viz.chart_type === "pie" && viz.data.labels) {
                                    traces = [{ 
                                        labels: viz.data.labels, 
                                        values: viz.data.values, 
                                        type: "pie", 
                                        hole: 0.4, 
                                        textinfo: "percent+label",
                                        marker: { colors: colorPalette }
                                    }];
                                    layout.showlegend = true;
                                    layout.margin = { t: 60, b: 80, l: 50, r: 50 };
                                    layout.legend.y = -0.3;
                                } else if (viz.chart_type === "scatter" && viz.data.x) {
                                    const correlation = viz.data.correlation || 0;
                                    const rSquared = (correlation ** 2).toFixed(3);
                                    traces = [{ x: viz.data.x, y: viz.data.y, mode: 'markers', type: 'scatter', marker: { color: colorPrimary, opacity: 0.7, size: 8 } }];
                                    
                                    layout.title.text = `${viz.title} <br><span style="font-size: 16px; color: ${colorAccent};">Corr: ${correlation.toFixed(3)} | R: ${rSquared}</span>`;
                                    layout.showlegend = false;
                                } else if (viz.chart_type === "line" && viz.data.x) {
                                    traces = [{ 
                                        x: viz.data.x, 
                                        y: viz.data.y, 
                                        mode: 'lines+markers',
                                        type: 'scatter', 
                                        line: { color: colorAccent, width: 3 },
                                        marker: { size: 6, color: colorAccent }
                                    }];
                                    layout.showlegend = false;
                                } else if (viz.chart_type === "box" && viz.data) {
                                    traces = [{ 
                                        y: viz.data.values, 
                                        type: 'box', 
                                        name: viz.x_label, 
                                        boxpoints: 'Outliers',
                                        marker: { color: colorPrimary },
                                        boxmean: 'sd'
                                    }];
                                    layout.yaxis.zeroline = false;
                                    layout.showlegend = false;
                                } else if (viz.chart_type === "box_grouped" && viz.data) {
                                    let i = 0;
                                    for (const groupName in viz.data) {
                                        traces.push({ 
                                            y: viz.data[groupName].values, 
                                            type: 'box', 
                                            name: groupName, 
                                            boxpoints: 'Outliers',
                                            boxmean: 'sd',
                                            marker: { color: colorPalette[i % colorPalette.length] }
                                        });
                                        i++;
                                    }
                                    layout.yaxis.zeroline = false;
                                    layout.showlegend = true;
                                    layout.boxmode = 'group';
                                } else if (viz.chart_type === "area" && viz.data.x && viz.data.series) {
                                    let i = 0;
                                    for (const seriesName in viz.data.series) {
                                        traces.push({ 
                                            x: viz.data.x, 
                                            y: viz.data.series[seriesName], 
                                            type: 'scatter', 
                                            mode: 'lines', 
                                            name: seriesName, 
                                            fill: 'tozeroy',
                                            line: { color: colorPalette[i % colorPalette.length] }
                                        });
                                        i++;
                                    }
                                    layout.showlegend = true;
                                } else if (viz.chart_type === "heatmap" && viz.data.correlation_matrix) {
                                    const zValues = viz.data.rows.map(row => {
                                        return viz.data.columns.map(col => {
                                            return viz.data.correlation_matrix[row][col];
                                        });
                                    });
                                    traces = [{ z: zValues, x: viz.data.columns, y: viz.data.rows, type: 'heatmap', colorscale: 'RdBu', zmin: -1, zmax: 1, showscale: true }];
                                    layout.xaxis.tickangle = -45;
                                    layout.margin = { t: 60, b: 120, l: 120, r: 50 };
                                    layout.showlegend = false;
                                } else if (viz.chart_type === "treemap" && viz.data.nodes) {
                                    traces = [{
                                        type: "treemap",
                                        labels: viz.data.nodes.map(n => n.name),
                                        values: viz.data.nodes.map(n => n.value),
                                        parents: viz.data.nodes.map(n => ""),
                                        textinfo: "label+value+percent root",
                                        marker: { colors: colorPalette }
                                    }];
                                    layout.margin = { t: 50, b: 20, l: 20, r: 20 };
                                    layout.showlegend = false;
                                } else {
                                     throw new Error(`Unsupported or invalid chart type: ${viz.chart_type}`);
                                }
                                 
                                Plotly.newPlot(chartDiv, traces, layout, { 
                                    responsive: true, 
                                    displaylogo: false, 
                                    modeBarButtonsToRemove: ['sendDataToCloud', 'select2d', 'lasso2d'],
                                    displayModeBar: true 
                                });
                                 
                             } catch (e) { 
                                 console.error("Initial render error:", e);
                                 chartDiv.innerHTML = `<div class="p-4 text-center text-red-400">Could not render chart for ${viz.title}.</div>`;
                             }
                         }
                     }
                 });
             }
        }, 150); 

        $("analysisActions").classList.remove("hidden");
        setLoading("generate", false);
    }

    /**
     * --- NEW FUNCTION (V15) ---
     * Renders the new "Warnings & Diagnostics" panel.
     * Moves warnings from the Summary tab to here for prominence.
     * Adds a new section on Statistical Significance.
     * Uses the user's updated row count logic.
     */
    function renderVizWarningsPanel(warningsPanel, dataset_info) {
        if (!warningsPanel || !dataset_info) {
            if(warningsPanel) warningsPanel.innerHTML = "<p class='p-4 text-white/60'>Could not load warnings.</p>";
            return;
        }

        let warningsHtml = `<div class="p-6 space-y-8 text-white/90 max-w-5xl mx-auto">
            <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-red-400 to-orange-400 bg-clip-text text-transparent">
                 Warnings & Diagnostics
            </h3>
            
            <div class="bg-red-900/20 p-6 rounded-lg border border-red-500/30">
                <h4 class="text-xl font-bold mb-3 text-red-300">Data Quality & Sufficiency</h4>`;
        
        // --- YOUR NEW WARNING LOGIC ---
        const dataRowCount = dataset_info.rows || 0;
        if (dataRowCount < 30) {
            warningsHtml += `<p class="text-red-200"><strong>CRITICAL WARNING:</strong> Your dataset has only <strong>${dataRowCount} rows</strong>. This is insufficient data for reliable visualization or statistical insights. Any patterns (like correlations) are highly likely to be due to random chance and should not be trusted for decision-making.</p>`;
        } else if (dataRowCount < 50) {
            warningsHtml += `<p class="text-yellow-200"><strong>WARNING:</strong> Your dataset has <strong>${dataRowCount} rows</strong>. This is a limited dataset. Basic charts may be useful, but findings (like correlations) have low statistical power and may not be reliable.</p>`;
        } else {
            warningsHtml += `<p class="text-green-300"><strong>CHECK:</strong> Your dataset has <strong>${dataRowCount} rows</strong>. This is a sufficient size for basic descriptive visualizations.</p>`;
        }
        // --- END YOUR LOGIC ---
        
        warningsHtml += `</div>

            <div class="bg-yellow-900/20 p-6 rounded-lg border border-yellow-500/30">
                <h4 class="text-xl font-bold mb-3 text-yellow-300">Interpretation Warning: Correlation is Not Causation</h4>
                <p class="text-white/90 leading-relaxed">
                    Your charts (especially scatter plots) show **correlation** (a mutual relationship), not **causation** (proof that one thing *causes* another). 
                </p>
                <p class="text-white/80 text-sm mt-2">
                    <strong>Example:</strong> A chart might show that \`Marketing_Spend\` and \`Sales_Revenue\` both go up together. This *does not prove* that spending more *caused* the sales. A third "lurking variable" (like a holiday season) could be causing both.
                </p>
                <p class="text-white/80 text-sm mt-2">
                    <strong>Action:</strong> Always use your business expertise to determine if a causal link is plausible.
                </p>
            </div>

            <div class="bg-blue-900/20 p-6 rounded-lg border border-blue-500/30">
                <h4 class="text-xl font-bold mb-3 text-blue-300">A Note on Statistical Significance</h4>
                <p class="text-white/90 leading-relaxed">
                    This tool performs **descriptive and exploratory** analysis. It shows you what is in the data.
                </p>
                <p class="text-white/80 text-sm mt-2">
                    It does **not** automatically run formal statistical tests (like t-tests or regression with p-values) to confirm if these findings are "statistically significant." A pattern you see in a small dataset could be due to random chance.
                </p>
                <p class="text-white/80 text-sm mt-2">
                    <strong>Action:</strong> Use these visualizations to form a <strong>hypothesis</strong>, then use a dedicated statistical tool (like the Regression or SEM tools in S.A.G.E.) to test that hypothesis formally.
                </p>
            </div>
        </div>`;

        warningsPanel.innerHTML = warningsHtml;
    }

    /**
     * --- NEW FUNCTION (V8) ---
     * Renders the improved, PURELY EDUCATIONAL "Learn Viz" panel.
     * - Removes all contextual data warnings and column name references.
     * - Focuses on explaining the "what" and "why" of chart types.
     * - Includes advanced concepts like statistical rigor and common pitfalls.
     */
    function renderLearnVizPanel(learnPanel, dataset_info) {
        if (!learnPanel) return;
        
        // This content is now static and purely educational.
        learnPanel.innerHTML = `
            <div class="p-6 space-y-8 text-white/90 max-w-5xl mx-auto">
                <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                     A Guide to Data Visualization
                </h3>
                
                <div class="bg-black/20 p-6 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-4 text-indigo-300">What is Data Visualization?</h4>
                    <p class="text-white/80 text-sm">
                        Data visualization is the practice of translating information into a visual context, such as a map or graph, to make data easier for the human brain to understand and pull insights from. The main goal is to identify patterns, trends, and outliers in large data sets.
                    </p>
                </div>

                <div class="bg-black/20 p-6 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-4 text-indigo-300">How to Read Different Chart Types</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                        <div>
                            <h5 class="font-semibold text-blue-300 mb-2">Distributions (Histograms & Box Plots)</h5>
                            <p class="text-white/80 mb-2">Use these to understand the shape of a numerical variable.</p>
                            <ul class="list-disc list-inside space-y-1 text-white/80">
                                <li><strong>Central Tendency:</strong> Where is the center (median) or peak (mode)?</li>
                                <li><strong>Spread:</strong> Is the data tightly clustered or widely spread out?</li>
                                <li><strong>Skewness:</strong> Is it symmetric, or does it have a long "tail" to one side?</li>
                                <li><strong>Outliers:</strong> Are there extreme values far from the main group?</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-semibold text-green-300 mb-2">Relationships (Scatter Plots)</h5>
                            <p class="text-white/80 mb-2">Use these to see how two numerical variables move together.</p>
                            <ul class="list-disc list-inside space-y-1 text-white/80">
                                <li><strong>Direction:</strong> Positive (both go up) or negative (one goes up, one goes down)?</li>
                                <li><strong>Strength:</strong> How tightly clustered are the points? (R value shows this).</li>
                                <li><strong>Pattern:</strong> Is the relationship a straight line (linear) or curved?</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-semibold text-yellow-300 mb-2">Compositions (Bar & Pie Charts)</h5>
                            <p class="text-white/80 mb-2">Use these to compare counts or values across categories.</p>
                            <ul class="list-disc list-inside space-y-1 text-white/80">
                                <li><strong>Magnitude:</strong> Which categories are the largest or smallest?</li>
                                <li><strong>Proportion:</strong> How much does each category contribute to the whole?</li>
                                <li><strong>Pareto Principle:</strong> Do a few categories account for most of the value?</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-semibold text-purple-300 mb-2">Trends (Line Charts)</h5>
                            <p class="text-white/80 mb-2">Use these to see how a variable changes over a time column.</p>
                            <ul class="list-disc list-inside space-y-1 text-white/80">
                                <li><strong>Trend:</strong> Is the overall direction upward, downward, or flat?</li>
                                <li><strong>Seasonality:</strong> Are there repeating cycles (e.g., peaks every summer)?</li>
                                <li><strong>Volatility:</strong> Is the line smooth or erratic and spiky?</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="bg-yellow-900/20 p-6 rounded-lg border border-yellow-500/30">
                    <h4 class="text-xl font-bold mb-3 text-yellow-300"> A Critical Warning: Correlation vs. Causation</h4>
                    <p class="text-white/90 leading-relaxed">
                        Charts (especially scatter plots) show **correlation**, not **causation**. 
                        Just because two variables move together does not *prove* that one *causes* the other.
                    </p>
                    <p class="text-white/80 text-sm mt-2">
                        A hidden "lurking variable" (e.g., seasonality, a market event) could be causing both to change. 
                        Always use your domain expertise to interpret these relationships.
                    </p>
                </div>

                <details class="styled-details bg-white/5 rounded-lg">
                    <summary class="font-semibold cursor-pointer p-4 text-lg text-red-300">Common Visualization Pitfalls to Avoid</summary>
                    <div class="px-6 pb-6 space-y-4 text-sm">
                        <div class="p-4 bg-red-900/20 border border-red-500/30 rounded">
                            <h5 class="font-semibold text-red-300 mb-2">Misleading Axes</h5>
                            <p class="text-white/80">Truncating the Y-axis (not starting at zero) on a bar chart can make small differences look massive. Be cautious when interpreting comparisons.</p>
                        </div>
                        <div class="p-4 bg-yellow-900/20 border border-yellow-500/30 rounded">
                            <h5 class="font-semibold text-yellow-300 mb-2">Cherry-Picking Data</h5>
                            <p class="text-white/80">Visualizing only a small date range or a specific subset of data can create a misleading impression that doesn't hold true for the entire dataset.</p>
                        </div>
                        <div class="p-4 bg-purple-900/20 border border-purple-500/30 rounded">
                            <h5 class="font-semibold text-purple-300 mb-2">Using the Wrong Chart</h5>
                            <p class="text-white/80">Using a line chart for non-time-based categorical data or a pie chart for data that doesn't sum to 100% can confuse and mislead the audience.</p>
                        </div>
                    </div>
                </details>

                <div class="text-center p-4 bg-black/20 rounded-lg border border-white/10">
                    <p class="text-xs text-white/60">
                        The best analysis combines these statistical findings with your deep knowledge of your business and industry.
                    </S.A.G.E.>
                </div>
            </div>
        `;
    }
        
    function createSystemActionsLayout_ST(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe a Problem in Your System</h3>
                             
                             <div class="mb-2">
                                <label for="systemActionLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="systemActionLocation" class="input-field" placeholder="e.g., Corporate HQ, Specific Plant, Global Supply Chain">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="systemActionContent" class="input-field h-48" placeholder="Describe a recurring problem. For example: 'Every time we hire more salespeople to boost revenue, our customer satisfaction drops and churn increases.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="systemActionFile" id="systemActionFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="systemActionFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Formulate Actions</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Systemic Action Plan</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("systemActionFile", "systemActionFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createSystemActionsLayout_ST");
        }
    }
    async function handleSystemActionsAnalysis_ST() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Diagnosing System Behavior & Formulating Actions...</h3><p class="text-white/80 mb-2">Generating analysis strictly based on your provided context...</p></div>`;
        setLoading("generate", true);

        // Define URL and Model
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Consistent model

        try {
            // 1. Gather Inputs
            const useDoc = $("docUpload").checked;
            let text = "";
            if (useDoc) {
                const file = $("systemActionFile").files[0];
                if (!file) throw new Error("Please select a document.");
                text = await extractTextFromFile(file);
            } else {
                text = $("systemActionContent").value.trim();
                if (!text.trim()) throw new Error("Please describe the system problem.");
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("systemActionLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
                console.log("Injected location into System Actions Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (text.length > MAX_CONTEXT_LENGTH) {
                text = text.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
                console.warn(`System Actions analysis context truncated.`);
            }

            // 2. Construct REFINED Prompt with STRONGER Context Grounding & ACTION CLASSIFICATION Rules
            const prompt = `
                You are an expert systems thinking consultant. A user has described a recurring problem or strategic initiative. Analyze it based **ONLY** on the provided text to diagnose the underlying system structure (archetype, if applicable) and prescribe **context-specific** actions, correctly classifying them as short-term fixes or long-term solutions based *only* on the text provided. ${truncatedNote}

                **USER'S SYSTEM PROBLEM/INITIATIVE DESCRIPTION:**
                \`\`\`
                ${text}
                \`\`\`

                **DETAILED TASKS:**
                **VALIDATION:**
                If the text is gibberish, return the INVALID structure.

                1.  **Diagnose Problem/Goal:** Provide a concise, one-sentence \`problem_diagnosis\` stating the core systemic issue or goal described **in the user's text**.
                2.  **Identify Archetype (If Applicable):** Identify the single most likely \`system_archetype\` (e.g., "Limits to Growth", "Shifting the Burden", etc.) evident **in the user's text**, *only if a clear recurring problem pattern is described*. If the text describes a *proactive initiative* rather than a problem cycle, state "Proactive Initiative - No Archetype" for the name. Include:
                    * \`name\`: The archetype name or "Proactive Initiative - No Archetype".
                    * \`explanation\`: Detail *how* this archetype manifests **in the user's specific situation**, referencing elements **from the text** OR explain why it's a proactive initiative based on the text. Include reinforcing/balancing loops *if identifiable from the text*.
                3.  **Identify Leverage Points (2-3):** Based **only** on the analysis and **the user's text**, identify specific \`leverage_points\` (key areas for intervention) described or implied **in the text**.
                4.  **Prescribe Actions (3-4 actions):** Develop an array of recommended \`actions\` derived **solely from the user's text and the identified leverage points/goal**. For each action:
                    * \`action_name\`: Clear, actionable name (under 10 words) **taken directly from or summarizing actions mentioned in the user's text**.
                    * \`type\`: Classify strictly as "Short-Term Fix" or "Long-Term Solution". **CRUCIAL RULE:** Base this classification **ONLY** on the user's text.
                        * If the text describes the action as addressing an immediate symptom, a temporary measure, or a quick patch -> "Short-Term Fix".
                        * If the text describes the action as part of a fundamental change, addressing a root cause, building new capabilities for a strategic goal, or having lasting impact -> "Long-Term Solution". (e.g., Building necessary infrastructure like logistics for a *new strategic direction* described in the text is "Long-Term Solution").
                    * \`rationale\`: Explain *how* this action addresses a specific leverage point or contributes to the goal, **using evidence and reasoning found ONLY within the user's text**. Justify the 'type' classification based on the text.
                    * \`impact\`: Estimated potential impact ("High", "Medium", "Low") **based on importance stated or implied in the text**.
                    * \`effort\`: Estimated implementation effort ("High", "Medium", "Low") **based on complexity described or implied in the text**.
                    * \`kpis\`: List 2-3 specific KPIs **mentioned in, implied by, or logically derived ONLY from the user's text** to track this action's success.
                5.  **Self-Correction:** Rigorously check: Is every detail (diagnosis, archetype, leverage points, action names, **action types**, rationales, KPIs) **strictly derived ONLY from the user's text**? Is the archetype choice (or lack thereof) justified **by text evidence**? Is the **action type classification strictly following the rule based on the text's description of the action's purpose/duration**? Is rationale grounded **only in text**? Is JSON perfect? Fix all errors.

                **ABSOLUTE CONSTRAINTS:**
                - **CONTEXT IS KING:** All output MUST be based **EXCLUSIVELY** on the provided "USER'S SYSTEM PROBLEM/INITIATIVE DESCRIPTION". **DO NOT** invent information.
                - **ACTION TYPE ACCURACY:** The classification of "Short-Term Fix" vs. "Long-Term Solution" **MUST strictly reflect how the action is described or purposed within the user's text**, following the rule above. Building foundational capabilities for a long-term goal described in the text is LONG-TERM.
                - **NO GENERIC EXAMPLES:** **DO NOT** use the placeholder content in the RETURN FORMAT structure below. Replace ALL placeholder text with content generated **strictly from the user's input text**.
                - **JSON FORMAT:** Adhere EXACTLY.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object. Replace ALL bracketed placeholders strictly based on the user's input text and the action classification rule.
                {
                  "problem_diagnosis": "[Concise diagnosis/goal derived ONLY from user text]",
                  "system_archetype": {
                    "name": "[Archetype name or 'Proactive Initiative - No Archetype' identified ONLY from user text]",
                    "explanation": "[Detailed explanation linking archetype/initiative ONLY to user's text/concepts, including loops derived ONLY from text if applicable...]",
                    "leverage_points": [ // Points derived ONLY from user text/analysis
                        {"point": "[Leverage point derived ONLY from user text]"},
                        {"point": "[Another leverage point derived ONLY from user text]"}
                     ]
                  },
                  "actions": [ // MUST derive actions ONLY from user text
                    {
                      "action_name": "[Action Name derived ONLY from user text]",
                      "type": "[Short-Term Fix or Long-Term Solution based ONLY on text description/purpose rule]",
                      "rationale": "[Rationale linking action using ONLY user text evidence, justifying type classification based on text...]",
                      "impact": "[High/Medium/Low based ONLY on context]",
                      "effort": "[High/Medium/Low based ONLY on context]",
                      "kpis": ["[KPI derived ONLY from context 1]", "[KPI derived ONLY from context 2]"]
                    },
                    {
                      "action_name": "[Another Action Name derived ONLY from user text]",
                      "type": "[Short-Term Fix or Long-Term Solution based ONLY on text description/purpose rule]",
                      "rationale": "[Rationale linking action using ONLY user text evidence, justifying type classification based on text...]",
                      "impact": "[High/Medium/Low based ONLY on context]",
                      "effort": "[High/Medium/Low based ONLY on context]",
                      "kpis": ["[KPI derived ONLY from context 3]", "[KPI derived ONLY from context 4]"]
                    }
                    // ... potentially 1-2 more actions derived ONLY from context ...
                  ]
                }
            `;

            // 3. Send Request to Ollama
            console.log(`Sending REFINED Context-Focused System Actions prompt (v2) to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
            });

            if (!response.ok) {
                let errorBody = `API error ${response.status}`;
                try { errorBody += `: ${await response.text()}`; } catch (e) {}
                throw new Error(errorBody);
            }

            const data = await response.json();
            let parsedData;
            console.log('Raw AI Response (System Actions - Refined Prompt v2):', data.response); // Log raw response
            try {
                parsedData = JSON.parse(data.response);
                 // *** Use the SAME Robust Validation as before, checking placeholders and structure ***
                 console.log('--- RAW AI JSON RESPONSE (Parsed - Refined System Actions v2) ---');
                 console.log(JSON.stringify(parsedData, null, 2));
                 console.log('------------------------------------');

                 if (!parsedData || typeof parsedData !== 'object' ||
                     !parsedData.problem_diagnosis || typeof parsedData.problem_diagnosis !== 'string' || parsedData.problem_diagnosis.includes("[") ||
                     !parsedData.system_archetype || typeof parsedData.system_archetype !== 'object' ||
                     !parsedData.system_archetype.name || parsedData.system_archetype.name.includes("[") ||
                     !parsedData.system_archetype.explanation || parsedData.system_archetype.explanation.includes("[") ||
                     !Array.isArray(parsedData.system_archetype.leverage_points) ||
                     !Array.isArray(parsedData.actions) || parsedData.actions.length < 1 ||
                      (parsedData.actions.length > 0 && (
                          typeof parsedData.actions[0] !== 'object' ||
                          !parsedData.actions[0].hasOwnProperty('action_name') || parsedData.actions[0].action_name.includes("[") ||
                          !parsedData.actions[0].hasOwnProperty('type') || !['Short-Term Fix', 'Long-Term Solution'].includes(parsedData.actions[0].type) ||
                          !parsedData.actions[0].hasOwnProperty('rationale') || parsedData.actions[0].rationale.includes("[") ||
                          !parsedData.actions[0].hasOwnProperty('impact') ||
                          !parsedData.actions[0].hasOwnProperty('effort') ||
                          !Array.isArray(parsedData.actions[0].kpis) || (parsedData.actions[0].kpis.length > 0 && parsedData.actions[0].kpis[0].includes("["))
                      ))
                    )
                 {
                      console.error("Validation Failed (Refined System Actions v2): Required fields missing, invalid structure, or placeholders detected.", parsedData);
                      throw new Error(`AI response structure is incorrect, inconsistent, or contains placeholders (Refined System Actions v2). Check all fields carefully. See console logs.`);
                 }

                 console.log(`Successfully parsed REFINED System Actions JSON (v2) using ${MODEL_NAME}. Found archetype/status: ${parsedData.system_archetype.name}.`);

            } catch (e) {
                console.error(`Failed to parse/validate REFINED System Actions JSON (v2) using ${MODEL_NAME}:`, data?.response, e);
                throw new Error(`Invalid JSON received or validation failed (Refined System Actions v2): ${e.message}. See raw response in console.`);
            }

            // 4. Render Results (Using the existing renderer)
            renderSystemActionsPage_ST(analysisResultContainer, parsedData);

        } catch (error) {
            console.error(`Error in handleSystemActionsAnalysis_ST (Refined v2) using ${MODEL_NAME}:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            // Ensure loading stops reliably
             if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
             }
        }
    }



// No changes needed to renderSystemActionsPage_ST as it already handles the structured data.
// Keep the existing renderSystemActionsPage_ST function as it was.
function renderSystemActionsPage_ST(container, data) {
    container.innerHTML = ""; // Clear loading state

    // Add validation for new fields
    if (!data || !data.problem_diagnosis || !data.system_archetype || !data.actions) {
         console.error("Incomplete data passed to renderSystemActionsPage_ST:", data);
         container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render System Actions results.</div>`;
         $("analysisActions").classList.add("hidden");
         return;
    }
    const { problem_diagnosis, system_archetype, actions } = data; // leverage_points are inside system_archetype now


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="actions"> Action Plan</button> <!-- Renamed -->
        <button class="analysis-tab-btn" data-tab="dynamics"> System Dynamics</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Actions & Archetypes</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="actionsPanel" class="analysis-tab-panel"></div>
        <div id="dynamicsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- 1. Dashboard Panel (Updated) ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4 space-y-8">
        <blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90">
            <strong>Problem Diagnosis:</strong> ${problem_diagnosis}
        </blockquote>
        <div class="archetype-card text-center">
            <h3 class="text-lg font-bold text-indigo-300">DOMINANT ARCHETYPE</h3>
            <p class="text-2xl font-semibold mt-1">${system_archetype.name}</p>
        </div>
        <h3 class="text-2xl font-bold text-center">Action Plan Summary</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="actionTypeChart" class="w-full h-[350px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
            <div id="actionCompareChart" class="w-full h-[350px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
        </div>
    </div>`; // Close p-4 space-y-8
    dashboardPanel.innerHTML = dashboardHtml;

    // Chart 1: Action Types
    try {
        const shortTermCount = actions.filter(a => a.type === "Short-Term Fix").length;
        const longTermCount = actions.filter(a => a.type === "Long-Term Solution").length;
        Plotly.newPlot('actionTypeChart', [{
            values: [shortTermCount, longTermCount], labels: ["Short-Term Fixes", "Long-Term Solutions"],
            type: 'pie', hole: 0.4, marker: { colors: ["#f59e0b", "#2563eb"] }, textinfo: 'value+percent', insidetextorientation: 'radial'
        }], {
            title: 'Action Type Breakdown', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }, showlegend: true, legend: { orientation: 'h', y: -0.1 }, margin: { t: 40, b: 40, l: 20, r: 20 }
        }, { responsive: true });
    } catch(e){ console.error("Chart err 1:",e); $("actionTypeChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }

    // Chart 2: Impact vs Effort (ensure mapping exists)
    try {
        const valueMap = { Low: 1, Medium: 2, High: 3 };
        const actionNames = actions.map(a => a.action_name);
        // Add default values (e.g., 1 for 'Low') if impact/effort missing
        const impactValues = actions.map(a => valueMap[a.impact] || 1);
        const effortValues = actions.map(a => valueMap[a.effort] || 1);

        const impactTrace = { y: actionNames, x: impactValues, name: 'Impact', type: 'bar', orientation: 'h', marker: { color: 'var(--accent)' } };
        const effortTrace = { y: actionNames, x: effortValues, name: 'Effort', type: 'bar', orientation: 'h', marker: { color: 'rgba(255,255,255,0.4)' } };
        Plotly.newPlot('actionCompareChart', [impactTrace, effortTrace], {
            title: 'Impact vs. Effort Comparison', barmode: 'group', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' }, yaxis: { automargin: true, tickfont: {size: 10} }, // Smaller font size
            xaxis: { tickvals: [1, 2, 3], ticktext: ['Low', 'Medium', 'High'], gridcolor: "rgba(255,255,255,0.1)" }, // Lighter grid
            legend: { x: 0.5, y: -0.2, xanchor: 'center', orientation: 'h' }, // Center legend below
            margin: { t: 40, b: 60, l: 150, r: 20 } // Adjust margins maybe
        }, { responsive: true });
     } catch(e){ console.error("Chart err 2:",e); $("actionCompareChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }


    // --- 2. Action Plan Panel (Updated) ---
    const actionsPanel = $("actionsPanel");
    let actionsHtml = `<div class="p-4 space-y-6">`;
    // Separate actions by type
    const shortTermActions = actions.filter(a => a.type === "Short-Term Fix");
    const longTermActions = actions.filter(a => a.type === "Long-Term Solution");

    if (shortTermActions.length > 0) {
         actionsHtml += `<h3 class="text-xl font-bold mb-3 text-yellow-400 border-b border-yellow-400/50 pb-1"> Short-Term Fixes (Symptomatic)</h3>`;
         shortTermActions.forEach((a) => {
             actionsHtml += `<div class="action-card short-term"> <!-- Added class -->
                                <h4 class="text-lg font-bold">${a.action_name}</h4>
                                <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${a.impact || "?"} | <span class="text-blue-300">Effort:</span> ${a.effort || "?"}</p>
                                <p class="rationale"><strong>Rationale:</strong> ${a.rationale || "N/A"}</p>
                                <div class="bg-black/20 p-3 rounded text-sm mt-3">
                                    <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                                    <ul class="list-disc list-inside space-y-1 text-white/90">${(a.kpis || []).map(k => `<li>${k}</li>`).join('')}</ul>
                                </div>
                            </div>`;
         });
    }

    if (longTermActions.length > 0) {
         actionsHtml += `<h3 class="text-xl font-bold mt-8 mb-3 text-blue-400 border-b border-blue-400/50 pb-1"> Long-Term Solutions (Structural)</h3>`;
         longTermActions.forEach((a) => {
             actionsHtml += `<div class="action-card long-term"> <!-- Added class -->
                                <h4 class="text-lg font-bold">${a.action_name}</h4>
                                <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${a.impact || "?"} | <span class="text-blue-300">Effort:</span> ${a.effort || "?"}</p>
                                <p class="rationale"><strong>Rationale:</strong> ${a.rationale || "N/A"}</p>
                                <div class="bg-black/20 p-3 rounded text-sm mt-3">
                                    <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                                    <ul class="list-disc list-inside space-y-1 text-white/90">${(a.kpis || []).map(k => `<li>${k}</li>`).join('')}</ul>
                                </div>
                            </div>`;
         });
    }
     if (shortTermActions.length === 0 && longTermActions.length === 0) {
         actionsHtml += `<p class="text-center text-white/70 italic">No specific actions were generated based on the problem description.</p>`;
     }

    actionsHtml += `</div>`; // Close p-4 space-y-6
    actionsPanel.innerHTML = actionsHtml;


    // --- 3. System Dynamics Panel (Updated) ---
    const dynamicsPanel = $("dynamicsPanel");
    let dynamicsHtml = `<div class="p-4 space-y-6">
        <div class="archetype-card">
            <h3 class="text-lg font-bold text-indigo-300">IDENTIFIED ARCHETYPE</h3>
            <p class="text-2xl font-semibold mt-1">${system_archetype.name}</p>
            <p class="text-sm text-white/80 mt-2 italic">${system_archetype.explanation}</p>
        </div>`;
        // Leverage points are now inside archetype object
        if (system_archetype.leverage_points && system_archetype.leverage_points.length > 0) {
             dynamicsHtml += `<div class="insight-card">
                                <h4 class="text-lg font-bold text-yellow-300">Key Leverage Points (Derived from Archetype & Context):</h4>
                                <ul class="list-disc list-inside space-y-2 mt-2 text-white/90">`;
             system_archetype.leverage_points.forEach((lp) => {
                 // Check if lp is an object with 'point' property, otherwise assume it's a string
                 const pointText = (typeof lp === 'object' && lp.point) ? lp.point : String(lp);
                 dynamicsHtml += `<li>${pointText}</li>`;
             });
             dynamicsHtml += `</ul></div>`;
        } else {
             dynamicsHtml += `<p class="text-center text-white/70 italic">No specific leverage points explicitly identified for this archetype in the context.</p>`;
        }
     dynamicsHtml += `</div>`; // Close p-4 space-y-6
    dynamicsPanel.innerHTML = dynamicsHtml;


    // --- 4. Populate Learn Actions & Archetypes Panel (New) ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Actions in Systems</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Intervening in Complex Systems</h4>
            <p class="text-sm text-white/80">When dealing with systemic problems revealed by archetypes, interventions (actions) need to be carefully considered. Actions can target different leverage points and have varying time horizons and potential side effects.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50">
                <h4 class="text-xl font-bold text-yellow-300 mb-2"> Short-Term Fixes (Symptomatic Solutions)</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Goal:</strong> Alleviate immediate pressure or visible symptoms.</li>
                    <li><strong>Pros:</strong> Quick relief, buys time, politically easier.</li>
                    <li><strong>Cons:</strong> Doesn't solve the root cause, may have unintended negative side effects, can create dependency (as in "Shifting the Burden").</li>
                    <li><strong>Example:</strong> Hiring temporary staff to handle a surge instead of fixing the underlying process causing the surge.</li>
                    <li><strong>When to Use:</strong> Sparingly, as a bridge to a fundamental solution, or when immediate relief is critical.</li>
                </ul>
            </div>
            <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                <h4 class="text-xl font-bold text-blue-300 mb-2"> Long-Term Solutions (Structural Interventions)</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Goal:</strong> Address the root cause by changing the system's structure (loops, delays, goals, rules).</li>
                    <li><strong>Pros:</strong> Sustainable improvement, prevents recurrence, builds resilience.</li>
                    <li><strong>Cons:</strong> Often slower to implement, requires deeper understanding, may face resistance, results may be delayed.</li>
                    <li><strong>Example:</strong> Redesigning the process to eliminate the cause of the surge, changing performance metrics that incentivize bad behavior.</li>
                    <li><strong>When to Use:</strong> Whenever possible for lasting change. Often requires combining with short-term fixes initially.</li>
                </ul>
            </div>
        </div>

         <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
            <h4 class="text-lg font-bold mb-2">Linking Actions to Archetypes:</h4>
            <p class="text-sm text-white/80 mb-2">The most effective actions target the specific structure of the identified archetype:</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Limits to Growth:</strong> Focus on removing or easing the limiting condition (B loop) OR managing the growth engine (R loop).</li>
                <li><strong>Shifting the Burden:</strong> Strengthen the fundamental solution while weakening the symptomatic one.</li>
                <li><strong>Fixes that Fail:</strong> Map out and address the unintended consequences; anticipate delays.</li>
                <li><strong>Tragedy of the Commons:</strong> Change the rules/incentives governing resource use.</li>
                <li><strong>Success to the Successful:</strong> Re-evaluate resource allocation; create level playing fields.</li>
                <li><strong>Escalation:</strong> Find ways to de-escalate; focus on shared goals.</li>
            </ul>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool attempts to categorize actions and link them to the identified archetype's dynamics based on your input.</p>
    </div>
    `;
    
    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (ensure resizing happens)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // Resize charts if the Dashboard tab is activated
                 const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                 chartsInPanel.forEach(chartDiv => {
                      if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                          try {
                              Plotly.Plots.resize(chartDiv);
                          } catch (resizeError) {
                               console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                          }
                      }
                 });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Initial resize for charts in the default active tab (Dashboard)
     setTimeout(() => {
          const activePanel = tabContent.querySelector('.analysis-tab-panel.active');
          if (activePanel) {
              activePanel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                  if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                      try {
                           Plotly.Plots.resize(chartDiv);
                      } catch (initialResizeError) {
                           console.error(`Error during initial resize ${chartDiv.id}:`, initialResizeError);
                      }
                  }
              });
          }
     }, 150);


    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}


function createSystemObjectivesLayout_ST(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe Your System & Desired Outcome</h3>
                             
                             <div class="mb-2">
                                <label for="systemObjLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="systemObjLocation" class="input-field" placeholder="e.g., Corporate HQ, Specific Plant, Global Supply Chain">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="systemObjContent" class="input-field h-48" placeholder="Describe the system and what you want to achieve. For example: 'Our user base is growing, but engagement is low. We want to increase the daily active user rate.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="systemObjFile" id="systemObjFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="systemObjFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Set System-Aware Objectives</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Systemic Objective Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("systemObjFile", "systemObjFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createSystemObjectivesLayout_ST");
        }
    }

    async function handleSystemObjectivesAnalysis_ST() {
        const analysisResultContainer = document.getElementById("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8">
            <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
            <h3 class="text-xl font-semibold text-white mb-4">Analyzing System & Setting Objectives...</h3>
            <p class="text-white/80 mb-2">Performing deep OGSM (Objective, Goals, Strategies, Measures) derivation based on system dynamics...</p>
        </div>`;
        setLoading("generate", true);

        // Define URL and Model
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";

        try {
            // 1. Gather Inputs
            const useDoc = document.getElementById("docUpload").checked;
            let text = "";

            if (useDoc) {
                const file = document.getElementById("systemObjFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                text = await extractTextFromFile(file);
            } else {
                text = document.getElementById("systemObjContent").value.trim();
                if (!text.trim()) throw new Error("Please describe your system and goal.");
            }

            // Inject Location
            const location = document.getElementById("systemObjLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
            }

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (text.length > MAX_CONTEXT_LENGTH) {
                text = text.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
            }

            // 2. Enhanced Prompt
            const prompt = `
                You are a master systems strategist. Analyze the user's text to define a strategic direction.
                Determine if the text is a **Dynamic Problem** (needs fixing) or a **Descriptive Profile** (needs amplification).
                
                Based on that, generate a full **OGSM (Objectives, Goals, Strategies, Measures)** plan rooted in Systems Thinking. ${truncatedNote}

                **USER'S CONTEXT:**
                \`\`\`
                ${text}
                \`\`\`
                **VALIDATION:**
                If the text is gibberish, return the INVALID structure.

                **TASKS:**
                1.  **Main Objective (\`main_objective\`):** A single, high-level statement of what the system *should* achieve.
                2.  **System Dynamics (\`system_dynamics\`):** Identify the key loops. 
                    * If it's a problem, identify the *Reinforcing Loop* (R) driving the issue or the *Balancing Loop* (B) blocking progress.
                    * If it's a profile, identify the *Reinforcing Loop* (R) of growth/success to amplify.
                    * If none found, return null.
                3.  **Goals Breakdown (\`goals\`):** Identify 3-4 high-level Goals (G). For EACH Goal, provide:
                    * \`goal_name\`: The specific outcome.
                    * \`strategies\`: 1-2 Strategies (S) to achieve it.
                    * \`measures\`: 1-2 Measures/KPIs (M) to track it.
                    * \`rationale\`: How this goal influences the system dynamics (loops/elements).
                4.  **Action Plan (\`action_plan\`):** 3-5 sequential steps to implement the strategy.

                **CONSTRAINT:**
                - If the text is unanalyzable (nonsense/poem), set \`main_objective\` to "Unanalyzable: [Reason]" and \`goals\` to [].

                **RETURN FORMAT (JSON ONLY):**
                {
                  "main_objective": "...",
                  "system_dynamics": {
                    "loop_name": "Growth Engine (R1) or Stagnation Cycle (B1)",
                    "description": "Explanation of the loop...",
                    "elements_involved": ["Element A", "Element B"]
                  },
                  "goals": [
                    {
                      "goal_name": "...",
                      "rationale": "Strengthens the R1 loop by...",
                      "strategies": [
                        { "name": "...", "description": "..." }
                      ],
                      "measures": ["KPI 1", "KPI 2"]
                    }
                  ],
                  "action_plan": [
                    { "step": "Phase 1", "action": "...", "owner": "..." }
                  ]
                }
            `;

            // 3. Send Request
            console.log(`Sending Enhanced System Objectives prompt to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
            });

            if (!response.ok) throw new Error(`API error ${response.status}`);

            const data = await response.json();
            let parsedData;
            try {
                parsedData = JSON.parse(data.response);
                
                // Validation
                if (!parsedData || !parsedData.main_objective || !Array.isArray(parsedData.goals)) {
                    throw new Error("Invalid JSON structure received from AI.");
                }

            } catch (e) {
                console.error("JSON Parse Error:", data.response, e);
                throw new Error("Failed to parse AI response. Please try again.");
            }

            // 4. Render
            renderSystemObjectivesPage_ST(analysisResultContainer, parsedData);

        } catch (error) {
            console.error(`Error in handleSystemObjectivesAnalysis_ST:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
             if (document.getElementById("generateSpinner")) setLoading("generate", false);
        }
    }

    function renderSystemObjectivesPage_ST(container, data) {
        container.innerHTML = ""; // Clear loading

        // Validation
        if (!data || !data.main_objective || !data.goals) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data.</div>`;
            document.getElementById("analysisActions").classList.add("hidden");
            return;
        }

        // Unanalyzable Check
        if (data.goals.length === 0 && data.main_objective.toLowerCase().includes("unanalyzable")) {
            container.innerHTML = `<div class="p-4 text-center text-yellow-300">
                                     <h4 class="text-xl font-bold mb-3">Analysis Incomplete</h4>
                                     <p class="text-white/80">${data.main_objective}</p>
                                   </div>`;
            document.getElementById("analysisActions").classList.add("hidden");
            return;
        }

        const { main_objective, system_dynamics, goals, action_plan } = data;
        const hasDynamics = system_dynamics && system_dynamics.loop_name;

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
            <button class="analysis-tab-btn" data-tab="map"> System Map</button>
            <button class="analysis-tab-btn" data-tab="details"> Detailed OGSM</button>
            <button class="analysis-tab-btn" data-tab="actions"> Action Plan</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active"></div>
            <div id="mapPanel" class="analysis-tab-panel"></div>
            <div id="detailsPanel" class="analysis-tab-panel"></div>
            <div id="actionsPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Dashboard Panel ---
        const dashboardPanel = document.getElementById("dashboardPanel");
        let dashboardHtml = `<div class="p-6 space-y-8">
            <div class="p-6 rounded-lg bg-gradient-to-r from-indigo-900/40 to-blue-900/40 border border-indigo-500/30 text-center">
                <h3 class="text-xl font-bold mb-2 text-indigo-300"> Main System Objective</h3>
                <p class="text-2xl italic text-white/90">${main_objective}</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold text-green-300 mb-3">System Health Check</h4>
                    <ul class="space-y-2 text-sm text-white/80">
                        <li class="flex justify-between"><span>Goals Defined:</span> <span class="font-bold">${goals.length}</span></li>
                        <li class="flex justify-between"><span>Strategies Identified:</span> <span class="font-bold">${goals.reduce((acc, g) => acc + (g.strategies?.length||0), 0)}</span></li>
                        <li class="flex justify-between"><span>KPIs Set:</span> <span class="font-bold">${goals.reduce((acc, g) => acc + (g.measures?.length||0), 0)}</span></li>
                    </ul>
                 </div>
                 <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold text-yellow-300 mb-3">System Dynamics</h4>
                    <p class="text-sm text-white/80">${hasDynamics ? `Driven by: <strong>${system_dynamics.loop_name}</strong>` : "No dominant loop identified."}</p>
                    <p class="text-xs text-white/60 mt-2">${hasDynamics ? system_dynamics.description : ""}</p>
                 </div>
            </div>

            <h3 class="text-xl font-bold text-center mt-4">Implementation Weight</h3>
            <div id="kpiChart" class="w-full h-[300px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
        </div>`;
        dashboardPanel.innerHTML = dashboardHtml;

        // Render Chart
        try {
            const goalNames = goals.map((g, i) => `Goal ${i+1}`);
            const strategyCounts = goals.map(g => g.strategies?.length || 0);
            const measureCounts = goals.map(g => g.measures?.length || 0);
            
            Plotly.newPlot('kpiChart', [
                { x: goalNames, y: strategyCounts, name: 'Strategies', type: 'bar', marker: {color: '#3b82f6'} },
                { x: goalNames, y: measureCounts, name: 'KPIs', type: 'bar', marker: {color: '#10b981'} }
            ], {
                barmode: 'group', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: 'white'}, margin: {t:20, b:40, l:40, r:20},
                legend: {orientation: 'h', y: -0.1}
            }, {responsive: true});
        } catch(e) { console.error("Chart error:", e); }

        // --- 2. System Map Panel ---
        const mapPanel = document.getElementById("mapPanel");
        if (hasDynamics) {
            mapPanel.innerHTML = `
                <div class="p-6 flex flex-col items-center">
                    <h3 class="text-2xl font-bold mb-6"> Strategic System Map</h3>
                    
                    <div class="relative bg-black/20 p-8 rounded-xl border-2 border-dashed border-white/20 max-w-3xl w-full">
                        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900 px-4 py-1 border border-white/30 rounded-full text-xs uppercase tracking-widest font-bold">
                            ${system_dynamics.loop_name}
                        </div>
                        
                        <div class="flex flex-wrap justify-center gap-4 mb-8">
                            ${(system_dynamics.elements_involved || []).map(el => `
                                <div class="px-4 py-2 bg-indigo-900/40 border border-indigo-500/50 rounded text-indigo-200 font-semibold text-sm">
                                    ${el}
                                </div>
                            `).join('<span class="text-white/30 self-center"></span>')}
                        </div>
                        
                        <p class="text-center text-white/80 italic">"${system_dynamics.description}"</p>
                    </div>

                    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
                        ${goals.map(g => `
                            <div class="bg-white/5 p-4 rounded-lg border-l-4 border-green-500">
                                <h5 class="font-bold text-green-400 text-sm mb-1">Intervention Goal</h5>
                                <p class="text-white/90 font-semibold">${g.goal_name}</p>
                                <p class="text-xs text-white/60 mt-2">Targeting: ${g.rationale || "System optimization"}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else {
            mapPanel.innerHTML = `<div class="p-10 text-center text-white/60">No specific feedback loops were identified in the text to map.</div>`;
        }

        // --- 3. Detailed OGSM Panel ---
        const detailsPanel = document.getElementById("detailsPanel");
        let detailsHtml = `<div class="p-6 space-y-6">`;
        goals.forEach((goal, idx) => {
            detailsHtml += `
                <div class="glass-container p-0 overflow-hidden border border-white/10">
                    <div class="bg-white/5 p-4 border-b border-white/10 flex justify-between items-center">
                        <h4 class="text-lg font-bold text-indigo-300">Goal ${idx+1}: ${goal.goal_name}</h4>
                    </div>
                    <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="text-sm font-bold text-yellow-300 uppercase tracking-wider mb-3">Strategies (How)</h5>
                            <ul class="space-y-3">
                                ${(goal.strategies || []).map(s => `
                                    <li class="bg-black/20 p-3 rounded border-l-2 border-yellow-500/50">
                                        <p class="font-semibold text-sm text-white/90">${s.name}</p>
                                        <p class="text-xs text-white/60 mt-1">${s.description}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div>
                            <h5 class="text-sm font-bold text-green-300 uppercase tracking-wider mb-3">Measures (KPIs)</h5>
                            <ul class="space-y-2">
                                ${(goal.measures || []).map(m => `
                                    <li class="flex items-center text-sm text-white/80">
                                        <span class="text-green-400 mr-2"></span> ${m}
                                    </li>
                                `).join('')}
                            </ul>
                            <div class="mt-4 p-3 bg-blue-900/10 rounded border border-blue-500/20">
                                <span class="text-xs font-bold text-blue-300 block mb-1">System Rationale:</span>
                                <p class="text-xs text-white/70 italic">${goal.rationale || "N/A"}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        detailsHtml += `</div>`;
        detailsPanel.innerHTML = detailsHtml;

        // --- 4. Action Plan Panel ---
        const actionsPanel = document.getElementById("actionsPanel");
        if (action_plan && action_plan.length > 0) {
            actionsPanel.innerHTML = `
                <div class="p-6">
                    <h3 class="text-2xl font-bold mb-6 text-center"> Implementation Roadmap</h3>
                    <div class="space-y-4 max-w-4xl mx-auto">
                        ${action_plan.map((item, i) => `
                            <div class="flex items-center p-4 bg-white/5 rounded-lg border border-white/10 hover:border-white/30 transition">
                                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center font-bold text-white mr-4">
                                    ${i + 1}
                                </div>
                                <div class="flex-grow">
                                    <h5 class="font-bold text-white">${item.action}</h5>
                                    <p class="text-xs text-white/60 mt-1">${item.step || 'Next Step'}  Owner: ${item.owner || 'Team'}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else {
            actionsPanel.innerHTML = `<div class="p-10 text-center text-white/60">No specific action plan was generated.</div>`;
        }

        // --- 5. Learn Panel ---
        const learnPanel = document.getElementById("learnPanel");
        learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Systems-Based OGSM</h3>
                <div class="bg-black/20 p-4 rounded-lg">
                    <h4 class="text-lg font-bold mb-2 text-indigo-300">Traditional vs. Systems OGSM</h4>
                    <p class="text-sm text-white/80">Traditional OGSM (Objectives, Goals, Strategies, Measures) is linear. <strong>Systems-Based OGSM</strong> acknowledges that goals affect the system's structure (loops).</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                        <h4 class="text-lg font-bold text-green-300 mb-2">Objective (O)</h4>
                        <p class="text-sm">The high-level direction. In systems thinking, this usually involves shifting the dominance from a negative loop to a positive one.</p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                        <h4 class="text-lg font-bold text-yellow-300 mb-2">Goals (G)</h4>
                        <p class="text-sm">Specific leverage points. These are not just numbers, but structural changes (e.g., "Reduce delay in feedback loop").</p>
                    </div>
                </div>
            </div>
        `;

        // --- Final Setup ---
        const newElementsToAnimate = container.querySelectorAll('.glass-container, .feature-card, .plotly-chart');
        animateElements(newElementsToAnimate);

        document.getElementById("analysisActions").classList.remove("hidden");

        // Tab Logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanel = document.getElementById(e.target.dataset.tab + "Panel");
                if (targetPanel) {
                    targetPanel.classList.add("active");
                    const chart = targetPanel.querySelector(".plotly-chart");
                    if (chart) Plotly.Plots.resize(chart);
                }
            }
        });
    }

    function createCreativeDissonanceLayout_NS(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-4xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-center text-white">Define the Dissonance</h3>
                             
                             <div class="mb-4">
                                <label for="dissonanceLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="dissonanceLocation" class="input-field" placeholder="e.g., Global, Emerging Markets, Silicon Valley">
                             </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="currentReality" class="block text-lg font-medium text-gray-200 mb-2"> Current Reality</label>
                                    <textarea id="currentReality" class="input-field h-48" placeholder="Describe your current situation, challenges, and limitations..."></textarea>
                                </div>
                                <div>
                                    <label for="futureVision" class="block text-lg font-medium text-gray-200 mb-2"> Future Vision</label>
                                    <textarea id="futureVision" class="input-field h-48" placeholder="Describe your ambitious, desired future state..."></textarea>
                                </div>
                            </div>
                             <h3 class="text-xl font-bold mt-6 mb-4 text-center text-white">Provide Additional Context (Optional)</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="dissonanceContextFile" class="block text-sm font-medium text-gray-200 mb-2">Business Document (.txt, .docx)</label>
                                    <div class="input-file-wrapper">
                                        <label for="dissonanceContextFile" id="dissonanceContextFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select context file...</span>
                                        </label>
                                        <input type="file" id="dissonanceContextFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <div>
                                    <label for="dissonanceDataFile" class="block text-sm font-medium text-gray-200 mb-2">Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="dissonanceDataFile" id="dissonanceDataFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select data file...</span>
                                        </label>
                                        <input type="file" id="dissonanceDataFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                             </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Generate Creative Strategies</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Creative Dissonance Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        const attachListener = (inputId, labelId) => {
            const fileInput = $(inputId);
            if (fileInput) {
                fileInput.addEventListener("change", (e) => {
                    const label = $(labelId);
                    const fileNameSpan = label.querySelector(".file-name");
                    if (e.target.files.length > 0) {
                        fileNameSpan.textContent = e.target.files[0].name;
                    } else {
                        fileNameSpan.textContent = "Select a file...";
                    }
                });
            }
        };
        attachListener("dissonanceContextFile", "dissonanceContextFileLabel");
        attachListener("dissonanceDataFile", "dissonanceDataFileLabel");
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createCreativeDissonanceLayout_NS");
        }
    }

   async function handleCreativeDissonanceAnalysis_NS() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Analyzing Creative Gap (Prioritizing Files)...</h3><p class="text-white/80 mb-2">Generating initiatives based primarily on document and data context...</p></div>`;
        setLoading("generate", true); // Set loading state

        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Using Llama 3.1 as requested

        try {
            // --- Gather Inputs ---
            const currentReality = $("currentReality").value.trim();
            const futureVision = $("futureVision").value.trim();
            const contextFile = $("dissonanceContextFile").files[0];
            const dataFile = $("dissonanceDataFile").files[0];

            if (!currentReality || !futureVision) {
                throw new Error(" Please describe both your Current Reality and Future Vision (even if brief summaries).");
            }
            // **Crucial Check:** Ensure at least one file is provided if we prioritize them.
            if (!contextFile && !dataFile) {
                 throw new Error(" Please upload at least a Business Context (.txt/.docx) or Data Context (.csv) file for detailed analysis.");
            }


            // --- Process Optional Context Files ---
            let businessContext = "No business document provided."; // Default changed
            if (contextFile) {
                try {
                    businessContext = await extractTextFromFile(contextFile);
                    console.log("Extracted text from context file.");
                } catch (e) {
                    console.warn("Could not read context file:", e.message);
                    businessContext = `Error reading provided context file: ${e.message}`;
                }
            } else {
                 console.log("No business context file uploaded.");
            }

            let dataContext = "No data file provided."; // Default changed
            if (dataFile) {
                 try {
                    dataContext = await extractTextFromFile(dataFile);
                    console.log("Extracted text from data file.");
                 } catch (e) {
                     console.warn("Could not read data file:", e.message);
                     dataContext = `Error reading provided data file: ${e.message}`;
                 }
            } else {
                 console.log("No data context file uploaded.");
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("dissonanceLocation").value.trim();
            if (location) {
                // Prepend to businessContext to ensure it's part of the primary source
                businessContext = `Target Location/Region: ${location}\n\n${businessContext}`;
                console.log("Injected location into Creative Dissonance Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate contexts if necessary
            const MAX_CONTEXT_LENGTH = 7000; // Keep reasonable for context focus
            if (businessContext.length > MAX_CONTEXT_LENGTH) {
                businessContext = businessContext.substring(0, MAX_CONTEXT_LENGTH) + "\n... (business context truncated)";
            }
            if (dataContext.length > MAX_CONTEXT_LENGTH) {
                dataContext = dataContext.substring(0, MAX_CONTEXT_LENGTH) + "\n... (data context truncated)";
            }

            // --- Enhanced Prompt Prioritizing Files ---
            const prompt = `
                You are a master strategist applying Robert Fritz's "Creative Dissonance" framework. Analyze the user's situation based *primarily* on the provided Business Context (.txt/.docx) and Data Context (.csv) files. Use the brief "Current Reality" and "Future Vision" inputs mainly for high-level framing and goal confirmation.

                **ANALYSIS INPUTS:**
                * **Business Context (Primary Source):** """${businessContext}"""
                * **Data Context (Primary Source):** """${dataContext}"""
                * **Current Reality (Framing):** ${currentReality}
                * **Future Vision (Framing):** ${futureVision}

                **VALIDATION:**
                If the provided contexts are gibberish or empty, return the INVALID structure.

                **TASK:**
                Perform a Creative Dissonance analysis based *strictly* on the detailed information within the **Business Context** and **Data Context** files.

                1.  **dissonance_points**: Identify 2-4 key thematic points of tension between the *detailed reality described in the files* and the *envisioned future described in the files (or framed by the Future Vision input)*. Phrase as "From '[Specific Reality from Files]' to '[Specific Vision from Files/Input]'".

                2.  **gap_analysis**: Create an array analyzing 2-4 major gaps *identified from the files*. For each gap:
                    * \`theme\`: Overarching theme (e.g., "Operational Scalability," "Market Penetration," "Data Infrastructure").
                    * \`reality_statement\`: A summary of the current state for this theme, citing specific details *from the files*.
                    * \`vision_statement\`: A summary of the desired future state for this theme, citing specific details *from the files* or aligning with the Future Vision input.
                    * \`gap\`: A clear description of the specific discrepancy *identified from the files*.

                3.  **strategic_initiatives**: Develop an array of 2-4 strategic initiatives designed *specifically* to close the gaps *identified from the files*. For each initiative:
                    * \`initiative_name\`: Action-oriented name (under 10 words).
                    * \`rationale\`: Explain *how* this initiative addresses a gap *identified from the files*, citing file context where possible.
                    * \`impact\`: Potential impact ("High", "Medium", "Low").
                    * \`effort\`: Likely effort ("High", "Medium", "Low").
                    * \`action_items\`: 2-3 concrete first steps derived from the necessary actions suggested by the *file context*.
                    * \`kpis_to_track\`: 2-3 specific KPIs relevant to the gap and measurable using data *suggested by the files* or standard business metrics.

                **ABSOLUTE CONSTRAINTS (CRITICAL):**
                - **FILE PRIORITY:** Base your ENTIRE analysisgaps, initiatives, actions, KPIsprimarily on the **Business Context** and **Data Context** files. Use the text box inputs only for overall direction if the files lack a clear goal.
                - **EVIDENCE-BASED:** Every point, gap, and initiative detail MUST be directly traceable to, or a logical necessity based on, the information *within the uploaded files*.
                - **NO FABRICATION:** Do NOT invent details, challenges, solutions, or metrics not supported by the file content. If the files lack sufficient detail for a section (e.g., H3 initiatives), state that clearly or return an empty array.
                - **SPECIFICITY:** Extract and use concrete details, numbers, challenges, or opportunities mentioned in the files.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object with the exact structure specified below. Ensure all fields reflect the file-first analysis.
                {
                  "dissonance_points": [ /* Points based primarily on file details */ ],
                  "gap_analysis": [ /* Gaps identified primarily from file details */ ],
                  "strategic_initiatives": [ /* Initiatives addressing file-based gaps */ ]
                }
            `;

            console.log("Sending FILE-PRIORITIZED Creative Dissonance prompt to Llama 3.1...");
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: { num_ctx: 32768 }
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
            const data = await response.json();

            let parsedData;
            try {
                 parsedData = JSON.parse(data.response);
                 console.log("Successfully parsed FILE-PRIORITIZED Creative Dissonance JSON response.");
            } catch (e) {
                console.error("Failed to parse FILE-PRIORITIZED Creative Dissonance JSON:", data.response, e);
                throw new Error("Invalid JSON received from AI (File-Priority). Check AI logs or input files.");
            }

            // Minimal validation
            if (!parsedData.dissonance_points || !parsedData.gap_analysis || !parsedData.strategic_initiatives) {
                 console.error("Parsed JSON structure is invalid (File-Priority):", parsedData);
                 throw new Error("AI response structure is incorrect (File-Priority).");
            }

            // Store original inputs for rendering comparison
            parsedData.original_inputs = {
                 currentReality: currentReality,
                 futureVision: futureVision
            };

            renderCreativeDissonancePage_NS(analysisResultContainer, parsedData);

        } catch (error) {
            console.error("Error during Creative Dissonance Analysis (File-Priority):", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false); // Stop loading on error
        }
    }

    function renderCreativeDissonancePage_NS(container, data) {
        container.innerHTML = ""; // Clear loading state
        // Add original inputs back for display if they were stored
        const { dissonance_points, gap_analysis, strategic_initiatives, original_inputs } = data;
        const currentRealityText = original_inputs?.currentReality || "[Current Reality Input Missing]";
        const futureVisionText = original_inputs?.futureVision || "[Future Vision Input Missing]";


        // Basic validation
        if (!dissonance_points || !gap_analysis || !strategic_initiatives || !Array.isArray(dissonance_points) || !Array.isArray(gap_analysis) || !Array.isArray(strategic_initiatives) ) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Incomplete or invalid analysis data received. Cannot render Creative Dissonance plan.</div>`;
            $("analysisActions").classList.add("hidden");
            setLoading("generate", false);
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Standard tabs
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
            <button class="analysis-tab-btn" data-tab="gap"> Gap Analysis</button>
            <button class="analysis-tab-btn" data-tab="initiatives"> Strategic Initiatives</button>
            <button class="analysis-tab-btn" data-tab="matrix"> Prioritization Matrix</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Framework</button>
            `;
            // <button class="analysis-tab-btn" data-tab="kpis"> KPI Tracker</button> // Merged KPIs into Initiatives tab for brevity
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active"></div>
            <div id="gapPanel" class="analysis-tab-panel"></div>
            <div id="initiativesPanel" class="analysis-tab-panel"></div>
            <div id="matrixPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
            `;
            // <div id="kpisPanel" class="analysis-tab-panel"></div>

        // --- 1. Populate Dashboard Panel ---
        const dashboardPanel = $("dashboardPanel");
        // Simplified dashboard focusing on the core tension and initiative count
        let dashboardHtml = `<div class="p-4 space-y-8">
            <h3 class="text-2xl font-bold text-center mb-4">Creative Dissonance Overview</h3>
            <div class="dissonance-map-container">
                 <div class="dissonance-pole">
                     <h4 class="text-xl font-bold mb-3 text-red-300"> Current Reality</h4>
                     <p class="text-white/80 text-sm">${currentRealityText}</p>
                 </div>
                 <div class="dissonance-gap">
                     <div class="text-center mb-4">
                        <span class="text-4xl"></span>
                        <h4 class="text-lg font-bold text-yellow-300">Structural Tension</h4>
                        <p class="text-xs text-white/70">(Points of Dissonance)</p>
                     </div>
                    ${(dissonance_points || []).map(dp => `<div class="dissonance-point text-xs">${dp}</div>`).join("")}
                 </div>
                 <div class="dissonance-pole">
                     <h4 class="text-xl font-bold mb-3 text-green-300"> Future Vision</h4>
                     <p class="text-white/80 text-sm">${futureVisionText}</p>
                 </div>
            </div>
            <div class="text-center mt-[-1rem] mb-6">
                <p class="text-lg text-white/90">Identified <strong class="text-yellow-300">${(gap_analysis || []).length}</strong> major gaps and formulated <strong class="text-yellow-300">${(strategic_initiatives || []).length}</strong> strategic initiatives to bridge them.</p>
            </div>
        </div>`;
        dashboardPanel.innerHTML = dashboardHtml;

        // --- 2. Populate Gap Analysis Panel ---
        const gapPanel = $("gapPanel");
        let gapHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4"> Detailed Gap Analysis</h3>`;
        if (gap_analysis.length > 0) {
            gap_analysis.forEach((gap) => {
                gapHtml += `<div class="insight-card">
                    <h4 class="text-xl font-bold mb-3 text-indigo-300">${gap.theme || "Unnamed Gap Theme"}</h4>
                    <p class="mb-2 text-sm"><strong>Current State:</strong> ${gap.reality_statement || "N/A"}</p>
                    <p class="mb-3 text-sm"><strong>Future State:</strong> ${gap.vision_statement || "N/A"}</p>
                    <div class="p-3 bg-black/20 rounded border-l-4 border-yellow-400 mt-3">
                        <p class="text-sm"><strong>Identified Gap:</strong> ${gap.gap || "N/A"}</p>
                    </div>
                </div>`;
            });
        } else {
             gapHtml += `<p class="text-center text-white/70">No specific gaps identified based on input.</p>`;
        }
        gapHtml += `</div>`;
        gapPanel.innerHTML = gapHtml;

        // --- 3. Populate Strategic Initiatives Panel (Including KPIs) ---
        const initiativesPanel = $("initiativesPanel");
        let initiativesHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Strategic Initiatives</h3>`;
         if (strategic_initiatives.length > 0) {
            initiativesHtml += `<div class="space-y-6">`;
            strategic_initiatives.forEach((p) => {
                initiativesHtml += `<div class="prescription-card">
                    <h4 class="text-xl font-bold">${p.initiative_name || "Unnamed Initiative"}</h4>
                    <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${p.impact || "?"} | <span class="text-blue-300">Effort:</span> ${p.effort || "?"}</p>
                    <p class="rationale"><strong>Strategic Rationale:</strong> ${p.rationale || "N/A"}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-indigo-300 mb-2">First Action Items</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90">${(p.action_items || []).map((a) => `<li>${a}</li>`).join("")}</ul>
                            ${!(p.action_items && p.action_items.length > 0) ? '<p class="text-white/60 italic text-xs">No specific first steps defined.</p>' : ''}
                        </div>
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-indigo-300 mb-2">KPIs to Track</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90">${(p.kpis_to_track || []).map((k) => `<li>${k}</li>`).join("")}</ul>
                            ${!(p.kpis_to_track && p.kpis_to_track.length > 0) ? '<p class="text-white/60 italic text-xs">No specific KPIs defined.</p>' : ''}
                        </div>
                    </div>
                </div>`;
            });
            initiativesHtml += `</div>`;
         } else {
            initiativesHtml += `<p class="text-center text-white/70">No specific initiatives identified based on input.</p>`;
         }
        initiativesHtml += `</div>`;
        initiativesPanel.innerHTML = initiativesHtml;


        // --- 4. Populate Prioritization Matrix Panel ---
        const matrixPanel = $("matrixPanel");
        matrixPanel.innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> Initiative Prioritization Matrix</h3><div id="initiativeMatrixPlot" class="w-full h-[600px] plotly-chart"></div></div>`;

        if (strategic_initiatives.length > 0) {
            const impactMap = { Low: 1, Medium: 2, High: 3 };
            const effortMap = { Low: 1, Medium: 2, High: 3 };
            // Add jitter to avoid points overlapping perfectly
            const addJitter = (val) => val + (Math.random() - 0.5) * 0.2;

            const matrixData = {
                x: strategic_initiatives.map((p) => addJitter(effortMap[p.effort] || 1)),
                y: strategic_initiatives.map((p) => addJitter(impactMap[p.impact] || 1)),
                text: strategic_initiatives.map((p) => p.initiative_name || "Unnamed"),
                mode: "markers+text",
                textposition: "top right", // Adjusted for better visibility with jitter
                marker: { size: 18, color: "var(--primary)", opacity: 0.8 },
                type: 'scatter' // Ensure type is scatter for jitter
            };
            const matrixLayout = { /* ... keep the same layout as before ... */
                title: { text: "Impact vs. Effort", y:0.95 },
                paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", font: { color: "white" },
                xaxis: { title: "Effort Required", range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ["Low", "Medium", "High"], gridcolor: "rgba(255,255,255,0.2)", zeroline: false },
                yaxis: { title: "Potential Impact", range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ["Low", "Medium", "High"], gridcolor: "rgba(255,255,255,0.2)", zeroline: false },
                shapes: [ { type: "line", x0: 2, y0: 0.5, x1: 2, y1: 3.5, line: { color: "rgba(255,255,255,0.3)", width: 1, dash: "dot" } }, { type: "line", x0: 0.5, y0: 2, x1: 3.5, y1: 2, line: { color: "rgba(255,255,255,0.3)", width: 1, dash: "dot" } } ],
                annotations: [ { x: 1, y: 3, text: "Quick Wins", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } }, { x: 3, y: 3, text: "Major Projects", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } }, { x: 1, y: 1, text: "Fill-ins", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } }, { x: 3, y: 1, text: "Thankless Tasks", showarrow: false, font: { size: 14, color: "rgba(255,255,255,0.6)" } } ]
            };
            Plotly.newPlot("initiativeMatrixPlot", [matrixData], matrixLayout, { responsive: true });
        } else {
             $("initiativeMatrixPlot").innerHTML = `<p class="text-center text-white/70 pt-10">No initiatives identified to plot.</p>`;
        }

        // --- 5. Populate Learn Framework Panel ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding Creative Dissonance (Structural Tension)</h3>

                <p class="italic text-center">Based on the work of Robert Fritz, Creative Dissonance (or Structural Tension) is the gap between the vision of what you want to create and your perception of current reality. This gap generates energy that naturally seeks resolution, driving action and creativity.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/50">
                        <h4 class="text-xl font-bold text-red-300 mb-2"> Current Reality</h4>
                        <p class="text-sm mb-3">A clear, objective, and honest assessment of the present situation. What *is* true right now, including limitations, challenges, and existing resources?</p>
                        <p class="text-sm"><strong>Focus:</strong> Objectivity, facts, data, current state.</p>
                        <p class="text-sm mt-2"><strong>Pitfall to Avoid:</strong> Letting the current reality limit your vision.</p>
                    </div>

                    <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/50">
                        <h4 class="text-xl font-bold text-green-300 mb-2"> Future Vision</h4>
                        <p class="text-sm mb-3">A compelling picture of the desired future state. What do you truly want to create or achieve? This should be aspirational and clearly defined.</p>
                        <p class="text-sm"><strong>Focus:</strong> Aspiration, desired outcome, clarity, intrinsic motivation.</p>
                        <p class="text-sm mt-2"><strong>Pitfall to Avoid:</strong> Making the vision a reaction to current problems (it should be about creation).</p>
                    </div>
                </div>

                 <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50 mt-6">
                        <h4 class="text-xl font-bold text-yellow-300 mb-2"> The Tension (The Gap)</h4>
                        <p class="text-sm mb-3">The difference between the Vision and Current Reality creates a natural tension. This isn't a problem to be solved, but a structure that inherently seeks resolution.</p>
                        <p class="text-sm"><strong>Mechanism:</strong> Just like a stretched rubber band wants to return to equilibrium, this structural tension drives action towards the vision OR pulls the vision down towards reality.</p>
                        <p class="text-sm mt-2"><strong>Key Insight:</strong> You resolve the tension by taking actions that move reality closer to the vision.</p>
                 </div>

                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">How This Tool Applies It:</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Dissonance Points & Gap Analysis:</strong> Clearly defines the specific areas of tension between your stated reality and vision.</li>
                        <li><strong>Strategic Initiatives:</strong> Proposes concrete actions aimed at altering the current reality structure to move it towards the desired vision, thereby resolving the tension constructively.</li>
                        <li><strong>Prioritization Matrix:</strong> Helps focus resources on initiatives likely to have the biggest impact in closing the gap relative to the effort required.</li>
                    </ul>
                 </div>
                 <p class="text-xs text-center text-white/60 mt-4">Note: This framework emphasizes creating the future you want, rather than just solving problems from the past.</p>
            </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     const chart = targetPanel.querySelector(".plotly-chart");
                     if (chart) Plotly.Plots.resize(chart); // Resize chart if panel becomes active
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator
    }

   function createLivingSystemLayout_NS(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-4xl mx-auto w-full p-6 space-y-6">
                             <h3 class="text-xl font-bold mb-4 text-center text-white">Describe Your Living System</h3>
                             
                             <div class="mb-4">
                                <label for="lsLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="lsLocation" class="input-field" placeholder="e.g., Global, Local Community, Specific Ecosystem">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Detailed Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="lsCoreIdentity" class="block text-lg font-medium text-gray-200 mb-2"> Core Identity (DNA)</label>
                                        <textarea id="lsCoreIdentity" class="input-field h-32" placeholder="What is your organization's fundamental purpose, mission, and core values?"></textarea>
                                    </div>
                                    <div>
                                        <label for="lsEnvironment" class="block text-lg font-medium text-gray-200 mb-2"> Environment</label>
                                        <textarea id="lsEnvironment" class="input-field h-32" placeholder="Describe your market, competitors, customers, and key trends."></textarea>
                                    </div>
                                    <div>
                                        <label for="lsMetabolism" class="block text-lg font-medium text-gray-200 mb-2"> Metabolism</label>
                                        <textarea id="lsMetabolism" class="input-field h-32" placeholder="How does your organization take in resources (revenue, talent, data) and convert them into value?"></textarea>
                                    </div>
                                    <div>
                                        <label for="lsNervousSystem" class="block text-lg font-medium text-gray-200 mb-2"> Nervous System</label>
                                        <textarea id="lsNervousSystem" class="input-field h-32" placeholder="How does information flow? How do you sense changes and make decisions?"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div id="docUploadArea" class="hidden max-w-md mx-auto">
                                <div class="input-file-wrapper">
                                    <label for="lsFile" id="lsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="lsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Diagnose Living System</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">System Health Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("lsFile", "lsFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createLivingSystemLayout_NS");
        }
    }

    async function handleLivingSystemAnalysis_NS() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Diagnosing System Health...</h3><p class="text-white/80 mb-2">Analyzing metabolism, nervous system, and immune response using enhanced, context-aware prompting...</p></div>`;
        setLoading("generate", true); // Set loading state

        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Using Llama 3.1 as requested

        try {
            const useDoc = $("docUpload").checked;
            let systemDescription = "";

            if (useDoc) {
                const file = $("lsFile").files[0];
                if (!file) throw new Error(" Please select a document to upload.");
                systemDescription = await extractTextFromFile(file);
                console.log("Extracted text from Living System context file.");
            } else {
                // Combine text area inputs into a single description
                const coreIdentity = $("lsCoreIdentity")?.value.trim() || "Not specified.";
                const environment = $("lsEnvironment")?.value.trim() || "Not specified.";
                const metabolism = $("lsMetabolism")?.value.trim() || "Not specified.";
                const nervousSystem = $("lsNervousSystem")?.value.trim() || "Not specified.";

                if (!coreIdentity || !environment || !metabolism || !nervousSystem) {
                    throw new Error(" Please fill out all four detailed input sections (Core Identity, Environment, Metabolism, Nervous System).");
                }
                systemDescription = `Core Identity (DNA): ${coreIdentity}\n\nEnvironment: ${environment}\n\nMetabolism: ${metabolism}\n\nNervous System: ${nervousSystem}`;
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("lsLocation").value.trim();
            if (location) {
                systemDescription = `Target Location/Region: ${location}\n\n${systemDescription}`;
                console.log("Injected location into Living System Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000; // Adjust based on Llama 3.1 capabilities
            if (systemDescription.length > MAX_CONTEXT_LENGTH) {
                console.warn(`Living System description truncated to ${MAX_CONTEXT_LENGTH} characters.`);
                systemDescription = systemDescription.substring(0, MAX_CONTEXT_LENGTH);
            }

            // --- Enhanced Prompt ---
            const prompt = `
                You are an expert organizational strategist specializing in applying the "Living System" or "Viable System Model" principles to diagnose business health. Analyze the user's provided description *strictly* based on that context.

                **USER'S SYSTEM DESCRIPTION:**
                """
                ${systemDescription}
                """

                **VALIDATION:**
                If the text is gibberish, return the INVALID structure.

                **TASK:**
                Perform a comprehensive Living System diagnosis. Identify the health status and provide analysis for each key system component *based solely on evidence within the user's description*. Formulate specific strategic interventions to address identified weaknesses, again, grounded *only* in the provided text.

                1.  **overall_diagnosis**: Provide a concise, 1-2 sentence overall assessment of the system's health and key challenges *as described by the user*.

                2.  **system_analysis**: Create an array analyzing the core system components. For each component (Metabolism, Nervous System, Immune System, Growth & Adaptation):
                    * system_name: The name of the component.
                    * health_status: Assess the health as "Robust," "Strained," or "Fragile" *based strictly on evidence (or lack thereof) in the user's text*. If the text provides no information to judge a component, default to "Strained" and state the lack of evidence in the analysis.
                    * analysis: Explain *why* you assigned that health status, citing specific examples, phrases, or lack of information *from the user's description*.

                3.  **strategic_interventions**: Develop an array of 2-4 specific strategic initiatives designed *only* to address the weaknesses identified in the system_analysis section and supported by the user's context. For each initiative:
                    * initiative_name: A clear, action-oriented name (under 10 words).
                    * target_system: The primary system component(s) this initiative aims to improve (e.g., "Metabolism", "Nervous System").
                    * rationale: Explain *how* this initiative directly addresses a weakness identified in the system_analysis, referencing the user's context.
                    * action_items: List 2-3 concrete first steps to begin implementing this initiative, logically derived from the context.
                    * kpis_to_track: List 2-3 specific, measurable KPIs relevant to the initiative's goal, based on the context.

                **ABSOLUTE CONSTRAINTS (CRITICAL):**
                - **GROUNDING:** Every diagnosis, analysis point, health status, and intervention MUST be directly traceable to specific statements or the lack of specific information within the "USER'S SYSTEM DESCRIPTION". Do NOT infer beyond the text.
                - **NO FABRICATION:** Do NOT invent organizational problems, strengths, strategies, or metrics not explicitly supported by the provided text.
                - **FRAMEWORK ADHERENCE:** Interpret the user's text through the lens of the Living System components (Metabolism, Nervous System, Immune System, Growth/Adaptation).
                - **HEALTH STATUS JUSTIFICATION:** Clearly justify each "Robust," "Strained," or "Fragile" assessment using evidence *from the text*. If evidence is missing, state that.
                - **INTERVENTION LINKAGE:** Interventions must *only* target weaknesses identified in *your* system_analysis section.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object with the exact structure specified below. Ensure all fields adhere strictly to the grounding constraints.
                {
                  "overall_diagnosis": "Concise overall assessment based ONLY on user text.",
                  "system_analysis": [
                    {
                      "system_name": "Metabolism",
                      "health_status": "Robust/Strained/Fragile (Justified by text)",
                      "analysis": "Explanation citing specific user text or lack thereof..."
                    },
                    {
                      "system_name": "Nervous System",
                      "health_status": "Robust/Strained/Fragile (Justified by text)",
                      "analysis": "Explanation citing specific user text or lack thereof..."
                    },
                    {
                      "system_name": "Immune System", // How it handles threats/change
                      "health_status": "Robust/Strained/Fragile (Justified by text)",
                      "analysis": "Explanation citing specific user text or lack thereof..."
                    },
                    {
                      "system_name": "Growth & Adaptation", // How it evolves/learns
                      "health_status": "Robust/Strained/Fragile (Justified by text)",
                      "analysis": "Explanation citing specific user text or lack thereof..."
                    }
                  ],
                  "strategic_interventions": [ // Only if weaknesses identified
                    {
                      "initiative_name": "Initiative Name 1",
                      "target_system": "System Name(s)",
                      "rationale": "How this addresses a specific weakness identified above, citing text...",
                      "action_items": ["Action 1.1 derived from context", "Action 1.2 derived from context"],
                      "kpis_to_track": ["KPI 1.1 from context", "KPI 1.2 from context"]
                    },
                    { /* ... 2-4 total, if applicable ... */ }
                  ]
                }
            `;

            console.log("Sending STRICTLY GROUNDED Living System prompt to Llama 3.1...");
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: { num_ctx: 32768 } // Adjust context window if needed
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
            const data = await response.json();

            let parsedData;
            try {
                 parsedData = JSON.parse(data.response);
                 console.log("Successfully parsed Living System JSON response from Llama 3.1.");
            } catch (e) {
                console.error("Failed to parse Living System JSON response:", data.response, e);
                throw new Error("Invalid JSON received from AI (Living System). Check AI logs or input text.");
            }

            // Minimal validation
            if (!parsedData.overall_diagnosis || !parsedData.system_analysis || !Array.isArray(parsedData.system_analysis) || parsedData.system_analysis.length < 4 || !parsedData.strategic_interventions) {
                 console.error("Parsed JSON structure is invalid (Living System):", parsedData);
                 throw new Error("AI response structure is incorrect (Living System).");
            }
             // Store original inputs if text areas were used, for potential display
             if (!$("docUpload").checked) {
                  parsedData.original_inputs = {
                     coreIdentity: $("lsCoreIdentity")?.value.trim() || "",
                     environment: $("lsEnvironment")?.value.trim() || "",
                     metabolism: $("lsMetabolism")?.value.trim() || "",
                     nervousSystem: $("lsNervousSystem")?.value.trim() || ""
                  };
             }


            renderLivingSystemPage_NS(analysisResultContainer, parsedData);

        } catch (error) {
            console.error("Error during Living System Analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false); // Stop loading on error
        }
    }

    function renderLivingSystemPage_NS(container, data) {
        container.innerHTML = ""; // Clear loading state
        const { overall_diagnosis, system_analysis, strategic_interventions, original_inputs } = data;

        // Basic validation
        if (!overall_diagnosis || !system_analysis || !Array.isArray(system_analysis) || system_analysis.length < 4 || !strategic_interventions ) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Incomplete or invalid analysis data received. Cannot render Living System plan.</div>`;
            $("analysisActions").classList.add("hidden");
            setLoading("generate", false);
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Standard tabs
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> System Health</button>
            <button class="analysis-tab-btn" data-tab="deepdive"> Deep Dive</button>
            <button class="analysis-tab-btn" data-tab="interventions"> Interventions</button>
            <button class="analysis-tab-btn" data-tab="kpis"> KPI Tracker</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Framework</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active"></div>
            <div id="deepdivePanel" class="analysis-tab-panel"></div>
            <div id="interventionsPanel" class="analysis-tab-panel"></div>
            <div id="kpisPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // Map system names for consistent ordering/display
        const systemMap = {
            "Metabolism": system_analysis.find(s => s.system_name.includes("Metabolism")) || { system_name: "Metabolism", health_status: "Strained", analysis: "Data missing." },
            "Nervous System": system_analysis.find(s => s.system_name.includes("Nervous")) || { system_name: "Nervous System", health_status: "Strained", analysis: "Data missing." },
            "Immune System": system_analysis.find(s => s.system_name.includes("Immune")) || { system_name: "Immune System", health_status: "Strained", analysis: "Data missing." },
            "Growth & Adaptation": system_analysis.find(s => s.system_name.includes("Growth") || s.system_name.includes("Adaptation")) || { system_name: "Growth & Adaptation", health_status: "Strained", analysis: "Data missing." }
        };
        const orderedSystems = ["Metabolism", "Nervous System", "Immune System", "Growth & Adaptation"];


        // --- 1. Populate Dashboard Panel ---
        const dashboardPanel = $("dashboardPanel");
        // Get Core Identity text either from original inputs or analysis if available
         const coreIdentityText = original_inputs?.coreIdentity || system_analysis.find(s => s.system_name.includes("Core Identity"))?.analysis || "Core Identity not specified in detail.";

        let dashboardHtml = `<div class="p-4">
            <blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 mb-8">
                <strong>Overall Diagnosis:</strong> ${overall_diagnosis}
            </blockquote>
            <div class="ls-dashboard-container">
                <div class="ls-core">
                    <h3 class="text-lg font-bold">Core Identity</h3>
                    <p class="text-xs text-white/70 mt-1">${coreIdentityText.substring(0, 100)}${coreIdentityText.length > 100 ? '...' : ''}</p>
                 </div>`;

        // Position nodes consistently
        const positions = [
            { bottom: "5%", left: "50%", transform: "translateX(-50%)" }, // Metabolism at bottom
            { top: "50%", left: "5%", transform: "translateY(-50%)" },   // Nervous System left
            { top: "50%", right: "5%", transform: "translateY(-50%)" },  // Immune System right
            { top: "5%", left: "50%", transform: "translateX(-50%)" }    // Growth & Adaptation at top
        ];

        orderedSystems.forEach((sysName, index) => {
            const sys = systemMap[sysName];
            const pos = positions[index];
            // Normalize health status for class name
            const healthStatusNormalized = (sys.health_status || "strained").toLowerCase();
            const healthClass = `ls-health-${healthStatusNormalized}`; // e.g., ls-health-robust

            dashboardHtml += `<div class="ls-system-node ${healthClass}" style="top:${pos.top || "auto"}; left:${pos.left || "auto"}; right:${pos.right || "auto"}; bottom:${pos.bottom || "auto"}; transform:${pos.transform || 'none'};">
                <h4 class="font-bold text-sm">${sys.system_name}</h4>
                <p class="text-md font-bold mt-1">${sys.health_status || "Unknown"}</p>
            </div>`;
        });
        dashboardHtml += `</div></div>`; // Close ls-dashboard-container and p-4
        dashboardPanel.innerHTML = dashboardHtml;


        // --- 2. Populate Deep Dive Panel ---
        const deepdivePanel = $("deepdivePanel");
        let deepdiveHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4">Deep Dive Analysis</h3>`;
        orderedSystems.forEach((sysName) => {
            const sys = systemMap[sysName];
            const healthStatusNormalized = (sys.health_status || "strained").toLowerCase();
            const healthClass = `ls-health-${healthStatusNormalized}`; // Use normalized status for class

            // Add border color based on health status
            let borderColorClass = "border-gray-500"; // Default border
            if (healthStatusNormalized === "robust") borderColorClass = "border-green-400";
            else if (healthStatusNormalized === "fragile") borderColorClass = "border-red-400";
            else if (healthStatusNormalized === "strained") borderColorClass = "border-yellow-400";


            deepdiveHtml += `<div class="insight-card border-l-4 ${borderColorClass}">
                <h4 class="text-xl font-bold mb-2">${sys.system_name} - <span class="font-semibold ${healthClass}">${sys.health_status || "Unknown"}</span></h4>
                <p class="text-white/90 text-sm">${sys.analysis || "No analysis provided."}</p>
            </div>`;
        });
        deepdiveHtml += `</div>`;
        deepdivePanel.innerHTML = deepdiveHtml;


        // --- 3. Populate Interventions Panel ---
        const interventionsPanel = $("interventionsPanel");
        let interventionsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Strategic Interventions</h3>`;
        if (strategic_interventions && strategic_interventions.length > 0) {
             interventionsHtml += `<div class="space-y-6">`;
             strategic_interventions.forEach((p) => {
                interventionsHtml += `<div class="prescription-card">
                    <h4 class="text-xl font-bold">${p.initiative_name || "Unnamed Initiative"}</h4>
                    <p class="text-xs font-semibold my-1 text-indigo-300">TARGET SYSTEM(S): ${p.target_system || "N/A"}</p>
                    <p class="rationale"><strong>Rationale:</strong> ${p.rationale || "N/A"}</p>
                    <div class="bg-black/20 p-3 rounded text-sm mt-3">
                        <h5 class="font-bold text-yellow-300 mb-2">Action Items</h5>
                        <ul class="list-disc list-inside space-y-1 text-white/90">${(p.action_items || []).map((a) => `<li>${a}</li>`).join("")}</ul>
                        ${!(p.action_items && p.action_items.length > 0) ? '<p class="text-white/60 italic text-xs">No specific action items defined.</p>' : ''}
                    </div>
                </div>`;
            });
             interventionsHtml += `</div>`;
        } else {
             interventionsHtml += `<p class="text-center text-white/70 italic">No specific strategic interventions were identified based on the provided context, likely indicating no major weaknesses were found or derivable.</p>`;
        }
        interventionsHtml += `</div>`;
        interventionsPanel.innerHTML = interventionsHtml;


        // --- 4. Populate KPI Tracker Panel ---
        const kpisPanel = $("kpisPanel");
        let kpisHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Consolidated KPI Tracker</h3>`;
        if (strategic_interventions && strategic_interventions.length > 0 && strategic_interventions.some(p => p.kpis_to_track && p.kpis_to_track.length > 0)) {
            kpisHtml += `<div class="overflow-x-auto"><table class="coeff-table">
                        <thead><tr><th>KPI to Track</th><th>Related Initiative</th><th>Target System</th></tr></thead>
                        <tbody>`;
            strategic_interventions.forEach((p) => {
                (p.kpis_to_track || []).forEach((kpi) => {
                    kpisHtml += `<tr><td>${kpi}</td><td>${p.initiative_name || "N/A"}</td><td>${p.target_system || "N/A"}</td></tr>`;
                });
            });
            kpisHtml += `</tbody></table></div>`;
        } else {
            kpisHtml += `<p class="text-center text-white/70 italic">No specific KPIs identified for the proposed interventions.</p>`;
        }
        kpisHtml += `</div>`;
        kpisPanel.innerHTML = kpisHtml;


        // --- 5. Populate Learn Framework Panel ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding the Living System / Viable System Model (VSM)</h3>

                <p class="italic text-center">This framework views organizations not just as machines, but as complex, adaptive systems akin to living organisms. It helps diagnose systemic health and identify interventions for viability and resilience, drawing heavily on Stafford Beer's Viable System Model.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                        <h4 class="text-xl font-bold text-blue-300 mb-2"> Core Identity (VSM System 5 - Policy)</h4>
                        <p class="text-sm mb-3"><strong>Focus:</strong> The organization's fundamental purpose, values, mission, and long-term direction. Its "DNA."</p>
                        <p class="text-sm"><strong>Health Check:</strong> Is the identity clear, shared, and guiding decisions? Does it align with the environment?</p>
                    </div>

                    <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/50">
                        <h4 class="text-xl font-bold text-green-300 mb-2"> Metabolism (VSM System 1 - Operations)</h4>
                        <p class="text-sm mb-3"><strong>Focus:</strong> How the organization takes in resources (inputs like revenue, materials, talent) and transforms them into value (outputs like products, services).</p>
                        <p class="text-sm"><strong>Health Check:</strong> Are core operations efficient? Is resource conversion effective? Is there waste? Can it acquire needed resources?</p>
                    </div>

                    <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50">
                        <h4 class="text-xl font-bold text-yellow-300 mb-2"> Nervous System (VSM Systems 2, 3, 3* - Coordination, Control, Audit)</h4>
                        <p class="text-sm mb-3"><strong>Focus:</strong> How information flows, how coordination happens, how performance is monitored, and how decisions are made to regulate operations and respond to the environment.</p>
                        <p class="text-sm"><strong>Health Check:</strong> Is information timely and accurate? Are feedback loops effective? Is decision-making swift and informed? Is there internal stability?</p>
                    </div>

                    <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/50">
                        <h4 class="text-xl font-bold text-red-300 mb-2"> Immune System / Adaptation (VSM System 4 - Intelligence/Environment Sensing)</h4>
                        <p class="text-sm mb-3"><strong>Focus:</strong> How the organization senses changes in its external environment (market, competitors, tech), anticipates threats/opportunities, and adapts its strategy and identity for long-term survival.</p>
                        <p class="text-sm"><strong>Health Check:</strong> Is the organization aware of external trends? Can it adapt proactively? Does it learn and evolve its model?</p>
                         <p class="text-xs italic mt-1">(Note: Sometimes 'Immune System' is used more narrowly for internal threat response, while VSM's System 4 covers broader external adaptation.)</p>
                    </div>
                </div>

                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">Why Use This Framework?</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Holistic View:</strong> Considers the organization as an interconnected whole, not just separate parts.</li>
                        <li><strong>Resilience Focus:</strong> Helps identify vulnerabilities and build adaptability for long-term survival.</li>
                        <li><strong>Systemic Diagnosis:</strong> Pinpoints root causes of problems within the system's structure, not just symptoms.</li>
                        <li><strong>Viability Assessment:</strong> Based on principles required for any system (biological or organizational) to remain viable in its environment.</li>
                    </ul>
                 </div>
                 <p class="text-xs text-center text-white/60 mt-4">This analysis maps concepts like Metabolism, Nervous System, etc., onto the core functions described in Stafford Beer's Viable System Model (VSM).</p>
            </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     // const chart = targetPanel.querySelector(".plotly-chart"); // If charts added later
                     // if (chart) Plotly.Plots.resize(chart);
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator AFTER rendering
    }

    function createThinkingSystemLayout_NS(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe a Belief or Conclusion</h3>
                             
                             <div class="mb-4">
                                <label for="tsLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="tsLocation" class="input-field" placeholder="e.g., Corporate HQ, Remote Team, Specific Department">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="tsContent" class="input-field h-48" placeholder="Describe a belief, conclusion, or decision that has led to a recurring problem. For example: 'I believe our marketing campaigns are failing because the creative team is uninspired.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="tsFile" id="tsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="tsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Deconstruct Thinking</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis of Your Thinking System</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("tsFile", "tsFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createThinkingSystemLayout_NS");
        }
    }

    async function handleThinkingSystemAnalysis_NS() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Deconstructing Mental Models...</h3><p class="text-white/80 mb-2">Analyzing your thought process with enhanced prompting to uncover new paths...</p></div>`;
        setLoading("generate", true); // Set loading state

        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Using Llama 3.1 as requested

        try {
            const useDoc = $("docUpload").checked;
            let beliefOrProblemContext = "";

            if (useDoc) {
                const file = $("tsFile").files[0];
                if (!file) throw new Error(" Please select a document to upload.");
                beliefOrProblemContext = await extractTextFromFile(file);
                console.log("Extracted text from Thinking System context file.");
            } else {
                beliefOrProblemContext = $("tsContent").value.trim();
                if (!beliefOrProblemContext) {
                    throw new Error(" Please describe a belief, conclusion, or problem context to analyze.");
                }
            }

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000; // Adjust based on Llama 3.1
            if (beliefOrProblemContext.length > MAX_CONTEXT_LENGTH) {
                console.warn(`Thinking System context truncated to ${MAX_CONTEXT_LENGTH} characters.`);
                beliefOrProblemContext = beliefOrProblemContext.substring(0, MAX_CONTEXT_LENGTH);
            }

            // --- Enhanced Prompt ---
            const prompt = `
                You are an expert facilitator applying Chris Argyris' "Ladder of Inference" framework. Analyze the user's provided text, which describes a belief, conclusion, or a problematic situation resulting from a certain line of thinking. Your task is to deconstruct the likely thought process *down* the ladder and then guide a reframing *up* a potentially more constructive ladder, based *strictly* on the provided context.

                **USER'S CONTEXT (Belief/Problem Description):**
                """
                ${beliefOrProblemContext}
                """

                **VALIDATION:**
                If the text is gibberish, return the INVALID structure.

                **TASK:**
                Perform a Ladder of Inference analysis grounded *exclusively* in the USER'S CONTEXT.

                1.  **Infer Top Rung:** First, infer the core problematic **Action** or **Belief** described or implied at the top of the ladder within the user's context.

                2.  **Deconstruction (Working DOWN the Ladder):** Based *only* on the user's context, reconstruct the likely steps leading to that top rung. For each rung below, explain *how it derives from the rung above it*, citing evidence or logical inference *from the user's text*:
                    * action (The inferred problematic action/decision based on the text).
                    * belief (The inferred underlying belief driving the action, derived from the text).
                    * conclusion (The inferred conclusion drawn from assumptions/interpretations, based on the text).
                    * assumption (Inferred assumptions made based on interpretations, drawn from the text).
                    * interpretation (How selected data/observations were likely interpreted, based on the text).
                    * selection (What specific data or observations from the available 'reality' were likely focused on, ignoring others, based on the text).
                    * observation (The pool of observable data/reality described or implied in the user's text).

                3.  **Reframing (Identifying Leverage & Building UP a New Ladder):**
                    * critical_question: Formulate a challenging question that probes the assumptions or interpretations identified in the deconstruction.
                    * new_observation: Suggest broadening the pool of observable data  what else *could* be observed or considered from the context?
                    * new_interpretation: Offer an alternative, potentially more constructive interpretation of the (potentially broadened) observations.
                    * new_conclusion: State a different conclusion that could logically follow from the new interpretation.

                4.  **New Actions:** Propose 2-3 specific, actionable initiatives based on the new_conclusion. For each action:
                    * action_name: Clear name (under 10 words).
                    * rationale: Explain how this action stems from the reframed perspective and helps address the original problem described in the user's context.
                    * steps: List 2-3 concrete first steps to implement this action.
                    * kpis: List 2-3 measurable KPIs to track the effectiveness of this new action.


                **ABSOLUTE CONSTRAINTS (CRITICAL):**
                - **INPUT GROUNDING:** Every step of the deconstruction and reframing MUST be directly traceable to, or a logical inference *solely based upon*, the information presented in the "USER'S CONTEXT". Do NOT introduce external knowledge or assumptions.
                - **NO FABRICATION:** Do NOT invent observations, interpretations, beliefs, or actions not supported by the user's text.
                - **LADDER LOGIC:** Ensure a clear, step-by-step causal link when moving both down and up the ladder rungs. Explain the connection between rungs based on the context.
                - **FOCUS ON THINKING:** The analysis must focus on deconstructing and reframing the *thought process*, not just listing business problems.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object with the exact structure specified below. Fill all fields according to the constraints, using inferences grounded *only* in the user's context.
                {
                  "deconstruction": {
                    "action": "Inferred action from user text...",
                    "belief": "Inferred belief from user text...",
                    "conclusion": "Inferred conclusion from user text...",
                    "assumption": "Inferred assumption(s) from user text...",
                    "interpretation": "Inferred interpretation from user text...",
                    "selection": "Inferred selected data/observations from user text...",
                    "observation": "Observable reality described/implied in user text..."
                  },
                  "reframing": {
                    "critical_question": "Challenging question based on deconstruction...",
                    "new_observation": "Suggestion to broaden observation based on context...",
                    "new_interpretation": "Alternative interpretation grounded in context...",
                    "new_conclusion": "New conclusion based on alternative interpretation..."
                  },
                  "new_actions": [
                    {
                      "action_name": "New Action Name 1",
                      "rationale": "How this follows from reframing & addresses original problem...",
                      "steps": ["Step 1.1 based on context", "Step 1.2 based on context"],
                      "kpis": ["KPI 1.1 relevant to context", "KPI 1.2 relevant to context"]
                    },
                    { /* ... 1-2 more actions ... */ }
                  ]
                }
            `;

            console.log("Sending STRICTLY GROUNDED Ladder of Inference prompt to Llama 3.1...");
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: { num_ctx: 32768 } // Adjust context window if needed
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
            const data = await response.json();

            let parsedData;
            try {
                 parsedData = JSON.parse(data.response);
                 console.log("Successfully parsed Ladder of Inference JSON response from Llama 3.1.");
            } catch (e) {
                console.error("Failed to parse Ladder of Inference JSON response:", data.response, e);
                throw new Error("Invalid JSON received from AI (Ladder of Inference). Check AI logs or input text.");
            }

            // Minimal validation
            if (!parsedData.deconstruction || !parsedData.reframing || !parsedData.new_actions || !parsedData.deconstruction.observation) {
                 console.error("Parsed JSON structure is invalid (Ladder of Inference):", parsedData);
                 throw new Error("AI response structure is incorrect (Ladder of Inference).");
            }

            renderThinkingSystemPage_NS(analysisResultContainer, parsedData);

        } catch (error) {
            console.error("Error during Thinking System Analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false); // Stop loading on error
        }
    }

    function renderThinkingSystemPage_NS(container, data) {
        container.innerHTML = ""; // Clear loading state
        const { deconstruction, reframing, new_actions } = data;

        // Basic validation
        if (!deconstruction || !reframing || !new_actions || !Array.isArray(new_actions) || !deconstruction.observation ) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Incomplete or invalid analysis data received. Cannot render Ladder of Inference analysis.</div>`;
            $("analysisActions").classList.add("hidden");
            setLoading("generate", false);
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Standard tabs
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="ladder"> Deconstruction</button>
            <button class="analysis-tab-btn" data-tab="reframing"> Reframing</button>
            <button class="analysis-tab-btn" data-tab="actions"> New Actions</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Framework</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="ladderPanel" class="analysis-tab-panel active"></div>
            <div id="reframingPanel" class="analysis-tab-panel"></div>
            <div id="actionsPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Ladder Deconstruction Panel ---
        const ladderPanel = $("ladderPanel");
        // Rungs ordered bottom-up for display
        const rungs = [
            { name: "Observation", text: deconstruction.observation },
            { name: "Selection", text: deconstruction.selection },
            { name: "Interpretation", text: deconstruction.interpretation },
            { name: "Assumption", text: deconstruction.assumption },
            { name: "Conclusion", text: deconstruction.conclusion },
            { name: "Belief", text: deconstruction.belief },
            { name: "Action", text: deconstruction.action }
        ];
        let ladderHtml = `<div class="p-4"><h3 class="text-2xl font-bold text-center mb-6"> Deconstructing the Thought Process (Bottom-Up)</h3><div class="ladder-container">`;
        rungs.forEach(rung => {
             ladderHtml += `<div class="ladder-rung"><h4>${rung.name}</h4><p>${rung.text || "Not explicitly derived from context."}</p></div>`;
             // Add arrow between rungs, except after the last one
             if (rung.name !== "Action") {
                 ladderHtml += `<div class="ladder-arrow"></div>`;
             }
        });
        ladderHtml += `</div></div>`; // Close ladder-container and p-4
        ladderPanel.innerHTML = ladderHtml;


        // --- 2. Populate Reframing Panel ---
        const reframingPanel = $("reframingPanel");
        reframingPanel.innerHTML = `<div class="p-4 space-y-6">
             <h3 class="text-2xl font-bold mb-4"> Reframing the Perspective</h3>
            <div class="insight-card">
                <h4 class="text-lg font-bold text-yellow-300"> Critical Question to Challenge Assumptions:</h4>
                <p class="text-white/90 text-md mt-2">${reframing.critical_question || "N/A"}</p>
            </div>
            <div class="insight-card">
                <h4 class="text-lg font-bold"> Building a New Path Up the Ladder:</h4>
                <p class="mt-2 text-sm"><strong>1. Broaden Observations:</strong> What else could be considered? <code>${reframing.new_observation || "N/A"}</code></p>
                <p class="mt-2 text-sm"><strong>2. New Interpretation:</strong> How else could this data be seen? <code>${reframing.new_interpretation || "N/A"}</code></p>
                <p class="mt-2 text-sm"><strong>3. New Conclusion:</strong> What different conclusion arises? <code>${reframing.new_conclusion || "N/A"}</code></p>
                <p class="mt-4 text-sm font-semibold"> This reframed conclusion should lead to more constructive beliefs and actions.</p>
            </div>
        </div>`;

        // --- 3. Populate New Actions Panel ---
        const actionsPanel = $("actionsPanel");
        let actionsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> New Actions Based on Reframing</h3>`;
         if (new_actions.length > 0) {
            actionsHtml += `<div class="space-y-6">`;
            new_actions.forEach((p) => {
                actionsHtml += `<div class="prescription-card">
                    <h4 class="text-xl font-bold">${p.action_name || "Unnamed Action"}</h4>
                    <p class="rationale"><strong>Rationale (Linked to Reframing):</strong> ${p.rationale || "N/A"}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-indigo-300 mb-2">First Steps</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90">${(p.steps || []).map((a) => `<li>${a}</li>`).join("")}</ul>
                             ${!(p.steps && p.steps.length > 0) ? '<p class="text-white/60 italic text-xs">No specific first steps defined.</p>' : ''}
                       </div>
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-indigo-300 mb-2">KPIs to Track</h5>
                            <ul class="list-disc list-inside space-y-1 text-white/90">${(p.kpis || []).map((k) => `<li>${k}</li>`).join("")}</ul>
                             ${!(p.kpis && p.kpis.length > 0) ? '<p class="text-white/60 italic text-xs">No specific KPIs defined.</p>' : ''}
                       </div>
                    </div>
                </div>`;
            });
            actionsHtml += `</div>`;
         } else {
             actionsHtml += `<p class="text-center text-white/70 italic">No specific new actions were formulated based on the reframing.</p>`;
         }
        actionsHtml += `</div>`;
        actionsPanel.innerHTML = actionsHtml;

        // --- 4. Populate Learn Framework Panel ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding the Ladder of Inference</h3>

                <p class="italic text-center">Developed by Chris Argyris, the Ladder of Inference describes the often unconscious thinking process we go through to get from an observation to a decision or action. Understanding it helps us challenge our assumptions and make better decisions.</p>
                 
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                     <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-600/50 space-y-3">
                         <h4 class="text-xl font-bold text-indigo-300 mb-2"> The Rungs (Bottom-Up)</h4>
                         <p class="text-sm"><strong>1. Observation:</strong> Selecting data from the pool of available reality.</p>
                         <p class="text-sm"><strong>2. Selection:</strong> Filtering and choosing specific data to pay attention to (often unconsciously).</p>
                         <p class="text-sm"><strong>3. Interpretation:</strong> Adding meaning to the selected data based on our mental models.</p>
                         <p class="text-sm"><strong>4. Assumption:</strong> Making assumptions based on the interpreted meaning.</p>
                         <p class="text-sm"><strong>5. Conclusion:</strong> Drawing conclusions based on our assumptions.</p>
                         <p class="text-sm"><strong>6. Belief:</strong> Adopting beliefs based on these conclusions.</p>
                         <p class="text-sm"><strong>7. Action:</strong> Taking action based on our beliefs.</p>
                     </div>
                     <div class="bg-black/20 p-4 rounded-lg space-y-4">
                        <h4 class="text-lg font-bold mb-2"> The Danger: Reflexive Loops</h4>
                        <p class="text-sm">Our beliefs influence what data we select next time, creating a "reflexive loop." This reinforces our existing beliefs and can prevent us from seeing contradictory evidence, leading to poor decisions.</p>
                         <h4 class="text-lg font-bold mb-2 mt-4"> Using the Ladder Constructively:</h4>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li><strong>Awareness:</strong> Become conscious of your own thinking process.</li>
                            <li><strong>Reflection:</strong> Question your assumptions and interpretations. Ask "Why do I believe this?"</li>
                            <li><strong>Inquiry:</strong> Seek out different perspectives and data you might have ignored. Ask others how they interpret the situation.</li>
                            <li><strong>Testing:</strong> Test your conclusions and assumptions explicitly.</li>
                        </ul>
                        <p class="text-xs italic mt-3">This tool helps by making the inferred ladder explicit (Deconstruction) and prompting a conscious effort to challenge it (Reframing).</p>
                     </div>
                </div>

                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">Why Use This Framework?</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li>Improves critical thinking and decision-making.</li>
                        <li>Helps uncover hidden assumptions and biases.</li>
                        <li>Facilitates better communication by making reasoning explicit.</li>
                        <li>Enables more effective problem-solving by addressing root mental models.</li>
                        <li>Reduces conflict arising from misunderstood perspectives.</li>
                    </ul>
                 </div>
            </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     // const chart = targetPanel.querySelector(".plotly-chart"); // If charts added later
                     // if (chart) Plotly.Plots.resize(chart);
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator AFTER rendering
    }

    function createSwotTowsLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container p-6 max-w-2xl mx-auto w-full">
                            <h3 class="text-xl font-bold mb-4 text-white">Business Information</h3>
                            
                            <div class="mb-4">
                                <label for="swotLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="swotLocation" class="input-field" placeholder="e.g., North America, Global">
                            </div>

                            <div class="space-y-4">
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="businessContent" class="input-field h-48" placeholder="Describe your business, industry, market position, challenges, opportunities, etc."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                     <div class="input-file-wrapper">
                                         <label for="swotFile" id="swotFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Click to select a file...</span>
                                         </label>
                                         <input type="file" id="swotFile" class="input-file" accept=".txt,.pdf,.docx">
                                    </div>
                                    <p class="text-xs text-white/50 mt-2 text-center">Note: Only .txt files can be read by the browser. PDF/DOCX are not supported for reading.</p>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText">Run SWOT/TOWS Analysis</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                                <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;
        
        // Re-attach event listeners for the newly created elements
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }
        
        // Listeners for radio buttons
        $("textInput").addEventListener("change", () => {
            $("textInputArea").classList.remove("hidden");
            $("docUploadArea").classList.add("hidden");
        });
        $("docUpload").addEventListener("change", () => {
            $("textInputArea").classList.add("hidden");
            $("docUploadArea").classList.remove("hidden");
        });
        // Listener for file input
        const fileInput = $("swotFile");
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $("swotFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                } else {
                    fileNameSpan.textContent = "Click to select a file...";
                    label.classList.remove("has-file");
                }
            });
        }

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createSwotTowsLayout");
        }
    }

   function createMiscLayout_MSC(template) {
        const contentContainer = document.getElementById("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
            <div class="lg:col-span-1">
                <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                
                <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                    <h3 class="text-xl font-bold mb-4 text-white">Provide Full Strategic Plan / Business Document</h3>
                    
                    <div>
                        <label for="miscCompanyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label>
                        <input type="text" id="miscCompanyName" class="input-field" placeholder="e.g., Innovate Inc." required>
                    </div>

                    <div>
                        <label for="miscLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                        <input type="text" id="miscLocation" class="input-field" placeholder="e.g., Global, North America, Online">
                    </div>

                    <div class="input-radio-group">
                        <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                        <label for="textInput" class="input-radio-label">Text Input</label>
                        <input type="radio" name="inputType" id="docUpload" class="input-radio">
                        <label for="docUpload" class="input-radio-label">Document Upload</label>
                    </div>

                    <div id="textInputArea">
                        <textarea id="miscContent" class="input-field h-48" placeholder="Paste your complete business plan, strategic analysis, or project proposal here..."></textarea>
                    </div>

                    <div id="docUploadArea" class="hidden">
                        <div class="input-file-wrapper">
                            <label for="miscFile" id="miscFileLabel" class="input-file-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                <span class="file-name">Select .docx or .txt file...</span>
                            </label>
                            <input type="file" id="miscFile" class="input-file" accept=".txt,.docx">
                        </div>
                    </div>
                    
                    <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                        <span id="generateBtnText"> Compile Final Report</span>
                        <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                    
                    <div class="text-center mt-4">
                        <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                    </div>
                </div>
                
                <div class="mt-12">
                    <h2 class="text-3xl font-bold mb-4 text-center">Final Sections</h2>
                    <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                    <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                        <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                        <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                    </div>
                </div>
            </div>
        `;
        
        // Re-attach listeners
        setupInputToggle("miscFile", "miscFileLabel", "textInputArea", "docUploadArea");

        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') navigateTo('feedback');
            });
        }
    }

    function createLeveragePointsLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Single column layout
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide System Description</h3>
                             
                             <div class="mb-2">
                                <label for="leverageLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="leverageLocation" class="input-field" placeholder="e.g., Global, North America, Online, Specific City">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="leverageContent" class="input-field h-48" placeholder="Describe the system, its components, the goal of the system, and any challenges or inefficiencies you have observed..."></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                 <div class="input-file-wrapper">
                                     <label for="leverageFile" id="leverageFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                     </label>
                                     <input type="file" id="leverageFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Find Leverage Points</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

        // Re-attach all necessary event listeners for the new elements
        setupInputToggle("leverageFile", "leverageFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createLeveragePointsLayout");
        }
    }

    function createArchetypeAnalysisLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Change layout to single column
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide System Information</h3>
                             
                             <div class="mb-2">
                                <label for="archetypeLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="archetypeLocation" class="input-field" placeholder="e.g., Global Market, Local Community, Specific Branch">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="archetypeContent" class="input-field h-48" placeholder="Describe the system, its components, behaviors, and any recurring problems or patterns you have observed..."></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                 <div class="input-file-wrapper">
                                     <label for="archetypeFile" id="archetypeFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                     </label>
                                     <input type="file" id="archetypeFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Analyze System</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                            <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

        // Attach event listeners
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // Add listeners for radio buttons and file input
        $("textInput").addEventListener("change", () => {
            $("textInputArea").classList.remove("hidden");
            $("docUploadArea").classList.add("hidden");
        });
        $("docUpload").addEventListener("change", () => {
            $("textInputArea").classList.add("hidden");
            $("docUploadArea").classList.remove("hidden");
        });

        const fileInput = $("archetypeFile");
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $("archetypeFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                } else {
                    fileNameSpan.textContent = "Select .docx or .txt file...";
                    label.classList.remove("has-file");
                }
            });
        }

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createArchetypeAnalysisLayout");
        }
    }

    


    function createParetoLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div>
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="max-w-2xl mx-auto">
                            <div class="glass-container p-6 space-y-4">
                                
                                <div class="mb-2">
                                    <label for="paretoLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                    <input type="text" id="paretoLocation" class="input-field" placeholder="e.g., Manufacturing Plant A, Global HQ, Supply Chain - Asia">
                                </div>
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <label for="problemStatement" class="block text-sm font-medium text-gray-200 mb-2">Problem Statement</label>
                                    <textarea id="problemStatement" class="input-field h-32" placeholder="Describe the problem you want to analyze, including symptoms, context, and any known contributing factors..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                     <div class="input-file-wrapper">
                                         <label for="paretoFile" id="paretoFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Click to select a file...</span>
                                         </label>
                                         <input type="file" id="paretoFile" class="input-file" accept=".txt,.pdf,.docx">
                                    </div>
                                    <p class="text-xs text-white/50 mt-2 text-center">Upload a document describing the problem.</p>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText">Analyze Root Causes</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                                <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                                </div>
                            </div>
                        </div>
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                            </div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        // Add listeners for radio buttons and file input
        $("textInput").addEventListener("change", () => {
            $("textInputArea").classList.remove("hidden");
            $("docUploadArea").classList.add("hidden");
        });
        $("docUpload").addEventListener("change", () => {
            $("textInputArea").classList.add("hidden");
            $("docUploadArea").classList.remove("hidden");
        });

        const fileInput = $("paretoFile");
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $("paretoFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                } else {
                    fileNameSpan.textContent = "Click to select a file...";
                    label.classList.remove("has-file");
                }
            });
        }

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createParetoLayout");
        }
    }

    function createProcessMappingLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-4">
                               <h3 class="text-xl font-bold mb-4 text-white">Process Information</h3>
                               
                               <div class="mb-2">
                                    <label for="processLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                    <input type="text" id="processLocation" class="input-field" placeholder="e.g., Manufacturing Plant, Global HQ, Online, Specific City">
                               </div>
                               <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="processContent" class="input-field h-48" placeholder="Describe the business process from start to finish. Include the steps, roles involved, and any decision points..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="processFile" id="processFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .txt or .docx file...</span>
                                        </label>
                                        <input type="file" id="processFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Map Process</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                                <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"></div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;
        setupInputToggle("processFile", "processFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createProcessMappingLayout");
        }
    }

   function createSystemThinkingLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                     <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-4">
                                <h3 class="text-xl font-bold mb-4 text-white">System Description</h3>
                                
                                <div class="mb-2">
                                    <label for="systemLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                    <input type="text" id="systemLocation" class="input-field" placeholder="e.g., Corporate HQ, Specific Plant, Global Supply Chain">
                                </div>
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="systemContent" class="input-field h-48" placeholder="Describe the system you want to analyze. Include key elements, their relationships, and any observed behaviors or problems..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="systemFile" id="systemFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .txt or .docx file...</span>
                                        </label>
                                        <input type="file" id="systemFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Analyze System Dynamics</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                                <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                                </div>
                            </div>
                        </div>
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"></div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;
        setupInputToggle("systemFile", "systemFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        } else {
            console.warn("Feedback link not found inside createSystemThinkingLayout");
        }
    }
   
    function createSemAnalysisLayout(template) {
    const contentContainer = $("templateDetailContent");
    contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Single column layout

        // --- HTML Structure ---
        contentContainer.innerHTML = `
            <div class="lg:col-span-1">
                <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

            <div class="max-w-2xl mx-auto w-full">
                <div class="glass-container p-6 space-y-6">
                    
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xl font-bold text-white">Analysis Configuration</h3>
                        <div class="flex items-center space-x-2">
                            <button type="button" id="configExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                            <button type="button" onclick="triggerBackendDownload(\'sem\', \'sem-sample-data.csv\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .csv</button>
                            <button type="button" id="useSemSampleBtn" class="btn-sample btn-use-sample" data-template-id="sem-analysis"> Use Sample</button>
                        </div>
                    </div>

                    <div id="configExamples" class="hidden mb-4 p-3 bg-black/20 border border-white/15 rounded-lg">
                        <div class="text-xs font-medium text-white/90 mb-2"> Configuration Examples</div>
                        <div class="space-y-2 text-xs">
                            <div id="exampleContent" class="text-white/80">Loading example...</div>
                        </div>
                    </div>

                        <div class="input-radio-group">
                            <input type="radio" name="semInputType" id="semInputTextToggle" class="input-radio" checked>
                            <label for="semInputTextToggle" class="input-radio-label">Text Input</label>
                            <input type="radio" name="semInputType" id="semInputFileToggle" class="input-radio">
                            <label for="semInputFileToggle" class="input-radio-label">Document Upload</label>
                        </div>

                        <div id="semFileUploadArea" class="hidden">
                            <label for="semFile" class="block text-sm font-medium text-gray-200 mb-2">Data File (.csv, .xlsx)</label>
                            <div class="input-file-wrapper">
                                <label for="semFile" id="semFileLabel" class="input-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                    <span class="file-name">Select data file...</span>
                                </label>
                                <input type="file" id="semFile" class="input-file" accept=".csv,.xlsx">
                            </div>
                            <div id="semFileError" class="text-red-400 text-sm mt-2"></div>
                        </div>

                        <div id="semTextInputArea">
                            <label for="semDataText" class="block text-sm font-medium text-gray-200 mb-2">Paste CSV Data</label>
                            <textarea id="semDataText" class="input-field h-48" placeholder="Date,Var1,Var2...\n2023-01-01,10,20..."></textarea>
                            <div id="semTextError" class="text-red-400 text-sm mt-2"></div>
                        </div>

                        <div id="semDataPreview" class="space-y-2">
                            <label class="block text-sm font-medium text-gray-200">Data Preview (First 5 Rows)</label>
                            <div class="overflow-x-auto rounded-lg border border-white/20">
                                <table class="min-w-full text-left text-sm text-white/90" id="semPreviewTable">
                                    <tbody>
                                        <tr>
                                            <td class="p-4 text-center text-white/60" colspan="100%">Upload or paste data to see a preview.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div>
                            <label for="semModelTemplate" class="block text-sm font-medium text-gray-200 mb-2">Model Template</label>
                            <select id="semModelTemplate" class="input-field" disabled>
                                <option value="">-- Upload or paste data first --</option>
                            </select>
                        </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label for="semMeasurementSyntax" class="block text-sm font-medium text-gray-200">Measurement Model Syntax</label>
                            <button type="button" id="measurementExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                        </div>
                        <div id="measurementExamples" class="hidden mb-2 p-3 bg-black/20 border border-white/15 rounded-lg">
                            <div class="text-xs font-medium text-white/90 mb-2"> Measurement Model Examples</div>
                            <div class="space-y-2 text-xs">
                                <div>
                                    <div class="text-white/80 mb-1">Basic Factor Structure:</div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                        Anxiety =~ anx1 + anx2 + anx3 + anx4<br>Depression =~ dep1 + dep2 + dep3 + dep4
                                    </div>
                                </div>
                                <div>
                                    <div class="text-white/80 mb-1">With Fixed Loadings:</div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                        Performance =~ 1*perf1 + perf2 + perf3<br>Satisfaction =~ 1*sat1 + sat2 + sat3
                                    </div>
                                </div>
                            </div>
                        </div>
                        <textarea id="semMeasurementSyntax" class="input-field h-32" placeholder="e.g., Factor1 =~ varA + varB\nFactor2 =~ varC + varD..."></textarea>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label for="semStructuralSyntax" class="block text-sm font-medium text-gray-200">Structural Model Syntax</label>
                            <button type="button" id="structuralExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                        </div>
                        <div id="structuralExamples" class="hidden mb-2 p-3 bg-black/20 border border-white/15 rounded-lg">
                            <div class="text-xs font-medium text-white/90 mb-2"> Structural Model Examples</div>
                            <div class="space-y-2 text-xs">
                                <div>
                                    <div class="text-white/80 mb-1">Simple Regression:</div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                        Performance ~ Motivation + Ability<br>Satisfaction ~ Performance
                                    </div>
                                </div>
                                <div>
                                    <div class="text-white/80 mb-1">Mediation Model:</div>
                                    <div class="bg-black/30 p-2 rounded font-mono text-white/90 relative">
                                        Outcome ~ c*Predictor + b*Mediator<br>Mediator ~ a*Predictor<br><br>indirect := a*b<br>total := c + (a*b)
                                    </div>
                                </div>
                            </div>
                        </div>
                        <textarea id="semStructuralSyntax" class="input-field h-32" placeholder="e.g., Factor1 ~ Factor2\nObservedVar ~ Factor1..."></textarea>
                    </div>

                        <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                            <span id="generateBtnText"> Run SEM Analysis</span>
                            <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div class="text-center mt-4">
                                    <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                        </div>
                    </div>
                </div>

                <div class="mt-12">
                    <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                    <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"> {/* Results will be injected here */} </div>
                    <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                        <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                        <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                    </div>
                </div>
            </div>`;

    // --- Attach Core Event Listeners ---
    $("generateBtn").addEventListener("click", handleGenerate); 
    reattachActionListeners(); 

    // --- Add Example Toggle Event Listeners ---
    $("configExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("configExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        
        if (isHidden) {
            // Display hardcoded example content immediately
            const exampleContent = $("exampleContent");
            const exampleText = `Date,Performance_Score,Satisfaction_Rating,Quality_Index,Revenue_USD
2023-01-01,85,4.2,8.5,15000
2023-02-01,87,4.4,8.7,16200
2023-03-01,89,4.6,8.9,17500
2023-04-01,82,4.1,8.2,14800
2023-05-01,91,4.8,9.1,18900
2023-06-01,88,4.5,8.8,17200`;

            exampleContent.innerHTML = `
                <div class="bg-black/30 p-2 rounded font-mono text-white/90 text-xs whitespace-pre-wrap">${exampleText}</div>
                <div class="text-white/60 text-xs mt-2 space-y-1">
                    <div class="font-medium text-white/80">SEM Data Requirements:</div>
                    <div> <strong>Clean column names:</strong> No spaces, symbols, or special characters (use underscores instead)</div>
                    <div> <strong>Numeric data only:</strong> All measurement variables must be numbers</div>
                    <div> <strong>Sample size:</strong> Minimum 200 rows recommended for reliable results</div>
                    <div> <strong>No missing values:</strong> Complete data for all variables (or <10% missing)</div>
                    <div> <strong>Variable types:</strong> Use meaningful names like Performance_Score, Customer_Satisfaction</div>
                    <div> <strong>Scale consistency:</strong> Use same scale for related measures (e.g., all 1-10 ratings)</div>
                </div>
            `;
        }
        
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

    $("measurementExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("measurementExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

    $("structuralExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("structuralExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

        // --- Restore Cached Results (if any) ---
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult")); 
        } else {
            $("analysisResult").innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // --- Get References to SEM-Specific DOM Elements ---
        const fileInput = $("semFile");
        const textInput = $("semDataText");
        const measurementSyntaxBox = $("semMeasurementSyntax");
        const structuralSyntaxBox = $("semStructuralSyntax");
        const fileError = $("semFileError");
        const textError = $("semTextError");
        const fileToggle = $("semInputFileToggle");
        const textToggle = $("semInputTextToggle");
        const fileArea = $("semFileUploadArea");
        const textArea = $("semTextInputArea");
        const dataPreviewContainer = $("semDataPreview");
        const previewTable = $("semPreviewTable");
        const modelTemplateSelect = $("semModelTemplate");
        let fullHeaders = []; 

        // --- SEM Helper Functions (with MODIFICATIONS) ---

        const getHeadersFromText = (text) => {
            if (!text || typeof text !== 'string' || !text.trim()) throw new Error("Input text is empty.");
            const firstLine = text.split(/[\r\n]+/)[0];
            if (!firstLine || !firstLine.trim()) throw new Error("First line (header) is empty.");

            let headers = firstLine.split(',').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length <= 1) headers = firstLine.split(';').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length <= 1) headers = firstLine.split('\t').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
            if (headers.length === 0) throw new Error("Could not parse headers (tried comma, semicolon, tab).");
            return headers;
        };

        /** === MODIFIED showDataPreview === */
        const showDataPreview = (csvText) => {
            try {
                const lines = csvText.split(/[\r\n]+/).filter(Boolean); 
                const rows = lines.slice(0, 6); 
                
                // === MODIFIED: Show placeholder if file is empty/no rows ===
                if (rows.length < 2) { 
                    previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Data file is empty or has no data rows.</td></tr></tbody>';
                    dataPreviewContainer.classList.remove("hidden"); 
                    return; 
                }

                const headers = getHeadersFromText(rows[0]);
                let tableHTML = '<thead class="bg-white/10 text-xs uppercase"><tr>';
                headers.forEach(h => { tableHTML += `<th scope="col" class="px-4 py-2">${h}</th>`; });
                tableHTML += '</tr></thead><tbody>';

                rows.slice(1).forEach((line, rowIndex) => {
                    let cells = line.split(',');
                    if (cells.length !== headers.length) cells = line.split(';');
                    if (cells.length !== headers.length) cells = line.split('\t');

                    tableHTML += `<tr class="border-t border-white/10 ${rowIndex % 2 === 0 ? 'bg-white/5' : ''}">`;
                    headers.forEach((_, cellIndex) => {
                        tableHTML += `<td class="px-4 py-2">${cells[cellIndex] === undefined ? '' : cells[cellIndex]}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody>';
                previewTable.innerHTML = tableHTML;
                dataPreviewContainer.classList.remove("hidden"); // Ensure it's visible
            } catch (e) {
                console.error("Error showing data preview:", e);
                // === MODIFIED: Show error in table ===
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-red-400" colspan="100%">Error reading data preview.</td></tr></tbody>';
                dataPreviewContainer.classList.remove("hidden"); // Ensure it's visible
            }
        };

    const updateModelTemplates = (headers) => {
        fullHeaders = headers;
        modelTemplateSelect.innerHTML = '';
        modelTemplateSelect.add(new Option("Select a model template...", ""));
        modelTemplateSelect.add(new Option("Custom Syntax (Type below)", "custom"));
        modelTemplateSelect.add(new Option("Auto-Suggest (Generic Model)", "autosuggest"));
        modelTemplateSelect.disabled = false;
    };

        const populateSyntaxBoxes = (fullSyntax) => {
            const uncommentedSyntax = fullSyntax.split('\n')
                .filter(line => !line.trim().startsWith('#'))
                .join('\n');
            const lines = uncommentedSyntax.split('\n');
            let measurement = [], structural = [], foundStructural = false;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                if (trimmedLine.includes('~') && !trimmedLine.includes('=~')) foundStructural = true;
                if (foundStructural) structural.push(line);
                else measurement.push(line);
            });

            measurementSyntaxBox.value = measurement.join('\n').trim();
            structuralSyntaxBox.value = structural.join('\n').trim();
            measurementSyntaxBox.placeholder = measurementSyntaxBox.value ? measurementSyntaxBox.placeholder : "e.g., F1 =~ x1+x2";
            structuralSyntaxBox.placeholder = structuralSyntaxBox.value ? structuralSyntaxBox.placeholder : "e.g., F1 ~ F2";
        };

        const generateRecommendedSyntax = () => {
            const fullSyntax = `
    Marketing =~ Ad_Spend_USD + Brand_Awareness_Pct
    Profit_USD ~ Marketing + Online_Sales_USD + Retail_Sales_USD`;
            populateSyntaxBoxes(fullSyntax);
        };

    const generateSyntax = () => {
        if (fullHeaders.length === 0) { 
            alert("Data headers not found for auto-suggestion."); 
            return; 
        }
        const excludePatterns = ['id', 'date', 'time', 'timestamp', 'index', 'row'];
        const analyticalHeaders = fullHeaders.filter(h => 
            !excludePatterns.some(pattern => h.toLowerCase().includes(pattern))
        );
        if (analyticalHeaders.length < 4) {
            populateSyntaxBoxes(`# Need at least 4 numeric columns for SEM\n# Available: ${analyticalHeaders.join(', ')}\n# Please add more numeric variables to your data`);
            return;
        }
        let measurementPart = '';
        let structuralPart = '';
        measurementPart += `Factor1 =~ ${analyticalHeaders[0]} + ${analyticalHeaders[1]}\n`;
        measurementPart += `Factor2 =~ ${analyticalHeaders[2]} + ${analyticalHeaders[3]}\n`;
        structuralPart = 'Factor2 ~ Factor1\n';
        let fullSyntax = measurementPart.trim() + '\n\n' + structuralPart.trim();
        populateSyntaxBoxes(fullSyntax);
    };

        /** === MODIFIED processDataInput === */
        const processDataInput = async (isFileInput) => {
            let textContent = null;
            let originalHeaders = [];
            const errorEl = isFileInput === null ? null : (isFileInput ? fileError : textError);
            const inputEl = isFileInput === null ? null : (isFileInput ? fileInput : textInput);

            if (fileError) fileError.textContent = "";
            if (textError) textError.textContent = "";

            modelTemplateSelect.disabled = true;
            modelTemplateSelect.innerHTML = '<option value="">-- Processing data... --</option>';
            // === MODIFIED: Show processing in table ===
            previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Processing data...</td></tr></tbody>';
            dataPreviewContainer.classList.remove("hidden"); // Make sure it's visible
            
            measurementSyntaxBox.value = ""; 
            structuralSyntaxBox.value = "";
            measurementSyntaxBox.placeholder = "Upload or paste data to see model templates...";
            structuralSyntaxBox.placeholder = "";

            if (isFileInput === null) {
                // === MODIFIED: Show placeholder on reset ===
                modelTemplateSelect.innerHTML = '<option value="">-- Upload or paste data first --</option>';
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Upload or paste data to see a preview.</td></tr></tbody>';
                return;
            }

            try {
                if (isFileInput) {
                    const file = inputEl.files[0];
                    if (!file) {
                        // === MODIFIED: Show placeholder if no file ===
                        modelTemplateSelect.innerHTML = '<option value="">-- Upload or paste data first --</option>';
                        previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Upload or paste data to see a preview.</td></tr></tbody>';
                        return;
                    }
                    textContent = await extractTextFromFile(file);
                } else {
                    textContent = inputEl.value;
                    if (!textContent.trim()) {
                        // === MODIFIED: Show placeholder if no text ===
                        modelTemplateSelect.innerHTML = '<option value="">-- Upload or paste data first --</option>';
                        previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-white/60" colspan="100%">Upload or paste data to see a preview.</td></tr></tbody>';
                        return;
                    }
                }

            originalHeaders = getHeadersFromText(textContent);

            const lines = textContent.split(/[\r\n]+/).filter(Boolean);
            const dataRows = lines.slice(1); 
            
            if (dataRows.length < 10) {
                if (errorEl) errorEl.textContent = "Warning: Very small dataset. Need at least 10 rows for reliable SEM analysis.";
            }
            
            let numericColumnsCount = 0;
            if (dataRows.length > 0) {
                const firstRow = dataRows[0].split(/[,;\t]/);
                firstRow.forEach((cell, index) => {
                    if (index > 0 && !isNaN(parseFloat(cell)) && isFinite(cell)) {
                        numericColumnsCount++;
                    }
                });
            }
            
            if (numericColumnsCount < 3) {
                if (errorEl) errorEl.textContent = "Warning: Most columns appear non-numeric. SEM requires numeric data.";
            }

                showDataPreview(textContent);
                updateModelTemplates(originalHeaders);

            if (dataRows.length >= 10 && numericColumnsCount >= 3) {
                modelTemplateSelect.value = "autosuggest";
                modelTemplateSelect.dispatchEvent(new Event('change'));
            }

            } catch (err) {
                console.error("Input processing failed:", err);
                if (errorEl) errorEl.textContent = `Error: ${err.message}.`;
                modelTemplateSelect.disabled = true;
                modelTemplateSelect.innerHTML = '<option value="">-- Error reading data --</option>';
                // === MODIFIED: Show error in table ===
                previewTable.innerHTML = '<tbody><tr><td class="p-4 text-center text-red-400" colspan="100%">Error reading data preview.</td></tr></tbody>';
                dataPreviewContainer.classList.remove("hidden");
                measurementSyntaxBox.placeholder = "Error reading input data.";
                structuralSyntaxBox.placeholder = "";
            }
        };

        // --- Attach Input Event Listeners ---

        fileToggle.addEventListener("change", () => {
            fileArea.classList.remove("hidden");
            textArea.classList.add("hidden");
            processDataInput(fileInput.files.length > 0 ? true : null); 
        });
        textToggle.addEventListener("change", () => {
            fileArea.classList.add("hidden");
            textArea.classList.remove("hidden");
            processDataInput(textInput.value.trim() ? false : null); 
        });

        if (fileInput) {
            fileInput.addEventListener("change", () => {
                const label = $("semFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (fileInput.files.length > 0) {
                    fileNameSpan.textContent = fileInput.files[0].name;
                    label.classList.add("has-file");
                    processDataInput(true); 
                } else { 
                    fileNameSpan.textContent = "Select data file...";
                    label.classList.remove("has-file");
                    processDataInput(null); 
                }
            });
        }

        if (textInput) {
            textInput.addEventListener("blur", () => { 
                if (!textArea.classList.contains("hidden")) {
                    processDataInput(textInput.value.trim() ? false : null);
                }
            });
        }

        if (modelTemplateSelect) {
            modelTemplateSelect.addEventListener("change", async () => { 
                const selected = modelTemplateSelect.value;
                measurementSyntaxBox.value = ""; 
                structuralSyntaxBox.value = "";

                switch (selected) {
                    case "custom":
                        measurementSyntaxBox.placeholder = "Type measurement model syntax here...";
                        structuralSyntaxBox.placeholder = "Type structural model syntax here...";
                        measurementSyntaxBox.focus(); 
                        break;
                    case "autosuggest":
                        measurementSyntaxBox.placeholder = "Auto-suggesting generic model...";
                        structuralSyntaxBox.placeholder = "Auto-suggesting generic model...";
                        generateSyntax(); 
                        measurementSyntaxBox.placeholder = measurementSyntaxBox.value ? "Review auto-suggested syntax." : "Could not auto-suggest.";
                        structuralSyntaxBox.placeholder = structuralSyntaxBox.value ? "Review auto-suggested syntax." : "";
                        break;
                    case "recommended":
                        measurementSyntaxBox.placeholder = "Loading recommended model...";
                        structuralSyntaxBox.placeholder = "Loading recommended model...";
                        generateRecommendedSyntax(); 
                        measurementSyntaxBox.placeholder = "Review recommended syntax.";
                        structuralSyntaxBox.placeholder = "Review recommended syntax.";
                        break;
                    default:
                        measurementSyntaxBox.placeholder = "Select a model template or type syntax...";
                        structuralSyntaxBox.placeholder = "";
                }
            });
        }

        // Attach listener for the feedback link
                const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
                if (feedbackLink) {
                    feedbackLink.addEventListener("click", (e) => {
                        e.preventDefault();
                        if (typeof navigateTo === 'function') {
                            navigateTo('feedback');
                        } else {
                            console.error("navigateTo function is not defined.");
                        }
                    });
                } else {
                    console.warn("Feedback link not found inside createSemAnalysisLayout");
                }
    }
         
function createPredictiveAnalysisLayout(template) {
    const contentContainer = $("templateDetailContent");
    contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Set layout class

    // --- 1. Build HTML Structure ---
        contentContainer.innerHTML = `
            <div class="lg:col-span-1">
                <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

                <div class="max-w-2xl mx-auto w-full">
                    <div class="glass-container p-6 space-y-6">
                        
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-bold text-white">Forecasting Configuration</h3>
                            <div class="flex items-center space-x-2">
                                <button type="button" id="predictiveExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                                <button type="button" onclick="triggerBackendDownload(\'predictive\', \'predictive-sample-data.csv\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .csv</button>
                                <button type="button" id="usePredSampleBtn" class="btn-sample btn-use-sample" data-template-id="predictive-analysis"> Use Sample</button>
                            </div>
                        </div>

                        <div id="predictiveExamples" class="hidden mb-4 p-3 bg-black/20 border border-white/15 rounded-lg">
                             <div id="predictiveExampleContent">Loading example...</div>
                        </div>

                        <div class="input-radio-group">
                            <input type="radio" name="predictiveInputType" id="predictiveInputTextToggle" class="input-radio" checked>
                            <label for="predictiveInputTextToggle" class="input-radio-label">Text Input</label>
                            <input type="radio" name="predictiveInputType" id="predictiveInputFileToggle" class="input-radio">
                            <label for="predictiveInputFileToggle" class="input-radio-label">Document Upload</label>
                        </div>

                        <div id="predictiveFileUploadArea" class="hidden">
                            <label for="predictiveFile" class="block text-sm font-medium text-gray-200 mb-2">Time Series Data (.csv, .xlsx)</label>
                            <div class="input-file-wrapper">
                                <label for="predictiveFile" id="predictiveFileLabel" class="input-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" 
     fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                                    </svg>
                                    <span class="file-name">Select data file...</span>
                                </label>
                                <input type="file" id="predictiveFile" class="input-file" accept=".csv,.xlsx">
                            </div>
                            <div id="predictiveFileError" class="text-red-400 text-sm mt-2"></div>
                        </div>

                        <div id="predictiveTextInputArea">
                            <label for="predictiveDataText" class="block text-sm font-medium text-gray-200 mb-2">Paste CSV Data</label>
                             <textarea id="predictiveDataText" class="input-field h-48" placeholder="Date,Revenue,Customers\n2023-01-01,150000,1250\n2023-02-01,162000,1340..."></textarea>
                            <div id="predictiveTextError" class="text-red-400 text-sm mt-2"></div>
                        </div>

                        <div id="predictiveDataPreview" class="hidden space-y-2">
                            <label class="block text-sm font-medium text-gray-200">Data Preview (First 5 Rows)</label>
                            <div class="overflow-x-auto rounded-lg border border-white/20">
                                <table class="min-w-full text-left text-sm text-white/90" id="predictivePreviewTable">
                                </table>
                            </div>
                             <p class="text-xs text-white/70">Assuming first column ('<span id="assumedDateColName" class="font-medium">...</span>') is the Date/Time column.</p>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label for="predictiveTargetColumn" class="block text-sm font-medium text-gray-200 mb-2">Target Variable (to Forecast)</label>
                                <select id="predictiveTargetColumn" class="input-field" disabled>
                                      <option value="">-- Upload data first --</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="predictiveForecastPeriods" class="block text-sm font-medium text-gray-200 mb-2">Forecast Periods</label>
                                 <input type="number" id="predictiveForecastPeriods" class="input-field" value="12" min="1" max="48" placeholder="e.g., 12">
                            </div>
                            <div>
                                <label for="predictiveConfidenceLevel" class="block text-sm font-medium text-gray-200 mb-2">Confidence Level</label>
                                <select id="predictiveConfidenceLevel" class="input-field">
                                    <option value="0.80">80%</option>
                                      <option value="0.90" selected>90%</option>
                                    <option value="0.95">95%</option>
                                    <option value="0.99">99%</option>
                                </select>
                            </div>
                             <div>
                                <label for="predictiveModelType" class="block text-sm font-medium text-gray-200 mb-2">Model Type</label>
                                 <select id="predictiveModelType" class="input-field">
                                    <option value="auto" selected>Auto-Select Best</option>
                                    <option value="trend">Simple Trend</option>
                                    <option value="seasonal">Seasonal Forecast</option>
                                    <option value="linear">Linear Regression</option>
                                </select>
                            </div>
                         </div>

                        <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                            <span id="generateBtnText"> Generate Forecast</span>
                            <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div class="text-center mt-4">
                            <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                        </div>
                     </div>
                </div>

                <div class="mt-12">
                    <h2 class="text-3xl font-bold mb-4 text-center">Forecast Results</h2>
                    <div id="analysisResult" class="glass-container min-h-[400px]">
                        <div class="text-white/60 p-8 text-center">Upload your data and configure options to generate a forecast.</div>
                    </div>
                    <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                        <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                        <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                     </div>
                </div>
            </div>
        `;

    // --- 2. Setup Event Listeners ---
    const fileToggle = $("predictiveInputFileToggle");
    const textToggle = $("predictiveInputTextToggle");
    const fileArea = $("predictiveFileUploadArea");
    const textArea = $("predictiveTextInputArea");
    const dataPreviewContainer = $("predictiveDataPreview");
    const previewTable = $("predictivePreviewTable");
    const fileInput = $("predictiveFile");
    const textInput = $("predictiveDataText");
    const targetColumnSelect = $("predictiveTargetColumn");
    const fileError = $("predictiveFileError");
    const textError = $("predictiveTextError");
    const examplesBtn = $("predictiveExamplesBtn");
    const examplesDiv = $("predictiveExamples");
    const generateBtn = $("generateBtn");
    const assumedDateColNameSpan = $("assumedDateColName");

    let fullHeaders = []; // To store all headers
    let assumedDateColumn = null; // To store the name of the assumed date column

    // --- Helper Functions ---

    /**
     * Extracts headers from CSV text, trying common delimiters.
     */
    const getHeadersFromText = (text) => {
        if (!text || typeof text !== 'string' || !text.trim()) throw new Error("Input text is empty.");
        const firstLine = text.split(/[\r\n]+/)[0];
        if (!firstLine || !firstLine.trim()) throw new Error("First line (header) is empty.");

        let headers = 
 firstLine.split(',').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
        if (headers.length <= 1) {
            headers = firstLine.split(';').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
        }
        if (headers.length <= 1) {
            headers = firstLine.split('\t').map(h => h.trim().replace(/^"|"$/g, '')).filter(Boolean);
        }
        if (headers.length === 0) throw new Error("Could not parse headers (tried comma, semicolon, tab). Ensure header row is present.");
        return headers;
    };

    /**
     * Displays the first few rows of CSV data in a preview table.
     */
    const showDataPreview = (csvText) => {
        try {
            const lines = csvText.split(/[\r\n]+/).filter(Boolean);
            const rows = lines.slice(0, 6); // Header + max 5 data rows
            if (rows.length < 2) {
                dataPreviewContainer.classList.add("hidden");
                return;
            }

            const headers = getHeadersFromText(rows[0]);
            let tableHTML 
 = '<thead class="bg-white/10 text-xs uppercase"><tr>';
            headers.forEach(h => { tableHTML += `<th scope="col" class="px-4 py-2">${h}</th>`; });
            tableHTML += '</tr></thead><tbody>';

            rows.slice(1).forEach((line, rowIndex) => {
                let cells = line.split(',');
                if (cells.length !== headers.length) cells = line.split(';');
                if (cells.length !== headers.length) cells = line.split('\t');

                tableHTML += `<tr class="border-t border-white/10 ${rowIndex % 2 === 0 ? 'bg-white/5' : ''}">`;
                headers.forEach((_, cellIndex) => {
                    const cellValue = cells[cellIndex]?.trim().replace(/^"|"$/g, '') ?? '';
                    tableHTML += `<td class="px-4 py-2 whitespace-nowrap overflow-hidden text-ellipsis max-w-[150px]" title="${cellValue}">${cellValue}</td>`;
                 });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody>';
            previewTable.innerHTML = tableHTML;
            dataPreviewContainer.classList.remove("hidden");
        } catch (e) {
            console.error("Error showing data preview:", e);
            dataPreviewContainer.classList.add("hidden");
        }
    };

    /**
     * Updates the Target column dropdown. Assumes first header is date column.
     */
    const updateColumnSelects = (headers) => {
        fullHeaders = headers;
        targetColumnSelect.innerHTML = '<option value="">Select target variable...</option>';
        assumedDateColumn = null;

        if (headers.length === 0) {
            targetColumnSelect.innerHTML = '<option value="">-- No columns found --</option>';
            targetColumnSelect.disabled = true;
            if (assumedDateColNameSpan) assumedDateColNameSpan.textContent = "N/A";
            return;
        }

        assumedDateColumn = headers[0]; // Assume first column is date
        if (assumedDateColNameSpan) assumedDateColNameSpan.textContent = assumedDateColumn;

        let potentialTargetCol = null;

        // Populate target dropdown (skip first column)
        headers.forEach((header, index) => {
             if (index === 0) return; // Skip the assumed date column

            const optionTarget = new Option(header, header);
            targetColumnSelect.add(optionTarget);

            // Auto-detection logic for TARGET column
            const lowerHeader = header.toLowerCase();
            if (!potentialTargetCol && (lowerHeader.includes('revenue') || lowerHeader.includes('sales') || lowerHeader.includes('value') || lowerHeader.includes('count') || lowerHeader.includes('amount') || lowerHeader.includes('target') || lowerHeader.includes('metric'))) {
                potentialTargetCol = header;
            }
        });

        // Auto-select target or fallback to second column
        if (potentialTargetCol) {
            targetColumnSelect.value = potentialTargetCol;
        } else if (headers.length > 1) {
            targetColumnSelect.value = headers[1];
        }

        targetColumnSelect.disabled = false; // Enable target dropdown
    };

    /**
     * Processes data input, updates preview, and column selections.
     */
    const processDataInput = async (isFileInput) => {
        let textContent = null;
        const errorEl = isFileInput === null ? null : (isFileInput ? fileError : textError);

        // Clear errors and reset UI
        if (fileError) fileError.textContent = "";
        if (textError) textError.textContent = "";
        targetColumnSelect.disabled = true;
        targetColumnSelect.innerHTML = '<option value="">-- Processing data... --</option>';
        dataPreviewContainer.classList.add("hidden");
        previewTable.innerHTML = "";
        fullHeaders = [];
        assumedDateColumn = null;
        if (assumedDateColNameSpan) assumedDateColNameSpan.textContent = "...";

        if (isFileInput === null) { // Reset request
            targetColumnSelect.innerHTML = '<option value="">-- Upload data first --</option>';
            if (assumedDateColNameSpan) assumedDateColNameSpan.textContent = "N/A";
            return;
        }

        try {
            // Get data content
            if (isFileInput) {
                const 
 file = fileInput.files[0];
                if (!file) return;
                textContent = await extractTextFromFile(file);
            } else {
                textContent = textInput.value;
                if (!textContent.trim()) return;
            }

            // Extract headers
            const headers = getHeadersFromText(textContent);

            // Basic Validation
            // === BUG FIX: Use textContent, not csvText ===
            const lines = textContent.split(/[\r\n]+/).filter(Boolean);
            // === END BUG FIX ===
            
            if (lines.length < 10) {
                if (errorEl) errorEl.textContent = "Warning: Small dataset (<10 rows). Forecasting might be unreliable.";
            } else {
                if (errorEl) errorEl.textContent = "";
            }

            // Update UI
            showDataPreview(textContent);
            updateColumnSelects(headers); // Calls the modified function

        } catch (err) {
            // Handle errors
             console.error("Input processing failed:", err);
            if (errorEl) errorEl.textContent = `Error: ${err.message}. Please check data format/content.`;
            targetColumnSelect.disabled = true;
            targetColumnSelect.innerHTML = '<option value="">-- Error reading data --</option>';
            dataPreviewContainer.classList.add("hidden");
            if (assumedDateColNameSpan) assumedDateColNameSpan.textContent = "Error";
        }
    };

    // --- Attach Event Listeners ---

    // Example button listener
    if (examplesBtn && examplesDiv) {
        examplesBtn.addEventListener("click", () => {
            const isHidden = examplesDiv.classList.toggle("hidden");
            examplesBtn.textContent = isHidden ? "View Examples" : "Hide Examples";

            if (!isHidden) {
                const exampleContent = $("predictiveExampleContent");
                if (exampleContent && exampleContent.textContent === "Loading example...") {
                    exampleContent.innerHTML = `
                        <div class="text-xs font-medium text-white/90 mb-2"> Data Format Examples</div>
                         <div class="space-y-2 text-xs">
                             <div>
                                <div class="text-white/80 mb-1">Time Series Data (CSV):</div>
                                <pre class="bg-black/30 p-2 rounded font-mono text-white/90 text-xs whitespace-pre-wrap overflow-x-auto">Date,Revenue\n2023-01-01,150000\n2023-02-01,162000\n2023-03-01,175000</pre>
                            </div>
                            <div class="text-white/60 text-xs mt-2 space-y-1">
    <div> <strong>Minimum:</strong> 24 data points (2 years monthly data)</div>
    <div> <strong>Recommended:</strong> 36+ data points (3+ years monthly data)</div>
    <div> <strong>Optimal:</strong> 60+ data points (5+ years monthly data)</div>
    <div> First column must be the Date/Time column</div>
    <div> Use clear, simple column names (no spaces/symbols)</div>
    <div> Ensure date column is consistently formatted (e.g., YYYY-MM-DD)</div>
    <div> Target variable column must contain only numbers</div>
</div>

<div class="mt-4 p-3 bg-white/5 rounded border border-white/10">
    <h4 class="text-sm font-medium mb-3 text-blue-300">Model Types & Data Patterns</h4>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
        <div class="space-y-2">
            <div class="p-2 bg-blue-900/20 rounded border-l-2 border-blue-400">
                <div class="font-medium text-blue-300">Linear Regression</div>
                <div class="text-white/70">Best for: Steady growth or decline</div>
                <div class="text-white/50">Examples: Subscription revenue, planned expansion</div>
            </div>
             
            <div class="p-2 bg-yellow-900/20 rounded border-l-2 border-yellow-400">
                <div class="font-medium text-yellow-300">Seasonal Forecast</div>
                <div class="text-white/70">Best for: Repeating cycles</div>
                <div class="text-white/50">Examples: Retail sales, tourism, energy usage</div>
            </div>
        </div>
        
        <div class="space-y-2">
            <div class="p-2 bg-red-900/20 rounded border-l-2 border-red-400">
                <div class="font-medium text-red-300">Simple Trend</div>
                <div class="text-white/70">Best for: Stable operations</div>
                <div class="text-white/50">Examples: Mature markets, utility bills</div>
             </div>
            
            <div class="p-2 bg-green-900/20 rounded border-l-2 border-green-400">
                <div class="font-medium text-green-300">Auto-Select (Recommended)</div>
                <div class="text-white/70">Best for: Mixed or unknown patterns</div>
                <div class="text-white/50">Automatically chooses the best model</div>
            </div>
        </div>
    </div>
</div>
                        </div>`;
                }
            }
        });
    }

    // Input type toggle listeners
    if (fileToggle && textToggle && fileArea && textArea) {
        fileToggle.addEventListener("change", () => 
 {
            if (fileToggle.checked) {
                fileArea.classList.remove("hidden");
                textArea.classList.add("hidden");
                processDataInput(fileInput.files.length > 0 ? true : null);
            }
        });
        textToggle.addEventListener("change", () => {
            if (textToggle.checked) {
                fileArea.classList.add("hidden");
                textArea.classList.remove("hidden");
                processDataInput(textInput.value.trim() ? false : null);
            }
        });
    }

    // File input change listener
    if (fileInput) {
        
 fileInput.addEventListener("change", () => {
            const label = $("predictiveFileLabel");
            const fileNameSpan = label ? label.querySelector(".file-name") : null;
            if (fileNameSpan) {
                if (fileInput.files.length > 0) {
                    fileNameSpan.textContent = fileInput.files[0].name;
                    if (label) label.classList.add("has-file");
                    processDataInput(true);
                } else {
                    fileNameSpan.textContent = "Select data file...";
                    if (label) label.classList.remove("has-file");
                     processDataInput(null);
                }
            }
        });
    }

    // Text input 'blur' listener
    if (textInput) {
        textInput.addEventListener("blur", () => {
            if (textArea && !textArea.classList.contains("hidden")) {
                processDataInput(textInput.value.trim() ? false : null);
            }
        });
    }

    // Generate button listener -> Calls the main router function
    if (generateBtn) {
        generateBtn.removeEventListener("click", handleGenerate); // Ensure only one listener
        generateBtn.addEventListener("click", handleGenerate);
    }

    // Save button listeners
    const savePdfBtn = $("savePdfBtn");
    const saveDocxBtn = $("saveDocxBtn");
    if (savePdfBtn) 
 savePdfBtn.removeEventListener("click", handleSaveAsPdf);
    if (saveDocxBtn) saveDocxBtn.removeEventListener("click", handleSaveAsDocx);
    reattachActionListeners(); // Use your global function to attach listeners

    // --- 3. Initial State & Cache Handling ---
    if (analysisCache[currentTemplateId]) {
        $("analysisResult").innerHTML = analysisCache[currentTemplateId];
        $("analysisActions").classList.remove("hidden");
        // Re-initialize Plotly charts from cached HTML
        setTimeout(() => {
            const charts = $("analysisResult").querySelectorAll('.plotly-chart');
            charts.forEach(chartDiv => {
                if (chartDiv.layout && typeof Plotly !== 'undefined') { // Check if it's a Plotly chart
                    try {
                        Plotly.Plots.resize(chartDiv);
                        console.log(`Resized cached chart ${chartDiv.id}`);
                     } catch (e) {
                        console.error(`Error resizing cached chart ${chartDiv.id}:`, e);
                    }
                }
            });
        }, 150);
    } else {
        // Default placeholder
        $("analysisResult").innerHTML = '<div class="text-white/60 p-8 text-center">Upload your data (ensuring the first column is the date/time) and configure options to generate a forecast.</div>';
        $("analysisActions").classList.add("hidden");
    }

    // Attach listener for the feedback link
                const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
                if (feedbackLink) {
                    feedbackLink.addEventListener("click", (e) => {
                         e.preventDefault();
                        
                        // This just calls the navigateTo function.
                        // It relies on your main `MapsTo` function to be
                        // the *simplified one* (without memory logic)
                        // and your `submitFeedbackPageBtn` listener
                        // to be the *simplified one* (that just goes home).
                         if (typeof navigateTo === 'function') {
                            navigateTo('feedback');
                        } else {
                            console.error("navigateTo function is not defined.");
                        }
                    });
                } else {
                    console.warn("Feedback link not found inside createPredictiveAnalysisLayout");
                }
                 // --- END FIX ---

} // --- End of createPredictiveAnalysisLayout function ---

// Copy to clipboard function for examples
function copyToClipboard(button, text) {
    navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.classList.add('bg-green-500/20');
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-500/20');
        }, 2000);
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        button.textContent = 'Copied!';
        setTimeout(() => button.textContent = 'Copy', 2000);
    });
}


    function createDematelLayout(template) {
    const contentContainer = $("templateDetailContent");
    contentContainer.className = "grid lg:grid-cols-1 gap-12"; // Single column layout

    // --- HTML Structure ---
contentContainer.innerHTML = `
    <div class="lg:col-span-1">
        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

        <div class="max-w-2xl mx-auto w-full">
            <div class="glass-container p-6 space-y-6">
                
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xl font-bold text-white">Analysis Configuration</h3>
                    <div class="flex items-center space-x-2">
                        <button type="button" id="configExamplesBtn" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Examples</button>
                        <button type="button" onclick="triggerBackendDownload(\'dematel\', \'dematel-sample-doc.txt\')" class="btn btn-secondary text-xs" style="padding: 0.25rem 0.5rem;">Download Sample .txt</button>
                        <button type="button" id="useDematelSampleBtn" class="btn-sample btn-use-sample" data-template-id="dematel-analysis"> Use Sample</button>
                    </div>
                </div>
                
                <div id="configExamples" class="hidden mb-4 p-3 bg-black/20 border border-white/15 rounded-lg">
                    <div class="text-xs font-medium text-white/90 mb-3"> Good vs Bad DEMATEL Input Examples</div>
                    
                    <div class="mb-6">
                        <div class="flex items-center mb-2">
                            <span class="text-green-300 font-semibold text-xs mr-2"> GOOD EXAMPLE</span>
                            <span class="text-green-200 text-xs">(Results in stable analysis with clear cause/effect separation)</span>
                        </div>
                        <div class="bg-green-900/20 border border-green-500/30 p-3 rounded font-mono text-white/90 relative text-xs">
                            <button class="absolute top-1 right-1 text-xs px-1 py-0.5 bg-white/10 rounded hover:bg-white/20" onclick="copyToClipboard(this, 'We identified five factors: (1) Product Quality, (2) Website Usability, (3) Customer Service, (4) Delivery Speed, and (5) Price Competitiveness.\\n\\nProduct Quality causes a very strong increase in Customer Service complaints. Bad Website Usability also strongly influences Customer Service. Slow Delivery Speed has a moderate impact on Price Competitiveness. Price Competitiveness has little influence on Product Quality since we maintain standards. Delivery Speed weakly influences Price Competitiveness because faster shipping costs more. Customer Service has very little impact on Website Usability since support issues rarely lead to website changes.')">Copy</button>
                            We identified five factors: (1) Product Quality, (2) Website Usability, (3) Customer Service, (4) Delivery Speed, and (5) Price Competitiveness.<br><br>
                            Product Quality causes a <strong>very strong</strong> increase in Customer Service complaints. Bad Website Usability also <strong>strongly</strong> influences Customer Service. Slow Delivery Speed has a <strong>moderate</strong> impact on Price Competitiveness. Price Competitiveness has <strong>little influence</strong> on Product Quality since we maintain standards. Delivery Speed <strong>weakly influences</strong> Price Competitiveness because faster shipping costs more. Customer Service has <strong>very little impact</strong> on Website Usability since support issues rarely lead to website changes.
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex items-center mb-2">
                            <span class="text-red-300 font-semibold text-xs mr-2"> BAD EXAMPLE</span>
                            <span class="text-red-200 text-xs">(Results in mathematical instability and unclear insights)</span>
                        </div>
                        <div class="bg-red-900/20 border border-red-500/30 p-3 rounded font-mono text-white/90 relative text-xs">
                            <button class="absolute top-1 right-1 text-xs px-1 py-0.5 bg-white/10 rounded hover:bg-white/20" onclick="copyToClipboard(this, 'Our company has these success factors: Leadership, Innovation, Market Position, Financial Performance, Employee Satisfaction, Customer Relationships, Technology Infrastructure, Brand Reputation.\\n\\nLeadership affects everything in the company very strongly. Innovation influences all other factors significantly. Market Position impacts everything else. Financial Performance drives all business decisions and affects every single factor. Employee Satisfaction influences everything because happy employees work better. All factors influence each other bidirectionally with maximum strength.')">Copy</button>
                            Our company has these success factors: Leadership, Innovation, Market Position, Financial Performance, Employee Satisfaction, Customer Relationships, Technology Infrastructure, Brand Reputation.<br><br>
                            Leadership affects <strong>everything</strong> in the company <strong>very strongly</strong>. Innovation influences <strong>all other factors significantly</strong>. Market Position impacts <strong>everything else</strong>. Financial Performance drives all business decisions and affects <strong>every single factor</strong>. Employee Satisfaction influences <strong>everything</strong> because happy employees work better. <strong>All factors influence each other bidirectionally with maximum strength.</strong>
                        </div>
                    </div>

                    <div class="text-white/60 text-xs space-y-1 mb-4">
                        <div class="font-medium text-white/80">Key Differences Between Good & Bad Input:</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                            <div>
                                <div class="text-green-300 font-medium"> Good Practices:</div>
                                <div> Varied intensity words (very strong  very little)</div>
                                <div> Specific explanations for each relationship</div>
                                <div> Realistic relationship patterns</div>
                                <div> 5-7 factors (manageable complexity)</div>
                                <div> Not everything affects everything</div>
                            </div>
                            <div>
                                <div class="text-red-300 font-medium"> Bad Practices:</div>
                                <div> "Everything affects everything" mentality</div>
                                <div> All relationships are "maximum strength"</div>
                                <div> Too many factors (8+ creates complexity)</div>
                                <div> Vague language without explanations</div>
                                <div> "Bidirectional with maximum strength"</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-900/20 border border-blue-500/30 p-3 rounded">
                        <div class="text-blue-300 font-semibold text-xs mb-2"> How to Use This Tool:</div>
                        <div class="text-white/80 text-xs space-y-1">
                            <div> <strong>Just write naturally!</strong> Describe your system in plain English.</div>
                            <div> <strong>List your factors:</strong> Use a numbered list like "(1) Factor Name" for clarity.</div>
                            <div> <strong>Describe relationships:</strong> Use words like "strongly influences," "moderately affects," "weakly impacts," or "has little impact on."</div>
                            <div> <strong>Show the full spectrum:</strong> Mix very strong, strong, moderate, weak, and very weak relationships.</div>
                            <div> <strong>Explain WHY:</strong> Add "because..." to help the AI understand the logic.</div>
                            <div> <strong>The AI does the rest:</strong> You don't need to provide scales or matrices.</div>
                        </div>
                    </div>
                </div>

                <div class="input-radio-group">
                    <input type="radio" name="dematelInputType" id="dematelInputTextToggle" class="input-radio" checked>
                    <label for="dematelInputTextToggle" class="input-radio-label">Text Input</label>
                    <input type="radio" name="dematelInputType" id="dematelInputFileToggle" class="input-radio">
                    <label for="dematelInputFileToggle" class="input-radio-label">Document Upload</label>
                </div>

                <div id="dematelTextInputArea">
                    <label for="dematelContent" class="block text-sm font-medium text-gray-200 mb-2">System or Problem Description</label>
                    <textarea id="dematelContent" class="input-field h-48" placeholder="Describe your system in natural language. 
List your factors, like '(1) My First Factor'.
Then, describe their relationships using varied intensities: 
'Factor A strongly influences Factor B...'
'Factor C has little impact on Factor D...'
'Factor E very weakly affects Factor F...'
The AI will read this and build the matrix for you."></textarea>
                    <div id="dematelTextError" class="text-red-400 text-sm mt-2"></div>
                </div>

                <div id="dematelFileUploadArea" class="hidden">
                    <label for="dematelFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Document (.txt, .docx)</label>
                    <div class="input-file-wrapper">
                        <label for="dematelFile" id="dematelFileLabel" class="input-file-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                            <span class="file-name">Select .txt or .docx file...</span>
                        </label>
                        <input type="file" id="dematelFile" class="input-file" accept=".txt,.docx">
                    </div>
                    <div id="dematelFileError" class="text-red-400 text-sm mt-2"></div>

                    <div id="dematelFilePreviewContainer" class="hidden space-y-2 mt-4">
                        <label class="block text-sm font-medium text-gray-200">File Content Preview (First 10 lines)</label>
                        <pre id="dematelFilePreview" class="bg-black/20 p-3 rounded-lg text-white/80 text-xs overflow-x-auto h-32"></pre>
                    </div>
                </div>

                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                    <span id="generateBtnText">Analyze Causal Factors</span>
                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                </button>
                <div class="text-center mt-4">
	                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                </div>
            </div>
        </div>

        <div class="mt-12">
            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
            </div>
            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
            </div>
        </div>
    </div>
`;

    // --- Helper function for copying to clipboard ---
    if (!window.copyToClipboard) {
        window.copyToClipboard = function(button, text) {
            navigator.clipboard.writeText(text.replace(/\\n/g, '\n')).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        };
    }

    // --- Attach Core Event Listeners ---
    $("generateBtn").addEventListener("click", handleGenerate); 
    
    reattachActionListeners(); 

    // --- Add Example Toggle Event Listener ---
    $("configExamplesBtn").addEventListener("click", function() {
        const exampleDiv = $("configExamples");
        const isHidden = exampleDiv.classList.contains("hidden");
        exampleDiv.classList.toggle("hidden");
        this.textContent = isHidden ? "Hide Examples" : "View Examples";
    });

    // --- Restore Cached Results (if any) ---
    if (analysisCache[currentTemplateId]) {
        $("analysisResult").innerHTML = analysisCache[currentTemplateId];
        $("analysisActions").classList.remove("hidden");
        if (window.reattachTabListeners) {
             reattachTabListeners($("analysisResult"));
        }
    } else {
        $("analysisResult").innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
        $("analysisActions").classList.add("hidden");
    }

    // --- Get References to DEMATEL-Specific DOM Elements ---
    const fileInput = $("dematelFile");
    const textInput = $("dematelContent");
    const fileToggle = $("dematelInputFileToggle");
    const textToggle = $("dematelInputTextToggle");
    const fileArea = $("dematelFileUploadArea");
    const textArea = $("dematelTextInputArea");
    const filePreviewContainer = $("dematelFilePreviewContainer");
    const filePreview = $("dematelFilePreview");

    // --- Attach Input Event Listeners ---
    fileToggle.addEventListener("change", () => {
        fileArea.classList.remove("hidden");
        textArea.classList.add("hidden");
        // Show preview if a file is already selected
        if (fileInput.files.length > 0) {
            filePreviewContainer.classList.remove("hidden");
        }
    });
    textToggle.addEventListener("change", () => {
        fileArea.classList.add("hidden");
        textArea.classList.remove("hidden");
        // Hide file preview when switching to text input
        filePreviewContainer.classList.add("hidden");
    });

    if (fileInput) {
        fileInput.addEventListener("change", async () => { // Make async
            const label = $("dematelFileLabel");
            const fileNameSpan = label.querySelector(".file-name");
            const fileError = $("dematelFileError");
            
            fileError.textContent = ""; // Clear errors
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileNameSpan.textContent = file.name;
                label.classList.add("has-file");
                
                // --- NEW PREVIEW LOGIC ---
                try {
                     // extractTextFromFile is a global function in your script
                    const text = await extractTextFromFile(file); 
                    const first10Lines = text.split('\n').slice(0, 10).join('\n');
                    filePreview.textContent = first10Lines || "(File appears to be empty)";
                    filePreviewContainer.classList.remove("hidden");
                } catch (err) {
                    console.error("File preview error:", err);
                    fileError.textContent = `Error reading file: ${err.message}`;
                    filePreviewContainer.classList.add("hidden");
                }
                // --- END NEW PREVIEW LOGIC ---

            } else { 
                fileNameSpan.textContent = "Select .txt or .docx file...";
                label.classList.remove("has-file");
                filePreviewContainer.classList.add("hidden"); // Hide on file deselect
                filePreview.textContent = "";
            }
        });
    }

    if (textInput) {
        textInput.addEventListener("input", () => {
             $("dematelTextError").textContent = "";
        });
    }

    // Attach listener for the feedback link
                const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
                if (feedbackLink) {
                    feedbackLink.addEventListener("click", (e) => {
                        e.preventDefault();
                        
                        // This just calls the navigateTo function.
                        // It relies on your main `MapsTo` function to be
                        // the *simplified one* (without memory logic)
                        // and your `submitFeedbackPageBtn` listener
                        // to be the *simplified one* (that just goes home).
                        if (typeof navigateTo === 'function') {
                            navigateTo('feedback');
                        } else {
                            console.error("navigateTo function is not defined.");
                        }
                    });
                } else {
                    console.warn("Feedback link not found inside createDematelLayout");
                }
                // --- END FIX ---
}

/**
     * Creates the UI for the "All Framework" Novel Strategies tool.
     * Updated to include a list of all 9 active frameworks under the button.
     */
   function createAllFrameworkLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide Business Problem or Context</h3>
                             
                             <div class="mb-2">
                                <label for="allFrameworkLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                <input type="text" id="allFrameworkLocation" class="input-field" placeholder="e.g., Global, Silicon Valley, APAC Region">
                             </div>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="allFrameworkContent" class="input-field h-48" placeholder="Describe your strategic challenge, business situation, or the problem you want to solve. The AI will apply multiple frameworks to this context..."></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="allFrameworkFile" id="allFrameworkFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="allFrameworkFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Generate Comprehensive Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>

                            <div class="mt-6 pt-6 border-t border-white/10 text-center">
                                <p class="text-xs text-white/50 mb-3 uppercase tracking-widest font-semibold">Applying 9 Strategic Engines Simultaneously</p>
                                <div class="flex flex-wrap justify-center gap-2">
                                    <span class="px-2 py-1 bg-white/5 rounded text-xs text-blue-200 border border-blue-500/20" title="ERRC Grid"> Blue Ocean</span>
                                    <span class="px-2 py-1 bg-white/5 rounded text-xs text-purple-200 border border-purple-500/20" title="User-Centric Innovation"> Design Thinking</span>
                                    <span class="px-2 py-1 bg-white/5 rounded text-xs text-indigo-200 border border-indigo-500/20" title="Ideation Checklist"> SCAMPER</span>
                                    <span class="px-2 py-1 bg-white/5 rounded text-xs text-teal-200 border border-teal-500/20" title="Inventive Problem Solving"> TRIZ</span>
                                    <span class="px-2 py-1 bg-white/5 rounded text-xs text-pink-200 border border-pink-500/20" title="Organizational Alignment">7 McKinsey 7S</span>
                                    <span class="px-2 py-1 bg-white/5 rounded text-xs text-green-200 border border-green-500/20" title="Parallel Thinking"> Six Hats</span>
                                    <span class="px-2 py-1 bg-white/5 rounded text-xs text-red-200 border border-red-500/20" title="Structural Tension"> Dissonance</span>
                                    <span class="px-2 py-1 bg-white/5 rounded text-xs text-orange-200 border border-orange-500/20" title="Thinking Process"> Ladder of Inference</span>
                                    <span class="px-2 py-1 bg-white/5 rounded text-xs text-yellow-200 border border-yellow-500/20" title="Assumption Busting"> Reframing</span>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                            </div>

                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Novel Strategy Synthesis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
        setupInputToggle("allFrameworkFile", "allFrameworkFileLabel", "textInputArea", "docUploadArea");

        // Attach listener for the feedback link
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.addEventListener("click", (e) => {
                e.preventDefault();
                if (typeof navigateTo === 'function') {
                    navigateTo('feedback');
                } else {
                    console.error("navigateTo function is not defined.");
                }
            });
        }
    }

    /**
     * Handles the "HEFTY" parallel AI generation for all 9 frameworks + 1 synthesis.
     * Updated to include SCAMPER, TRIZ, and McKinsey 7S.
     */
    async function handleAllFrameworkAnalysis() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Running Comprehensive Multi-Framework Analysis...</h3><p class="text-white/80 mb-2">Applying 9 strategic frameworks. This is a hefty task and may take several minutes.</p><p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p></div>`;
        setLoading("generate", true);

        const statusEl = $("analysisStatus");
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";

        try {
            // 1. Gather Inputs
            statusEl.textContent = "Reading and processing your context...";
            const useDoc = $("docUpload").checked;
            let text = "";
            if (useDoc) {
                const file = $("allFrameworkFile").files[0];
                if (!file) throw new Error("Please select a document.");
                text = await extractTextFromFile(file);
            } else {
                text = $("allFrameworkContent").value.trim();
                if (!text.trim()) throw new Error("Please provide your business problem or context.");
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("allFrameworkLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
                console.log("Injected location into All Frameworks Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (text.length > MAX_CONTEXT_LENGTH) {
                text = text.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters of the provided text.)`;
                console.warn(`All Framework context truncated.`);
            }

            // 2. Define Helper for Parallel AI Calls
            async function generateOllamaResponse(prompt, statusUpdate) {
                statusEl.textContent = statusUpdate;
                console.log(`Sending prompt for: ${statusUpdate}`);
                const response = await fetch(OLLAMA_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        prompt: prompt,
                        stream: false,
                        format: "json",
                        options: { num_ctx: 32768 }
                    })
                });
                if (!response.ok) {
                    throw new Error(`Ollama API error for ${statusUpdate}: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                try {
                    return JSON.parse(data.response);
                } catch (e) {
                    console.error(`Failed to parse JSON for ${statusUpdate}:`, data.response, e);
                    throw new Error(`Invalid JSON received from AI for ${statusUpdate}.`);
                }
            }

            // 3. Define ALL Framework Prompts
            const textContext = `**USER'S BUSINESS CONTEXT:**\n\`\`\`\n${text}\n\`\`\`\n**VALIDATION:** If the context is gibberish (e.g., "asdf"), return a JSON object where all array fields are empty [] and string fields say "Analysis failed: Invalid input". \n**ABSOLUTE CONSTRAINTS:** Base **ALL** output **EXCLUSIVELY** on the provided "USER'S BUSINESS CONTEXT". ${truncatedNote}`;

            // --- UPDATED PROMPT: Blue Ocean (Includes Novel Strategies) ---
            const prompt_blue_ocean = `
                ${textContext}
                **TASK:** Apply the Blue Ocean Strategy "Eliminate-Reduce-Raise-Create" (ERRC) grid to the user's context.
                **MANDATORY REQUIREMENT:** You MUST generate a "Novel Strategies Recommended" section. This is NOT a summary. It is a concise, actionable strategic direction derived from the ERRC grid.
                **RETURN FORMAT:** Provide ONLY a valid JSON object: 
                {
                  "eliminate": ["Factor 1 to eliminate...", "..."], 
                  "reduce": ["Factor 1 to reduce...", "..."], 
                  "raise": ["Factor 1 to raise...", "..."], 
                  "create": ["Factor 1 to create...", "..."],
                  "summary": "Brief overview of the analysis...",
                  "novel_strategies": "A concise, high-leverage strategic recommendation describing exactly what the user should do next based on this Blue Ocean analysis."
                }`;
            
            // --- UPDATED PROMPT: Design Thinking (Includes Novel Strategies) ---
            const prompt_design_thinking = `
                ${textContext}
                **TASK:** Apply the 5 stages of Design Thinking.
                **MANDATORY REQUIREMENT:** You MUST generate a "Novel Strategies Recommended" section. This is NOT a summary. It is a specific, actionable next step or pivot derived from the Testing phase insights.
                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                  "empathize": "Description of user/problem...", 
                  "define": "The core problem statement...", 
                  "ideate": "Key brainstorming solutions...", 
                  "prototype": "Potential low-fi solution...", 
                  "test": "How to test with users...",
                  "summary": "Brief overview...",
                  "novel_strategies": "A concise, actionable strategy recommendation. What is the specific innovative direction the user should pursue based on this process?"
                }`;
            
            // --- PROMPT: Reframing (NO Novel Strategies needed per instructions) ---
            const prompt_reframing = `
                ${textContext}
                **TASK:** Apply Reframing Thinking. Identify 2-3 core assumptions and provide alternative reframes.
                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                  "reframes": [{"assumption": "Core assumption...", "alternatives": ["Alternative 1...", "Alternative 2..."]}, {"assumption": "...", "alternatives": ["..."]}],
                  "summary": "Brief overview of the analysis...",
                  "conclusion": "Key insights..."
                }`;
            
            // --- UPDATED PROMPT: Thinking Hats (Includes Novel Strategies) ---
            const prompt_thinking_hats = `
                ${textContext}
                **TASK:** Apply De Bono's Six Thinking Hats.
                **MANDATORY REQUIREMENT:** You MUST generate a "Novel Strategies Recommended" section. This is the final "Blue Hat" decisiona clear, actionable path forward.
                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                  "white_hat": "Facts & data...", 
                  "red_hat": "Feelings & intuition...", 
                  "black_hat": "Risks & cautions...", 
                  "yellow_hat": "Benefits & positives...", 
                  "green_hat": "Creative ideas...", 
                  "blue_hat": "Process summary...",
                  "summary": "Brief overview...",
                  "novel_strategies": "A concise, actionable strategic decision. Based on all hats, what is the single most effective strategy to implement now?"
                }`;
            
            // --- PROMPT: Creative Dissonance (NO change requested) ---
            const prompt_creative_dissonance = `
                ${textContext}
                **TASK:** Apply Creative Dissonance. Identify \`current_reality\`, \`future_vision\`, and \`tension_points\`.
                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                  "current_reality": "The main problem...", 
                  "future_vision": "The main goal...", 
                  "tension_points": ["Gap 1...", "Gap 2..."],
                  "summary": "Brief overview...",
                  "conclusion": "Strategies to resolve tension..."
                }`;
            
            // --- PROMPT: Ladder of Inference (NO change requested) ---
            const prompt_ladder_of_inference = `
                ${textContext}
                **TASK:** Apply the Ladder of Inference. Deconstruct a core \`belief_or_action\`.
                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                  "belief_or_action": "Core conclusion...", 
                  "deconstruction": {"observations": "...", "interpretations": "...", "assumptions": "..."},
                  "summary": "Brief overview...",
                  "conclusion": "Recommendations..."
                }`;

            // --- NEW PROMPTS (SCAMPER, TRIZ, McKinsey 7S) ---

            const prompt_scamper = `
                ${textContext}
                **TASK:** Apply the SCAMPER ideation technique to the product, service, or process described in the context.
                **MANDATORY:** Generate specific ideas for each letter.
                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                  "substitute": ["Idea 1...", "Idea 2..."],
                  "combine": ["Idea..."],
                  "adapt": ["Idea..."],
                  "modify": ["Idea..."],
                  "put_to_another_use": ["Idea..."],
                  "eliminate": ["Idea..."],
                  "reverse": ["Idea..."],
                  "summary": "Brief overview of the most promising changes...",
                  "novel_strategies": "A specific strategic direction based on the best SCAMPER ideas."
                }`;

            const prompt_triz = `
                ${textContext}
                **TASK:** Apply TRIZ (Theory of Inventive Problem Solving). Identify core contradictions in the context and suggest inventive principles.
                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                  "contradictions": [{"conflict": "e.g., Speed vs Accuracy", "explanation": "..."}],
                  "inventive_principles": [{"principle": "e.g., Segmentation", "application": "How to apply it to this context..."}],
                  "ideal_final_result": "Description of the ideal outcome without cost/harm...",
                  "summary": "Brief overview...",
                  "novel_strategies": "A specific innovation strategy based on resolving the contradictions."
                }`;

            const prompt_mckinsey_7s = `
                ${textContext}
                **TASK:** Apply the McKinsey 7S Framework to analyze organizational alignment. Analyze the 'Hard S's' (Strategy, Structure, Systems) and 'Soft S's' (Shared Values, Style, Staff, Skills).
                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                  "strategy": "Analysis of strategy...",
                  "structure": "Analysis of structure...",
                  "systems": "Analysis of systems...",
                  "shared_values": "Analysis of culture/values...",
                  "style": "Analysis of leadership style...",
                  "staff": "Analysis of team/staff capabilities...",
                  "skills": "Analysis of core competencies...",
                  "alignment_check": "Are these elements aligned? Where is the friction?",
                  "novel_strategies": "A recommendation to improve organizational alignment and performance."
                }`;

            // 4. Run All 9 Frameworks in Parallel
            const [
                data_blue_ocean,
                data_design_thinking,
                data_reframing,
                data_thinking_hats,
                data_creative_dissonance,
                data_ladder_of_inference,
                data_scamper,
                data_triz,
                data_mckinsey_7s
            ] = await Promise.all([
                generateOllamaResponse(prompt_blue_ocean, "Running Blue Ocean Strategy..."),
                generateOllamaResponse(prompt_design_thinking, "Applying Design Thinking..."),
                generateOllamaResponse(prompt_reframing, "Reframing Assumptions..."),
                generateOllamaResponse(prompt_thinking_hats, "Using Six Thinking Hats..."),
                generateOllamaResponse(prompt_creative_dissonance, "Analyzing Creative Dissonance..."),
                generateOllamaResponse(prompt_ladder_of_inference, "Deconstructing Thinking System..."),
                generateOllamaResponse(prompt_scamper, "Running SCAMPER Ideation..."),
                generateOllamaResponse(prompt_triz, "Applying TRIZ Principles..."),
                generateOllamaResponse(prompt_mckinsey_7s, "Analyzing McKinsey 7S...")
            ]);

            // 5. Run the Synthesis AI Call
            statusEl.textContent = "Synthesizing all framework insights...";
            const synthesis_context = `
                **CONTEXT:** ${text.substring(0, 1000)}...
                **Blue Ocean:** ${JSON.stringify(data_blue_ocean)}
                **Design Thinking:** ${JSON.stringify(data_design_thinking)}
                **Reframing:** ${JSON.stringify(data_reframing)}
                **Thinking Hats:** ${JSON.stringify(data_thinking_hats)}
                **SCAMPER:** ${JSON.stringify(data_scamper)}
                **TRIZ:** ${JSON.stringify(data_triz)}
                **McKinsey 7S:** ${JSON.stringify(data_mckinsey_7s)}
            `;

            const prompt_synthesis = `
                You are a master strategist. Synthesize these findings from 9 different frameworks.
                1. \`strategic_narrative\`: 3-4 sentence summary.
                2. \`top_insights\`: 3-5 critical insights (look for patterns across frameworks).
                3. \`primary_leverage_point\`: Single most powerful intervention.
                4. \`priority_actions\`: Top 3-4 specific first steps.

                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                  "strategic_narrative": "...",
                  "top_insights": ["..."],
                  "primary_leverage_point": "...",
                  "priority_actions": ["..."]
                }`;
            
            const data_synthesis = await generateOllamaResponse(prompt_synthesis, "Creating final synthesis...");

            // 6. Assemble Final Data Object
            const parsedData = {
                synthesis: data_synthesis,
                blue_ocean: data_blue_ocean,
                design_thinking: data_design_thinking,
                reframing: data_reframing,
                thinking_hats: data_thinking_hats,
                creative_dissonance: data_creative_dissonance,
                ladder_of_inference: data_ladder_of_inference,
                scamper: data_scamper,
                triz: data_triz,
                mckinsey_7s: data_mckinsey_7s
            };

            console.log("Successfully assembled all analysis parts.");
            
            // 7. Render Results
            statusEl.textContent = "Rendering comprehensive analysis...";
            renderAllFrameworkPage(analysisResultContainer, parsedData);

        } catch (error) {
            console.error(`Error in handleAllFrameworkAnalysis:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
            }
        }
    }

    /**
     * Renders the "HEFTY" multi-tabbed results page for the All Framework tool.
     * Includes SCAMPER, TRIZ, and McKinsey 7S tabs.
     */
    function renderAllFrameworkPage(container, data) {
        container.innerHTML = ""; // Clear loading
        const { 
            synthesis, blue_ocean, design_thinking, reframing, thinking_hats, 
            creative_dissonance, ladder_of_inference, 
            scamper, triz, mckinsey_7s 
        } = data;

        // --- Create Tab Navigation (11 Tabs) ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> Strategic Synthesis</button>
            <button class="analysis-tab-btn" data-tab="blueOcean"> Blue Ocean</button>
            <button class="analysis-tab-btn" data-tab="designThinking"> Design Thinking</button>
            <button class="analysis-tab-btn" data-tab="scamper"> SCAMPER</button>
            <button class="analysis-tab-btn" data-tab="triz"> TRIZ</button>
            <button class="analysis-tab-btn" data-tab="mckinsey">7 McKinsey 7S</button>
            <button class="analysis-tab-btn" data-tab="reframing"> Reframing</button>
            <button class="analysis-tab-btn" data-tab="thinkingHats"> Six Thinking Hats</button>
            <button class="analysis-tab-btn" data-tab="dissonance"> Creative Dissonance</button>
            <button class="analysis-tab-btn" data-tab="ladder"> Ladder of Inference</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Frameworks</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active"></div>
            <div id="blueOceanPanel" class="analysis-tab-panel"></div>
            <div id="designThinkingPanel" class="analysis-tab-panel"></div>
            <div id="scamperPanel" class="analysis-tab-panel"></div>
            <div id="trizPanel" class="analysis-tab-panel"></div>
            <div id="mckinseyPanel" class="analysis-tab-panel"></div>
            <div id="reframingPanel" class="analysis-tab-panel"></div>
            <div id="thinkingHatsPanel" class="analysis-tab-panel"></div>
            <div id="dissonancePanel" class="analysis-tab-panel"></div>
            <div id="ladderPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Dashboard (Synthesis) Panel ---
        const dashboardPanel = $("dashboardPanel");
        dashboardPanel.innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold mb-4 text-center">Strategic Synthesis</h3>
                <div class="p-6 rounded-lg bg-black/20 border border-white/10">
                    <h4 class="text-xl font-bold mb-2 text-indigo-300">Strategic Narrative</h4>
                    <p class="text-white/90 italic">${synthesis.strategic_narrative}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-black/20 p-4 rounded-lg">
                        <h4 class="text-lg font-bold mb-3 text-yellow-300">Top Cross-Framework Insights</h4>
                        <ul class="list-disc list-inside space-y-2 text-sm text-white/80">
                            ${(synthesis.top_insights || []).map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="bg-black/20 p-4 rounded-lg">
                        <h4 class="text-lg font-bold mb-3 text-red-300">Primary Leverage Point</h4>
                        <p class="text-sm text-white/80">${synthesis.primary_leverage_point}</p>
                    </div>
                </div>
                <div class="p-6 rounded-lg bg-black/20 border border-white/10">
                    <h4 class="text-xl font-bold mb-3 text-green-300">Priority First Actions</h4>
                    <ol class="list-decimal list-inside space-y-2 text-white/90">
                        ${(synthesis.priority_actions || []).map(a => `<li>${a}</li>`).join('')}
                    </ol>
                </div>
            </div>`;

        // --- 2. Populate Blue Ocean Panel ---
        const blueOceanPanel = $("blueOceanPanel");
        blueOceanPanel.innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold mb-6 text-center"> Blue Ocean (ERRC Grid)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/50">
                        <h4 class="text-xl font-bold text-red-300 mb-2"> Eliminate</h4>
                        <ul class="list-disc list-inside text-sm text-white/80 space-y-1">
                            ${(blue_ocean.eliminate || []).map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50">
                        <h4 class="text-xl font-bold text-yellow-300 mb-2"> Reduce</h4>
                        <ul class="list-disc list-inside text-sm text-white/80 space-y-1">
                            ${(blue_ocean.reduce || []).map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                        <h4 class="text-xl font-bold text-blue-300 mb-2"> Raise</h4>
                        <ul class="list-disc list-inside text-sm text-white/80 space-y-1">
                            ${(blue_ocean.raise || []).map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/50">
                        <h4 class="text-xl font-bold text-green-300 mb-2"> Create</h4>
                        <ul class="list-disc list-inside text-sm text-white/80 space-y-1">
                            ${(blue_ocean.create || []).map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                <div class="bg-black/20 p-6 rounded-lg border border-white/10 mt-6">
                    <h4 class="text-xl font-bold mb-3 text-indigo-300"> Summary</h4>
                    <p class="text-white/90 mb-4">${blue_ocean.summary || 'Summary not available.'}</p>
                </div>

                <div class="mt-8 p-6 rounded-lg bg-gradient-to-r from-indigo-900/40 to-purple-900/40 border border-indigo-500/30 text-center">
                    <h3 class="text-2xl font-bold mb-4 text-white">Novel Strategies Recommended</h3>
                    <p class="text-lg text-white/90 leading-relaxed">${blue_ocean.novel_strategies || 'Pending...'}</p>
                </div>
            </div>`;

        // --- 3. Populate Design Thinking Panel ---
        const designThinkingPanel = $("designThinkingPanel");
        designThinkingPanel.innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold mb-4 text-center"> Design Thinking Process</h3>
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-blue-400">
                    <h4 class="text-lg font-bold text-blue-300">1. Empathize</h4>
                    <p class="text-sm text-white/80 italic">${design_thinking.empathize || 'N/A'}</p>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-indigo-400">
                    <h4 class="text-lg font-bold text-indigo-300">2. Define</h4>
                    <p class="text-sm text-white/80 italic">${design_thinking.define || 'N/A'}</p>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-purple-400">
                    <h4 class="text-lg font-bold text-purple-300">3. Ideate</h4>
                    <p class="text-sm text-white/80 italic">${design_thinking.ideate || 'N/A'}</p>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-yellow-400">
                    <h4 class="text-lg font-bold text-yellow-300">4. Prototype</h4>
                    <p class="text-sm text-white/80 italic">${design_thinking.prototype || 'N/A'}</p>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border-l-4 border-green-400">
                    <h4 class="text-lg font-bold text-green-300">5. Test</h4>
                    <p class="text-sm text-white/80 italic">${design_thinking.test || 'N/A'}</p>
                </div>
                
                <div class="bg-black/20 p-6 rounded-lg border border-white/10 mt-6">
                    <h4 class="text-xl font-bold mb-3 text-indigo-300"> Summary</h4>
                    <p class="text-white/90 mb-4">${design_thinking.summary || 'Summary not available.'}</p>
                </div>

                <div class="mt-8 p-6 rounded-lg bg-gradient-to-r from-indigo-900/40 to-purple-900/40 border border-indigo-500/30 text-center">
                    <h3 class="text-2xl font-bold mb-4 text-white">Novel Strategies Recommended</h3>
                    <p class="text-lg text-white/90 leading-relaxed">${design_thinking.novel_strategies || 'Actionable strategy generation pending...'}</p>
                </div>
            </div>`;

        // --- 4. Populate SCAMPER Panel (NEW) ---
        const scamperPanel = $("scamperPanel");
        scamperPanel.innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold mb-6 text-center"> SCAMPER Ideation</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                     <div class="bg-white/5 p-4 rounded-lg"><h4 class="font-bold text-purple-300">Substitute</h4><ul class="list-disc list-inside text-sm">${(scamper.substitute || []).map(i => `<li>${i}</li>`).join('')}</ul></div>
                     <div class="bg-white/5 p-4 rounded-lg"><h4 class="font-bold text-blue-300">Combine</h4><ul class="list-disc list-inside text-sm">${(scamper.combine || []).map(i => `<li>${i}</li>`).join('')}</ul></div>
                     <div class="bg-white/5 p-4 rounded-lg"><h4 class="font-bold text-green-300">Adapt</h4><ul class="list-disc list-inside text-sm">${(scamper.adapt || []).map(i => `<li>${i}</li>`).join('')}</ul></div>
                     <div class="bg-white/5 p-4 rounded-lg"><h4 class="font-bold text-yellow-300">Modify</h4><ul class="list-disc list-inside text-sm">${(scamper.modify || []).map(i => `<li>${i}</li>`).join('')}</ul></div>
                     <div class="bg-white/5 p-4 rounded-lg"><h4 class="font-bold text-orange-300">Put to another use</h4><ul class="list-disc list-inside text-sm">${(scamper.put_to_another_use || []).map(i => `<li>${i}</li>`).join('')}</ul></div>
                     <div class="bg-white/5 p-4 rounded-lg"><h4 class="font-bold text-red-300">Eliminate</h4><ul class="list-disc list-inside text-sm">${(scamper.eliminate || []).map(i => `<li>${i}</li>`).join('')}</ul></div>
                     <div class="bg-white/5 p-4 rounded-lg md:col-span-2 lg:col-span-3"><h4 class="font-bold text-indigo-300">Reverse</h4><ul class="list-disc list-inside text-sm">${(scamper.reverse || []).map(i => `<li>${i}</li>`).join('')}</ul></div>
                </div>
                <div class="mt-8 p-6 rounded-lg bg-gradient-to-r from-indigo-900/40 to-purple-900/40 border border-indigo-500/30 text-center">
                    <h3 class="text-2xl font-bold mb-4 text-white">Novel Strategies Recommended</h3>
                    <p class="text-lg text-white/90 leading-relaxed">${scamper.novel_strategies || 'Pending...'}</p>
                </div>
            </div>`;

        // --- 5. Populate TRIZ Panel (NEW) ---
        const trizPanel = $("trizPanel");
        let trizHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-6 text-center"> TRIZ: Inventive Problem Solving</h3>`;
        trizHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-red-900/20 p-4 rounded-lg border border-red-500/30">
                <h4 class="text-lg font-bold text-red-300 mb-2">Identified Contradictions</h4>
                <ul class="space-y-3">`;
        (triz.contradictions || []).forEach(c => {
            trizHtml += `<li class="text-sm"><strong class="text-white">${c.conflict}</strong><p class="text-white/70 italic">${c.explanation}</p></li>`;
        });
        trizHtml += `</ul></div>
            <div class="bg-green-900/20 p-4 rounded-lg border border-green-500/30">
                <h4 class="text-lg font-bold text-green-300 mb-2">Inventive Principles</h4>
                <ul class="space-y-3">`;
        (triz.inventive_principles || []).forEach(p => {
            trizHtml += `<li class="text-sm"><strong class="text-white">${p.principle}</strong><p class="text-white/70 italic">${p.application}</p></li>`;
        });
        trizHtml += `</ul></div></div>
        <div class="bg-black/20 p-4 rounded-lg border border-white/10 mt-4"><h4 class="text-lg font-bold text-yellow-300 mb-2">Ideal Final Result</h4><p class="text-white/90">${triz.ideal_final_result || 'N/A'}</p></div>
        <div class="mt-8 p-6 rounded-lg bg-gradient-to-r from-indigo-900/40 to-purple-900/40 border border-indigo-500/30 text-center">
            <h3 class="text-2xl font-bold mb-4 text-white">Novel Strategies Recommended</h3>
            <p class="text-lg text-white/90 leading-relaxed">${triz.novel_strategies || 'Pending...'}</p>
        </div></div>`;
        trizPanel.innerHTML = trizHtml;

        // --- 6. Populate McKinsey 7S Panel (NEW) ---
        const mckinseyPanel = $("mckinseyPanel");
        mckinseyPanel.innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold mb-6 text-center">7 McKinsey 7S Analysis</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/30">
                        <h4 class="text-xl font-bold text-blue-300 mb-3 border-b border-blue-500/30 pb-2">Hard S's (Tangible)</h4>
                        <div class="space-y-4">
                            <div><h5 class="font-bold text-white">Strategy</h5><p class="text-sm text-white/80">${mckinsey_7s.strategy}</p></div>
                            <div><h5 class="font-bold text-white">Structure</h5><p class="text-sm text-white/80">${mckinsey_7s.structure}</p></div>
                            <div><h5 class="font-bold text-white">Systems</h5><p class="text-sm text-white/80">${mckinsey_7s.systems}</p></div>
                        </div>
                    </div>
                    <div class="bg-purple-900/20 p-4 rounded-lg border border-purple-500/30">
                        <h4 class="text-xl font-bold text-purple-300 mb-3 border-b border-purple-500/30 pb-2">Soft S's (Intangible)</h4>
                        <div class="space-y-4">
                            <div><h5 class="font-bold text-white">Shared Values</h5><p class="text-sm text-white/80">${mckinsey_7s.shared_values}</p></div>
                            <div><h5 class="font-bold text-white">Style (Culture)</h5><p class="text-sm text-white/80">${mckinsey_7s.style}</p></div>
                            <div><h5 class="font-bold text-white">Staff</h5><p class="text-sm text-white/80">${mckinsey_7s.staff}</p></div>
                            <div><h5 class="font-bold text-white">Skills</h5><p class="text-sm text-white/80">${mckinsey_7s.skills}</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-900/20 p-4 rounded-lg border border-yellow-500/30 mt-4">
                    <h4 class="text-lg font-bold text-yellow-300 mb-2">Alignment Check</h4>
                    <p class="text-white/90">${mckinsey_7s.alignment_check}</p>
                </div>
                <div class="mt-8 p-6 rounded-lg bg-gradient-to-r from-indigo-900/40 to-purple-900/40 border border-indigo-500/30 text-center">
                    <h3 class="text-2xl font-bold mb-4 text-white">Novel Strategies Recommended</h3>
                    <p class="text-lg text-white/90 leading-relaxed">${mckinsey_7s.novel_strategies || 'Pending...'}</p>
                </div>
            </div>`;

        // --- 7. Populate Reframing Panel ---
        const reframingPanel = $("reframingPanel");
        let reframingHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4 text-center"> Reframing Assumptions</h3>`;
        (reframing.reframes || []).forEach((r, index) => {
            reframingHtml += `
                <div class="insight-card border-l-4 border-yellow-400">
                    <h4 class="text-lg font-bold mb-2">Assumption ${index + 1}:</h4>
                    <p class="text-white/90 italic mb-3">"${r.assumption || 'N/A'}"</p>
                    <h5 class="text-md font-bold text-green-300 mb-2">Alternative Reframes:</h5>
                    <ul class="list-disc list-inside text-sm text-white/80 space-y-1">
                        ${(r.alternatives || []).map(a => `<li>${a}</li>`).join('')}
                    </ul>
                </div>
            `;
        });
        reframingHtml += `
            <div class="bg-black/20 p-6 rounded-lg border border-white/10 mt-6">
                <h4 class="text-xl font-bold mb-3 text-indigo-300"> Summary</h4>
                <p class="text-white/90 mb-4">${reframing.summary || 'Summary not available.'}</p>
                <h4 class="text-xl font-bold mb-3 text-green-300"> Conclusion</h4>
                <p class="text-white/90">${reframing.conclusion || 'Conclusion not available.'}</p>
            </div>
        </div>`;
        reframingPanel.innerHTML = reframingHtml;
        
        // --- 8. Populate Thinking Hats Panel ---
        const thinkingHatsPanel = $("thinkingHatsPanel");
        thinkingHatsPanel.innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold mb-6 text-center"> Six Thinking Hats</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white/5 p-4 rounded-lg border-t-4 border-white"><h4 class="font-bold text-lg mb-2"> White Hat</h4><p class="text-sm text-white/80">${thinking_hats.white_hat || 'N/A'}</p></div>
                    <div class="bg-red-900/30 p-4 rounded-lg border-t-4 border-red-500"><h4 class="font-bold text-lg mb-2 text-red-300"> Red Hat</h4><p class="text-sm text-white/80">${thinking_hats.red_hat || 'N/A'}</p></div>
                    <div class="bg-gray-800/30 p-4 rounded-lg border-t-4 border-gray-400"><h4 class="font-bold text-lg mb-2 text-gray-300"> Black Hat</h4><p class="text-sm text-white/80">${thinking_hats.black_hat || 'N/A'}</p></div>
                    <div class="bg-yellow-900/30 p-4 rounded-lg border-t-4 border-yellow-500"><h4 class="font-bold text-lg mb-2 text-yellow-300"> Yellow Hat</h4><p class="text-sm text-white/80">${thinking_hats.yellow_hat || 'N/A'}</p></div>
                    <div class="bg-green-900/30 p-4 rounded-lg border-t-4 border-green-500"><h4 class="font-bold text-lg mb-2 text-green-300"> Green Hat</h4><p class="text-sm text-white/80">${thinking_hats.green_hat || 'N/A'}</p></div>
                    <div class="bg-blue-900/30 p-4 rounded-lg border-t-4 border-blue-500"><h4 class="font-bold text-lg mb-2 text-blue-300"> Blue Hat</h4><p class="text-sm text-white/80">${thinking_hats.blue_hat || 'N/A'}</p></div>
                </div>
                <div class="bg-black/20 p-6 rounded-lg border border-white/10 mt-6">
                    <h4 class="text-xl font-bold mb-3 text-indigo-300"> Summary</h4>
                    <p class="text-white/90 mb-4">${thinking_hats.summary || 'Summary not available.'}</p>
                </div>

                <div class="mt-8 p-6 rounded-lg bg-gradient-to-r from-indigo-900/40 to-purple-900/40 border border-indigo-500/30 text-center">
                    <h3 class="text-2xl font-bold mb-4 text-white">Novel Strategies Recommended</h3>
                    <p class="text-lg text-white/90 leading-relaxed">${thinking_hats.novel_strategies || 'Pending...'}</p>
                </div>
            </div>`;

        // --- 6. Populate Creative Dissonance Panel ---
        const dissonancePanel = $("dissonancePanel");
        dissonancePanel.innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold text-center mb-6"> Creative Dissonance</h3>
                <div class="dissonance-map-container">
                    <div class="dissonance-pole">
                        <h4 class="text-xl font-bold mb-3 text-red-300"> Current Reality</h4>
                        <p class="text-white/80 text-sm">${creative_dissonance.current_reality || 'N/A'}</p>
                    </div>
                    <div class="dissonance-gap">
                        <div class="text-center mb-4">
                            <span class="text-4xl"></span>
                            <h4 class="text-lg font-bold text-yellow-300">Tension Points</h4>
                        </div>
                        ${(creative_dissonance.tension_points || []).map(dp => `<div class="dissonance-point text-xs">${dp}</div>`).join("")}
                    </div>
                    <div class="dissonance-pole">
                        <h4 class="text-xl font-bold mb-3 text-green-300"> Future Vision</h4>
                        <p class="text-white/80 text-sm">${creative_dissonance.future_vision || 'N/A'}</p>
                    </div>
                </div>
                <div class="bg-black/20 p-6 rounded-lg border border-white/10 mt-6">
                    <h4 class="text-xl font-bold mb-3 text-indigo-300"> Summary</h4>
                    <p class="text-white/90 mb-4">${creative_dissonance.summary || 'Summary not available.'}</p>
                    <h4 class="text-xl font-bold mb-3 text-green-300"> Conclusion</h4>
                    <p class="text-white/90">${creative_dissonance.conclusion || 'Conclusion not available.'}</p>
                </div>
            </div>`;

        // --- 7. Populate Ladder of Inference Panel ---
        const ladderPanel = $("ladderPanel");
        const d = ladder_of_inference.deconstruction || {};
        ladderPanel.innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold text-center mb-6"> Ladder of Inference</h3>
                <div class="ladder-container">
                    <div class="ladder-rung"><h4>Action</h4><p>${ladder_of_inference.belief_or_action || 'N/A'}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>Assumptions</h4><p>${d.assumptions || 'N/A'}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>Interpretations</h4><p>${d.interpretations || 'N/A'}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>Selected Observations</h4><p>${d.observations || 'N/A'}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>Pool of Reality</h4><p>(The full context provided)</p></div>
                </div>
                <div class="bg-black/20 p-6 rounded-lg border border-white/10 mt-6">
                    <h4 class="text-xl font-bold mb-3 text-indigo-300"> Summary</h4>
                    <p class="text-white/90 mb-4">${ladder_of_inference.summary || 'Summary not available.'}</p>
                    <h4 class="text-xl font-bold mb-3 text-green-300"> Conclusion</h4>
                    <p class="text-white/90">${ladder_of_inference.conclusion || 'Conclusion not available.'}</p>
                </div>
            </div>`;
        
        // --- 11. Populate Learn Panel ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
        <div class="p-6 space-y-6 text-white/90">
            <h3 class="text-2xl font-bold text-center mb-4"> Understanding Novel Frameworks</h3>
            <p class="text-sm text-white/80 text-center italic">These frameworks are designed to break conventional thinking and generate new strategic options.</p>
            
            <details class="styled-details" open>
                <summary> Blue Ocean Strategy (ERRC)</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>Focuses on creating uncontested market space. The ERRC grid challenges industry assumptions:</p>
                    <ul class="list-disc list-inside ml-4">
                        <li><strong>Eliminate:</strong> Factors the industry takes for granted but no longer add value.</li>
                        <li><strong>Reduce:</strong> Factors to reduce well below industry standards to cut costs.</li>
                        <li><strong>Raise:</strong> Factors to raise well above industry standards to add value.</li>
                        <li><strong>Create:</strong> Factors to create that the industry has never offered.</li>
                    </ul>
                </div>
            </details>

            <details class="styled-details">
                <summary> Design Thinking</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>A human-centered approach to innovation moving through 5 stages:</p>
                    <ul class="list-decimal list-inside ml-4">
                        <li><strong>Empathize:</strong> Understand user needs and pain points.</li>
                        <li><strong>Define:</strong> Articulate the core problem.</li>
                        <li><strong>Ideate:</strong> Brainstorm creative solutions.</li>
                        <li><strong>Prototype:</strong> Build low-cost versions to test ideas.</li>
                        <li><strong>Test:</strong> Gather feedback and refine.</li>
                    </ul>
                </div>
            </details>

            <details class="styled-details">
                <summary> Reframing Thinking</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>The process of challenging and changing the core assumptions that define a problem. By changing the "frame," you can unlock entirely new solutions invisible from the old perspective.</p>
                </div>
            </details>

            <details class="styled-details">
                <summary> Six Thinking Hats</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>A tool for parallel thinking that separates analysis into six distinct modes:</p>
                    <ul class="list-disc list-inside ml-4">
                        <li><strong>White:</strong> Facts & Data.</li>
                        <li><strong>Red:</strong> Emotions & Intuition.</li>
                        <li><strong>Black:</strong> Cautions & Risks.</li>
                        <li><strong>Yellow:</strong> Benefits & Optimism.</li>
                        <li><strong>Green:</strong> Creativity & New Ideas.</li>
                        <li><strong>Blue:</strong> Process Control & Summary.</li>
                    </ul>
                </div>
            </details>

            <details class="styled-details">
                <summary> Creative Dissonance</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>Posits that energy for change comes from the gap (dissonance) between a clear **Future Vision** and an honest assessment of **Current Reality**. This structural tension naturally seeks resolution, pulling reality up toward the vision.</p>
                </div>
            </details>

            <details class="styled-details">
                <summary> Ladder of Inference</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>Deconstructs the mental steps from observation to action (Observation -> Selection -> Interpretation -> Assumption -> Conclusion -> Belief -> Action). Helping to uncover flaws in reasoning and build better mental models.</p>
                </div>
            </details>

            <details class="styled-details">
                <summary> Delphi Method</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>A structured communication technique used to gain consensus from a panel of experts.</p>
                    <ul class="list-disc list-inside ml-4">
                        <li><strong>Anonymity:</strong> Experts answer questionnaires anonymously to prevent groupthink.</li>
                        <li><strong>Iterations:</strong> Process happens in multiple rounds.</li>
                        <li><strong>Feedback:</strong> Facilitator provides a summary of experts' forecasts from the previous round.</li>
                        <li><strong>Consensus:</strong> The goal is to reduce the range of answers and reach expert agreement.</li>
                    </ul>
                </div>
            </details>

            <details class="styled-details">
                <summary> Business Model Canvas</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>A strategic template for developing new or documenting existing business models using 9 building blocks:</p>
                    <ul class="list-disc list-inside ml-4">
                        <li><strong>Value Propositions</strong>, <strong>Customer Segments</strong>, <strong>Channels</strong></li>
                        <li><strong>Customer Relationships</strong>, <strong>Revenue Streams</strong>, <strong>Key Resources</strong></li>
                        <li><strong>Key Activities</strong>, <strong>Key Partnerships</strong>, <strong>Cost Structure</strong></li>
                    </ul>
                </div>
            </details>

            <details class="styled-details">
                <summary> SCAMPER</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>A checklist tool for generating ideas by changing an existing product/service:</p>
                    <ul class="list-disc list-inside ml-4">
                        <li><strong>S</strong>ubstitute, <strong>C</strong>ombine, <strong>A</strong>dapt</li>
                        <li><strong>M</strong>odify, <strong>P</strong>ut to another use</li>
                        <li><strong>E</strong>liminate, <strong>R</strong>everse</li>
                    </ul>
                </div>
            </details>

            <details class="styled-details">
                <summary> TRIZ (Theory of Inventive Problem Solving)</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>Theory of Inventive Problem Solving. It solves problems by identifying contradictions (e.g., "Stronger but Lighter") and using 40 universal inventive principles to resolve them.</p>
                    <ul class="list-disc list-inside ml-4">
                        <li><strong>Contradictions:</strong> Solving problems where improving one thing worsens another.</li>
                        <li><strong>40 Principles:</strong> Standard inventive principles to resolve contradictions.</li>
                        <li><strong>Ideal Final Result:</strong> Imagining the perfect solution without cost or harm.</li>
                    </ul>
                </div>
            </details>
            <details class="styled-details">
                <summary>7 McKinsey 7S</summary>
                <div class="bg-black/20 p-4 rounded-b-lg text-sm space-y-2">
                    <p>Analyzes organizational alignment across 7 elements: Strategy, Structure, Systems (Hard S's) and Shared Values, Style, Staff, Skills (Soft S's).</p>
                </div>
            </details>
        </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add("active");
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });
        $("analysisActions").classList.remove("hidden");
    }

    function setupInputToggle(fileInputId, fileLabelId, textInputAreaId, docUploadAreaId) {
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();

        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // --- THIS IS THE FIX ---
        // Only add radio button listeners if the elements actually exist on the page.
        const textInput = $("textInput");
        const docUpload = $("docUpload");
        if (textInput && docUpload && $(textInputAreaId) && $(docUploadAreaId)) {
            textInput.addEventListener("change", () => {
                $(textInputAreaId).classList.remove("hidden");
                $(docUploadAreaId).classList.add("hidden");
            });
            docUpload.addEventListener("change", () => {
                $(textInputAreaId).classList.add("hidden");
                $(docUploadAreaId).classList.remove("hidden");
            });
        }
        // --- END OF FIX ---

        const fileInput = $(fileInputId);
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $(fileLabelId);
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                } else {
                    fileNameSpan.textContent = "Click to select a file...";
                    label.classList.remove("has-file");
                }
            });
        }
    }

    function frameworkCheckboxChangeHandler() {
        const checkedBoxes = document.querySelectorAll("#frameworkList .method-checkbox:checked");
        const selectionCounter = $("selectionCounter");

        if (checkedBoxes.length > currentSelectionLimit) {
            this.checked = false;
        }

        const finalCheckedCount = document.querySelectorAll("#frameworkList .method-checkbox:checked").length;
        if (selectionCounter) {
            selectionCounter.textContent = `Selected: ${finalCheckedCount} / ${currentSelectionLimit}`;
        }
    }

    function configureFrameworkSelector(limit) {
        currentSelectionLimit = limit;
        const selectionCounter = $("selectionCounter");
        const checkboxes = document.querySelectorAll("#frameworkList .method-checkbox");

        if (!selectionCounter || !checkboxes) return;

        selectionCounter.textContent = `Selected: 0 / ${limit}`;

        const rule = templateRules[currentTemplateId] || {};
        if (!rule.preselectFramework) {
            checkboxes.forEach((cb) => {
                cb.checked = false;
            });
        }
        frameworkCheckboxChangeHandler();
    }

    function getSelectedFrameworks() {
        const checkedBoxes = document.querySelectorAll("#frameworkList .method-checkbox:checked");
        const selectedMethods = [];

        const frameworkMap = {
            "Reframing Thinking": "ReframingThinking",
            "Delphi Method": "DelphiMethod",
            "Blue Ocean Strategy": "BlueOcean",
            "Design Thinking": "DesignThinking",
            "Thinking Hats": "ThinkingHats",
            "Business Model Canvas": "BusinessModelCanvas",
            SCAMPER: "SCAMPER",
            "TRIZ (Theory of Inventive Problem Solving)": "TRIZ"
        };

        checkedBoxes.forEach((checkbox) => {
            const methodText = checkbox.dataset.framework;
            if (frameworkMap[methodText]) {
                selectedMethods.push(frameworkMap[methodText]);
            }
        });
        return selectedMethods.join(",");
    }

    function getSelectedSections() {
        const checkedBoxes = document.querySelectorAll("#analysisList .method-checkbox:checked");
        const sectionMap = {
            Introduction: "introduction",
            "Overview of business": "overview_of_business",
            "process overview": "process_overview",
            "mission statement": "mission_statement",
            "vision analysis": "vision_analysis",
            "vision statement 2": "vision_statement_2",
            "novel strategy part 1": "novel_strategy_part_1",
            "novel strategy part 2": "novel_strategy_part_2",
            "novel strategy part 3": "novel_strategy_part_3"
        };

        if (checkedBoxes.length === 0) {
            return Object.values(sectionMap).join(",");
        }

        const selectedSections = [];
        checkedBoxes.forEach((checkbox) => {
            const sectionText = checkbox.nextElementSibling.textContent.trim();
            if (sectionMap[sectionText]) {
                selectedSections.push(sectionMap[sectionText]);
            }
        });
        return selectedSections.join(",");
    }

    function getFrameworkForTemplate(templateId) {
        const selectedFrameworks = getSelectedFrameworks();
        return selectedFrameworks || "BlueOcean,SCAMPER";
    }

    // =========================================================================
    // ===== ANALYSIS LOGIC FUNCTIONS                                     =====
    // =========================================================================

    /**
     * Extracts text from a user-uploaded file. Supports .txt and .docx.
     */
    async function extractTextFromFile(file) {
        return new Promise((resolve, reject) => {
            const fileExtension = file.name.split(".").pop().toLowerCase();

            // --- 1. Handle TXT/CSV (Read as Text) ---
            if (file.type === "text/plain" || file.name.endsWith(".csv") || fileExtension === 'txt' || fileExtension === 'csv') {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject("Error reading .txt or .csv file.");
                reader.readAsText(file);
            
            // --- 2. Handle DOCX (Read as ArrayBuffer) ---
            } else if (fileExtension === 'docx') {
                if (window.mammoth) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const arrayBuffer = event.target.result;
                        try {
                            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                            resolve(result.value);
                        } catch (err) {
                            reject(`Error reading .docx file: ${err.message}`);
                        }
                    };
                    reader.onerror = () => reject("Error preparing .docx file for reading.");
                    reader.readAsArrayBuffer(file);
                } else {
                    reject(".docx reader library (mammoth.js) not found.");
                }
            
            // --- 3. Handle PDF (Read as ArrayBuffer for PDF.js) ---
            } else if (fileExtension === 'pdf') {
                if (typeof pdfjsLib === 'undefined') {
                    reject("PDF reader library (pdf.js) not found. Cannot process PDF.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const arrayBuffer = event.target.result;
                    const pdfData = new Uint8Array(arrayBuffer);
                    
                    try {
                        // Set worker source (necessary for PDF.js)
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs'; 

                        const pdfDocument = await pdfjsLib.getDocument({ data: pdfData }).promise;
                        let fullText = '';

                        // Iterate through all pages
                        for (let i = 1; i <= pdfDocument.numPages; i++) {
                            const page = await pdfDocument.getPage(i);
                            const textContent = await page.getTextContent();
                            
                            // Concatenate text content items with spaces
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n\n'; // Add line breaks between pages
                        }

                        resolve(fullText.trim());
                    } catch (err) {
                        console.error("PDF.js Extraction Error:", err);
                        reject(`Error extracting text from PDF: ${err.message}`);
                    }
                };

                reader.onerror = () => reject("Error reading PDF file as ArrayBuffer.");
                reader.readAsArrayBuffer(file);

            } else {
                // --- 4. Handle Unsupported Types ---
                reject(`Unsupported file type: .${fileExtension}. Please use .txt, .csv, .docx, or .pdf.`);
            }
        });
    }

    /**
     * Robustly extracts a JSON object from a string, which might contain extra text.
     */
    function extractJsonRobust(text) {
        try {
            const jsonStart = text.indexOf("{");
            const jsonEnd = text.lastIndexOf("}") + 1;
            if (jsonStart !== -1 && jsonEnd !== -1) {
                const jsonStr = text.substring(jsonStart, jsonEnd);
                return JSON.parse(jsonStr);
            }
        } catch (e) {
            console.warn("Standard JSON parsing failed. The AI response may be malformed.", e);
        }
        throw new Error("Failed to parse a valid JSON object from the AI's response.");
    }

    async function handleGenerate() {
    if (!currentTemplateId) return;

    // --- NEW: CHECK USAGE LIMITS BEFORE PROCEEDING ---
    const isAllowed = await checkAndIncrementUsage();
    if (isAllowed === false) {
        // Stop the spinner if it was somehow triggered
        setLoading("generate", false);
        return; 
    }
    // -------------------------------------------------

    const analysisResultContainer = $("analysisResult");
    setLoading("generate", true);
    const analysisActionsEl = $("analysisActions");

    // --- FIX START ---
    // 1. Hide the actions panel. This is just setup, not part of the 'if' chain.
    if (analysisActionsEl) {
        analysisActionsEl.classList.add("hidden");
    }

    // 2. Start a *single, clean* if/else if chain to route the request.
    if (currentTemplateId === "mission-vision") {
        await handleMissionVisionAnalysis(); // Now it will be called
    } else if (currentTemplateId === "objectives") {
        await handleObjectivesAnalysis(); // This one too
    } else if (currentTemplateId === "swot-tows") { // Changed from 'if' to 'else if'
        await handleSwotTowsAnalysis();
    } else if (currentTemplateId === "archetype-analysis") {
        await handleArchetypeAnalysis();
    } else if (currentTemplateId === "leverage-points") {
        await handleLeveragePointsAnalysis();
    } else if (currentTemplateId === "visualization") {
        await handleVisualizationAnalysis_DA();
    } else if (currentTemplateId === "prescriptive-analysis") {
        await handlePrescriptiveAnalysis_DA();
    } else if (currentTemplateId === "all-framework") {
        await handleAllFrameworkAnalysis();
    } else if (currentTemplateId === "thinking-system") {
        await handleThinkingSystemAnalysis_NS();
    } else if (currentTemplateId === "creative-dissonance") {
        await handleCreativeDissonanceAnalysis_NS();
    } else if (currentTemplateId === "pareto-fishbone") {
        await handleParetoFishboneAnalysis();
    } else if (currentTemplateId === "system-actions") {
        await handleSystemActionsAnalysis_ST();
    } else if (currentTemplateId === "goals-initiatives") {
        await handleGoalsAndInitiativesAnalysis_SP();
    } else if (currentTemplateId === "living-system") {
        await handleLivingSystemAnalysis_NS();
    } else if (currentTemplateId === "system-objectives") {
        await handleSystemObjectivesAnalysis_ST();
    } else if (currentTemplateId === "pls-analysis") {
        await handlePlsAnalysis_DA();
    } else if (currentTemplateId === "sem-analysis") {
        await handleSemAnalysis();
    } else if (currentTemplateId === "predictive-analysis") {
        await handlePredictiveAnalysis();
    } else if (currentTemplateId === "dematel-analysis") {
        await handleDematelAnalysis();
    } else if (currentTemplateId === "descriptive-analysis") {
        await handleDescriptiveAnalysis_DA();
    } else if (currentTemplateId === "kpi-events") {
        await handleKpiAnalysis_KE();
    } else if (currentTemplateId === "regression-analysis") {
        await handleRegressionAnalysis_DA();
    } else if (currentTemplateId === "novel-goals-initiatives") {
        await handleNovelGoalsAnalysis_NS();
    } else if (currentTemplateId === "misc-summary") {
        await handleMiscAnalysis_MSC();
    } else if (currentTemplateId === "action-plans") {
        await handleActionPlansAnalysis_AP();
    } else if (currentTemplateId === "factor-analysis") {
        await handleFactorAnalysis();
    } else if (currentTemplateId === "system-goals-initiatives") {
        await handleSystemGoalsAnalysis();
    } else if (currentTemplateId === "process-mapping") {
        await handleProcessMappingAnalysis();
    } else if (currentTemplateId === "system-thinking-analysis") {
        await handleSystemThinkingAnalysis();
    } else {
        // --- Generic n8n workflow for all other tools ---
        analysisResultContainer.innerHTML = `
            <div class="text-center text-white/70 p-8">
                <div class="typing-indicator mb-6">
                    <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                </div>
                <h3 class="text-xl font-semibold text-white mb-4">Generating Your Strategic Analysis</h3>
                <p class="text-white/80 mb-2">This comprehensive analysis may take 2-5 minutes to complete.</p>
                <p class="text-white/60 text-sm">Please keep this page open while we process your request.</p>
            </div>`;

        const formData = new FormData();
        const companyName = document.getElementById("companyName").value.trim();
        const location = document.getElementById("location").value.trim();
        
        const framework = typeof getFrameworkForTemplate === 'function' ? getFrameworkForTemplate(currentTemplateId) : "";
        const sections = typeof getSelectedSections === 'function' ? getSelectedSections() : "";

        // Validation
        if (!companyName || !location) {
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Please enter Company Name and Location.</div>`;
            setLoading("generate", false);
            return;
        }

        // --- FIX: Check Input Method (Text vs File) ---
        const docUploadRadio = document.getElementById("docUpload");
        const useDoc = docUploadRadio ? docUploadRadio.checked : false;
        
        let fullPromptContext = "";

        if (useDoc) {
            // --- OPTION A: Actual File Upload ---
            const companyDocumentsFile = document.getElementById("companyDocumentsFile") ? document.getElementById("companyDocumentsFile").files[0] : null;
            
            if (!companyDocumentsFile) {
                analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Please select a document to upload.</div>`;
                setLoading("generate", false);
                return;
            }
            // Send actual file
            formData.append("company_documents", companyDocumentsFile.name);
            formData.append("file", companyDocumentsFile);
            
            fullPromptContext = "See attached document.";
        } else {
            // --- OPTION B: Text Input (Converted to Virtual File) ---
            const textEl = document.getElementById("useCaseContext");
            const contextText = textEl ? textEl.value.trim() : "";
            
            if (!contextText) {
                 analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Please enter your business context or description.</div>`;
                 setLoading("generate", false);
                 return;
            }

            // Create a Virtual File (Blob)
            const textBlob = new Blob([contextText], { type: 'text/plain' });
            
            // Send as "file" and "company_documents" so n8n treats it as a file upload
            formData.append("file", textBlob, "context_input.txt");
            formData.append("company_documents", "context_input.txt");
            
            // Also append as 'context' just in case your workflow looks for that specifically
            formData.append("context", contextText);
            
            fullPromptContext = contextText;
        }

        // Construct Prompt
        const fullPrompt = `User Information: - Company Name: ${companyName} - Location: ${location} - Context: ${fullPromptContext}`;

        formData.append("customerName", companyName);
        formData.append("location", location);
        formData.append("framework", framework);
        formData.append("sections", sections);
        formData.append("prompt", fullPrompt);
        formData.append("templateId", currentTemplateId);

        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) throw new Error("Please log in to generate analysis.");

            const messageId = Date.now();
            if (typeof pendingAnalysisRequests !== 'undefined') {
                pendingAnalysisRequests.set(messageId, analysisResultContainer);
            }
            formData.append("messageId", messageId);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            const response = await fetch("https://n8n.data2int.com/webhook/mission-vision-v11", {
                method: "POST",
                headers: { Authorization: `Bearer ${session.access_token}` },
                body: formData,
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            console.log("Analysis request submitted successfully.");
            
        } catch (error) {
            if (error.name === "AbortError") {
                console.log("Fetch request timed out as expected. Waiting for WebSocket response.");
                return;
            }
            console.error("Error submitting analysis request:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        }
    }
    // --- FIX END ---
}

    async function handleDescriptiveAnalysis_DA() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Performing Full Descriptive Analysis...</h3><p class="text-white/80 mb-2">Calculating statistics, generating visualizations, and deriving insights...</p></div>`;
        setLoading("generate", true); // Set loading state

        try {
            const formData = new FormData();
            formData.append("analysis_type", "descriptive");
            
            // --- CHECK: SAMPLE MODE VS MANUAL MODE ---
            if (window.isSampleModeActive === true && window.tempSampleDataFile) {
                console.log("Using Global Sample Data for Descriptive");
                formData.append("data_file", window.tempSampleDataFile, window.tempSampleDataFile.name);
                if (window.tempSampleContextFile) {
                    formData.append("context_file", window.tempSampleContextFile, window.tempSampleContextFile.name);
                }
            } else {
                // --- MANUAL MODE ---
                const dataFile = $("descriptiveFile").files[0];
                if (!dataFile) {
                    throw new Error(" Please upload a CSV data file.");
                }
                formData.append("data_file", dataFile, dataFile.name);
                
                const useDoc = $("docUpload").checked;
                if (useDoc) {
                    const contextFile = $("descriptiveContextFile").files[0];
                    if (!contextFile) {
                        throw new Error(" You selected 'Document Upload' but did not select a context file.");
                    }
                    formData.append("context_file", contextFile, contextFile.name); 
                } else {
                    const contextText = $("descriptiveContextText").value.trim();
                    if (!contextText) {
                        throw new Error(" Please paste your context into the text area or select 'Document Upload' to upload a file.");
                    }
                    const contextBlob = new Blob([contextText], { type: 'text/plain' });
                    formData.append("context_file", contextBlob, "context_input.txt");
                }
            }
            
            // 3. Call your FastAPI Backend
            const API_URL = "https://analysis.sageaios.com/api/descriptive";
            const response = await fetch(API_URL, {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                let errorDetail = `API Error: ${response.status}`;
                try {
                    const errorJson = await response.json();
                    errorDetail = errorJson.detail || `API Error: ${response.status}`;
                } catch (e) {
                    errorDetail = `API Error: ${response.status} - ${response.statusText}`;
                }
                throw new Error(errorDetail);
            }

            const parsedData = await response.json();
            
            if (parsedData.error) {
                throw new Error(`Backend Analysis Error: ${parsedData.error}`);
            }

            // 5. Pass the *entire response* to your render function
            renderDescriptivePage_DA(analysisResultContainer, parsedData);

        } catch (error) {
            console.error(`Error in handleDescriptiveAnalysis_DA:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            window.isSampleModeActive = false; // Reset the flag
            setLoading("generate", false);
        }
    }

    async function handleParetoFishboneAnalysis() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `
            <div class="text-center text-white/70 p-8">
                <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                <h3 class="text-xl font-semibold text-white mb-4">Generating Detailed Pareto & Fishbone Analysis...</h3>
                <p class="text-white/80 mb-2">Identifying root causes, prioritizing impact, and suggesting actions...</p>
            </div>`; // Updated text
        setLoading("generate", true);

        // Define URL and Model
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Consistent model

        try {
            // 1. Gather Inputs
            const useDoc = $("docUpload").checked;
            let problemContext = "";

            if (useDoc) {
                const file = $("paretoFile").files[0];
                if (!file) throw new Error("Please select a document (.txt, .docx) to upload.");
                problemContext = await extractTextFromFile(file);
            } else {
                problemContext = $("problemStatement").value.trim(); // Use ID from createParetoLayout
                if (!problemContext) throw new Error("Please enter a problem statement or description in the text area.");
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("paretoLocation").value.trim();
            if (location) {
                problemContext = `Target Location/Region: ${location}\n\n${problemContext}`;
                console.log("Injected location into Pareto Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 50000;
            let truncatedNote = "";
            if (problemContext.length > MAX_CONTEXT_LENGTH) {
                problemContext = problemContext.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
                console.warn(`Pareto/Fishbone context truncated.`);
            }

            // 2. Construct ENHANCED Prompt
            const prompt = `
                You are an expert quality management and process improvement consultant. Analyze the user's provided problem description using the Fishbone (Ishikawa) diagram and Pareto Principle (80/20 rule). Infer plausible causes and impacts based *only* on the context provided. ${truncatedNote}

                **USER'S PROBLEM DESCRIPTION:**
                \`\`\`
                ${problemContext}
                \`\`\`
                **VALIDATION:**
                If text is gibberish (e.g., "asdf"), return the INVALID structure.

                **DETAILED TASKS:**
                1.  **Problem Statement:** Clearly define the central \`problem_statement\` being analyzed, derived from the context.
                2.  **Fishbone Analysis:** Identify potential root causes categorized under the 6 standard Ms. For each category (Methods, Machines, Materials, Manpower, Measurement, Environment), list 2-4 specific sub-causes (2-5 words each) *inferred solely from the problem description*. If context doesn't suggest causes for a category, return an empty array for it.
                3.  **Pareto Analysis:** Based *only* on the inferred sub-causes and the problem context:
                    * Estimate a plausible relative \`impact_score\` (percentage, summing to 100) for each identified sub-cause, reflecting its likely contribution to the main problem statement based on the context.
                    * Categorize these causes into:
                        * \`vital_few\`: The top ~20% of causes contributing to ~80% of the impact. Include cause name, estimated impact_score, and fishbone category.
                        * \`useful_many\`: The remaining causes. Include cause name, estimated impact_score, and fishbone category.
                    * Provide an \`analysis_summary\` explaining how the vital few dominate the impact, according to the 80/20 principle, based on your estimations.
                4.  **Action Plan (Focus on Vital Few):** Generate an array of 2-3 structured actions targeting the identified \`vital_few\` causes. For each action:
                    * \`target_cause\`: The specific vital few cause being addressed.
                    * \`action_suggestion\`: A concrete, actionable step to mitigate this cause (e.g., "Implement standardized training", "Upgrade specific software module").
                    * \`rationale\`: Explain *how* this action addresses the target cause, referencing the problem context if possible.
                    * \`potential_impact\`: Estimate the potential impact on the main problem (High, Medium, Low).
                5.  **Self-Correction:** Before outputting JSON, rigorously check: Is the problem statement accurate? Are all fishbone sub-causes derived *only* from the text? Are impact scores plausible estimations based on context? Does the Pareto categorization correctly reflect the 80/20 split based on *your estimated scores*? Does the action plan focus *only* on the vital few? Is the JSON structure perfect? Fix all errors.

                **ABSOLUTE CONSTRAINTS:**
                - **CONTEXT GROUNDING:** All analysis (problem, causes, impacts, actions) MUST be based *exclusively* on the USER'S PROBLEM DESCRIPTION. Do NOT invent information.
                - **PLAUSIBLE ESTIMATION:** Impact scores are estimations based on context, not precise calculations, but should be logical and sum to 100.
                - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys and sub-keys. Use standard 6M fishbone categories.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
                {
                "problem_statement": "e.g., Low Customer Satisfaction Scores",
                "fishbone": {
                    "Methods": ["Sub-cause inferred from text 1", "Sub-cause inferred from text 2"],
                    "Machines": ["Sub-cause inferred from text 3"],
                    "Materials": [], // Example if no context
                    "Manpower": ["Sub-cause inferred from text 4", "Sub-cause inferred from text 5"],
                    "Measurement": ["Sub-cause inferred from text 6"],
                    "Environment": ["Sub-cause inferred from text 7"]
                },
                "pareto_analysis": {
                    "vital_few": [ // Top ~20% causes, ~80% impact based on estimations
                    {"cause": "Sub-cause inferred from text 4", "impact_score": 45, "category": "Manpower"},
                    {"cause": "Sub-cause inferred from text 1", "impact_score": 30, "category": "Methods"}
                    ],
                    "useful_many": [ // Remaining causes
                    {"cause": "Sub-cause inferred from text 6", "impact_score": 10, "category": "Measurement"},
                    {"cause": "Sub-cause inferred from text 3", "impact_score": 8, "category": "Machines"},
                    {"cause": "Sub-cause inferred from text 2", "impact_score": 5, "category": "Methods"},
                    {"cause": "Sub-cause inferred from text 5", "impact_score": 1, "category": "Manpower"},
                    {"cause": "Sub-cause inferred from text 7", "impact_score": 1, "category": "Environment"}
                    ],
                    "analysis_summary": "Explanation of 80/20 finding based on estimations (e.g., 'The analysis suggests that 'Sub-cause 4' and 'Sub-cause 1' collectively account for an estimated 75% of the impact...')"
                },
                "action_plan": [ // Actions targeting ONLY vital_few
                    {
                    "target_cause": "Sub-cause inferred from text 4",
                    "action_suggestion": "e.g., Develop targeted training program",
                    "rationale": "Addresses the primary driver identified (Manpower issue mentioned in context) by...",
                    "potential_impact": "High"
                    },
                    {
                    "target_cause": "Sub-cause inferred from text 1",
                    "action_suggestion": "e.g., Standardize process documentation",
                    "rationale": "Tackles the second major contributor (Methods issue described as...) by...",
                    "potential_impact": "High"
                    }
                ]
                }
            `;

            // 3. Send Request to Ollama
            console.log(`Sending ENHANCED Pareto/Fishbone prompt to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
            });

            if (!response.ok) {
                let errorBody = `API error ${response.status}`;
                try { errorBody += `: ${await response.text()}`; } catch (e) {}
                throw new Error(errorBody);
            }

            const data = await response.json();
            let parsedData;
            console.log('Raw AI Response (Pareto/Fishbone):', data.response); // Log raw response
            try {
                parsedData = JSON.parse(data.response);
                // *** Refined Robust Validation ***
                console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Pareto/Fishbone) ---');
                console.log(JSON.stringify(parsedData, null, 2));
                console.log('------------------------------------');

                if (!parsedData || typeof parsedData !== 'object' ||
                    !parsedData.problem_statement || typeof parsedData.problem_statement !== 'string' ||
                    !parsedData.fishbone || typeof parsedData.fishbone !== 'object' || !parsedData.fishbone.Methods || // Check one standard category
                    !parsedData.pareto_analysis || typeof parsedData.pareto_analysis !== 'object' ||
                    !Array.isArray(parsedData.pareto_analysis.vital_few) || !Array.isArray(parsedData.pareto_analysis.useful_many) || !parsedData.pareto_analysis.analysis_summary ||
                    !Array.isArray(parsedData.action_plan) || // Action plan is required, even if empty based on vital_few
                    // Check structure of first elements if they exist
                    (parsedData.pareto_analysis.vital_few.length > 0 && (typeof parsedData.pareto_analysis.vital_few[0] !== 'object' || !parsedData.pareto_analysis.vital_few[0].hasOwnProperty('cause') || !parsedData.pareto_analysis.vital_few[0].hasOwnProperty('impact_score'))) ||
                    (parsedData.action_plan.length > 0 && (typeof parsedData.action_plan[0] !== 'object' || !parsedData.action_plan[0].hasOwnProperty('target_cause') || !parsedData.action_plan[0].hasOwnProperty('rationale')))
                    )
                {
                    console.error("Validation Failed (Enhanced Pareto/Fishbone): Required fields missing or invalid structure.", parsedData);
                    throw new Error(`AI response structure is incorrect or inconsistent (Enhanced Pareto/Fishbone). Check problem, fishbone, pareto (vital/useful/summary), and action_plan. See console logs.`);
                }
                // Simple check on impact scores summing roughly to 100
                const totalScore = [...parsedData.pareto_analysis.vital_few, ...parsedData.pareto_analysis.useful_many].reduce((sum, item) => sum + (item.impact_score || 0), 0);
                if (Math.abs(totalScore - 100) > 5) { // Allow some tolerance
                    console.warn(`Pareto impact scores sum to ${totalScore}, not 100.`);
                    // Don't throw error, but log it. AI might struggle with perfect sums.
                }

                console.log(`Successfully parsed ENHANCED Pareto/Fishbone JSON using ${MODEL_NAME}. Problem: ${parsedData.problem_statement}.`);

            } catch (e) {
                console.error(`Failed to parse/validate ENHANCED Pareto/Fishbone JSON using ${MODEL_NAME}:`, data?.response, e);
                throw new Error(`Invalid JSON received or validation failed (Enhanced Pareto/Fishbone): ${e.message}. See raw response in console.`);
            }

            // 4. Render Results using a new dedicated function
            renderParetoFishbonePage(analysisResultContainer, parsedData);

        } catch (error) {
            console.error(`Error in handleParetoFishboneAnalysis (Enhanced) using ${MODEL_NAME}:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            // Ensure loading stops reliably
            if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
            }
        }
    }


    function renderParetoFishbonePage(container, data) {
        container.innerHTML = ""; // Clear loading
        // Basic validation
        if (!data || !data.problem_statement || !data.fishbone || !data.pareto_analysis || !data.action_plan) {
            console.error("Incomplete data passed to renderParetoFishbonePage:", data);
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Pareto/Fishbone results.</div>`;
            $("analysisActions").classList.add("hidden");
            return;
        }

        const fishboneElements = parseFishboneData(data);
        const { problem_statement, fishbone, pareto_analysis, action_plan } = data;

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="pareto"> Pareto Chart & Summary</button>
            <button class="analysis-tab-btn" data-tab="fishbone"> Fishbone Diagram</button>
            <button class="analysis-tab-btn" data-tab="action"> Action Plan (Vital Few)</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Techniques</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="paretoPanel" class="analysis-tab-panel active"></div>
            <div id="fishbonePanel" class="analysis-tab-panel"></div>
            <div id="actionPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Pareto Chart & Summary Tab ---
        const paretoPanel = $("paretoPanel");
        paretoPanel.innerHTML = `<div class="p-4">
            <h3 class="text-2xl font-bold mb-4 text-center">Pareto Analysis (80/20 Rule)</h3>
            <p class="text-center text-lg italic text-white/80 mb-6">Problem: ${problem_statement}</p>
            <div id="paretoChartContainer" class="w-full h-[550px] plotly-chart bg-black/10 rounded-lg mb-8"></div>
            <h4 class="text-xl font-semibold mb-3">Analysis Summary:</h4>
            <blockquote class="p-3 italic border-l-4 border-gray-500 bg-black/20 text-white/90 text-sm">
                ${pareto_analysis.analysis_summary || "Summary unavailable."}
            </blockquote>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 text-sm">
                <div class="bg-red-900/20 p-3 rounded border border-red-500/50">
                    <h5 class="font-bold text-red-300 mb-1"> Vital Few (${pareto_analysis.vital_few.length} causes)</h5>
                    <p class="text-xs text-white/70 mb-2">Focus improvement efforts here (~80% of impact).</p>
                    <ul class="list-disc list-inside space-y-1">
                        ${pareto_analysis.vital_few.map(item => `<li>${item.cause} (${item.impact_score}%)</li>`).join("")}
                    </ul>
                </div>
                <div class="bg-gray-700/20 p-3 rounded border border-gray-500/50">
                    <h5 class="font-bold text-gray-300 mb-1"> Useful Many (${pareto_analysis.useful_many.length} causes)</h5>
                    <p class="text-xs text-white/70 mb-2">Address later or if resources allow (~20% of impact).</p>
                    <ul class="list-disc list-inside space-y-1">
                        ${pareto_analysis.useful_many.map(item => `<li>${item.cause} (${item.impact_score}%)</li>`).join("")}
                    </ul>
                </div>
            </div>
        </div>`;
        // Render the Pareto chart
        try {
            createParetoChartJS(pareto_analysis, "paretoChartContainer"); // Use the existing chart function
        } catch(e) {
            console.error("Error rendering Pareto chart:", e);
            $("paretoChartContainer").innerHTML = "<p class='p-4 text-center text-red-400'>Could not render Pareto chart.</p>";
        }

        // --- 2. Populate Fishbone Diagram Tab (Textual) ---
        const fishbonePanel = $("fishbonePanel");
        let fishboneHtml = `<div class="p-4">
            <h3 class="text-2xl font-bold mb-4 text-center">Fishbone Diagram (Ishikawa) - Potential Causes</h3>
            <p class="text-center text-lg italic text-white/80 mb-6">Problem: ${problem_statement}</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

        const standardCategories = ["Methods", "Machines", "Materials", "Manpower", "Measurement", "Environment"];
        standardCategories.forEach(category => {
            const subCauses = fishbone[category] || [];
            // Highlight vital few causes within the fishbone list
            const causesHtml = subCauses.map(cause => {
                const isVital = pareto_analysis.vital_few.some(item => item.cause.toLowerCase() === cause.toLowerCase());
                return `<li class="${isVital ? 'font-semibold text-red-300' : 'text-white/80'}">${isVital ? ' ' : ''}${cause}</li>`;
            }).join("");

            fishboneHtml += `
                <div class="bg-white/5 p-3 rounded-lg border-t-4 border-indigo-400">
                    <h4 class="font-semibold text-lg mb-2 text-indigo-300">${category}</h4>
                    ${subCauses.length > 0
                        ? `<ul class="list-disc list-inside space-y-1 text-sm">${causesHtml}</ul>`
                        : `<p class="text-sm italic text-white/60">(No specific causes identified from context)</p>`
                    }
                </div>`;
        });

        fishboneHtml += `</div></div>`; // Close grid and p-4
        fishboneHtml += `
            <div id="fishboneCy" class="fishboneCy" flex justify-center></div>
            <div class="diagram-controls" flex justify-center gap-2 mt-4>
                <button class="diagram-fit-btn" data-action="fit">Fit to View</button>
                <button class="diagram-reset-btn" data-action="reset">Reset Zoom</button>
                <button class="diagram-export-btn" data-action="export">Export as PNG</button>
            </div>
            `;
        fishbonePanel.innerHTML = fishboneHtml;

        // --- 3. Populate Action Plan Tab ---
        const actionPanel = $("actionPanel");
        let actionHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Action Plan (Focus on Vital Few)</h3>`;
        if (action_plan && action_plan.length > 0) {
            actionHtml += `<p class="text-sm text-white/70 mb-6 italic">Concentrate resources on addressing these high-impact causes identified in the Pareto analysis.</p>`;
            actionHtml += `<div class="space-y-6">`;
            action_plan.forEach((action, index) => {
                let impactClass = "text-yellow-400"; // Medium default
                if (action.potential_impact?.toLowerCase() === 'high') impactClass = "text-green-400";
                else if (action.potential_impact?.toLowerCase() === 'low') impactClass = "text-red-400";

                actionHtml += `
                    <div class="prescription-card border-l-4 border-yellow-500">
                        <h4 class="text-xl font-bold">${index + 1}. ${action.action_suggestion}</h4>
                        <p class="text-xs font-semibold my-1 text-indigo-300">TARGET CAUSE: ${action.target_cause || 'N/A'}</p>
                        <p class="text-xs font-semibold my-1 ${impactClass}">POTENTIAL IMPACT: ${action.potential_impact || 'N/A'}</p>
                        <p class="rationale"><strong>Rationale:</strong> ${action.rationale || 'N/A'}</p>
                    </div>`;
            });
            actionHtml += `</div>`;
        } else {
            actionHtml += `<p class="text-center text-white/70 italic">No specific actions were generated for the 'vital few' causes, possibly because none were identified or derivable from the context.</p>`;
        }
        actionHtml += `</div>`;
        actionPanel.innerHTML = actionHtml;

        // --- 4. Populate Learn Techniques Tab ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
        <div class="p-6 space-y-6 text-white/90">
            <h3 class="text-2xl font-bold text-center mb-4"> Understanding Pareto & Fishbone Analysis</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-black/20 p-4 rounded-lg">
                    <h4 class="text-lg font-bold mb-2 text-indigo-300"> Pareto Principle (80/20 Rule)</h4>
                    [Image of Pareto chart example]
                    <p class="text-sm text-white/80 mb-3">States that for many outcomes, roughly 80% of consequences come from 20% of causes. In quality improvement, it helps identify the "vital few" causes that have the most significant impact on a problem, distinguishing them from the "useful many."</p>
                    <h5 class="text-md font-semibold mb-1">How it's Used Here:</h5>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li>Identifies potential causes from the Fishbone analysis.</li>
                        <li>Estimates the relative impact of each cause on the main problem.</li>
                        <li>Sorts causes by impact score.</li>
                        <li>Calculates cumulative impact percentage.</li>
                        <li>Visually separates the "vital few" (first ~80% cumulative impact) from the "useful many".</li>
                        <li>Directs action planning towards the vital few for maximum efficiency.</li>
                    </ul>
                </div>

                <div class="bg-black/20 p-4 rounded-lg">
                    <h4 class="text-lg font-bold mb-2 text-indigo-300"> Fishbone Diagram (Ishikawa / Cause-and-Effect)</h4>
                    [Image of Fishbone diagram example]
                    <p class="text-sm text-white/80 mb-3">A visualization tool used to brainstorm and categorize potential causes of a specific problem (the "effect"). Causes are grouped into major categories to ensure a structured and comprehensive analysis.</p>
                    <h5 class="text-md font-semibold mb-1">Standard Categories (6Ms):</h5>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Methods:</strong> Policies, procedures, rules, regulations, laws.</li>
                        <li><strong>Machines:</strong> Equipment, tools, technology used.</li>
                        <li><strong>Materials:</strong> Raw materials, consumables, information.</li>
                        <li><strong>Manpower (People):</strong> Anyone involved in the process; skills, training, motivation.</li>
                        <li><strong>Measurement:</strong> Data generated from the process used for evaluation.</li>
                        <li><strong>Environment (Mother Nature):</strong> Location, time, temperature, workplace culture.</li>
                    </ul>
                    <p class="text-xs italic mt-2">Note: Categories can sometimes be adapted based on the industry (e.g., 4S for Service).</p>
                </div>
            </div>

            <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
                <h4 class="text-lg font-bold mb-2"> How They Work Together:</h4>
                <p class="text-sm text-white/80">The Fishbone diagram helps brainstorm a wide range of potential causes. The Pareto analysis then helps prioritize which of those causes are likely contributing the most to the problem, allowing teams to focus their improvement efforts effectively.</p>
            </div>
        </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                // Deactivate all
                tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

                // Activate clicked
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add("active");
                    // Resize chart if the Pareto tab is activated
                    const chart = targetPanel.querySelector('.plotly-chart');
                    if (chart && chart.layout && typeof Plotly !== 'undefined') {
                        try { Plotly.Plots.resize(chart); } catch (err) { console.error("Resize err:", err); }
                    }
                } else {
                    console.warn("Target panel not found:", targetPanelId);
                }

                if (e.target.dataset.tab === "fishbone") {
                    const fishboneDiagramContainer = targetPanel.querySelector("#fishboneCy");
                    if (fishboneDiagramContainer && fishboneElements) {
                        let cy;
                        cy = renderFishboneDiagram(fishboneDiagramContainer, fishboneElements);
                        document.querySelector('.diagram-fit-btn').addEventListener('click', () => fitDiagram(cy));
                        document.querySelector('.diagram-reset-btn').addEventListener('click', () => resetZoom(cy));
                        document.querySelector('.diagram-export-btn').addEventListener('click', () => exportPNG(cy));
                    }
                }
            }
        });

        // Attempt initial resize for chart in the default active tab (Pareto)
        setTimeout(() => {
            const initialChart = $('paretoChartContainer');
            if (initialChart && initialChart.layout && typeof Plotly !== 'undefined') {
                try { Plotly.Plots.resize(initialChart); } catch (err) { console.error("Initial Resize err:", err); }
            }
        }, 150);


        $("analysisActions").classList.remove("hidden"); // Show save buttons
        // setLoading('generate', false); // Handled in the calling function
    }


    // Ensure createParetoChartJS is available (it was defined in a previous step, but include it here for completeness if needed)
    function createParetoChartJS(paretoData, containerId) {
        const container = $(containerId);
        if (!container) {
            console.error(`Container with ID ${containerId} not found for Pareto chart.`);
            return;
        }
        container.innerHTML = ""; // Clear previous chart

        // Ensure paretoData exists and has the expected structure
        if (!paretoData || (!paretoData.vital_few && !paretoData.useful_many)) {
            container.innerHTML = "<p class='p-4 text-center text-red-400'>Pareto data is missing or incomplete.</p>";
            return;
        }

        const allCauses = (paretoData.vital_few || []).concat(paretoData.useful_many || []);
        if (allCauses.length === 0) {
            container.innerHTML = "<p class='p-4 text-center text-white/70'>No causes identified for Pareto analysis.</p>";
            return;
        }


        allCauses.sort((a, b) => (b.impact_score || 0) - (a.impact_score || 0));

        const causes = allCauses.map((item) => item.cause || "Unknown Cause");
        const impacts = allCauses.map((item) => item.impact_score || 0);
        const categories = allCauses.map((item) => item.category || "Uncategorized");

        const cumulative = impacts.reduce((acc, val) => {
            acc.push((acc.length > 0 ? acc[acc.length - 1] : 0) + val);
            return acc;
        }, []);
        // Ensure totalImpact is not zero before dividing
        const totalImpact = impacts.reduce((a, b) => a + b, 0);
        const cumulativePct = totalImpact > 0 ? cumulative.map((val) => (val / totalImpact) * 100) : cumulative.map(() => 0);


        const trace1 = {
            x: causes,
            y: impacts,
            name: "Impact Score",
            type: "bar",
            text: impacts.map((imp) => `${imp}%`),
            textposition: "outside",
            marker: { color: "var(--primary)" }, // Consistent color
            hovertemplate: "<b>%{x}</b><br>Impact: %{y}%<br>Category: %{customdata}<extra></extra>",
            customdata: categories
        };

        const trace2 = {
            x: causes,
            y: cumulativePct,
            name: "Cumulative %",
            type: "scatter",
            mode: "lines+markers",
            line: { color: "var(--accent)", width: 3 }, // Accent color for line
            marker: { size: 8 },
            yaxis: "y2",
            hovertemplate: "<b>%{x}</b><br>Cumulative: %{y:.1f}%<extra></extra>"
        };

        // Find the index where cumulative percentage crosses 80%
        const eightyPercentIndex = cumulativePct.findIndex(p => p >= 80);
        let vitalFewCount = eightyPercentIndex !== -1 ? eightyPercentIndex + 1 : allCauses.length;
        // Ensure vitalFewCount matches the actual vital_few array length if provided, otherwise use calculated
        vitalFewCount = paretoData.vital_few ? paretoData.vital_few.length : vitalFewCount;


        const layout = {
            title: "Pareto Analysis - Vital Few vs. Useful Many Causes",
            xaxis: { title: "Potential Root Causes", tickangle: -45, automargin: true },
            yaxis: { title: "Estimated Impact Score (%)", gridcolor: "rgba(255,255,255,0.1)" },
            yaxis2: {
                title: "Cumulative Impact (%)",
                overlaying: "y",
                side: "right",
                range: [0, 101],
                gridcolor: "rgba(255,255,255,0.05)",
                zeroline: false
            },
            shapes: [
                // 80% cumulative line
                { type: "line", xref: "paper", x0: 0, x1: 1, yref: "y2", y0: 80, y1: 80, line: { color: "orange", width: 2, dash: "dot" } },
                // Vertical line separating vital few
                vitalFewCount > 0 && vitalFewCount < allCauses.length ? { type: "line", xref: "x", x0: vitalFewCount - 0.5, x1: vitalFewCount - 0.5, yref: "paper", y0: 0, y1: 1, line: { color: "rgba(255, 0, 0, 0.5)", width: 2, dash: "dash" } } : {}
            ],
            annotations: [
                vitalFewCount > 0 ? { xref: 'x', yref: 'paper', x: (vitalFewCount - 1) / 2, y: 1.05, text: ' Vital Few', showarrow: false, font: {color: 'red'} } : {},
                vitalFewCount < allCauses.length ? { xref: 'x', yref: 'paper', x: vitalFewCount + (allCauses.length - vitalFewCount -1) / 2, y: 1.05, text: ' Useful Many', showarrow: false, font: {color: 'grey'} } : {},
                { xref: 'paper', yref: 'y2', x: 0.95, y: 80, text: '80% Impact', showarrow: false, font: {color: 'orange'}, xanchor: 'right', yanchor: 'bottom' }
            ],
            showlegend: true,
            height: 550, // Increased height slightly
            hovermode: "x unified",
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(0,0,0,0)",
            font: { color: "white" },
            legend: { orientation: "h", y: -0.3 }, // Adjusted legend position
            margin: { t: 60, b: 150, l: 60, r: 60 } // Adjusted margins
        };

        Plotly.newPlot(containerId, [trace1, trace2], layout, { responsive: true });
    }



    /**
     * Parses the fishbone JSON schema and generates a Cytoscape.js elements array
     * with preset positions for a fishbone diagram layout.
     *
     * @param {object} jsonData The input JSON data.
     * @returns {Array} A Cytoscape.js elements array.
     */
    function parseFishboneData(jsonData) {
        const elements = [];

        // --- 1. Layout Constants (Tweak these to change the diagram's appearance) ---
        const Y_SPINE = 500;        // Y-coordinate for the horizontal spine
        const X_HEAD = 1300;        // X-coordinate for the "Problem" node (the head)
        const X_TAIL = 0;           // X-coordinate for the tail
        
        const Y_RIB_TOP = 250;      // Y-coordinate for top-row categories
        const Y_RIB_BOTTOM = 750;   // Y-coordinate for bottom-row categories
        
        const X_RIB_START = 250;    // X-coordinate for the first group of ribs
        const X_RIB_SPACING = 350;  // Horizontal gap between rib groups

        // --- 2. Add Head and Tail Nodes ---
        
        // Add the "Head" (Problem)
        elements.push({
            data: { id: 'problem', label: jsonData.problem_statement, type: 'head' },
            position: { x: X_HEAD, y: Y_SPINE },
            locked: true,
        });

        // Add the "Tail" (an invisible node to anchor the spine)
        elements.push({
            data: { id: 'tail', type: 'spine' },
            position: { x: X_TAIL, y: Y_SPINE },
            locked: true,
        });

        // --- 3. Process Categories (Ribs) and Causes (Bones) ---

        // Filter out any categories that have no causes
        const categories = Object.keys(jsonData.fishbone)
                                .filter(key => jsonData.fishbone[key].length > 0);

        const spineNodesToConnect = ['tail']; // Start the spine connection list

        categories.forEach((categoryName, index) => {
            const causes = jsonData.fishbone[categoryName];
            const n = causes.length;

            // Alternate categories between top and bottom
            const isTop = index % 2 === 0;
            const yCategory = isTop ? Y_RIB_TOP : Y_RIB_BOTTOM;
            
            // Group ribs in pairs (e.g., 0 & 1, 2 & 3) at the same horizontal level
            const ribGroupIndex = Math.floor(index / 2);
            const xCategory = X_RIB_START + (ribGroupIndex * X_RIB_SPACING);

            // A. Create the invisible "Spine" node for this rib group to connect to
            const spineNodeId = 'spine-' + ribGroupIndex;
            let xSpinePoint;
            if (!elements.find(el => el.data.id === spineNodeId)) {
                xSpinePoint = xCategory + (X_RIB_SPACING / 3); // Make ribs angle forward
                elements.push({
                    data: { id: spineNodeId, type: 'spine' },
                    position: { x: xSpinePoint, y: Y_SPINE },
                    locked: true,
                });
                spineNodesToConnect.push(spineNodeId);
            } else {
                // Get position of existing spine node
                xSpinePoint = elements.find(el => el.data.id === spineNodeId).position.x;
            }
            
            // B. Create the "Category" node (the rib end)
            const categoryNodeId = 'cat-' + index;
            elements.push({
                data: { id: categoryNodeId, label: categoryName, type: 'category' },
                position: { x: xCategory, y: yCategory },
                locked: true,
            });

            // C. Create the "Cause" nodes and chain the edges
            let lastNodeId = categoryNodeId; // Start the chain from the category node

            causes.forEach((causeText, causeIndex) => {
                const causeNodeId = 'cause-' + index + '-' + causeIndex;
                
                // Calculate position by interpolating between category and spine node
                // (causeIndex + 1) / (n + 1) ensures nodes are evenly spaced *between* start and end
                const percent = (causeIndex + 1) / (n + 1);
                
                const xCause = xCategory + (percent * (xSpinePoint - xCategory));
                const yCause = yCategory + (percent * (Y_SPINE - yCategory));

                // Add the cause node
                elements.push({
                    data: { id: causeNodeId, label: causeText, type: 'cause' },
                    position: { x: xCause, y: yCause },
                    locked: true
                });

                // Add the "bone" edge from the *previous* node in the chain
                elements.push({
                    data: { id: 'edge-' + lastNodeId + '-' + causeNodeId, source: lastNodeId, target: causeNodeId, type: 'bone' },
                });
                
                lastNodeId = causeNodeId; // This cause becomes the next source
            });

            // D. Connect the *last* cause node to the spine node
            elements.push({
                data: { id: 'edge-' + lastNodeId + '-' + spineNodeId, source: lastNodeId, target: spineNodeId, type: 'bone' },
            });
        });

        // --- 4. Connect the Spine Nodes ---
        spineNodesToConnect.push('problem'); // Add the head as the final connection

        for (let i = 0; i < spineNodesToConnect.length - 1; i++) {
            elements.push({
                data: {
                    id: 'spine-edge-' + i,
                    source: spineNodesToConnect[i],
                    target: spineNodesToConnect[i+1],
                    type: 'spine-bone'
                },
            });
        }

        return elements;
    }



    // =========================================================================
    // ===== SPECIALIZED ANALYSIS LOGIC (SWOT, ARCHETYPE, FACTOR, etc.)   =====
    // =========================================================================


    async function handleNovelGoalsAnalysis_NS() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Mapping Horizons of Growth...</h3><p class="text-white/80 mb-2">Analyzing your ambition using a refined, context-aware prompt...</p></div>`;
        setLoading("generate", true);

        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Using Llama 3.1 as requested

        try {
            const useDoc = $("docUpload").checked;
            let ambitionText = "";

            if (useDoc) {
                const file = $("novelGoalsFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                ambitionText = await extractTextFromFile(file);
            } else {
                ambitionText = $("novelGoalsContent").value.trim();
                if (!ambitionText) {
                    throw new Error("Please describe your ambition or goal in the text area.");
                }
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("novelGoalsLocation").value.trim();
            if (location) {
                ambitionText = `Target Location/Region: ${location}\n\n${ambitionText}`;
                console.log("Injected location into Novel Goals Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            if (ambitionText.length > MAX_CONTEXT_LENGTH) {
                console.warn(`Ambition text truncated to ${MAX_CONTEXT_LENGTH} characters.`);
                ambitionText = ambitionText.substring(0, MAX_CONTEXT_LENGTH);
            }

            // --- Refined Prompt with Stricter Grounding ---
            const prompt = `
                You are an expert corporate strategist specializing in McKinsey's "Three Horizons of Growth" framework. Your task is to analyze the user's provided text and develop a structured strategic plan *strictly grounded* in that text.

                **USER'S PROVIDED CONTEXT:**
                """
                ${ambitionText}
                """

                **VALIDATION:**
                If text is gibberish, return the INVALID structure.

                **TASK:**
                Formulate a Three Horizons plan derived *exclusively* from the details within the USER'S PROVIDED CONTEXT.

                1.  **main_goal**: First, identify the primary goal explicitly stated or strongly implied in the context. Refine this into a single, clear, measurable goal statement (under 25 words) that accurately reflects the context's focus (e.g., if the context is about research, the goal should relate to using research findings).

                2.  **horizons**: Create an array containing exactly three objects, one for each horizon (H1, H2, H3). For each horizon, define initiatives *only if they directly address the main_goal and are supported by specific details in the USER'S PROVIDED CONTEXT*.

                    * **Horizon 1 (Core - ~0-18 Months):** Focus on optimizing or improving the *current business* described in the context. Initiatives MUST relate to elements explicitly mentioned (e.g., improving listed service quality dimensions).
                    * **Horizon 2 (Adjacent - ~12-36 Months):** Focus on leveraging insights or capabilities *mentioned in the context* to build logically adjacent growth related to the main_goal (e.g., using research findings on satisfaction drivers to propose a loyalty program *if loyalty programs are implied or discussed*).
                    * **Horizon 3 (Transformational - ~3-7+ Years):** Focus on exploring future options *suggested by the context* (e.g., researching long-term implications mentioned in the text).

                    For *each* horizon object, provide:
                    * \`horizon_name\`: (e.g., "Horizon 1: Optimize Core CX Research").
                    * \`timeframe\`: (e.g., "0-18 Months").
                    * \`focus\`: A one-sentence description of this horizon's focus *directly tied to the main_goal and the context provided*.
                    * \`initiatives\`: An array of 1-3 specific initiatives. **CRITICAL:** If no initiatives for a specific horizon can be reasonably derived *solely from the provided context* to support the main goal, return an empty array [] for that horizon's \`initiatives\`. For each valid initiative:
                        * \`initiative_name\`: Clear name (under 10 words).
                        * \`description\`: Brief explanation *linking it directly to specific details in the context* and explaining how it supports the horizon's focus.
                        * \`kpis\`: 2-3 specific, measurable KPIs relevant to the initiative and context.

                **ABSOLUTE CONSTRAINTS (VERY IMPORTANT):**
                - **NO FABRICATION:** Do NOT invent initiatives, goals, or focus areas that are not explicitly stated or logically derived from the USER'S PROVIDED CONTEXT.
                - **CONTEXT IS KING:** Your entire response must be based *only* on the text provided in the "USER'S PROVIDED CONTEXT" section.
                - **AVOID GENERIC STRATEGIES:** Do NOT suggest common business strategies (like 'omnichannel expansion', 'subscription models', 'AI implementation', 'sustainability drives', 'new market entry') UNLESS these concepts are *specifically mentioned* or *directly implied as goals* within the user's text. Focus only on what the text provides.
                - **RESEARCH CONTEXT AWARENESS:** If the context is about a research plan (like the example text), the goal and initiatives should relate to executing that research or acting on its *hypothesized* findings, not on unrelated business expansion.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object with the exact structure specified below. Ensure all fields are filled according to the constraints above. Return empty arrays [] for initiatives if none are derivable from the context for a given horizon.
                {
                  "main_goal": "Refined goal statement strictly derived from user context.",
                  "horizons": [
                    { // Horizon 1
                      "horizon_name": "Horizon 1: ...", "timeframe": "0-18 Months", "focus": "...",
                      "initiatives": [ /* Initiatives derived ONLY from context or empty [] */ ]
                    },
                    { // Horizon 2
                      "horizon_name": "Horizon 2: ...", "timeframe": "12-36 Months", "focus": "...",
                      "initiatives": [ /* Initiatives derived ONLY from context or empty [] */ ]
                    },
                    { // Horizon 3
                      "horizon_name": "Horizon 3: ...", "timeframe": "3-7+ Years", "focus": "...",
                      "initiatives": [ /* Initiatives derived ONLY from context or empty [] */ ]
                    }
                  ]
                }
            `;

            console.log("Sending STRICTLY GROUNDED Three Horizons prompt to Llama 3.1...");
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: { num_ctx: 32768 }
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
            const data = await response.json();

            let parsedData;
            try {
                 parsedData = JSON.parse(data.response);
                 console.log("Successfully parsed STRICT Three Horizons JSON response from Llama 3.1.");
            } catch (e) {
                console.error("Failed to parse STRICT Three Horizons JSON response:", data.response, e);
                throw new Error("Invalid JSON received from AI. The AI may have failed to follow the strict formatting or grounding constraints. Please try again or refine the input text.");
            }

            // Validate structure minimally
            if (!parsedData.main_goal || !parsedData.horizons || !Array.isArray(parsedData.horizons) || parsedData.horizons.length !== 3) {
                console.error("Parsed JSON structure is invalid:", parsedData);
                throw new Error("AI response did not follow the required Three Horizons structure despite instructions.");
            }

            renderNovelGoalsPage_NS(analysisResultContainer, parsedData); // Pass to the renderer

        } catch (error) {
            console.error("Error during Novel Goals analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        }
    }

    function parseCSV(csvText) {
        const lines = csvText.trim().split("\n");
        const header = lines[0].split(",").map((h) => h.trim());
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(",").map((v) => v.trim());
            if (values.length === header.length) {
                const row = {};
                for (let j = 0; j < header.length; j++) {
                    const value = values[j];
                    // Attempt to convert to number if possible
                    const numValue = parseFloat(value);
                    row[header[j]] = isNaN(numValue) ? value : numValue;
                }
                rows.push(row);
            }
        }
        return { header, rows };
    }

    
   

    async function handleArchetypeAnalysis() {
        const analysisResultContainer = $("analysisResult");

        analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Performing System Thinking Analysis</h3>
                        <p class="text-white/80 mb-2">This multi-step process may take several minutes.</p>
                        <p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p>
                    </div>`;

        const statusEl = $("analysisStatus");
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";

        try {
            statusEl.textContent = "Reading and processing your document...";
            const useDoc = $("docUpload").checked;
            let text = "";

            if (useDoc) {
                const file = $("archetypeFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                text = await extractTextFromFile(file);
            } else {
                text = $("archetypeContent").value;
                if (!text.trim()) throw new Error("Please enter system information in the text area.");
            }
            if (!text) throw new Error("Could not get text from the document or text area.");

            // --- NEW: INJECT LOCATION ---
            const location = $("archetypeLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
                console.log("Injected location into Archetype Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            if (text.length > 3000) text = text.substring(0, 3000);

            async function generateOllamaResponse(prompt) {
                const response = await fetch(OLLAMA_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        prompt: prompt,
                        stream: false,
                        format: "json",
                        options: { num_ctx: 32768 }
                    })
                });
                if (!response.ok) throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                const data = await response.json();
                return JSON.parse(data.response); // Expecting valid JSON now
            }

            // Step 1: Extract Concepts
            statusEl.textContent = "Step 1/3: Extracting key system concepts...";
            const conceptPrompt = `
                        Analyze the following text and extract key 2-4 word concepts. If it is gibberish, return {"concepts": []}.
                        Else, for each concept, provide:
                        1. name (2-4 words)
                        2. description (brief)
                        3. effect ("+", "-", or "0")
                        4. influence ("High", "Medium", or "Low")
                        Text: ${text}
                        Return ONLY a valid JSON object with the structure: {"concepts": [{"name": "...", "description": "...", "effect": "...", "influence": "..."}]}`;
            const conceptData = await generateOllamaResponse(conceptPrompt);
            const concepts = conceptData.concepts;
            if (!concepts || concepts.length === 0) throw new Error("No concepts were extracted from the document.");

            // Step 2: Identify Archetypes
            statusEl.textContent = "Step 2/3: Identifying relevant system archetypes...";
            const conceptText = concepts.map((c) => c.name).join(", ");
            const archetypePrompt = `
                        You are a system thinking expert. Analyze the provided text and the key concepts extracted from it to identify the single most fitting system archetype.

                        **System Description/Text:**
                        ${text}

                        **Key Concepts:**
                        [${conceptText}]

                        **Task:**
                        From the list of common archetypes below, select the ONE that best explains the dynamics described in the text.
                        - **Success to the Successful:** One entity gets more resources, which it uses to perform better and get even more resources, starving competitors.
                        - **Limits to Growth:** A reinforcing process of growth eventually meets a balancing process that slows or stops the growth.
                        - **Shifting the Burden:** A short-term solution is used to correct a problem, but it undermines the ability of the system to use a more fundamental, long-term solution.
                        - **Tragedy of the Commons:** Individuals use a shared resource in their own self-interest, leading to its depletion.
                        - **Fixes that Fail:** A fix is applied to a problem that has immediate positive results but unforeseen long-term negative consequences.

                        **Analysis & Response:**
                        Based on the text and concepts, provide a JSON response with the following structure. The description MUST explain *why* the chosen archetype fits the specific situation described in the text.

                        Return ONLY a valid JSON object:
                        {
                          "archetypes": [{
                            "name": "Name of the chosen archetype (e.g., Success to the Successful)",
                            "relevance_score": 10,
                            "description": "A detailed explanation of how the dynamics in the provided text perfectly match the chosen archetype. Reference the key concepts.",
                            "leverage_points": ["Specific leverage point 1", "Specific leverage point 2"],
                            "interventions": ["Specific intervention 1", "Specific intervention 2"]
                          }]
                        }`;
            const archetypeData = await generateOllamaResponse(archetypePrompt);
            let archetypes = archetypeData.archetypes;

            archetypes.sort((a, b) => (b.relevance_score || 0) - (a.relevance_score || 0));
            const topArchetypeCount = Math.max(1, Math.floor(archetypes.length * 0.2));
            const topArchetypes = archetypes.slice(0, topArchetypeCount);

            // Step 3: Analyze Leverage Points with enhanced context-aware prompt
            statusEl.textContent = "Step 3/3: Analyzing high-impact leverage points...";
            const leveragePrompt = `
                        You are a systems thinking strategist. Your task is to identify the most effective leverage point to overcome the central problem described in the provided text.

                        **Context:**
                        The text describes a '${topArchetypes[0].name}' situation. 

                        **Key Concepts Extracted from the Text:**
                        [${conceptText}]

                        **Task:**
                        From the list of key concepts, identify the single concept that represents the **most powerful solution or intervention** to achieve the strategic goal implied in the text.

                        **CRITICAL INSTRUCTION:** Do NOT select a concept that represents the problem. You must select the concept that represents the **SOLUTION**.

                        Provide your response as a valid JSON object with the following structure:
                        {
                          "leverage_points": [{
                            "concept": "The name of the concept that is the best leverage point",
                            "score": 10,
                            "reasoning": "Explain WHY this concept is the key to overcoming the limitation and achieving the goal, based on the text.",
                            "actions": ["Action 1 related to the solution", "Action 2 related to the solution", "Action 3 related to the solution"],
                            "impact": "High"
                          }]
                        }`;
            
            const leverageData = await generateOllamaResponse(leveragePrompt);
            let leveragePoints = leverageData.leverage_points;

            leveragePoints.sort((a, b) => (b.score || 0) - (a.score || 0));
            const topLeverageCount = Math.max(1, Math.floor(leveragePoints.length * 0.2));
            const topLeveragePoints = leveragePoints.slice(0, topLeverageCount);

            // Final step: Render the full page
            statusEl.textContent = "Analysis complete! Rendering results...";
            renderArchetypeAnalysisPage(analysisResultContainer, {
                concepts,
                topArchetypes,
                topLeveragePoints
            });
        } catch (error) {
            console.error("Error during Archetype analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}<br><br><span class="text-sm text-white/60">Please ensure your Ollama server is running and accessible at ${OLLAMA_URL}.</span></div>`;
        } finally {
            setLoading("generate", false);
        }
    }

    

    async function handleProcessMappingAnalysis() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white">Mapping and Analyzing Your Process...</h3><p class="text-white/80 mb-2">Identifying steps, bottlenecks, and potential optimizations...</p></div>`; // Updated text
        setLoading("generate", true);

        // Define URL and Model
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Consistent model

        try {
            // 1. Gather Inputs
            const useDoc = document.querySelector('input[name="inputType"]:checked').id === "docUpload";
            let content = "";
            if (useDoc) {
                const file = $("processFile").files[0];
                if (!file) throw new Error("Please select a document.");
                content = await extractTextFromFile(file);
            } else {
                content = $("processContent").value.trim();
                if (!content) throw new Error("Please describe the process.");
            }

            // --- INJECT LOCATION ---
            const location = $("processLocation").value.trim();
            if (location) {
                content = `Target Location/Region: ${location}\n\n${content}`;
                console.log("Injected location into Process Mapping prompt:", location);
            }

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (content.length > MAX_CONTEXT_LENGTH) {
                content = content.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
                console.warn(`Process Mapping context truncated.`);
            }

            // 2. Construct ENHANCED Prompt
            const prompt = `
                You are an expert business process analyst. Analyze the following process description provided by the user and model it comprehensively. Focus on identifying bottlenecks and suggesting concrete optimizations based *only* on the provided text. ${truncatedNote}

                **USER'S PROCESS DESCRIPTION:**
                \`\`\`
                ${content}
                \`\`\`

                **VALIDATION:**
                If the text is gibberish, return the INVALID structure.
                **DETAILED TASKS:**
                1.  **Process Definition:** Define a clear \`process_name\` based on the description.
                2.  **Identify Steps (8-12 steps):** Extract the sequential steps. For each step, provide:
                    * \`id\`: A unique sequential number (1, 2, 3...).
                    * \`name\`: A concise action-oriented name (2-5 words).
                    * \`description\`: A brief explanation of the step based on the context.
                    * \`owner\`: The role or department responsible, as mentioned or implied in the context.
                    * \`type\`: Classify as "Start", "Task", "Decision", "End", or "Sub-process" based on context.
                3.  **Define Connections:** Specify the flow between steps. For each connection:
                    * \`from\`: The ID of the source step.
                    * \`to\`: The ID of the target step.
                    * \`label\`: The condition or transition (e.g., "Next", "Yes", "No", "Approved", "Rejected"), inferred from context.
                4.  **Identify Bottlenecks (2-3 bottlenecks):** Pinpoint specific steps or transitions that appear inefficient, slow, or problematic based *only* on the description. For each bottleneck:
                    * \`step_name\`: The name of the bottleneck step (or transition description like "Handover from Sales to Ops").
                    * \`reason\`: A detailed explanation *citing evidence from the context* why it's considered a bottleneck (e.g., "Context mentions manual data entry here", "Description implies waiting time", "Multiple approvals required as stated in text").
                5.  **Suggest Optimizations (2-3 suggestions):** For the identified bottlenecks or other inefficient steps described, propose specific improvements. For each optimization:
                    * \`target_step_name\`: The step the optimization applies to.
                    * \`suggestion\`: A clear description of the proposed change (e.g., "Automate data entry", "Implement parallel processing", "Simplify approval workflow").
                    * \`rationale\`: Explain *how* this optimization addresses the inefficiency *described in the context*.
                    * \`type\`: Categorize the optimization (e.g., "Automation", "Simplification", "Parallelization", "Standardization", "Resource Allocation").
                6.  **Recommend KPIs (4-5 KPIs):** Suggest relevant Key Performance Indicators to measure the process's efficiency and effectiveness, based on the context. For each KPI:
                    * \`name\`: Name of the KPI (e.g., "Cycle Time").
                    * \`description\`: What it measures specifically in relation to this process.

                7.  **Self-Correction:** Before outputting JSON, rigorously check: Is every piece of information (steps, owners, types, connections, bottlenecks, reasons, optimizations, KPIs) derived *solely* from the user's text? Are connections logical? Are bottleneck reasons and optimization rationales explicitly linked to the text? Is the JSON structure perfect? Fix all errors.

                **ABSOLUTE CONSTRAINTS:**
                - **CONTEXT GROUNDING:** All output MUST be based *exclusively* on the provided PROCESS DESCRIPTION. Do NOT invent steps, roles, bottlenecks, or optimizations not supported by the text.
                - **SPECIFICITY:** Be specific in descriptions, reasons, and rationales, referencing the context where possible.
                - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys and sub-keys.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
                {
                "process_name": "Example: Customer Order Fulfillment",
                "steps": [
                    {"id": 1, "name": "Receive Order", "description": "System receives order via web form.", "owner": "System/Sales", "type": "Start"},
                    {"id": 2, "name": "Check Inventory", "description": "Warehouse staff manually check stock levels.", "owner": "Warehouse", "type": "Task"},
                    {"id": 3, "name": "Stock Available?", "description": "Decision based on inventory check.", "owner": "Warehouse", "type": "Decision"},
                    {"id": 4, "name": "Allocate Stock", "description": "If available, reserve items.", "owner": "Warehouse", "type": "Task"},
                    {"id": 5, "name": "Notify Backorder", "description": "If unavailable, inform customer.", "owner": "Customer Service", "type": "Task"},
                    {"id": 6, "name": "Pack Order", "description": "Warehouse packs the allocated items.", "owner": "Warehouse", "type": "Task"},
                    {"id": 7, "name": "Ship Order", "description": "Logistics arranges shipment.", "owner": "Logistics", "type": "Task"},
                    {"id": 8, "name": "Send Confirmation", "description": "System sends shipping confirmation.", "owner": "System", "type": "Task"},
                    {"id": 9, "name": "Process Complete", "description": "Order fulfillment cycle ends.", "owner": "System", "type": "End"}
                ],
                "connections": [
                    {"from": 1, "to": 2, "label": "Next"},
                    {"from": 2, "to": 3, "label": "Next"},
                    {"from": 3, "to": 4, "label": "Yes"},
                    {"from": 3, "to": 5, "label": "No"},
                    {"from": 4, "to": 6, "label": "Next"},
                    {"from": 5, "to": 9, "label": "End Cycle"}, // Example connection
                    {"from": 6, "to": 7, "label": "Ready to Ship"},
                    {"from": 7, "to": 8, "label": "Shipped"},
                    {"from": 8, "to": 9, "label": "Confirmed"}
                ],
                "bottlenecks": [
                    {"step_name": "Check Inventory", "reason": "Context states 'Warehouse staff manually check stock levels', indicating a slow, error-prone step compared to automated checks."},
                    {"step_name": "Handover from Warehouse to Logistics", "reason": "The description implies a potential delay between packing ('Pack Order') and shipping ('Ship Order') without specifying a clear trigger or SLA, suggesting a possible bottleneck."}
                ],
                "optimizations": [
                    {
                    "target_step_name": "Check Inventory",
                    "suggestion": "Implement a real-time inventory management system.",
                    "rationale": "Replaces the slow 'manual check' mentioned in the context with an automated system, reducing errors and speeding up the decision at step 3 ('Stock Available?').",
                    "type": "Automation"
                    },
                    {
                    "target_step_name": "Pack Order / Ship Order Transition",
                    "suggestion": "Establish automated notification from Warehouse to Logistics upon packing completion.",
                    "rationale": "Addresses the implied delay between steps 6 and 7 by creating a clear trigger, potentially reducing wait time as suggested by the lack of explicit connection in the description.",
                    "type": "Process Improvement/Automation"
                    }
                ],
                "kpis": [
                    {"name": "Order Cycle Time", "description": "Total time from 'Receive Order' (Step 1) to 'Send Confirmation' (Step 8)."},
                    {"name": "Inventory Check Time", "description": "Time taken specifically for the 'Check Inventory' step (Step 2)."},
                    {"name": "Picking and Packing Time", "description": "Time taken for 'Allocate Stock' and 'Pack Order' (Steps 4 & 6)."},
                    {"name": "On-Time Shipment Rate", "description": "Percentage of orders shipped by the promised date."},
                    {"name": "Order Accuracy Rate", "description": "Percentage of orders shipped without errors (correct items, quantity)."}
                ]
                }
            `;

            // 3. Send Request to Ollama
            console.log(`Sending ENHANCED Process Mapping prompt to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
            });

            if (!response.ok) {
                let errorBody = `API error ${response.status}`;
                try { errorBody += `: ${await response.text()}`; } catch (e) {}
                throw new Error(errorBody);
            }

            const data = await response.json();
            let parsedData;
            console.log('Raw AI Response (Process Mapping):', data.response); // Log raw response
            try {
                parsedData = JSON.parse(data.response);
                // *** Refined Robust Validation ***
                console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Process Mapping) ---');
                console.log(JSON.stringify(parsedData, null, 2));
                console.log('------------------------------------');

                if (!parsedData || typeof parsedData !== 'object' ||
                    !parsedData.process_name || typeof parsedData.process_name !== 'string' ||
                    !Array.isArray(parsedData.steps) || parsedData.steps.length < 3 ||
                    !Array.isArray(parsedData.connections) || parsedData.connections.length < parsedData.steps.length - 1 || // At least n-1 connections usually
                    !Array.isArray(parsedData.bottlenecks) || // Can be empty, but must exist
                    !Array.isArray(parsedData.optimizations) || // Can be empty, but must exist
                    !Array.isArray(parsedData.kpis) || parsedData.kpis.length < 2 || // Expect at least a couple of KPIs
                    // Check structure of first elements if they exist
                    (parsedData.steps.length > 0 && (typeof parsedData.steps[0] !== 'object' || !parsedData.steps[0].hasOwnProperty('id') || !parsedData.steps[0].hasOwnProperty('name') || !parsedData.steps[0].hasOwnProperty('type'))) ||
                    (parsedData.connections.length > 0 && (typeof parsedData.connections[0] !== 'object' || !parsedData.connections[0].hasOwnProperty('from') || !parsedData.connections[0].hasOwnProperty('to'))) ||
                    (parsedData.bottlenecks.length > 0 && (typeof parsedData.bottlenecks[0] !== 'object' || !parsedData.bottlenecks[0].hasOwnProperty('step_name') || !parsedData.bottlenecks[0].hasOwnProperty('reason'))) ||
                    (parsedData.optimizations.length > 0 && (typeof parsedData.optimizations[0] !== 'object' || !parsedData.optimizations[0].hasOwnProperty('suggestion') || !parsedData.optimizations[0].hasOwnProperty('rationale'))) ||
                    (parsedData.kpis.length > 0 && (typeof parsedData.kpis[0] !== 'object' || !parsedData.kpis[0].hasOwnProperty('name') || !parsedData.kpis[0].hasOwnProperty('description')))
                    )
                {
                    console.error("Validation Failed (Enhanced Process Mapping): Required fields missing or invalid structure.", parsedData);
                    throw new Error(`AI response structure is incorrect or inconsistent (Enhanced Process Mapping). Check process_name, steps, connections, bottlenecks, optimizations, and kpis. See console logs.`);
                }
                console.log(`Successfully parsed ENHANCED Process Mapping JSON using ${MODEL_NAME}. Found ${parsedData.steps.length} steps.`);

            } catch (e) {
                console.error(`Failed to parse/validate ENHANCED Process Mapping JSON using ${MODEL_NAME}:`, data?.response, e);
                throw new Error(`Invalid JSON received or validation failed (Enhanced Process Mapping): ${e.message}. See raw response in console.`);
            }

            // 4. Render Results
            renderProcessMappingPage(analysisResultContainer, parsedData);

        } catch (error) {
            console.error(`Error in handleProcessMappingAnalysis (Enhanced) using ${MODEL_NAME}:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            // Ensure loading stops reliably
            if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
            }
        }
    }


    function renderProcessMappingPage(container, data) {
        container.innerHTML = ""; // Clear the loading indicator
        // Add validation for new fields
        if (!data || !data.process_name || !data.steps || !data.connections || !data.bottlenecks || !data.optimizations || !data.kpis) {
            console.error("Incomplete data passed to renderProcessMappingPage:", data);
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Process Map results.</div>`;
            $("analysisActions").classList.add("hidden");
            return;
        }

        const { process_name, steps, connections, bottlenecks, optimizations, kpis } = data;


        // --- Create Tab Navigation (Updated) ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="flowchart"> Process Flowchart</button>
            <button class="analysis-tab-btn" data-tab="details"> Step Details</button>
            <button class="analysis-tab-btn" data-tab="optimizations"> Optimizations</button>
            <button class="analysis-tab-btn" data-tab="kpis"> KPIs & Bottlenecks</button>
            <button class="analysis-tab-btn" data-tab="mermaid"> Mermaid Diagram</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Mapping</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels (Updated) ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="flowchartPanel" class="analysis-tab-panel active"></div>
            <div id="detailsPanel" class="analysis-tab-panel"></div>
            <div id="optimizationsPanel" class="analysis-tab-panel"></div>
            <div id="kpisPanel" class="analysis-tab-panel"></div>
            <div id="mermaidPanel" class="analysis-tab-panel">
                <!-- <h3 class="text-2xl font-bold mb-4">Mermaid Process Diagram</h3> -->
                <div id="diagram-container" class="mermaid"></div>
            </div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Flowchart Panel (Keep as is, but add better icons) ---
        const flowchartPanel = $("flowchartPanel");
        let flowchartHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-6 text-center">${process_name}</h3><div class="space-y-2 max-w-lg mx-auto">`; // Centered flowchart

        const stepMap = new Map(steps.map((step) => [step.id, step]));

        steps.forEach((step, index) => {
            let stepClass = "bg-black/20 p-3 rounded-lg border-l-4 flex items-center gap-3 ";
            let icon = ""; // Default
            switch (step.type.toLowerCase()) {
                case "start": stepClass += "border-green-400"; icon = ""; break;
                case "end": stepClass += "border-red-400"; icon = ""; break;
                case "decision": stepClass += "border-yellow-400"; icon = ""; break;
                case "sub-process": stepClass += "border-purple-400"; icon = ""; break; // Added sub-process
                default: stepClass += "border-blue-400"; icon = ""; // Task
            }
            flowchartHtml += `<div class="${stepClass}">
                                <span class="text-xl">${icon}</span>
                                <div>
                                    <p class="font-bold text-md">${step.name}</p>
                                    <p class="text-xs text-white/70">Owner: ${step.owner || 'N/A'}</p>
                                </div>
                            </div>`;

            // Add connection arrow and label if not the last step
            // Find connections originating FROM this step
            const outgoingConnections = connections.filter(c => c.from === step.id);
            if (outgoingConnections.length > 0) {
                if (outgoingConnections.length === 1) {
                    // Single outgoing path
                    const connection = outgoingConnections[0];
                    const label = connection.label || "Next";
                    flowchartHtml += `<div class="text-center text-white/50 text-2xl font-light leading-none my-1" aria-hidden="true"> <span class="text-xs font-sans align-middle">${label}</span></div>`;
                } else {
                    // Multiple outgoing paths (likely from a decision)
                    flowchartHtml += `<div class="text-center text-white/50 text-lg font-light leading-none my-1 flex justify-around items-center" aria-hidden="true">`;
                    outgoingConnections.forEach(conn => {
                        const targetStepName = stepMap.get(conn.to)?.name || `Step ${conn.to}`;
                        flowchartHtml += `<span class="text-xs font-sans"> ${conn.label || ''} (to ${targetStepName})</span>`;
                    });
                    flowchartHtml += `</div>`;
                }
            } else if (step.type.toLowerCase() !== 'end' && index < steps.length - 1) {
                // If no connection defined but not the end, assume 'Next'
                flowchartHtml += `<div class="text-center text-white/50 text-2xl font-light leading-none my-1" aria-hidden="true"> <span class="text-xs font-sans align-middle">Next</span></div>`;
            }

        });
        flowchartHtml += "</div></div>"; // Close space-y-2 and p-4
        flowchartPanel.innerHTML = flowchartHtml;

        // --- 2. Populate Step Details Panel (Keep table) ---
        const detailsPanel = $("detailsPanel");
        let detailsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Detailed Step Breakdown</h3><div class="overflow-x-auto"><table class="coeff-table styled-table text-sm">
            <thead><tr><th>ID</th><th>Step Name</th><th>Owner/Role</th><th>Type</th><th>Description</th></tr></thead><tbody>`;
        steps.forEach((step) => {
            detailsHtml += `<tr>
                <td>${step.id}</td>
                <td class="font-semibold">${step.name}</td>
                <td>${step.owner || 'N/A'}</td>
                <td>${step.type}</td>
                <td class="text-white/80">${step.description}</td></tr>`;
        });
        detailsHtml += `</tbody></table></div></div>`;
        detailsPanel.innerHTML = detailsHtml;

        // --- 3. Populate Optimizations Panel (New) ---
        const optimizationsPanel = $("optimizationsPanel");
        let optimizationsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Potential Optimizations</h3>`;
        if (optimizations && optimizations.length > 0) {
            optimizationsHtml += `<p class="text-sm text-white/70 mb-6 italic">Based on the process description, consider these improvements, particularly for identified bottlenecks.</p>`;
            optimizationsHtml += `<div class="space-y-6">`;
            optimizations.forEach((opt, index) => {
                optimizationsHtml += `
                    <div class="prescription-card border-l-4 border-green-500">
                        <h4 class="text-xl font-bold">${index + 1}. ${opt.suggestion}</h4>
                        <p class="text-xs font-semibold my-1 text-indigo-300">TARGET STEP: ${opt.target_step_name || 'N/A'} | TYPE: ${opt.type || 'N/A'}</p>
                        <p class="rationale"><strong>Rationale:</strong> ${opt.rationale || 'N/A'}</p>
                    </div>`;
            });
            optimizationsHtml += `</div>`;
        } else {
            optimizationsHtml += `<p class="text-center text-white/70 italic">No specific optimization opportunities were clearly identified from the provided process description.</p>`;
        }
        optimizationsHtml += `</div>`;
        optimizationsPanel.innerHTML = optimizationsHtml;

        // --- 4. Populate KPIs & Bottlenecks Panel (New/Combined) ---
        const kpisPanel = $("kpisPanel");
        let kpisHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> KPIs & Bottlenecks</h3>`;
        // Bottlenecks first
        if (bottlenecks && bottlenecks.length > 0) {
            kpisHtml += `<h4 class="text-xl font-semibold mb-3 text-red-300"> Identified Potential Bottlenecks</h4><div class="space-y-3 mb-8">`;
            bottlenecks.forEach((b) => {
                kpisHtml += `<div class="metric-card border-l-4 border-red-400">
                                <p class="font-bold">${b.step_name}</p>
                                <p class="text-sm text-white/80 italic">${b.reason}</p>
                            </div>`;
            });
            kpisHtml += `</div>`;
        } else {
            kpisHtml += `<p class="text-center text-white/70 italic mb-8">No clear bottlenecks were identified from the provided description.</p>`;
        }
        // Then KPIs
        if (kpis && kpis.length > 0) {
            kpisHtml += `<h4 class="text-xl font-semibold mb-3 text-green-300"> Recommended KPIs</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            kpis.forEach((k) => {
                kpisHtml += `<div class="summary-stat-card text-left p-4 border-l-4 border-green-400">
                                <p class="font-bold text-lg text-white">${k.name}</p>
                                <p class="text-sm text-white/80">${k.description}</p>
                            </div>`;
            });
            kpisHtml += `</div>`;
        } else {
            kpisHtml += `<p class="text-center text-white/70 italic">No specific KPIs were recommended based on the description.</p>`;
        }
        kpisHtml += `</div>`; // Close p-4
        kpisPanel.innerHTML = kpisHtml;


        // --- Populate Mermaid Panel and Render Diagram ---
        const mermaidPanel = $("mermaidPanel");
        if (mermaidPanel) {
            const mermaidCode = generateProcessMappingMermaidCode(data); // Generate Mermaid code
            const diagramContainer = mermaidPanel.querySelector("#diagram-container");

            if (diagramContainer) { // Store mermaidCode and container for deferred rendering
                diagramContainer.dataset.mermaidCode = mermaidCode; // Store code in a data attribute
                diagramContainer.innerHTML = `<pre class="mermaid">${mermaidCode}</pre>`; // Display code for debugging/inspection
                // window.renderMermaidDiagram(diagramContainer, mermaidCode);
            }
        }


        // --- 5. Populate Learn Mapping Panel (New) ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
        <div class="p-6 space-y-6 text-white/90">
            <h3 class="text-2xl font-bold text-center mb-4"> Understanding Process Mapping</h3>
            [Image of a business process map]
            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-lg font-bold mb-2 text-indigo-300">What is Process Mapping?</h4>
                <p class="text-sm text-white/80">Process mapping is a technique used to visually represent the sequence of steps, decisions, and handoffs involved in a specific work process from beginning to end. It helps teams understand, analyze, and improve workflows.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2">Common Symbols (Simplified):</h4>
                    <ul class="space-y-2 text-sm">
                        <li><span class="font-mono text-xl mr-2"></span> <strong>Start/End:</strong> Oval shapes indicating the beginning or end points.</li>
                        <li><span class="font-mono text-xl mr-2"></span> <strong>Task/Activity:</strong> Rectangles representing a specific action or step.</li>
                        <li><span class="font-mono text-xl mr-2"></span> <strong>Decision:</strong> Diamonds indicating a point where a choice is made (usually with Yes/No branches).</li>
                        <li><span class="font-mono text-xl mr-2"></span> <strong>Sub-process:</strong> Rectangle with double vertical lines, representing a predefined, separate process.</li>
                        <li><span class="font-mono text-xl mr-2"></span> <strong>Flow Lines:</strong> Arrows showing the direction and sequence of steps.</li>
                        <li><span class="font-mono text-xl mr-2"></span> <strong>Document/Data:</strong> Often represented by a rectangle with a wavy bottom.</li>
                    </ul>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2">Why Map Processes?</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Clarity & Understanding:</strong> Provides a clear visual representation of how work gets done.</li>
                        <li><strong>Identify Inefficiencies:</strong> Highlights bottlenecks, redundancies, delays, and unnecessary steps.</li>
                        <li><strong>Improvement Foundation:</strong> Serves as a baseline for optimization efforts (simplification, automation).</li>
                        <li><strong>Standardization:</strong> Helps define and communicate standard operating procedures.</li>
                        <li><strong>Training:</strong> Useful tool for onboarding new team members.</li>
                        <li><strong>Role Clarity:</strong> Shows who is responsible for each step.</li>
                    </ul>
                </div>
            </div>

            <details class="styled-details text-sm mt-4">
                <summary class="font-semibold">Tips for Effective Process Mapping</summary>
                <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                    <p><strong>1. Define Scope Clearly:</strong> Know where the process starts and ends.</p>
                    <p><strong>2. Involve the Right People:</strong> Include those who actually perform the work.</p>
                    <p><strong>3. Observe the Real Process:</strong> Don't just rely on documented procedures; see how it actually happens.</p>
                    <p><strong>4. Keep it Simple Initially:</strong> Start with a high-level map, then add detail as needed.</p>
                    <p><strong>5. Use Consistent Symbols:</strong> Stick to a standard set of shapes for clarity.</p>
                    <p><strong>6. Focus on Flow, Not Just Steps:</strong> Show handoffs, decisions, and potential loops.</p>
                    <p><strong>7. Validate the Map:</strong> Review with stakeholders to ensure accuracy.</p>
                    <p><strong>8. Use it for Action:</strong> The map is a tool for analysis and improvement, not just documentation.</p>
                </div>
            </details>
        </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                // Deactivate all
                tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

                // Activate clicked
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add("active");
                    // No Plotly charts expected in this version, so no resize needed
                } else {
                    console.warn("Target panel not found:", targetPanelId);
                }

                // If the Mermaid tab is activated, render the diagram
                if (e.target.dataset.tab === "mermaid") {
                    const mermaidContainer = targetPanel.querySelector("#diagram-container");
                    if (mermaidContainer && mermaidContainer.dataset.mermaidCode) {
                        // Clear previous content and render
                        mermaidContainer.innerHTML = ``; // Clear raw code or placeholder
                        renderMermaidDiagram(mermaidContainer, mermaidContainer.dataset.mermaidCode);
                    }
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        // setLoading('generate', false); // Handled in the calling function
    }


    /**
         * Generates Mermaid flowchart code from process mapping data.
         * @param {object} data - The process mapping data containing steps and connections.
         * @returns {string} Mermaid flowchart code.
         */
    function generateProcessMappingMermaidCode(processData) {
        const { process_name, steps, connections } = processData;
        if (!steps || !connections) {
            return "graph LR\n    A[Error: Incomplete data for Mermaid diagram]";
        }

        let mermaidCode = `graph LR\n`; // Start with graph declaration
        mermaidCode += `%% Process: ${processData.process_name}\n`;
        let roleIdCounter = 0;
        const roleNameToMermaidId = new Map();
        // const roleTaskCounters = new Map(); // Maps role letter to its next task number (e.g., "A" -> 1)
        let taskIdCounter = 0;
        const stepIdToMermaidId = new Map(); // Maps original step.id to generated Mermaid Task_ID (e.g., 1 -> "A1")
        const processedSteps = []; // Temporary structure to hold steps with their generated IDs and role letters
        const stepsByRole = new Map();  // Group processed steps by roleLetter
        
        // First Pass: Assign unique alphanumeric IDs to roles
        processData.steps.forEach(step => {
            if (step.owner && !roleNameToMermaidId.has(step.owner)) {
                roleNameToMermaidId.set(step.owner, generateAlphaNumericId(roleIdCounter++));
            }
        });

        // Second Pass: Generate Task IDs and populate processedSteps.
        processData.steps.forEach(step => {
            const mermaidId = generateAlphaNumericId(taskIdCounter++); // Global task ID counter
            stepIdToMermaidId.set(step.id, mermaidId);
            processedSteps.push({ ...step, mermaidId, roleLetter: roleNameToMermaidId.get(step.owner) });
        });

        // Group processed steps by roleLetter
        processedSteps.forEach(step => {
            const role = step.owner;
            if (role) {
                if (!stepsByRole.has(role)) {
                    stepsByRole.set(role, []);
                }
                stepsByRole.get(role).push(step);
            }
        });

        // Generate subgraphs for roles.
        roleNameToMermaidId.forEach((mermaidRoleLetter, roleName) => {
            mermaidCode += `    subgraph Role_${mermaidRoleLetter}[\"${roleName}\"]\n`;
            // Filter processedSteps by owner
            const roleSteps = processedSteps.filter(step => step.owner === roleName) || [];

            let hasStartInRole = false;
            let hasEndInRole = false;

            // Check for Start/End nodes within this role
            roleSteps.forEach(step => {
                if (step.type.toLowerCase() === "start") {
                    hasStartInRole = true;
                }
                if (step.type.toLowerCase() === "end") {
                    hasEndInRole = true;
                }
            });

            if (hasStartInRole) {
                mermaidCode += `        Start(("Start"))\n`;
            }
            if (hasEndInRole) {
                mermaidCode += `        End(("End"))\n`;
            }

            roleSteps.forEach(step => {
                let nodeShape;
                switch (step.type.toLowerCase()) {
                    case "start":
                        nodeShape = `(("${step.name}"))`; // Use double parentheses for start/end tasks
                        break;
                    case "end":
                        nodeShape = `((${step.name}))`; // Use double parentheses for start/end tasks
                        break;
                    case "task":
                        nodeShape = `[\"${step.id}. ${step.name}\"]`;
                        break;
                    case "decision":
                        nodeShape = `{\"${step.id}. ${step.name}\"}`;
                        break;
                    default:
                        nodeShape = `[\"${step.id}. ${step.name}\"]`;
                }
                mermaidCode += `        ${step.mermaidId}${nodeShape}\n`;
            });
            mermaidCode += `    end\n`;
        });
        
        // Generate connections.
        mermaidCode += `%% Flow Connections\n`;
        processData.connections.forEach(conn => {
            const fromMermaidId = stepIdToMermaidId.get(conn.from);
            const toMermaidId = stepIdToMermaidId.get(conn.to);
            if (fromMermaidId && toMermaidId) {
                mermaidCode += `    ${fromMermaidId} --\"${conn.label}\"--> ${toMermaidId}\n`;
            }
        });

        // Handle implicit Start/End connections
        const actualStartTask = processedSteps.find(step => step.type.toLowerCase() === "start");
        const actualEndTask = processedSteps.find(step => step.type.toLowerCase() === "end");

        if (actualStartTask) {
            mermaidCode += `    Start --> ${actualStartTask.mermaidId}\n`;
        }

        if (actualEndTask) {
            mermaidCode += `    ${actualEndTask.mermaidId} --> End\n`;
        }

        return mermaidCode;
    }

    function generateAlphaNumericId(index) {
        let letterIndex = index % 26; // 0-25 for A-Z
        let numberSuffix = Math.floor(index / 26) + 1; // 1 for A-Z, 2 for A-Z again, etc.
        return `${String.fromCharCode(65 + letterIndex)}${numberSuffix}`;
    }



/**
 * Handles the submission of the SEM analysis request to the backend.
 * Sends data (file or text) and separate measurement/structural syntax.
 */
async function handleSemAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><h3 class="text-xl font-semibold text-white">Running Structural Equation Model...</h3><p class="text-white/80 mb-2">Please wait while the model is estimated.</p></div>`;
    setLoading("generate", true);

    try {
        const formData = new FormData();
        formData.append("analysis_type", "sem");

        let measurementSyntax, structuralSyntax;

        // --- CHECK: SAMPLE MODE VS MANUAL MODE ---
        if (window.isSampleModeActive === true && window.tempSampleDataFile) {
            console.log(" SEM Sample mode active - using global temp file");

            // 1. Use the file already loaded in the global variable
            formData.append("data_file", window.tempSampleDataFile, window.tempSampleDataFile.name);

            // 2. Set Hardcoded Syntax for the Sample
            // (We do this because the text areas might be empty if the user didn't click anything else)
            measurementSyntax = `Marketing_Performance =~ Ad_Spend_USD + Brand_Awareness_Pct
                                Sales_Performance =~ Online_Sales_USD + Retail_Sales_USD + Total_Sales_USD
                                Customer_Metrics =~ New_Customers_Count + Sales_Per_Customer`;

            structuralSyntax = `Sales_Performance ~ Marketing_Performance
                                Customer_Metrics ~ Marketing_Performance + Sales_Performance
                                Profit_USD ~ Sales_Performance + Customer_Metrics`;

        } else {
            // --- MANUAL MODE ---
            console.log(" SEM Manual mode - reading from UI");

            // 1. Get Syntax from UI
            measurementSyntax = $("semMeasurementSyntax").value.trim();
            structuralSyntax = $("semStructuralSyntax").value.trim();

            // 2. Get Data from UI
            const isUsingFile = $("semInputFileToggle").checked;

            if (isUsingFile) {
                const dataFile = $("semFile").files[0];
                if (!dataFile) {
                    throw new Error("Please upload a data file (.csv or .xlsx).");
                }
                formData.append("data_file", dataFile, dataFile.name);
            } else {
                const dataText = $("semDataText").value.trim();
                if (!dataText) {
                    throw new Error("Please paste your CSV data into the text area.");
                }
                formData.append("data_text", dataText);
            }
        }

        // Validate syntax (Applies to both modes)
        if (!measurementSyntax && !structuralSyntax) {
            throw new Error("Please provide Measurement Model Syntax and/or Structural Model Syntax.");
        }

        console.log(" Final SEM syntax - Measurement:", measurementSyntax);
        console.log(" Final SEM syntax - Structural:", structuralSyntax);

        formData.append("measurement_syntax", measurementSyntax);
        formData.append("structural_syntax", structuralSyntax);

        // --- 4. Send Request to Backend API ---
        const API_URL = "https://analysis.sageaios.com/api/sem";
        console.log(" Sending SEM request to backend...");

        const response = await fetch(API_URL, {
            method: "POST",
            body: formData,
        });

        // --- 5. Handle Backend Response ---
        if (!response.ok) {
            let errorDetail = `API request failed (${response.status})`;
            try {
                const errorJson = await response.json();
                errorDetail = errorJson.detail || `API Error: ${response.status}`;
            } catch (e) {
                errorDetail = `API Error: ${response.status} - ${response.statusText}`;
            }
            throw new Error(errorDetail);
        }

        const parsedData = await response.json();
        console.log(" Received SEM response from backend");

        renderSemAnalysisPage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error("Error during SEM analysis:", error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"><strong>Error:</strong> ${error.message}</div>`;
    } finally {
        window.isSampleModeActive = false; // Reset the flag
        setLoading("generate", false);
    }
}

   /**
 * Handles the Predictive Analysis request.
 * Gathers data and parameters (using the assumed first column as the date column),
 * sends them to the backend API, and calls the rendering function upon receiving results.
 */
async function handlePredictiveAnalysis() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div></div><div></div><div></div></div><h3 class="text-xl font-semibold text-white">Running Predictive Analysis...</h3><p class="text-white/80 mb-2">Please wait while the forecast is generated.</p></div>`;
        setLoading("generate", true);
        $("analysisActions").classList.add("hidden");

        try {
            const formData = new FormData();
            formData.append("analysis_type", "predictive");

            // Get parameters from UI (these are set by the sample button)
            const dateColumn = $("assumedDateColName").textContent;
            const targetColumn = $("predictiveTargetColumn").value;
            const forecastPeriods = $("predictiveForecastPeriods").value;
            const confidenceLevel = $("predictiveConfidenceLevel").value;
            const modelType = $("predictiveModelType").value;

            if (window.isSampleModeActive === true && window.tempSampleDataFile) {
                console.log("Using Global Sample Data for Predictive");
                formData.append("data_file", window.tempSampleDataFile, window.tempSampleDataFile.name);
            } else {
                // --- MANUAL MODE ---
                const dataFile = $("predictiveFile").files[0];
                const dataText = $("predictiveDataText").value.trim();
                const isUsingFile = $("predictiveInputFileToggle").checked;

                if (isUsingFile) {
                    if (!dataFile) { throw new Error("Please upload a data file (.csv or .xlsx)."); }
                    formData.append("data_file", dataFile, dataFile.name);
                } else {
                    if (!dataText) { throw new Error("Please paste your CSV data into the text area."); }
                    formData.append("data_text", dataText);
                }
            }

            // --- Validate UI-driven parameters ---
            if (!dateColumn || dateColumn === "..." || dateColumn === "N/A" || dateColumn === "Error") {
                throw new Error("Could not determine the Date Column. Please ensure data is loaded correctly.");
            }
            if (!targetColumn) {
                throw new Error("Please select the Target Variable column.");
            }
            if (dateColumn === targetColumn) {
                 throw new Error("Date Column and Target Variable must be different.");
            }

            // Append parameters
            formData.append("dateColumn", dateColumn);
            formData.append("targetColumn", targetColumn);
            formData.append("forecastPeriods", forecastPeriods);
            formData.append("confidenceLevel", confidenceLevel);
            formData.append("modelType", modelType);

            // --- 4. Send Request to Backend API ---
            const API_URL = "https://analysis.sageaios.com/api/predictive";
            const response = await fetch(API_URL, {
                method: "POST",
                body: formData,
            });

            // --- 5. Handle Backend Response ---
            if (!response.ok) {
                let errorDetail = `API request failed (${response.status} ${response.statusText})`;
                try {
                    const errorJson = await response.json();
                    errorDetail += `: ${errorJson.detail || JSON.stringify(errorJson)}`;
                } catch (e) { try { errorDetail += `: ${await response.text()}`; } catch(readErr) {} }
                throw new Error(errorDetail);
            }

            const parsedData = await response.json();
            renderPredictiveAnalysisPage($("analysisResult"), parsedData);

        } catch (error) {
            console.error("Error during Predictive Analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"><strong>Error:</strong> ${error.message}</div>`;
        } finally {
            window.isSampleModeActive = false; // Reset the flag
            setLoading("generate", false);
        }
    }

/**
 * Complete Enhanced renderPredictiveAnalysisPage function 
 * Includes all 6 tabs with enhanced chart rendering and model differentiation
 */
function renderPredictiveAnalysisPage(container, data) {
    container.innerHTML = ""; // Clear loading state

    // --- Enhanced Data Validation ---
    if (!data || typeof data !== 'object' || !data.predictions || !data.data_summary || !data.model_performance || !data.insights ||
        !Array.isArray(data.predictions) || typeof data.data_summary !== 'object' ||
        typeof data.model_performance !== 'object' || !Array.isArray(data.insights))
    {
        console.error("Incomplete or invalid data received for rendering:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete or invalid analysis data received from the backend. Cannot render results.</div>`;
        $("analysisActions").classList.add("hidden");
        setLoading("generate", false);
        return;
    }
    
    const { predictions, data_summary, model_performance, insights, business_context, historical_data } = data;

    // --- Create Tab Navigation ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="overview"> Overview</button>
        <button class="analysis-tab-btn" data-tab="charts"> Charts</button>
        <button class="analysis-tab-btn" data-tab="details"> Details</button>
        <button class="analysis-tab-btn" data-tab="insights"> Insights</button>
        <button class="analysis-tab-btn" data-tab="diagnostics"> Diagnostics</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Predictive</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="predictiveOverviewPanel" class="analysis-tab-panel active"></div>
        <div id="predictiveChartsPanel" class="analysis-tab-panel"></div>
        <div id="predictiveDetailsPanel" class="analysis-tab-panel"></div>
        <div id="predictiveInsightsPanel" class="analysis-tab-panel"></div>
        <div id="predictiveDiagnosticsPanel" class="analysis-tab-panel"></div>
        <div id="predictiveLearnPanel" class="analysis-tab-panel"></div>
    `;

    // --- Helper Functions ---
    const formatMetric = (value, decimals = 1, suffix = '') => {
        if (value === null || value === undefined || isNaN(value)) return 'N/A';
        return `${value.toFixed(decimals)}${suffix}`;
    };

    const calculateEnhancedForecastReliability = (r2, mape, dataPoints, horizon) => {
        let score = 0;
        
        if (r2 > 0.8) score += 40;
        else if (r2 > 0.6) score += 30;
        else if (r2 > 0.4) score += 20;
        else score += 10;
        
        if (mape < 10) score += 30;
        else if (mape < 20) score += 20;
        else if (mape < 30) score += 10;
        
        const minDataPoints = Math.max(horizon * 2, 24);
        if (dataPoints >= minDataPoints) score += 20;
        else if (dataPoints >= horizon) score += 15;
        else score += 5;
        
        if (horizon <= 6) score += 10;
        else if (horizon <= 12) score += 7;
        else score += 3;
        
        return {
            score: score,
            level: score >= 80 ? 'High' : score >= 60 ? 'Medium' : 'Low',
            class: score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400',
            description: score >= 80 ? 'Strong confidence in predictions' : 
                        score >= 60 ? 'Reasonable confidence with caution' : 
                        'Limited confidence, use with caution'
        };
    };

    // --- Diagnostics Panel Function ---
    const renderPredictiveDiagnosticsPanel = (diagnosticsPanel, data) => {
        const { model_performance, business_context, data_info, predictions } = data;
        
        // Calculate diagnostic metrics
        const dataPoints = data_info?.total_points || predictions.length * 2;
        const forecastHorizon = predictions.length || 12;
        const r2 = model_performance?.r_squared || 0;
        const mape = model_performance?.mape || 100;
        const riskLevel = business_context?.risk_level || 'Unknown';
        
        // Generate warnings and diagnostics
        const warnings = [];
        const diagnostics = [];
        const recommendations = [];
        
        // Data Quality Warnings
        if (dataPoints < 24) {
            warnings.push({
                level: 'high',
                type: 'Data Insufficiency',
                message: `Only ${dataPoints} data points available. Minimum 24 recommended for reliable analysis.`,
                impact: 'Low confidence in seasonal patterns and model validation.'
            });
        } else if (dataPoints < 36) {
            warnings.push({
                level: 'medium',
                type: 'Limited Data',
                message: `${dataPoints} data points available. 36+ recommended for optimal analysis.`,
                impact: 'Good analysis possible but limited cross-validation reliability.'
            });
        }
        
        // Model Performance Warnings
        if (r2 < 0.3) {
            warnings.push({
                level: 'high',
                type: 'Poor Model Fit',
                message: `R-squared of ${(r2 * 100).toFixed(1)}% indicates weak model performance.`,
                impact: 'Predictions may not reflect actual patterns in your data.'
            });
        } else if (r2 < 0.5) {
            warnings.push({
                level: 'medium',
                type: 'Moderate Model Fit',
                message: `R-squared of ${(r2 * 100).toFixed(1)}% suggests room for improvement.`,
                impact: 'Use predictions with caution for strategic decisions.'
            });
        }
        
        if (mape > 30) {
            warnings.push({
                level: 'high',
                type: 'High Prediction Error',
                message: `MAPE of ${mape.toFixed(1)}% indicates significant prediction errors.`,
                impact: 'Consider this forecast as directional guidance only.'
            });
        } else if (mape > 15) {
            warnings.push({
                level: 'medium',
                type: 'Moderate Prediction Error',
                message: `MAPE of ${mape.toFixed(1)}% suggests moderate prediction accuracy.`,
                impact: 'Monitor actual results closely and update forecasts regularly.'
            });
        }
        
        // Forecast Horizon Warnings
        if (forecastHorizon > dataPoints / 2) {
            warnings.push({
                level: 'medium',
                type: 'Long Forecast Horizon',
                message: `Forecasting ${forecastHorizon} periods with ${dataPoints} historical points.`,
                impact: 'Confidence decreases significantly for later periods.'
            });
        }
        
        // Risk Assessment Warnings
        if (riskLevel === 'High') {
            warnings.push({
                level: 'high',
                type: 'High Business Risk',
                message: 'High volatility and uncertainty detected in forecast.',
                impact: 'Consider scenario planning and frequent forecast updates.'
            });
        }
        
        // Generate Diagnostics
        diagnostics.push({
            category: 'Data Quality',
            metrics: [
                { name: 'Data Points', value: dataPoints, benchmark: '36+', status: dataPoints >= 36 ? 'good' : dataPoints >= 24 ? 'fair' : 'poor' },
                { name: 'Data Range', value: `${data_info?.date_range_days || 'Unknown'} days`, benchmark: '730+ days', status: (data_info?.date_range_days || 0) >= 730 ? 'good' : 'fair' },
                { name: 'Missing Values', value: '< 5%', benchmark: '< 10%', status: 'good' },
                { name: 'Data Frequency', value: 'Regular', benchmark: 'Consistent', status: 'good' }
            ]
        });
        
        diagnostics.push({
            category: 'Model Performance',
            metrics: [
                { name: 'R-Squared', value: `${(r2 * 100).toFixed(1)}%`, benchmark: '70%+', status: r2 >= 0.7 ? 'good' : r2 >= 0.5 ? 'fair' : 'poor' },
                { name: 'MAPE', value: `${mape.toFixed(1)}%`, benchmark: '< 15%', status: mape <= 15 ? 'good' : mape <= 30 ? 'fair' : 'poor' },
                { name: 'Cross-Validation', value: `${model_performance?.validation_folds || 0} folds`, benchmark: '5+ folds', status: (model_performance?.validation_folds || 0) >= 5 ? 'good' : 'fair' },
                { name: 'Model Selection', value: model_performance?.model_used || 'Unknown', benchmark: 'Auto-Selected', status: 'good' }
            ]
        });
        
        diagnostics.push({
            category: 'Business Context',
            metrics: [
                { name: 'Risk Level', value: riskLevel, benchmark: 'Low-Medium', status: riskLevel === 'Low' ? 'good' : riskLevel === 'Medium' ? 'fair' : 'poor' },
                { name: 'Volatility', value: `${(business_context?.predicted_volatility || 0).toFixed(1)}%`, benchmark: '< 25%', status: (business_context?.predicted_volatility || 0) < 25 ? 'good' : 'fair' },
                { name: 'Trend Stability', value: business_context?.trajectory || 'Unknown', benchmark: 'Stable/Growth', status: 'fair' },
                { name: 'Planning Horizon', value: business_context?.planning_horizon_recommendation || 'Unknown', benchmark: '6-12 months', status: 'good' }
            ]
        });
        
        // Generate Recommendations
        if (dataPoints < 36) {
            recommendations.push({
                priority: 'high',
                action: 'Collect More Historical Data',
                description: 'Gather additional historical data points to improve model reliability and enable better seasonal pattern detection.',
                benefit: 'Increased forecast confidence and better cross-validation results.'
            });
        }
        
        if (mape > 20) {
            recommendations.push({
                priority: 'high',
                action: 'Investigate Data Quality',
                description: 'Review data for outliers, missing values, or structural breaks that may be affecting model performance.',
                benefit: 'Improved prediction accuracy and model reliability.'
            });
        }
        
        if (riskLevel === 'High') {
            recommendations.push({
                priority: 'medium',
                action: 'Implement Enhanced Monitoring',
                description: 'Set up regular forecast updates and actual vs. predicted tracking to quickly identify deviations.',
                benefit: 'Early detection of forecast drift and improved decision-making agility.'
            });
        }
        
        recommendations.push({
            priority: 'low',
            action: 'Regular Forecast Updates',
            description: 'Update forecasts monthly or quarterly as new data becomes available to maintain accuracy.',
            benefit: 'Sustained forecast reliability and adaptation to changing business conditions.'
        });
        
        diagnosticsPanel.innerHTML = `
            <div class="p-6 space-y-8 text-white/90 max-w-6xl mx-auto">
                <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-red-400 to-orange-400 bg-clip-text text-transparent">
                     Warnings & Diagnostics
                </h3>
                
                <!-- Warnings Section -->
                <div class="space-y-4">
                    <h4 class="text-xl font-bold text-red-300 mb-4"> Warnings & Alerts</h4>
                    ${warnings.length > 0 ? warnings.map(warning => `
                        <div class="p-4 rounded-lg border-l-4 ${
                            warning.level === 'high' ? 'bg-red-900/20 border-red-500' : 
                            warning.level === 'medium' ? 'bg-yellow-900/20 border-yellow-500' : 
                            'bg-blue-900/20 border-blue-500'
                        }">
                            <div class="flex items-start space-x-3">
                                <div class="text-2xl">${warning.level === 'high' ? '' : warning.level === 'medium' ? '' : ''}</div>
                                <div class="flex-1">
                                    <h5 class="font-semibold text-lg ${
                                        warning.level === 'high' ? 'text-red-300' : 
                                        warning.level === 'medium' ? 'text-yellow-300' : 
                                        'text-blue-300'
                                    }">${warning.type}</h5>
                                    <p class="text-white/90 mt-1">${warning.message}</p>
                                    <p class="text-white/70 text-sm mt-2"><strong>Impact:</strong> ${warning.impact}</p>
                                </div>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="p-4 bg-green-900/20 border border-green-500/30 rounded-lg text-center">
                            <div class="text-2xl mb-2"></div>
                            <p class="text-green-300 font-semibold">No Critical Warnings Detected</p>
                            <p class="text-white/70 text-sm mt-1">Your analysis appears to be within acceptable parameters.</p>
                        </div>
                    `}
                </div>
                
                <!-- Diagnostics Section -->
                <div class="space-y-6">
                    <h4 class="text-xl font-bold text-blue-300 mb-4"> Detailed Diagnostics</h4>
                    ${diagnostics.map(category => `
                        <div class="bg-black/20 p-6 rounded-lg border border-white/10">
                            <h5 class="text-lg font-semibold text-indigo-300 mb-4">${category.category}</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${category.metrics.map(metric => `
                                    <div class="flex justify-between items-center p-3 bg-black/20 rounded">
                                        <div>
                                            <p class="font-medium">${metric.name}</p>
                                            <p class="text-xs text-white/60">Target: ${metric.benchmark}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold">${metric.value}</p>
                                            <span class="text-xs px-2 py-1 rounded ${
                                                metric.status === 'good' ? 'bg-green-600/20 text-green-300' :
                                                metric.status === 'fair' ? 'bg-yellow-600/20 text-yellow-300' :
                                                'bg-red-600/20 text-red-300'
                                            }">
                                                ${metric.status === 'good' ? ' Good' : metric.status === 'fair' ? ' Fair' : ' Poor'}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Recommendations Section -->
                <div class="space-y-4">
                    <h4 class="text-xl font-bold text-green-300 mb-4"> Improvement Recommendations</h4>
                    <div class="space-y-3">
                        ${recommendations.map((rec, index) => `
                            <div class="p-4 bg-black/20 rounded-lg border border-white/10">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                        rec.priority === 'high' ? 'bg-red-600 text-white' :
                                        rec.priority === 'medium' ? 'bg-yellow-600 text-white' :
                                        'bg-blue-600 text-white'
                                    }">${index + 1}</div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <h5 class="font-semibold">${rec.action}</h5>
                                            <span class="text-xs px-2 py-1 rounded ${
                                                rec.priority === 'high' ? 'bg-red-600/20 text-red-300' :
                                                rec.priority === 'medium' ? 'bg-yellow-600/20 text-yellow-300' :
                                                'bg-blue-600/20 text-blue-300'
                                            }">
                                                ${rec.priority.toUpperCase()} PRIORITY
                                            </span>
                                        </div>
                                        <p class="text-white/80 text-sm mb-2">${rec.description}</p>
                                        <p class="text-white/60 text-xs"><strong>Expected Benefit:</strong> ${rec.benefit}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Model Health Summary -->
                <div class="bg-gradient-to-r from-purple-900/30 to-indigo-900/30 p-6 rounded-lg border border-purple-500/20">
                    <h4 class="text-lg font-bold text-purple-300 mb-4"> Overall Model Health</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold ${r2 >= 0.7 ? 'text-green-400' : r2 >= 0.5 ? 'text-yellow-400' : 'text-red-400'}">
                                ${r2 >= 0.7 ? 'Excellent' : r2 >= 0.5 ? 'Good' : 'Poor'}
                            </div>
                            <p class="text-xs text-white/70">Model Fit Quality</p>
                        </div>
                        <div>
                            <div class="text-2xl font-bold ${dataPoints >= 36 ? 'text-green-400' : dataPoints >= 24 ? 'text-yellow-400' : 'text-red-400'}">
                                ${dataPoints >= 36 ? 'Sufficient' : dataPoints >= 24 ? 'Adequate' : 'Limited'}
                            </div>
                            <p class="text-xs text-white/70">Data Sufficiency</p>
                        </div>
                        <div>
                            <div class="text-2xl font-bold ${warnings.filter(w => w.level === 'high').length === 0 ? 'text-green-400' : 'text-red-400'}">
                                ${warnings.filter(w => w.level === 'high').length === 0 ? 'Stable' : 'Caution'}
                            </div>
                            <p class="text-xs text-white/70">Forecast Reliability</p>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="text-center p-4 bg-black/20 rounded-lg border border-white/10">
                    <p class="text-xs text-white/60">
                        Regular diagnostics help ensure forecast quality and reliability. Address high-priority recommendations first for maximum impact.
                    </p>
                </div>
            </div>
        `;
    };

    // --- Learn Panel Function ---
    const renderPredictiveLearnPanel = (learnPanel, data) => {
        learnPanel.innerHTML = `
            <div class="p-6 space-y-8 text-white/90 max-w-5xl mx-auto">
                <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                     Learn Predictive Analysis
                </h3>
                
                <!-- Main Definition -->
                <div class="bg-gradient-to-r from-purple-900/40 to-blue-900/40 p-6 rounded-lg border border-purple-500/30">
                    <h4 class="text-xl font-bold mb-3 text-purple-300">What is Predictive Analysis?</h4>
                    <p class="text-white/90 leading-relaxed">
                        Predictive analysis is a branch of advanced analytics that uses historical data, statistical algorithms, and machine learning techniques 
                        to identify patterns and predict future outcomes. Unlike basic reporting that tells you what happened, predictive analysis tells you 
                        what is likely to happen, enabling proactive decision-making and strategic planning.
                    </p>
                </div>
                
                <!-- Core Concepts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white/5 p-6 rounded-lg border border-white/10">
                        <h4 class="text-lg font-bold mb-4 text-green-300"> Core Components</h4>
                        <ul class="space-y-3 text-sm">
                            <li class="flex items-start space-x-2">
                                <span class="text-green-400 mt-0.5"></span>
                                <div>
                                    <strong>Time-Series Analysis:</strong> Examines data points collected over time to identify trends, patterns, and seasonality
                                </div>
                            </li>
                            <li class="flex items-start space-x-2">
                                <span class="text-green-400 mt-0.5"></span>
                                <div>
                                    <strong>Statistical Modeling:</strong> Uses mathematical models to understand relationships between variables
                                </div>
                            </li>
                            <li class="flex items-start space-x-2">
                                <span class="text-green-400 mt-0.5"></span>
                                <div>
                                    <strong>Pattern Recognition:</strong> Identifies recurring patterns that can predict future behavior
                                </div>
                            </li>
                            <li class="flex items-start space-x-2">
                                <span class="text-green-400 mt-0.5"></span>
                                <div>
                                    <strong>Uncertainty Quantification:</strong> Measures confidence levels and risk in predictions
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="bg-white/5 p-6 rounded-lg border border-white/10">
                        <h4 class="text-lg font-bold mb-4 text-blue-300"> Business Applications</h4>
                        <ul class="space-y-3 text-sm">
                            <li class="flex items-start space-x-2">
                                <span class="text-blue-400 mt-0.5"></span>
                                <div>
                                    <strong>Financial Planning:</strong> Budget forecasting, revenue projection, expense planning
                                </div>
                            </li>
                            <li class="flex items-start space-x-2">
                                <span class="text-blue-400 mt-0.5"></span>
                                <div>
                                    <strong>Demand Forecasting:</strong> Inventory management, production planning, resource allocation
                                </div>
                            </li>
                            <li class="flex items-start space-x-2">
                                <span class="text-blue-400 mt-0.5"></span>
                                <div>
                                    <strong>Risk Management:</strong> Market volatility assessment, scenario planning
                                </div>
                            </li>
                            <li class="flex items-start space-x-2">
                                <span class="text-blue-400 mt-0.5"></span>
                                <div>
                                    <strong>Strategic Planning:</strong> Long-term goal setting, market expansion decisions
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- Model Types -->
                <div class="bg-black/20 p-6 rounded-lg">
                    <h4 class="text-lg font-bold mb-4 text-yellow-300"> Forecasting Models Explained</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-black/20 rounded border border-blue-500/30">
                            <h5 class="font-semibold text-blue-300 mb-2">Linear/Trend Models</h5>
                            <p class="text-xs text-white/80 mb-2">Best for data with consistent directional movement</p>
                            <div class="text-xs text-white/60">
                                <p><strong>Use when:</strong> Steady growth or decline patterns</p>
                                <p><strong>Examples:</strong> Population growth, cumulative sales</p>
                            </div>
                        </div>
                        <div class="p-4 bg-black/20 rounded border border-green-500/30">
                            <h5 class="font-semibold text-green-300 mb-2">Seasonal Models</h5>
                            <p class="text-xs text-white/80 mb-2">Ideal for cyclical business patterns</p>
                            <div class="text-xs text-white/60">
                                <p><strong>Use when:</strong> Regular seasonal fluctuations</p>
                                <p><strong>Examples:</strong> Retail sales, tourism, energy consumption</p>
                            </div>
                        </div>
                        <div class="p-4 bg-black/20 rounded border border-purple-500/30">
                            <h5 class="font-semibold text-purple-300 mb-2">Auto-Selection</h5>
                            <p class="text-xs text-white/80 mb-2">Automatically chooses the best model</p>
                            <div class="text-xs text-white/60">
                                <p><strong>Use when:</strong> Unsure which model fits best</p>
                                <p><strong>Benefits:</strong> Cross-validation ensures optimal choice</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Requirements -->
                <div class="bg-gradient-to-r from-blue-900/30 to-indigo-900/30 p-6 rounded-lg border border-blue-500/20">
                    <h4 class="text-lg font-bold mb-4 text-blue-300"> Data Requirements & Best Practices</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                        <div>
                            <h5 class="font-semibold text-green-300 mb-3">Data Quality Guidelines</h5>
                            <ul class="space-y-2 text-white/80">
                                <li> <strong>Minimum 24 data points</strong> for basic analysis</li>
                                <li> <strong>36+ points recommended</strong> for seasonal detection</li>
                                <li> <strong>60+ points optimal</strong> for high confidence</li>
                                <li> Regular time intervals (monthly, weekly, etc.)</li>
                                <li> Minimal missing values (< 10%)</li>
                                <li> Consistent data collection methods</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-semibold text-yellow-300 mb-3">Common Data Issues</h5>
                            <ul class="space-y-2 text-white/80">
                                <li> <strong>Outliers:</strong> Extreme values that skew results</li>
                                <li> <strong>Structural breaks:</strong> Major business changes</li>
                                <li> <strong>Missing data:</strong> Gaps in time series</li>
                                <li> <strong>Inconsistent frequency:</strong> Irregular intervals</li>
                                <li> <strong>External shocks:</strong> One-time events</li>
                                <li> <strong>Data drift:</strong> Changing measurement methods</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="text-center p-4 bg-black/20 rounded-lg border border-white/10">
                    <p class="text-xs text-white/60">
                        Predictive analysis is a powerful tool for data-driven decision making. Combine statistical insights with domain expertise 
                        and business judgment for the best results. Always consider the context and limitations of your predictions.
                    </p>
                </div>
            </div>
        `;
    };

    // --- 1. Enhanced Overview Panel ---
    try {
        const overviewPanel = $("predictiveOverviewPanel");
        const accuracy = model_performance.r_squared !== null ? (model_performance.r_squared * 100) : null;
        const mape = model_performance.mape;
        const trend = model_performance.trend_detected || 'N/A';
        
        const estimatedDataPoints = data.data_info?.total_points || (predictions.length > 0 ? Math.max(predictions.length * 2, 24) : 24);
        const forecastHorizon = predictions.length || 12;
        
        const reliability = calculateEnhancedForecastReliability(
            model_performance.r_squared || 0,
            model_performance.mape || 100,
            estimatedDataPoints,
            forecastHorizon
        );
        
        // Enhanced business context metrics
        const trajectory = business_context?.trajectory || 'Unknown';
        const changePercent = business_context?.change_percent || 0;
        const riskLevel = business_context?.risk_level || 'Unknown';
        const planningHorizon = business_context?.planning_horizon_recommendation || '6-12 months';
        const selectionReason = model_performance.selection_reason || "Auto-selected based on data characteristics";

        overviewPanel.innerHTML = `
            <div class="p-4 space-y-8">
                <h3 class="text-2xl font-bold text-center mb-4">Executive Dashboard</h3>
                
                <!-- Enhanced Business Strategy Section -->
                <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 p-6 rounded-lg mb-6 max-w-4xl mx-auto border border-purple-500/20">
                    <h4 class="text-xl font-semibold mb-4 text-center text-purple-300"> Strategic Business Intelligence</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-2xl font-bold ${changePercent > 0 ? 'text-green-400' : changePercent < 0 ? 'text-red-400' : 'text-yellow-400'}">${trajectory}</div>
                            <div class="text-xs text-white/70 mt-1">${Math.abs(changePercent).toFixed(1)}% ${changePercent >= 0 ? 'Growth' : 'Decline'}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold ${riskLevel === 'Low' ? 'text-green-400' : riskLevel === 'Medium' ? 'text-yellow-400' : 'text-red-400'}">${riskLevel} Risk</div>
                            <div class="text-xs text-white/70 mt-1">Planning: ${planningHorizon}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold ${reliability.class}">${reliability.level}</div>
                            <div class="text-xs text-white/70 mt-1">Forecast Confidence</div>
                        </div>
                    </div>
                    ${business_context?.strategic_recommendations?.[0] ? `
                    <div class="mt-4 p-3 bg-black/20 rounded text-sm">
                        <strong>Key Recommendation:</strong> ${business_context.strategic_recommendations[0]}
                    </div>
                    ` : ''}
                </div>

                <!-- Enhanced Performance Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 max-w-6xl mx-auto">
                    <div class="summary-stat-card text-center p-4">
                        <div class="stat-label text-sm mb-1" title="Model R-Squared: How well the model fits historical data">Model Fit (R)</div>
                        <div class="stat-value text-3xl font-bold ${accuracy === null || accuracy < 50 ? 'text-yellow-400' : 'text-green-400'}">${formatMetric(accuracy, 1, '%')}</div>
                        <div class="stat-subtext text-xs mt-1">Reliability: ${reliability.score}/100</div>
                    </div>
                    <div class="summary-stat-card text-center p-4">
                        <div class="stat-label text-sm mb-1" title="Mean Absolute Percentage Error">Prediction Error</div>
                        <div class="stat-value text-3xl font-bold ${mape === null || mape > 20 ? 'text-yellow-400' : 'text-green-400'}">${formatMetric(mape, 1, '%')}</div>
                        <div class="stat-subtext text-xs mt-1">MAPE</div>
                    </div>
                    <div class="summary-stat-card text-center p-4">
                        <div class="stat-label text-sm mb-1" title="Historical trend direction">Historical Trend</div>
                        <div class="stat-value text-2xl font-bold">${trend}</div>
                        <div class="stat-subtext text-xs mt-1">Pattern Direction</div>
                    </div>
                    <div class="summary-stat-card text-center p-4">
                        <div class="stat-label text-sm mb-1" title="Business volatility assessment">Volatility Risk</div>
                        <div class="stat-value text-2xl font-bold ${(business_context?.predicted_volatility || 0) > 25 ? 'text-red-400' : 'text-green-400'}">${(business_context?.predicted_volatility || 0) > 25 ? 'High' : 'Low'}</div>
                        <div class="stat-subtext text-xs mt-1">${formatMetric(business_context?.predicted_volatility, 1, '%')}</div>
                    </div>
                </div>

                <!-- Enhanced Model Selection -->
                <div class="bg-black/20 p-4 rounded-lg max-w-4xl mx-auto">
                    <h5 class="font-semibold mb-2 text-indigo-300"> Model Intelligence</h5>
                    <div class="text-sm text-white/80">
                        <p><strong>Selected Model:</strong> ${model_performance.model_used || 'N/A'}</p>
                        <p><strong>Selection Reason:</strong> ${selectionReason}</p>
                        ${model_performance.validation_folds ? `<p><strong>Cross-Validation:</strong> ${model_performance.validation_folds} validation folds completed</p>` : ''}
                    </div>
                </div>

                <!-- Strategic Action Items -->
                ${business_context?.strategic_recommendations?.length > 1 ? `
                <div class="bg-black/20 p-6 rounded-lg max-w-4xl mx-auto">
                    <h4 class="text-xl font-semibold mb-3 text-center text-indigo-300"> Strategic Action Items</h4>
                    <div class="space-y-2">
                        ${business_context.strategic_recommendations.slice(0, 3).map((rec, idx) => 
                            `<div class="flex items-center space-x-2">
                                <span class="flex-shrink-0 w-6 h-6 bg-purple-600 text-white rounded-full flex items-center justify-center text-xs font-bold">${idx + 1}</span>
                                <span class="text-sm text-white/90">${rec}</span>
                            </div>`
                        ).join('')}
                    </div>
                    
                    ${riskLevel === 'High' ? `
                    <div class="mt-4 p-3 bg-red-900/30 border border-red-600/50 rounded text-red-200 text-xs">
                        <strong> High Risk Alert:</strong> Enhanced monitoring recommended. Consider shorter planning cycles and more frequent forecast updates.
                    </div>
                    ` : ''}
                    
                    <p class="text-xs text-white/60 mt-4 text-center">Review the 'Diagnostics' tab for detailed warnings and recommendations.</p>
                </div>
                ` : ''}
            </div>
        `;
    } catch (e) {
        console.error("Error rendering Enhanced Overview Panel:", e);
        $("predictiveOverviewPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering overview: ${e.message}</div>`;
    }

    // --- 2. Enhanced Charts Panel with Model Differentiation ---
    try {
        const chartsPanel = $("predictiveChartsPanel");
        chartsPanel.innerHTML = `
            <div class="p-4 space-y-8">
                <h3 class="text-2xl font-bold mb-4 text-center">Visual Analysis</h3>
                <div>
                    <h4 class="text-xl font-semibold mb-2">Enhanced Forecast with Business Context</h4>
                    <div id="predictiveForecastChart" class="w-full h-[500px] plotly-chart bg-black/10 rounded-lg border border-white/20"></div>
                    <p class="text-xs text-white/60 mt-2 text-center">
                        Shaded area represents ${formatMetric((model_performance.confidence_level || 0.90) * 100, 0)}% confidence interval. 
                        ${business_context?.trajectory ? `Business trajectory: ${business_context.trajectory}` : ''}
                    </p>
                </div>
            </div>
        `;

        if (predictions && predictions.length > 0) {
            // Add historical data if available
            let historicalTrace = null;
            if (historical_data && historical_data.length > 0) {
                historicalTrace = {
                    x: historical_data.map(h => h.period),
                    y: historical_data.map(h => h.value),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Historical Data',
                    line: { 
                        color: '#8B5CF6', // Purple for historical
                        width: 3 
                    },
                    marker: { 
                        size: 6, 
                        color: '#8B5CF6' 
                    }
                };
            }

            // Enhanced forecast trace with model-specific styling
            const modelType = model_performance?.model_used || 'Unknown';
            let forecastColor = '#10B981'; // Default green
            let lineStyle = 'solid';
            
            // Differentiate by model type
            switch(modelType.toLowerCase()) {
                case 'linear regression':
                case 'linear trend':
                    forecastColor = '#3B82F6'; // Blue for linear
                    lineStyle = 'solid';
                    break;
                case 'seasonal forecast':
                case 'seasonal decomposition':
                    forecastColor = '#F59E0B'; // Orange for seasonal
                    lineStyle = 'solid';
                    break;
                case 'simple trend':
                    forecastColor = '#EF4444'; // Red for simple trend
                    lineStyle = 'dash';
                    break;
                case 'auto-select best':
                default:
                    forecastColor = '#10B981'; // Green for auto-select
                    lineStyle = 'solid';
                    break;
            }

            const traceForecast = {
                x: predictions.map(p => p.period),
                y: predictions.map(p => p.predicted_value),
                type: 'scatter', 
                mode: 'lines+markers', 
                name: `Forecast (${modelType})`,
                line: { 
                    color: forecastColor,
                    width: 4,
                    dash: lineStyle
                },
                marker: { 
                    size: 8,
                    color: forecastColor,
                    line: { color: 'white', width: 2 }
                }
            };
            
            // Enhanced confidence bounds with model-specific colors
            const traceUpper = {
                x: predictions.map(p => p.period),
                y: predictions.map(p => p.upper_bound),
                type: 'scatter', 
                mode: 'lines', 
                name: 'Upper Bound',
                line: { 
                    dash: 'dot', 
                    color: `rgba(255,255,255,0.7)`,
                    width: 2
                },
                fill: 'none',
                showlegend: true
            };
            
            const traceLower = {
                x: predictions.map(p => p.period),
                y: predictions.map(p => p.lower_bound),
                type: 'scatter', 
                mode: 'lines', 
                name: 'Lower Bound',
                line: { 
                    dash: 'dot', 
                    color: `rgba(255,255,255,0.7)`,
                    width: 2
                },
                fill: 'tonexty',
                fillcolor: `${forecastColor}33`, // 20% opacity of forecast color
                showlegend: true
            };

            // Enhanced annotations with model-specific insights
            const annotations = [];
            
            // Add model type annotation
            if (predictions.length > 3) {
                const midPoint = Math.floor(predictions.length / 2);
                annotations.push({
                    x: predictions[midPoint]?.period,
                    y: predictions[midPoint]?.predicted_value,
                    text: `<b>${modelType}</b><br>${business_context?.trajectory || 'Pattern'} Detected`,
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: forecastColor,
                    bgcolor: 'rgba(0,0,0,0.8)',
                    bordercolor: forecastColor,
                    borderwidth: 1,
                    font: { color: 'white', size: 10 }
                });
            }

            // Add trend direction annotation if significant change
            if (business_context?.change_percent && Math.abs(business_context.change_percent) > 5) {
                const lastPoint = predictions.length - 1;
                annotations.push({
                    x: predictions[lastPoint]?.period,
                    y: predictions[lastPoint]?.predicted_value,
                    text: `<b>${Math.abs(business_context.change_percent).toFixed(1)}%</b><br>${business_context.change_percent > 0 ? ' Growth' : ' Decline'}`,
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: business_context.change_percent > 0 ? '#10B981' : '#EF4444',
                    bgcolor: 'rgba(0,0,0,0.8)',
                    bordercolor: business_context.change_percent > 0 ? '#10B981' : '#EF4444',
                    borderwidth: 1,
                    font: { color: 'white', size: 10 },
                    ax: -30,
                    ay: -30
                });
            }

            // Create traces array
            const traces = [traceLower, traceUpper, traceForecast];
            if (historicalTrace) {
                traces.unshift(historicalTrace); // Add historical data first
            }

            // Enhanced layout with better differentiation
            const layout = {
                title: {
                    text: `${modelType} Forecast: ${business_context?.trajectory || 'Pattern'} Detected`,
                    font: { color: 'white', size: 18, family: 'Arial, sans-serif' }
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0.1)',
                font: { color: 'white', size: 12 },
                xaxis: { 
                    title: {
                        text: 'Time Period',
                        font: { size: 14, color: 'white' }
                    },
                    gridcolor: 'rgba(255,255,255,0.3)',
                    tickformat: '%Y-%m',
                    tickfont: { size: 11, color: 'white' },
                    linecolor: 'rgba(255,255,255,0.5)',
                    linewidth: 1
                },
                yaxis: { 
                    title: {
                        text: 'Value',
                        font: { size: 14, color: 'white' }
                    },
                    gridcolor: 'rgba(255,255,255,0.3)',
                    zeroline: false,
                    tickfont: { size: 11, color: 'white' },
                    linecolor: 'rgba(255,255,255,0.5)',
                    linewidth: 1
                },
                legend: { 
                    orientation: 'h', 
                    y: -0.15, 
                    yanchor: 'top',
                    bgcolor: 'rgba(0,0,0,0.7)',
                    bordercolor: 'rgba(255,255,255,0.3)',
                    borderwidth: 1,
                    font: { size: 11, color: 'white' }
                },
                hovermode: 'x unified',
                hoverlabel: {
                    bgcolor: 'rgba(0,0,0,0.8)',
                    bordercolor: 'white',
                    font: { color: 'white', size: 11 }
                },
                margin: { t: 80, b: 100, l: 80, r: 40 },
                annotations: annotations,
                // Add vertical line to separate historical from forecast
                shapes: historicalTrace ? [{
                    type: 'line',
                    x0: historicalTrace.x[historicalTrace.x.length - 1],
                    y0: 0,
                    x1: historicalTrace.x[historicalTrace.x.length - 1],
                    y1: 1,
                    yref: 'paper',
                    line: {
                        color: 'rgba(255,255,255,0.5)',
                        width: 2,
                        dash: 'dash'
                    }
                }] : []
            };

            Plotly.newPlot('predictiveForecastChart', traces, layout, { 
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            });
        } else {
            $("predictiveForecastChart").innerHTML = `<div class="p-4 text-center text-white/60">Forecast data unavailable for charting.</div>`;
        }
    } catch (e) {
        console.error("Error rendering Enhanced Charts Panel:", e);
        $("predictiveChartsPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering charts.</div>`;
    }

    // --- 3. Enhanced Details Panel ---
    try {
        const detailsPanel = $("predictiveDetailsPanel");
        const detailsHtml = `
            <div class="p-4 space-y-8">
                <h3 class="text-2xl font-bold mb-4 text-center">Technical Details</h3>

                <div>
                    <h4 class="text-xl font-semibold mb-3">Enhanced Model Performance Metrics</h4>
                    <p class="text-sm text-white/70 mb-4 italic">Statistics evaluating how well the chosen model (${model_performance.model_used || 'N/A'}) fit the historical data.</p>
                    <div class="overflow-x-auto">
                        <table class="coeff-table styled-table text-sm">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                    <th>Interpretation Guide</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Model Used</td><td>${model_performance.model_used || 'N/A'}</td><td class="text-white/70">Algorithm selected for forecasting.</td></tr>
                                <tr><td>Selection Reason</td><td>${model_performance.selection_reason || 'Auto-selected'}</td><td class="text-white/70">Why this model was chosen.</td></tr>
                                <tr><td>R-Squared</td><td>${formatMetric(model_performance.r_squared, 3)}</td><td class="text-white/70">% variance explained (higher = better fit).</td></tr>
                                <tr><td>MAPE (%)</td><td>${formatMetric(model_performance.mape, 1)}</td><td class="text-white/70">Mean Absolute Percentage Error (lower = better accuracy).</td></tr>
                                <tr><td>MAE</td><td>${formatMetric(model_performance.mae, 2)}</td><td class="text-white/70">Mean Absolute Error (avg. error magnitude in original units).</td></tr>
                                <tr><td>RMSE</td><td>${formatMetric(model_performance.rmse, 2)}</td><td class="text-white/70">Root Mean Squared Error (error magnitude, penalizes large errors).</td></tr>
                                ${model_performance.validation_folds ? `<tr><td>Cross-Validation Folds</td><td>${model_performance.validation_folds}</td><td class="text-white/70">Number of validation tests performed.</td></tr>` : ''}
                            </tbody>
                        </table>
                        <blockquote class="mt-4 p-3 text-xs italic border-l-2 border-indigo-400 bg-black/20 text-white/70">${model_performance.interpretation || 'Model fit interpretation unavailable.'}</blockquote>
                    </div>
                </div>

                ${business_context ? `
                <div>
                    <h4 class="text-xl font-semibold mb-3">Business Context Analysis</h4>
                    <div class="overflow-x-auto">
                        <table class="coeff-table styled-table text-sm">
                            <thead>
                                <tr>
                                    <th>Business Metric</th>
                                    <th>Value</th>
                                    <th>Interpretation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Business Trajectory</td><td>${business_context.trajectory || 'Unknown'}</td><td class="text-white/70">Overall direction of change.</td></tr>
                                <tr><td>Expected Change</td><td>${formatMetric(Math.abs(business_context.change_percent || 0), 1, '%')} ${(business_context.change_percent || 0) >= 0 ? 'Growth' : 'Decline'}</td><td class="text-white/70">Projected change over forecast period.</td></tr>
                                <tr><td>Risk Level</td><td>${business_context.risk_level || 'Unknown'}</td><td class="text-white/70">Overall forecast risk assessment.</td></tr>
                                <tr><td>Current Volatility</td><td>${formatMetric(business_context.current_volatility, 1, '%')}</td><td class="text-white/70">Historical variability level.</td></tr>
                                <tr><td>Predicted Volatility</td><td>${formatMetric(business_context.predicted_volatility, 1, '%')}</td><td class="text-white/70">Expected future variability.</td></tr>
                                <tr><td>Planning Horizon</td><td>${business_context.planning_horizon_recommendation || 'N/A'}</td><td class="text-white/70">Recommended planning timeframe.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}

                <div>
                    <h4 class="text-xl font-semibold mb-3">Forecast Data Table</h4>
                    <p class="text-sm text-white/70 mb-4 italic">Predicted values and ${formatMetric((model_performance.confidence_level || 0.90) * 100, 0)}% confidence intervals for each future period.</p>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table class="coeff-table styled-table forecast-table text-sm">
                            <thead class="sticky top-0 bg-gray-800/80 backdrop-blur-sm">
                                <tr>
                                    <th>Period</th>
                                    <th>Predicted Value</th>
                                    <th>Lower Bound</th>
                                    <th>Upper Bound</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${predictions?.map(p => `
                                    <tr>
                                        <td>${p.period ?? 'N/A'}</td>
                                        <td><strong>${formatMetric(p.predicted_value, 2)}</strong></td>
                                        <td>${formatMetric(p.lower_bound, 2)}</td>
                                        <td>${formatMetric(p.upper_bound, 2)}</td>
                                    </tr>`).join("") ?? '<tr><td colspan="4" class="text-center text-white/60">No prediction data available.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        detailsPanel.innerHTML = detailsHtml;
    } catch (e) {
        console.error("Error rendering Enhanced Details Panel:", e);
        $("predictiveDetailsPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering details: ${e.message}</div>`;
    }

    // --- 4. Enhanced Insights Panel ---
    try {
        const insightsPanel = $("predictiveInsightsPanel");
        let insightsHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4 text-center"> Strategic Insights & Recommendations</h3>`;

        if (insights && insights.length > 0) {
            insights.forEach((insight, index) => {
                const confidenceLevel = insight.confidence_level || 'Medium';
                const confidenceClass = confidenceLevel === 'High' ? 'border-green-500' : 
                                      confidenceLevel === 'Medium' ? 'border-yellow-500' : 'border-red-500';
                const confidenceIcon = confidenceLevel === 'High' ? '' : 
                                      confidenceLevel === 'Medium' ? '' : '';
                
                insightsHtml += `
                    <div class="insight-card border-l-4 ${confidenceClass} relative">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-xs font-semibold text-indigo-300 mb-1">INSIGHT ${index + 1}</p>
                            <span class="text-xs bg-black/30 px-2 py-1 rounded flex items-center">
                                ${confidenceIcon} ${confidenceLevel} Confidence
                            </span>
                        </div>
                        <p class="mb-2"><strong>Observation:</strong> ${insight.observation}</p>
                        <p class="mb-2 text-sm text-white/80"><strong>Analysis:</strong> ${insight.accurate_interpretation}</p>
                        <div class="p-3 bg-gradient-to-r from-purple-900/20 to-blue-900/20 rounded mt-3 border-l-2 border-purple-400">
                            <p class="text-sm font-semibold"> Business Implication:</p>
                            <p class="text-sm text-white/90 mt-1">${insight.business_implication}</p>
                        </div>
                    </div>`;
            });
        } else {
            insightsHtml += `<p class="text-center text-white/70 italic">No specific insights were generated by the analysis.</p>`;
        }
        
        insightsHtml += `</div>`;
        insightsPanel.innerHTML = insightsHtml;
    } catch (e) {
        console.error("Error rendering Enhanced Insights Panel:", e);
        $("predictiveInsightsPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering insights.</div>`;
    }

    // --- 5. Enhanced Diagnostics Panel ---
    try {
        const diagnosticsPanel = $("predictiveDiagnosticsPanel");
        renderPredictiveDiagnosticsPanel(diagnosticsPanel, data);
    } catch (e) {
        console.error("Error rendering Diagnostics Panel:", e);
        $("predictiveDiagnosticsPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering diagnostics: ${e.message}</div>`;
    }

    // --- 6. Simplified Learn Panel ---
    try {
        const learnPanel = $("predictiveLearnPanel");
        renderPredictiveLearnPanel(learnPanel, data);
    } catch (e) {
        console.error("Error rendering Learn Panel:", e);
        $("predictiveLearnPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering learn section: ${e.message}</div>`;
    }

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Final Touches (keeping existing logic) ---
    try {
        analysisCache[currentTemplateId] = container.innerHTML;
        $("analysisActions").classList.remove("hidden");

        // --- Tab Switching Logic ---
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON" && !e.target.classList.contains('active')) {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

                e.target.classList.add("active");
                const targetPanelId = "predictive" + e.target.dataset.tab.charAt(0).toUpperCase() + e.target.dataset.tab.slice(1) + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add("active");

                    const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                    chartsInPanel.forEach(chartDiv => {
                        if (chartDiv.layout && typeof Plotly !== 'undefined') {
                            try {
                                Plotly.Plots.resize(chartDiv);
                                console.log(`Resized chart ${chartDiv.id} on tab switch.`);
                            } catch (resizeError) {
                                console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                            }
                        }
                    });
                } else {
                     console.warn("Target panel not found for tab:", e.target.dataset.tab);
                }
            }
        });

        setTimeout(() => {
             const activePanel = tabContent.querySelector('.analysis-tab-panel.active');
             if (activePanel) {
                 activePanel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                     if (chartDiv.layout && typeof Plotly !== 'undefined') {
                         try {
                              Plotly.Plots.resize(chartDiv);
                              console.log(`Initial resize for chart ${chartDiv.id} attempted.`);
                         } catch (initialResizeError) {
                              console.error(`Error during initial resize ${chartDiv.id}:`, initialResizeError);
                         }
                     }
                 });
             }
        }, 200);

    } catch (e) {
        console.error("Error during final setup (cache/tabs/buttons):", e);
        if (!container.innerHTML.includes('text-red-400')) {
             container.innerHTML += `<div class="p-4 text-center text-red-400">Error setting up UI components after rendering.</div>`;
        }
    } finally {
        setLoading("generate", false);
    }
}

/**
 * Warnings and Diagnostics Panel Function
 * Call this to populate the new diagnostics tab
 */
function renderPredictiveDiagnosticsPanel(diagnosticsPanel, data) {
    const { model_performance, business_context, data_info, predictions } = data;
    
    // Calculate diagnostic metrics
    const dataPoints = data_info?.total_points || predictions.length * 2;
    const forecastHorizon = predictions.length || 12;
    const r2 = model_performance?.r_squared || 0;
    const mape = model_performance?.mape || 100;
    const riskLevel = business_context?.risk_level || 'Unknown';
    
    // Generate warnings and diagnostics
    const warnings = [];
    const diagnostics = [];
    const recommendations = [];
    
    // Data Quality Warnings
    if (dataPoints < 24) {
        warnings.push({
            level: 'high',
            type: 'Data Insufficiency',
            message: `Only ${dataPoints} data points available. Minimum 24 recommended for reliable analysis.`,
            impact: 'Low confidence in seasonal patterns and model validation.'
        });
    } else if (dataPoints < 36) {
        warnings.push({
            level: 'medium',
            type: 'Limited Data',
            message: `${dataPoints} data points available. 36+ recommended for optimal analysis.`,
            impact: 'Good analysis possible but limited cross-validation reliability.'
        });
    }
    
    // Model Performance Warnings
    if (r2 < 0.3) {
        warnings.push({
            level: 'high',
            type: 'Poor Model Fit',
            message: `R-squared of ${(r2 * 100).toFixed(1)}% indicates weak model performance.`,
            impact: 'Predictions may not reflect actual patterns in your data.'
        });
    } else if (r2 < 0.5) {
        warnings.push({
            level: 'medium',
            type: 'Moderate Model Fit',
            message: `R-squared of ${(r2 * 100).toFixed(1)}% suggests room for improvement.`,
            impact: 'Use predictions with caution for strategic decisions.'
        });
    }
    
    if (mape > 30) {
        warnings.push({
            level: 'high',
            type: 'High Prediction Error',
            message: `MAPE of ${mape.toFixed(1)}% indicates significant prediction errors.`,
            impact: 'Consider this forecast as directional guidance only.'
        });
    } else if (mape > 15) {
        warnings.push({
            level: 'medium',
            type: 'Moderate Prediction Error',
            message: `MAPE of ${mape.toFixed(1)}% suggests moderate prediction accuracy.`,
            impact: 'Monitor actual results closely and update forecasts regularly.'
        });
    }
    
    // Forecast Horizon Warnings
    if (forecastHorizon > dataPoints / 2) {
        warnings.push({
            level: 'medium',
            type: 'Long Forecast Horizon',
            message: `Forecasting ${forecastHorizon} periods with ${dataPoints} historical points.`,
            impact: 'Confidence decreases significantly for later periods.'
        });
    }
    
    // Risk Assessment Warnings
    if (riskLevel === 'High') {
        warnings.push({
            level: 'high',
            type: 'High Business Risk',
            message: 'High volatility and uncertainty detected in forecast.',
            impact: 'Consider scenario planning and frequent forecast updates.'
        });
    }
    
    // Generate Diagnostics
    diagnostics.push({
        category: 'Data Quality',
        metrics: [
            { name: 'Data Points', value: dataPoints, benchmark: '36+', status: dataPoints >= 36 ? 'good' : dataPoints >= 24 ? 'fair' : 'poor' },
            { name: 'Data Range', value: `${data_info?.date_range_days || 'Unknown'} days`, benchmark: '730+ days', status: (data_info?.date_range_days || 0) >= 730 ? 'good' : 'fair' },
            { name: 'Missing Values', value: '< 5%', benchmark: '< 10%', status: 'good' },
            { name: 'Data Frequency', value: 'Regular', benchmark: 'Consistent', status: 'good' }
        ]
    });
    
    diagnostics.push({
        category: 'Model Performance',
        metrics: [
            { name: 'R-Squared', value: `${(r2 * 100).toFixed(1)}%`, benchmark: '70%+', status: r2 >= 0.7 ? 'good' : r2 >= 0.5 ? 'fair' : 'poor' },
            { name: 'MAPE', value: `${mape.toFixed(1)}%`, benchmark: '< 15%', status: mape <= 15 ? 'good' : mape <= 30 ? 'fair' : 'poor' },
            { name: 'Cross-Validation', value: `${model_performance?.validation_folds || 0} folds`, benchmark: '5+ folds', status: (model_performance?.validation_folds || 0) >= 5 ? 'good' : 'fair' },
            { name: 'Model Selection', value: model_performance?.model_used || 'Unknown', benchmark: 'Auto-Selected', status: 'good' }
        ]
    });
    
    diagnostics.push({
        category: 'Business Context',
        metrics: [
            { name: 'Risk Level', value: riskLevel, benchmark: 'Low-Medium', status: riskLevel === 'Low' ? 'good' : riskLevel === 'Medium' ? 'fair' : 'poor' },
            { name: 'Volatility', value: `${(business_context?.predicted_volatility || 0).toFixed(1)}%`, benchmark: '< 25%', status: (business_context?.predicted_volatility || 0) < 25 ? 'good' : 'fair' },
            { name: 'Trend Stability', value: business_context?.trajectory || 'Unknown', benchmark: 'Stable/Growth', status: 'fair' },
            { name: 'Planning Horizon', value: business_context?.planning_horizon_recommendation || 'Unknown', benchmark: '6-12 months', status: 'good' }
        ]
    });
    
    // Generate Recommendations
    if (dataPoints < 36) {
        recommendations.push({
            priority: 'high',
            action: 'Collect More Historical Data',
            description: 'Gather additional historical data points to improve model reliability and enable better seasonal pattern detection.',
            benefit: 'Increased forecast confidence and better cross-validation results.'
        });
    }
    
    if (mape > 20) {
        recommendations.push({
            priority: 'high',
            action: 'Investigate Data Quality',
            description: 'Review data for outliers, missing values, or structural breaks that may be affecting model performance.',
            benefit: 'Improved prediction accuracy and model reliability.'
        });
    }
    
    if (riskLevel === 'High') {
        recommendations.push({
            priority: 'medium',
            action: 'Implement Enhanced Monitoring',
            description: 'Set up regular forecast updates and actual vs. predicted tracking to quickly identify deviations.',
            benefit: 'Early detection of forecast drift and improved decision-making agility.'
        });
    }
    
    recommendations.push({
        priority: 'low',
        action: 'Regular Forecast Updates',
        description: 'Update forecasts monthly or quarterly as new data becomes available to maintain accuracy.',
        benefit: 'Sustained forecast reliability and adaptation to changing business conditions.'
    });
    
    diagnosticsPanel.innerHTML = `
        <div class="p-6 space-y-8 text-white/90 max-w-6xl mx-auto">
            <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-red-400 to-orange-400 bg-clip-text text-transparent">
                 Warnings & Diagnostics
            </h3>
            
            <!-- Warnings Section -->
            <div class="space-y-4">
                <h4 class="text-xl font-bold text-red-300 mb-4"> Warnings & Alerts</h4>
                ${warnings.length > 0 ? warnings.map(warning => `
                    <div class="p-4 rounded-lg border-l-4 ${
                        warning.level === 'high' ? 'bg-red-900/20 border-red-500' : 
                        warning.level === 'medium' ? 'bg-yellow-900/20 border-yellow-500' : 
                        'bg-blue-900/20 border-blue-500'
                    }">
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">${warning.level === 'high' ? '' : warning.level === 'medium' ? '' : ''}</div>
                            <div class="flex-1">
                                <h5 class="font-semibold text-lg ${
                                    warning.level === 'high' ? 'text-red-300' : 
                                    warning.level === 'medium' ? 'text-yellow-300' : 
                                    'text-blue-300'
                                }">${warning.type}</h5>
                                <p class="text-white/90 mt-1">${warning.message}</p>
                                <p class="text-white/70 text-sm mt-2"><strong>Impact:</strong> ${warning.impact}</p>
                            </div>
                        </div>
                    </div>
                `).join('') : `
                    <div class="p-4 bg-green-900/20 border border-green-500/30 rounded-lg text-center">
                        <div class="text-2xl mb-2"></div>
                        <p class="text-green-300 font-semibold">No Critical Warnings Detected</p>
                        <p class="text-white/70 text-sm mt-1">Your analysis appears to be within acceptable parameters.</p>
                    </div>
                `}
            </div>
            
            <!-- Diagnostics Section -->
            <div class="space-y-6">
                <h4 class="text-xl font-bold text-blue-300 mb-4"> Detailed Diagnostics</h4>
                ${diagnostics.map(category => `
                    <div class="bg-black/20 p-6 rounded-lg border border-white/10">
                        <h5 class="text-lg font-semibold text-indigo-300 mb-4">${category.category}</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${category.metrics.map(metric => `
                                <div class="flex justify-between items-center p-3 bg-black/20 rounded">
                                    <div>
                                        <p class="font-medium">${metric.name}</p>
                                        <p class="text-xs text-white/60">Target: ${metric.benchmark}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold">${metric.value}</p>
                                        <span class="text-xs px-2 py-1 rounded ${
                                            metric.status === 'good' ? 'bg-green-600/20 text-green-300' :
                                            metric.status === 'fair' ? 'bg-yellow-600/20 text-yellow-300' :
                                            'bg-red-600/20 text-red-300'
                                        }">
                                            ${metric.status === 'good' ? ' Good' : metric.status === 'fair' ? ' Fair' : ' Poor'}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <!-- Recommendations Section -->
            <div class="space-y-4">
                <h4 class="text-xl font-bold text-green-300 mb-4"> Improvement Recommendations</h4>
                <div class="space-y-3">
                    ${recommendations.map((rec, index) => `
                        <div class="p-4 bg-black/20 rounded-lg border border-white/10">
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                    rec.priority === 'high' ? 'bg-red-600 text-white' :
                                    rec.priority === 'medium' ? 'bg-yellow-600 text-white' :
                                    'bg-blue-600 text-white'
                                }">${index + 1}</div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <h5 class="font-semibold">${rec.action}</h5>
                                        <span class="text-xs px-2 py-1 rounded ${
                                            rec.priority === 'high' ? 'bg-red-600/20 text-red-300' :
                                            rec.priority === 'medium' ? 'bg-yellow-600/20 text-yellow-300' :
                                            'bg-blue-600/20 text-blue-300'
                                        }">
                                            ${rec.priority.toUpperCase()} PRIORITY
                                        </span>
                                    </div>
                                    <p class="text-white/80 text-sm mb-2">${rec.description}</p>
                                    <p class="text-white/60 text-xs"><strong>Expected Benefit:</strong> ${rec.benefit}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- Model Health Summary -->
            <div class="bg-gradient-to-r from-purple-900/30 to-indigo-900/30 p-6 rounded-lg border border-purple-500/20">
                <h4 class="text-lg font-bold text-purple-300 mb-4"> Overall Model Health</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold ${r2 >= 0.7 ? 'text-green-400' : r2 >= 0.5 ? 'text-yellow-400' : 'text-red-400'}">
                            ${r2 >= 0.7 ? 'Excellent' : r2 >= 0.5 ? 'Good' : 'Poor'}
                        </div>
                        <p class="text-xs text-white/70">Model Fit Quality</p>
                    </div>
                    <div>
                        <div class="text-2xl font-bold ${dataPoints >= 36 ? 'text-green-400' : dataPoints >= 24 ? 'text-yellow-400' : 'text-red-400'}">
                            ${dataPoints >= 36 ? 'Sufficient' : dataPoints >= 24 ? 'Adequate' : 'Limited'}
                        </div>
                        <p class="text-xs text-white/70">Data Sufficiency</p>
                    </div>
                    <div>
                        <div class="text-2xl font-bold ${warnings.filter(w => w.level === 'high').length === 0 ? 'text-green-400' : 'text-red-400'}">
                            ${warnings.filter(w => w.level === 'high').length === 0 ? 'Stable' : 'Caution'}
                        </div>
                        <p class="text-xs text-white/70">Forecast Reliability</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center p-4 bg-black/20 rounded-lg border border-white/10">
                <p class="text-xs text-white/60">
                    Regular diagnostics help ensure forecast quality and reliability. Address high-priority recommendations first for maximum impact.
                </p>
            </div>
        </div>
    `;
}

/**
 * Simplified Learn Predictive Analysis Panel Function
 * Focuses purely on educational content without diagnostics
 */
function renderPredictiveLearnPanel(learnPanel, data) {
    learnPanel.innerHTML = `
        <div class="p-6 space-y-8 text-white/90 max-w-5xl mx-auto">
            <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                 Learn Predictive Analysis
            </h3>
            
            <!-- Main Definition -->
            <div class="bg-gradient-to-r from-purple-900/40 to-blue-900/40 p-6 rounded-lg border border-purple-500/30">
                <h4 class="text-xl font-bold mb-3 text-purple-300">What is Predictive Analysis?</h4>
                <p class="text-white/90 leading-relaxed">
                    Predictive analysis is a branch of advanced analytics that uses historical data, statistical algorithms, and machine learning techniques 
                    to identify patterns and predict future outcomes. Unlike basic reporting that tells you what happened, predictive analysis tells you 
                    what is likely to happen, enabling proactive decision-making and strategic planning.
                </p>
            </div>
            
            <!-- Core Concepts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white/5 p-6 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-4 text-green-300"> Core Components</h4>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-start space-x-2">
                            <span class="text-green-400 mt-0.5"></span>
                            <div>
                                <strong>Time-Series Analysis:</strong> Examines data points collected over time to identify trends, patterns, and seasonality
                            </div>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-green-400 mt-0.5"></span>
                            <div>
                                <strong>Statistical Modeling:</strong> Uses mathematical models to understand relationships between variables
                            </div>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-green-400 mt-0.5"></span>
                            <div>
                                <strong>Pattern Recognition:</strong> Identifies recurring patterns that can predict future behavior
                            </div>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-green-400 mt-0.5"></span>
                            <div>
                                <strong>Uncertainty Quantification:</strong> Measures confidence levels and risk in predictions
                            </div>
                        </li>
                    </ul>
                </div>
                
                <div class="bg-white/5 p-6 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-4 text-blue-300"> Business Applications</h4>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-start space-x-2">
                            <span class="text-blue-400 mt-0.5"></span>
                            <div>
                                <strong>Financial Planning:</strong> Budget forecasting, revenue projection, expense planning
                            </div>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-blue-400 mt-0.5"></span>
                            <div>
                                <strong>Demand Forecasting:</strong> Inventory management, production planning, resource allocation
                            </div>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-blue-400 mt-0.5"></span>
                            <div>
                                <strong>Risk Management:</strong> Market volatility assessment, scenario planning
                            </div>
                        </li>
                        <li class="flex items-start space-x-2">
                            <span class="text-blue-400 mt-0.5"></span>
                            <div>
                                <strong>Strategic Planning:</strong> Long-term goal setting, market expansion decisions
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Model Types -->
            <div class="bg-black/20 p-6 rounded-lg">
                <h4 class="text-lg font-bold mb-4 text-yellow-300"> Forecasting Models Explained</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-black/20 rounded border border-blue-500/30">
                        <h5 class="font-semibold text-blue-300 mb-2">Linear/Trend Models</h5>
                        <p class="text-xs text-white/80 mb-2">Best for data with consistent directional movement</p>
                        <div class="text-xs text-white/60">
                            <p><strong>Use when:</strong> Steady growth or decline patterns</p>
                            <p><strong>Examples:</strong> Population growth, cumulative sales</p>
                        </div>
                    </div>
                    <div class="p-4 bg-black/20 rounded border border-green-500/30">
                        <h5 class="font-semibold text-green-300 mb-2">Seasonal Models</h5>
                        <p class="text-xs text-white/80 mb-2">Ideal for cyclical business patterns</p>
                        <div class="text-xs text-white/60">
                            <p><strong>Use when:</strong> Regular seasonal fluctuations</p>
                            <p><strong>Examples:</strong> Retail sales, tourism, energy consumption</p>
                        </div>
                    </div>
                    <div class="p-4 bg-black/20 rounded border border-purple-500/30">
                        <h5 class="font-semibold text-purple-300 mb-2">Auto-Selection</h5>
                        <p class="text-xs text-white/80 mb-2">Automatically chooses the best model</p>
                        <div class="text-xs text-white/60">
                            <p><strong>Use when:</strong> Unsure which model fits best</p>
                            <p><strong>Benefits:</strong> Cross-validation ensures optimal choice</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Key Metrics -->
            <div class="bg-black/20 p-6 rounded-lg">
                <h4 class="text-lg font-bold mb-4 text-indigo-300"> Understanding Key Metrics</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                    <div class="space-y-4">
                        <div class="border-l-4 border-green-400 pl-4">
                            <h5 class="font-semibold text-green-300">R-Squared (R)</h5>
                            <p class="text-white/80 mb-1">Measures how well the model explains historical data variance</p>
                            <div class="text-xs text-white/60">
                                <p> 0.80+ = Excellent fit</p>
                                <p> 0.60-0.79 = Good fit</p>
                                <p> 0.40-0.59 = Moderate fit</p>
                                <p> Below 0.40 = Poor fit</p>
                            </div>
                        </div>
                        <div class="border-l-4 border-blue-400 pl-4">
                            <h5 class="font-semibold text-blue-300">MAPE (Mean Absolute Percentage Error)</h5>
                            <p class="text-white/80 mb-1">Average percentage difference between predicted and actual values</p>
                            <div class="text-xs text-white/60">
                                <p> Under 10% = Highly accurate</p>
                                <p> 10-20% = Good accuracy</p>
                                <p> 20-50% = Reasonable accuracy</p>
                                <p> Above 50% = Poor accuracy</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="border-l-4 border-purple-400 pl-4">
                            <h5 class="font-semibold text-purple-300">Confidence Intervals</h5>
                            <p class="text-white/80 mb-1">Range of values where the true outcome is likely to fall</p>
                            <div class="text-xs text-white/60">
                                <p> 90% confidence = 9 out of 10 outcomes fall within range</p>
                                <p> Wider intervals = Higher uncertainty</p>
                                <p> Narrower intervals = More precise predictions</p>
                            </div>
                        </div>
                        <div class="border-l-4 border-red-400 pl-4">
                            <h5 class="font-semibold text-red-300">Cross-Validation</h5>
                            <p class="text-white/80 mb-1">Testing model performance on different data subsets</p>
                            <div class="text-xs text-white/60">
                                <p> Prevents overfitting to historical data</p>
                                <p> More folds = More reliable validation</p>
                                <p> Essential for model selection</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Requirements -->
            <div class="bg-gradient-to-r from-blue-900/30 to-indigo-900/30 p-6 rounded-lg border border-blue-500/20">
                <h4 class="text-lg font-bold mb-4 text-blue-300"> Data Requirements & Best Practices</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                    <div>
                        <h5 class="font-semibold text-green-300 mb-3">Data Quality Guidelines</h5>
                        <ul class="space-y-2 text-white/80">
                            <li> <strong>Minimum 24 data points</strong> for basic analysis</li>
                            <li> <strong>36+ points recommended</strong> for seasonal detection</li>
                            <li> <strong>60+ points optimal</strong> for high confidence</li>
                            <li> Regular time intervals (monthly, weekly, etc.)</li>
                            <li> Minimal missing values (< 10%)</li>
                            <li> Consistent data collection methods</li>
                        </ul>
                    </div>
                    <div>
                        <h5 class="font-semibold text-yellow-300 mb-3">Common Data Issues</h5>
                        <ul class="space-y-2 text-white/80">
                            <li> <strong>Outliers:</strong> Extreme values that skew results</li>
                            <li> <strong>Structural breaks:</strong> Major business changes</li>
                            <li> <strong>Missing data:</strong> Gaps in time series</li>
                            <li> <strong>Inconsistent frequency:</strong> Irregular intervals</li>
                            <li> <strong>External shocks:</strong> One-time events</li>
                            <li> <strong>Data drift:</strong> Changing measurement methods</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Interpretation Guide -->
            <details class="styled-details bg-white/5 rounded-lg">
                <summary class="font-semibold cursor-pointer p-4 text-lg text-indigo-300"> How to Interpret Results</summary>
                <div class="px-6 pb-6 space-y-4 text-sm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-green-900/20 border border-green-500/30 rounded">
                            <h5 class="font-semibold text-green-300 mb-2">High Confidence Results</h5>
                            <p class="text-white/80 mb-2">R > 70%, MAPE < 15%, 5+ validation folds</p>
                            <ul class="text-xs text-white/70 space-y-1">
                                <li> Use for strategic planning</li>
                                <li> Set budget targets</li>
                                <li> Make resource allocation decisions</li>
                                <li> Plan capacity expansions</li>
                            </ul>
                        </div>
                        <div class="p-4 bg-yellow-900/20 border border-yellow-500/30 rounded">
                            <h5 class="font-semibold text-yellow-300 mb-2">Medium Confidence Results</h5>
                            <p class="text-white/80 mb-2">R 50-70%, MAPE 15-30%, 3-4 validation folds</p>
                            <ul class="text-xs text-white/70 space-y-1">
                                <li> Use for tactical planning</li>
                                <li> Monitor closely</li>
                                <li> Build in flexibility</li>
                                <li> Consider scenario planning</li>
                            </ul>
                        </div>
                        <div class="p-4 bg-red-900/20 border border-red-500/30 rounded">
                            <h5 class="font-semibold text-red-300 mb-2">Low Confidence Results</h5>
                            <p class="text-white/80 mb-2">R < 50%, MAPE > 30%, < 3 validation folds</p>
                            <ul class="text-xs text-white/70 space-y-1">
                                <li> Use for directional guidance only</li>
                                <li> Collect more data</li>
                                <li> Investigate data quality</li>
                                <li> Consider external factors</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </details>
            
            <!-- Limitations -->
            <details class="styled-details bg-white/5 rounded-lg">
                <summary class="font-semibold cursor-pointer p-4 text-lg text-red-300"> Understanding Limitations</summary>
                <div class="px-6 pb-6 space-y-4 text-sm">
                    <div class="p-4 bg-red-900/20 border border-red-500/30 rounded">
                        <h5 class="font-semibold text-red-300 mb-3">Important Assumptions</h5>
                        <ul class="space-y-2 text-white/80">
                            <li> <strong>Historical patterns continue:</strong> Future resembles the past</li>
                            <li> <strong>No major disruptions:</strong> Business environment remains stable</li>
                            <li> <strong>Data quality:</strong> Historical data accurately reflects reality</li>
                            <li> <strong>Model assumptions:</strong> Statistical model fits the underlying process</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-yellow-900/20 border border-yellow-500/30 rounded">
                        <h5 class="font-semibold text-yellow-300 mb-3">When Predictions May Fail</h5>
                        <ul class="space-y-2 text-white/80">
                            <li> Market disruptions (economic crashes, pandemics)</li>
                            <li> Technology shifts (digital transformation)</li>
                            <li> Regulatory changes (new laws, policies)</li>
                            <li> Competitive landscape changes (new entrants)</li>
                            <li> Consumer behavior shifts (changing preferences)</li>
                        </ul>
                    </div>
                </div>
            </details>
            
            <!-- Best Practices -->
            <div class="bg-black/20 p-6 rounded-lg">
                <h4 class="text-lg font-bold mb-4 text-purple-300"> Best Practices for Success</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                    <div>
                        <h5 class="font-semibold text-blue-300 mb-3">Before Analysis</h5>
                        <ul class="space-y-1 text-white/80">
                            <li> Clean and validate your data</li>
                            <li> Ensure consistent time intervals</li>
                            <li> Document any known business changes</li>
                            <li> Remove or explain outliers</li>
                            <li> Verify data accuracy</li>
                        </ul>
                    </div>
                    <div>
                        <h5 class="font-semibold text-green-300 mb-3">After Analysis</h5>
                        <ul class="space-y-1 text-white/80">
                            <li> Review model diagnostics carefully</li>
                            <li> Consider external factors not in data</li>
                            <li> Plan for multiple scenarios</li>
                            <li> Monitor actual vs. predicted regularly</li>
                            <li> Update forecasts with new data</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center p-4 bg-black/20 rounded-lg border border-white/10">
                <p class="text-xs text-white/60">
                    Predictive analysis is a powerful tool for data-driven decision making. Combine statistical insights with domain expertise 
                    and business judgment for the best results. Always consider the context and limitations of your predictions.
                </p>
            </div>
        </div>
    `;
}

/**
 * Handles the DEMATEL analysis request.
 * --- THIS IS THE "REAL" VERSION - v2 ---
 * Step 1: Gets user text and sends it to OLLAMA with a highly-structured,
 * "chain-of-thought" prompt to force accurate factor/matrix generation.
 * Step 2: Sends the OLLAMA result to our Python backend for math.
 * Step 3: Renders the final result from the Python backend.
 */
async function handleDematelAnalysis() {
    const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
    const PYTHON_BACKEND_URL = "https://analysis.sageaios.com/api/dematel";
    const MODEL_NAME = "llama3.1:latest"; 

    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div></div><div></div><div></div></div><h3 class="text-xl font-semibold text-white">Starting DEMATEL Analysis...</h3><p class="text-white/80 mb-2">Please wait...</p></div>`;
    
    const textInput = $("dematelContent");
    const fileInput = $("dematelFile");
    const textError = $("dematelTextError");
    const fileError = $("dematelFileError");
    
    textError.textContent = "";
    fileError.textContent = "";

    try {
        setLoading("generate", true); 
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div></div><div></div><div></div></div><h3 class="text-xl font-semibold text-white">Step 1/3: Reading and Understanding Text...</h3><p class="text-white/80 mb-2">Extracting key factors from your document...</p></div>`;

        // 2. Get User Text (from sample, file, or text)
        let userText = "";
        if (window.isSampleModeActive === true) {
            // --- SAMPLE MODE ---
            console.log(" DEMATEL Sample mode active");
            
            try {
                const file = await fetchFileAsObject('dematel/dematel-sample-doc.txt');
                if (!file) throw new Error("Sample file not found.");
                
                console.log(" Sample DEMATEL file loaded:", file.name);
                
                // For .txt files, read directly as text instead of using extractTextFromFile
                if (file.name.toLowerCase().endsWith('.txt')) {
                    userText = await file.text();
                    console.log(" Read .txt file directly");
                } else {
                    // For other file types, use the extractTextFromFile function
                    userText = await extractTextFromFile(file);
                    console.log(" Used extractTextFromFile function");
                }
                
                console.log(" Sample text loaded, length:", userText.length);
                
            } catch (fileError) {
                console.error(" Error loading DEMATEL sample file:", fileError);
                throw new Error(`DEMATEL sample file loading failed: ${fileError.message}`);
            }
            
        } else {
            // --- MANUAL MODE ---
            console.log(" DEMATEL Manual mode - reading from UI");
            
            const isFileInput = $("dematelInputFileToggle").checked;
            if (isFileInput) { 
                const file = fileInput.files[0]; 
                if (!file) throw new Error("Please select a .txt or .docx file.");
                
                // Handle .txt files directly, use extractTextFromFile for others
                if (file.name.toLowerCase().endsWith('.txt')) {
                    userText = await file.text();
                } else {
                    userText = await extractTextFromFile(file);
                }
            } else {
                userText = textInput.value.trim();
                if (!userText) throw new Error("Please enter a system or problem description.");
            }
        }
        
        // Validate that we have text
        if (!userText || userText.trim().length === 0) {
            throw new Error("No text content found in the file or input.");
        }
        
        console.log(" Final DEMATEL text length:", userText.length);

        // 3. --- STEP 1: CALL OLLAMA ---
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div></div><div></div><div></div></div><h3 class="text-xl font-semibold text-white">Step 2/3: Generating Influence Matrix...</h3><p class="text-white/80 mb-2">AI is quantifying the causal relationships (this may take a moment)...</p></div>`;

        const prompt = `
            You are a meticulous DEMATEL analyst. Your task is to perform a rigorous analysis of the provided text.

            **USER TEXT:**
            """
            ${userText}
            """

            **YOUR TASKS (Follow this order):**

            **TASK 1: Extract Factors**
            First, carefully read the text and identify the key named factors. List them.
            *Example:*
            * Factors: ["Factor 1", "Factor 2", "Factor 3"]

            **TASK 2: Analyze Relationships (Chain of Thought)**
            Second, think step-by-step. For each *pair* of factors, analyze the influence from the row factor to the column factor.
            - Use this scale ONLY: 0=No, 1=Low, 2=Moderate, 3=Strong, 4=Very Strong.
            - You MUST justify your rating with a quote or direct inference from the text.
            - If the text does not describe an influence, the rating MUST be 0.
            
            *Example of thinking process:*
            * (Factor 1 -> Factor 1): 0 (Self-influence is zero)
            * (Factor 1 -> Factor 2): Rating 3 (Strong). Justification: The text states "Factor 1 strongly influences Factor 2."
            * (Factor 1 -> Factor 3): Rating 0. Justification: The text does not mention any relationship.
            * (Factor 2 -> Factor 1): Rating 1 (Low). Justification: The text implies "Factor 2 has some small impact on Factor 1."
            * ... (continue for all pairs)

            **TASK 3: Create Final JSON**
            Finally, use your step-by-step analysis to build the final JSON object.
            - The "factors" list must match the factors you identified.
            - The "matrix" must be an N x N matrix corresponding to your justified ratings.
            - The matrix row/column order MUST match the factor list order.

            You must return ONLY the valid JSON object. Do not add any other text or explanations outside the JSON structure.

            **JSON FORMAT:**
            {
              "factors": [
                "Factor Name 1",
                "Factor Name 2",
                "..."
              ],
              "matrix": [
                [0, 3, 0, ...], 
                [1, 0, 0, ...],
                [...],
                ...
              ]
            }
        `;

        console.log(" Sending request to Ollama...");

        const ollamaResponse = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json" })
        });

        if (!ollamaResponse.ok) {
            throw new Error(`Ollama AI server error: ${ollamaResponse.statusText}`);
        }

        const ollamaResult = await ollamaResponse.json();
        console.log(" Received response from Ollama");
        
        let aiData;
        try {
            aiData = JSON.parse(ollamaResult.response);
            if (!aiData.factors || !aiData.matrix || !Array.isArray(aiData.factors) || !Array.isArray(aiData.matrix)) {
                throw new Error("AI response missing 'factors' or 'matrix' key, or they are not arrays.");
            }
            if (aiData.factors.length !== aiData.matrix.length) {
                throw new Error("AI returned a matrix size that does not match the factors list.");
            }
            console.log(" AI response validated successfully");
        } catch (e) {
            console.error("Failed to parse AI response:", ollamaResult.response);
            throw new Error(`AI returned invalid JSON. Error: ${e.message}`);
        }

        // 4. --- STEP 2: CALL PYTHON BACKEND ---
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div></div><div></div><div></div></div><h3 class="text-xl font-semibold text-white">Step 3/3: Calculating DEMATEL Mathematics...</h3><p class="text-white/80 mb-2">Running matrix calculations and generating insights...</p></div>`;
        
        const backendFormData = new FormData();
        backendFormData.append("analysis_type", "dematel");
        backendFormData.append("dematel_factors", JSON.stringify(aiData.factors));
        backendFormData.append("dematel_matrix", JSON.stringify(aiData.matrix));

        console.log(" Sending request to Python backend...");

        const backendResponse = await fetch(PYTHON_BACKEND_URL, {
            method: "POST",
            body: backendFormData,
        });

        if (!backendResponse.ok) {
            let errorDetail = `Python Backend Error: ${backendResponse.statusText}`;
            try {
                const errorData = await backendResponse.json();
                errorDetail = errorData.detail || `Python Backend Error: ${backendResponse.statusText}`;
            } catch (e) {}
            throw new Error(errorDetail);
        }

        // 5. Process Final Response
        const finalResults = await backendResponse.json();
        console.log(" Received response from Python backend");

        if (finalResults.analysis_insights && finalResults.chart_data) {
            console.log(" DEMATEL analysis successful, rendering results...");
            renderDematelAnalysisPage(finalResults);
        } else {
             throw new Error("Received an invalid response from the Python backend.");
        }

    } catch (error) {
        console.error("DEMATEL Analysis Error:", error);
        const errorMessage = error.message || "An unknown error occurred.";
        
        analysisResultContainer.innerHTML = `<div class="error-message">${errorMessage}</div>`;
        
        // Show error in the correct UI element
        if (window.isSampleModeActive || $("dematelInputFileToggle").checked) {
            fileError.textContent = errorMessage;
        } else {
            textError.textContent = errorMessage;
        }

    } finally {
        window.isSampleModeActive = false; // Reset the flag
        // 6. Reset loading state
        setLoading("generate", false);
    }
}

/**
 * Renders the full DEMATEL analysis page from the backend results.
 * --- UPDATED ---
 * This function now includes a smarter tab-switching logic
 * that calls the chart rendering function *only when* the
 * diagram tab is clicked, solving the visibility issue.
 * @param {object} data - The full JSON response from the backend.
 */
function renderDematelAnalysisPage(data) {
    const container = $("analysisResult");
    if (!container) return;

    container.innerHTML = ""; // Clear loading state

    // --- Create Tab Navigation (5 Tabs) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active py-3 px-5 text-white font-medium border-b-2 border-indigo-400 transition" data-tab="summary"> Summary & Insights</button>
        <button class="analysis-tab-btn py-3 px-5 text-white/60 hover:text-white border-b-2 border-transparent transition" data-tab="diagram"> Causal Diagram</button>
        <button class="analysis-tab-btn py-3 px-5 text-white/60 hover:text-white border-b-2 border-transparent transition" data-tab="metrics"> Metrics & Matrix</button>
        <button class="analysis-tab-btn py-3 px-5 text-white/60 hover:text-white border-b-2 border-transparent transition" data-tab="diagnostics"> Diagnostics</button>
        <button class="analysis-tab-btn py-3 px-5 text-white/60 hover:text-white border-b-2 border-transparent transition" data-tab="learn"> Learn DEMATEL</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (5 Panels) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dematelSummaryPanel" class="analysis-tab-panel active p-6"></div>
        <div id="dematelDiagramPanel" class="analysis-tab-panel p-6"></div>
        <div id="dematelMetricsPanel" class="analysis-tab-panel p-6"></div>
        <div id="dematelDiagnosticsPanel" class="analysis-tab-panel p-6"></div>
        <div id="dematelLearnPanel" class="analysis-tab-panel p-6"></div>
    `;

    // --- Populate Each Tab ---
    renderDematelSummaryTab("dematelSummaryPanel", data);
    renderDematelDiagramTab("dematelDiagramPanel", data); // This just creates the placeholder
    renderDematelMetricsTab("dematelMetricsPanel", data);
    renderDematelDiagnosticsTab("dematelDiagnosticsPanel", data.diagnostics);
    renderLearnDematelTab("dematelLearnPanel");

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache the new HTML
    $("analysisActions").classList.remove("hidden"); // Show save buttons

    // --- UPDATED: Tab Switching Logic ---
    // This logic now *replaces* the reattachTabListeners call for this specific tool.
    const allTabButtons = tabNav.querySelectorAll(".analysis-tab-btn");
    const allTabPanels = tabContent.querySelectorAll(".analysis-tab-panel");
    let chartRendered = false; // Flag to prevent re-rendering

    allTabButtons.forEach(button => {
        button.addEventListener("click", (e) => {
            const clickedTab = e.currentTarget;
            if (!clickedTab || clickedTab.classList.contains("active")) return;

            // Deactivate all
            allTabButtons.forEach((btn) => {
                btn.classList.remove("active", "text-white", "font-medium", "border-indigo-400");
                btn.classList.add("text-white/60", "hover:text-white", "border-transparent");
            });
            allTabPanels.forEach((pnl) => pnl.classList.remove("active"));

            // Activate clicked tab
            clickedTab.classList.add("active", "text-white", "font-medium", "border-indigo-400");
            clickedTab.classList.remove("text-white/70", "hover:text-white", "border-transparent");
            
            // Activate corresponding panel
            const targetPanelId = "dematel" + clickedTab.dataset.tab.charAt(0).toUpperCase() + clickedTab.dataset.tab.slice(1) + "Panel";
            const targetPanel = $(targetPanelId);
            
            if (targetPanel) {
                targetPanel.classList.add("active");
                
                // --- THIS IS THE FIX ---
                // If the user clicked the "diagram" tab and the chart hasn't been rendered yet...
                if (clickedTab.dataset.tab === "diagram" && !chartRendered) {
                    // We call the render function *now*, while the tab is visible.
                    setTimeout(() => { // Use a tiny timeout to ensure the panel is fully visible
                        renderDematelChart(data.chart_data);
                        chartRendered = true; // Set flag so we don't render it again
                    }, 50);
                } 
                // If the chart *has* been rendered, just resize it
                else if (clickedTab.dataset.tab === "diagram") {
                     setTimeout(() => {
                        const chartDiv = $("dematel-chart-container");
                        if (chartDiv && chartDiv.layout && typeof Plotly !== 'undefined') {
                            try { Plotly.Plots.resize(chartDiv); } catch (e) { console.error("Resize error:", e); }
                        }
                    }, 50);
                }
                // --- END OF FIX ---
            }
        });
    });

    // --- Initial Chart Render ---
    // This is no longer needed because the Summary tab is active by default,
    // and the chart will be rendered when the user clicks the Diagram tab.
    // setTimeout(() => { ... }, 200);
}

/**
 * Updated renderDematelDiagramTab function with proper container sizing
 */
function renderDematelDiagramTab(containerId, data) {
    const container = $(containerId);
    if (!container) return;

    container.innerHTML = `
        <h3 class="result-subheader text-2xl font-bold text-center mb-4">Causal Influence Diagram</h3>
        <p class="text-white/70 mb-6 text-center mx-auto max-w-3xl">This diagram visualizes the relationships. Factors are plotted by their Prominence (importance) and Relation (cause/effect).</p>
        
        <!-- Fixed chart container with proper sizing -->
        <div class="w-full mb-6">
            <div id="dematel-chart-container" class="w-full bg-black/10 rounded-lg border border-white/10" style="height: 600px; min-height: 600px;">
                <p class="text-white/60 flex items-center justify-center h-full">Chart will render when this tab is active...</p>
            </div>
        </div>
        
        <div class="chart-interpretation mx-auto bg-black/20 p-4 rounded-lg border border-white/10">
            <strong class="text-white">How to Read:</strong>
            <ul class="list-disc list-inside text-sm mt-2 space-y-1 text-white/80">
                <li><strong>Quadrant Lines:</strong> The chart is divided into four quadrants by a horizontal line (at 0) and a vertical line (at the average prominence).</li>
                <li><strong>Horizontal Axis (Prominence):</strong> Factors to the right are more important/central to the system.</li>
                <li><strong>Vertical Axis (Relation):</strong> Factors in the top-half (positive) are 'Cause' factors (net drivers). Factors in the bottom-half (negative) are 'Effect' factors (net receivers).</li>
            </ul>
        </div>
    `;
}

/**
     * Renders the Summary & Insights tab for DEMATEL.
     * --- UPDATED ---
     * Checks for a "fail" status in the diagnostics data
     * and directs the user to the Diagnostics tab.
     */
    function renderDematelSummaryTab(containerId, data) {
        const container = $(containerId);
        if (!container) return;

        // --- This code only runs if insights are valid ---
        let insights_html = "";
        const insights = data.analysis_insights || [];
        const centralInsight = insights.find(i => i.observation.includes("most central"));
        const causeInsight = insights.find(i => i.observation.includes("'Cause' factor"));
        const effectInsight = insights.find(i => i.observation.includes("'Effect' factor"));
        const centralFactorName = centralInsight ? centralInsight.observation.split(":")[0].replace(/\*\*/g, '').trim() : null;
        const effectFactorName = effectInsight ? effectInsight.observation.split(":")[0].replace(/\*\*/g, '').trim() : null;
        const isCentralAlsoEffect = centralInsight && effectInsight && centralFactorName === effectFactorName;

        if (centralInsight) {
            let interpretation = centralInsight.interpretation;
            if (isCentralAlsoEffect) {
                interpretation += `<br/><strong>Causal Role:</strong> This factor is also the system's primary <strong>'Effect' factor</strong> (net receiver).`;
            }
            insights_html += `
            <div class="insight-card-detailed border-l-4 border-yellow-500 bg-black/20 p-4 rounded-lg shadow-lg mb-4">
                <h5 class="text-lg font-semibold">${centralInsight.observation}</h5>
                <p class="text-sm text-white/80 mt-2 pl-2"><strong>Interpretation:</strong> ${interpretation}</p>
                <p class="text-sm text-white/90 mt-2 pl-2"><strong>Recommendation:</strong> ${centralInsight.recommendation}</p>
            </div>`;
        }
        if (causeInsight) {
            insights_html += `
            <div class="insight-card-detailed border-l-4 border-blue-500 bg-black/20 p-4 rounded-lg shadow-lg mb-4">
                <h5 class="text-lg font-semibold">${causeInsight.observation}</h5>
                <p class="text-sm text-white/80 mt-2 pl-2"><strong>Interpretation:</strong> ${causeInsight.interpretation}</p>
                <p class="text-sm text-white/90 mt-2 pl-2"><strong>Recommendation:</strong> ${causeInsight.recommendation}</p>
            </div>`;
        }
        if (effectInsight && !isCentralAlsoEffect) {
            insights_html += `
            <div class="insight-card-detailed border-l-4 border-red-500 bg-black/20 p-4 rounded-lg shadow-lg mb-4">
                <h5 class="text-lg font-semibold">${effectInsight.observation}</h5>
                <p class="text-sm text-white/80 mt-2 pl-2"><strong>Interpretation:</strong> ${effectInsight.interpretation}</p>
                <p class="text-sm text-white/90 mt-2 pl-2"><strong>Recommendation:</strong> ${effectInsight.recommendation}</p>
            </div>`;
        }

        let cause_group_html = "<div class='space-y-2'>";
        if (data.cause_group && data.cause_group.length > 0) {
            data.cause_group.forEach(row => {
                cause_group_html += `
                <div class='p-2 bg-blue-900/20 rounded border border-blue-500/30'>
                    <span class='font-semibold'>${row['Factor']}</span>
                    <span class='text-xs float-right text-blue-300' style="margin-top: 4px;">Net Influence: +${row['Relation (D-R)'].toFixed(3)}</span>
                </div>
                `;
            });
        } else {
            cause_group_html += "<p class='text-sm text-white/60 italic'>No cause factors identified.</p>";
        }
        cause_group_html += "</div>";

        let effect_group_html = "<div class='space-y-2'>";
        if (data.effect_group && data.effect_group.length > 0) {
            data.effect_group.forEach(row => {
                if (!(isCentralAlsoEffect && row['Factor'] === centralFactorName)) {
                    effect_group_html += `
                    <div class='p-2 bg-red-900/20 rounded border border-red-500/30'>
                        <span class='font-semibold'>${row['Factor']}</span>
                        <span class='text-xs float-right text-red-300' style="margin-top: 4px;">Net Receiver: ${row['Relation (D-R)'].toFixed(3)}</span>
                    </div>
                    `;
                }
            });
             if (effect_group_html === "<div class='space-y-2'>") {
                 effect_group_html += "<p class='text-sm text-white/60 italic'>No other effect factors identified.</p>";
            }
        } else {
            effect_group_html += "<p class='text-sm text-white/60 italic'>No effect factors identified.</p>";
        }
        effect_group_html += "</div>";

        container.innerHTML = `
            <h3 class="result-subheader">Key Insights</h3>
            <div class="insights-container space-y-4">
                ${insights_html}
            </div>
            
            <h3 class="result-subheader mt-8">Causal Groups</h3>
            <div class="cause-effect-container grid grid-cols-1 gap-6">
                <div>
                    <h4 class="result-subheader text-blue-300">Cause Group (Drivers)</h4>
                    ${cause_group_html}
                </div>
                <div>
                    <h4 class="result-subheader text-red-300">Effect Group (Outcomes)</h4>
                    ${effect_group_html}
                </div>
            </div>
        `;
    }

/**
     * Renders the Metrics & Matrix tab.
     * --- UPDATED ---
     * Checks for a "fail" status in the diagnostics data
     * and shows an error message instead of tables.
     */
    function renderDematelMetricsTab(containerId, data) {
        const container = $(containerId);
        if (!container) return;

        // --- This code only runs if data is valid ---
        let summaryTableHtml = "";
        let matrixTableHtml = "";
        const summaryData = data.summary_table || [];
        const matrixData = data.total_relation_matrix || [];
        const factors = data.raw_data ? data.raw_data.factors : [];

        // Build Summary Table HTML
        if (summaryData.length > 0) {
            const avgProminence = summaryData.reduce((sum, row) => sum + row['Prominence (D+R)'], 0) / summaryData.length;
            
            summaryTableHtml = `<div class="overflow-x-auto"><table class="coeff-table styled-table text-sm">
                <thead><tr>
                    <th>Factor</th>
                    <th>D (Influence Given)</th>
                    <th>R (Influence Received)</th>
                    <th>Prominence (D+R)</th>
                    <th>Relation (D-R)</th>
                </tr></thead>
                <tbody>`;
            
            summaryData.forEach(row => {
                const prominenceClass = row['Prominence (D+R)'] > avgProminence ? 'font-bold text-yellow-300' : '';
                let relationClass = 'text-white/70';
                if (row['Relation (D-R)'] > 0.1) relationClass = 'font-medium text-blue-300'; // Cause
                if (row['Relation (D-R)'] < -0.1) relationClass = 'font-medium text-red-300'; // Effect

                summaryTableHtml += `
                    <tr>
                        <td class="font-semibold">${row['Factor']}</td>
                        <td>${row['D (Influence Given)'].toFixed(4)}</td>
                        <td>${row['R (Influence Received)'].toFixed(4)}</td>
                        <td class="${prominenceClass}">${row['Prominence (D+R)'].toFixed(4)}</td>
                        <td class="${relationClass}">${row['Relation (D-R)'].toFixed(4)}</td>
                    </tr>
                `;
            });
            summaryTableHtml += `</tbody></table></div>`;
        } else {
            summaryTableHtml = "<p class='text-white/70'>Summary table data is missing.</p>";
        }

        // Build Total Relation Matrix HTML
        if (matrixData.length > 0 && factors.length > 0) {
            let sum = 0;
            let count = 0;
            matrixData.forEach(row => row.forEach(cell => {
                if (cell > 0) {
                    sum += cell;
                    count++;
                }
            }));
            const avgInfluence = (count > 0) ? (sum / count) : 0.1;

            matrixTableHtml = `<div class="overflow-x-auto"><table class="coeff-table styled-table text-sm dematel-matrix">
                <thead><tr><th class="bg-black/10">Influencer  | Influenced </th>`;
            
            factors.forEach(factor => {
                matrixTableHtml += `<th>${factor}</th>`;
            });
            matrixTableHtml += `</tr></thead><tbody>`;

            matrixData.forEach((row, index) => {
                matrixTableHtml += `<tr><th class="font-semibold">${factors[index]}</th>`;
                row.forEach(cell => {
                    const cellClass = cell > avgInfluence ? 'font-bold text-yellow-300' : 'text-white/7Two';
                    matrixTableHtml += `<td class="${cellClass}">${cell.toFixed(4)}</td>`;
                });
                matrixTableHtml += `</tr>`;
            });
            matrixTableHtml += `</tbody></table></div>`;
        } else {
            matrixTableHtml = "<p class='text-white/70'>Total relation matrix data is missing.</p>";
        }

        // Assemble Final Tab HTML
        container.innerHTML = `
            <h3 class="result-subheader">Factor Summary (D+R, D-R)</h3>
            <p class="text-white/70 mb-4">This table quantifies each factor's role. 
                <strong>Prominence (D+R)</strong> = Total Importance. 
                <strong>Relation (D-R)</strong> = Causal Role (<strong>+</strong> is Cause, <strong>-</strong> is Effect).
            </p>
            <div class="table-container mb-8">
                ${summaryTableHtml}
            </div>
            
            <h3 class="result-subheader">Total Relation Matrix (T)</h3>
            <p class="text-white/70 mb-4">This matrix shows the total (direct + indirect) influence. 
                Read as: <strong>Row Factor</strong>  <strong>Column Factor</strong>. 
                Values above the average influence (approx. ${matrixData.length > 0 ? (matrixData.flat().reduce((a,b)=>a+b,0) / (matrixData.length*matrixData.length)).toFixed(3) : '0.1'}) are highlighted.
            </p>
            <div class="table-container">
                ${matrixTableHtml}
            </div>
            
            <div class="chart-interpretation mt-6 max-w-none mx-auto bg-black/20 p-4 rounded-lg border border-white/10">
                <strong>How to Read the Matrix:</strong>
                <ul class="list-disc list-inside text-sm mt-2 space-y-1">
                    <li><strong>What does a "zero row" mean?</strong> (e.g., "Customer Service" or "Price Competitiveness" in the test data). This is <strong>correct</strong> and means the factor is a <strong>"pure effect"</strong>. It does not influence any other factors in the system.</li>
                    <li><strong>What does a "zero column" mean?</strong> This would mean the factor is a <strong>"pure cause"</strong> and is not influenced by any other factor (this is very rare).</li>
                    <li><strong>Highlighted Values:</strong> These are the strongest causal relationships in your system. They represent the primary pathways of influence.</li>
                </ul>
            </div>
        `;
    }

/**
 * Renders the comprehensive Diagnostics tab with enhanced data quality assessment.
 * --- FULL ENHANCED VERSION ---
 * Detects critical issues like mathematical instability, extreme values, and poor data quality.
 * Provides specific guidance for fixing common problems.
 */
function renderDematelDiagnosticsTab(containerId, diagnostics) {
    const container = $(containerId);
    if (!container) return;

    // Enhanced diagnostic analysis with specific checks for bad data
    let overallStatus = "good";
    let criticalIssues = 0;
    let warningIssues = 0;
    let mathematicalInstability = false;
    let extremeValues = false;
    let poorDataQuality = false;
    
    // Check for mathematical instability (astronomical values)
    if (diagnostics && diagnostics.statistics) {
        const stats = diagnostics.statistics;
        
        // Check for extreme prominence values (indicates mathematical overflow)
        if (stats.max_prominence && parseFloat(stats.max_prominence) > 1000) {
            mathematicalInstability = true;
            criticalIssues++;
            overallStatus = "critical";
        }
        
        // Check for AI scale violations
        if (stats.ai_max_value && parseFloat(stats.ai_max_value) > 4) {
            poorDataQuality = true;
            criticalIssues++;
            overallStatus = "critical";
        }
        
        // Check for extreme matrix density
        if (stats.matrix_density && parseFloat(stats.matrix_density) > 90) {
            poorDataQuality = true;
            if (overallStatus !== "critical") overallStatus = "warning";
            warningIssues++;
        }
    }

    // Analyze diagnostic checks
    if (diagnostics && diagnostics.checks) {
        diagnostics.checks.forEach(check => {
            if (check.status === 'fail') {
                criticalIssues++;
                overallStatus = "critical";
                
                // Detect specific failure types
                if (check.metric === 'Model Stability') {
                    mathematicalInstability = true;
                }
                if (check.metric === 'AI Scale Adherence') {
                    poorDataQuality = true;
                }
            } else if (check.status === 'warn') {
                warningIssues++;
                if (overallStatus !== "critical") overallStatus = "warning";
            }
        });
    }

    // Generate enhanced status summary
    let statusHtml = "";
    let statusClass = "";
    let statusIcon = "";
    let actionableAdvice = "";
    
    if (overallStatus === "critical") {
        statusClass = "bg-red-900/40 border-red-500/60 text-red-200";
        statusIcon = "";
        
        if (mathematicalInstability) {
            statusHtml = `<strong>MATHEMATICAL INSTABILITY DETECTED</strong> - The calculations have failed due to extreme values.`;
            actionableAdvice = `This usually means your input described relationships that are too strong or contradictory. Try simplifying your system description.`;
        } else if (poorDataQuality) {
            statusHtml = `<strong>POOR DATA QUALITY DETECTED</strong> - The AI misunderstood your input or used extreme values.`;
            actionableAdvice = `Try rewriting your description with clearer intensity words like "strongly influences" or "has moderate impact on."`;
        } else {
            statusHtml = `<strong>CRITICAL ISSUES DETECTED</strong> - The analysis has significant problems that affect reliability.`;
            actionableAdvice = `Please review the detailed checks below and consider revising your input data.`;
        }
    } else if (overallStatus === "warning") {
        statusClass = "bg-yellow-900/40 border-yellow-500/60 text-yellow-200";
        statusIcon = "";
        statusHtml = `<strong>WARNINGS PRESENT</strong> - The analysis has some issues that may affect interpretation.`;
        actionableAdvice = `The results are usable but could be improved with better input data.`;
    } else {
        statusClass = "bg-green-900/40 border-green-500/60 text-green-200";
        statusIcon = "";
        statusHtml = `<strong>ANALYSIS LOOKS GOOD</strong> - No major issues detected with the model.`;
        actionableAdvice = `Your results should be reliable and actionable.`;
    }

    // Enhanced checks with comprehensive explanations
    let checksHtml = "";
    if (diagnostics && diagnostics.checks && diagnostics.checks.length > 0) {
        // Sort checks: fail, warn, pass
        const levelOrder = { "fail": 1, "warn": 2, "pass": 3, "success": 3 };
        diagnostics.checks.sort((a, b) => (levelOrder[a.status] || 4) - (levelOrder[b.status] || 4));

        diagnostics.checks.forEach(check => {
            let statusClass = "text-blue-300"; 
            let icon = "";
            let recommendation = "";
            let severity = "";
            
            if (check.status === 'fail') {
                statusClass = "text-red-300";
                icon = "";
                severity = "CRITICAL";
                
                // Enhanced recommendations for specific failures
                if (check.metric === 'AI Scale Adherence') {
                    recommendation = `
                        <div class="mt-3 p-3 bg-red-900/30 rounded-lg text-xs border border-red-500/30">
                            <div class="font-medium text-red-200 mb-2"> How to Fix This:</div>
                            <div class="space-y-1 text-red-100">
                                <div> <strong>Use specific intensity words:</strong> "strongly influences", "moderately affects", "weakly impacts"</div>
                                <div> <strong>Avoid extreme language:</strong> Instead of "completely controls" use "strongly influences"</div>
                                <div> <strong>Be more explicit:</strong> Instead of "affects" use "has a moderate impact on"</div>
                                <div> <strong>Review your relationships:</strong> Make sure they're realistic, not maximum intensity</div>
                            </div>
                        </div>
                    `;
                } else if (check.metric === 'Model Stability') {
                    recommendation = `
                        <div class="mt-3 p-3 bg-red-900/30 rounded-lg text-xs border border-red-500/30">
                            <div class="font-medium text-red-200 mb-2"> How to Fix This:</div>
                            <div class="space-y-1 text-red-100">
                                <div> <strong>Simplify your system:</strong> Focus on 3-7 key factors instead of many</div>
                                <div> <strong>Avoid circular logic:</strong> Don't make AB and BA equally strong</div>
                                <div> <strong>Reduce over-connectivity:</strong> Not everything should influence everything</div>
                                <div> <strong>Use varied intensities:</strong> Mix strong, moderate, and weak relationships</div>
                            </div>
                        </div>
                    `;
                }
            } else if (check.status === 'warn') {
                statusClass = "text-yellow-300";
                icon = "";
                severity = "WARNING";
                
                if (check.metric === 'Matrix Density') {
                    recommendation = `
                        <div class="mt-3 p-3 bg-yellow-900/30 rounded-lg text-xs border border-yellow-500/30">
                            <div class="font-medium text-yellow-200 mb-2"> Suggestion:</div>
                            <div class="space-y-1 text-yellow-100">
                                <div> <strong>Focus on key relationships:</strong> Describe only the most important connections</div>
                                <div> <strong>Use "little to no impact":</strong> For weak relationships instead of ignoring them</div>
                                <div> <strong>Consider system boundaries:</strong> Maybe some factors should be external</div>
                            </div>
                        </div>
                    `;
                } else if (check.metric === 'Low Factor Count') {
                    recommendation = `
                        <div class="mt-3 p-3 bg-yellow-900/30 rounded-lg text-xs border border-yellow-500/30">
                            <div class="font-medium text-yellow-200 mb-2"> Suggestion:</div>
                            <div class="space-y-1 text-yellow-100">
                                <div> <strong>Add more factors:</strong> Try to identify 4-7 key factors for better analysis</div>
                                <div> <strong>Break down broad factors:</strong> "Performance" could become "Speed" + "Quality"</div>
                                <div> <strong>Consider sub-components:</strong> What are the parts of your main factors?</div>
                            </div>
                        </div>
                    `;
                }
            } else if (check.status === 'pass' || check.status === 'success') {
                statusClass = "text-green-300";
                icon = "";
                severity = "PASS";
            }

            checksHtml += `
                <tr class="border-b border-white/10">
                    <td class="p-4">
                        <div class="flex items-center">
                            <span class="${statusClass} text-lg mr-2">${icon}</span>
                            <div>
                                <div class="font-semibold text-white">${check.metric}</div>
                                <div class="text-xs ${statusClass} font-medium">${severity}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="text-white/90">${check.message || 'No message provided.'}</div>
                        ${recommendation}
                    </td>
                </tr>
            `;
        });
    } else {
        checksHtml = "<tr><td colspan='2' class='p-4 text-white/70 text-center'>No diagnostic checks were generated.</td></tr>";
    }

    // Enhanced statistics with critical value detection
    let statsHtml = "";
    if (diagnostics && diagnostics.statistics) {
        const stats = diagnostics.statistics;
        
        // AI Max Value with enhanced interpretation
        let aiValueInterpretation = "";
        let aiValueClass = "text-white/80";
        const aiMax = parseFloat(stats.ai_max_value) || 0;
        if (aiMax > 4) {
            aiValueInterpretation = `<div class="text-xs text-red-300 mt-1 font-medium"> CRITICAL: Outside 0-4 scale</div>`;
            aiValueClass = "text-red-300";
        } else if (aiMax === 0) {
            aiValueInterpretation = `<div class="text-xs text-yellow-300 mt-1"> No relationships detected</div>`;
            aiValueClass = "text-yellow-300";
        } else {
            aiValueInterpretation = `<div class="text-xs text-green-300 mt-1"> Within expected range</div>`;
            aiValueClass = "text-green-300";
        }
        
        // Stability with interpretation
        let stabilityInterpretation = "";
        let stabilityClass = "text-white/80";
        const stability = parseFloat(stats.max_norm_row_sum) || 0;
        if (stability > 5) {
            stabilityInterpretation = `<div class="text-xs text-red-300 mt-1 font-medium"> UNSTABLE</div>`;
            stabilityClass = "text-red-300";
        } else if (stability > 2) {
            stabilityInterpretation = `<div class="text-xs text-yellow-300 mt-1"> Borderline</div>`;
            stabilityClass = "text-yellow-300";
        } else {
            stabilityInterpretation = `<div class="text-xs text-green-300 mt-1"> Stable</div>`;
            stabilityClass = "text-green-300";
        }
        
        // Matrix Density with enhanced interpretation
        let densityInterpretation = "";
        let densityClass = "text-white/80";
        const density = parseFloat(stats.matrix_density) || 0;
        if (density >= 100) {
            densityInterpretation = `<div class="text-xs text-red-300 mt-1 font-medium"> TOTAL CONNECTIVITY</div>`;
            densityClass = "text-red-300";
        } else if (density > 80) {
            densityInterpretation = `<div class="text-xs text-yellow-300 mt-1"> Over-connected</div>`;
            densityClass = "text-yellow-300";
        } else if (density < 20) {
            densityInterpretation = `<div class="text-xs text-blue-300 mt-1"> Sparse system</div>`;
            densityClass = "text-blue-300";
        } else {
            densityInterpretation = `<div class="text-xs text-green-300 mt-1"> Good balance</div>`;
            densityClass = "text-green-300";
        }
        
        // Cause Factors interpretation
        let causeInterpretation = "";
        let causeClass = "text-white/80";
        const causeCount = parseInt(stats.cause_factors_found) || 0;
        const totalFactors = parseInt(stats.total_factors) || parseInt(stats.factor_count) || 5;
        if (causeCount === 0) {
            causeInterpretation = `<div class="text-xs text-red-300 mt-1 font-medium"> No drivers found</div>`;
            causeClass = "text-red-300";
        } else if (causeCount === 1 && totalFactors > 4) {
            causeInterpretation = `<div class="text-xs text-yellow-300 mt-1"> Only one driver</div>`;
            causeClass = "text-yellow-300";
        } else if (causeCount === totalFactors) {
            causeInterpretation = `<div class="text-xs text-yellow-300 mt-1"> All are drivers</div>`;
            causeClass = "text-yellow-300";
        } else {
            causeInterpretation = `<div class="text-xs text-green-300 mt-1"> Good balance</div>`;
            causeClass = "text-green-300";
        }

        statsHtml = `
            <div class="summary-stat-card border-l-4 ${aiMax > 4 ? 'border-red-500' : aiMax === 0 ? 'border-yellow-500' : 'border-green-500'}">
                <div class="stat-value ${aiValueClass}">${stats.ai_max_value || 'N/A'}</div>
                <div class="stat-label">Max AI Value</div>
                <div class="text-xs text-white/60 mt-1">(Should be 0-4)</div>
                ${aiValueInterpretation}
            </div>
            <div class="summary-stat-card border-l-4 ${stability > 5 ? 'border-red-500' : stability > 2 ? 'border-yellow-500' : 'border-green-500'}">
                <div class="stat-value ${stabilityClass}">${stats.max_norm_row_sum || 'N/A'}</div>
                <div class="stat-label">Stability</div>
                <div class="text-xs text-white/60 mt-1">(Max Row Sum)</div>
                ${stabilityInterpretation}
            </div>
            <div class="summary-stat-card border-l-4 ${density >= 100 ? 'border-red-500' : density > 80 ? 'border-yellow-500' : 'border-green-500'}">
                <div class="stat-value ${densityClass}">${stats.matrix_density || 'N/A'}</div>
                <div class="stat-label">Matrix Density</div>
                <div class="text-xs text-white/60 mt-1">(% Connected)</div>
                ${densityInterpretation}
            </div>
            <div class="summary-stat-card border-l-4 ${causeCount === 0 ? 'border-red-500' : (causeCount === 1 && totalFactors > 4) ? 'border-yellow-500' : 'border-green-500'}">
                <div class="stat-value ${causeClass}">${stats.cause_factors_found || 'N/A'} / ${totalFactors}</div>
                <div class="stat-label">Cause Factors</div>
                <div class="text-xs text-white/60 mt-1">(Drivers Found)</div>
                ${causeInterpretation}
            </div>
        `;
    }

    // Enhanced Data Quality Tips section
    const dataQualityTips = `
        <div class="bg-gradient-to-r from-blue-900/20 to-purple-900/20 p-6 rounded-lg border border-blue-500/30 mt-8">
            <h5 class="text-xl font-semibold mb-4 text-blue-300 flex items-center">
                <span class="mr-2"></span> Complete Guide to Better DEMATEL Data
            </h5>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h6 class="font-semibold text-green-300 mb-2"> DO This:</h6>
                    <div class="space-y-2 text-sm text-white/80">
                        <div><strong>Use Specific Intensity Words:</strong><br>"strongly influences", "moderately affects", "weakly impacts", "has little effect on"</div>
                        <div><strong>Vary Relationship Strengths:</strong><br>Mix strong, moderate, and weak relationships realistically</div>
                        <div><strong>Explain WHY:</strong><br>"A influences B because..." gives AI better context</div>
                        <div><strong>Focus on Key Relationships:</strong><br>Describe the most important connections, not every possible one</div>
                        <div><strong>Use 3-7 Factors:</strong><br>This range gives the best analysis results</div>
                    </div>
                </div>
                
                <div>
                    <h6 class="font-semibold text-red-300 mb-2"> AVOID This:</h6>
                    <div class="space-y-2 text-sm text-white/80">
                        <div><strong>Everything is "Strong":</strong><br>Don't make all relationships maximum intensity</div>
                        <div><strong>Circular Logic:</strong><br>Avoid AB and BA with equal strength</div>
                        <div><strong>Vague Language:</strong><br>"affects", "impacts", "influences" without intensity</div>
                        <div><strong>"Everything affects everything":</strong><br>This creates mathematical instability</div>
                        <div><strong>Too Many Factors:</strong><br>8+ factors often lead to over-complexity</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-blue-900/30 rounded border border-blue-500/50">
                <h6 class="font-semibold text-blue-200 mb-2"> Example of Good Input:</h6>
                <div class="text-xs text-blue-100 font-mono">
                    "Product Quality <strong>strongly influences</strong> Customer Satisfaction because defects create complaints. 
                    Price <strong>moderately affects</strong> Sales Volume through demand elasticity. 
                    Marketing <strong>weakly impacts</strong> Product Quality since it doesn't change the actual product."
                </div>
            </div>
        </div>
    `;

    container.innerHTML = `
        <h3 class="result-subheader text-2xl font-bold">Model Diagnostics & Health Check</h3>
        <p class="text-white/70 mb-6">This tab analyzes the quality and reliability of your DEMATEL analysis to help you get better results.</p>
        
        <!-- Enhanced Overall Status Banner -->
        <div class="p-6 rounded-xl border-2 ${statusClass} mb-8 shadow-lg">
            <div class="flex items-start">
                <span class="text-3xl mr-4 mt-1">${statusIcon}</span>
                <div class="flex-1">
                    <div class="text-lg font-bold mb-2">${statusHtml}</div>
                    <div class="text-sm opacity-90 mb-3">${criticalIssues} critical issues, ${warningIssues} warnings detected</div>
                    <div class="text-sm font-medium">${actionableAdvice}</div>
                </div>
            </div>
        </div>

        <h4 class="text-xl font-semibold mb-4"> Model Statistics</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            ${statsHtml}
        </div>

        <h4 class="text-xl font-semibold mb-4"> Detailed Health Check Results</h4>
        <div class="overflow-x-auto mb-8">
            <table class="coeff-table styled-table text-sm w-full">
                <thead>
                    <tr>
                        <th class="w-1/3 text-left">Diagnostic Check</th>
                        <th class="w-2/3 text-left">Status & Recommendations</th>
                    </tr>
                </thead>
                <tbody>
                    ${checksHtml}
                </tbody>
            </table>
        </div>
        
        ${dataQualityTips}
    `;
}

/**
 * Renders the new "Learn DEMATEL" tab.
 * --- UPDATED ---
 * This version explains our AI-powered methodology, not the
 * manual, academic process, to build user trust and
 * clarify how the tool actually works.
 */
function renderLearnDematelTab(containerId) {
    const container = $(containerId);
    if (!container) return;

    // This is static content, but now it's accurate to our tool
    container.innerHTML = `
        <h3 class="text-3xl font-bold text-center mb-6"> Understanding Our AI-Powered DEMATEL Analysis</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2 text-indigo-300">What is DEMATEL?</h4>
                <p class="text-sm text-white/80">The <strong>DEMATEL</strong> method is a powerful tool used to analyze a complex system and understand the *causal relationships* between its parts.</p>
                <p class="text-sm text-white/80 mt-2">Its main goal is to separate factors into two simple groups:</p>
                <ul class="list-disc list-inside space-y-1 text-sm mt-2 pl-4">
                    <li><strong>'Cause' Factors (Drivers):</strong> The root factors that *influence* the rest of the system.</li>
                    <li><strong>'Effect' Factors (Outcomes):</strong> The factors that are *influenced by* others (the symptoms or results).</li>
                </ul>
            </div>
            
            <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2 text-indigo-300">How This Tool Works (Our Methodology)</h4>
                <p class="text-sm text-white/80">You don't need to be an expert. Our tool automates the hard parts:</p>
                <ol class="list-decimal list-inside space-y-2 text-sm mt-2 pl-4">
                    <li><strong>1. You Describe:</strong> You provide a natural language description of your system, its factors, and their relationships (e.g., "Factor A strongly influences Factor B").</li>
                    <li><strong>2. AI Analyzes:</strong> The AI (Llama 3.1) reads your text, identifies your key factors, and builds the complex "Direct Influence Matrix" for you, using a 0-4 scale based on your wording.</li>
                    <li><strong>3. You Validate:</strong> You check the AI's work in the "Preview" step to ensure it understood you correctly.</li>
                    <li><strong>4. Backend Calculates:</strong> Our Python backend takes the confirmed matrix and performs all the complex DEMATEL math (normalization, matrix inversion, etc.) to get the final, accurate results.</li>
                </ol>
            </div>
        </div>

        <h3 class="result-subheader text-2xl font-bold text-center mt-8 mb-4">How to Interpret Your Results</h3>
        <p class="text-white/70 mb-4 text-center max-w-3xl mx-auto">The analysis gives you two key numbers for each factor. Use them to decide where to focus your efforts.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2 text-yellow-300">Prominence (D+R): "Importance"</h4>
                <p class="text-sm text-white/80">This number shows how "connected" a factor is. A high prominence means the factor has many strong relationships (both giving and receiving influence). This is your system's "central hub."</p>
                <p class="text-sm text-white/90 font-semibold mt-2"><strong>Rule:</strong> The higher the Prominence, the more central and important the factor is to the overall system.</p>
            </div>
            
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2 text-blue-300">Relation (D-R): "Causal Role"</h4>
                <p class="text-sm text-white/80">This is the most critical number. It tells you if a factor is a driver or an outcome.</p>
                <ul class="list-none space-y-2 text-sm mt-2">
                    <li><strong class="text-blue-300">Positive (D-R > 0) = 'Cause' Factor:</strong> This factor *gives* more influence than it receives. It is a root driver.</li>
                    <li><strong class="text-red-300">Negative (D-R < 0) = 'Effect' Factor:</strong> This factor *receives* more influence than it gives. It is a symptom or outcome.</li>
                </ul>
            </div>
        </div>

        <div class="p-6 rounded-lg bg-green-900/20 border border-green-500/30 text-center mt-8">
            <h4 class="text-xl font-bold mb-2 text-green-300">Your Strategic Action Plan</h4>
            <p class="text-white/90">To fix a complex problem, **focus your energy on the 'Cause' factors** (positive D-R). By improving them, you will automatically fix the 'Effect' factors.</p>
            <p class="text-white/90 mt-1">Use the **'Effect' factors as your KPIs** to monitor if your changes are working.</p>
        </div>

        <div class="p-4 rounded-lg bg-black/20 border border-white/10 text-center mt-8">
             <h4 class="text-lg font-bold mb-2 text-indigo-300">Check Your Model's Health</h4>
             <p class="text-sm text-white/80">Always check the <strong>"Diagnostics"</strong> tab. It will tell you if the AI's analysis was stable and if any potential issues (like no 'Cause' factors) were found.</p>
        </div>
    `;
}

/**
 * Renders the DEMATEL Causal Diagram chart into its container.
 * --- FIXED VERSION - Minimal changes to existing function ---
 * Fixes alignment issues and adds color bar
 */
function renderDematelChart(chartData) {
    const chartContainer = $("dematel-chart-container");
    if (!chartContainer) {
        console.warn("DEMATEL chart container not found.");
        return;
    }

    // Check for all zero data (from a failed calculation)
    const isAllZero = chartData.data.every(d => d.x === 0 && d.y === 0);
    if (isAllZero) {
        chartContainer.innerHTML = `
            <div class="p-6 text-center text-white/70 flex items-center justify-center h-full">
                <div>
                    <h4 class="text-xl font-bold text-yellow-300 mb-4">Chart Cannot Be Rendered</h4>
                    <p>The analysis resulted in zero prominence and relation for all factors.</p>
                    <p>This is a valid result but cannot be plotted. Please see the <strong class="text-red-400">Diagnostics</strong> tab.</p>
                </div>
            </div>
        `;
        return;
    }

    chartContainer.innerHTML = ""; // Clear placeholder

    try {
        // Calculate intelligent text positions to avoid overlap
        const textPositions = chartData.data.map((point, index) => {
            const x = point.x;
            const y = point.y;
            const avgX = chartData.data.reduce((sum, p) => sum + p.x, 0) / chartData.data.length;
            
            // Position labels based on quadrant and avoid clustering
            if (x > avgX && y > 0) {
                // Top right quadrant - alternate positions
                return index % 2 === 0 ? 'top left' : 'bottom right';
            } else if (x <= avgX && y > 0) {
                // Top left quadrant - alternate positions  
                return index % 2 === 0 ? 'top right' : 'bottom left';
            } else if (x > avgX && y <= 0) {
                // Bottom right quadrant
                return index % 2 === 0 ? 'top right' : 'bottom left';
            } else {
                // Bottom left quadrant
                return index % 2 === 0 ? 'top left' : 'bottom right';
            }
        });

        const plotData = [{
            x: chartData.data.map(m => m.x), // Prominence (D+R)
            y: chartData.data.map(m => m.y), // Relation (D-R)
            text: chartData.data.map(m => m.name),
            mode: 'markers+text',
            textposition: textPositions,
            textfont: {
                size: 11,
                color: 'white'
            },
            marker: {
                size: 12,
                color: chartData.data.map(m => m.y),
                colorscale: 'RdBu',
                showscale: true, // Show the color bar
                colorbar: {
                    title: {
                        text: "Relation (D-R)<br>Cause  Effect",
                        font: { color: 'white', size: 12 }
                    },
                    titleside: "right",
                    tickfont: { color: 'white', size: 10 },
                    x: 1.02, // Position colorbar to the right
                    len: 0.8,
                    thickness: 15
                }
            },
            type: 'scatter',
            hovertemplate: '<b>%{text}</b><br>Prominence: %{x:.3f}<br>Relation: %{y:.3f}<extra></extra>'
        }];

        // Calculate context lines with better spacing
        const avgProminence = chartData.data.reduce((sum, p) => sum + p.x, 0) / chartData.data.length;
        const maxRelation = Math.max(...chartData.data.map(p => Math.abs(p.y)));
        const yPadding = maxRelation * 0.15 || 0.1; 
        const yRange = [-(maxRelation + yPadding), maxRelation + yPadding];
        const minProminence = Math.min(...chartData.data.map(p => p.x));
        const maxProminence = Math.max(...chartData.data.map(p => p.x));
        const xPadding = (maxProminence - minProminence) * 0.1 || 0.1;
        const xRange = [minProminence - xPadding, maxProminence + xPadding];

        const layout = {
            title: {
                text: chartData.title,
                font: { color: 'white' } 
            },
            paper_bgcolor: 'rgba(0,0,0,0)', 
            plot_bgcolor: 'rgba(0,0,0,0.1)', 
            font: { color: 'white' }, 
            xaxis: { 
                title: {
                    text: chartData.x_axis_label,
                    font: { color: 'white' } 
                },
                gridcolor: 'rgba(255, 255, 255, 0.2)', 
                zeroline: false,
                tickfont: { color: 'white' },
                range: xRange // Use calculated range instead of automargin
            },
            yaxis: { 
                title: {
                    text: chartData.y_axis_label,
                    font: { color: 'white' } 
                },
                gridcolor: 'rgba(255, 255, 255, 0.2)', 
                zeroline: true, 
                zerolinecolor: 'rgba(255, 255, 255, 0.5)', 
                tickfont: { color: 'white' },
                range: yRange // Use calculated range for proper alignment
            },
            hovermode: 'closest',
            margin: { t: 50, b: 60, l: 80, r: 120 }, // Fixed margins instead of automargin
            autosize: true,

            shapes: [
                { 
                    type: 'line',
                    xref: 'paper', x0: 0, x1: 1,
                    yref: 'y', y0: 0, y1: 0,
                    line: { color: 'rgba(255, 255, 255, 0.5)', width: 1, dash: 'dot' }
                },
                { 
                    type: 'line',
                    xref: 'x', x0: avgProminence, x1: avgProminence,
                    yref: 'paper', y0: 0, y1: 1,
                    line: { color: 'rgba(255, 255, 255, 0.5)', width: 1, dash: 'dot' }
                }
            ],
            annotations: [
                {
                    text: 'Core Drivers',
                    x: maxProminence - xPadding * 0.5, 
                    y: yRange[1] - yPadding * 0.5,
                    showarrow: false, 
                    font: { color: 'rgba(255, 255, 255, 0.4)' }
                },
                {
                    text: 'Independent Drivers',
                    x: minProminence + xPadding * 0.5, 
                    y: yRange[1] - yPadding * 0.5,
                    showarrow: false, 
                    font: { color: 'rgba(255, 255, 255, 0.4)' }
                },
                {
                    text: 'Central Outcomes',
                    x: maxProminence - xPadding * 0.5, 
                    y: yRange[0] + yPadding * 0.5,
                    showarrow: false, 
                    font: { color: 'rgba(255, 255, 255, 0.4)' }
                },
                {
                    text: 'Independent Outcomes',
                    x: minProminence + xPadding * 0.5, 
                    y: yRange[0] + yPadding * 0.5,
                    showarrow: false, 
                    font: { color: 'rgba(255, 255, 255, 0.4)' }
                }
            ]
        };

        Plotly.newPlot(chartContainer, plotData, layout, { responsive: true });

    } catch (e) {
        console.error("Chart rendering failed (is Plotly.js loaded?):", e);
        chartContainer.innerHTML = `<div class="error-message">Chart rendering failed: ${e.message}.<br><pre class="text-xs bg-black/30 p-2 rounded mt-2">${JSON.stringify(chartData.data, null, 2)}</pre></div>`;
    }
}

// =========================================================================
    // ===== VISUALIZATION & RENDERING FUNCTIONS (FOR SEM)                =====
    // =========================================================================

/**
 * Sets up the tab structure for SEM results ('Estimates', 'Model Fit', 'Effects', 'Diagnostics', 'Comparison', 'Diagram', 'Learn SEM').
 * Calls specific functions to render content into each tab panel.
 * @param {HTMLElement} container - The main container element for results.
 * @param {object} data - Data from the backend (contains CSV strings, DOT string, or error).
 */
function renderSemAnalysisPage(container, data) {
    container.innerHTML = ""; // Clear previous content or loading indicator

    // --- Create Tab Navigation (Added Comparison Tab) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="results"> Estimates</button>
        <button class="analysis-tab-btn" data-tab="fit"> Model Fit</button>
        <button class="analysis-tab-btn" data-tab="effects"> Effects</button>
        <button class="analysis-tab-btn" data-tab="diagnostics"> Diagnostics</button>
        <button class="analysis-tab-btn" data-tab="comparison"> Comparison</button>
        <button class="analysis-tab-btn" data-tab="diagram"> Path Diagram</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn SEM</button>
       `;
    container.appendChild(tabNav);

    // --- Create Tab Content Panels (Added Comparison Panel) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="resultsPanel" class="analysis-tab-panel active p-6"></div>
        <div id="fitPanel" class="analysis-tab-panel p-6"></div>
        <div id="effectsPanel" class="analysis-tab-panel p-6"></div>
        <div id="diagnosticsPanel" class="analysis-tab-panel p-6"></div>
        <div id="comparisonPanel" class="analysis-tab-panel p-6"></div>
        <div id="diagramPanel" class="analysis-tab-panel p-6"></div>
        <div id="learnPanel" class="analysis-tab-panel p-6"></div>
       `;

    // --- Render Content into Panels (Added call to renderSemComparisonTab) ---
    renderSemResultsTab("resultsPanel", data);      // Render parameter estimates
    renderSemFitTab("fitPanel", data);              // Render fit statistics
    renderSemEffectsTab("effectsPanel");            // Render effects explanation
    renderSemDiagnosticsTab("diagnosticsPanel", data.warnings); // Render diagnostics info
    renderSemComparisonTab("comparisonPanel");      // --- NEW --- Render model comparison explanation
    renderSemDiagramTab("diagramPanel", data.path_diagram_dot);
    renderLearnSemTab("learnPanel");                // Render general SEM info

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Cache and Display Actions ---
    analysisCache[currentTemplateId] = container.innerHTML;
    const actionsEl = $("analysisActions");
    if (actionsEl) actionsEl.classList.remove("hidden");

    // --- Add Tab Switching Logic (No change needed here) ---
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON" && !e.target.classList.contains('active')) {
            // Deactivate all buttons and panels
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate the clicked button and corresponding panel
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");

                // Optional: Resize Plotly charts
                const chart = targetPanel.querySelector(".plotly-chart");
                if (chart && typeof Plotly !== 'undefined') {
                    try { Plotly.Plots.resize(chart); } catch (resizeError) { console.error("Plotly resize error:", resizeError); }
                }

                // Resize/fit viz.js diagram
                 const svgContainer = targetPanel.querySelector("svg");
                 if (svgContainer && targetPanelId === 'diagramPanel') {
                     // No specific resize needed for viz.js SVG
                 }
            }
        }
    });
}

/**
 * --- UPDATED FUNCTION (using viz.js) ---
 * Renders the SEM Path Diagram from a DOT string, including an explanatory section.
 * @param {string} containerId - The ID of the HTML element to render into.
 * @param {string} dotString - The pre-styled DOT language string from the backend.
 */
function renderSemDiagramTab(containerId, dotString) {
    const container = $(containerId);
    if (!container) return;

    // --- Start HTML with the Explanation ---
    let html = `
        <div class="mb-8 bg-green-900/20 p-6 rounded-lg border border-green-500/30">
            <h4 class="text-2xl font-bold mb-4 text-green-300"> Understanding the Path Diagram</h4>
            <p class="text-white/80 mb-4">This diagram visually represents the relationships in your SEM model. Here's how to interpret it:</p>
            <ul class="list-none space-y-3 text-white/90">
                <li class="flex items-start">
                    <span class="font-bold w-40 shrink-0">Shapes:</span>
                    <span><strong>Ellipses/Circles</strong> represent latent (unobserved) variables (e.g., 'Marketing'). <strong>Rectangles</strong> represent observed variables (your actual data columns).</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold w-40 shrink-0">Arrows:</span>
                    <span><strong>Single-headed arrows ()</strong> show hypothesized causal paths (regressions or factor loadings). The variable the arrow points *to* is predicted by the variable it comes *from*.</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-40 shrink-0">Numbers on Arrows:</span>
                    <span>These are the **standardized path coefficients (estimates)** showing the strength and direction of the relationship. Below them is the **p-value**, indicating statistical significance (typically p < 0.05 means significant).</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-40 shrink-0">Layout:</span>
                    <span>The arrangement (Top-to-Bottom) helps visualize the flow of influence based on your model specification.</span>
                </li>
            </ul>
        </div>
        <hr class="border-white/20 my-6">
        <h3 class="text-2xl font-bold mb-4">Your Model's Path Diagram</h3>
    `; // Added title for the diagram itself

    // --- Check for the Viz.js library ---
    console.log("--- Checking libraries inside renderSemDiagramTab ---");
    console.log("typeof Viz:", typeof Viz);
    
    if (typeof Viz === 'undefined') {
        console.error("Viz.js is not loaded.");
        html += `
            <div class="p-4">
                <p class="text-red-400"><strong>Error:</strong> Visualization library not loaded. (Viz is undefined)</p>
                {/* ... (rest of the library error message) ... */}
            </div>`;
        container.innerHTML = html; // Show explanation and error
        return;
    }

    // Check for the DOT string
    if (!dotString) {
        html += `<p class="text-yellow-400 p-4">Path diagram data is not available. This can happen if the model failed to fit or if diagram generation failed on the server.</p>`;
        container.innerHTML = html; // Show explanation and warning
        return;
    }

    // Add placeholder for the diagram rendering
    const graphId = "semGraphContainer_" + containerId;
    html += `<div id="${graphId}" class="w-full h-full min-h-[500px] flex justify-center items-center"><div class="text-white/70 p-8 text-center">Rendering path diagram...</div></div>`;
    container.innerHTML = html; // Set initial HTML including explanation and placeholder

    // --- Render the diagram into the placeholder ---
    try {
        const viz = new Viz();
        const graphContainer = $(graphId); // Get the placeholder div

        viz.renderSVGElement(dotString)
            .then(function (svgElement) {
                // --- Success ---
                if (graphContainer) { // Check if container still exists
                    graphContainer.innerHTML = ""; // Clear "Rendering..." text
                    
                    svgElement.style.width = "100%";
                    svgElement.style.height = "100%";
                    // No styling needed as it comes pre-styled from backend

                    graphContainer.appendChild(svgElement);
                }
            })
            .catch(function (error) {
                // --- Render Error ---
                console.error("Viz.js rendering error:", error);
                 if (graphContainer) { // Check if container still exists
                    graphContainer.innerHTML = `<p class="text-red-400 p-4"><strong>Error rendering path diagram:</strong> ${error.message || 'Unknown error'}</p>`;
                 }
            });
    } catch (error) {
        // --- Initialization Error ---
        console.error("Error initializing Viz.js:", error);
         const graphContainer = $(graphId);
         if (graphContainer) {
            graphContainer.innerHTML = `<p class="text-red-400 p-4"><strong>Error initializing path diagram:</strong> ${error.message}</p>`;
         }
    }
}

/**
 * --- UPDATED FUNCTION ---
 * Parses CSV data for fit indices, adds explanatory text, and renders them.
 * @param {string} containerId - The ID of the HTML element to render into.
 * @param {object} data - Backend response containing 'fit_indices_csv_content' or an 'error'.
 */
function renderSemFitTab(containerId, data) {
    const container = $(containerId);
    if (!container) return;

    // --- Start HTML with the Explanation ---
    let html = `
        <div class="mb-8 bg-indigo-900/20 p-6 rounded-lg border border-indigo-500/30">
            <h4 class="text-2xl font-bold mb-4 text-indigo-300"> Assessing Model Fit</h4>
            <p class="text-white/80 mb-4">These statistics check how well your theoretical model matches the actual structure of your data. Look at multiple indices together:</p>
            <ul class="list-none space-y-3 text-white/90">
                <li class="flex items-start">
                    <span class="font-bold w-28 shrink-0">Chi-Square ():</span>
                    <span>Tests exact fit. A **non-significant p-value (> 0.05)** suggests good fit (model matches data), but it's sensitive to large samples.</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold w-28 shrink-0">CFI / TLI:</span>
                    <span>Compare your model to a baseline. ** 0.95 is good fit.**</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-28 shrink-0">RMSEA:</span>
                    <span>Error per degree of freedom. ** 0.06 is good fit**,  0.08 is acceptable.</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-28 shrink-0">SRMR:</span>
                    <span>Average residual correlation. ** 0.08 is good fit.**</span>
                </li>
            </ul>
        </div>
        <hr class="border-white/20 my-6">
        <h3 class="text-2xl font-bold mb-4">Your Model's Fit Indices</h3>
    `; // Added title for the results grid

    // --- Now add the results grid (or error message) ---
    if (data.error) {
        html += `<p class="text-red-400 p-4"><strong>Analysis Error prevented fit calculation:</strong> ${data.error}</p>`;
    } else if (typeof data.fit_indices_csv_content !== 'string') {
        html += `<p class="text-yellow-400 p-4">Warning: Model fit indices are missing or invalid in the backend response.</p>`;
        console.warn("Missing/invalid fit_indices_csv_content:", data);
    } else {
        try {
            if (typeof Papa === 'undefined') {
                 throw new Error("PapaParse library is not loaded.");
            }
            const fitIndicesConfig = { header: true, skipEmptyLines: true, dynamicTyping: true };
            const fitIndicesResult = Papa.parse(data.fit_indices_csv_content, fitIndicesConfig);

            if (fitIndicesResult.errors.length > 0) throw new Error(`Error parsing fit indices CSV: ${fitIndicesResult.errors[0].message}`);

            const fitIndices = fitIndicesResult.data.length > 0 ? fitIndicesResult.data[0] : {};

            html += renderFitIndices(fitIndices); // Use helper for fit indices grid

            // Add warnings related to fit if any exist
            if (data.warnings) {
                html += `<h4 class="text-lg font-semibold mt-6 mb-2">Warnings:</h4><ul class="list-disc list-inside text-yellow-300 text-sm">`;
                for (const key in data.warnings) {
                     html += `<li><strong>${key.replace(/_/g, ' ')}:</strong> ${data.warnings[key]}</li>`;
                }
                 html += `</ul>`;
            }
        } catch (error) {
            console.error("Error displaying SEM fit indices:", error);
            html += `<p class="text-red-400 p-4"><strong>Error displaying fit indices:</strong> ${error.message}</p>`;
        }
    }

    container.innerHTML = html; // Set the final HTML for the tab
}

/**
 * --- UPDATED FUNCTION ---
 * Renders the SEM parameter estimates tab, including an explanation,
 * variable lists, and the main estimates table.
 * @param {string} containerId - The ID of the HTML element to render into.
 * @param {object} data - Backend response containing estimates, fit indices, variables, or an 'error'.
 */
function renderSemResultsTab(containerId, data) {
    const container = $(containerId);
    if (!container) return; // Exit if container not found

    // --- Start HTML with the Explanation ---
    let html = `
        <div class="mb-8 bg-blue-900/20 p-6 rounded-lg border border-blue-500/30">
            <h4 class="text-2xl font-bold mb-4 text-blue-300"> Understanding Parameter Estimates</h4>
            <p class="text-white/80 mb-4">This table shows the calculated strength and significance of each relationship (path) in your model. Key columns include:</p>
            <ul class="list-none space-y-3 text-white/90 text-sm">
                <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">lval / rval:</span>
                    <span>The left-hand and right-hand variables involved in the relationship.</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">op:</span>
                    <span>The operator defining the relationship type: <code>=~</code> (measurement/loading), <code>~</code> (regression/path), <code>~~</code> (variance/covariance).</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">Estimate:</span>
                    <span>The calculated **standardized path coefficient**. It indicates the strength and direction of the relationship in standard deviation units (e.g., a 1 SD change in predictor leads to X SD change in outcome). **Makes effects comparable** across different paths.</span>
                 </li>
                 <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">Std. Err:</span>
                    <span>The standard error of the estimate, indicating its precision (lower is better).</span>
                 </li>
                 <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">z-value:</span>
                    <span>The estimate divided by its standard error. Used to test significance.</span>
                 </li>
                 <li class="flex items-start">
                    <span class="font-bold w-24 shrink-0">p-value:</span>
                    <span>The probability of observing the relationship if there were truly no effect. A **p-value < 0.05** is typically considered statistically significant, suggesting the relationship is unlikely due to chance.</span>
                </li>
            </ul>
             <p class="text-xs text-white/60 mt-4"><em>(Note: These estimates are standardized because the input data was scaled before analysis.)</em></p>
        </div>
        <hr class="border-white/20 my-6">
    `;
    // --- END MODIFIED SECTION ---

    // Display error message if present in data
    if (data.error) {
        html += `<p class="text-red-400 p-4"><strong>Analysis Error:</strong> ${data.error}</p>`;
        container.innerHTML = html; // Show explanation and error
        return;
    }

    // Display Observed and Latent Variables
    if (data.model_variables) {
        const observedVars = data.model_variables.observed || [];
        const latentVars = data.model_variables.latent || [];

        html += `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/30">
                    <h4 class="text-lg font-semibold mb-2 text-blue-300">Observed Variables (${observedVars.length})</h4>
                    <p class="text-xs text-white/70 break-words">${observedVars.join(', ') || 'None'}</p>
                </div>
                <div class="bg-purple-900/20 p-4 rounded-lg border border-purple-500/30">
                    <h4 class="text-lg font-semibold mb-2 text-purple-300">Latent Variables (${latentVars.length})</h4>
                    <p class="text-xs text-white/70 break-words">${latentVars.join(', ') || 'None'}</p>
                </div>
            </div>
            <hr class="border-white/20 my-6">
        `;
    }

    // Validate estimates CSV content
    if (typeof data.estimates_csv_content !== 'string') {
        html += `<p class="text-yellow-400 p-4">Warning: SEM parameter estimates are incomplete or missing.</p>`;
        console.warn("Missing/invalid estimates_csv_content:", data);
        container.innerHTML = html; // Show explanation, variables, and warning
        return;
    }

    try {
        // --- Parse Estimates CSV Data ---
        if (typeof Papa === 'undefined') {
             throw new Error("PapaParse library is not loaded.");
        }
        const estimatesConfig = { header: true, skipEmptyLines: true, dynamicTyping: true };
        const estimatesResult = Papa.parse(data.estimates_csv_content, estimatesConfig);
        if (estimatesResult.errors.length > 0) throw new Error(`Error parsing estimates CSV: ${estimatesResult.errors[0].message}`);
        const estimates = estimatesResult.data;

        // --- Build HTML Output for Estimates Table ---
        html += `<h3 class="text-2xl font-bold mb-4">Parameter Estimates Table</h3>`; // Added 'Table' to title
        html += renderHtmlTable(estimates); // Use helper for estimates table

        container.innerHTML = html; // Set the final combined HTML

    } catch (error) { // Catch errors during parsing or rendering helpers
        console.error("Error displaying SEM results:", error);
        // Append error message to existing HTML
        html += `<p class="text-red-400 p-4"><strong>Error displaying estimate results:</strong> ${error.message}</p>`;
        container.innerHTML = html;
    }
}

/**
 * --- NEW FUNCTION ---
 * Renders the explanation for Total, Direct, and Indirect Effects (Mediation).
 * @param {string} containerId - The ID of the HTML element to render into.
 */
function renderSemEffectsTab(containerId) {
    const container = $(containerId);
    if (!container) return;

    container.innerHTML = `
        <div class="bg-teal-900/20 p-6 rounded-lg border border-teal-500/30">
            <h4 class="text-2xl font-bold mb-4 text-teal-300"> Total, Direct & Indirect Effects (Mediation)</h4>
            <p class="text-white/80 mb-4">When a variable (X) influences another variable (Y) *through* an intermediate variable (M), this is called **mediation**. Analyzing effects helps understand these pathways:</p>
            <ul class="list-none space-y-3 text-white/90 text-sm mb-6">
                <li class="flex items-start">
                    <span class="font-bold w-32 shrink-0">Direct Effect:</span>
                    <span>The influence of X directly on Y, ignoring any mediators (e.g., the path X  Y).</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold w-32 shrink-0">Indirect Effect(s):</span>
                    <span>The influence of X on Y that flows *through* one or more mediators (M). Calculated by multiplying the path coefficients along the indirect route (e.g., X  M * M  Y).</span>
                </li>
                 <li class="flex items-start">
                    <span class="font-bold w-32 shrink-0">Total Effect:</span>
                    <span>The overall impact of X on Y, combining both the direct and all indirect effects. (Total = Direct + Indirect).</span>
                </li>
            </ul>

            <h5 class="font-semibold text-lg mb-2 text-teal-300">Example Decomposition:</h5>
            <pre class="bg-black/20 p-4 rounded text-sm text-white/90 mb-4 whitespace-pre-wrap">
Marketing  Profit
 Direct Effect:         -0.026 (non-significant)
 Indirect via Online_Sales: 0.318
 Indirect via Retail_Sales: -0.009
 TOTAL Effect:           0.309 

Proportion Mediated: 100% (complete mediation because direct is non-sig.)</pre>

            <h5 class="font-semibold text-lg mb-2 text-teal-300">What it Tells You:</h5>
             <ul class="list-disc list-inside text-white/80 space-y-1 text-sm">
                 <li><strong>How much** of the effect is direct vs. mediated through other variables.</li>
                 <li>The **actual total impact** of a predictor on an outcome, which is often crucial for business decisions.</li>
                 <li>Helps validate (or refute) your **mediation story**  does the intermediate variable truly act as a pathway?</li>
            </ul>
             <p class="text-xs text-white/60 mt-4"><em>(Note: Calculating these effects often requires specific commands or post-estimation analysis in SEM software. They are derived from the standard path estimates.)</em></p>
        </div>
    `;
}

/**
 * --- NEW FUNCTION ---
 * Renders diagnostic information, focusing on warnings like high correlation.
 * @param {string} containerId - The ID of the HTML element to render into.
 * @param {object | null} warnings - The warnings object from the backend response, or null if none.
 */
function renderSemDiagnosticsTab(containerId, warnings) {
    const container = $(containerId);
    if (!container) return;

    let html = `<h3 class="text-2xl font-bold mb-4"> Model Diagnostics & Warnings</h3>`;

    if (!warnings || Object.keys(warnings).length === 0) {
        html += `<div class="p-4 rounded-lg bg-green-900/20 border border-green-500/30 text-green-300">
                    <p> No major warnings detected during the analysis.</p>
                 </div>`;
        container.innerHTML = html;
        return;
    }

    // --- Display High Correlation Warning Specifically ---
    if (warnings.high_correlation) {
        html += `
            <div class="mb-6 bg-yellow-900/30 p-6 rounded-lg border border-yellow-500/30">
                <h4 class="text-xl font-bold mb-3 text-yellow-300">High Correlation Detected (Multicollinearity Warning)</h4>
                <p class="text-white/80 mb-2">The analysis found very high correlations (typically > 0.85 or 0.90) between some of your observed variables:</p>
                <pre class="bg-black/20 p-3 rounded text-sm text-yellow-200 mb-4 whitespace-pre-wrap">${warnings.high_correlation}</pre>
                <h5 class="font-semibold mb-1 text-white/90">Potential Issues:</h5>
                <ul class="list-disc list-inside text-white/80 space-y-1 text-sm mb-3">
                    <li><strong>Unstable Estimates:</strong> Path coefficients (Estimates) might change drastically with small data changes.</li>
                    <li><strong>Inflated Standard Errors:</strong> This can make it harder to find statistically significant relationships (higher p-values), even if a real effect exists.</li>
                    <li><strong>Interpretation Difficulty:</strong> It's hard to isolate the unique effect of one highly correlated variable from the other.</li>
                </ul>
                <h5 class="font-semibold mb-1 text-white/90">Possible Actions:</h5>
                 <ul class="list-disc list-inside text-white/80 space-y-1 text-sm">
                    <li><strong>Review Theory:</strong> Do these variables measure very similar concepts? Is it expected?</li>
                    <li><strong>Combine Variables:</strong> If theoretically sound, consider creating a composite score or factor from the highly correlated variables.</li>
                    <li><strong>Remove Variable(s):</strong> If two variables are redundant, consider removing one, but only if justified by theory (don't remove just to fix the statistic).</li>
                    <li><strong>Acknowledge Limitation:</strong> If removal/combination isn't appropriate, report the high correlation as a limitation when interpreting the results.</li>
                </ul>
            </div>
        `;
    }

    // --- Display Other Warnings ---
    html += `<h4 class="text-xl font-semibold mt-6 mb-3">Other Warnings:</h4>`;
    let otherWarningsFound = false;
    for (const key in warnings) {
        if (key !== 'high_correlation') { // Skip the one we already handled
             otherWarningsFound = true;
             html += `<div class="mb-4 p-4 rounded-lg bg-red-900/20 border border-red-500/30">
                        <h5 class="font-bold text-red-300">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</h5>
                        <p class="text-white/80 text-sm">${warnings[key]}</p>
                      </div>`;
        }
    }

    if (!otherWarningsFound) {
        html += `<p class="text-white/70 text-sm italic">No other specific warnings were generated.</p>`;
    }

    container.innerHTML = html;
}

/**
 * --- NEW FUNCTION ---
 * Renders the explanation for Model Comparison in SEM.
 * @param {string} containerId - The ID of the HTML element to render into.
 */
function renderSemComparisonTab(containerId) {
    const container = $(containerId);
    if (!container) return;

    container.innerHTML = `
        <div class="bg-orange-900/20 p-6 rounded-lg border border-orange-500/30">
            <h4 class="text-2xl font-bold mb-4 text-orange-300"> Comparing Alternative Models</h4>
            <p class="text-white/80 mb-4">Often, there isn't just one single "correct" model. Theory might suggest several plausible ways variables relate. Model comparison helps you determine which specified model best fits your data among a set of alternatives.</p>

            <h5 class="font-semibold text-lg mb-2 text-orange-300">Why Compare Models?</h5>
            <ul class="list-disc list-inside text-white/80 space-y-1 text-sm mb-4">
                <li><strong>Test Competing Theories:</strong> See which theoretical structure is better supported by the data.</li>
                <li><strong>Assess Mediation/Moderation:</strong> Compare a model with mediation paths to one without, or test different moderation effects.</li>
                <li><strong>Improve Parsimony:</strong> Determine if adding or removing paths significantly improves or worsens model fit relative to the change in complexity.</li>
                <li><strong>Refine Understanding:</strong> Explore nuances in relationships by testing slightly different model specifications.</li>
            </ul>

            <h5 class="font-semibold text-lg mb-2 text-orange-300">Common Comparison Methods:</h5>
            <ul class="list-disc list-inside text-white/80 space-y-1 text-sm mb-4">
                <li><strong>Nested Model Comparison (Chi-Square Difference Test):</strong> Used when one model is a simpler version of another (e.g., Model B is Model A with some paths removed). A significant Chi-Square difference suggests the more complex model fits significantly better.</li>
                <li><strong>Information Criteria (AIC, BIC):</strong> Used for comparing non-nested models (models that aren't subsets of each other). The model with the **lower** AIC or BIC value is generally preferred, balancing fit and complexity. BIC penalizes complexity more heavily.</li>
                <li><strong>Comparing Fit Indices:</strong> While not a formal test, you can compare indices like CFI, TLI, RMSEA across models. Look for meaningful improvements in fit alongside theoretical justification.</li>
            </ul>

            <h5 class="font-semibold text-lg mb-2 text-orange-300">How to Do It Here:</h5>
            <p class="text-white/80 text-sm">Currently, this tool runs one model at a time. To compare models:</p>
            <ol class="list-decimal list-inside text-white/80 space-y-1 text-sm">
                <li>Run your first model specification and note its fit indices (especially Chi-Square, AIC, BIC if available).</li>
                <li>Modify the Measurement or Structural Syntax text boxes to define your alternative model.</li>
                <li>Run the analysis again with the same data.</li>
                <li>Compare the fit indices between the runs. Use the guidelines above (Chi-Square difference, lower AIC/BIC) to help decide which model is preferable.</li>
            </ol>
             <p class="text-xs text-white/60 mt-4"><em>(Note: Rigorous model comparison should always be guided by theory, not just statistical fit.)</em></p>
        </div>
    `;
}

/**
 * Renders the static 'Learn SEM' content into the specified container.
 * @param {string} containerId - The ID of the HTML element to render into.
 */
function renderLearnSemTab(containerId) {
    const container = $(containerId);
    if (!container) return; // Exit if container not found

    // Static HTML content explaining SEM
    container.innerHTML = `
        <h3 class="text-3xl font-bold mb-6"> Understanding SEM Analysis</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
            <div class="md:col-span-2 space-y-6">
                <div>
                    <h4 class="text-xl font-bold mb-3"> What is SEM?</h4>
                    <p class="text-white/80 mb-2">Structural Equation Modeling is a powerful statistical technique that allows researchers to test complex theoretical models. It essentially combines:</p>
                    <ul class="list-disc list-inside text-white/80 space-y-1">
                        <li><strong>Factor Analysis:</strong> To understand how well observed variables (like survey items) measure underlying unobserved concepts (latent variables or constructs). This is the <strong>Measurement Model</strong>.</li>
                        <li><strong>Path Analysis / Regression:</strong> To examine the direct and indirect causal relationships hypothesized between different constructs (latent or observed). This is the <strong>Structural Model</strong>.</li>
                    </ul>
                     <p class="text-white/80 mt-2">It allows testing the entire model simultaneously, providing a holistic view of relationships.</p>
                </div>
                <div>
                    <h4 class="text-xl font-bold mb-3"> Common Business Applications:</h4>
                    <ul class="list-disc list-inside text-white/80 space-y-1">
                        <li><strong>Customer Satisfaction/Loyalty:</strong> Modeling drivers like service quality, price perception, and brand image.</li>
                        <li><strong>Employee Engagement:</strong> Understanding factors like leadership, work environment, and compensation.</li>
                        <li><strong>Brand Equity/Image:</strong> Assessing components like awareness, associations, and perceived quality.</li>
                        <li><strong>Marketing Mix Modeling:</strong> Evaluating the combined impact of advertising, promotions, etc., on sales or brand perception.</li>
                        <li><strong>Technology Acceptance:</strong> Testing models like TAM (Technology Acceptance Model).</li>
                        <li><strong>Supply Chain Performance:</strong> Analyzing relationships between supplier integration, logistics, and firm performance.</li>
                    </ul>
                </div>
            </div>

            <div class="md:col-span-1 bg-white/5 p-4 rounded-lg">
                <h4 class="text-xl font-bold mb-3"> Key Components:</h4>
                <ul class="list-disc list-inside text-white/80 space-y-2">
                    <li>
                        <strong>Latent Variables (Ellipses):</strong>
                        <ul class="list-[circle] list-inside pl-4 text-sm">
                            <li>Unobserved concepts (e.g., 'Brand Loyalty').</li>
                            <li>Syntax: <code>Loyalty =~ item1 + item2</code></li>
                        </ul>
                    </li>
                    <li>
                        <strong>Observable Variables (Rectangles):</strong>
                        <ul class="list-[circle] list-inside pl-4 text-sm">
                            <li>Directly measured data (e.g., survey answers).</li>
                        </ul>
                    </li>
                     <li>
                        <strong>Measurement Paths (<code>=~</code>):</strong>
                        <ul class="list-[circle] list-inside pl-4 text-sm">
                             <li>Link latent variables to their indicators.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Structural Paths (<code>~</code>):</strong>
                         <ul class="list-[circle] list-inside pl-4 text-sm">
                            <li>Hypothesized causal relationships between variables.</li>
                        </ul>
                    </li>
                     <li>
                        <strong>Covariances (<code>~~</code>):</strong>
                         <ul class="list-[circle] list-inside pl-4 text-sm">
                            <li>Correlations without assumed causality.</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

        <div class="mb-8">
            <h4 class="text-xl font-bold mb-3"> SEM Analysis Workflow:</h4>
            <ol class="list-decimal list-inside text-white/80 space-y-1">
                <li><strong>Model Specification:</strong> Define constructs and relationships based on theory using syntax.</li>
                <li><strong>Data Collection:</strong> Gather sufficient data (N > 200 often recommended).</li>
                <li><strong>Model Estimation:</strong> The software calculates path coefficients and error terms.</li>
                <li><strong>Model Evaluation:</strong> Assess how well the model fits the data using indices (, RMSEA, CFI, TLI, SRMR).</li>
                <li><strong>Interpretation:</strong> Examine significant paths and overall model fit.</li>
                <li><strong>Modification (Optional):</strong> Adjust model based on theory and modification indices if fit is poor.</li>
            </ol>
        </div>

        <div class="mb-8">
             <h4 class="text-xl font-bold mb-3"> Best Practices:</h4>
            <ul class="list-disc list-inside text-white/80 space-y-1">
                <li><strong>Theory Driven:</strong> Model specification should be based on existing research or strong logical arguments.</li>
                <li><strong>Sample Size:</strong> Ensure adequate sample size (rules of thumb: >200, or 10-20 per estimated parameter).</li>
                <li><strong>Indicators per Factor:</strong> Use at least 3, preferably 4+, indicators per latent variable for stability.</li>
                <li><strong>Model Fit:</strong> Aim for good fit across multiple indices (e.g., RMSEA  0.06, CFI/TLI  0.95, SRMR  0.08, non-significant  p-value > 0.05).</li>
                <li><strong>Parsimony:</strong> Prefer simpler models that fit well over overly complex ones.</li>
            </ul>
        </div>

        <details class="styled-details mt-8">
            <summary> Advanced SEM Tips</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-6">
                <div>
                    <h5 class="text-lg font-semibold text-white/90 mb-2">Model Building Strategy:</h5>
                    <ol class="list-decimal list-inside text-white/80 space-y-1">
                        <li>Start with the measurement model (CFA) to ensure constructs are well-defined before testing structural paths.</li>
                        <li>Gradually add structural paths based on theory.</li>
                        <li>Compare nested models using Chi-Square difference tests.</li>
                        <li>Consider alternative models and compare their fit.</li>
                    </ol>
                </div>
                <div>
                    <h5 class="text-lg font-semibold text-white/90 mb-2"> Common Pitfalls:</h5>
                    <ul class="list-disc list-inside text-white/80 space-y-1">
                        <li><strong>Overfitting:</strong> Specifying too many paths just to improve fit without theoretical justification.</li>
                        <li><strong>Multicollinearity:</strong> Very high correlations between predictor variables (check correlations > 0.85).</li>
                        <li><strong>Heywood Cases:</strong> Impossible results like negative variances ("error variance") or correlations > 1.0, often due to model misspecification or poor data.</li>
                        <li><strong>Identification Issues:</strong> The model has too few knowns (data points) to estimate the unknowns (parameters). Ensure df > 0.</li>
                    </ul>
                </div>
                <div>
                    <h5 class="text-lg font-semibold text-white/90 mb-2"> Troubleshooting Poor Fit:</h5>
                    <ul class="list-disc list-inside text-white/80 space-y-1">
                        <li><strong>Check Data:</strong> Look for outliers, non-normality (consider robust estimators like MLR or MLW), missing data patterns.</li>
                        <li><strong>Review Theory:</strong> Is the model theoretically sound? Are important paths missing?</li>
                        <li><strong>Examine Modification Indices:</strong> Suggest potential paths to add, but ONLY add those that make theoretical sense.</li>
                        <li><strong>Simplify Model:</strong> Remove non-significant paths or combine highly correlated constructs if justified.</li>
                        <li><strong>Check Measurement Model:</strong> Ensure indicators load strongly and cleanly onto their intended factors.</li>
                    </ul>
                </div>
            </div>
        </details>
    `;
}

    /**
 * Helper function to convert an array of objects (like parsed CSV data) into an HTML table.
 * @param {object[]} data - Array of row objects.
 * @returns {string} HTML string for the table.
 */
function renderHtmlTable(data) {
    if (!data || data.length === 0) return '<p class="text-white/70">No estimate data available.</p>';

    const headers = Object.keys(data[0]);
    let tableHtml = '<div class="overflow-x-auto"><table class="w-full text-left styled-table text-sm"><thead><tr>';
    headers.forEach(h => { tableHtml += `<th>${h}</th>`; });
    tableHtml += '</tr></thead><tbody>';

    data.forEach(row => {
        tableHtml += '<tr>';
        headers.forEach(h => {
            let value = row[h];
            let displayValue = '';

            if (typeof value === 'number') {
                if (h.toLowerCase().includes('p-value') && value < 0.0001 && value >= 0) {
                    displayValue = "&lt; 0.0001"; // Use HTML entity
                } else if (value % 1 === 0) { // Integer
                    displayValue = value.toString();
                } else { // Decimal - default to 4 places for estimates/stats
                    const precision = (['Estimate', 'Std. Err', 'z-value'].includes(h)) ? 4 : 3;
                    displayValue = value.toFixed(precision);
                }
            } else if (value === null || value === undefined) {
                displayValue = '';
            } else if (value === '-') {
                displayValue = ''; // Replace placeholder dash
            } else {
                displayValue = value.toString(); // Default to string
            }
            tableHtml += `<td>${displayValue}</td>`;
        });
        tableHtml += '</tr>';
    });

    tableHtml += '</tbody></table></div>';
    return tableHtml;
}

    /**
 * Helper function to render fit indices object into a styled grid with interpretations.
 * @param {object} indices - Object containing fit index key-value pairs.
 * @returns {string} HTML string for the grid.
 */
function renderFitIndices(indices) {
    if (!indices || Object.keys(indices).length === 0) return '<p class="text-white/70">No fit indices available.</p>';

    // Configuration for common indices
    const config = {
        'chi2': { label: 'Chi-Square ()', threshold: null, higherIsBetter: null, note: 'Model vs Data diff.' },
        'chi2 p-value': { label: ' p-value', threshold: 0.05, higherIsBetter: true, note: 'Want > 0.05 (fit)' },
        'RMSEA': { label: 'RMSEA', threshold: 0.08, higherIsBetter: false, note: '< 0.08 Good, < 0.06 Exc.' },
        'CFI': { label: 'CFI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Accept, > 0.95 Good' },
        'TLI': { label: 'TLI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Accept, > 0.95 Good' },
        'SRMR': { label: 'SRMR', threshold: 0.08, higherIsBetter: false, note: '< 0.08 Good' },
        'AIC': { label: 'AIC', threshold: null, higherIsBetter: false, note: 'Lower is better (compare)' },
        'BIC': { label: 'BIC', threshold: null, higherIsBetter: false, note: 'Lower is better (compare)' },
        'DoF': { label: 'Degrees of Freedom', threshold: null, higherIsBetter: null, note: 'Model complexity' },
         // Add others as needed, e.g., GFI, AGFI if semopy provides them consistently
         'GFI': { label: 'GFI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Good' },
         'AGFI': { label: 'AGFI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Good' },
         'NFI': { label: 'NFI', threshold: 0.90, higherIsBetter: true, note: '> 0.90 Good' },
    };

    let gridHtml = '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">';

    for (const key in indices) {
        if (indices.hasOwnProperty(key)) {
            const valueStr = indices[key];
            let valueNum = parseFloat(valueStr);
            if (isNaN(valueNum)) continue; // Skip non-numeric values

            const idxConfig = config[key] || {
                label: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                threshold: null, higherIsBetter: null, note: ''
            };

            let interpretation = '', colorClass = 'bg-white/5'; // Default style

            // Determine interpretation and color based on threshold
            if (idxConfig.threshold !== null && idxConfig.higherIsBetter !== null) {
                const passesThreshold = (idxConfig.higherIsBetter && valueNum >= idxConfig.threshold) ||
                                       (!idxConfig.higherIsBetter && valueNum <= idxConfig.threshold);
                if (passesThreshold) {
                    interpretation = ' Good Fit';
                    colorClass = 'bg-green-600/10 text-green-300 border border-green-600/30';
                } else {
                    interpretation = ' Potential Issue';
                    colorClass = 'bg-yellow-600/10 text-yellow-300 border border-yellow-600/30';
                }
            }
             // Specific logic for p-value interpretation
             if (key === 'chi2 p-value') {
                if (valueNum >= 0.05) {
                    interpretation = ' Fits Data (p  0.05)';
                    colorClass = 'bg-green-600/10 text-green-300 border border-green-600/30';
                } else {
                    interpretation = ' Differs from Data (p < 0.05)';
                    colorClass = 'bg-yellow-600/10 text-yellow-300 border border-yellow-600/30';
                }
            }


            gridHtml += `
                <div class="p-3 rounded-lg ${colorClass}">
                    <p class="text-sm font-medium text-white/80">${idxConfig.label}</p>
                    <p class="text-xl font-bold text-white">${valueNum.toFixed(3)}</p>
                    ${interpretation ? `<p class="text-xs mt-1 font-semibold">${interpretation}</p>` : ''}
                    ${idxConfig.note ? `<p class="text-xs mt-1 text-white/60">${idxConfig.note}</p>` : ''}
                </div>`;
        }
    }
    gridHtml += '</div>';

    // Footer with general guidelines
    gridHtml += `
        <div class="mt-6 text-xs text-white/60 space-y-1">
            <p><strong>Note:</strong> Fit index interpretation depends on context (sample size, model complexity, theory). Thresholds are common guidelines.</p>
        </div>`;

    return gridHtml;
}

    // =========================================================================
    // ===== VISUALIZATION & RENDERING FUNCTIONS (FOR SEM) END             =====
    // =========================================================================


    // =========================================================================
    // ===== VISUALIZATION & RENDERING FUNCTIONS                          =====
    // =========================================================================

/**
 * RENDERER: System Thinking Analysis
 * - NEW (v5 - Comprehensive): This renderer is completely overhauled to handle
 *   the rich JSON output from the new comprehensive system mapping prompt.
 * - It creates a multi-tab view to explore the deep analysis.
 */
function renderSystemThinkingPage(container, data) {
    container.innerHTML = ""; // Clear the loading indicator

    // --- Validation for the comprehensive new structure ---
    if (!data || !Array.isArray(data.concepts) || !Array.isArray(data.relationships) || !Array.isArray(data.archetypes) || !Array.isArray(data.leverage_points)) {
        console.error("Incomplete data passed to renderSystemThinkingPage (v5):", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. The AI response is missing key fields like concepts, relationships, archetypes, or leverage_points.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    
    // Destructure all new fields for clarity
    const {
        concepts,
        relationships,
        goals,
        stakeholders,
        constraints,
        assumptions,
        missing_factors,
        leverage_points,
        second_order_effects,
        archetypes,
        feedback_loops
    } = data;

    // --- Create Tab Navigation (New Tabs for Deep Analysis) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="network"> System Map</button>
        <button class="analysis-tab-btn" data-tab="variables"> Variables</button>
        <button class="analysis-tab-btn" data-tab="relations"> Relationships</button>
        <button class="analysis-tab-btn" data-tab="loops"> Loops & Archetypes</button>
        <button class="analysis-tab-btn" data-tab="strategy"> Strategic Context</button>
        <button class="analysis-tab-btn" data-tab="leverage"> Leverage Points</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="networkPanel" class="analysis-tab-panel"></div>
        <div id="variablesPanel" class="analysis-tab-panel"></div>
        <div id="relationsPanel" class="analysis-tab-panel"></div>
        <div id="loopsPanel" class="analysis-tab-panel"></div>
        <div id="strategyPanel" class="analysis-tab-panel"></div>
        <div id="leveragePanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Dashboard Panel ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4 space-y-6">
        <h3 class="text-2xl font-bold mb-4 text-center">System Analysis Dashboard</h3>`;

    // Top Archetype
    if (archetypes && archetypes.length > 0) {
        dashboardHtml += `
        <div class="archetype-card">
            <h3 class="text-lg font-bold text-indigo-300">Dominant System Archetype</h3>
            <p class="text-2xl font-semibold mt-1">${archetypes[0].name}</p>
            <p class="text-sm text-white/80 mt-2 italic">${archetypes[0].description || 'No description.'}</p>
        </div>`;
    }

    // Top Leverage Point
    if (leverage_points && leverage_points.length > 0) {
        const topLeverage = [...leverage_points].sort((a,b) => a.level - b.level)[0];
        dashboardHtml += `
        <div class="prescription-card border-l-4 border-red-500">
            <h3 class="text-lg font-bold text-red-300">Top Leverage Point (Level ${topLeverage.level})</h3>
            <p class="text-xl font-semibold mt-1">${topLeverage.type}</p>
            <p class="text-sm text-white/80 mt-2"><strong>Recommendation:</strong> ${topLeverage.recommendation}</p>
        </div>`;
    }
    
    // Summary cards
    dashboardHtml += `<div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div class="summary-stat-card"><p class="font-bold text-3xl">${concepts.length}</p><p class="text-xs">Variables</p></div>
        <div class="summary-stat-card"><p class="font-bold text-3xl">${relationships.length}</p><p class="text-xs">Relationships</p></div>
        <div class="summary-stat-card"><p class="font-bold text-3xl">${feedback_loops.length}</p><p class="text-xs">Feedback Loops</p></div>
        <div class="summary-stat-card"><p class="font-bold text-3xl">${archetypes.length}</p><p class="text-xs">Archetypes</p></div>
    </div></div>`;
    dashboardPanel.innerHTML = dashboardHtml;

    // --- 2. Populate System Map (Network) Panel ---
    // This is deferred until the tab is clicked, but we set up the container.
    const networkPanel = $("networkPanel");
    networkPanel.innerHTML = `
    <div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center">System Map</h3>
        <div id="systemNetworkChart" class="w-full h-[700px] bg-black/10 rounded-lg"></div>
        <div class="diagram-controls flex justify-center gap-2 mt-4">
            <button class="diagram-fit-btn" data-action="fit">Fit to View</button>
            <button class="diagram-reset-btn" data-action="reset">Reset Zoom</button>
            <button class="diagram-export-btn" data-action="export">Export as PNG</button>
        </div>
    </div>`;
    
    // --- 3. Populate Variables Panel ---
    const variablesPanel = $("variablesPanel");
    let variablesHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">System Variables (Concepts)</h3><div class="overflow-x-auto"><table class="coeff-table styled-table text-sm">
        <thead><tr><th>Name</th><th>Type</th><th>Leverage Lvl (1-12)</th><th>Description</th></tr></thead><tbody>`;
    concepts.forEach(c => {
        variablesHtml += `<tr>
            <td class="font-semibold">${c.name}</td>
            <td>${c.type}</td>
            <td class="text-center">${c.leverage_level}</td>
            <td class="text-white/80">${c.description}</td>
        </tr>`;
    });
    variablesHtml += `</tbody></table></div></div>`;
    variablesPanel.innerHTML = variablesHtml;
    
    // --- 4. Populate Relationships Panel ---
    const relationsPanel = $("relationsPanel");
    let relationsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Causal Relationships</h3><div class="overflow-x-auto"><table class="coeff-table styled-table text-sm">
        <thead><tr><th>From</th><th>To</th><th>Polarity</th><th>Strength</th><th>Delay</th><th>Evidence</th></tr></thead><tbody>`;
    relationships.forEach(r => {
        relationsHtml += `<tr>
            <td class="font-semibold">${r.from}</td>
            <td class="font-semibold">${r.to}</td>
            <td class="text-center font-bold ${r.polarity === '+' ? 'text-green-400' : 'text-red-400'}">${r.polarity}</td>
            <td>${r.strength}</td>
            <td>${r.delay}</td>
            <td class="text-white/80 italic">"${r.evidence}"</td>
        </tr>`;
    });
    relationsHtml += `</tbody></table></div></div>`;
    relationsPanel.innerHTML = relationsHtml;
    
    // --- 5. Populate Loops & Archetypes Panel ---
    const loopsPanel = $("loopsPanel");
    let loopsHtml = `<div class="p-4 space-y-8">`;
    // Archetypes
    loopsHtml += `<div><h3 class="text-2xl font-bold mb-4">System Archetypes</h3><div class="space-y-4">`;
    archetypes.forEach(a => {
        loopsHtml += `<div class="archetype-card p-4">
            <h4 class="text-xl font-bold text-indigo-300">${a.name}</h4>
            <p class="text-sm text-white/80 my-2 italic">${a.description}</p>
            <p class="text-xs text-white/60"><strong>Dynamic:</strong> ${a.dynamic}</p>
            <p class="text-xs text-white/60"><strong>Nodes:</strong> ${a.nodes_involved.join(", ")}</p>
        </div>`;
    });
    loopsHtml += `</div></div>`;
    // Feedback Loops
    loopsHtml += `<div><h3 class="text-2xl font-bold mb-4">Feedback Loops</h3><div class="space-y-4">`;
    feedback_loops.forEach(l => {
        const isReinforcing = l.type === 'reinforcing';
        loopsHtml += `<div class="bg-black/20 p-4 rounded-lg border-l-4 ${isReinforcing ? 'border-green-400' : 'border-yellow-400'}">
            <h4 class="text-lg font-bold">${isReinforcing ? '' : ''} ${l.type.toUpperCase()} Loop</h4>
            <p class="text-sm text-white/80 my-2 italic">${l.description}</p>
            <p class="text-xs text-white/60"><strong>Variables:</strong> ${l.variables.join("  ")}  ...</p>
        </div>`;
    });
    loopsHtml += `</div></div></div>`;
    loopsPanel.innerHTML = loopsHtml;
    
    // --- 6. Populate Strategic Context Panel ---
    const strategyPanel = $("strategyPanel");
    let strategyHtml = `<div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Goals</h4>
            <ul class="list-disc list-inside text-sm space-y-1">${goals.map(g => `<li>${g}</li>`).join('')}</ul>
        </div>
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Stakeholders</h4>
            <ul class="list-disc list-inside text-sm space-y-1">${stakeholders.map(s => `<li>${s}</li>`).join('')}</ul>
        </div>
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-yellow-400">Constraints</h4>
            <ul class="list-disc list-inside text-sm space-y-1">${constraints.map(c => `<li>${c}</li>`).join('')}</ul>
        </div>
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-yellow-400">Assumptions</h4>
            <ul class="list-disc list-inside text-sm space-y-1">${assumptions.map(a => `<li>${a}</li>`).join('')}</ul>
        </div>
        <div class="bg-black/20 p-4 rounded-lg col-span-1 md:col-span-2">
            <h4 class="text-lg font-bold mb-2 text-red-400">Risks & Second-Order Effects</h4>
            <p class="text-sm text-white/70 mb-2"><strong>Missing Factors:</strong> ${missing_factors.join(", ")}</p>
            <ul class="text-sm space-y-2 mt-4">${second_order_effects.map(e => `
                <li class="border-t border-white/10 pt-2">
                    <strong>Action:</strong> ${e.action}<br>
                    <span class="text-green-400"><strong>Immediate:</strong> ${e.immediate}</span>  
                    <span class="text-red-400"><strong>Delayed (${e.timeline}):</strong> ${e.delayed}</span>
                </li>`).join('')}
            </ul>
        </div>
    </div>`;
    strategyPanel.innerHTML = strategyHtml;
    
    // --- 7. Populate Leverage Points Panel ---
    const leveragePanel = $("leveragePanel");
    let leverageHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Leverage Points (after Donella Meadows)</h3><div class="space-y-6">`;
    [...leverage_points].sort((a,b) => a.level - b.level).forEach(lp => {
        leverageHtml += `<div class="prescription-card border-l-4" style="border-color: hsl(${lp.level * 25}, 70%, 50%)">
            <h4 class="text-xl font-bold">Level ${lp.level}: ${lp.type}</h4>
            <p class="text-sm my-2 text-white/80">${lp.description}</p>
            <div class="p-3 bg-black/20 rounded mt-3 text-sm">
                <p><strong>Impact:</strong> <span class="font-semibold">${lp.impact}</span></p>
                <p><strong>Recommendation:</strong> ${lp.recommendation}</p>
            </div>
        </div>`;
    });
    leverageHtml += `</div></div>`;
    leveragePanel.innerHTML = leverageHtml;

    // --- 8. Populate Learn Panel ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding System Thinking</h3>
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is System Thinking?</h4>
            <p class="text-sm text-white/80">System thinking is a holistic approach to analysis that focuses on how a system's constituent parts interrelate and how systems work over time and within the context of larger systems. This analysis extracts variables, relationships, and feedback loops to build a comprehensive model of your situation.</p>
        </div>
        <details class="styled-details text-sm mt-4" open>
            <summary class="font-semibold">Common System Archetypes (Recurring Patterns)</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                <p><strong>Limits to Growth:</strong> Growth eventually slows or stops due to a limiting factor.</p>
                <p><strong>Shifting the Burden:</strong> Using a short-term fix distracts from a fundamental solution.</p>
                <p><strong>Fixes that Fail:</strong> A solution creates unintended consequences that worsen the original problem.</p>
                <p><strong>Success to the Successful:</strong> One group gets more resources, leading to even better performance and more resources, starving others.</p>
            </div>
        </details>
    </div>
    `;

    // --- NEW: Animate the new content ---
    // const newElementsToAnimate = container.querySelectorAll(
    //     '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    // );
    // animateElements(newElementsToAnimate);

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                if (e.target.dataset.tab === 'network') {
                    // Render the network chart only when its tab is clicked for the first time
                    const chartDiv = $('systemNetworkChart');
                    if (chartDiv && !chartDiv.hasChildNodes()) {
                        let cy = renderSystemNetworkTab(concepts, relationships, chartDiv);
                        document.querySelector('.diagram-fit-btn').addEventListener('click', () => fitDiagram(cy));
                        document.querySelector('.diagram-reset-btn').addEventListener('click', () => resetZoom(cy));
                        document.querySelector('.diagram-export-btn').addEventListener('click', () => exportPNG(cy));
                    }
                }
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
}



/**
 * RENDERER: System Network Diagram (with Cytoscape.js)
 * - NEW (v3 - Cytoscape): Replaces Plotly.js with Cytoscape.js for dynamic, automatic graph layout.
 * - Retains all data-driven styling: node size/color, edge width/color.
 * - Implements a simple hover tooltip to display node details.
 */
function renderSystemNetworkTab(concepts, relationships, containerId) {
    //const container = $(containerId);
    if (!containerId) return;

    // Robustly filter and normalize relationships.
    const nodesForFilter = concepts.map(c => ({ id: c.name, ...c }));
    const canonicalNameMap = new Map();
    nodesForFilter.forEach(node => {
        canonicalNameMap.set(node.id.trim().toLowerCase(), node.id);
    });
    const validRelationships = relationships.reduce((acc, link) => {
        if (link.from && link.to) {
            const fromLower = link.from.trim().toLowerCase();
            const toLower = link.to.trim().toLowerCase();
            if (canonicalNameMap.has(fromLower) && canonicalNameMap.has(toLower)) {
                acc.push({ ...link, from: canonicalNameMap.get(fromLower), to: canonicalNameMap.get(toLower) });
            }
        }
        return acc;
    }, []);

    // Transform data for Cytoscape.
    const cyNodes = concepts.map(c => ({
        group: 'nodes',
        data: { id: c.name, label: c.name, ...c }
    }));

    let nodeArray = cyNodes.slice(); // Use slice() to create a copy

    // 2. Perform the Fisher-Yates (or equivalent) shuffle
    for (let i = nodeArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [nodeArray[i], nodeArray[j]] = [nodeArray[j], nodeArray[i]];
}

    const strengthMap = { 'weak': 1, 'medium': 2, 'strong': 3 };
    const cyEdges = validRelationships.map(r => ({
        group: 'edges',
        data: {
            id: `${r.from}->${r.to}_${Math.random()}`, // Add random to avoid duplicate IDs
            source: r.from,
            target: r.to,
            strengthNum: strengthMap[r.strength] || 1,
            ...r
        }
    }));
    const elements = [...nodeArray, ...cyEdges];

    // Define style mappings
    const typeToColor = { 'driver': '#FBBC05', 'outcome': '#4285F4', 'constraint': '#EA4335', 'resource': '#34A853' };
    const polarityToColor = { '+': 'rgba(52, 168, 83, 0.9)', '-': 'rgba(234, 67, 53, 0.9)' };

    // Initialize Cytoscape
    try {
        const cy = cytoscape({
            container: containerId,
            elements: elements,
            // Zoom and pan settings
            zoom: 1,
            minZoom: 0.2,
            maxZoom: 5,
            zoomingEnabled: true,
            userZoomingEnabled: true,
            panningEnabled: true,
            userPanningEnabled: true,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'font-size': '12px',
                        'color': '#fff',
                        'text-valign': 'bottom',
                        'text-halign': 'center',
                        'text-margin-y': '5px',
                        'text-wrap': 'wrap',
                        'text-max-width': '80px',
                        // Node size based on leverage level (lower number = higher leverage = bigger size)
                        'width': 'mapData(leverage_level, 12, 1, 20, 70)',
                        'height': 'mapData(leverage_level, 12, 1, 20, 70)',
                        // Node color based on variable type
                        'background-color': (ele) => typeToColor[ele.data('type')] || '#808080',
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'curve-style': 'bezier',
                        'target-arrow-shape': 'triangle',
                        // Edge width based on relationship strength.
                        'width': 'mapData(strengthNum, 1, 3, 1, 5)',
                        // Edge color based on polarity.
                        'line-color': (ele) => polarityToColor[ele.data('polarity')] || '#808080',
                        'target-arrow-color': (ele) => polarityToColor[ele.data('polarity')] || '#808080',
                    }
                },
                { // Style for showing selection
                    selector: 'node:selected',
                    style: { 'border-width': 3, 'border-color': '#fff' }
                }
            ],
            layout: {
                name: 'circle',
                fit: true,
                avoidOverlap: true,
            }
        });
        
        // Show tooltip on hover.
        cy.on('mouseover', 'node', function(event) {
            const node = event.target;
            const data = node.data();
            const tooltipText = `<b>${data.label}</b><br>Type: ${data.type}<br>Leverage: ${data.leverage_level}<br>Desc: <i>${data.description}</i>`;
            
            let tooltip = document.getElementById('cy-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'cy-tooltip';
                tooltip.style.position = 'fixed';
                tooltip.style.padding = '8px';
                tooltip.style.backgroundColor = 'rgba(20, 20, 20, 0.85)';
                tooltip.style.color = 'white';
                tooltip.style.border = '1px solid #555';
                tooltip.style.borderRadius = '5px';
                tooltip.style.fontSize = '12px';
                tooltip.style.pointerEvents = 'none';
                tooltip.style.zIndex = '10000';
                tooltip.style.display = 'none';
                document.body.appendChild(tooltip);
            }
    
            tooltip.innerHTML = tooltipText;
            tooltip.style.display = 'block';

            // Position using native mouse coordinates.
            const mouseX = event.originalEvent.clientX;
            const mouseY = event.originalEvent.clientY;
            tooltip.style.left = mouseX + 15 + 'px';
            tooltip.style.top = mouseY - 15 + 'px';
        });

        // Hide tooltip when the mouse moves off of a node.
        cy.on('mouseout', 'node', function(event) {
            const tooltip = document.getElementById('cy-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        });

        // Hide tooltip on drag.
        cy.on('drag', 'node', function(event) {
            const tooltip = document.getElementById('cy-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        });

        // Fit the diagram to the viewport.
        cy.fit();

        return cy;
    } catch (e) {
        console.error("Failed to render Cytoscape Systems Thinking Network diagram:", e);
        containerId.innerHTML = `<div class="p-4 text-center text-red-400"> Error rendering diagram: ${e.message}</div>`;
    }

    return;
}




/**
 * Helper function to build a DOT string for Viz.js from analysis data.
 * --- FIX v2 --- Added safety checks for loop and loop.type
 */
function buildDotString(elements, causal_links, feedback_loops) {
    if (!elements || !causal_links) return "digraph G {}"; // Return empty graph if data is missing
    
    let dot = 'digraph G {\n';
    dot += '  layout=dot;\n';
    dot += '  overlap=false;\n';
    dot += '  splines=true;\n';
    dot += '  sep="+15,15";\n';
    dot += '  bgcolor="transparent";\n';
    dot += '  node [style=filled, shape=oval, fillcolor="rgba(0,0,0,0.3)", fontcolor="white", color="rgba(255,255,255,0.3)"];\n';
    dot += '  edge [fontcolor="white", fontsize=10];\n\n';

    // Define nodes
    elements.forEach(el => {
        // Safety check for el.type
        if (el.type && typeof el.type === 'string' && el.type.toLowerCase() === 'stock') {
            dot += `  "${el.name}" [shape=box, style="filled,bold", color="var(--primary)"];\n`;
        } else {
            dot += `  "${el.name}";\n`;
        }
    });

    // Get loop colors
    const loopColors = {};
    const colors = ["#2ECC71", "#E74C3C", "#3498DB", "#F39C12", "#9B59B6", "#1ABC9C"];
    let colorIndex = 0;
    
    if (feedback_loops) {
        // --- START FIX ---
        // Added checks for loop, loop.type, and typeof loop.type
        feedback_loops.forEach(loop => {
            const loopName = loop.name || loop.loop_name; // Handle both possible name keys
            if (loop && loop.type && typeof loop.type === 'string' && loop.type.toLowerCase() === 'reinforcing') {
                loopColors[loopName] = colors[colorIndex % colors.length];
                colorIndex++;
            }
        });
        feedback_loops.forEach(loop => {
            const loopName = loop.name || loop.loop_name; // Handle both possible name keys
             if (loop && loop.type && typeof loop.type === 'string' && loop.type.toLowerCase() === 'balancing') {
                loopColors[loopName] = colors[colorIndex % colors.length];
                colorIndex++;
            }
        });
        // --- END FIX ---
    }

    // Define edges
    dot += '\n';
    causal_links.forEach(link => {
        // Use loop color if available, otherwise default
        const color = loopColors[link.loop_name] || (link.loop_name === 'H' ? "rgba(100,100,255,0.6)" : "rgba(255,255,255,0.4)");
        let style = `color="${color}"`;
        if (link.polarity === '-') {
            style += ', arrowhead=tee';
        }
        // Add description as label, fallback to polarity
        const label = link.description || ` ${link.polarity} `;
        dot += `  "${link.from}" -> "${link.to}" [label=" ${label} ", ${style}];\n`;
    });

    // Add loop labels (if they exist)
    if (feedback_loops && feedback_loops.length > 0) {
        dot += '\n  labelloc="b";\n';
        let label = 'Key: ';
        Object.entries(loopColors).forEach(([name, color]) => {
             label += `<font color="${color}">${name}</font>  `;
        });
        dot += `  label = <${label}>;\n`;
    }

    dot += '}';
    return dot;
}

function createFactorAnalysisLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-4">
                               <h3 class="text-xl font-bold mb-4 text-white">Provide Business Information</h3>
                    
                                <div>
                                    <label for="factorLocation" class="block text-sm font-medium text-gray-200 mb-2">Location / Region</label>
                                    <input type="text" id="factorLocation" class="input-field" placeholder="e.g., Global, North America, Manufacturing Plant">
                                </div>

                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="factorContent" class="input-field h-48" placeholder="Describe your business, its operations, market environment, and internal resources..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="factorFile" id="factorFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .txt or .docx file...</span>
                                        </label>
                                        <input type="file" id="factorFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                    <div id="fileStats" class="text-sm text-white/70 text-center mt-2"></div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Analyze Factors</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                                <div class="text-center mt-4">
	                                <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                                </div> 
                            </div>
                        </div>
                        
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                            </div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;

        // Attach event listeners
        $("generateBtn").addEventListener("click", handleFactorAnalysis);
        reattachActionListeners();

        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
            reattachTabListeners($("analysisResult"));
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // Add listeners for radio buttons and file input
        $("textInput").addEventListener("change", () => {
            $("textInputArea").classList.remove("hidden");
            $("docUploadArea").classList.add("hidden");
        });
        $("docUpload").addEventListener("change", () => {
            $("textInputArea").classList.add("hidden");
            $("docUploadArea").classList.remove("hidden");
        });

        const fileInput = $("factorFile");
        if (fileInput) {
            fileInput.addEventListener("change", async (e) => {
                const label = $("factorFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                const fileStats = $("fileStats");
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    fileNameSpan.textContent = file.name;
                    label.classList.add("has-file");
                    try {
                        const text = await extractTextFromFile(file);
                        fileStats.innerHTML = `<p>Word Count: ${text.split(/\s+/).length}</p><p>Character Count: ${text.length}</p>`;
                    } catch (err) {
                        fileStats.innerHTML = `<p class="text-red-400">Error reading file.</p>`;
                    }
                } else {
                    fileNameSpan.textContent = "Select .txt or .docx file...";
                    label.classList.remove("has-file");
                    fileStats.innerHTML = "";
                }
            });
        }

        // Attach listener for the feedback link
                const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
                if (feedbackLink) {
                    feedbackLink.addEventListener("click", (e) => {
                        e.preventDefault();
                        
                        if (typeof navigateTo === 'function') {
                            navigateTo('feedback');
                        } else {
                            console.error("navigateTo function is not defined.");
                        }
                    });
                } else {
                    console.warn("Feedback link not found inside createFactorAnalysisLayout");
                }
}

async function handleFactorAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `
        <div class="text-center text-white/70 p-8">
            <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
            <h3 class="text-xl font-semibold text-white">Performing EXHAUSTIVE Factor Analysis...</h3>
            <p class="text-white/80 mb-2">Finding every factor and analyzing each one deeply. This may take a moment...</p>
        </div>`;
    setLoading("generate", true);

    const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
    const MODEL_NAME = "llama3.1:latest";

    try {
        const useDoc = $("docUpload").checked;
        let documentText = "";

        if (useDoc) {
            const file = $("factorFile").files[0];
            if (!file) throw new Error("Please select a document to upload.");
            documentText = await extractTextFromFile(file);
        } else {
            documentText = $("factorContent").value.trim();
            if (!documentText.trim()) throw new Error("Please enter business information in the text area.");
        }

        // --- NEW: INJECT LOCATION ---
        const location = $("factorLocation").value.trim();
        if (location) {
            documentText = `Target Location/Region: ${location}\n\n${documentText}`;
            console.log("Injected location into Factor Analysis prompt:", location);
        }
        // --- END NEW LOGIC ---

        const MAX_CONTEXT_LENGTH = 15000;
        let truncatedNote = "";
        if (documentText.length > MAX_CONTEXT_LENGTH) {
            documentText = documentText.substring(0, MAX_CONTEXT_LENGTH);
            truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters of the provided text.)`;
            console.warn(`Factor Analysis context truncated.`);
        }

        const prompt = `
            You are a meticulous senior strategic analyst. Your task is to perform an exhaustive and deeply detailed factor analysis based **ONLY** on the provided business text. You must find **EVERY SINGLE** relevant factor. ${truncatedNote}

            **USER'S BUSINESS DESCRIPTION:**
            \`\`\`
            ${documentText}
            \`\`\`

            **VALIDATION:**
            If the text is gibberish, return the INVALID structure.

            **DETAILED TASKS:**
            1.  **Identify Internal Factors:** Exhaustively scan the text for **ALL** internal positive factors (Strengths) and internal negative factors (Weaknesses).
            2.  **Identify External Factors:** Exhaustively scan the text for **ALL** external positive factors (Opportunities) and external negative factors (Threats).
            3.  **Provide Deep Analysis for EACH Factor:** For **EVERY** factor identified, you MUST provide the following detailed structure:
                * \`factor\`: The concise name of the factor (e.g., "Strong Brand Reputation").
                * \`category\`: The business function it relates to (e.g., "Marketing", "Operations", "Financial", "PESTEL - Technology").
                * \`description\`: A 1-2 sentence description summarizing the factor **using wording found in or directly inferred from the text**.
                * \`impact_score\`: A plausible impact score (integer 1-10, where 10 is highest impact) based **only** on its significance as suggested **by the text**.
                * \`analysis\`: A nested object containing the deep analysis:
                    * \`facts\`: A list of 3-5 specific, relevant factual statements about this factor **based *only* on the text**.
                    * \`deductions\`: A list of 3-4 logical inferences drawn **from the facts above**.
                    * \`conclusions\`: A list of 2-3 strategic implications. Each **MUST** include: Impact (High/Medium/Low), Urgency (Critical/Important/Monitor), and Stance (Leverage/Improve/Mitigate/Monitor).
                    * \`summary\`: A concise 2-3 sentence summary of this factor's strategic significance.

            **ABSOLUTE CONSTRAINTS:**
            - **BE EXHAUSTIVE:** Do not stop at 4-6 factors. Find all of them.
            - **CONTEXT IS KING:** Base **ALL** output **EXCLUSIVELY** on the provided text. **DO NOT** invent factors, analysis, or recommendations not supported by the text.
            - **DEEP ANALYSIS IS MANDATORY:** The \`analysis\` object with its 4 parts is the most critical part of this task for **EVERY** factor.
            - **JSON FORMAT:** Adhere EXACTLY to the nested structure.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object.
            {
              "internal_factors": {
                "strengths": [
                  {
                    "factor": "...", "category": "...", "description": "...", "impact_score": 9, 
                    "analysis": {
                      "facts": ["Fact 1...", "Fact 2..."],
                      "deductions": ["Deduction 1...", "Deduction 2..."],
                      "conclusions": ["- Impact: High...", "- Urgency: Critical...", "- Stance: Leverage..."],
                      "summary": "..."
                    }
                  }
                ],
                "weaknesses": [
                  {
                    "factor": "...", "category": "...", "description": "...", "impact_score": 7, 
                    "analysis": {
                      "facts": ["..."], "deductions": ["..."], "conclusions": ["- Impact: ..."], "summary": "..."
                    }
                  }
                ]
              },
              "external_factors": {
                "opportunities": [
                  {
                    "factor": "...", "category": "...", "description": "...", "impact_score": 8, 
                    "analysis": {
                      "facts": ["..."], "deductions": ["..."], "conclusions": ["- Impact: ..."], "summary": "..."
                    }
                  }
                ],
                "threats": [
                   {
                    "factor": "...", "category": "...", "description": "...", "impact_score": 6, 
                    "analysis": {
                      "facts": ["..."], "deductions": ["..."], "conclusions": ["- Impact: ..."], "summary": "..."
                    }
                  }
                ]
              }
            }
        `;

        console.log(`Sending DEEP Factor Analysis prompt (v2) to ${MODEL_NAME}...`);
        const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
        });

        if (!response.ok) {
            let errorBody = `API error ${response.status}`;
            try { errorBody += `: ${await response.text()}`; } catch (e) {}
            throw new Error(errorBody);
        }

        const data = await response.json();
        let parsedData;
        console.log('Raw AI Response (Factor Analysis):', data.response);
        try {
            parsedData = JSON.parse(data.response);
            
            if (!parsedData || typeof parsedData !== 'object' ||
                !parsedData.internal_factors || typeof parsedData.internal_factors !== 'object' ||
                !Array.isArray(parsedData.internal_factors.strengths) || !Array.isArray(parsedData.internal_factors.weaknesses) ||
                !parsedData.external_factors || typeof parsedData.external_factors !== 'object' ||
                !Array.isArray(parsedData.external_factors.opportunities) || !Array.isArray(parsedData.external_factors.threats) ||
                (parsedData.internal_factors.strengths.length > 0 && (
                    typeof parsedData.internal_factors.strengths[0] !== 'object' || 
                    !parsedData.internal_factors.strengths[0].hasOwnProperty('analysis') ||
                    typeof parsedData.internal_factors.strengths[0].analysis !== 'object' ||
                    !parsedData.internal_factors.strengths[0].analysis.hasOwnProperty('facts')
                ))
               )
            {
                console.error("Validation Failed (DEEP Factor Analysis v2): Required fields or new 'analysis' object structure missing.", parsedData);
                throw new Error(`AI response structure is incorrect. Missing internal/external factors or the required 'analysis' object.`);
            }
            console.log(`Successfully parsed DEEP Factor Analysis JSON (v2) using ${MODEL_NAME}.`);

        } catch (e) {
            console.error(`Failed to parse/validate DEEP Factor Analysis JSON (v2) using ${MODEL_NAME}:`, data?.response, e);
            throw new Error(`Invalid JSON received or validation failed (DEEP Factor Analysis v2): ${e.message}.`);
        }

        renderFactorAnalysisPage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleFactorAnalysis (DEEP v2) using ${MODEL_NAME}:`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
        }
    }
}

// Keep applyParetoAnalysisJS as it's used to process AI output
function applyParetoAnalysisJS(factors) {
    if (!factors || factors.length === 0) return [];

    // Ensure impact_score is numeric before sorting
    const validFactors = factors.filter(f => typeof f.impact_score === 'number' && !isNaN(f.impact_score));
    if (validFactors.length === 0) {
        console.warn("No factors with valid numeric impact scores found for Pareto analysis.");
        // Return original factors with default priority/rank if scores were bad
        return factors.map((f, i) => ({ ...f, cumulative_percentage: 0, priority: "Low", rank: i + 1 }));
    }


    const sorted_factors = [...validFactors].sort((a, b) => b.impact_score - a.impact_score);
    const total_impact = sorted_factors.reduce((sum, f) => sum + f.impact_score, 0);

    if (total_impact === 0) {
        // Handle case where all scores are 0
        return sorted_factors.map((f, i) => ({ ...f, cumulative_percentage: 0, priority: "Low", rank: i + 1 }));
    }

    let cumulative_impact = 0;
    return sorted_factors.map((factor, i) => {
        cumulative_impact += factor.impact_score;
        const cumulative_percentage = (cumulative_impact / total_impact) * 100;
        return {
            ...factor,
            cumulative_percentage: parseFloat(cumulative_percentage.toFixed(1)),
            priority: cumulative_percentage <= 80 ? "High" : "Low",
            rank: i + 1
        };
    });
}


/**
 * NEW MASTER RENDERER for Factor Analysis.
 * Creates a 7-tab layout: Dashboard, Impact Map, S, W, O, T, Learn.
 * Calls helper functions to render each tab's content.
 */
function renderFactorAnalysisPage(container, data) {
    container.innerHTML = ""; // Clear loading state

    // Basic validation for the comprehensive structure
    if (!data || !data.internal_factors || !data.external_factors) {
         console.error("Incomplete data passed to renderFactorAnalysisPage:", data);
         container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received.</div>`;
         $("analysisActions").classList.add("hidden");
         return;
    }

    const { internal_factors, external_factors } = data;
    // Consolidate all factors into one array for the dashboard & map
    const allFactors = [
        ...(internal_factors.strengths || []).map(f => ({ ...f, type: 'Strength' })),
        ...(internal_factors.weaknesses || []).map(f => ({ ...f, type: 'Weakness' })),
        ...(external_factors.opportunities || []).map(f => ({ ...f, type: 'Opportunity' })),
        ...(external_factors.threats || []).map(f => ({ ...f, type: 'Threat' }))
    ];

    // --- Create Tab Navigation (7 Tabs) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="impactMap"> Impact Map</button>
        <button class="analysis-tab-btn" data-tab="strengths"> Strengths</button>
        <button class="analysis-tab-btn" data-tab="weaknesses"> Weaknesses</button>
        <button class="analysis-tab-btn" data-tab="opportunities"> Opportunities</button>
        <button class="analysis-tab-btn" data-tab="threats"> Threats</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Factors</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (7 Panels) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="impactMapPanel" class="analysis-tab-panel"></div>
        <div id="strengthsPanel" class="analysis-tab-panel"></div>
        <div id="weaknessesPanel" class="analysis-tab-panel"></div>
        <div id="opportunitiesPanel" class="analysis-tab-panel"></div>
        <div id="threatsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Dashboard Panel ---
    renderFactorDashboardTab("dashboardPanel", allFactors, internal_factors, external_factors);

    // --- 2. Populate Impact Map Panel ---
    renderImpactMapTab("impactMapPanel", allFactors);

    // --- 3-6. Populate Detail Tabs ---
    renderFactorDetailTab("strengthsPanel", internal_factors.strengths || [], "Strengths", "border-green-500");
    renderFactorDetailTab("weaknessesPanel", internal_factors.weaknesses || [], "Weaknesses", "border-red-500");
    renderFactorDetailTab("opportunitiesPanel", external_factors.opportunities || [], "Opportunities", "border-blue-500");
    renderFactorDetailTab("threatsPanel", external_factors.threats || [], "Threats", "border-yellow-500");
    
    // --- 7. Populate Learn Panel ---
    renderLearnFactorAnalysisTab("learnPanel");

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);


    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (with Plotly resize)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                
                // Resize any Plotly charts within the newly active panel
                const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                chartsInPanel.forEach(chartDiv => {
                    // Check if it's a rendered Plotly chart
                    if (chartDiv.layout && typeof Plotly !== 'undefined') { 
                        try {
                            Plotly.Plots.resize(chartDiv);
                        } catch (resizeError) {
                            console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                        }
                    }
                });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });
    
    // Attempt initial resize for charts in the default active tab
     setTimeout(() => {
         const activePanel = tabContent.querySelector('.analysis-tab-panel.active');
         if (activePanel) {
             activePanel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                 if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                     try {
                          Plotly.Plots.resize(chartDiv);
                     } catch (initialResizeError) {
                          console.error(`Error during initial resize ${chartDiv.id}:`, initialResizeError);
                     }
                 }
             });
         }
     }, 150); // Delay slightly

    $("analysisActions").classList.remove("hidden"); // Show save buttons
}

/**
 * NEW HELPER: Renders the Factor Analysis Dashboard tab.
 */
function renderFactorDashboardTab(containerId, allFactors, internal_factors, external_factors) {
    const container = $(containerId);
    if (!container) return;

    let dashboardHtml = `<div class="p-4">
                            <h3 class="text-2xl font-bold mb-6 text-center">Factor Analysis Dashboard</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-4xl mx-auto mb-8">
                                <div class="summary-stat-card"><div class="stat-value text-green-400">${internal_factors.strengths.length}</div><div class="stat-label">Strengths</div></div>
                                <div class="summary-stat-card"><div class="stat-value text-red-400">${internal_factors.weaknesses.length}</div><div class="stat-label">Weaknesses</div></div>
                                <div class="summary-stat-card"><div class="stat-value text-blue-400">${external_factors.opportunities.length}</div><div class="stat-label">Opportunities</div></div>
                                <div class="summary-stat-card"><div class="stat-value text-yellow-400">${external_factors.threats.length}</div><div class="stat-label">Threats</div></div>
                            </div>`;
    
    // Find most critical factor
    const allSorted = allFactors.sort((a, b) => (b.impact_score || 0) - (a.impact_score || 0));
    const criticalFactor = allSorted[0];

    if (criticalFactor) {
        dashboardHtml += `<div class="bg-black/20 p-6 rounded-lg max-w-3xl mx-auto border-l-4 border-red-500">
                            <h4 class="text-xl font-bold mb-3 text-center text-red-300">Most Critical Factor Identified (Highest Impact)</h4>
                            <p class="text-lg font-bold text-center">${criticalFactor.factor} (Impact: ${criticalFactor.impact_score}/10)</p>
                            <p class="text-sm text-center text-white/70 italic mb-3">Type: ${criticalFactor.type} | Category: ${criticalFactor.category}</p>
                            <div class="rationale text-sm">
                                <strong>Analysis Summary:</strong> ${criticalFactor.analysis.summary || 'N/A'}
                            </div>
                         </div>`;
    }
    dashboardHtml += `</div>`; // Close p-4
    container.innerHTML = dashboardHtml;
}

/**
 * MODIFIED HELPER: Renders a detail tab (S, W, O, T)
 * NOW INCLUDES a horizontal bar chart of factors by category.
 *
 * --- FIX ---
 * Moved `categoryCounts` declaration to the top-level scope of the function
 * so it is accessible by both the HTML-building block and the
 * Plotly-rendering block.
 */
function renderFactorDetailTab(panelId, factors, title, borderColorClass) {
    const panel = $(panelId);
    if (!panel) return;

    let categoryCounts = {}; // <-- FIX: Declared in outer scope
    let html = `<div class="p-4 space-y-6">
                    <h3 class="text-3xl font-bold mb-4 text-center">${title} (${factors.length})</h3>`;
    
    if (factors.length > 0) {
        // --- NEW: Category Bar Chart ---
        categoryCounts = factors.reduce((acc, f) => { // <-- FIX: Initialize here
            const category = f.category || "Uncategorized";
            acc[category] = (acc[category] || 0) + 1;
            return acc;
        }, {});
        const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]); // Sort by count desc

        html += `<div class="mb-8">
                    <h4 class="text-xl font-semibold mb-3 text-center">Factor Count by Category</h4>
                    <div id="${panelId}-chart" class="w-full h-[${30 + sortedCategories.length * 40}px] min-h-[200px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
                 </div>`;
        // --- END NEW ---

        // Sort by impact score, highest first, for the list
        factors.sort((a, b) => (b.impact_score || 0) - (a.impact_score || 0));
        
        factors.forEach((factor, index) => {
            const analysis = factor.analysis || { facts: [], deductions: [], conclusions: [], summary: "Analysis not provided." };
            
            html += `
                <div class="prescription-card ${borderColorClass} p-5">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-xl font-bold">${index + 1}. ${factor.factor}</h4>
                        <span class="text-lg font-bold text-yellow-300" title="Impact Score">(${factor.impact_score}/10)</span>
                    </div>
                    <p class="text-xs font-semibold text-indigo-300 uppercase mb-2">Category: ${factor.category || 'N/A'}</p>
                    <p class="text-sm text-white/80 italic mb-4"><strong>Description:</strong> ${factor.description || 'N/A'}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-black/20 p-4 rounded-lg space-y-3">
                            <div>
                                <h5 class="font-bold text-green-300 mb-2"> Facts</h5>
                                <ul class="list-disc list-inside text-sm text-white/80 space-y-1">
                                    ${(analysis.facts && analysis.facts.length > 0) 
                                        ? analysis.facts.map(f => `<li>${f}</li>`).join('') 
                                        : '<li>No facts provided.</li>'}
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-bold text-green-300 mb-2"> Deductions</h5>
                                <ul class="list-disc list-inside text-sm text-white/80 space-y-1">
                                    ${(analysis.deductions && analysis.deductions.length > 0) 
                                        ? analysis.deductions.map(d => `<li>${d}</li>`).join('') 
                                        : '<li>No deductions provided.</li>'}
                                </ul>
                            </div>
                        </div>

                        <div class="bg-black/20 p-4 rounded-lg space-y-3">
                            <div>
                                <h5 class="font-bold text-yellow-300 mb-2"> Conclusions</h5>
                                <ul class="list-disc list-inside text-sm text-white/80 space-y-1">
                                    ${(analysis.conclusions && analysis.conclusions.length > 0) 
                                        ? analysis.conclusions.map(c => `<li>${c}</li>`).join('') 
                                        : '<li>No conclusions provided.</li>'}
                                </ul>
                            </div>
                            <div class="mt-4">
                                <h5 class="font-bold text-indigo-300 mb-2"> Summary</h5>
                                <p class="text-sm text-white/80 italic">
                                    ${analysis.summary || 'No summary provided.'}
                                </p>
                            </div>
                        </div>
                    </div>
                    </div>
            `;
        });
    } else {
        html += `<p class="text-center text-white/70 italic">No factors identified for this category based on the provided text.</p>`;
    }
    html += `</div>`; // Close p-4
    panel.innerHTML = html;

    // --- Render the new Category Bar Chart ---
    if (factors.length > 0) {
        try {
            // Sort ascending for horizontal bar chart
            const chartData = Object.entries(categoryCounts).sort((a, b) => a[1] - b[1]); // 'categoryCounts' is now in scope
            const trace = {
                y: chartData.map(c => c[0]), // Categories on Y-axis
                x: chartData.map(c => c[1]), // Counts on X-axis
                type: 'bar',
                orientation: 'h', // Horizontal
                marker: { color: borderColorClass.replace('border-', 'color-mix(in srgb, var(--') + ') 70%, transparent)' } // Use tab color
            };
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: 'white' },
                xaxis: { title: 'Number of Factors', gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { automargin: true, tickfont: { size: 10 } },
                margin: { t: 20, b: 40, l: 150, r: 20 } // Give space for Y-axis labels
            };
            Plotly.newPlot(`${panelId}-chart`, [trace], layout, { responsive: true });
        } catch(e) {
            console.error(`Category chart render error for ${panelId}-chart:`, e);
            $(`${panelId}-chart`).innerHTML = `<p class="text-red-400 text-center pt-10">Chart render error: ${e.message}</p>`;
        }
    }
}

/**
 * NEW HELPER: Renders the Factor Impact Map (Bubble Chart) tab.
 *
 * --- FIX v3 ---
 * 1. REMOVED the broken `sizeref` and `sizemin` properties.
 * 2. MODIFIED the `size` array to map impact scores directly to a
 * reasonable pixel diameter (e.g., 10px for impact 1, 46px for impact 10).
 * 3. INCREASED the axis `range` padding to -0.75 / +0.25 to "zoom out"
 * and ensure no bubbles are clipped at the edges.
 */
function renderImpactMapTab(containerId, allFactors) {
    const container = $(containerId);
    if (!container) return;
    
    let html = `<div class="p-4">
                    <h3 class="text-2xl font-bold mb-4 text-center">Factor Impact Map</h3>
                    <p class="text-sm text-white/70 text-center mb-6 max-w-2xl mx-auto">This map visualizes all factors. The Y-axis shows the business category, the X-axis shows the strategic type, and the size of each bubble represents its impact score.</p>
                    <div id="factorImpactMapChart" class="w-full h-[600px] bg-black/10 rounded-lg p-2 plotly-chart"></div>
                </div>`;
    container.innerHTML = html;
    
    if (allFactors && allFactors.length > 0) {
        
        // --- Data Prep ---
        const types = ['Strength', 'Weakness', 'Opportunity', 'Threat'];
        // Get unique categories from the data and sort them
        const categories = [...new Set(allFactors.map(f => f.category || 'Uncategorized'))].sort();

        const trace = {
            x: allFactors.map(f => f.type),
            y: allFactors.map(f => f.category || 'Uncategorized'),
            text: allFactors.map(f => `<strong>${f.factor}</strong><br>Impact: ${f.impact_score}<br>${f.description}`),
            mode: 'markers',
            marker: {
                // --- FIX: Use direct pixel sizing ---
                // Map impact_score (1-10) to a pixel size (e.g., 10px to 46px)
                size: allFactors.map(f => (f.impact_score || 1) * 4 + 6), 
                // --- FIX: REMOVED `sizeref` and `sizemin` ---
                color: allFactors.map(f => {
                    if (f.type === 'Strength') return '#28a745';
                    if (f.type ==='Weakness') return '#dc3545';
                    if (f.type === 'Opportunity') return '#007bff';
                    if (f.type === 'Threat') return '#ffc107';
                    return '#6c757d';
                }),
                opacity: 0.7,
            },
            type: 'scatter',
            hovertemplate: '%{text}<extra></extra>'
        };

        const layout = {
            title: 'Factor Impact Map by Category and Type',
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: 'white' },
            xaxis: { 
                title: 'Factor Type', 
                gridcolor: 'rgba(255,255,255,0.1)',
                categoryorder: 'array',
                categoryarray: types,
                // --- FIX: Add more padding to "zoom out" ---
                range: [-0.75, types.length - 0.25] // Adds 0.75 padding on each side
            },
            yaxis: { 
                title: 'Business Category', 
                gridcolor: 'rgba(255,255,255,0.1)',
                automargin: true,
                categoryorder: 'array',
                categoryarray: categories.reverse(), // Show from top to bottom
                // --- FIX: Add more padding to "zoom out" ---
                range: [-0.75, categories.length - 0.25] // Adds 0.75 padding on each side
            },
            margin: { t: 60, b: 100, l: 150, r: 40 }, // Keep margins for labels
            hovermode: 'closest'
        };

        try {
            Plotly.newPlot('factorImpactMapChart', [trace], layout, { responsive: true });
        } catch(e) { 
            console.error("Impact Map render error:", e); 
            $('factorImpactMapChart').innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; 
        }
    } else {
        $('factorImpactMapChart').innerHTML = "<p class='text-white/70 italic text-center pt-10'>No factors identified to plot.</p>";
    }
}

/**
 * NEW HELPER: Renders the static "Learn" tab for Factor Analysis.
 */
function renderLearnFactorAnalysisTab(containerId) {
    const container = $(containerId);
    if (!container) return;

    container.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Factor Analysis (Strategic Context)</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is Strategic Factor Analysis?</h4>
            <p class="text-sm text-white/80">In strategic planning, factor analysis involves systematically identifying and evaluating key internal and external elements that can influence an organization's ability to achieve its objectives. It's the foundation of a SWOT analysis.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2"> External Factor Analysis (PESTEL+)</h4>
                

[Image of PESTEL analysis diagram]

                <p class="text-xs text-white/70 mb-2 italic">Understanding the macro-environment.</p>
                <ul class="space-y-1 text-sm">
                    <li><strong>P</strong>olitical: Government stability, policy, regulation, taxes.</li>
                    <li><strong>E</strong>conomic: Growth rates, inflation, interest rates, exchange rates, employment.</li>
                    <li><strong>S</strong>ocial: Demographics, cultural trends, lifestyle changes, consumer attitudes.</li>
                    <li><strong>T</strong>echnological: Innovation, automation, R&D, digital trends.</li>
                    <li><strong>E</strong>nvironmental: Climate change, sustainability, weather, resource availability.</li>
                    <li><strong>L</strong>egal: Laws affecting employment, competition, health & safety, consumer protection.</li>
                    <li><strong>+ Market/Competitive:</strong> Industry trends, market size, competition intensity, supplier/buyer power.</li>
                </ul>
                <p class="text-xs text-white/70 mt-2"><strong>Goal:</strong> Identify Opportunities & Threats.</p>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2"> Internal Factor Analysis (Resources & Capabilities)</h4>
                <p class="text-xs text-white/70 mb-2 italic">Assessing the organization's own assets and abilities.</p>
                <ul class="space-y-1 text-sm">
                    <li><strong>Financial:</strong> Profitability, cash flow, funding access, cost structure.</li>
                    <li><strong>Physical:</strong> Facilities, equipment, location, raw materials access.</li>
                    <li><strong>Human Resources:</strong> Skills, experience, motivation, culture, leadership.</li>
                    <li><strong>Technological:</strong> IT infrastructure, patents, R&D capabilities, proprietary tech.</li>
                    <li><strong>Organizational:</strong> Structure, processes, reputation, brand equity, partnerships.</li>
                    <li><strong>Marketing & Sales:</strong> Brand recognition, distribution channels, customer relationships.</li>
                 </ul>
                 <p class="text-xs text-white/70 mt-2"><strong>Goal:</strong> Identify Strengths & Weaknesses.</p>
            </div>
        </div>
         <div class="bg-black/20 p-4 rounded-lg mt-6">
            <h4 class="text-lg font-bold mb-2 text-yellow-300"> From Identification to Analysis (How this tool works)</h4>
            <p class="text-sm text-white/80">Simply listing factors is not enough. This tool's AI provides a deep analysis for each factor:</p>
            <ul class="list-disc list-inside space-y-1 text-sm mt-2">
                <li><strong>Facts:</strong> What is the objective evidence for this factor from your text?</li>
                <li><strong>Deductions:</strong> What logical inferences can be drawn from the facts?</li>
                <li><strong>Conclusions:</strong> What is the strategic implication (Impact, Urgency, Stance)?</li>
                <li><strong>Summary:</strong> What is the simple takeaway for this factor?</li>
            </ul>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to find all factors in your text and provide this deep analysis for each one.</p>
    </div>
    `;
}
// Modified renderFactorTab to use AI categories and factor details
function renderFactorTab(containerId, title, factors) {
    const container = $(containerId);
    let contentHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">${title}</h3>`; // Added p-4

    if (factors && factors.length > 0) {
        // Group factors by AI-provided category
        const categories = factors.reduce((acc, f) => {
            const category = f.category || "Uncategorized"; // Handle missing category
            if (!acc[category]) acc[category] = [];
            acc[category].push(f);
            return acc;
        }, {});

        // Sort categories alphabetically
        const sortedCategories = Object.keys(categories).sort();

        // Chart: Factor Count by Category
        contentHtml += `<div id="${containerId}-chart" class="w-full h-[400px] mb-8 bg-black/10 rounded-lg p-2 plotly-chart"></div>`;

        // Details sections for each category
         sortedCategories.forEach(category => {
            contentHtml += `<div class="mb-6"><details class="styled-details" ${sortedCategories.length <= 3 ? 'open' : ''}> <!-- Open details if few categories -->
                            <summary class="font-semibold text-lg">${category} (${categories[category].length} factors)</summary>
                            <div class="bg-black/20 p-4 rounded-b-lg space-y-4">`; // Use styled-details background
            // Sort factors within category by rank (desc impact)
            categories[category].sort((a, b) => a.rank - b.rank);
            categories[category].forEach((factor) => {
                 const priorityColor = factor.priority === "High" ? "text-red-400" : "text-yellow-400";
                 const swotColor = factor.swot === 'Strength' || factor.swot === 'Opportunity' ? 'text-green-400' : 'text-red-400';
                 contentHtml += `<div class="py-2 border-b border-white/10 last:border-b-0">
                                <p class="flex justify-between items-center">
                                    <span class="font-semibold text-white">${factor.factor}</span>
                                    <span class="text-xs ${priorityColor}"><strong>Rank #${factor.rank}</strong> | Prio: ${factor.priority}</span>
                                </p>
                                <p class="text-sm text-white/80 my-1 italic">${factor.description || 'No description provided.'}</p>
                                <p class="text-xs text-white/60">
                                    <span class="${swotColor}">${factor.swot}</span> |
                                    Score: ${factor.impact_score.toFixed(1)} |
                                    Cumul %: ${factor.cumulative_percentage}%
                                </p>
                            </div>`;
            });
            contentHtml += `</div></details></div>`; // Close details content and details tag
         });

    } else {
        contentHtml += '<p class="text-white/70 italic text-center">No factors identified in this category based on the provided text.</p>';
    }

    contentHtml += `</div>`; // Close p-4
    container.innerHTML = contentHtml;

    // Render Category Chart
    if (factors && factors.length > 0) {
        const categoryCounts = Object.entries(
            factors.reduce((acc, f) => {
                const category = f.category || "Uncategorized";
                acc[category] = (acc[category] || 0) + 1;
                return acc;
            }, {})
        ).sort((a, b) => b[1] - a[1]); // Sort by count desc

        try {
            Plotly.newPlot(
                `${containerId}-chart`,
                [{
                    x: categoryCounts.map(c => c[0]),
                    y: categoryCounts.map(c => c[1]),
                    type: 'bar',
                    marker: { color: 'var(--primary)' }
                }],
                {
                    title: `${title.split('(')[0]} Factors by Category`, // Clean title
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                    xaxis: { automargin: true, tickangle: -30, tickfont: { size: 10 } }, // Smaller font
                    yaxis: { title: 'Number of Factors', gridcolor: 'rgba(255,255,255,0.1)' },
                    margin: { t: 50, b: 80, l: 50, r: 20 } // Adjust margins
                },
                { responsive: true }
            );
        } catch(e) { console.error(`Chart render error for ${containerId}-chart:`, e); $(`${containerId}-chart`).innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }
    }
}


// Modified renderParetoTab to use AI factors and details
function renderParetoTab(containerId, allFactors) {
    const container = $(containerId);
    let contentHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> 80/20 Pareto Analysis - Combined Factors</h3>`; // Added p-4

    if (allFactors && allFactors.length > 0) {
        // Sort ALL factors by rank (desc impact) for the chart
        const sortedFactors = [...allFactors].sort((a, b) => a.rank - b.rank);
        const topFactorsForChart = sortedFactors.slice(0, 20); // Limit chart display for readability

        contentHtml += `<div id="pareto-chart-container" class="w-full h-[600px] mb-8 bg-black/10 rounded-lg p-2 plotly-chart"></div>`;

        const highPriorityFactors = sortedFactors.filter(f => f.priority === "High");
        contentHtml += `<h4 class="text-xl font-semibold mt-8 mb-3 text-center"> High Priority Factors (Top ~80% Impact)</h4>
                        <p class="text-sm text-white/70 mb-6 italic text-center">Focus strategic efforts on these ${highPriorityFactors.length} factors identified by the AI and prioritized using the Pareto principle.</p>`;

        // Display high priority factors in two columns: Internal vs External
        const highInternal = highPriorityFactors.filter(f => f.type === 'Internal');
        const highExternal = highPriorityFactors.filter(f => f.type === 'External');

        contentHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
        // Internal High Priority
        contentHtml += `<div class="bg-black/20 p-4 rounded-lg">
                           <h5 class="font-bold mb-3 text-center text-blue-300">Internal Priorities (${highInternal.length})</h5>
                           <div class="space-y-3">`;
        if (highInternal.length > 0) {
            highInternal.forEach(f => {
                const swotColor = f.swot === 'Strength' ? 'text-green-400' : 'text-red-400';
                 contentHtml += `<div class="text-xs p-2 bg-black/30 rounded">
                                    <p class="flex justify-between items-center">
                                        <span class="font-semibold text-white">${f.factor}</span>
                                        <span class="text-red-400">Rank #${f.rank}</span>
                                    </p>
                                    <p class="text-white/70 italic my-1">${f.description || ''}</p>
                                    <p class="text-white/60"><span class="${swotColor}">${f.swot}</span> | Cat: ${f.category || 'N/A'} | Score: ${f.impact_score.toFixed(1)}</p>
                                 </div>`;
            });
        } else {
            contentHtml += `<p class="text-white/60 italic text-center text-sm">No high priority internal factors identified.</p>`;
        }
        contentHtml += `</div></div>`; // Close internal div

        // External High Priority
        contentHtml += `<div class="bg-black/20 p-4 rounded-lg">
                            <h5 class="font-bold mb-3 text-center text-yellow-300">External Priorities (${highExternal.length})</h5>
                            <div class="space-y-3">`;
        if (highExternal.length > 0) {
            highExternal.forEach(f => {
                const swotColor = f.swot === 'Opportunity' ? 'text-green-400' : 'text-red-400';
                 contentHtml += `<div class="text-xs p-2 bg-black/30 rounded">
                                     <p class="flex justify-between items-center">
                                        <span class="font-semibold text-white">${f.factor}</span>
                                        <span class="text-red-400">Rank #${f.rank}</span>
                                    </p>
                                    <p class="text-white/70 italic my-1">${f.description || ''}</p>
                                    <p class="text-white/60"><span class="${swotColor}">${f.swot}</span> | Cat: ${f.category || 'N/A'} | Score: ${f.impact_score.toFixed(1)}</p>
                                  </div>`;
            });
        } else {
             contentHtml += `<p class="text-white/60 italic text-center text-sm">No high priority external factors identified.</p>`;
        }
        contentHtml += `</div></div>`; // Close external div
        contentHtml += `</div>`; // Close grid

    } else {
        contentHtml += '<p class="text-white/70 italic text-center">No factors available for Pareto analysis.</p>';
    }

    contentHtml += `</div>`; // Close p-4
    container.innerHTML = contentHtml;

    // Render Pareto Chart
    if (allFactors && allFactors.length > 0) {
         // Use the limited, sorted list for the chart
         const sortedFactors = [...allFactors].sort((a, b) => a.rank - b.rank);
         const topFactorsForChart = sortedFactors.slice(0, 20);

        const trace1 = {
            x: topFactorsForChart.map(f => `(#${f.rank}) ${f.factor.substring(0, 30)}...`), // Add rank, shorten name
            y: topFactorsForChart.map(f => f.impact_score),
            name: 'Impact Score',
            type: 'bar',
            marker: { color: topFactorsForChart.map(f => f.priority === 'High' ? 'var(--accent)' : 'var(--primary)') }
        };

        const trace2 = {
            x: topFactorsForChart.map(f => `(#${f.rank}) ${f.factor.substring(0, 30)}...`),
            y: topFactorsForChart.map(f => f.cumulative_percentage),
            name: 'Cumulative %',
            type: 'scatter', mode: 'lines+markers', // Add markers
            yaxis: 'y2',
            line: { color: '#FFF', width: 2 }, // Thicker white line
            marker: {size: 6}
        };

        const layout = {
            title: '80/20 Pareto Analysis - Top 20 Factors by Impact', // Updated title
            xaxis: { tickangle: -45, automargin: true, tickfont: { size: 9 } }, // Even smaller font
            yaxis: { title: 'Impact Score (1-10)', gridcolor: 'rgba(255,255,255,0.1)' },
            yaxis2: { title: 'Cumulative Impact %', overlaying: 'y', side: 'right', range: [0, 101], gridcolor: 'rgba(255,255,255,0.1)', zeroline: false },
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
            legend: { orientation: 'h', y: -0.3 }, // Adjust legend position maybe
            shapes: [{
                type: 'line', xref: 'paper', yref: 'y2', x0: 0, y0: 80, x1: 1, y1: 80,
                line: { color: 'orange', width: 2, dash: 'dash' }
            }],
             margin: { t: 50, b: 120, l: 50, r: 50 } // Adjust margins
        };

        try {
            Plotly.newPlot('pareto-chart-container', [trace1, trace2], layout, { responsive: true });
        } catch(e) { console.error("Pareto chart render error:", e); $("pareto-chart-container").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }
    }
}


// Modified renderSummaryTab to use AI factors
function renderSummaryTab(containerId, external, internal) {
    const container = $(containerId);

     // Ensure factors are arrays
     external = Array.isArray(external) ? external : [];
     internal = Array.isArray(internal) ? internal : [];

    const highPriorityExternal = external.filter(f => f.priority === 'High').length;
    const highPriorityInternal = internal.filter(f => f.priority === 'High').length;

    // Find top categories based on *count* of high-priority items
    const getTopHighPriorityCategory = (factors) => {
         if (!factors || factors.length === 0) return "N/A";
         const highPriority = factors.filter(f => f.priority === 'High');
         if (highPriority.length === 0) return "N/A (None High Priority)";
         const counts = highPriority.reduce((acc, f) => {
              const cat = f.category || "Uncategorized";
              acc[cat] = (acc[cat] || 0) + 1;
              return acc;
         }, {});
         return Object.entries(counts).sort((a,b) => b[1] - a[1])[0][0];
    };

    const topExtCatHighPrio = getTopHighPriorityCategory(external);
    const topIntCatHighPrio = getTopHighPriorityCategory(internal);

    container.innerHTML = `
        <div class="p-4"> <!-- Added p-4 -->
            <h3 class="text-2xl font-bold mb-4"> Executive Summary</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="summary-stat-card"><div class="stat-value">${external.length}</div><div class="stat-label">Total External Factors</div></div>
                <div class="summary-stat-card"><div class="stat-value">${internal.length}</div><div class="stat-label">Total Internal Factors</div></div>
                <div class="summary-stat-card ${highPriorityExternal > 0 ? 'border-l-4 border-red-500' : ''}"><div class="stat-value">${highPriorityExternal}</div><div class="stat-label">High-Priority External</div></div>
                <div class="summary-stat-card ${highPriorityInternal > 0 ? 'border-l-4 border-red-500' : ''}"><div class="stat-value">${highPriorityInternal}</div><div class="stat-label">High-Priority Internal</div></div>
            </div>
            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-xl font-semibold mb-3">Key Insights & Strategic Focus</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li>A total of <strong>${external.length + internal.length}</strong> strategic factors were identified from the text.</li>
                    <li>Pareto analysis highlighted <strong>${highPriorityExternal + highPriorityInternal}</strong> factors (${highPriorityExternal} external, ${highPriorityInternal} internal) as 'High Priority', representing the critical few likely driving ~80% of strategic impact.</li>
                    <li>The most frequent category among high-priority <strong>external</strong> factors appears to be <strong>${topExtCatHighPrio}</strong>. Strategies should consider leveraging opportunities or mitigating threats in this area.</li>
                    <li>The most frequent category among high-priority <strong>internal</strong> factors appears to be <strong>${topIntCatHighPrio}</strong>. Strategies should focus on exploiting related strengths or addressing related weaknesses.</li>
                    <li><strong>Recommendation:</strong> Focus primary strategic efforts on the ${highPriorityExternal + highPriorityInternal} 'High Priority' factors identified in the '80/20 Analysis' tab.</li>
                </ul>
            </div>
         </div>`; // Close p-4
}



/**
 * HANDLER: KPI & Critical Events (Strategic Planning)
 * - NEW: Re-engineered to act as a "Research Plan Analyst".
 * - Prompt is now specifically trained to parse the user's research plan.
 * - It identifies constructs (e.g., "Service Quality")
 * and extracts their bulleted indicators (e.g., "Website responsiveness") as the KPIs,
 * and groups them under their parent construct.
 * - It finds the measurement scale (e.g., "7-point Likert scales").
 * - It extracts critical events from the research plan itself.
 */
async function handleKpiAnalysis_KE() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Analyzing Research Plan...</h3><p class="text-white/80 mb-2">Extracting specific indicators, scales, and milestones from your text...</p></div>`;
        setLoading("generate", true);

        // Define URL and Model
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";

        try {
            // 1. Gather Inputs
            const useDoc = $("docUpload").checked;
            let text = "";
            if (useDoc) {
                const file = $("kpiFile").files[0];
                if (!file) throw new Error("Please select a document.");
                text = await extractTextFromFile(file);
            } else {
                text = $("kpiContent").value.trim();
                if (!text.trim()) throw new Error("Please describe the project or goal.");
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("kpiLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
                console.log("Injected location into KPI Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (text.length > MAX_CONTEXT_LENGTH) {
                text = text.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
                console.warn(`KPI & Events analysis context truncated.`);
            }

            // 2. Construct NEW, HIGH-ACCURACY Prompt
            const prompt = `
            You are a meticulous research analyst and strategic consultant. Your task is to analyze the provided business context **ONLY** and extract its core components into a structured JSON.

            **USER'S BUSINESS CONTEXT:**
            \`\`\`
            ${text}
            \`\`\`

            **VALIDATION:**
            If the text is gibberish or contains no meaningful content, return the INVALID structure.

            **DETAILED TASKS (Ground all answers *strictly* in the text):**
            1.  **Extract Goal:** Identify the \`main_goal\` of the research/project (e.g., "to understand the key drivers of customer satisfaction...").
            2.  **Extract KPI Groups:**
                * First, identify the main constructs/problems (e.g., "SERVICE QUALITY", "Unstable Control Feedback Loops").
                * Then, for each construct, extract its *specific bulleted indicators* as the KPIs (e.g., "Website responsiveness", "Temperature regulation accuracy").
                * Create an array of \`kpi_groups\`. For each group:
                    * \`construct_name\`: The parent construct (e.g., "Service Quality", "Unstable Control Feedback Loops").
                    * \`kpis\`: An array of KPI objects. For each KPI:
                        * \`name\`: The specific indicator (e.g., "Website responsiveness", "Temperature regulation accuracy").
                        * \`formula\`: A plausible, specific measurement scale or formula for this KPI (e.g., "Page Load Time (ms)", "Avg. Deviation from Setpoint (C)", "Latency (ms)", "% of accurate calibrations", "Uptime %"). **If the text mentions a specific scale (like '1-7 scale'), use that. Otherwise, YOU MUST GENERATE a logical one.**
                        * \`type\`: Infer the category (e.g., "Operational", "Customer", "Financial").
            3.  **Extract Critical Events:** Identify key project milestones **from the text** (e.g., conducting the survey, developing the roadmap). Create an array of \`critical_events\`. For each event:
                * \`event_name\`: Name of the milestone (e.g., "Conduct Customer Survey").
                * \`description\`: What signifies completion (e.g., "Survey of 500 customers completed").
                * \`timeline\`: Timeframe (e.g., "Within 6 months", "3-year").
                * \`importance\`: Assess importance ("High" or "Medium").
            4.  **Extract Summary:** Extract the \`performance_summary\` or "Expected Business Impact" section.

            **ABSOLUTE CONSTRAINTS:**
            - **USE INDICATORS AS KPIs:** The KPIs *must* be the sub-items (e.g., "Product durability"), NOT the main constructs (e.g., "PRODUCT QUALITY").
            - **STICK TO THE TEXT:** Do NOT invent KPIs, scales, or events not present in the text, *unless* you are generating a formula as instructed.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object.
            {
              "main_goal": "[Goal extracted from text, e.g., 'To address severe challenges related to multiple dynamic systems...']",
              "kpi_groups": [
                {
                  "construct_name": "Unstable Control Feedback Loops",
                  "kpis": [
                    {"name": "Automated control systems stability", "formula": "Oscillation Frequency (Hz) or Uptime %", "type": "Operational"},
                    {"name": "Temperature regulation accuracy", "formula": "Avg. Deviation from Setpoint (C)", "type": "Operational"}
                  ]
                },
                {
                  "construct_name": "Cross-System Latency",
                  "kpis": [
                    {"name": "IoT sensor data synchronization", "formula": "Max Data Lag (seconds)", "type": "Data"},
                    {"name": "Communication latency", "formula": "Latency (ms)", "type": "Data"}
                  ]
                }
                // ... *all* other constructs and their indicators found in the text ...
              ],
              "critical_events": [
                {"event_name": "Conduct Comprehensive System Audit", "description": "Identify all conflicting dynamic interactions", "timeline": "Within 6 Months", "importance": "High"},
                {"event_name": "Rebuild Data Integration Pipelines", "description": "Implement asynchronous event-driven architecture", "timeline": "Within 9 Months", "importance": "High"}
              ],
              "performance_summary": "[Summary of expected business impact, extracted from text...]"
            }
        `;

            // 3. Send Request to Ollama
            console.log(`Sending RESEARCH-FOCUSED KPI prompt (v-fix) to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
            });

            if (!response.ok) {
                let errorBody = `API error ${response.status}`;
                try { errorBody += `: ${await response.text()}`; } catch (e) {}
                throw new Error(errorBody);
            }

            const data = await response.json();
            let parsedData;
            console.log('Raw AI Response (KPI & Events - v-fix):', data.response);
            try {
                parsedData = JSON.parse(data.response);
                 // *** Validation for the new GROUPED structure ***
                 console.log('--- RAW AI JSON RESPONSE (Parsed - v-fix) ---');
                 console.log(JSON.stringify(parsedData, null, 2));
                 console.log('------------------------------------');

                 if (!parsedData || !parsedData.main_goal || !Array.isArray(parsedData.kpi_groups) || parsedData.kpi_groups.length < 1 ||
                     !Array.isArray(parsedData.critical_events) ||
                     !parsedData.performance_summary ||
                     // Check the *first group* and its *first KPI* for correct structure
                     !parsedData.kpi_groups[0].construct_name ||
                     !Array.isArray(parsedData.kpi_groups[0].kpis) ||
                     parsedData.kpi_groups[0].kpis.length < 1 ||
                     !parsedData.kpi_groups[0].kpis[0].name ||
                     !parsedData.kpi_groups[0].kpis[0].formula // Check that formula is no longer "None"
                    )
                 {
                      // Check if the formula is "None", which is the problem we're fixing
                      if (parsedData.kpi_groups[0].kpis[0].formula.toLowerCase() === "none") {
                          console.error("Validation Failed (v-fix): AI returned 'None' for formula despite new prompt.", parsedData);
                          throw new Error(`AI failed to generate a formula and returned 'None'. This may be a model context issue.`);
                      }
                      console.error("Validation Failed (v-fix): AI returned an invalid `kpi_groups` structure or had missing fields.", parsedData);
                      throw new Error(`AI response structure is incorrect. It may have failed to group KPIs. Check console.`);
                 }
                 console.log(`Successfully parsed (v-fix) KPI JSON using ${MODEL_NAME}. Found ${parsedData.kpi_groups.length} KPI groups.`);

            } catch (e) {
                console.error(`Failed to parse/validate (v-fix) KPI JSON using ${MODEL_NAME}:`, data?.response, e);
                throw new Error(`Invalid JSON received or validation failed (v-fix): ${e.message}. See raw response in console.`);
            }

            // 4. Render Results
            renderKpiPage_KE(analysisResultContainer, parsedData); // Call the NEW renderer

        } catch (error) {
            console.error(`Error in handleKpiAnalysis_KE (v-fix) using ${MODEL_NAME}:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
             if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
             }
        }
    }

/**
 * RENDERER: KPI & Critical Events (Strategic Planning)
 * - NEW: Re-engineered to render the `kpi_groups` structure.
 * - Tab 1 (Dashboard): Cleaned up. Shows Goal, Summary, and Critical Events.
 * - Tab 2 (KPI Details): NEW grouped layout. Renders KPIs under their parent construct.
 * - Tabs 3, 4, 5 (Timeline, Event Details, Learn): Unchanged, as they were already good.
 */
function renderKpiPage_KE(container, data) {
    container.innerHTML = ""; // Clear loading state

    // --- Input Data Validation (for NEW kpi_groups structure) ---
    if (!data || typeof data !== 'object' ||
        !data.main_goal || typeof data.main_goal !== 'string' ||
        !Array.isArray(data.kpi_groups) || // Check for kpi_groups
        !Array.isArray(data.critical_events) ||
        !data.performance_summary || typeof data.performance_summary !== 'string')
    {
        console.error("Incomplete or invalid data passed to renderKpiPage_KE (v2):", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received (kpi_groups missing). Cannot render results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    // Destructure data *after* validation
    const { main_goal, kpi_groups, critical_events, performance_summary } = data;
    const all_kpis_flat = kpi_groups.flatMap(g => g.kpis); // For the "Learn" tab example, if needed

    // --- Create Tab Navigation (5 Tabs) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="kpiDetails"> KPI Details</button>
        <button class="analysis-tab-btn" data-tab="timeline"> Events Timeline</button>
        <button class="analysis-tab-btn" data-tab="eventDetails"> Event Details</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn KPIs & Milestones</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (5 Panels) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="kpiDetailsPanel" class="analysis-tab-panel"></div>
        <div id="timelinePanel" class="analysis-tab-panel"></div>
        <div id="eventDetailsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate KPI Dashboard Panel (NEW CLEANED VERSION) ---
    try {
        const dashboardPanel = $("dashboardPanel");
        let dashboardHtml = `<div class="p-4 space-y-8">
            <div class="p-6 rounded-lg bg-black/20 border border-white/10 text-center">
                <h3 class="text-xl font-bold mb-2 text-indigo-300"> Main Goal</h3>
                <p class="text-2xl italic text-white/90">${main_goal}</p>
            </div>
            <blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90 text-sm">
                <strong>Performance Summary:</strong> ${performance_summary}
            </blockquote>
            <h3 class="text-2xl font-bold text-center">Critical Events</h3>`;

        if (critical_events.length > 0) {
             dashboardHtml += `<div class="grid grid-cols-1 md:grid-cols-${Math.min(critical_events.length, 3)} gap-6">`;
             critical_events.forEach((event) => {
                 if (event && typeof event === 'object' && event.hasOwnProperty('event_name')) {
                     const importanceColor = event.importance === 'High' ? 'border-red-500' : 'border-yellow-500';
                     dashboardHtml += `
                        <div class="summary-stat-card text-left p-4 border-l-4 ${importanceColor}">
                            <p class="font-bold text-lg text-white">${event.event_name || 'Unnamed Event'}</p>
                            <p class="text-sm text-white/80">${event.description || 'N/A'}</p>
                            <p class="text-xs text-indigo-300 font-semibold mt-2">Timeline: ${event.timeline || 'N/A'}</p>
                        </div>`;
                 }
             });
             dashboardHtml += `</div>`; // Close grid
        } else {
            dashboardHtml += `<p class="col-span-full text-center text-white/60 italic">No critical events identified.</p>`;
        }
        dashboardHtml += `</div>`; // Close p-4 space-y-8
        dashboardPanel.innerHTML = dashboardHtml;
    } catch (e) {
         console.error("Error rendering Dashboard Panel:", e);
         $("dashboardPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering dashboard.</div>`;
    }

    // --- 2. Populate KPI Details Panel (NEW GROUPED VERSION) ---
    try {
        const kpiDetailsPanel = $("kpiDetailsPanel");
        let kpiDetailsHtml = `<div class="p-4 space-y-8"><h3 class="text-2xl font-bold mb-4 text-center"> KPI Details (Grouped by Construct)</h3>`;

        if (kpi_groups.length > 0) {
            kpi_groups.forEach((group) => {
                if (group && typeof group === 'object' && group.construct_name && Array.isArray(group.kpis)) {
                    kpiDetailsHtml += `
                        <div class="bg-black/10 p-4 rounded-lg">
                            <h4 class="text-xl font-semibold mb-3 text-indigo-300">${group.construct_name}</h4>
                            <div class="overflow-x-auto">
                                <table class="coeff-table styled-table text-sm">
                                    <thead><tr>
                                        <th>KPI (Indicator)</th>
                                        <th>Measurement Scale / Formula</th>
                                        <th>Type</th>
                                    </tr></thead>
                                    <tbody>`;
                    
                    if (group.kpis.length > 0) {
                        group.kpis.forEach((kpi) => {
                            if (kpi && typeof kpi === 'object' && kpi.hasOwnProperty('name')) {
                                kpiDetailsHtml += `<tr>
                                    <td class="font-semibold">${kpi.name || 'Unnamed KPI'}</td>
                                    <td class="font-mono text-xs">${kpi.formula || 'N/A'}</td>
                                    <td class="text-white/70">${kpi.type || 'N/A'}</td>
                                </tr>`;
                            }
                        });
                    } else {
                        kpiDetailsHtml += `<tr><td colspan="3" class="text-center text-white/60 italic p-4">No KPIs identified for this construct.</td></tr>`;
                    }

                    kpiDetailsHtml += `</tbody></table></div></div>`; // Close table div and group div
                }
            });
        } else {
            kpiDetailsHtml += `<p class="text-center text-white/60 italic p-4">No KPI groups were identified from the text.</p>`;
        }
        kpiDetailsHtml += `</div>`; // Close p-4
        kpiDetailsPanel.innerHTML = kpiDetailsHtml;
    } catch (e) {
         console.error("Error rendering KPI Details Panel:", e);
         $("kpiDetailsPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering KPI details.</div>`;
    }

    // --- 3. Populate Events Timeline Panel (Unchanged) ---
    try {
        const timelinePanel = $("timelinePanel");
        let timelineHtml = `<div class="p-4"><h2 class="text-3xl font-bold text-center mb-8">${main_goal} - Critical Events Timeline</h2><div class="action-plan-container flex flex-col items-center">`;
        if (critical_events.length > 0) {
            const sorted_events = [...critical_events].sort((a, b) => {
                 const getTimeValue = (timeline) => {
                     timeline = String(timeline || '').toLowerCase();
                     if (timeline.includes('week')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 7;
                     if (timeline.includes('month')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 30;
                     if (timeline.includes('q')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 90;
                     if (timeline.includes('year')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 365;
                     return 9999;
                 };
                 return getTimeValue(a.timeline) - getTimeValue(b.timeline);
             });

            sorted_events.forEach((event) => {
                 if (event && typeof event === 'object' && event.hasOwnProperty('event_name')) {
                    const importanceColor = event.importance === 'High' ? '#ef4444' : '#f97316';
                    const importanceIcon = event.importance === 'High' ? '' : '';

                    timelineHtml += `
                        <div class="timeline-item">
                            <div class="timeline-dot" style="border-color: ${importanceColor};"></div>
                            <div class="timeline-content border-l-4" style="border-left-color: ${importanceColor};">
                                <p class="text-xs text-indigo-300 font-semibold">${event.timeline || 'N/A'}</p>
                                <h4 class="text-lg font-bold">${event.event_name || 'Unnamed Event'}</h4>
                                <p class="text-xs font-bold mt-1">${importanceIcon} Importance: ${event.importance || 'N/A'}</p>
                            </div>
                        </div>`;
                 }
            });
        } else {
            timelineHtml += `<p class="text-center text-white/70 italic">No critical events were identified from the text.</p>`;
        }
        timelineHtml += `</div></div>`;
        timelinePanel.innerHTML = timelineHtml;
    } catch (e) {
        console.error("Error rendering Timeline Panel:", e);
        $("timelinePanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering timeline.</div>`;
    }

    // --- 4. Populate Event Details Panel (Unchanged) ---
    try {
        const eventDetailsPanel = $("eventDetailsPanel");
        let eventDetailsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> Event Details</h3>`;
        eventDetailsHtml += `<div class="overflow-x-auto">
                            <table class="coeff-table styled-table text-sm">
                                <thead><tr><th>Event Name</th><th>Description (Completion Criteria)</th><th>Timeline</th><th>Importance</th></tr></thead>
                                <tbody>`;
        if (critical_events.length > 0) {
            critical_events.forEach((event) => {
                 if (event && typeof event === 'object' && event.hasOwnProperty('event_name')) {
                    const importanceColor = event.importance === 'High' ? 'text-red-400' : 'text-yellow-400';
                    eventDetailsHtml += `<tr>
                                    <td class="font-semibold">${event.event_name || 'Unnamed Event'}</td>
                                    <td class="text-white/80">${event.description || 'N/A'}</td>
                                    <td class="text-white/70">${event.timeline || 'N/A'}</td>
                                    <td><span class="font-bold ${importanceColor}">${event.importance || 'N/A'}</span></td>
                                  </tr>`;
                 }
            });
        } else {
            eventDetailsHtml += `<tr><td colspan="4" class="text-center text-white/60 italic p-4">No event details were identified from the text.</td></tr>`;
        }
        eventDetailsHtml += `</tbody></table></div></div>`;
        eventDetailsPanel.innerHTML = eventDetailsHtml;
    } catch (e) {
        console.error("Error rendering Event Details Panel:", e);
        $("eventDetailsPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering event details.</div>`;
    }

    // --- 5. Populate Learn KPIs & Milestones Panel (Unchanged) ---
    try {
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
        <div class="p-6 space-y-6 text-white/90">
            <h3 class="text-2xl font-bold text-center mb-4"> Understanding KPIs & Milestones</h3>
             
            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-lg font-bold mb-2 text-indigo-300">Why Track Performance?</h4>
                <p class="text-sm text-white/80">Tracking performance is crucial for strategy execution. Key Performance Indicators (KPIs) measure progress towards goals, while Critical Events (Milestones) mark significant achievements along the way. Together, they provide visibility and enable course correction.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2 text-green-300"> Key Performance Indicators (KPIs)</h4>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><strong>Definition:</strong> Measurable values demonstrating how effectively a company is achieving key business objectives.</li>
                        <li><strong>In Research:</strong> KPIs are often the specific *indicators* or *survey questions* used to measure a larger, abstract *construct*.</li>
                        <li><strong>Types:</strong>
                            <ul class="list-[circle] list-inside pl-4 text-xs">
                               <li><strong>Lagging Indicators:</strong> Measure past performance (e.g., Revenue, Churn Rate).</li>
                               <li><strong>Leading Indicators:</strong> Measure activities likely to drive future results (e.g., Website Visits, Training Hours).</li>
                               <li><strong>Operational:</strong> Measures process efficiency (e.g., Website responsiveness).</li>
                               <li><strong>Customer:</strong> Measures perception/behavior (e.g., NPS, CSAT).</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2 text-yellow-300"> Critical Events (Milestones)</h4>
                     <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><strong>Definition:</strong> Significant points or achievements in a project or strategic initiative timeline.</li>
                        <li><strong>Examples:</strong> Project Kick-off, Design Approval, Product Launch, Funding Secured, Regulatory Approval, First Customer Acquired.</li>
                        <li><strong>In Research:</strong> Milestones include "Conduct Survey," "Analyze Data," and "Present Findings," or "Develop Roadmap."</li>
                        <li><strong>Purpose:</strong> Break down large projects, track progress, provide clear deadlines, facilitate communication.</li>
                     </ul>
                </div>
            </div>
             <div class="bg-black/20 p-4 rounded-lg mt-6">
                <h4 class="text-lg font-bold mb-2">Connecting KPIs and Milestones</h4>
                 <ul class="list-disc list-inside space-y-1 text-sm">
                    <li>Milestones mark *when* key things happen; KPIs measure *how well* things are happening.</li>
                    <li>Achieving a milestone (e.g., "Launch Survey") enables the measurement of KPIs (e.g., "NPS").</li>
                    <li>KPI trends (e.g., "Low CSAT") can trigger the need for new projects with new milestones.</li>
                </ul>
            </div>
             <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to identify potential KPIs (as indicators) and Critical Events based strictly on the goal/project description you provided.</p>
        </div>
        `;
    } catch (e) {
         console.error("Error rendering Learn Panel:", e);
         $("learnPanel").innerHTML = `<div class="p-4 text-center text-red-400">Error rendering learning content.</div>`;
    }

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Final Touches ---
    try {
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result
        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add("active");
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });
        $("analysisActions").classList.remove("hidden"); // Show save buttons
    } catch (e) {
         console.error("Error setting up final touches (tabs, cache, buttons):", e);
         if (!container.innerHTML.includes('text-red-400')) {
              container.innerHTML += `<div class="p-4 text-center text-red-400">Error setting up UI components.</div>`;
         }
    }
}



    /**
     * Creates the UI for the Mission Vision tool with Ollama/N8N toggle.
     */
    function createMissionVisionLayout(template) {
        const contentContainer = $("templateDetailContent");
        contentContainer.className = "grid lg:grid-cols-1 gap-12";
        contentContainer.innerHTML = `
            <div class="lg:col-span-1">
                <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
            
                <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                    <h3 class="text-xl font-bold mb-4 text-white">Provide Company Context</h3>
                    
                    <div>
                        <label for="companyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label>
                        <input type="text" id="companyName" class="input-field" placeholder="e.g., ${preFillData || 'Innovate Inc.'}" required>
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-200 mb-2">Location</label>
                        <input type="text" id="location" class="input-field" placeholder="e.g., Global" required>
                    </div>
                    <div>
                        <label for="companyDocumentsFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Company Documents</label>
                        <div class="input-file-wrapper">
                            <label for="companyDocumentsFile" id="companyDocumentsFileLabel" class="input-file-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                <span class="file-name">Click to select a file...</span>
                            </label>
                            <input type="file" id="companyDocumentsFile" class="input-file">
                        </div>
                    </div>
                    <div class="input-radio-group">
                        <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                        <label for="textInput" class="input-radio-label">Manual Text Input</label>
                        <input type="radio" name="inputType" id="docUpload" class="input-radio" disabled>
                        <label for="docUpload" class="input-radio-label opacity-50 cursor-not-allowed">Use Document Above</label>
                    </div>
                    <div id="textInputArea">
                        <label for="missionVisionContent" class="block text-sm font-medium text-gray-200 mb-2">Or Paste Context Here</label>
                        <textarea id="missionVisionContent" class="input-field h-32" placeholder="Describe your company, its purpose, its products, and its primary objectives... (Note: Uploading a document above is recommended)"></textarea>
                    </div>
                    
                    <div class="border-t border-white/10 pt-4 mt-4">
                        <h4 class="text-lg font-bold mb-3 text-white">Choose Analysis Engine</h4>
                        <div class="space-y-3">
                            <label class="custom-checkbox">
                                <input type="radio" name="analysisEngine" id="useOllama" class="custom-checkbox-input" value="ollama" checked>
                                <span class="custom-checkbox-checkmark"></span>
                                <span class="custom-checkbox-label">
                                    <span class="font-semibold text-white"> Llama 3.1 </span>
                                    <span class="text-sm text-gray-300 block mt-1">Deep component analysis with breakdowns, values, and goals</span>
                                </span>
                            </label>
                            
                            <label class="custom-checkbox">
                                <input type="radio" name="analysisEngine" id="useN8N" class="custom-checkbox-input" value="n8n">
                                <span class="custom-checkbox-checkmark"></span>
                                <span class="custom-checkbox-label">
                                    <span class="font-semibold text-white"> RAG-Enhanced output</span>
                                    <span class="text-sm text-gray-300 block mt-1">Fast strategic foundation with mission, vision, and analysis</span>
                                </span>
                            </label>
                            
                            <p id="toggleError" class="text-red-400 text-xs hidden mt-2"> Please select an analysis engine</p>
                        </div>
                    </div>
                    
                    <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                        <span id="generateBtnText">Generate Mission & Vision</span>
                        <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                    <div class="text-center mt-4">
                        <a href="#" class="btn-tertiary nav-link text-sm" data-page="feedback">Have feedback on this tool?</a>
                    </div>
                </div>
                
                <div class="mt-12">
                    <h2 class="text-3xl font-bold mb-4 text-center">Generated Analysis</h2>
                    <div id="analysisResult" class="glass-container min-h-[300px] whitespace-pre-wrap overflow-x-auto">
                    </div>
                    <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                        <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                        <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                    </div>
                </div>
            </div>
        `;

        // Add CSS for custom Radio Buttons (Circular)
        const style = document.createElement('style');
        style.textContent = `
            .custom-checkbox {
                display: flex;
                align-items: flex-start;
                cursor: pointer;
                padding: 12px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                transition: all 0.2s ease;
                position: relative;
            }
            
            .custom-checkbox:hover {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.2);
            }
            
            .custom-checkbox-input {
                position: absolute;
                opacity: 0;
                cursor: pointer;
                height: 0;
                width: 0;
            }
            
            /* Circle Container for Radio */
            .custom-checkbox-checkmark {
                position: relative;
                top: 2px;
                height: 20px;
                width: 20px;
                background: rgba(255, 255, 255, 0.1);
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%; /* Make it round */
                margin-right: 12px;
                flex-shrink: 0;
                transition: all 0.2s ease;
            }
            
            .custom-checkbox:hover .custom-checkbox-checkmark {
                border-color: rgba(255, 255, 255, 0.5);
            }
            
            .custom-checkbox-input:checked ~ .custom-checkbox-checkmark {
                background: transparent;
                border-color: #667eea;
            }
            
            /* Dot Indicator for Radio */
            .custom-checkbox-input:checked ~ .custom-checkbox-checkmark::after {
                content: "";
                position: absolute;
                left: 50%;
                top: 50%;
                width: 10px;
                height: 10px;
                background: #667eea; /* Solid color dot */
                border-radius: 50%;
                transform: translate(-50%, -50%);
                box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
            }
            
            .custom-checkbox-label {
                flex: 1;
            }
            
            .custom-checkbox-input:focus ~ .custom-checkbox-checkmark {
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
            }
        `;
        document.head.appendChild(style);

        // Re-attach event listeners
        $("generateBtn").addEventListener("click", handleGenerate);
        reattachActionListeners();
        
        // --- Setup Logic for this specific page ---
        const fileInput = $("companyDocumentsFile");
        const textInputToggle = $("textInput");
        const docUploadToggle = $("docUpload");
        const textArea = $("textInputArea");
        
        // Radio button logic for input type
        textInputToggle.addEventListener("change", () => {
            textArea.classList.remove("hidden");
        });
        docUploadToggle.addEventListener("change", () => {
            textArea.classList.add("hidden");
        });

        // File input logic
        if (fileInput) {
            fileInput.addEventListener("change", (e) => {
                const label = $("companyDocumentsFileLabel");
                const fileNameSpan = label.querySelector(".file-name");
                if (e.target.files.length > 0) {
                    fileNameSpan.textContent = e.target.files[0].name;
                    label.classList.add("has-file");
                    docUploadToggle.checked = true;
                    docUploadToggle.disabled = false;
                    docUploadToggle.nextElementSibling.classList.remove("opacity-50", "cursor-not-allowed");
                    textInputToggle.checked = false;
                    textArea.classList.add("hidden");
                } else {
                    fileNameSpan.textContent = "Click to select a file...";
                    label.classList.remove("has-file");
                    docUploadToggle.checked = false;
                    docUploadToggle.disabled = true;
                    docUploadToggle.nextElementSibling.classList.add("opacity-50", "cursor-not-allowed");
                    textInputToggle.checked = true;
                    textArea.classList.remove("hidden");
                }
            });
        }
        
        // Restore from cache or set default
        if (analysisCache[currentTemplateId]) {
            $("analysisResult").innerHTML = analysisCache[currentTemplateId];
            $("analysisActions").classList.remove("hidden");
        } else {
            $("analysisResult").innerHTML =
                '<div class="text-white/60 p-8 text-center">Your generated mission and goals will appear here.</div>';
            $("analysisActions").classList.add("hidden");
        }

        // Attach listener for the feedback link manually (Safeguard)
        const feedbackLink = contentContainer.querySelector('a[data-page="feedback"]');
        if (feedbackLink) {
            feedbackLink.removeEventListener("click", handleNavLinkClick); // Avoid duplicates
            feedbackLink.addEventListener("click", handleNavLinkClick);
        }
    }


    /**
     * OLLAMA CASCADE: Strategic Plan (10-Part Parallel Analysis)
     * Generates the full strategic plan using User Context + N8N RAG Data.
     */
    async function ollamaCascadeStrategicPlan(n8nResult, fullContext) {
        console.log("Ollama Cascade: Starting Comprehensive Strategic Plan generation (Expanded)...");
        
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";
        
        const statusEl = document.getElementById("analysisStatus");
        if (statusEl) statusEl.textContent = "Step 2/2: Synthesizing Full Strategic Plan (12 Sections)...";

        // Construct Combined Context
        const combinedContext = `
            **USER'S INTERNAL CONTEXT:**
            ${fullContext}

            **EXTERNAL STRATEGIC CONTEXT (RAG/AI Analysis):**
            - Book Insights: ${n8nResult.external_data?.book_summary || 'N/A'}
            - Market/Web Insights: ${n8nResult.external_data?.web_summary || 'N/A'}
        `;
        
        const MAX_CONTEXT_LENGTH = 25000; // Increased for larger context
        const ollamaText = combinedContext.substring(0, MAX_CONTEXT_LENGTH);

        // --- Helper for Parallel Calls ---
        async function generateSection(prompt, sectionName) {
            if (statusEl) statusEl.textContent = `Generating: ${sectionName}...`;
            try {
                const response = await fetch(OLLAMA_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
                });
                if (!response.ok) throw new Error(`Error generating ${sectionName}`);
                const data = await response.json();
                return JSON.parse(data.response);
            } catch (e) {
                console.error(`Failed to generate ${sectionName}:`, e);
                return {}; 
            }
        }

        // --- Define Prompts (Context-Aware) ---
        const basePrompt = `**CONTEXT:**\n\`\`\`\n${ollamaText}\n\`\`\`\n**CONSTRAINT:** Base output on the provided Context. Return ONLY valid JSON.`;

        const prompts = {
            intro: `${basePrompt} **TASK:** Write an 'introduction' string summarizing the company and the plan's purpose. {"introduction": "..."}`,
            overview: `${basePrompt} **TASK:** Write an 'executive_overview' string summarizing the current situation and strategic direction. {"executive_overview": "..."}`,
            mv: `${basePrompt} **TASK:** Define 'mission_statement' and 'vision_statement'. {"mission_statement": "...", "vision_statement": "..."}`,
            goals: `${basePrompt} **TASK:** Identify 3-5 'strategic_goals' (goal_name, description, rationale). {"strategic_goals": [...] }`,
            init: `${basePrompt} **TASK:** Identify 4-6 'strategic_initiatives' (initiative_name, description, strategic_importance). {"strategic_initiatives": [...] }`,
            obj: `${basePrompt} **TASK:** Define specific 'objectives' (objective_name, target, timeline, measurement). {"objectives": [...] }`,
            action: `${basePrompt} **TASK:** Create an 'action_plan' (action_item, responsible_party, deadline, priority). {"action_plan": [...] }`,
            risk: `${basePrompt} **TASK:** Assess 'risk_management' (risk_description, impact, mitigation_strategy). {"risk_management": [...] }`,
            // --- NEW PROMPTS ---
            gov: `${basePrompt} **TASK:** Outline the 'governance' structure required to execute this plan (roles, decision rights, oversight committees). Return a string. {"governance": "..."}`,
            novel: `${basePrompt} **TASK:** Propose a 'novel_strategy' section describing innovative or disruptive approaches the company should consider outside its BAU operations. Return a string. {"novel_strategy": "..."}`,
            // -------------------
            conc: `${basePrompt} **TASK:** Write a 'conclusion' string summarizing the outlook. {"conclusion": "..."}`,
            sum: `${basePrompt} **TASK:** Write a 'summary' string encapsulating the entire plan. {"summary": "..."}`
        };

        // --- Execute Parallel Calls ---
        try {
            const [p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12] = await Promise.all([
                generateSection(prompts.intro, "Introduction"),
                generateSection(prompts.overview, "Overview"),
                generateSection(prompts.mv, "Mission/Vision"),
                generateSection(prompts.goals, "Goals"),
                generateSection(prompts.init, "Initiatives"),
                generateSection(prompts.obj, "Objectives"),
                generateSection(prompts.action, "Action Plan"),
                generateSection(prompts.risk, "Risks"),
                generateSection(prompts.gov, "Governance"),      // New
                generateSection(prompts.novel, "Novel Strategy"), // New
                generateSection(prompts.conc, "Conclusion"),
                generateSection(prompts.sum, "Summary")
            ]);

            // Assemble Final Object
            return {
                introduction: p1.introduction,
                executive_overview: p2.executive_overview,
                mission_statement: p3.mission_statement,
                vision_statement: p3.vision_statement,
                strategic_goals: p4.strategic_goals,
                strategic_initiatives: p5.strategic_initiatives,
                objectives: p6.objectives,
                action_plan: p7.action_plan,
                risk_management: p8.risk_management,
                governance: p9.governance,         // New
                novel_strategy: p10.novel_strategy, // New
                conclusion: p11.conclusion,
                summary: p12.summary,
                external_data: n8nResult.external_data 
            };

        } catch (error) {
            console.error("Strategic Plan Cascade Error:", error);
            throw error;
        }
    }

 /**
     * OLLAMA CASCADE: Generates Mission, Vision, Values, and Goals with Contextual Breakdowns.
     * This function is called by handleWebSocketMessage ONLY after N8N returns its base analysis.
     */
    async function ollamaCascadeGoals(n8nResult, fullContext) {
        console.log("Ollama Cascade: Starting deep synthesis with contextual breakdowns.");
        
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";
        
        const statusEl = document.getElementById("analysisStatus");
        if (statusEl) statusEl.textContent = "Synthesizing Mission, Vision & Contextual Analysis...";

        // Construct the combined context for the cascade prompt
        const combinedContext = `
            **FULL COMPANY CONTEXT (User Input):**
            ${fullContext}

            **RAG ANALYSIS OUTPUT (External Context):**
            - Book Summary: ${n8nResult.external_data?.book_summary || 'N/A'}
            - Web Summary: ${n8nResult.external_data?.web_summary || 'N/A'}
        `;
        
        const MAX_CONTEXT_LENGTH = 15000;
        const ollamaText = combinedContext.substring(0, MAX_CONTEXT_LENGTH);

        const prompt = `
            You are a top-tier strategic planning consultant. Your task is to synthesize a complete strategic foundation. Base all outputs **EXCLUSIVELY** on the provided "FULL COMPANY CONTEXT" and "RAG ANALYSIS OUTPUT".

            **CONTEXT:**
            \`\`\`
            ${ollamaText}
            \`\`\`


            **DETAILED TASKS:**
            1.  **Synthesize Mission (\`mission\`):** * Create a concise \`statement\` defining the organization's core purpose.
                * Create a \`breakdown\` array. Break the mission into 3 components (e.g., "Target Audience", "Contribution", "Key Elements"). For the \`analysis\` of each, **you must explicitly reference facts from the context** (e.g., "The context mentions targeting SMEs in the fintech sector...").
            2.  **Synthesize Vision (\`vision\`):** * Create an aspirational \`statement\` describing the future state.
                * Create a \`breakdown\` array. Break the vision into 3 components (e.g., "Future State", "Impact", "Strategic Direction"). For the \`analysis\` of each, **cite specific ambitions found in the context**.
            3.  **Generate Core Values (\`core_values\`):** Identify 5-7 Core Values.
                * \`value\`: The value name.
                * \`description\`: Explain how this applies to the specific organization described.
            4.  **Generate Strategic Goals (\`goals\`):** Create 8-10 distinct, high-level strategic goals.
                * \`goal_name\`: Clear, inspiring goal.
                * \`description\`: Rationale based on context.
                * \`key_initiatives\`: 2-3 high-level initiatives.
                * \`kpis_to_track\`: 2-3 specific KPIs.

            **ABSOLUTE CONSTRAINTS:**
            **VALIDITY CHECK**
            Check the context. Is it intelligible text describing a business or organization?
            - If it is gibberish (e.g., "asdf", "lorem ipsum") or random keys: **STOP**. Return the INVALID format below.
            - **CONTEXT IS KING:** Do not generate generic analyses. Every breakdown analysis must mention specific details from the user's input (industry, specific products, stated challenges).
            - **JSON FORMAT:** Adhere EXACTLY.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object.
            {
              "mission": {
                "statement": "To empower...",
                "breakdown": [
                    { "component": "Target Audience", "analysis": "Specifically focuses on [User's Audience] as mentioned in the text..." },
                    { "component": "Core Contribution", "analysis": "Delivers [User's Product] to solve [User's Problem]..." },
                    { "component": "Distinction", "analysis": "Leverages [User's Unique Selling Point]..." }
                ]
              },
              "vision": {
                "statement": "To become the...",
                "breakdown": [
                    { "component": "Future State", "analysis": "Aims for [Specific Future Goal]..." },
                    { "component": "Impact", "analysis": "Seeks to change [Specific Industry Metric]..." },
                    { "component": "Scope", "analysis": "Expands operations to [Specific Region/Market]..." }
                ]
              },
              "core_values": [
                { "value": "Value 1", "description": "..." }
              ],
              "goals": [
                { "goal_name": "Goal 1", "description": "...", "key_initiatives": ["..."], "kpis_to_track": ["..."] }
              ]
            }
        `;

        try {
            console.log("Sending deep Mission/Vision/Values/Goals CASCADE prompt to Ollama...");
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
            });

            if (!response.ok) {
                let errorBody = `AI Cascade error ${response.status}`;
                try { errorBody += `: ${await response.text()}`; } catch (e) {}
                throw new Error(errorBody);
            }
            
            const data = await response.json();
            const ollamaJson = JSON.parse(data.response);
            
            // Basic Validation
            if (!ollamaJson.mission || !ollamaJson.mission.statement) {
                 console.warn("AI Cascade missing mission statement, using fallback.");
                 ollamaJson.mission = { statement: "Analysis failed.", breakdown: [] };
            }
            
            return ollamaJson; 
            
        } catch (error) {
            console.error(`Ollama Cascade Failure (Step 2):`, error);
            return { 
                mission: { statement: "Analysis failed.", breakdown: [] },
                vision: { statement: "Analysis failed.", breakdown: [] },
                core_values: [], 
                goals: [], 
                error_message: error.message 
            }; 
        }
    }


    // =========================================================================
    // ===== UPDATED HANDLERS (CASCADE CONTROLLER)                         =====
    // =========================================================================

    /**
     * HANDLER: Mission Vision Analysis
     * Controls the flow based on the selected engine (Ollama Only vs. RAG-Enhanced).
     */
    async function handleMissionVisionAnalysis() {
        const analysisResultContainer = document.getElementById("analysisResult");
        const statusEl = document.getElementById("analysisStatus"); // Note: Might not exist yet in DOM until innerHTML is set, handled below.
        
        // 1. Set Initial Loading State & UI
        setLoading("generate", true);
        
        // We set the initial HTML immediately so we have a place to show status updates
        analysisResultContainer.innerHTML = `
            <div class="text-center text-white/70 p-8">
                <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                <h3 class="text-xl font-semibold text-white mb-4">Initializing Analysis...</h3>
                <p id="analysisStatus" class="text-white/80 mb-2">Reading inputs...</p>
            </div>`;
            
        // 2. Reset Global State
        pendingOllamaResult = null; 
        pendingN8nResult = null; 
        currentAnalysisMessageId = `analysis_${Date.now()}`; // Unique ID for WebSocket matching
        let textContext = ""; 

        try {
            // 3. Gather & Validate Inputs
            const useDoc = document.getElementById("docUpload").checked;
            const companyName = document.getElementById("companyName").value.trim() || "The organization";
            const location = document.getElementById("location").value.trim() || "unspecified location";
            
            // Determine which Analysis Engine is selected
            const engineOption = document.querySelector('input[name="analysisEngine"]:checked')?.value || 'ollama';
            console.log(`Mission/Vision Analysis Mode: ${engineOption}`);

            // Prepare Data for N8N (FormData) and Ollama (String Context)
            const n8nFormData = new FormData(); 
            
            if (useDoc) {
                // --- OPTION A: File Upload ---
                const fileInput = document.getElementById("companyDocumentsFile");
                if (!fileInput.files || fileInput.files.length === 0) {
                    throw new Error("Please select a document to upload.");
                }
                const file = fileInput.files[0];
                
                // Extract text for local Ollama context
                textContext = await extractTextFromFile(file); 
                
                // Append file for N8N
                n8nFormData.append("file", file, file.name); 
            } else {
                // --- OPTION B: Text Input ---
                const rawText = document.getElementById("missionVisionContent").value.trim();
                if (!rawText) {
                    throw new Error("Please provide your company context in the text area.");
                }
                textContext = rawText;

                // Create a Virtual Blob for N8N so it treats it as a file
                const textBlob = new Blob([rawText], { type: 'text/plain' });
                n8nFormData.append("file", textBlob, "context_input.txt");
            }

            // Set the Global Context (Crucial for the WebSocket callback to use later)
            currentAnalysisContext = `Company Name: ${companyName}\nLocation: ${location}\n\nCompany Context:\n${textContext}`; 

            // Check Authentication
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) throw new Error("Please log in to generate analysis.");

            // 4. Branch Logic based on Engine Selection

            // =========================================================
            // BRANCH 1: OLLAMA ONLY (Direct)
            // =========================================================
            if (engineOption === 'ollama') {
                // Update UI
                const status = document.getElementById("analysisStatus");
                if (status) status.textContent = "Analyzing directly with Ollama AI...";
                
                // Create a "dummy" N8N result because we skipped the RAG step
                const dummyN8nResult = {
                    external_data: {
                        book_summary: "N/A (Ollama-Only Mode Selected)",
                        web_summary: "N/A (Ollama-Only Mode Selected)",
                        reference_links: [],
                        processing_time: "0s"
                    }
                };

                // Call the synthesis function directly
                // (This is the function that contains the gibberish check)
                const result = await ollamaCascadeGoals(dummyN8nResult, currentAnalysisContext);

                // Render Results Immediately
                renderMissionVisionPage(analysisResultContainer, {
                    mission: result.mission,
                    vision: result.vision,
                    values: result.core_values || [],
                    goals: result.goals || [], 
                    external_data: dummyN8nResult.external_data
                });
                
                setLoading("generate", false);
                return; // Done
            }

            // =========================================================
            // BRANCH 2: RAG-ENHANCED (N8N + Ollama)
            // =========================================================
            else {
                // Update UI
                const status = document.getElementById("analysisStatus");
                if (status) status.textContent = "Connecting to Knowledge Base (RAG)...";

                // Add metadata for N8N
                n8nFormData.append("customerName", companyName);
                n8nFormData.append("location", location);
                n8nFormData.append("messageId", currentAnalysisMessageId); 

                // Trigger N8N Webhook
                const N8N_MISSION_URL = "https://n8n.data2int.com/webhook/mission-vision-v11";
                console.log(`Sending data to n8n RAG workflow at ${N8N_MISSION_URL}...`);
                
                const response = await fetch(N8N_MISSION_URL, {
                    method: "POST",
                    headers: { 'Authorization': `Bearer ${session.access_token}` },
                    body: n8nFormData
                });

                if (!response.ok) {
                    throw new Error(`n8n Trigger Error: ${response.status} - ${await response.text()}`);
                }
                
                // UI Update after successful send
                if (status) status.textContent = "RAG processing started. Waiting for external insights...";

                // STOP HERE.
                // The flow pauses. The browser waits for the WebSocket message.
                // When handleWebSocketMessage() receives the N8N result, 
                // IT will trigger ollamaCascadeGoals automatically using 'currentAnalysisContext'.
            }

        } catch (error) {
            console.error(`Error in handleMissionVisionAnalysis:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
            currentAnalysisContext = null; 
        }
    }
    

    /**
     * RENDERER: Mission Vision (DEEP ANALYSIS v4 - Layout Fix & Safe Rendering)
     * --- FIX: Added new tab and sections to render external data and references ---
     */
    function renderMissionVisionPage(container, data) {
        // Fix spacing
        container.style.whiteSpace = 'normal';
        container.innerHTML = ""; 

        const { mission, vision, values, goals, external_data } = data;

        // --- Validation with Fallbacks ---
        const safeMission = mission || { statement: "No mission generated", breakdown: [] };
        const safeVision = vision || { statement: "No vision generated", breakdown: [] };
        const safeValues = Array.isArray(values) ? values : [];
        const safeGoals = Array.isArray(goals) ? goals : [];

        // --- NEW: Process External Data ---
        const bookSummary = external_data?.book_summary || "Book summary not available.";
        const webSummary = external_data?.web_summary || "Web summary not available.";
        const referenceLinks = external_data?.reference_links || [];
        const processingTime = external_data?.processing_time || "N/A";


        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="summary"> Summary</button>
            <button class="analysis-tab-btn" data-tab="statements"> Mission & Vision</button>
            <button class="analysis-tab-btn" data-tab="goals"> Strategic Goals</button>
            <button class="analysis-tab-btn" data-tab="references"> References & Sources</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Framework</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="summaryPanel" class="analysis-tab-panel active p-4 md:p-6"></div>
            <div id="statementsPanel" class="analysis-tab-panel p-4 md:p-6"></div>
            <div id="valuesPanel" class="analysis-tab-panel p-4 md:p-6"></div>
            <div id="goalsPanel" class="analysis-tab-panel p-4 md:p-6"></div>
            <div id="referencesPanel" class="analysis-tab-panel p-4 md:p-6"></div> <div id="learnPanel" class="analysis-tab-panel p-4 md:p-6"></div>
        `;

        // --- 1. Populate Summary Panel (Replaced Values/Goals with Sources) ---
        const summaryPanel = $("summaryPanel");
        summaryPanel.innerHTML = `
        <div class="space-y-8">
            <h3 class="text-3xl font-bold text-center mb-6">Strategic Foundation Summary</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                <div class="p-6 rounded-lg bg-black/20 border-l-4 border-indigo-400 glass-container">
                    <h4 class="text-xl font-bold mb-3 text-indigo-300"> Mission</h4>
                    <p class="text-lg italic text-white/90">"${safeMission.statement}"</p>
                </div>
                <div class="p-6 rounded-lg bg-black/20 border-l-4 border-green-400 glass-container">
                    <h4 class="text-xl font-bold mb-3 text-green-300"> Vision</h4>
                    <p class="text-lg italic text-white/90">"${safeVision.statement}"</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                <div class="bg-black/20 p-4 rounded-lg glass-container">
                    <h4 class="text-lg font-bold mb-3 text-yellow-300"> Primary Source Summary (Book)</h4>
                    <p class="text-sm text-white/80 italic line-clamp-3">${bookSummary}</p>
                    <p class="text-xs text-white/60 mt-3">Processing Time: ${processingTime}</p>
                </div>
                <div class="bg-black/20 p-4 rounded-lg glass-container">
                    <h4 class="text-lg font-bold mb-3 text-red-300"> Supporting Source Summary (Web)</h4>
                     <p class="text-sm text-white/80 italic line-clamp-3">${webSummary}</p>
                     <p class="text-xs text-white/60 mt-3">${referenceLinks.length} External Reference(s)</p>
                </div>
            </div>
        </div>
        `;

        // --- 2. Populate Mission & Vision Statements Panel ---
        // (No change in logic needed, still uses safeMission/safeVision)
        const statementsPanel = $("statementsPanel");
        const missionRows = safeMission.breakdown?.map(b => `
            <tr><td class="font-semibold text-white/90">${b.component}</td><td class="text-white/80">${b.analysis}</td></tr>
        `).join('') || '<tr><td colspan="2" class="text-center italic opacity-50">No detailed breakdown available</td></tr>';

        const visionRows = safeVision.breakdown?.map(b => `
            <tr><td class="font-semibold text-white/90">${b.component}</td><td class="text-white/80">${b.analysis}</td></tr>
        `).join('') || '<tr><td colspan="2" class="text-center italic opacity-50">No detailed breakdown available</td></tr>';

        statementsPanel.innerHTML = `
        <div class="space-y-8">
            <h3 class="text-3xl font-bold text-center mb-6">Mission & Vision Breakdown</h3>
            
            <div class="glass-container p-6">
                <h4 class="text-2xl font-bold mb-3 text-indigo-300"> Mission Statement</h4>
                <blockquote class="p-4 italic text-lg border-l-4 border-indigo-400 bg-black/20 text-white/90 mb-6">
                    "${safeMission.statement}"
                </blockquote>
                <h5 class="text-lg font-semibold mb-3">Component Breakdown:</h5>
                <div class="overflow-x-auto">
                    <table class="coeff-table styled-table text-sm">
                        <thead><tr><th class="w-1/3">Component</th><th>Analysis (Based on Text)</th></tr></thead>
                        <tbody>${missionRows}</tbody>
                    </table>
                </div>
            </div>

            <div class="glass-container p-6">
                <h4 class="text-2xl font-bold mb-3 text-green-300"> Vision Statement</h4>
                <blockquote class="p-4 italic text-lg border-l-4 border-green-400 bg-black/20 text-white/90 mb-6">
                    "${safeVision.statement}"
                </blockquote>
                <h5 class="text-lg font-semibold mb-3">Component Breakdown:</h5>
                <div class="overflow-x-auto">
                    <table class="coeff-table styled-table text-sm">
                        <thead><tr><th class="w-1/3">Component</th><th>Analysis (Based on Text)</th></tr></thead>
                        <tbody>${visionRows}</tbody>
                    </table>
                </div>
            </div>
        </div>
        `;

        // --- 3. Populate Core Values Panel (Moved to Goals Panel for space) ---
        // I will merge the Core Values panel content into the Goals Panel for simplicity since you only provided Goals/References
        
        // --- 4. Populate Strategic Goals Panel ---
        const goalsPanel = $("goalsPanel");
        let goalsHtml = `<div class="space-y-6">`;
        
        // 4a. Add Core Values Section
        goalsHtml += `<h3 class="text-3xl font-bold text-center mb-8"> Core Values</h3><div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">`;
        if (safeValues.length > 0) {
            safeValues.forEach((v_obj) => {
                goalsHtml += `
                <div class="insight-card border-l-4 border-yellow-400">
                    <h4 class="text-xl font-bold mb-2">${v_obj.value}</h4>
                    <p class="text-sm text-white/80 italic">${v_obj.description || ''}</p>
                </div>`;
            });
        } else {
            goalsHtml += `<p class="text-white/70 italic text-center md:col-span-2">No core values were generated from the context.</p>`;
        }
        goalsHtml += `</div><hr class="border-white/20 my-6">`;
        
        // 4b. Add Strategic Goals Section
        goalsHtml += `<h3 class="text-3xl font-bold text-center mb-8"> Strategic Goals (${safeGoals.length})</h3><div class="max-w-4xl mx-auto space-y-6">`;
        if (safeGoals.length > 0) {
            safeGoals.forEach((g_obj, index) => {
                goalsHtml += `
                <div class="prescription-card border-l-4 border-red-400">
                    <h4 class="text-xl font-bold mb-2">${index + 1}. ${g_obj.goal_name}</h4>
                    <p class="rationale"><strong>Rationale:</strong> ${g_obj.description || ''}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-indigo-300 mb-2">Key Initiatives</h5>
                            ${g_obj.key_initiatives?.length > 0 ? 
                                `<ul class="list-disc list-inside space-y-1 text-white/90">${g_obj.key_initiatives.map(k => `<li>${k}</li>`).join('')}</ul>` : 
                                `<p class="text-white/70 italic text-xs">No specific initiatives.</p>`}
                        </div>
                        <div class="bg-black/20 p-3 rounded">
                            <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                            ${g_obj.kpis_to_track?.length > 0 ? 
                                `<ul class="list-disc list-inside space-y-1 text-white/90">${g_obj.kpis_to_track.map(k => `<li>${k}</li>`).join('')}</ul>` : 
                                `<p class="text-white/70 italic text-xs">No specific KPIs.</p>`}
                        </div>
                    </div>
                </div>`;
            });
        } else {
            goalsHtml += `<p class="text-white/70 italic text-center">No specific goals were generated from the context.</p>`;
        }
        goalsHtml += `</div></div>`;
        goalsPanel.innerHTML = goalsHtml;

        // --- 5. Populate References & Sources Panel (NEW) ---
        const referencesPanel = $("referencesPanel");
        let referencesHtml = `<div class="space-y-6"><h3 class="text-3xl font-bold text-center mb-6"> References & Source Material</h3>`;
        
        // 5a. Primary Source (Book)
        referencesHtml += `<div class="glass-container p-6 border-l-4 border-blue-400">
            <h4 class="text-xl font-bold mb-3 text-blue-300"> Primary Source (Book Summary)</h4>
            <p class="text-white/80 whitespace-pre-wrap">${bookSummary}</p>
        </div>`;

        // 5b. Web Sources Summary
        referencesHtml += `<div class="glass-container p-6 border-l-4 border-purple-400">
            <h4 class="text-xl font-bold mb-3 text-purple-300"> Supporting Source (Web Summary)</h4>
            <p class="text-white/80 whitespace-pre-wrap">${webSummary}</p>
        </div>`;

        // 5c. Links Table
        referencesHtml += `<div class="glass-container p-6">
            <h4 class="text-xl font-bold mb-3">External Reference Links (${referenceLinks.length})</h4>
            <div class="overflow-x-auto">
                <table class="coeff-table styled-table text-sm">
                    <thead><tr><th class="w-10">#</th><th>URL</th></tr></thead>
                    <tbody>`;
        if (referenceLinks.length > 0) {
            referenceLinks.forEach((link, index) => {
                referencesHtml += `<tr>
                    <td>${index + 1}</td>
                    <td><a href="${link}" target="_blank" class="text-blue-300 hover:text-blue-100">${link}</a></td>
                </tr>`;
            });
        } else {
            referencesHtml += `<tr><td colspan="2" class="text-center italic opacity-50">No external links provided.</td></tr>`;
        }
        referencesHtml += `</tbody></table></div></div>`;
        
        referencesHtml += `</div>`; // Close space-y-6
        referencesPanel.innerHTML = referencesHtml;


        // --- 6. Populate Learn Panel ---
        const learnPanel = $("learnPanel");
        // (Static content for learning framework remains here)
        learnPanel.innerHTML = `
        <div class="space-y-6 text-white/90 glass-container max-w-4xl mx-auto p-6 md:p-10">
            <h3 class="text-3xl font-bold text-center mb-4"> Understanding Mission, Vision, Values & Goals</h3>
            
            



[Image of strategic planning pyramid mission vision values goals]



            <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                <h4 class="text-xl font-bold mb-2 text-indigo-300"> What is a Mission Statement?</h4>
                <p class="text-sm text-white/80">A Mission statement defines the company's fundamental purpose. It's about the **PRESENT**.</p>
            </div>

            <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                <h4 class="text-xl font-bold mb-2 text-green-300"> What is a Vision Statement?</h4>
                <p class="text-sm text-white/80">A Vision statement describes the organization's desired future state. It's about the **FUTURE**.</p>
            </div>

            <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                <h4 class="text-xl font-bold mb-2 text-yellow-300"> What are Core Values?</h4>
                <p class="text-sm text-white/80">Values are the guiding principles that define the company's culture and behavior. They are the **RULES** of conduct.</p>
            </div>
            
            <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                <h4 class="text-xl font-bold mb-2 text-red-300"> What are Strategic Goals?</h4>
                <p class="text-sm text-white/80">Goals are the critical, high-level objectives that translate the aspirational Vision into specific, measurable targets.</p>
            </div>
        </div>
        `;

        // --- Final Touches (Animation, Cache, and Listeners) ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        analysisCache[currentTemplateId] = container.innerHTML;
        $("analysisActions").classList.remove("hidden");

        // Add tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanel = $(e.target.dataset.tab + "Panel");
                if (targetPanel) targetPanel.classList.add("active");
            }
        });
    }
    
    async function handleSwotTowsAnalysis() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `
            <div class="text-center text-white/70 p-8">
                <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                <h3 class="text-xl font-semibold text-white mb-4">Performing Comprehensive SWOT/TOWS Analysis...</h3>
                <p class="text-white/80 mb-2">Analyzing factors, generating strategies, and identifying priorities based *only* on your text...</p> <!-- Updated text -->
                <p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p>
            </div>`;
        setLoading("generate", true); // Ensure loading state is set

        const statusEl = $("analysisStatus");
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Consistent model

        try {
        // --- Step 0: Gather Input ---
            statusEl.textContent = "Reading your business content...";
            const useDoc = $("docUpload").checked;
            let businessContent = "";

            if (useDoc) {
                const file = $("swotFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                businessContent = await extractTextFromFile(file);
            } else {
                businessContent = $("businessContent").value.trim();
                if (!businessContent.trim()) throw new Error("Please enter business information in the text area.");
            }

            // --- INJECT LOCATION ---
            const location = $("swotLocation").value.trim();
            if (location) {
                businessContent = `Target Location/Region: ${location}\n\n${businessContent}`;
            }
            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (businessContent.length > MAX_CONTEXT_LENGTH) {
                businessContent = businessContent.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
                console.warn(`SWOT/TOWS analysis context truncated.`);
            }

            // --- Helper: Call Ollama ---
            async function generateOllamaResponse(prompt) {
                console.log(`Sending prompt to ${MODEL_NAME}...`);
                const response = await fetch(OLLAMA_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        prompt: prompt,
                        stream: false,
                        format: "json", // Expect JSON format directly
                        options: { num_ctx: 32768 }
                    })
                });
                if (!response.ok) {
                    let errorBody = `Ollama API error ${response.status}`;
                    try { errorBody += `: ${await response.text()}`; } catch(e){}
                    throw new Error(errorBody);
                }
                const data = await response.json();
                console.log('Raw AI Response:', data.response);
                try {
                    const parsed = JSON.parse(data.response);
                    console.log('Successfully parsed AI JSON response.');
                    return parsed;
                } catch (e) {
                    console.error("Failed to parse AI JSON response:", data.response, e);
                    throw new Error("Invalid JSON received from AI. Check AI logs or prompt structure.");
                }
            }

            // --- Step 1: Extract Internal Factors (S/W) with Descriptions ---
            statusEl.textContent = "Step 1/4: Analyzing internal factors (Strengths & Weaknesses)...";
            const internalPrompt = `
                Analyze the following business content based **ONLY** on the text provided. Identify 4-6 specific internal Strengths and 4-6 specific internal Weaknesses.  ${truncatedNote}

                **USER'S BUSINESS CONTENT:**
                \`\`\`
                ${businessContent}
                \`\`\`
                **VALIDATION:** If gibberish, return: { "strengths": [], "weaknesses": [] }

                **TASK:** For each Strength and Weakness identified **solely from the text**:
                1.  Provide a concise \`factor\` name (2-5 words).
                2.  Provide a brief \`description\` (1 sentence) summarizing the factor **using wording found in or directly inferred from the text**.

                **ABSOLUTE CONSTRAINTS:**
                - Base **ALL** output **EXCLUSIVELY** on the provided "USER'S BUSINESS CONTENT". **DO NOT** invent factors or descriptions.
                - Strengths = internal positive factors the company controls (mentioned in text).
                - Weaknesses = internal negative factors the company needs to address (mentioned in text).

                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                "strengths": [
                    {"factor": "[Strength Name ONLY from text]", "description": "[Description ONLY from text wording]"},
                    // ... 4-6 total ...
                ],
                "weaknesses": [
                    {"factor": "[Weakness Name ONLY from text]", "description": "[Description ONLY from text wording]"},
                    // ... 4-6 total ...
                ]
                }`;
            const internal_factors = await generateOllamaResponse(internalPrompt);
            // *** Validation ***
            if (!internal_factors || !Array.isArray(internal_factors.strengths) || !Array.isArray(internal_factors.weaknesses) || (internal_factors.strengths.length > 0 && typeof internal_factors.strengths[0] !== 'object') ) {
                console.error("Invalid internal factors structure:", internal_factors);
                throw new Error("AI failed to return valid internal factors. Check response structure.");
            }
            console.log(`Extracted ${internal_factors.strengths.length} Strengths, ${internal_factors.weaknesses.length} Weaknesses.`);


            // --- Step 2: Extract External Factors (O/T) with Descriptions ---
            statusEl.textContent = "Step 2/4: Analyzing external factors (Opportunities & Threats)...";
            const externalPrompt = `
                Analyze the following business content based **ONLY** on the text provided. Identify 4-6 specific external Opportunities and 4-6 specific external Threats. ${truncatedNote}

                **USER'S BUSINESS CONTENT:**
                \`\`\`
                ${businessContent}
                \`\`\`
                **VALIDATION:** If gibberish, return: { "strengths": [], "weaknesses": [] }

                **TASK:** For each Opportunity and Threat identified **solely from the text**:
                1.  Provide a concise \`factor\` name (2-5 words).
                2.  Provide a brief \`description\` (1 sentence) summarizing the factor **using wording found in or directly inferred from the text**.

                **ABSOLUTE CONSTRAINTS:**
                - Base **ALL** output **EXCLUSIVELY** on the provided "USER'S BUSINESS CONTENT". **DO NOT** invent factors or descriptions.
                - Opportunities = external positive factors the company can leverage (mentioned in text).
                - Threats = external negative factors that pose risks (mentioned in text).

                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                "opportunities": [
                    {"factor": "[Opportunity Name ONLY from text]", "description": "[Description ONLY from text wording]"},
                    // ... 4-6 total ...
                ],
                "threats": [
                    {"factor": "[Threat Name ONLY from text]", "description": "[Description ONLY from text wording]"},
                    // ... 4-6 total ...
                ]
                }`;
            const external_factors = await generateOllamaResponse(externalPrompt);
            // *** Validation ***
            if (!external_factors || !Array.isArray(external_factors.opportunities) || !Array.isArray(external_factors.threats) || (external_factors.opportunities.length > 0 && typeof external_factors.opportunities[0] !== 'object')) {
                console.error("Invalid external factors structure:", external_factors);
                throw new Error("AI failed to return valid external factors. Check response structure.");
            }
            console.log(`Extracted ${external_factors.opportunities.length} Opportunities, ${external_factors.threats.length} Threats.`);

            // Combine into swot_data
            const swot_data = {
                strengths: internal_factors.strengths || [],
                weaknesses: internal_factors.weaknesses || [],
                opportunities: external_factors.opportunities || [],
                threats: external_factors.threats || []
            };

            // --- Step 3: Generate TOWS Strategies with Rationale ---
            statusEl.textContent = "Step 3/4: Generating TOWS strategies...";
            // Attempt to infer primary goal from text (fallback if necessary)
            const goalInferencePrompt = `Based ONLY on the following text, what is the single primary strategic goal or objective? Respond with just the goal statement (max 25 words). TEXT: "${businessContent.substring(0, 1000)}..."`; // Limit context for goal inference
            let primaryGoal = "Achieve sustainable growth and enhance market position."; // Default fallback
            try {
                const goalResponse = await fetch(OLLAMA_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ model: MODEL_NAME, prompt: goalInferencePrompt, stream: false }) });
                if (goalResponse.ok) {
                    const goalData = await goalResponse.json();
                    if (goalData.response) {
                        primaryGoal = goalData.response.trim().replace(/^Goal: /i, ''); // Clean up response
                        console.log("Inferred Primary Goal:", primaryGoal);
                    }
                }
            } catch (goalError) { console.warn("Could not infer primary goal, using default.", goalError); }


            const towsPrompt = `
                You are a strategic business consultant creating a TOWS matrix. Generate actionable strategies based **ONLY** on the provided SWOT factors and the inferred primary strategic goal.

                **Inferred Primary Strategic Goal:** ${primaryGoal}

                **SWOT ANALYSIS (Derived ONLY from User Text):**
                Strengths: ${swot_data.strengths.map(s => `- ${s.factor}: ${s.description}`).join("\n")}
                Weaknesses: ${swot_data.weaknesses.map(w => `- ${w.factor}: ${w.description}`).join("\n")}
                Opportunities: ${swot_data.opportunities.map(o => `- ${o.factor}: ${o.description}`).join("\n")}
                Threats: ${swot_data.threats.map(t => `- ${t.factor}: ${t.description}`).join("\n")}

                **TASK:** Generate 2-3 specific, actionable strategies for each TOWS quadrant (SO, WO, ST, WT). For each strategy:
                1.  Provide a concise \`strategy\` name (action-oriented, 5-10 words).
                2.  Provide a brief \`rationale\` (1-2 sentences) explaining *how* it uses the specific SWOT factors involved (e.g., "Leverages [Specific Strength] to capitalize on [Specific Opportunity]") and *how it supports the primary strategic goal*.

                **ABSOLUTE CONSTRAINTS:**
                - Base strategies **EXCLUSIVELY** on the provided SWOT factors. **DO NOT** introduce external ideas.
                - Ensure each strategy's rationale **explicitly mentions** the specific S/W/O/T factors it combines.
                - Ensure each strategy clearly supports the stated **Primary Strategic Goal**.
                - Ensure the JSON structure is exactly as specified.

                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                "SO_strategies": [
                    {"strategy": "[Actionable SO Strategy Name]", "rationale": "Leverages [Strength X] to capitalize on [Opportunity Y] by... This supports the goal of [Primary Goal] by..."},
                    // ... 1-2 more ...
                ],
                "WO_strategies": [
                    {"strategy": "[Actionable WO Strategy Name]", "rationale": "Overcomes [Weakness A] by leveraging [Opportunity B] through... This supports the goal of [Primary Goal] by..."},
                    // ... 1-2 more ...
                ],
                "ST_strategies": [
                    {"strategy": "[Actionable ST Strategy Name]", "rationale": "Uses [Strength C] to mitigate [Threat D] via... This supports the goal of [Primary Goal] by..."},
                    // ... 1-2 more ...
                ],
                "WT_strategies": [
                    {"strategy": "[Actionable WT Strategy Name]", "rationale": "Minimizes [Weakness E] and avoids [Threat F] by... This supports the goal of [Primary Goal] by..."},
                    // ... 1-2 more ...
                ]
                }`;
            const tows_strategies = await generateOllamaResponse(towsPrompt);
            // *** Validation ***
            if (!tows_strategies || typeof tows_strategies !== 'object' || !Array.isArray(tows_strategies.SO_strategies) /* Add checks for other quadrants too */ ) {
                console.error("Invalid TOWS strategies structure:", tows_strategies);
                throw new Error("AI failed to return valid TOWS strategies. Check response structure.");
            }
            console.log("Generated TOWS strategies.");


            // --- Step 4: Apply 80/20 rule for key insights ---
            statusEl.textContent = "Step 4/4: Applying 80/20 rule for key insights...";
            // Combine all generated strategies for the insights prompt
            const allStrategies = [].concat(...Object.values(tows_strategies || {}).map(arr => arr || []));

            const insightsPrompt = `
                You are a senior strategy consultant applying the Pareto Principle (80/20 rule) based **ONLY** on the provided SWOT/TOWS analysis derived from user text.

                **Primary Strategic Goal:** ${primaryGoal}

                **SWOT Factors (Derived ONLY from User Text):**
                Strengths: ${swot_data.strengths.map(s => s.factor).join(", ")}
                Weaknesses: ${swot_data.weaknesses.map(w => w.factor).join(", ")}
                Opportunities: ${swot_data.opportunities.map(o => o.factor).join(", ")}
                Threats: ${swot_data.threats.map(t => t.factor).join(", ")}

                **Generated TOWS Strategies (Derived ONLY from User Text & Factors):**
                ${allStrategies.map(s => `- ${s.strategy}: ${s.rationale}`).join("\n")}

                **TASK:** Apply the 80/20 rule to identify the critical few factors and strategies **from the lists above** that will likely drive ~80% of the impact towards achieving the **Primary Strategic Goal**.
                1.  \`strategic_focus\`: Define a single, overarching strategic direction (1 sentence) **based on the analysis** that best achieves the primary goal.
                2.  \`key_strategies\`: Select the 2-3 **most impactful strategies from the 'Generated TOWS Strategies' list** that most directly support the strategic_focus and primary goal. Provide the strategy name and a brief justification why it's key.
                3.  \`critical_factors\`: Identify the 2-3 **most critical SWOT factors from the 'SWOT Factors' list** that underpin the key_strategies or represent major hurdles/enablers for the primary goal. Provide factor name and brief justification.
                4.  \`priority_actions\`: List 2-3 immediate, concrete first steps **logically derived from the key_strategies** to begin execution.

                **ABSOLUTE CONSTRAINTS:**
                - Base **ALL** insights **EXCLUSIVELY** on the provided Goal, SWOT Factors, and TOWS Strategies. **DO NOT** introduce external ideas or factors.
                - Selections (strategies, factors, actions) MUST come directly from or be logically derived ONLY from the provided lists/context.

                **RETURN FORMAT:** Provide ONLY a valid JSON object:
                {
                "strategic_focus": "[Single sentence focus derived ONLY from analysis/goal]",
                "key_strategies": [ // 2-3 strategies PICKED ONLY FROM THE PROVIDED LIST
                    {"strategy": "[Name of Strategy 1 from list]", "justification": "Why this specific strategy is key based on analysis..."},
                    {"strategy": "[Name of Strategy 2 from list]", "justification": "Why this specific strategy is key based on analysis..."}
                ],
                "critical_factors": [ // 2-3 factors PICKED ONLY FROM THE PROVIDED LIST
                    {"factor": "[Name of Factor 1 from list]", "justification": "Why this specific factor is critical based on analysis..."},
                    {"factor": "[Name of Factor 2 from list]", "justification": "Why this specific factor is critical based on analysis..."}
                ],
                "priority_actions": [ // 2-3 actions DERIVED ONLY from key_strategies
                    "[Immediate action derived ONLY from Key Strategy 1]",
                    "[Immediate action derived ONLY from Key Strategy 2]"
                ]
                }`;
            const key_insights_80_20 = await generateOllamaResponse(insightsPrompt);
            // *** Validation ***
            if (!key_insights_80_20 || typeof key_insights_80_20 !== 'object' || !key_insights_80_20.strategic_focus || !Array.isArray(key_insights_80_20.key_strategies) || !Array.isArray(key_insights_80_20.critical_factors) || !Array.isArray(key_insights_80_20.priority_actions)) {
                console.error("Invalid 80/20 insights structure:", key_insights_80_20);
                throw new Error("AI failed to return valid 80/20 insights. Check response structure.");
            }
            console.log("Generated 80/20 insights.");

            // --- Final step: Render the full page ---
            statusEl.textContent = "Analysis complete! Rendering results...";
            const finalData = {
                swot_analysis: swot_data,
                tows_strategies: tows_strategies,
                key_insights_80_20: key_insights_80_20
            };
            renderFullSwotTowsPage(analysisResultContainer, finalData); // Use the updated renderer

        } catch (error) {
            console.error("Error during SWOT/TOWS analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false); // Ensure loading stops on error
        } finally {
            // Ensure loading stops reliably if missed
            if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
            }
        }
    }

// Modified renderFullSwotTowsPage to add Learn Tab and use detailed data
function renderFullSwotTowsPage(container, data) {
    container.innerHTML = ""; // Clear loading state

    // Basic Validation
    if (!data || !data.swot_analysis || !data.tows_strategies || !data.key_insights_80_20) {
        console.error("Incomplete data passed to renderFullSwotTowsPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render SWOT/TOWS results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    const { swot_analysis, tows_strategies, key_insights_80_20 } = data;


    // --- Create Tab Navigation (Added Learn Tab) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="insights"> Key Insights (80/20)</button> <!-- Insights First -->
        <button class="analysis-tab-btn" data-tab="swot"> SWOT Matrix</button>
        <button class="analysis-tab-btn" data-tab="tows"> TOWS Strategies</button>
        <button class="analysis-tab-btn" data-tab="details"> Detailed Analysis</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn SWOT/TOWS</button> <!-- New -->
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Added Learn Panel) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="insightsPanel" class="analysis-tab-panel active"></div> <!-- Insights Active -->
        <div id="swotPanel" class="analysis-tab-panel"></div>
        <div id="towsPanel" class="analysis-tab-panel"></div>
        <div id="detailsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> <!-- New -->
    `;

    // --- Populate Tabs (Order Changed) ---
    render8020Visualization(key_insights_80_20, "insightsPanel"); // Render Insights First
    renderSwotVisualization(swot_analysis, "swotPanel"); // Uses factor + description
    renderTowsVisualization(tows_strategies, "towsPanel"); // Uses strategy + rationale
    renderDetailedAnalysis(swot_analysis, tows_strategies, "detailsPanel"); // Keep charts

    // --- Populate Learn SWOT/TOWS Panel (New) ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding SWOT & TOWS Analysis</h3>
        [Image of SWOT matrix diagram]
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is SWOT Analysis?</h4>
            <p class="text-sm text-white/80">SWOT is a strategic planning technique used to identify an organization's Strengths, Weaknesses, Opportunities, and Threats related to business competition or project planning. It helps assess the internal and external factors impacting a goal.</p>
            <ul class="list-disc list-inside space-y-1 text-sm mt-2">
                <li><strong>Strengths (Internal, Positive):</strong> Characteristics of the business that give it an advantage over others (e.g., strong brand, skilled workforce).</li>
                <li><strong>Weaknesses (Internal, Negative):</strong> Characteristics that place the business at a disadvantage relative to others (e.g., outdated technology, high debt).</li>
                 <li><strong>Opportunities (External, Positive):</strong> Elements in the environment that the business could exploit to its advantage (e.g., growing market, competitor weakness).</li>
                 <li><strong>Threats (External, Negative):</strong> Elements in the environment that could cause trouble for the business (e.g., new regulations, emerging competitor).</li>
            </ul>
        </div>

         <div class="bg-black/20 p-4 rounded-lg mt-4">
             
            <h4 class="text-lg font-bold mb-2 text-yellow-300">From SWOT to TOWS: Generating Strategy</h4>
            <p class="text-sm text-white/80 mb-2">While SWOT identifies factors, TOWS uses these factors to generate actionable strategies by matching internal capabilities with external possibilities/challenges:</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>SO (Maxi-Maxi): Strengths + Opportunities:</strong> How can strengths be used to maximize opportunities? (Aggressive strategies)</li>
                <li><strong>WO (Mini-Maxi): Weaknesses + Opportunities:</strong> How can opportunities be used to overcome weaknesses? (Turnaround strategies)</li>
                 <li><strong>ST (Maxi-Mini): Strengths + Threats:</strong> How can strengths be used to minimize threats? (Defensive strategies)</li>
                 <li><strong>WT (Mini-Mini): Weaknesses + Threats:</strong> How can weaknesses be minimized and threats avoided? (Survival/Divestment strategies)</li>
            </ul>
             <p class="text-xs text-white/70 mt-2 italic">TOWS helps bridge the gap between analysis (SWOT) and action (Strategy).</p>
        </div>

         <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
            <h4 class="text-lg font-bold mb-2">Why Use SWOT/TOWS?</h4>
             <ul class="list-disc list-inside space-y-1 text-sm">
                <li>Provides a structured framework for situation analysis.</li>
                <li>Helps identify competitive advantages and disadvantages.</li>
                <li>Uncovers potential growth areas and risks.</li>
                <li>Facilitates strategic thinking and discussion.</li>
                <li>Forms a basis for developing actionable strategic plans (TOWS).</li>
            </ul>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to extract SWOT factors from your text and then generate corresponding TOWS strategies, followed by an 80/20 prioritization.</p>
    </div>
    `;

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic (ensure resizing happens)
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // Resize charts if they are in the activated panel
                 const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                 chartsInPanel.forEach(chartDiv => {
                      if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                          try {
                              Plotly.Plots.resize(chartDiv);
                          } catch (resizeError) {
                               console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                          }
                      }
                 });
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

     // Initial resize for charts in the default active tab (Insights - no chart) + hidden tabs
     setTimeout(() => {
          tabContent.querySelectorAll(".analysis-tab-panel").forEach(panel => {
               panel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                   if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                       try {
                            Plotly.Plots.resize(chartDiv);
                       } catch (initialResizeError) {
                            console.error(`Error during initial resize ${chartDiv.id} in panel ${panel.id}:`, initialResizeError);
                       }
                   }
               });
          });
     }, 150); // Delay slightly


    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}


// Modified renderSwotVisualization to show factor descriptions
function renderSwotVisualization(swotData, containerId) {
    const container = $(containerId);
    const quadrants = [
        { title: 'Strengths', data: swotData.strengths || [], color: '#2E8B57', icon: '' },
        { title: 'Weaknesses', data: swotData.weaknesses || [], color: '#CD5C5C', icon: '' },
        { title: 'Opportunities', data: swotData.opportunities || [], color: '#4169E1', icon: '' },
        { title: 'Threats', data: swotData.threats || [], color: '#FF8C00', icon: '' }
    ];
    let gridHtml = '<div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">'; // Added p-4, gap-6
    quadrants.forEach(q => {
        const itemsHtml = q.data.length > 0 ? q.data.map(item =>
            `<li class="mb-2">
                <strong class="text-white">${item.factor}</strong>
                <p class="text-xs text-white/70 italic ml-2">- ${item.description || 'No description provided.'}</p>
             </li>`
        ).join('') : '<li>No items identified from text.</li>';

        gridHtml += `
            <div class="bg-black/20 rounded-lg p-4 border-t-4 shadow-lg" style="border-top-color: ${q.color};">
                <h3 class="text-xl font-bold text-center mb-3 flex items-center justify-center gap-2" style="color: ${q.color};">${q.icon} ${q.title}</h3>
                <ul class="space-y-2 text-white/80 text-sm"> <!-- Removed list-disc, list-inside -->
                    ${itemsHtml}
                </ul>
            </div>`;
    });
    gridHtml += '</div>'; // Close grid
    container.innerHTML = gridHtml;
}


// Modified renderTowsVisualization to show rationale
function renderTowsVisualization(towsData, containerId) {
    const container = $(containerId);
     // Ensure towsData exists and has the expected arrays
     towsData = towsData || {};
     const quadrants = [
         { title: 'SO Strategies (Maxi-Maxi)', data: towsData.SO_strategies || [], color: '#32CD32', icon: '' },
         { title: 'WO Strategies (Mini-Maxi)', data: towsData.WO_strategies || [], color: '#FFD700', icon: '' },
         { title: 'ST Strategies (Maxi-Mini)', data: towsData.ST_strategies || [], color: '#87CEEB', icon: '' },
         { title: 'WT Strategies (Mini-Mini)', data: towsData.WT_strategies || [], color: '#DDA0DD', icon: '' }
     ];
    let gridHtml = '<div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">'; // Added p-4, gap-6
    quadrants.forEach(q => {
        const itemsHtml = q.data.length > 0 ? q.data.map(item =>
             `<li class="mb-3">
                <strong class="text-white">${item.strategy}</strong>
                <p class="text-xs text-white/70 italic mt-1 ml-2">- ${item.rationale || 'No rationale provided.'}</p>
             </li>`
        ).join('') : '<li>No strategies generated based on text.</li>';

        gridHtml += `
            <div class="bg-black/20 rounded-lg p-4 border-t-4 shadow-lg" style="border-top-color: ${q.color};">
                <h3 class="text-xl font-bold text-center mb-3 flex items-center justify-center gap-2" style="color: ${q.color};">${q.icon} ${q.title}</h3>
                <ul class="space-y-3 text-white/80 text-sm"> <!-- Removed list markers, increased spacing -->
                    ${itemsHtml}
                </ul>
            </div>`;
    });
    gridHtml += '</div>'; // Close grid
    container.innerHTML = gridHtml;
}


// Modified render8020Visualization to show justifications
function render8020Visualization(insightsData, containerId) {
    const container = $(containerId);
     // Ensure insightsData exists and has expected arrays/strings
     insightsData = insightsData || {};
     const keyStrategies = insightsData.key_strategies || [];
     const criticalFactors = insightsData.critical_factors || [];
     const priorityActions = insightsData.priority_actions || [];

    let contentHtml = `
        <div class="p-4 space-y-8">
            <div class="p-6 rounded-lg bg-black/20 border border-white/10 text-center">
                <h3 class="text-xl font-bold mb-2 text-indigo-300"> Strategic Focus</h3>
                <p class="text-lg italic text-white/90">${insightsData.strategic_focus || "Strategic focus not defined."}</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-black/20 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold mb-3 text-center text-green-400"> Key Strategies (Top 20%)</h4>`;
                    if (keyStrategies.length > 0) {
                         contentHtml += `<ul class="space-y-4">`;
                         keyStrategies.forEach(s => {
                             contentHtml += `<li class="p-2 bg-black/30 rounded">
                                                 <strong class="text-white">${s.strategy}</strong>
                                                 <p class="text-xs text-white/70 italic mt-1">- ${s.justification || 'No justification.'}</p>
                                             </li>`;
                         });
                         contentHtml += `</ul>`;
                    } else {
                         contentHtml += `<p class="text-white/60 italic text-center text-sm">No key strategies identified.</p>`;
                    }
                contentHtml += `</div>
                <div class="bg-black/20 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold mb-3 text-center text-yellow-400"> Critical Factors (Top 20%)</h4>`;
                     if (criticalFactors.length > 0) {
                         contentHtml += `<ul class="space-y-4">`;
                         criticalFactors.forEach(f => {
                              contentHtml += `<li class="p-2 bg-black/30 rounded">
                                                  <strong class="text-white">${f.factor}</strong>
                                                  <p class="text-xs text-white/70 italic mt-1">- ${f.justification || 'No justification.'}</p>
                                              </li>`;
                         });
                         contentHtml += `</ul>`;
                     } else {
                          contentHtml += `<p class="text-white/60 italic text-center text-sm">No critical factors identified.</p>`;
                     }
                contentHtml += `</div>
            </div>

            <div class="p-6 rounded-lg bg-black/20 border border-white/10">
                <h4 class="text-xl font-semibold mb-3 text-center text-blue-400"> Priority Actions (First Steps)</h4>`;
                if (priorityActions.length > 0) {
                    contentHtml += `<ol class="space-y-3 list-decimal list-inside text-white/90 text-center md:text-left md:max-w-xl md:mx-auto">`; // Centered list
                    priorityActions.forEach(a => {
                         contentHtml += `<li>${a}</li>`;
                    });
                    contentHtml += `</ol>`;
                } else {
                     contentHtml += `<p class="text-white/60 italic text-center text-sm">No priority actions identified.</p>`;
                }
            contentHtml += `</div>
        </div>`;
    container.innerHTML = contentHtml;
}

// Keep renderDetailedAnalysis as it focuses on counts/charts which don't need rationale display
function renderDetailedAnalysis(swotData, towsData, containerId) {
    const container = $(containerId);
     // Ensure data exists and has arrays
     swotData = swotData || {};
     towsData = towsData || {};
    const factorCounts = {
        Strengths: (swotData.strengths || []).length,
        Weaknesses: (swotData.weaknesses || []).length,
        Opportunities: (swotData.opportunities || []).length,
        Threats: (swotData.threats || []).length
    };
    const strategyCounts = {
        'SO': (towsData.SO_strategies || []).length, // Use short names for chart
        'WO': (towsData.WO_strategies || []).length,
        'ST': (towsData.ST_strategies || []).length,
        'WT': (towsData.WT_strategies || []).length
    };
    const factorColors = ["#2E8B57", "#CD5C5C", "#4169E1", "#FF8C00"]; // S, W, O, T

    let metricsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> Factor & Strategy Counts</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">`; // Added p-4
    Object.entries(factorCounts).forEach(([key, value], index) => {
        metricsHtml += `<div class="summary-stat-card"><div class="stat-value" style="color:${factorColors[index]}">${value}</div><div class="stat-label">${key}</div></div>`; // Use summary-stat-card
    });
    metricsHtml += `</div>`;

    let chartHtml = `<div id="strategyBarChart" class="w-full h-[400px] bg-black/10 rounded-lg p-2 plotly-chart"></div>`;

    let recommendationsHtml = `<h4 class="text-xl font-semibold mt-8 mb-3 text-center">Summary Insights</h4>
                               <div class="bg-black/20 p-4 rounded-lg max-w-2xl mx-auto">
                                   <ul class="list-disc list-inside space-y-2 text-white/80 text-sm">`;
    recommendationsHtml += factorCounts['Strengths'] >= factorCounts['Weaknesses'] ?
                           "<li>Internal factors suggest a relatively stronger position; focus on leveraging strengths.</li>" :
                           "<li>Internal factors indicate areas for improvement; prioritize addressing key weaknesses.</li>";
    recommendationsHtml += factorCounts['Opportunities'] >= factorCounts['Threats'] ?
                           "<li>External environment appears more favorable; actively pursue identified opportunities.</li>" :
                           "<li>External environment presents challenges; focus on mitigating significant threats.</li>";
     // Add insight based on TOWS strategy counts
     const strategyTotals = Object.values(strategyCounts).reduce((a, b) => a + b, 0);
     if (strategyTotals > 0) {
         const dominantStrategy = Object.entries(strategyCounts).sort((a,b) => b[1] - a[1])[0][0];
         recommendationsHtml += `<li>The analysis generated the most strategies in the <strong>${dominantStrategy}</strong> quadrant, suggesting a potential focus on ${
             dominantStrategy === 'SO' ? 'aggressive growth' :
             dominantStrategy === 'WO' ? 'turnaround/development' :
             dominantStrategy === 'ST' ? 'diversification/defense' :
             'defensive/consolidation'
         }.</li>`;
     }

    recommendationsHtml += `</ul></div></div>`; // Close p-4

    container.innerHTML = metricsHtml + chartHtml + recommendationsHtml;

    // Render Strategy Count Chart
    try {
        const plotData = [{
            x: Object.keys(strategyCounts),
            y: Object.values(strategyCounts),
            type: 'bar',
            marker: { color: ['#32CD32', '#FFD700', '#87CEEB', '#DDA0DD'] } // SO, WO, ST, WT colors
        }];
        const layout = {
            title: 'Number of Generated Strategies by Type',
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
            xaxis: { title: 'Strategy Type', automargin: true },
            yaxis: { title: 'Count', gridcolor: 'rgba(255,255,255,0.1)' },
            margin: { t: 50, b: 50, l: 50, r: 20 }
        };
        Plotly.newPlot('strategyBarChart', plotData, layout, { responsive: true });
    } catch(e) { console.error("Strategy chart err:", e); $("strategyBarChart").innerHTML = "<p class='text-red-400 text-center pt-10'>Chart render error.</p>"; }
}

    /**
     * HANDLER: Goals & Strategic Initiatives (Strategic Planning)
     * - NEW: Re-engineered to use a comprehensive OGSM prompt.
     * - Forces AI to deconstruct user text into Objective, Goals, Strategies, and Measures.
     * - Ensures high accuracy by grounding every component in the provided text.
     */
    async function handleGoalsAndInitiativesAnalysis_SP() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Building OGSM Framework...</h3><p class="text-white/80 mb-2">Cascading your objective into actionable strategies based *only* on your provided text...</p></div>`;
        setLoading("generate", true);

        // Define URL and Model
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Consistent model

        try {
            // 1. Gather Inputs
            const useDoc = $("docUpload").checked;
            let text = "";

            if (useDoc) {
                const file = $("goalsFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                text = await extractTextFromFile(file);
            } else {
                text = $("goalsContent").value.trim();
                if (!text.trim()) throw new Error("Please enter your high-level goal or business context in the text area.");
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("goalsLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
                console.log("Injected location into Goals Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (text.length > MAX_CONTEXT_LENGTH) {
                text = text.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
                console.warn(`Goals & Initiatives (SP) analysis context truncated.`);
            }

            // 2. Construct ENHANCED Prompt
            const prompt = `
                You are a strategic planning consultant specializing in the OGSM (Objective, Goals, Strategies, Measures) framework. Based **ONLY** on the user's provided context (which might describe a high-level goal or general business situation), create a complete OGSM plan derived strictly from that text. ${truncatedNote}

                **USER'S CONTEXT / HIGH-LEVEL GOAL:**
                \`\`\`
                ${text}
                \`\`\`

                **VALIDATION:**
                If the text is nonsense, gibberish, or too short to contain a goal, return the INVALID response.

                **DETAILED TASKS:**
                1.  **Define Objective:** Refine the user's input or infer from the context a single, clear, overarching, and ideally measurable \`main_objective\` (SMART if possible).
                2.  **Define Goals (3-4 goals):** Identify specific, high-level \`goals\` that support the main_objective, derived **only from the text**.
                3.  **Develop Strategies & Measures:** For EACH goal, develop 1-2 supporting \`strategies\` **based only on actions or directions mentioned/implied in the text**. For EACH strategy:
                    * Provide a concise \`strategy_name\` (action-oriented).
                    * Provide a brief \`rationale\` (1-2 sentences) explaining *how* this strategy supports the parent goal and main objective, **using evidence ONLY from the text**.
                    * List 1-2 specific, measurable \`measures\` (KPIs) **mentioned in, implied by, or logically derived ONLY from the text** to track the strategy's success.
                4.  **Self-Correction:** Rigorously check: Is the objective derived solely from input/context? Are goals/strategies/rationales/measures **strictly based ONLY on the user's text**? Is the structure logical and hierarchical? Is the JSON perfect? Fix all errors.

                **ABSOLUTE CONSTRAINTS:**
                - **CONTEXT IS KING:** Base **ALL** output **EXCLUSIVELY** on the provided "USER'S CONTEXT / HIGH-LEVEL GOAL". **DO NOT** invent information, goals, strategies, or KPIs not present or logically implied in the text.
                - **NO GENERIC EXAMPLES:** Replace **ALL** placeholder text in the RETURN FORMAT structure below with content generated **strictly from the user's input text**.
                - **JSON FORMAT:** Adhere EXACTLY.

                **RETURN FORMAT:**
                Provide ONLY a valid JSON object. Replace ALL bracketed placeholders strictly based on the user's input text.
                {
                  "main_objective": "[SMART Objective derived ONLY from user text/context]",
                  "goals": [ // 3-4 goals derived ONLY from text
                    {
                      "goal_name": "[Goal 1 Name derived ONLY from text]",
                      "strategies": [ // 1-2 strategies per goal derived ONLY from text
                        {
                          "strategy_name": "[Strategy 1.1 Name ONLY from text]",
                          "rationale": "[Rationale linking strategy to goal/objective using ONLY text evidence...]",
                          "measures": ["[Measure/KPI 1.1.1 derived ONLY from text]", "[Measure/KPI 1.1.2 derived ONLY from text]"]
                        },
                        {
                          "strategy_name": "[Strategy 1.2 Name ONLY from text]",
                          "rationale": "[Rationale linking strategy using ONLY text evidence...]",
                          "measures": ["[Measure/KPI 1.2.1 derived ONLY from text]"]
                        }
                      ]
                    },
                    {
                      "goal_name": "[Goal 2 Name derived ONLY from text]",
                      "strategies": [
                        {
                          "strategy_name": "[Strategy 2.1 Name ONLY from text]",
                          "rationale": "[Rationale linking strategy using ONLY text evidence...]",
                          "measures": ["[Measure/KPI 2.1.1 derived ONLY from text]"]
                        }
                      ]
                    }
                    // ... potentially 1-2 more goals derived ONLY from text ...
                  ]
                }
            `;

            // 3. Send Request to Ollama
            console.log(`Sending ENHANCED OGSM prompt to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
            });

            if (!response.ok) {
                let errorBody = `API error ${response.status}`;
                try { errorBody += `: ${await response.text()}`; } catch (e) {}
                throw new Error(errorBody);
            }

            const data = await response.json();
            let parsedData;
            console.log('Raw AI Response (OGSM - SP):', data.response); // Log raw response
            try {
                parsedData = JSON.parse(data.response);
                 // *** Refined Robust Validation ***
                 console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced OGSM SP) ---');
                 console.log(JSON.stringify(parsedData, null, 2));
                 console.log('------------------------------------');

                 if (!parsedData || typeof parsedData !== 'object' ||
                     !parsedData.main_objective || typeof parsedData.main_objective !== 'string' || parsedData.main_objective.includes("[") ||
                     !Array.isArray(parsedData.goals) || parsedData.goals.length < 1 ||
                     // Check structure of first goal and its strategies/measures
                     (parsedData.goals.length > 0 && (
                         typeof parsedData.goals[0] !== 'object' ||
                         !parsedData.goals[0].hasOwnProperty('goal_name') || parsedData.goals[0].goal_name.includes("[") ||
                         !Array.isArray(parsedData.goals[0].strategies) || parsedData.goals[0].strategies.length < 1 ||
                         (parsedData.goals[0].strategies.length > 0 && (
                             typeof parsedData.goals[0].strategies[0] !== 'object' ||
                             !parsedData.goals[0].strategies[0].hasOwnProperty('strategy_name') || parsedData.goals[0].strategies[0].strategy_name.includes("[") ||
                             !parsedData.goals[0].strategies[0].hasOwnProperty('rationale') || parsedData.goals[0].strategies[0].rationale.includes("[") ||
                             !Array.isArray(parsedData.goals[0].strategies[0].measures) || parsedData.goals[0].strategies[0].measures.length < 1 ||
                             (parsedData.goals[0].strategies[0].measures.length > 0 && parsedData.goals[0].strategies[0].measures[0].includes("[")) // Check first measure for placeholder
                         ))
                     ))
                    )
                 {
                      console.error("Validation Failed (Enhanced OGSM SP): Required fields missing, invalid structure, or placeholders detected.", parsedData);
                      throw new Error(`AI response structure is incorrect, inconsistent, or contains placeholders (Enhanced OGSM SP). Check objective, goals, strategies, rationales, and measures. See console logs.`);
                 }
                 console.log(`Successfully parsed ENHANCED OGSM (SP) JSON using ${MODEL_NAME}. Found ${parsedData.goals.length} goals.`);

            } catch (e) {
                console.error(`Failed to parse/validate ENHANCED OGSM (SP) JSON using ${MODEL_NAME}:`, data?.response, e);
                throw new Error(`Invalid JSON received or validation failed (Enhanced OGSM SP): ${e.message}. See raw response in console.`);
            }

            // 4. Render Results
            renderGoalsAndInitiativesPage_SP(analysisResultContainer, parsedData); // Use the new renderer

        } catch (error) {
            console.error(`Error in handleGoalsAndInitiativesAnalysis_SP (Enhanced) using ${MODEL_NAME}:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            // Ensure loading stops reliably
             if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
             }
        }
    }

/**
 * RENDERER: Goals & Strategic Initiatives (Strategic Planning)
 * - NEW: Renders the full 6-tab OGSM interface.
 * - Includes: Cascade View, Objective, Goals, Strategies, Measures, and Learn tabs.
 */
function renderGoalsAndInitiativesPage_SP(container, data) {
    container.innerHTML = ""; // Clear loading

    // Add validation for new fields
    if (!data || !data.main_objective || !data.goals) {
        console.error("Incomplete data passed to renderGoalsAndInitiativesPage_SP:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render OGSM results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    const { main_objective, goals } = data;

    // --- Create Tab Navigation (6 Tabs) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="cascade"> Cascade View</button>
        <button class="analysis-tab-btn" data-tab="objective"> Objective</button>
        <button class="analysis-tab-btn" data-tab="goals"> G Goals</button>
        <button class="analysis-tab-btn" data-tab="strategies"> S Strategies</button>
        <button class="analysis-tab-btn" data-tab="measures"> M Measures</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn OGSM</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (6 Panels) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="cascadePanel" class="analysis-tab-panel active"></div>
        <div id="objectivePanel" class="analysis-tab-panel"></div>
        <div id="goalsPanel" class="analysis-tab-panel"></div>
        <div id="strategiesPanel" class="analysis-tab-panel"></div>
        <div id="measuresPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Strategic Cascade Panel ---
    const cascadePanel = $("cascadePanel");
    let cascadeHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-6 text-center"> Strategic Cascade (OGSM)</h3><div class="cascade-container">
        <div class="cascade-objective">
            <h3 class="text-lg font-bold text-indigo-300">OBJECTIVE</h3>
            <p class="text-xl font-semibold">${main_objective}</p>
        </div>
        <div class="cascade-connector"></div>
        <div class="cascade-goals-grid">`;

    goals.forEach((goal) => {
        cascadeHtml += `<div class="cascade-goal-card">
            <div>
                <h4 class="text-md font-bold text-red-300">GOAL</h4>
                <p class="text-lg font-semibold">${goal.goal_name}</p>
            </div>
            <div class="space-y-3 mt-3">`;
        (goal.strategies || []).forEach((strategy) => {
            cascadeHtml += `<div class="cascade-strategy">
                <h5 class="text-sm font-bold text-yellow-300">STRATEGY</h5>
                <p class="font-semibold">${strategy.strategy_name}</p>
                 <p class="text-xs text-white/70 italic my-1">Rationale: ${strategy.rationale || 'N/A'}</p>
                <div class="mt-2 text-xs text-white/70">
                    <strong>Measures:</strong>
                    <ul class="list-disc list-inside ml-2">${(strategy.measures || []).map(m => `<li>${m}</li>`).join('')}</ul>
                </div>
            </div>`;
        });
        cascadeHtml += `</div></div>`;
    });
    cascadeHtml += `</div></div></div>`;
    cascadePanel.innerHTML = cascadeHtml;

    // --- 2. Populate Objective Panel ---
    const objectivePanel = $("objectivePanel");
    objectivePanel.innerHTML = `
        <div class="p-6">
             <h3 class="text-2xl font-bold mb-4 text-center"> Objective</h3>
             <div class="cascade-objective mx-auto max-w-2xl text-center bg-black/20 p-6 rounded-lg">
                <h3 class="text-lg font-bold text-indigo-300 mb-2">OVERARCHING OBJECTIVE</h3>
                <p class="text-2xl font-semibold italic">${main_objective}</p>
                 <p class="text-xs text-white/60 mt-4">(This sets the primary direction for the entire plan, derived from your input.)</p>
            </div>
        </div>`;


    // --- 3. Populate Goals Panel ---
    const goalsPanel = $("goalsPanel");
    let goalsHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4 text-center"> G Goals</h3>`;
    goalsHtml += `<p class="text-sm text-white/70 mb-6 italic text-center">These are the specific, high-level results needed to achieve the main Objective.</p>`;
    goals.forEach((goal, index) => {
        goalsHtml += `<div class="cascade-goal-card max-w-3xl mx-auto p-4 border-l-4 border-red-400">
            <h4 class="text-md font-bold text-red-300">GOAL ${index + 1}</h4>
            <p class="text-lg font-semibold">${goal.goal_name}</p>
        </div>`;
    });
    goalsHtml += `</div>`;
    goalsPanel.innerHTML = goalsHtml;


    // --- 4. Populate Strategies Panel ---
    const strategiesPanel = $("strategiesPanel");
    let strategiesHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4 text-center"> S Strategies</h3>`;
    strategiesHtml += `<p class="text-sm text-white/70 mb-6 italic text-center">These are the key approaches and choices ('how') to achieve each Goal.</p>`;
    goals.forEach((goal, index) => {
         strategiesHtml += `<div class="mb-6 bg-black/10 p-4 rounded-lg">
                               <h4 class="text-lg font-semibold mb-3 border-b border-white/10 pb-1 text-red-300">For Goal ${index + 1}: ${goal.goal_name}</h4>
                               <div class="space-y-4">`;
        (goal.strategies || []).forEach((strategy, s_index) => {
            strategiesHtml += `<div class="cascade-strategy border border-white/10 p-3 rounded-md">
                <h5 class="text-sm font-bold text-yellow-300">STRATEGY ${index + 1}.${s_index + 1}</h5>
                <p class="font-semibold text-white">${strategy.strategy_name}</p>
                <p class="text-xs text-white/70 italic my-2">${strategy.rationale || 'N/A'}</p>
            </div>`;
        });
         strategiesHtml += `</div></div>`;
    });
    strategiesHtml += `</div>`;
    strategiesPanel.innerHTML = strategiesHtml;


    // --- 5. Populate Measures Panel ---
    const measuresPanel = $("measuresPanel");
    let measuresHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center"> M Measures (KPIs)</h3>`;
    measuresHtml += `<p class="text-sm text-white/70 mb-6 italic text-center">These metrics track the progress and success of the Strategies.</p>`;
     measuresHtml += `<div class="overflow-x-auto">
                        <table class="coeff-table styled-table text-sm">
                            <thead><tr><th>Measure / KPI</th><th>Related Strategy</th><th>Related Goal</th></tr></thead>
                            <tbody>`;
    let kpiFound = false;
    goals.forEach((goal) => {
        (goal.strategies || []).forEach((strategy) => {
            (strategy.measures || []).forEach(measure => {
                kpiFound = true;
                measuresHtml += `<tr>
                                    <td class="font-semibold text-green-300">${measure}</td>
                                    <td>${strategy.strategy_name}</td>
                                    <td class="text-white/70">${goal.goal_name}</td>
                                 </tr>`;
            });
        });
    });
     if (!kpiFound) {
         measuresHtml += `<tr><td colspan="3" class="text-center text-white/60 italic p-4">No specific measures were identified from the text.</td></tr>`;
     }
    measuresHtml += `</tbody></table></div></div>`;
    measuresPanel.innerHTML = measuresHtml;


    // --- 6. Populate Learn OGSM Panel ---
    const learnPanel = $("learnPanel");
     learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding the OGSM Framework</h3>
        

[Image of OGSM framework diagram]

        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is OGSM?</h4>
            <p class="text-sm text-white/80">OGSM (Objective, Goals, Strategies, Measures) is a strategic planning framework used to define what an organization wants to achieve and how it plans to get there, ensuring clear alignment from the highest-level objective down to specific metrics.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-4">
                <div>
                    <h4 class="text-lg font-bold text-indigo-300">O - Objective</h4>
                    <p class="text-sm">The single, overarching, ambitious, and qualitatively stated aim for the planning period (e.g., "Become the market leader"). It sets the direction.</p>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-red-300">G - Goals</h4>
                    <p class="text-sm">Specific, measurable (SMART), time-bound results that need to be achieved to reach the Objective (e.g., "Increase market share to 25% by EOY"). They define 'what' success looks like.</p>
                </div>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-4">
                 <div>
                    <h4 class="text-lg font-bold text-yellow-300">S - Strategies</h4>
                    <p class="text-sm">The choices and approaches ('how') that will be employed to achieve the Goals (e.g., "Expand into new geographic regions," "Launch innovative product line"). They describe the path.</p>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-green-300">M - Measures</h4>
                    <p class="text-sm">Specific metrics (KPIs) used to track the progress and success of the Strategies (e.g., "Number of new stores opened," "Revenue from new products"). They monitor performance.</p>
                </div>
            </div>
        </div>

         <div class="bg-black/20 p-4 rounded-lg mt-6">
            <h4 class="text-lg font-bold mb-2">Why Use OGSM?</h4>
             <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Clarity & Focus:</strong> Creates a clear, concise (often one-page) view of the strategic plan.</li>
                <li><strong>Alignment:</strong> Ensures everyone understands the objective and how their work contributes through goals and strategies.</li>
                <li><strong>Actionability:</strong> Translates high-level objectives into concrete strategies and measurable targets.</li>
                <li><strong>Accountability:</strong> Measures provide a clear basis for tracking progress and holding teams accountable.</li>
                <li><strong>Communication:</strong> Simple structure makes it easy to communicate the plan across the organization.</li>
            </ul>
        </div>
         <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to structure your input context into an OGSM plan, deriving the elements strictly from the text provided.</p>
    </div>
    `;

     // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                 // No Plotly charts expected in this tool
            } else {
                 console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}

    function renderNovelGoalsPage_NS(container, data) {
        container.innerHTML = ""; // Clear loading state
        const { main_goal, horizons } = data;

        // Basic validation
        if (!main_goal || !horizons || !Array.isArray(horizons) || horizons.length !== 3) {
            container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete or invalid analysis data received. Cannot render Three Horizons plan.</div>`;
            $("analysisActions").classList.add("hidden"); // Hide save buttons
            setLoading("generate", false); // Ensure loading indicator stops
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Use standard tab styling
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
            <button class="analysis-tab-btn" data-tab="horizons"> Horizons Visual</button>
            <button class="analysis-tab-btn" data-tab="details"> Detailed Plan</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Framework</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active"></div>
            <div id="horizonsPanel" class="analysis-tab-panel"></div>
            <div id="detailsPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Dashboard Panel ---
        const dashboardPanel = $("dashboardPanel");
        let dashboardHtml = `<div class="p-4 space-y-8">
            <div class="p-6 rounded-lg bg-white/10 border border-white/20 text-center">
                <h3 class="text-xl font-bold mb-2 text-indigo-300"> Overarching Goal</h3>
                <p class="text-2xl italic text-white/90">${main_goal}</p>
            </div>
            <h3 class="text-2xl font-bold text-center">Initiatives Across Horizons</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">`;

        horizons.forEach((horizon, index) => {
            const colors = ["border-blue-400", "border-yellow-400", "border-red-400"];
            const initiativesList = horizon.initiatives || []; // Ensure it's an array
            dashboardHtml += `<div class="bg-white/5 p-4 rounded-lg border-l-4 ${colors[index]}">
                <h4 class="text-lg font-bold mb-2">${horizon.horizon_name}</h4>
                <p class="text-xs font-semibold text-white/70 mb-3">${horizon.timeframe}</p>
                <p class="text-xs italic text-white/70 mb-3">${horizon.focus}</p>`;
            // Handle empty initiatives list in dashboard
            if (initiativesList.length > 0) {
                 dashboardHtml += `<ul class="list-disc list-inside space-y-2 text-sm text-white/80">
                    ${initiativesList.map(init => `<li>${init.initiative_name}</li>`).join("")}
                </ul>`;
            } else {
                 dashboardHtml += `<p class="text-sm text-white/60 italic mt-2">(No specific initiatives derivable from context for this horizon)</p>`;
            }
            dashboardHtml += `</div>`;
        });
        dashboardHtml += `</div></div>`;
        dashboardPanel.innerHTML = dashboardHtml;


        // --- 2. Populate Horizons Visual Panel ---
        const horizonsPanel = $("horizonsPanel");
        let horizonsHtml = `<div class="horizons-container">
                    <div id="h3-circle" class="horizon-circle"><span class="horizon-label">Horizon 3 (${horizons[2]?.timeframe || '3-7+ Yrs'})</span></div>
                    <div id="h2-circle" class="horizon-circle"><span class="horizon-label">Horizon 2 (${horizons[1]?.timeframe || '12-36 Mos'})</span></div>
                    <div id="h1-circle" class="horizon-circle"><span class="horizon-label">Horizon 1 (${horizons[0]?.timeframe || '0-18 Mos'})</span></div>
                    <div class="main-goal-center">${main_goal}</div>`;

        let initiativeCount = 0;
        // Flatten only initiatives that actually exist
        const allValidInitiatives = horizons.flatMap(h => h.initiatives || []);
        const totalInitiatives = allValidInitiatives.length || 1;

        horizons.forEach((horizon, hIndex) => {
            (horizon.initiatives || []).forEach((initiative) => {
                const baseAngle = Math.PI / 6;
                const angleIncrement = (Math.PI * 1.8) / totalInitiatives;
                const angle = baseAngle + initiativeCount * angleIncrement;
                const radii = [25, 38, 50];
                const radius = radii[hIndex];
                const randomOffset = (Math.random() - 0.5) * 3;
                const effectiveRadius = Math.max(10, Math.min(60, radius + randomOffset));
                const x = 50 + effectiveRadius * Math.cos(angle);
                const y = 50 + effectiveRadius * Math.sin(angle);
                horizonsHtml += `<div class="initiative-point" style="left: ${x.toFixed(2)}%; top: ${y.toFixed(2)}%; transform: translate(-50%, -50%);" title="${initiative.description || initiative.initiative_name}">${initiative.initiative_name}</div>`;
                initiativeCount++;
            });
        });
        horizonsHtml += `</div>`;
        // Add message if no initiatives could be plotted
        if (allValidInitiatives.length === 0) {
             horizonsHtml += `<p class="text-center text-white/70 mt-[-50px] relative z-10">(No initiatives derived from context to plot)</p>`;
        }
        horizonsPanel.innerHTML = horizonsHtml;


        // --- 3. Populate Detailed Plan Panel ---
        const detailsPanel = $("detailsPanel");
        let detailsHtml = `<div class="p-4 space-y-6">
             <div class="p-4 rounded-lg bg-black/20 text-center mb-6">
                <h3 class="text-lg font-bold text-indigo-300"> Overarching Goal</h3>
                <p class="text-xl italic text-white/90">${main_goal}</p>
            </div>`;
        horizons.forEach((horizon) => {
            const initiativesList = horizon.initiatives || []; // Ensure it's an array
            detailsHtml += `<div class="bg-white/10 p-6 rounded-lg shadow-lg mb-6">
                        <h3 class="text-2xl font-bold mb-1">${horizon.horizon_name}</h3>
                        <p class="text-sm text-indigo-300 font-semibold mb-2">${horizon.timeframe}</p>
                        <p class="text-md italic text-white/80 mb-4">${horizon.focus}</p>
                        <h4 class="text-lg font-semibold mb-3 border-b border-white/20 pb-1">Initiatives:</h4>
                        <div class="space-y-4">`;
            // Handle empty initiatives list in detailed view
            if (initiativesList.length > 0) {
                initiativesList.forEach(initiative => {
                     detailsHtml += `<div class="bg-black/20 p-4 rounded">
                                    <p class="font-semibold text-white">${initiative.initiative_name}</p>
                                    <p class="text-xs text-white/70 italic my-1">${initiative.description}</p>
                                    <p class="text-xs text-yellow-300 mt-2"><strong>KPIs:</strong> ${(initiative.kpis || []).join(", ")}</p>
                                </div>`;
                });
            } else {
                 detailsHtml += `<p class="text-sm text-white/60 italic">(No specific initiatives derivable from context for this horizon)</p>`;
            }
            detailsHtml += `</div></div>`; // Close initiatives space-y-4 and horizon bg-white/10
        });
        detailsHtml += `</div>`; // Close details panel p-4 space-y-6
        detailsPanel.innerHTML = detailsHtml;


        // --- 4. Populate Learn Framework Panel ---
        const learnPanel = $("learnPanel");
        // (Keep the exact same HTML content for the learn panel as in the previous response)
        learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding the Three Horizons of Growth</h3>
                <p class="italic text-center">McKinsey's Three Horizons framework provides a structure for companies to manage current performance while maximizing future growth opportunities. It helps balance resources across initiatives with different timeframes and risk profiles.</p>
                <div class="text-center my-4"></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                        <h4 class="text-xl font-bold text-blue-300 mb-2">Horizon 1: Optimize the Core</h4>
                        <p class="text-sm font-semibold mb-2">Timeframe: ~0-18 Months</p>
                        <p class="text-sm mb-3"><strong>Focus:</strong> Defend, extend, and increase the profitability of the existing, core business. Improve efficiency and extract maximum value from current operations.</p>
                        <p class="text-sm"><strong>Characteristics:</strong> Lower risk, incremental improvements, known markets/customers, focus on execution, generates cash flow.</p>
                        <p class="text-sm mt-2"><strong>Example Activities:</strong> Process automation, cost reduction, product line extensions, customer retention programs.</p>
                    </div>
                    <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/50">
                        <h4 class="text-xl font-bold text-yellow-300 mb-2">Horizon 2: Build Adjacent Growth</h4>
                        <p class="text-sm font-semibold mb-2">Timeframe: ~12-36 Months</p>
                        <p class="text-sm mb-3"><strong>Focus:</strong> Develop emerging opportunities by leveraging existing capabilities into adjacent markets, products, or services. Build new lines of business.</p>
                        <p class="text-sm"><strong>Characteristics:</strong> Moderate risk, requires investment and new capabilities, potential for substantial growth, builds new revenue streams.</p>
                        <p class="text-sm mt-2"><strong>Example Activities:</strong> Geographic expansion, launching SaaS based on existing tech, entering new customer segments, strategic partnerships.</p>
                    </div>
                    <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/50">
                        <h4 class="text-xl font-bold text-red-300 mb-2">Horizon 3: Create Transformational Options</h4>
                        <p class="text-sm font-semibold mb-2">Timeframe: ~3-7+ Years</p>
                        <p class="text-sm mb-3"><strong>Focus:</strong> Explore and invest in truly disruptive or novel ideas, technologies, or business models that could become the core business of the distant future. Create options.</p>
                        <p class="text-sm"><strong>Characteristics:</strong> High risk & uncertainty, experimental, requires R&D or venture investment, uncertain outcomes but massive potential.</p>
                        <p class="text-sm mt-2"><strong>Example Activities:</strong> Basic research in new tech (AI, quantum), pilot programs for radical business models, minority investments in startups, creating internal innovation labs.</p>
                    </div>
                </div>
                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">Why Use the Three Horizons Framework?</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Balanced Portfolio:</strong> Ensures resources are allocated across short, medium, and long-term growth opportunities.</li>
                        <li><strong>Future-Proofing:</strong> Prevents complacency by forcing focus on future disruption and innovation.</li>
                        <li><strong>Structured Innovation:</strong> Provides a common language and framework for discussing and managing different types of growth initiatives.</li>
                        <li><strong>Resource Allocation:</strong> Helps justify investments in H2 and H3 initiatives that may not yield immediate returns.</li>
                        <li><strong>Avoiding the "Tyranny of the Urgent":</strong> Protects nascent H2/H3 projects from being starved by the demands of the core H1 business.</li>
                    </ul>
                 </div>
            </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache the result

        // Add event listener for tab switching
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     // const chart = targetPanel.querySelector(".plotly-chart"); // If charts added later
                     // if (chart) Plotly.Plots.resize(chart);
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator AFTER rendering
    }

    async function handleRegressionAnalysis_DA() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div></div><div></div><div></div> </div><h3 class="text-xl font-semibold text-white mb-4">Running scikit-learn Regression...</h3><p class="text-white/80 mb-2">Sending data to Python backend for statistical analysis...</p></div>`;
    setLoading("generate", true);
    $("analysisActions").classList.add("hidden");

    const API_URL = "https://analysis.sageaios.com/api/regression"; 
    
    const warningEl = $("regressionDataWarning");
    if (warningEl) warningEl.textContent = ""; 

    try {
        const formData = new FormData();
        
        let dependentVar, independentVarsList, dataFile, contextFile, contextText, numObservations;

        if (window.isSampleModeActive === true) {
            // --- SAMPLE MODE ---
            console.log(" Sample mode active - using hardcoded values");
            
            // HARDCODE the variables to match the actual UI selections
            dependentVar = "marketing_spend"; 
            independentVarsList = ["product_price", "customer_rating", "region", "sales_revenue"];
            
            // Fetch the files
            try {
                dataFile = await fetchFileAsObject('regression/regression-sample.csv');
                contextFile = await fetchFileAsObject('regression/regression-sample-doc.txt');
                
                if (!dataFile) {
                    throw new Error("Failed to fetch sample data file");
                }
                if (!contextFile) {
                    throw new Error("Failed to fetch sample context file");
                }
                
                console.log(" Sample files loaded successfully");
                console.log(" Data file:", dataFile.name);
                console.log(" Context file:", contextFile.name);
                
            } catch (fileError) {
                console.error(" Error loading sample files:", fileError);
                throw new Error(`Sample file loading failed: ${fileError.message}`);
            }
            
            // Verify the sample data has the expected columns
            try {
                const dataText = await dataFile.text();
                const headers = dataText.split(/[\r\n]+/)[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                console.log(" Available columns:", headers);
                
                // Check if our hardcoded variables exist in the data
                if (!headers.includes(dependentVar)) {
                    console.warn(` Dependent variable '${dependentVar}' not found in headers. Available: ${headers.join(', ')}`);
                    // Try to find a similar column or use the first numeric-looking column
                    const salesColumn = headers.find(h => h.toLowerCase().includes('sales') || h.toLowerCase().includes('revenue'));
                    if (salesColumn) {
                        dependentVar = salesColumn;
                        console.log(` Using '${dependentVar}' as dependent variable instead`);
                    }
                }
                
                // Check independent variables
                const missingVars = independentVarsList.filter(v => !headers.includes(v));
                if (missingVars.length > 0) {
                    console.warn(` Missing independent variables: ${missingVars.join(', ')}`);
                    // Filter to only include variables that exist
                    independentVarsList = independentVarsList.filter(v => headers.includes(v));
                    console.log(` Using available independent variables: ${independentVarsList.join(', ')}`);
                }
                
                numObservations = dataText.split(/[\r\n]+/).filter(line => line.trim()).length - 1; // -1 for header
                console.log(` Number of observations: ${numObservations}`);
                
            } catch (dataError) {
                console.error(" Error reading sample data:", dataError);
                throw new Error(`Sample data validation failed: ${dataError.message}`);
            }

        } else {
            // --- MANUAL MODE ---
            console.log(" Manual mode - reading from UI");
            
            // READ from UI as before
            dependentVar = $("dependentVar").value;
            const independentVarCheckboxes = document.querySelectorAll("#independentVarsContainer .independent-var-checkbox:checked");
            independentVarsList = Array.from(independentVarCheckboxes).map(cb => cb.value);
            
            // Get files from UI
            dataFile = $("regressionFile").files[0];
            if (!dataFile) {
                throw new Error(" Please upload a CSV data file.");
            }

            const useDoc = $("docUpload").checked;
            if (useDoc) {
                contextFile = $("regressionContextFile").files[0];
            } else {
                contextText = $("regressionContextText").value.trim();
            }
            numObservations = currentRegressionRowCount;
        }

        // 2. Validate Inputs
        if (!dataFile) {
            throw new Error(" Data file is missing.");
        }
        if (!dependentVar) {
             throw new Error(" Please select a Dependent Variable (Y).");
        }
        if (independentVarsList.length === 0) {
             throw new Error(" Please select at least one Independent Variable (X).");
        }
        if (independentVarsList.includes(dependentVar)) {
            throw new Error(" The Dependent Variable cannot also be an Independent Variable.");
        }

        console.log(` Final variables - Dependent: ${dependentVar}, Independent: ${independentVarsList.join(', ')}`);

        const numFeatures = independentVarsList.length;
        if (numObservations < 30) {
            throw new Error(` Insufficient Data: You have only ${numObservations} rows. A minimum of 30 is recommended for basic regression.`);
        }
        
        const ratio = numObservations / numFeatures;
        if (ratio < 10) {
            if (warningEl) {
                warningEl.textContent = `Warning: Data ratio is low (${ratio.toFixed(1)}-to-1). A 10-to-1 ratio is recommended. Results may be unstable.`;
                warningEl.className = "text-yellow-400 text-sm mt-2";
            }
        }
    
        // 3. Prepare FormData
        formData.append("data_file", dataFile, dataFile.name);
        console.log(` Appended data file: ${dataFile.name}`);

        if (contextFile) {
            formData.append("context_file", contextFile, contextFile.name);
            console.log(` Appended context file: ${contextFile.name}`);
        } else if (contextText) {
            const contextBlob = new Blob([contextText], { type: 'text/plain' });
            formData.append("context_file", contextBlob, "context_input.txt");
            console.log(" Appended context text as blob");
        }

        formData.append("target_column", dependentVar);
        formData.append("feature_columns", JSON.stringify(independentVarsList));
        
        console.log(" Sending request to backend...");
        
        // 4. Send Request
        const response = await fetch(API_URL, {
            method: "POST",
            body: formData,
        });

        // 5. Handle Response
        const parsedData = await response.json(); 
        console.log(" Received response from backend");

        if (!response.ok) {
            const errorMsg = parsedData.detail || `API Error: ${response.status} - ${response.statusText}`;
            throw new Error(errorMsg);
        }

        if (parsedData.metadata && parsedData.metadata.error === true) {
            console.error("Backend analysis failed:", parsedData.metadata.error_message);
            throw new Error(`Backend Analysis Error: ${parsedData.metadata.error_message}`);
        }

        // 6. Render Results
        console.log(" Analysis successful, rendering results...");
        renderAdvancedRegressionPage(analysisResultContainer, parsedData);

    } catch (error) {
        console.error(`Error in handleRegressionAnalysis_DA (Backend):`, error);
        const errorMessage = error.message;

        if (errorMessage.startsWith("")) {
             if (warningEl) {
                warningEl.textContent = errorMessage.substring(2); 
                warningEl.className = "text-red-400 text-sm mt-2"; 
             }
             analysisResultContainer.innerHTML = '<div class="text-white/60 p-8 text-center">Analysis stopped due to data issues.</div>'; 
        } else {
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"><strong>Error:</strong> ${errorMessage}</div>`;
        }

    } finally {
        window.isSampleModeActive = false; // Reset the flag
        setLoading("generate", false);
    }
}

    /**
     * --- NEW RENDERER v5 (Null-Safe) ---
     * --- USER REQUESTED UPDATE V3 ---
     * - Changed residual plot marker color to bright yellow for visibility.
     *
     * This function is designed to render the rich output from
     * the new 'statsmodels' backend and safely handles
     * null/undefined values from the JSON.
     */
    function renderAdvancedRegressionPage(container, data) {
        container.innerHTML = ""; // Clear loading state

        /**
         * Safely formats a number for display, handling null/undefined.
         */
        function safeFormat(num, digits, defaultVal = 'N/A') {
            if (num === null || typeof num === 'undefined' || isNaN(num)) {
                return defaultVal;
            }
            if (digits > 2 && num > 0 && num < (1 / Math.pow(10, digits))) {
                return `< 0.${'0'.repeat(digits - 1)}1`;
            }
            return num.toFixed(digits);
        }

        // --- Validate the new data structure ---
        if (!data || !data.statsmodels_results || !data.statistical_analysis || !data.dataset_info) {
            console.error("Incomplete data passed to renderAdvancedRegressionPage:", data);
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received from the backend.</div>`;
            $("analysisActions").classList.add("hidden");
            return;
        }

        const { statsmodels_results, sklearn_comparison, statistical_analysis, dataset_info } = data;
        const { model_summary, coefficients, diagnostics } = statsmodels_results;

        // --- Create Tab Navigation (8 Tabs) ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
            <button class="analysis-tab-btn" data-tab="coeffs"> Coefficients</button>
            <button class="analysis-tab-btn" data-tab="diagnostics"> Diagnostics</button>
            <button class="analysis-tab-btn" data-tab="assumptions"> Assumptions</button>
            <button class="analysis-tab-btn" data-tab="correlations"> Correlations</button>
            <button class="analysis-tab-btn" data-tab="comparison"> Model Comparison</button>
            <button class="analysis-tab-btn" data-tab="dataInfo"> Data Info</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Regression</button> 
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels (8 Panels) ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="dashboardPanel" class="analysis-tab-panel active"></div>
            <div id="coeffsPanel" class="analysis-tab-panel"></div>
            <div id="diagnosticsPanel" class="analysis-tab-panel"></div>
            <div id="assumptionsPanel" class="analysis-tab-panel"></div>
            <div id="correlationsPanel" class="analysis-tab-panel"></div>
            <div id="comparisonPanel" class="analysis-tab-panel"></div>
            <div id="dataInfoPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Dashboard Panel ---
        const dashboardPanel = $("dashboardPanel");
        const r2 = model_summary.r_squared ?? 0;
        const adj_r2 = model_summary.adj_r_squared ?? 0;
        const f_pvalue = model_summary.prob_f_statistic ?? 1.0;
        const f_stat = model_summary.f_statistic ?? 0;

        let dashboardHtml = `<div class="p-4 space-y-8">
            <h3 class="text-2xl font-bold text-center mb-4">Regression Dashboard (Statsmodels OLS)</h3>
            
            <div class="cascade-objective mb-6 text-center mx-auto max-w-4xl p-4">
                <h4 class="text-lg font-bold text-indigo-300">Regression Equation</h4>
                <p class="text-sm font-semibold break-words">${model_summary.equation}</p>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-4xl mx-auto mb-8">
                <div class="summary-stat-card">
                    <div class="stat-value text-green-400">${safeFormat(r2 * 100, 1)}%</div>
                    <div class="stat-label">R-Squared</div>
                </div>
                <div class="summary-stat-card">
                    <div class="stat-value text-green-400">${safeFormat(adj_r2 * 100, 1)}%</div>
                    <div class="stat-label">Adj. R-Squared</div>
                </div>
                <div class="summary-stat-card">
                    <div class="stat-value">${safeFormat(model_summary.observations, 0)}</div>
                    <div class="stat-label">Observations</div>
                </div>
                <div class="summary-stat-card">
                    <div class="stat-value">${safeFormat(f_stat, 2)}</div>
                    <div class="stat-label">F-Statistic</div>
                </div>
            </div>
            
            <blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90 max-w-4xl mx-auto">
                <strong>Model Fit Interpretation:</strong> 
                The model explains <strong>${safeFormat(adj_r2 * 100, 1)}%</strong> of the variance in <strong>${model_summary.dependent_variable}</strong> (Adj. R). 
                The overall model is statistically <strong>${f_pvalue < 0.05 ? "significant" : "NOT significant"}</strong> 
                (F-stat p-value = ${safeFormat(f_pvalue, 3)}), suggesting the features
                ${f_pvalue < 0.05 ? "collectively have a real effect." : "do not reliably predict the target."}
            </blockquote>
        </div>`;
        dashboardPanel.innerHTML = dashboardHtml;

        // --- 2. Populate Coefficients Panel ---
        const coeffsPanel = $("coeffsPanel");
        let coeffsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center">Coefficient Details</h3>`;
        coeffsHtml += `<div class="overflow-x-auto">
                        <table class="coeff-table styled-table text-sm">
                            <thead>
                                <tr>
                                    <th>Variable</th>
                                    <th>Coefficient</th>
                                    <th>Std. Error</th>
                                    <th>t-Statistic</th>
                                    <th>P-value</th>
                                    <th>95% Conf. Interval</th>
                                </tr>
                            </thead>
                            <tbody>`;

        for (const c of coefficients) {
            const isSig = c.p_value !== null && typeof c.p_value !== 'undefined' && c.p_value < 0.05;
            const pValueDisplay = safeFormat(c.p_value, 3, 'N/A');
            const colorClass = isSig ? "text-green-300 font-bold" : "text-white/70";
            
            coeffsHtml += `<tr class="${colorClass}">
                                <td class="font-semibold">${c.variable}</td>
                                <td>${safeFormat(c.coefficient, 4)}</td>
                                <td>${safeFormat(c.std_error, 4)}</td>
                                <td>${safeFormat(c.t_statistic, 3)}</td>
                                <td>${pValueDisplay} ${isSig ? '***' : ''}</td>
                                <td>[${safeFormat(c.conf_int_low, 3)}, ${safeFormat(c.conf_int_high, 3)}]</td>
                           </tr>`;
        }
        coeffsHtml += `</tbody></table></div>
                       <p class="text-xs text-white/60 mt-4">*** Statistically significant at p < 0.05. Coefficients are *not* standardized.</p>
                       </div>`;
        coeffsPanel.innerHTML = coeffsHtml;

        // --- 3. Populate Assumptions Panel (Formerly Diagnostics) ---
        const assumptionsPanel = $("assumptionsPanel");
        const bp_pvalue = diagnostics.breusch_pagan_pvalue.statistic ?? 1.0;
        const dw_stat = diagnostics.durbin_watson.statistic ?? 2.0;
        const jb_pvalue = diagnostics.jarque_bera_pvalue.statistic ?? 1.0;

        let assumpHtml = `<div class="p-4 space-y-8">
            <h3 class="text-2xl font-bold mb-4 text-center">Model Assumption Checks</h3>
            
            <div>
                <h4 class="text-xl font-semibold mb-2 text-center">Residuals vs. Predicted Plot</h4>
                <div id="residualsPlot" class="w-full h-[500px] plotly-chart bg-black/10 rounded-lg"></div>
                <p class="text-xs text-white/60 text-center mt-2"><strong>Goal:</strong> Look for random scatter around 0. Patterns (like a cone or a U-shape) indicate problems.</p>
            </div>
            
            <div>
                <h4 class="text-xl font-semibold mb-2 text-center">Statistical Tests</h4>
                <div class="overflow-x-auto max-w-3xl mx-auto">
                    <table class="coeff-table styled-table text-sm">
                        <thead>
                            <tr>
                                <th>Test</th>
                                <th>Statistic</th>
                                <th>Interpretation (p < 0.05 is Bad)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-semibold"><strong>Homoscedasticity (Breusch-Pagan)</strong><br><span class="text-xs text-white/60">Tests if residuals spread evenly.</span></td>
                                <td class="font-mono">${safeFormat(bp_pvalue, 3)}</td>
                                <td class="${bp_pvalue < 0.05 ? 'text-red-400' : 'text-green-300'}">${diagnostics.breusch_pagan_pvalue.interpretation}</td>
                            </tr>
                            <tr>
                                <td class="font-semibold"><strong>Autocorrelation (Durbin-Watson)</strong><br><span class="text-xs text-white/60">Tests if residuals are independent. (Want ~2.0)</span></td>
                                <td class="font-mono">${safeFormat(dw_stat, 3)}</td>
                                <td class="${(dw_stat < 1.5 || dw_stat > 2.5) ? 'text-red-400' : 'text-green-300'}">${diagnostics.durbin_watson.interpretation}</td>
                            </tr>
                            <tr>
                                <td class="font-semibold"><strong>Normality of Residuals (Jarque-Bera)</strong><br><span class="text-xs text-white/60">Tests if residuals form a bell curve.</span></td>
                                <td class="font-mono">${safeFormat(jb_pvalue, 3)}</td>
                                <td class="${jb_pvalue < 0.05 ? 'text-red-400' : 'text-green-300'}">${diagnostics.jarque_bera_pvalue.interpretation}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>`;
        assumptionsPanel.innerHTML = assumpHtml;

        // Render Residuals Plot
        try {
            const residualsTrace = {
                x: diagnostics.residuals_plot_data.map(p => p.predicted),
                y: diagnostics.residuals_plot_data.map(p => p.residual),
                mode: 'markers', type: 'scatter', name: 'Residuals',
                // --- MODIFICATION 1 ---
                marker: { color: 'rgba(245, 158, 11, 0.7)', size: 8, line: { color: 'rgba(255,255,255,0.3)', width: 1 } }
            };
            const residualsLayout = {
                title: 'Residuals vs. Predicted Values',
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                xaxis: { title: 'Predicted Values', gridcolor: 'rgba(255,255,255,0.1)', zeroline: false },
                yaxis: { title: 'Residuals', zeroline: true, zerolinecolor: 'var(--accent)', zerolinewidth: 2, gridcolor: 'rgba(255,255,255,0.1)' },
                margin: { t: 50, b: 50, l: 60, r: 30 }
            };
            Plotly.newPlot('residualsPlot', [residualsTrace], residualsLayout, { responsive: true });
        } catch(e) {
            console.error("Error rendering residuals plot:", e);
            $("residualsPlot").innerHTML = `<div class="p-4 text-center text-red-400">Could not render residuals plot.</div>`;
        }

        // --- 4. Populate Correlations Panel ---
        const correlationsPanel = $("correlationsPanel");
        let corrHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center">Correlation with Target (${dataset_info.target_column})</h3>`;
        
        if (statistical_analysis.correlations) {
            corrHtml += `<div class="overflow-x-auto max-w-lg mx-auto">
                         <table class="coeff-table styled-table text-sm">
                            <thead><tr><th>Feature</th><th>Correlation Coefficient</th></tr></thead>
                            <tbody>`;
            const sortedCorrs = Object.entries(statistical_analysis.correlations)
                                    .sort(([, a], [, b]) => Math.abs(b ?? 0) - Math.abs(a ?? 0));
            for (const [feature, corr] of sortedCorrs) {
                const corrValue = corr ?? 0;
                let colorClass = "text-white/70";
                if (Math.abs(corrValue) > 0.7) colorClass = "text-green-300 font-bold";
                else if (Math.abs(corrValue) > 0.4) colorClass = "text-yellow-300";
                corrHtml += `<tr>
                                <td class="font-semibold">${feature}</td>
                                <td class="${colorClass}">${safeFormat(corrValue, 4)}</td>
                             </tr>`;
            }
            corrHtml += `</tbody></table></div>
                         <p class="text-xs text-white/60 text-center mt-4">Values close to +1.0 or -1.0 indicate a strong relationship.</p>`;
        } else if (statistical_analysis.error) {
            corrHtml += `<p class="text-center text-red-400 italic">Could not calculate correlations: ${statistical_analysis.error}</p>`;
        } else {
            corrHtml += `<p class="text-center text-white/70 italic">Correlation data not available.</p>`;
        }
        correlationsPanel.innerHTML = corrHtml;
        
        // --- 5. Populate Model Comparison Panel ---
        const comparisonPanel = $("comparisonPanel");
        let compHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center">Model Performance Comparison</h3>`;
        compHtml += `<p class="text-sm text-white/70 mb-4 text-center">Comparing Statsmodels OLS (for inference) vs. Sklearn models (for prediction).</p>`;
        compHtml += `<div class="overflow-x-auto">
                        <table class="coeff-table styled-table text-sm">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Test R-Squared (R)</th>
                                    <th>Test RMSE</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b-2 border-indigo-400">
                                    <td class="font-semibold">Statsmodels OLS</td>
                                    <td class="text-green-300 font-bold">${safeFormat(model_summary.r_squared, 4)}</td>
                                    <td>N/A (Full dataset used)</td>
                                </tr>`;

        // Sklearn Model Results
        for (const modelName in sklearn_comparison) {
            const result = sklearn_comparison[modelName];
            if (result.error) {
                compHtml += `<tr><td class="font-semibold">${modelName}</td><td colspan="2" class="text-red-400">${result.error}</td></tr>`;
            } else {
                compHtml += `<tr>
                                <td class="font-semibold">${modelName} (Sklearn)</td>
                                <td class="text-green-300 font-bold">${safeFormat(result.test_r2, 4)}</td>
                                <td>${safeFormat(result.test_rmse, 2)}</td>
                              </tr>`;
            }
        }
        compHtml += `</tbody></table></div>
                    <div class="mt-6 p-4 bg-black/20 rounded-lg border border-white/10">
                        <h4 class="text-lg font-bold text-indigo-300 mb-2">How to Interpret:</h4>
                        <ul class="list-disc list-inside space-y-1 text-sm text-white/80">
                            <li>Use <strong>Statsmodels OLS</strong> for p-values, diagnostics, and statistical *inference*.</li>
                            <li>Use <strong>Sklearn Models (e.g., Random Forest)</strong> for *predictive accuracy*. A higher Test R here might mean better predictions, even if it's less interpretable.</li>
                            <li>If Random Forest R is much higher than OLS R, it suggests your data has non-linear relationships that the linear model can't capture.</li>
                        </ul>
                    </div></div>`;
        comparisonPanel.innerHTML = compHtml;

        // --- 6. Populate Data Info Panel ---
        const dataInfoPanel = $("dataInfoPanel");
        
        let targetStatsHtml = "";
        if (statistical_analysis.error) {
            targetStatsHtml = `<p class="text-sm text-red-400">Error during statistical analysis: ${statistical_analysis.error}</p>`;
        } else if (statistical_analysis.target_stats) {
            targetStatsHtml = `
                <p class="text-sm"><strong>Mean:</strong> ${safeFormat(statistical_analysis.target_stats.mean, 2)}</p>
                <p class="text-sm"><strong>Std. Dev:</strong> ${safeFormat(statistical_analysis.target_stats.std, 2)}</p>
                <p class="text-sm"><strong>Min:</strong> ${safeFormat(statistical_analysis.target_stats.min, 2)}</p>
                <p class="text-sm"><strong>Max:</strong> ${safeFormat(statistical_analysis.target_stats.max, 2)}</p>
            `;
        } else {
            targetStatsHtml = `<p class="text-sm text-white/70 italic">Target variable statistics not available.</p>`;
        }

        const originalFeatures = dataset_info.original_feature_columns || [];
        const finalFeatures = dataset_info.final_feature_columns_after_encoding || [];
        
        dataInfoPanel.innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold mb-4 text-center">Analysis Data Summary</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                    <div class="summary-stat-card"><div class="stat-value">${safeFormat(dataset_info.original_rows, 0)}</div><div class="stat-label">Original Rows</div></div>
                    <div class="summary-stat-card"><div class="stat-value">${safeFormat(dataset_info.clean_rows, 0)}</div><div class="stat-label">Rows Used (After Clean)</div></div>
                    <div class="summary-stat-card"><div class="stat-value">${safeFormat(model_summary.observations, 0)}</div><div class="stat-label">Final Observations</div></div>
                    <div class="summary-stat-card"><div class="stat-value">${safeFormat(dataset_info.features_count, 0)}</div><div class="stat-label">Features Used</div></div>
                </div>
                <div class="bg-black/20 p-4 rounded-lg max-w-4xl mx-auto">
                    <h4 class="text-lg font-semibold mb-2">Target Variable: ${dataset_info.target_column}</h4>
                    ${targetStatsHtml}
                </div>
                <div class="bg-black/20 p-4 rounded-lg max-w-4xl mx-auto">
                    <h4 class="text-lg font-semibold mb-2">Original Features Submitted (${originalFeatures.length})</h4>
                    <p class="text-sm text-white/80"><strong>${originalFeatures.join(", ")}</strong></p>
                    
                    <h4 class="text-lg font-semibold mt-4 mb-2">Final Features Used (After Encoding: ${finalFeatures.length})</h4>
                    <p class="text-xs text-white/70">${finalFeatures.join(", ")}</p>
                </div>
            </div>`;

        // --- 7. Populate Learn Panel ---
        renderLearnRegressionPanel("learnPanel");

        // --- 8. Populate NEW Diagnostics Panel ---
        renderRegressionDiagnosticsTab("diagnosticsPanel", data);

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache the new HTML
        $("analysisActions").classList.remove("hidden"); // Show save buttons

        // --- Tab Switching Logic ---
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));
                
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);

                if (targetPanel) {
                    targetPanel.classList.add("active");
                    
                    // Check if the panel being activated is the "Assumptions" panel
                    if (e.target.dataset.tab === "assumptions") {
                        const chart = targetPanel.querySelector(".plotly-chart"); // Find the chart *inside* this panel
                        if (chart && chart.layout && typeof Plotly !== 'undefined') {
                            try {
                                Plotly.Plots.resize(chart);
                            } catch (resizeError) {
                                console.error(`Error resizing chart ${chart.id} on tab switch:`, resizeError);
                            }
                        }
                    }
                }
            }
        });

        // --- Initial Chart Render ---
        setTimeout(() => {
            const residualsChart = $("residualsPlot");
            if (residualsChart && !residualsChart.layout) { // Only render if not already rendered
                try {
                    const residualsTrace = {
                        x: diagnostics.residuals_plot_data.map(p => p.predicted),
                        y: diagnostics.residuals_plot_data.map(p => p.residual),
                        mode: 'markers', type: 'scatter', name: 'Residuals',
                        // --- MODIFICATION 2 ---
                        marker: { color: 'rgba(245, 158, 11, 0.7)', size: 8, line: { color: 'rgba(255,255,255,0.3)', width: 1 } }
                    };
                    const residualsLayout = {
                        title: 'Residuals vs. Predicted Values',
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                        xaxis: { title: 'Predicted Values', gridcolor: 'rgba(255,255,255,0.1)', zeroline: false },
                        yaxis: { title: 'Residuals', zeroline: true, zerolinecolor: 'var(--accent)', zerolinewidth: 2, gridcolor: 'rgba(255,255,255,0.1)' },
                        margin: { t: 50, b: 50, l: 60, r: 30 }
                    };
                    Plotly.newPlot('residualsPlot', [residualsTrace], residualsLayout, { responsive: true });
                } catch(e) {
                    console.error("Error rendering residuals plot:", e);
                    $("residualsPlot").innerHTML = `<div class="p-4 text-center text-red-400">Could not render residuals plot.</div>`;
                }
            }
        }, 100); // Give the DOM a moment to settle
    }
    
    /**
 * --- NEW FUNCTION (Corrected) ---
 * Renders the new "Diagnostics" tab for regression, focusing on warnings.
 * --- FIX ---
 * - Correctly destructures 'coefficients' from 'data.statsmodels_results' instead of 'data'.
 *
 * @param {string} containerId - The ID of the HTML element to render into.
 * @param {object} data - The full backend response data.
 */
function renderRegressionDiagnosticsTab(containerId, data) {
    const container = $(containerId);
    if (!container) return;

    // Helper to safely format numbers
    function safeFormat(num, digits, defaultVal = 'N/A') {
        if (num === null || typeof num === 'undefined' || isNaN(num)) return defaultVal;
        if (digits > 2 && num > 0 && num < (1 / Math.pow(10, digits))) return `< 0.${'0'.repeat(digits - 1)}1`;
        return num.toFixed(digits);
    }

    // --- CORRECTED DESTRUCTURING ---
    // Destructure the main data object first
    const { statsmodels_results, sklearn_comparison, statistical_analysis } = data;
    // NOW destructure the nested objects
    const { model_summary, coefficients, diagnostics } = statsmodels_results;
    // --- END CORRECTION ---

    const warnings = [];

    // 1. Check for statistical_analysis errors
    if (statistical_analysis.error) {
        warnings.push({
            level: 'high',
            type: 'Data Preprocessing Error',
            message: `Could not perform initial statistical analysis: ${statistical_analysis.error}`,
            impact: 'Correlations and target stats are unavailable.'
        });
    }

    // 2. Check Sklearn model errors
    for (const modelName in sklearn_comparison) {
        if (sklearn_comparison[modelName].error) {
            warnings.push({
                level: 'medium',
                type: 'Sub-Model Failure',
                message: `The ${modelName} (Sklearn) model failed to train: ${sklearn_comparison[modelName].error}`,
                impact: 'Comparison data for this model is unavailable.'
            });
        }
    }

    // 3. Check overall model significance
    const f_pvalue = model_summary.prob_f_statistic ?? 1.0;
    if (f_pvalue >= 0.05) {
        warnings.push({
            level: 'high',
            type: 'Model Not Significant',
            message: `The overall model is not statistically significant (F-statistic p-value = ${safeFormat(f_pvalue, 3)}).`,
            impact: 'The independent variables, as a group, do not reliably predict the dependent variable. The results should not be trusted.'
        });
    }

    // 4. Check statistical assumption test FAILURES
    const bp_pvalue = diagnostics.breusch_pagan_pvalue.statistic ?? 1.0;
    if (bp_pvalue < 0.05) {
        warnings.push({
            level: 'medium',
            type: 'Heteroscedasticity Detected',
            message: `The Breusch-Pagan test failed (p = ${safeFormat(bp_pvalue, 3)}), suggesting residuals do not have constant variance.`,
            impact: 'p-values and standard errors for coefficients may be unreliable.'
        });
    }

    const dw_stat = diagnostics.durbin_watson.statistic ?? 2.0;
    if (dw_stat < 1.5 || dw_stat > 2.5) {
        warnings.push({
            level: 'medium',
            type: 'Autocorrelation Detected',
            message: `The Durbin-Watson statistic is ${safeFormat(dw_stat, 3)} (ideal is ~2.0), suggesting residuals are not independent.`,
            impact: 'This is a problem for time-series data. Standard errors and p-values may be inaccurate.'
        });
    }

    const jb_pvalue = diagnostics.jarque_bera_pvalue.statistic ?? 1.0;
    if (jb_pvalue < 0.05) {
        warnings.push({
            level: 'low',
            type: 'Non-Normal Residuals',
            message: `The Jarque-Bera test failed (p = ${safeFormat(jb_pvalue, 3)}), suggesting residuals are not normally distributed.`,
            impact: 'This is less critical with large samples, but indicates a potential violation of OLS assumptions.'
        });
    }

    // 5. Check for non-significant coefficients
    // This line will now work because 'coefficients' is correctly defined
    const nonSigCoeffs = coefficients.filter(c => c.variable.toLowerCase() !== 'const' && (c.p_value === null || c.p_value >= 0.05));
    if (nonSigCoeffs.length > 0) {
        warnings.push({
            level: 'low',
            type: 'Non-Significant Predictors',
            message: `The following variables were not statistically significant (p >= 0.05): ${nonSigCoeffs.map(c => c.variable).join(', ')}`,
            impact: 'These variables do not have a reliable, non-zero relationship with the target variable in this model.'
        });
    }

    // --- Render the HTML ---
    let html = `<div class="p-6 space-y-8 text-white/90 max-w-6xl mx-auto">
                <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-red-400 to-orange-400 bg-clip-text text-transparent">
                      Warnings & Diagnostics
                </h3>`;

    if (warnings.length > 0) {
        // Sort warnings: high, medium, low
        const levelOrder = { 'high': 1, 'medium': 2, 'low': 3 };
        warnings.sort((a, b) => (levelOrder[a.level] || 4) - (levelOrder[b.level] || 4));

        html += `<div class="space-y-4">
                    <h4 class="text-xl font-bold text-red-300 mb-4"> Analysis Alerts</h4>`;
        
        warnings.forEach(warning => {
            const colors = {
                high: { bg: 'bg-red-900/20', border: 'border-red-500', text: 'text-red-300', icon: '' },
                medium: { bg: 'bg-yellow-900/20', border: 'border-yellow-500', text: 'text-yellow-300', icon: '' },
                low: { bg: 'bg-blue-900/20', border: 'border-blue-500', text: 'text-blue-300', icon: '' }
            };
            const c = colors[warning.level] || colors.low;

            html += `
                <div class="p-4 rounded-lg border-l-4 ${c.bg} ${c.border}">
                    <div class="flex items-start space-x-3">
                        <div class="text-2xl">${c.icon}</div>
                        <div class="flex-1">
                            <h5 class="font-semibold text-lg ${c.text}">${warning.type}</h5>
                            <p class="text-white/90 mt-1">${warning.message}</p>
                            <p class="text-white/70 text-sm mt-2"><strong>Impact:</strong> ${warning.impact}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
    } else {
        html += `
            <div class="p-4 bg-green-900/20 border border-green-500/30 rounded-lg text-center">
                <div class="text-2xl mb-2"></div>
                <p class="text-green-300 font-semibold">No Critical Warnings Detected</p>
                <p class="text-white/70 text-sm mt-1">The statistical model appears to be stable and assumption tests passed.</p>
            </div>
        `;
    }

    html += `</div>`;
    container.innerHTML = html;
}

    /**
 * --- NEW FUNCTION ---
 * Renders the static 'Learn Regression' content into the specified container.
 * @param {string} containerId - The ID of the HTML element to render into.
 */
function renderLearnRegressionPanel(containerId) {
    const container = $(containerId);
    if (!container) return; // Exit if container not found

    // Static HTML content explaining Regression
    container.innerHTML = `
        <div class="p-6 space-y-6 text-white/90">
            <h3 class="text-3xl font-bold text-center mb-4"> Understanding Regression Analysis</h3>
            
            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-lg font-bold mb-2 text-indigo-300">What is Regression Analysis?</h4>
                <p class="text-sm text-white/80">Regression analysis is a statistical method used to model the relationship between a **dependent variable** (the outcome you want to predict) and one or more **independent variables** (the factors you believe influence the outcome).</p>
                <p class="text-sm text-white/80 mt-2">It helps answer questions like: "How much does my marketing spend affect my sales?" or "Which factors have the biggest impact on customer satisfaction?"</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2">Key Concepts to Know:</h4>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        <li>
                            <strong>Coefficient:</strong> The number showing how much the dependent variable is expected to change (on average) for a one-unit increase in the independent variable, holding all other variables constant.
                        </li>
                        <li>
                            <strong>p-value:</strong> The probability that the observed relationship is just due to random chance. A p-value **< 0.05** is typically considered "statistically significant," meaning the relationship is likely real.
                        </li>
                        <li>
                            <strong>R-Squared (R):</strong> A score from 0% to 100% that indicates how much of the variation in the dependent variable is "explained" by the independent variables in your model. A higher R is generally better.
                        </li>
                         <li>
                            <strong>Adj. R-Squared:</strong> A modified version of R-Squared that adjusts for the number of variables in the model. It's often preferred for comparing models with different numbers of predictors.
                        </li>
                    </ul>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2">Interpreting Your Results:</h4>
                     <ol class="list-decimal list-inside space-y-1 text-sm">
                        <li><strong>Check Model Fit (Dashboard):</strong> Is the **Adj. R-Squared** high enough to be useful? Is the **F-statistic p-value** < 0.05? If not, the model as a whole isn't very good at explaining the outcome.</li>
                        <li><strong>Check Coefficients (Coefficients Tab):</strong> Look for variables with a **p-value < 0.05**. These are your significant predictors.</li>
                        <li><strong>Analyze Coefficients:</strong> For significant predictors, look at the **Coefficient** value. Is it positive (+) or negative (-)? How large is it? This tells you the direction and strength of the relationship.</li>
                        <li><strong>Check Diagnostics (Diagnostics Tab):</strong> Are there any red flags? You want random scatter in the residuals plot and "PASS" on the statistical tests.</li>
                     </ol>
                </div>
            </div>

             <details class="styled-details text-sm mt-4">
                <summary class="font-semibold"> Common Pitfalls & Assumptions</summary>
                <div class="bg-black/20 p-4 rounded-b-lg space-y-3">
                    <p><strong>Multicollinearity (Check Correlations):</strong> If your independent variables are highly correlated with *each other* (e.g., > 0.8), it can make your coefficients unreliable. The model can't tell which variable is "responsible" for the effect.</p>
                    <p><strong>Homoscedasticity (Check Breusch-Pagan):</strong> The model assumes residuals (errors) are spread randomly and evenly. If they form a cone or fan shape (heteroscedasticity), your p-values might be inaccurate. This is a common issue.</p>
                    <p><strong>Normality of Residuals (Check Jarque-Bera):</strong> Assumes the errors are normally distributed (a bell curve). Violations are less critical with large samples but can be an issue.</p>
                    <p><strong>Autocorrelation (Check Durbin-Watson):</strong> Assumes errors are independent. This is mainly a problem in time-series data (e.g., stock prices) where one day's error affects the next. You want a value around 2.0.</p>
                </div>
            </details>
        </div>
    `;
}

    async function handleLeveragePointsAnalysis() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `
            <div class="text-center text-white/70 p-8">
                <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                <h3 class="text-xl font-semibold text-white mb-4">Performing Full System Leverage Analysis</h3>
                <p class="text-white/80 mb-2">Identifying elements, feedback loops, and high-impact intervention points...</p>
            </div>`;
        setLoading("generate", true);

        // Define URL and Model
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";

        try {
            // 1. Gather Inputs
            const useDoc = $("docUpload").checked;
            let text = "";

            if (useDoc) {
                const file = $("leverageFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                text = await extractTextFromFile(file);
            } else {
                text = $("leverageContent").value.trim();
                if (!text.trim()) throw new Error("Please enter system information in the text area.");
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("leverageLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
                console.log("Injected location into Leverage Points Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (text.length > MAX_CONTEXT_LENGTH) {
                text = text.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
                console.warn(`Leverage Points analysis context truncated.`);
            }


            // 2. --- NEW ENHANCED PROMPT (v3 with UNANALYZABLE path) ---
            const prompt = `
                You are a master systems thinking analyst. Your task is to analyze the provided text, determine its intent, and identify its key leverage points based *only* on the provided text. ${truncatedNote}

                **USER'S SYSTEM DESCRIPTION:**
                \`\`\`
                ${text}
                \`\`\`

                **DETAILED TASKS (Follow this order):**

                **VALIDATION:**
                If the text is gibberish or random characters, return the INVALID structure.

                **Task 1: Determine Text Intent.**
                First, read the text to determine its intent.
                - Is it a **Dynamic System Problem** (contains "sales are falling", "growth stalled", "bottleneck", "we have a problem with...")?
                - OR is it a **Descriptive Company Profile** (listing services, features, and differentiators, like "NexaFlow Capital...")?
                - OR is it **Unanalyzable** (a poem, a random story, a shopping list, or text with no clear factors, services, or problems)?

                **Task 2: Generate JSON based on Intent (Ground all answers *strictly* in the text):**

                **IF IT IS A DYNAMIC SYSTEM PROBLEM:**
                1.  **Elements (\`elements\`):** Extract 5-7 key elements (Stocks, Flows, Variables).
                2.  **Feedback Loops (\`feedback_loops\`):** Identify the 1-2 primary Reinforcing and Balancing loops *described in the text*.
                3.  **Summary (\`summary\`):** Summarize the dynamic problem caused by the loop interactions.
                4.  **Leverage Points (\`leverage_points\`):** Identify 3-4 *interventions* to fix or influence the loops. Rank them by "High", "Medium", "Low" impact. For each:
                    * \`point_name\`: Name of the intervention (e.g., "Adjust Support Staffing").
                    * \`potential_impact_rank\`: "High", "Medium", or "Low".
                    * \`intervention\`: The specific action (e.g., "Increase budget parameter...").
                    * \`rationale\`: How it fixes the loop (e.g., "Weakens B1 constraint...").
                    * \`expected_outcome\`: The expected result (e.g., "Allow more growth...").

                **IF IT IS A DESCRIPTIVE COMPANY PROFILE (like NexaFlow):**
                1.  **Elements (\`elements\`):** Extract the 5-7 key services, features, or differentiators as "Variable" or "Stock" elements (e.g., "AI-driven investment advisory", "NexaScore AI engine").
                2.  **Feedback Loops (\`feedback_loops\`):** This MUST be an empty array [].
                3.  **Summary (\`summary\`):** A simple 1-sentence description of the company (e.g., "NexaFlow Capital is a FinTech...").
                4.  **Leverage Points (\`leverage_points\`):** Identify the 3-4 most important **"Differentiators"** or **"Core Services"** listed. These are the leverage points.
                    * \`point_name\`: The name of the differentiator (e.g., "NexaScore AI engine").
                    * \`potential_impact_rank\`: "High" (for differentiators) or "Medium" (for core services).
                    * \`target_element_or_loop\`: The name of the element itself (e.g., "NexaScore AI engine").
                    * \`intervention\`: An action to *amplify* this strength (e.g., "Enhance and scale the NexaScore AI engine").
                    * \`rationale\`: Why this is a key strategic advantage (e.g., "This is a proprietary asset that provides a competitive edge...").
                    * \`expected_outcome\`: The business result of amplifying it (e.g., "Increase market share and solidify position...").
                
                **IF IT IS UNANALYZABLE:**
                1.  **Elements (\`elements\`):** This MUST be an empty array [].
                2.  **Feedback Loops (\`feedback_loops\`):** This MUST be an empty array [].
                3.  **Summary (\`summary\`):** A clear explanation of why the text cannot be analyzed (e.g., "The provided text appears to be a [poem/story/etc.] and does not contain analyzable system components...").
                4.  **Leverage Points (\`leverage_points\`):** This MUST be an empty array [].
                
                **ABSOLUTE CONSTRAINTS:**
                - STICK TO THE TEXT. Do NOT invent information.
                - If the text is descriptive, DO NOT invent feedback loops.
                - JSON format must be perfect.

                **RETURN FORMAT (Example for a Descriptive Profile):**
                {
                  "elements": [
                    {"name": "AI-driven investment advisory", "type": "Variable"},
                    {"name": "NexaScore AI engine", "type": "Variable"},
                    {"name": "Blockchain-audited trails", "type": "Variable"}
                  ],
                  "feedback_loops": [],
                  "summary": "NexaFlow Capital is a digital-first financial services company offering AI-driven investment advisory...",
                  "leverage_points": [
                    {
                      "point_name": "Proprietary NexaScore AI engine",
                      "potential_impact_rank": "High",
                      "target_element_or_loop": "NexaScore AI engine",
                      "intervention": "Enhance and scale the NexaScore AI engine",
                      "rationale": "This is a key proprietary differentiator that provides a significant competitive advantage in real-time credit scoring.",
                      "expected_outcome": "Solidify market leadership and attract more SME lending clients."
                    },
                    {
                      "point_name": "Blockchain-audited transaction trails",
                      "potential_impact_rank": "Medium",
                      "target_element_or_loop": "Blockchain-audited trails",
                      "intervention": "Market the transparency of blockchain-audited trails",
                      "rationale": "This feature directly addresses the 'unprecedented transparency' value proposition.",
                      "expected_outcome": "Increase trust and adoption of DeFi payment services."
                    }
                  ]
                }
            `;
            // --- END OF NEW PROMPT ---

            // 3. Send Request to Ollama
            console.log(`Sending ENHANCED Leverage Points prompt (v3) to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: {
                        num_ctx: 32768
                    }
                })
            });

            if (!response.ok) {
                let errorBody = `API error ${response.status}`;
                try {
                    errorBody += `: ${await response.text()}`;
                } catch (e) {}
                throw new Error(errorBody);
            }

            const data = await response.json();
            let parsedData;
            console.log('Raw AI Response (Leverage Points):', data.response); // Log raw response
            try {
                parsedData = JSON.parse(data.response);
                // *** Refined Robust Validation ***
                console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Leverage Points v3) ---');
                console.log(JSON.stringify(parsedData, null, 2));
                console.log('------------------------------------');

                if (!parsedData || typeof parsedData !== 'object' ||
                    !Array.isArray(parsedData.elements) ||
                    !Array.isArray(parsedData.feedback_loops) || // Must be an array, even if empty
                    !parsedData.summary || typeof parsedData.summary !== 'string' ||
                    !Array.isArray(parsedData.leverage_points) || // Must be an array, even if empty
                    
                    // Check for invalid state: must have leverage points IF elements exist
                    (parsedData.elements.length > 0 && parsedData.leverage_points.length < 1) ||
                    
                    // Check for valid state: must have NO leverage points IF elements are empty
                    (parsedData.elements.length === 0 && parsedData.leverage_points.length > 0)
                ) {
                    // This logic handles the "Unanalyzable" case (elements: [], leverage_points: []) as VALID
                    // But flags a case where AI finds elements but fails to find leverage points.
                    if (parsedData.elements.length > 0 && parsedData.leverage_points.length < 1) {
                         console.error("Validation Failed (Enhanced Leverage Points v3): AI found elements but no leverage points.", parsedData);
                         throw new Error(`AI response structure is inconsistent. Found elements but no leverage points.`);
                    }
                }
                console.log(`Successfully parsed ENHANCED Leverage Points JSON (v3) using ${MODEL_NAME}. Found ${parsedData.leverage_points.length} leverage points.`);

            } catch (e) {
                console.error(`Failed to parse/validate ENHANCED Leverage Points JSON (v3) using ${MODEL_NAME}:`, data?.response, e);
                throw new Error(`Invalid JSON received or validation failed (Enhanced Leverage Points v3): ${e.message}. See raw response in console.`);
            }

            // 4. Render Results
            renderLeveragePointsPage(analysisResultContainer, parsedData);

        } catch (error) {
            console.error(`Error in handleLeveragePointsAnalysis (Enhanced v3) using ${MODEL_NAME}:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            // Ensure loading stops reliably
            if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
            }
        }
    }


function renderLeveragePointsPage(container, data) {
    container.innerHTML = ""; // Clear the loading indicator

    // --- Validation for the flexible structure ---
    if (!data || !data.summary || !data.elements || !data.feedback_loops || !data.leverage_points) {
        console.error("Incomplete data passed to renderLeveragePointsPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Leverage Points results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }
    
    // --- NEW CHECK FOR UNANALYZABLE TEXT ---
    // If the AI returns no elements AND no leverage points, it means the text was unanalyzable.
    // Display the summary (which is now an error message) and stop.
    if (data.elements.length === 0 && data.leverage_points.length === 0) {
        console.warn("Data is unanalyzable. Displaying summary as error.");
        container.innerHTML = `<div class="p-4 text-center text-yellow-300">
                                 <h4 class="text-xl font-bold mb-3">Analysis Incomplete</h4>
                                 <p class="text-white/80">${data.summary}</p>
                                 <p class="text-sm text-white/70 mt-2">Please try again with text describing a business, a system problem, or a research plan.</p>
                               </div>`;
        $("analysisActions").classList.add("hidden"); // Hide save buttons
        return; // Stop rendering
    }
    // --- END NEW CHECK ---

    const {
        elements,
        feedback_loops,
        summary,
        leverage_points
    } = data;


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="gist"> Gist & Elements</button>
        <button class="analysis-tab-btn" data-tab="loops"> Feedback Loops</button>
        <button class="analysis-tab-btn" data-tab="leverage"> Leverage Points & Interventions</button> <button class="analysis-tab-btn" data-tab="learn"> Learn Leverage Points</button> `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="gistPanel" class="analysis-tab-panel active"></div>
        <div id="loopsPanel" class="analysis-tab-panel"></div>
        <div id="leveragePanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div> `;

    // --- 1. Populate Gist & Elements Panel (Reusing logic from System Thinking) ---
    const gistPanel = $("gistPanel");
    let gistHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">System Overview</h3>`;
    gistHtml += `<blockquote class="p-4 italic border-l-4 border-gray-500 bg-black/20 text-white/90 mb-6 text-sm">"${summary}"</blockquote>`;
    gistHtml += `<h4 class="text-xl font-semibold mb-3">Key System Elements Identified</h4>`;
    gistHtml += `<div class="overflow-x-auto">
                    <table class="coeff-table styled-table text-sm">
                        <thead><tr><th>Element Name</th><th>Type</th><th>Description (Inferred Role)</th></tr></thead>
                        <tbody>`;
    elements.forEach(el => {
        let description = "";
        if (el.type === "Stock") description = "Accumulation over time";
        else if (el.type === "Flow") description = "Rate of change affecting a Stock";
        else if (el.type === "Variable") description = "Factor influencing Flows/Variables";
        else if (el.type === "Parameter") description = "Constant or policy";
        gistHtml += `<tr><td class="font-semibold">${el.name}</td><td class="font-mono text-xs">${el.type}</td><td class="text-white/70">${description}</td></tr>`;
    });
    gistHtml += `</tbody></table></div></div>`; // Close table div and p-4
    gistPanel.innerHTML = gistHtml;

    // --- 2. Populate Feedback Loops Panel (Reusing logic from System Thinking) ---
    const loopsPanel = $("loopsPanel");
    let loopsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Identified Feedback Loops</h3><div class="space-y-6">`;
    
    // --- START FIX ---
    // Check if feedback_loops is an array and has items
    if (feedback_loops && feedback_loops.length > 0) {
        feedback_loops.forEach((loop) => {
            // Safety checks for loop object and loop.type property
            const loopType = (loop && loop.type && typeof loop.type === 'string') ? loop.type.toLowerCase() : 'unknown';
            const isReinforcing = loopType === "reinforcing";
            const loopIcon = isReinforcing ? "" : "";
            const loopColor = isReinforcing ? "border-green-400" : "border-yellow-400";
            const loopTypeName = loop.type || 'Type N/A';
            const loopName = loop.name || loop.loop_name || 'Unnamed Loop';
            const elementsList = Array.isArray(loop.elements) ? loop.elements.join(", ") : 'Elements not specified';

            loopsHtml += `
                <div class="bg-black/20 p-4 rounded-lg border-l-4 ${loopColor}">
                    <h4 class="text-lg font-bold flex items-center gap-2">${loopIcon} ${loopName} <span class="text-xs font-light text-white/60">(${loopTypeName})</span></h4>
                    <p class="text-sm text-white/80 my-3 italic"><strong>Causal Chain:</strong> ${loop.description || 'No description.'}</p>
                    <div class="text-xs text-white/60"><strong>Key Elements Involved:</strong> ${elementsList}</div>
                </div>`;
        });
    } else {
        // This will now correctly trigger for NexaFlow-Capital.txt
        loopsHtml += `<p class="text-center text-white/70 italic">No feedback loops were identified. This is expected for descriptive profiles.</p>`;
    }
    // --- END FIX ---

    loopsHtml += `</div></div>`;
    loopsPanel.innerHTML = loopsHtml;

    // --- 3. Populate Leverage Points Panel (Updated for detailed interventions) ---
    const leveragePanel = $("leveragePanel");
    let leverageHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> High-Impact Leverage Points & Interventions</h3>`;
    if (leverage_points && leverage_points.length > 0) {
        leverageHtml += `<p class="text-sm text-white/70 mb-6 italic">These are ranked intervention points where actions can significantly shift system behavior, ordered from potentially highest to lowest impact based on system principles.</p>`;
        leverageHtml += `<div class="space-y-6">`;
        // Sort points based on High > Medium > Low impact rank for rendering
        const impactOrder = {
            "High": 1,
            "Medium": 2,
            "Low": 3
        };
        const sortedLeveragePoints = [...leverage_points].sort((a, b) => {
            const rankA = impactOrder[a.potential_impact_rank?.split(" ")[0]] || 4; // Default to lowest if rank missing
            const rankB = impactOrder[b.potential_impact_rank?.split(" ")[0]] || 4;
            return rankA - rankB;
        });

        sortedLeveragePoints.forEach((point, index) => {
            let borderColor = "border-indigo-400"; // Default
            if (point.potential_impact_rank?.startsWith("High")) borderColor = "border-red-500";
            else if (point.potential_impact_rank?.startsWith("Medium")) borderColor = "border-yellow-500";
            else if (point.potential_impact_rank?.startsWith("Low")) borderColor = "border-blue-500";

            leverageHtml += `
                <div class="prescription-card ${borderColor}">
                     <h4 class="text-xl font-bold">${index + 1}. ${point.point_name}</h4>
                     <p class="text-xs font-semibold my-1 ${borderColor.replace('border-', 'text-')}">${point.potential_impact_rank || 'Impact Undefined'}</p>
                     <p class="text-xs font-semibold my-1 text-white/70">TARGET: ${point.target_element_or_loop || 'N/A'}</p>
                     <p class="rationale mt-3"><strong>Proposed Intervention:</strong> ${point.intervention || 'N/A'}</p>
                     <p class="text-sm text-white/80 mt-2 italic"><strong>System Rationale:</strong> ${point.rationale || 'N/A'}</p>
                     <div class="p-3 bg-black/20 rounded mt-3 text-sm">
                         <p><strong>Expected Outcome:</strong> ${point.expected_outcome || 'N/A'}</p>
                     </div>
                </div>`;
        });
        leverageHtml += `</div>`;
    } else {
        leverageHtml += `<p class="text-center text-white/70 italic">No specific leverage points were clearly identified from the provided system description.</p>`;
    }
    leverageHtml += `</div>`; // Close p-4
    leveragePanel.innerHTML = leverageHtml;


    // --- 4. Populate Learn Leverage Points Panel (New) ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Leverage Points</h3>
         
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What are Leverage Points?</h4>
            <p class="text-sm text-white/80">Popularized by Donella Meadows, leverage points are places within a complex system where a small shift in one thing can produce big changes in everything. Intervening at higher leverage points is often more effective, though potentially harder, than intervening at lower ones.</p>
        </div>

        <h4 class="text-xl font-semibold mt-4 mb-2 text-center">Meadows' 12 Places to Intervene (Simplified & Ranked Low to High Impact):</h4>
        <div class="overflow-x-auto">
             <table class="coeff-table styled-table text-sm">
                 <thead><tr><th>#</th><th>Leverage Point Type</th><th>Example Intervention</th><th>Impact Potential</th></tr></thead>
                 <tbody>
                     <tr><td>12</td><td><strong>Constants, Parameters, Numbers</strong></td><td>Adjusting budgets, staff levels, thresholds</td><td>Low</td></tr>
                     <tr><td>11</td><td><strong>Sizes of Buffers/Stocks</strong></td><td>Increasing inventory, server capacity</td><td>Low</td></tr>
                     <tr><td>10</td><td><strong>Structure of Material Stocks/Flows</strong></td><td>Changing physical layout, supply chain routes</td><td>Low-Medium</td></tr>
                     <tr><td>9</td><td><strong>Lengths of Delays</strong></td><td>Reducing response times, speeding up feedback</td><td>Medium</td></tr>
                     <tr><td>8</td><td><strong>Strength of Balancing Feedback Loops</strong></td><td>Implementing quality controls, regulations</td><td>Medium</td></tr>
                     <tr><td>7</td><td><strong>Strength of Reinforcing Feedback Loops</strong></td><td>Boosting marketing for word-of-mouth, R&D investment</td><td>Medium-High</td></tr>
                     <tr><td>6</td><td><strong>Structure of Information Flows</strong></td><td>Improving transparency, communication channels</td><td>Medium-High</td></tr>
                     <tr><td>5</td><td><strong>Rules of the System</strong></td><td>Changing incentives, policies, regulations</td><td>High</td></tr>
                     <tr><td>4</td><td><strong>Power to Add/Change System Structure</strong></td><td>Creating new departments, feedback loops</td><td>High</td></tr>
                     <tr><td>3</td><td><strong>Goals of the System</strong></td><td>Shifting focus from profit to sustainability, speed to quality</td><td>High</td></tr>
                     <tr><td>2</td><td><strong>Mindset or Paradigm</strong></td><td>Changing core beliefs/values (e.g., growth vs. stability)</td><td>Very High</td></tr>
                     <tr><td>1</td><td><strong>Power to Transcend Paradigms</strong></td><td>Realizing no single paradigm is complete</td><td>Highest</td></tr>
                 </tbody>
             </table>
        </div>

         <div class="bg-white/5 p-4 rounded-lg mt-6 border border-white/10">
            <h4 class="text-lg font-bold mb-2">How This Tool Applies It:</h4>
            <p class="text-sm text-white/80">This tool analyzes your text to see if it's a dynamic problem or a descriptive profile.
            <br>
            - If it's a <strong>problem</strong>, it finds loops and suggests interventions to *fix* them, ranking them by this hierarchy.
            <br>
            - If it's a <strong>profile</strong> (like NexaFlow), it identifies your core differentiators as high-leverage points to *amplify*.
            </p>
        </div>
    </div>
    `;

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
            } else {
                console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}

/**
 * HANDLER: System Thinking Analysis
 * - NEW (v5 - Comprehensive Mapping): Uses a highly detailed prompt to extract
 *   a rich, structured model of the system including variables, relationships,
 *   archetypes, leverage points, and strategic context. This provides a much
 *   deeper analysis than previous versions.
 */
async function handleSystemThinkingAnalysis() {
    const analysisResultContainer = $("analysisResult");
    analysisResultContainer.innerHTML = `
        <div class="text-center text-white/70 p-8">
            <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class.typing-dot"></div> </div>
            <h3 class="text-xl font-semibold text-white mb-4">Performing Comprehensive System Analysis...</h3>
            <p class="text-white/80 mb-2">This deep analysis may take a moment. Extracting variables, relationships, and archetypes...</p>
        </div>`;
    setLoading("generate", true);

    const provider = "ollama" //$("providerSelect").value;
    const analysisType = "(Systems Thinking)";
    let text = "";
    
    try {
        // 1. Gather Inputs
        const useDoc = document.querySelector('input[name="inputType"]:checked').id === "docUpload";
        if (useDoc) {
            const file = $("systemFile").files[0];
            if (!file) throw new Error("Please select a document to upload.");
            text = await extractTextFromFile(file);
        } else {
            text = $("systemContent").value.trim();
            if (!text.trim()) throw new Error("Please describe the system.");
        }

        // --- NEW: INJECT LOCATION ---
            const location = $("systemLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
                console.log("Injected location into System Thinking prompt:", location);
            }

        // 2. --- STEP 2: Run the new Comprehensive Analysis Prompt ---
        analysisResultContainer.querySelector("p").textContent = "Running comprehensive system mapping...";
        
        // This new prompt a bit more detailed, asking for a full system map.
        const systemPrompt = `You are an expert systems analyst trained in causal mapping, Donella Meadows' leverage points, and Peter Senge's system archetypes.
            **TASK 0: GIBBERISH DETECTION**
            Check the User Text. If it is gibberish or nonsense, you MUST return the "INVALID" JSON structure below.

            **CRITICAL INSTRUCTIONS:**
                1. Read the ENTIRE user-provided context carefully. 
                2. Extract 15-25 key variables (not just 5-8!).
                3. Identify ALL causal relationships mentioned or implied.
                4. Look for feedback loops explicitly.
                5. Identify system archetypes (Success to Successful, Limits to Growth, Shifting the Burden, etc.).
                6. Assign leverage levels based on Meadows' framework.
                7. **Self-Correction:** Before outputting JSON, rigorously check: Is the JSON structure perfect? Fix all errors, if present.

            **DETAILED TASKS:**
                STEP 1 - VARIABLE EXTRACTION:
                Identify 15-25 variables. For each, determine:
                - name (clear, specific)
                - description (what it represents)
                - type: "driver" (causes other things), "outcome" (result of other things), "constraint" (limits), "resource" (stock/capacity)
                - leverage_level (1-12, where 1=paradigm shift, 3=goals, 5=rules, 7=feedback gain, 9=delays, 12=parameters)

                STEP 2 - RELATIONSHIP MAPPING:
                For EVERY cause-effect relationship in the document:
                - Identify source and target variables ("from", "to")
                - Determine polarity: "+" (same direction) or "-" (opposite direction)
                - Assess strength: "strong" (explicit, direct), "medium" (mentioned), "weak" (implied)
                - Note evidence: quote or reference from text
                - Estimate delay: "immediate" (<1 month), "short" (1-6 months), "medium" (6-12 months), "long" (>1 year)

                STEP 3 - FEEDBACK LOOP IDENTIFICATION:
                Look for circular causation patterns:
                - type: "reinforcing" (growth/decline spirals) or "balancing" (goal-seeking, regulation)
                - variables: list of variables involved
                - description: explain the dynamic behavior of the loop

                STEP 4 - SYSTEM ARCHETYPES:
                Check for these patterns:
                1. Success to the Successful, 2. Limits to Growth, 3. Shifting the Burden, 4. Eroding Goals, 5. Escalation, 6. Tragedy of the Commons, 7. Fixes that Fail, 8. Growth and Underinvestment

                STEP 5 - STRATEGIC ANALYSIS:
                - goals: What objectives are stated or implied?
                - stakeholders: Who is mentioned or affected?
                - constraints: What limits are mentioned?
                - assumptions: What beliefs underpin the logic?
                - missing_factors: What important variables are NOT mentioned but should be?
                - second_order_effects: What delayed consequences are discussed?

            **ABSOLUTE CONSTRAINTS:**
                - EXTRACT AT LEAST 15 CONCEPTS AND 20 RELATIONSHIPS. Be thorough and comprehensive.
                - **JSON FORMAT:** Adhere EXACTLY. Include ALL specified keys and sub-keys.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object. **CRITICAL: Include ALL keys specified below.**
            ---
            {
              "concepts": [
                {
                  "name": "Customer Satisfaction",
                  "description": "degree of customer happiness with product/service",
                  "type": "outcome",
                  "leverage_level": 8
                }
              ],
              "relationships": [
                {
                  "from": "Product Quality",
                  "to": "Customer Satisfaction",
                  "polarity": "+",
                  "strength": "strong",
                  "evidence": "higher quality leads to more satisfied customers",
                  "delay": "short"
                }
              ],
              "goals": ["Increase market share", "Improve profitability"],
              "stakeholders": ["Customers", "Employees", "Investors", "Suppliers"],
              "constraints": ["Limited budget", "Regulatory compliance", "Time constraints"],
              "assumptions": ["Customers value quality over price", "Market will continue to grow"],
              "missing_factors": ["Competitor actions", "Economic conditions", "Technology disruption"],
              "leverage_points": [
                {
                  "level": 3,
                  "type": "System Goals",
                  "description": "Organization optimizing for wrong metrics - focusing on growth instead of sustainability",
                  "impact": "high",
                  "recommendation": "Redefine success metrics to include long-term resilience"
                }
              ],
              "second_order_effects": [
                {
                  "action": "Cut prices to increase sales",
                  "immediate": "Sales volume increases",
                  "delayed": "Brand perception as 'cheap' erodes premium positioning",
                  "timeline": "6-12 months"
                }
              ],
              "archetypes": [
                {
                  "name": "Limits to Growth",
                  "description": "Rapid growth eventually hits capacity constraints, slowing expansion",
                  "nodes_involved": ["Sales Growth", "Production Capacity", "Quality"],
                  "dynamic": "Initial success leads to resource strain"
                }
              ],
              "feedback_loops": [
                {
                  "type": "reinforcing",
                  "variables": ["Product Quality", "Customer Satisfaction", "Revenue", "Investment in Quality"],
                  "description": "Better quality -> happier customers -> more revenue -> more investment in quality"
                }
              ]
            }
            ---
        `;

        const userContext = `**USER'S PROVIDED CONTEXT:**
            ---
            ${text}
            ---
        `;

        const jsonSchema = {
            "type": "json_schema",
            "schema": {
            "type": "object",
            "properties": {
                "concepts": {
                "type": "array",
                "description": "A list of 15-25 key variables/concepts extracted from the document.",
                "items": {
                    "type": "object",
                    "properties": {
                    "name": { "type": "string", "description": "Clear, specific name of the variable." },
                    "description": { "type": "string", "description": "What the variable represents." },
                    "type": { "type": "string", "enum": ["driver", "outcome", "constraint", "resource"], "description": "Variable type: driver, outcome, constraint, or resource." },
                    "leverage_level": { "type": "integer", "description": "Meadows' leverage level (1-12)." }
                    },
                    "required": ["name", "description", "type", "leverage_level"]
                }
                },
                "relationships": {
                "type": "array",
                "description": "A list of causal relationships between the concepts.",
                "items": {
                    "type": "object",
                    "properties": {
                    "from": { "type": "string", "description": "Name of the source variable." },
                    "to": { "type": "string", "description": "Name of the target variable." },
                    "polarity": { "type": "string", "enum": ["+", "-"], "description": "Causal polarity: '+' for same direction, '-' for opposite." },
                    "strength": { "type": "string", "enum": ["strong", "medium", "weak"], "description": "Causal strength." },
                    "evidence": { "type": "string", "description": "Quote or reference from the text." },
                    "delay": { "type": "string", "enum": ["immediate", "short", "medium", "long"], "description": "Estimated time delay of the effect." }
                    },
                    "required": ["from", "to", "polarity", "strength", "evidence", "delay"]
                }
                },
                "goals": { "type": "array", "items": { "type": "string" }, "description": "Stated or implied objectives." },
                "stakeholders": { "type": "array", "items": { "type": "string" }, "description": "People or groups affected." },
                "constraints": { "type": "array", "items": { "type": "string" }, "description": "Limits mentioned in the document." },
                "assumptions": { "type": "array", "items": { "type": "string" }, "description": "Beliefs underpinning the logic." },
                "missing_factors": { "type": "array", "items": { "type": "string" }, "description": "Important variables NOT mentioned." },
                "leverage_points": {
                "type": "array",
                "description": "Specific high-leverage intervention points based on Meadows' framework.",
                "items": {
                    "type": "object",
                    "properties": {
                    "level": { "type": "integer", "description": "Meadows' leverage level (1-12)." },
                    "type": { "type": "string", "description": "General type of leverage point (e.g., System Goals, Rules)." },
                    "description": { "type": "string", "description": "Explanation of the leverage point." },
                    "impact": { "type": "string", "enum": ["high", "medium", "low"] },
                    "recommendation": { "type": "string", "description": "Actionable recommendation." }
                    },
                    "required": ["level", "type", "description", "impact", "recommendation"]
                }
                },
                "second_order_effects": {
                "type": "array",
                "description": "Delayed consequences of actions discussed.",
                "items": {
                    "type": "object",
                    "properties": {
                    "action": { "type": "string" },
                    "immediate": { "type": "string" },
                    "delayed": { "type": "string" },
                    "timeline": { "type": "string" }
                    },
                    "required": ["action", "immediate", "delayed", "timeline"]
                }
                },
                "archetypes": {
                "type": "array",
                "description": "Identified Peter Senge system archetypes.",
                "items": {
                    "type": "object",
                    "properties": {
                    "name": { "type": "string", "description": "Name of the archetype (e.g., Limits to Growth)." },
                    "description": { "type": "string" },
                    "nodes_involved": { "type": "array", "items": { "type": "string" }, "description": "List of concepts involved." },
                    "dynamic": { "type": "string", "description": "Brief explanation of the dynamic." }
                    },
                    "required": ["name", "description", "nodes_involved", "dynamic"]
                }
                },
                "feedback_loops": {
                "type": "array",
                "description": "Identified circular causation patterns (reinforcing/balancing).",
                "items": {
                    "type": "object",
                    "properties": {
                    "type": { "type": "string", "enum": ["reinforcing", "balancing"] },
                    "variables": { "type": "array", "items": { "type": "string" }, "description": "List of variables in the loop." },
                    "description": { "type": "string", "description": "Explanation of the loop's behavior." }
                    },
                    "required": ["type", "variables", "description"]
                }
                }
            },
            "required": ["concepts", "relationships", "goals", "stakeholders", "constraints", "assumptions", "missing_factors", "leverage_points", "second_order_effects", "archetypes", "feedback_loops"]
            }
        };
        
        // Send the analysis system prompt and user prompt.
        const finalParsedData = await fetchLLM(provider, systemPrompt, userContext, jsonSchema, analysisType);
        
        // 4. --- STEP 3: Render ---
        analysisResultContainer.querySelector("p").textContent = "Assembling comprehensive analysis...";
        
        // *** NEW validation for the comprehensive data structure ***
        if (!finalParsedData || !Array.isArray(finalParsedData.concepts) || finalParsedData.concepts.length < 5 ||
            !Array.isArray(finalParsedData.relationships) || finalParsedData.relationships.length < 5 ||
            !Array.isArray(finalParsedData.archetypes)
           ) {
             console.error("Validation Failed (Comprehensive Handler): Final analysis data is missing key components or has too few items.", finalParsedData);
             throw new Error("AI response was incomplete or malformed. It must include at least 5 concepts and 5 relationships.");
        }
        
        console.log("Successfully parsed comprehensive analysis JSON:", finalParsedData);

        // 5. Render Results
        renderSystemThinkingPage(analysisResultContainer, finalParsedData); // Call the flexible renderer

    } catch (error) {
        console.error(`Error in handleSystemThinkingAnalysis (Comprehensive v5):`, error);
        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
        setLoading("generate", false);
    } finally {
        if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
            setLoading("generate", false);
        }
    }
}

    /**
 * Handles the PLS-SEM analysis request to the backend.
 * Reads from the advanced UI (file/text toggle, syntax boxes).
 */
async function handlePlsAnalysis_DA() {
        const analysisResultContainer = $("analysisResult"); 
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><h3 class="text-xl font-semibold text-white">Running PLS-SEM Analysis...</h3><p class="text-white/80 mb-2">Please wait while the model is estimated.</p></div>`;
        setLoading("generate", true); 

        try {
            const formData = new FormData();
            formData.append("data_file", window.tempSampleDataFile, window.tempSampleDataFile.name);

            let measurementSyntax, structuralSyntax;

            if (window.isSampleModeActive === true) {
                // --- SAMPLE MODE ---
                // HARDCODE the syntax as requested
                measurementSyntax = "Quality =~ qual1 + qual2 + qual3\nSatisfaction =~ sat1 + sat2 + sat3\nLoyalty =~ loy1 + loy2 + loy3";
                structuralSyntax = "Satisfaction ~ Quality\nLoyalty ~ Satisfaction + Quality";
                
                console.log(" Using measurement syntax:", measurementSyntax);
                console.log(" Using structural syntax:", structuralSyntax);

                const dataFile = await fetchFileAsObject('pls/pls-sample-data.csv');
                if (!dataFile) throw new Error("Sample file not found.");
                formData.append("data_file", dataFile, dataFile.name);
            } else {
                // --- MANUAL MODE ---
                // READ syntax from UI
                measurementSyntax = $("plsMeasurementSyntax").value.trim();
                structuralSyntax = $("plsStructuralSyntax").value.trim();

                const dataFile = $("plsFile").files[0]; 
                const dataText = $("plsDataText").value.trim(); 
                const isUsingFile = $("plsInputFileToggle").checked; 

                if (isUsingFile) { 
                    if (!dataFile) {
                        throw new Error("Please upload a data file (.csv or .xlsx).");
                    }
                    formData.append("data_file", dataFile, dataFile.name);
                } else {
                    if (!dataText) {
                        throw new Error("Please paste your CSV data into the text area.");
                    }
                    formData.append("data_text", dataText);
                }
            }

            // Validate syntax
            if (!measurementSyntax && !structuralSyntax) {
                throw new Error("Please provide Measurement Model Syntax and/or Structural Model Syntax.");
            }
            formData.append("measurement_syntax", measurementSyntax);
            formData.append("structural_syntax", structuralSyntax);

            // --- 4. Send Request to Backend API ---
            const API_URL = "https://analysis.sageaios.com/api/pls"; 
            const response = await fetch(API_URL, {
                method: "POST",
                body: formData,
            });

            // --- 5. Handle Backend Response ---
            if (!response.ok) {
                let errorDetail = `API request failed (${response.status})`;
                try {
                    const errorJson = await response.json(); 
                    errorDetail += `: ${errorJson.detail || JSON.stringify(errorJson)}`; 
                } catch (e) {
                    try { errorDetail += `: ${await response.text()}`; } catch (readErr) {} 
                }
                throw new Error(errorDetail); 
            }

            const parsedData = await response.json(); 
            renderPlsPage_DA(analysisResultContainer, parsedData);

        } catch (error) { 
            console.error("Error during PLS-SEM analysis:", error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"><strong>Error:</strong> ${error.message}</div>`;
        } finally {
            window.isSampleModeActive = false; // Reset the flag
            setLoading("generate", false);
        }
    }

/**
 * RENDERER: PLS-SEM (v7 - 3-Tab Focused Version)
 * - Renders a 3-tab interface: "Path Model", "Measurement Model Assessment", "Learn PLS-SEM".
 * - Calls a new helper `renderPlsMeasurementTab` to populate the new tab.
 * - This version implements the user's "Critical Priority 9/10" request.
 */
function renderPlsPage_DA(container, data) {
    container.innerHTML = ""; // Clear loading

    // --- Enhanced Validation (still important) ---
    if (!data || !data.model_evaluation || !data.path_coefficients || !data.reliability_validity || !data.business_recommendations || !data.userInput ||
        !data.discriminant_validity_htmt || !data.discriminant_validity_fornell_larcker) {
        console.error("Incomplete data passed to renderPlsPage_DA (v7):", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. The backend is missing required fields like 'discriminant_validity_htmt' or 'model_evaluation'.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    const {
        model_evaluation,
        path_coefficients,
        reliability_validity,
        business_recommendations,
        userInput,
        discriminant_validity_htmt,
        discriminant_validity_fornell_larcker,
        path_diagram // This is an HTML string with an <img> tag
    } = data;
    const constructNames = reliability_validity.map(c => c.construct);

    // --- 3-Tab Navigation ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="diagram"> Path Model</button>
        <button class="analysis-tab-btn" data-tab="measurement"> Measurement Model</button>
        <button class="analysis-tab-btn" data-tab="structural"> Structural Results</button>
        <button class="analysis-tab-btn" data-tab="diagnostics"> Model Diagnostics</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn PLS-SEM</button>
    `;
    container.appendChild(tabNav);

    // --- 3-Tab Panels ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="diagramPanel" class="analysis-tab-panel active"></div>
        <div id="measurementPanel" class="analysis-tab-panel"></div>
        <div id="structuralPanel" class="analysis-tab-panel"></div>
        <div id="diagnosticsPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Path Diagram Panel ---
    const diagramPanel = $("diagramPanel");
    if (data.diagram_available && data.path_diagram) {
        diagramPanel.innerHTML = data.path_diagram;
        console.log(" Rendering backend-generated PNG diagram.");
        
        // Add error handling just in case
        setTimeout(() => {
            const imgElement = diagramPanel.querySelector('img');
            if (imgElement) {
                imgElement.addEventListener('error', (e) => {
                    console.warn('PNG diagram image failed to load:', e);
                    diagramPanel.innerHTML = `
                        <div class="p-4 text-center text-yellow-400">
                            <p> Diagram image failed to load.</p>
                            <p class="text-xs text-white/60">The backend data may be corrupted.</p>
                        </div>`;
                });
            } else if (!diagramPanel.innerHTML.includes("img")) {
                 console.warn("Diagram content loaded, but no <img> tag was found.");
                 diagramPanel.innerHTML = `
                        <div class="p-4 text-center text-yellow-400">
                            <p> Diagram content loaded, but no <img> tag was found.</p>
                            <p class="text-xs text-white/60">Backend may not have returned a valid image.</p>
                        </div>`;
            }
        }, 500); 
    } else {
        console.log(" Graphviz diagram not available (diagram_available=false or path_diagram=null).");
        diagramPanel.innerHTML = `<div class="p-4 text-center text-white/60">Path diagram data is not available. The backend did not provide a graph.</div>`;
    }

    // --- 2. Populate NEW Measurement Model Panel ---
    const measurementPanel = $("measurementPanel");
    // Call the new helper function
    measurementPanel.innerHTML = renderPlsMeasurementTab(
        reliability_validity,
        discriminant_validity_htmt,
        discriminant_validity_fornell_larcker,
        data.outer_loadings_json // This will be undefined, but we pass it anyway
    );

    // --- 3. Populate NEW Structural Results Panel ---
    const structuralPanel = $("structuralPanel");
    structuralPanel.innerHTML = renderPlsStructuralTab(
        data.path_coefficients,
        data.model_evaluation,
        data.userInput,
        data.bootstrap_results
    );

    // --- 4. Populate NEW Model Diagnostics Panel ---
    const diagnosticsPanel = $("diagnosticsPanel");
    diagnosticsPanel.innerHTML = renderPlsDiagnosticsTab(
        data.data_summary,
        data.model_evaluation,
        data.reliability_validity,
        data.path_coefficients,
        data.bootstrap_results
    );

    // --- 5. Populate Learn PLS-SEM Tab (Enhanced Version) ---
const learnPanel = $("learnPanel");
learnPanel.innerHTML = `
<div class="p-6 space-y-6 text-white/90">
    <h3 class="text-2xl font-bold text-center mb-4"> Understanding PLS-SEM</h3>
    
    <!-- When to Use PLS-SEM vs Alternatives -->
    <div class="bg-black/20 p-4 rounded-lg border border-blue-500/30">
        <h4 class="text-lg font-bold mb-3 text-blue-300"> When to Use PLS-SEM vs. Alternatives</h4>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-green-900/20 p-3 rounded border border-green-500/30">
                <h5 class="font-bold text-green-300 mb-2"> Use PLS-SEM When:</h5>
                <ul class="text-sm space-y-1">
                    <li> <strong>Exploratory research:</strong> Testing new theories or relationships</li>
                    <li> <strong>Complex models:</strong> Many constructs (5+) and indicators (20+)</li>
                    <li> <strong>Prediction focus:</strong> Goal is predicting key outcomes</li>
                    <li> <strong>Small samples:</strong> Less than 200 observations</li>
                    <li> <strong>Non-normal data:</strong> Skewed or non-parametric distributions</li>
                    <li> <strong>Formative measures:</strong> Indicators cause the construct</li>
                </ul>
            </div>
            
            <div class="bg-red-900/20 p-3 rounded border border-red-500/30">
                <h5 class="font-bold text-red-300 mb-2"> Use CB-SEM Instead When:</h5>
                <ul class="text-sm space-y-1">
                    <li> <strong>Theory testing:</strong> Confirming well-established models</li>
                    <li> <strong>Model comparison:</strong> Testing competing theoretical models</li>
                    <li> <strong>Global fit focus:</strong> Need overall model fit indices</li>
                    <li> <strong>Large samples:</strong> 300+ observations available</li>
                    <li> <strong>Normal data:</strong> Multivariate normality assumptions met</li>
                    <li> <strong>Simple models:</strong> Few constructs, well-established measures</li>
                </ul>
            </div>
        </div>
        
        <div class="mt-4 p-3 bg-yellow-900/20 rounded border border-yellow-500/30">
            <h5 class="font-bold text-yellow-300 mb-2"> Other Alternatives:</h5>
            <div class="text-sm grid grid-cols-1 md:grid-cols-2 gap-2">
                <div><strong>Multiple Regression:</strong> Single outcome, linear relationships</div>
                <div><strong>Factor Analysis:</strong> Just measurement model validation</div>
                <div><strong>Path Analysis:</strong> Observed variables only, no latents</div>
                <div><strong>Machine Learning:</strong> Pure prediction, no theory testing</div>
            </div>
        </div>
    </div>
    
    <!-- Practical Model Specification Tips -->
    <div class="bg-black/20 p-4 rounded-lg border border-purple-500/30">
        <h4 class="text-lg font-bold mb-3 text-purple-300"> Practical Model Specification Tips</h4>
        
        <div class="space-y-4">
            <div class="bg-white/5 p-3 rounded">
                <h5 class="font-semibold text-white mb-2"> Measurement Model Best Practices:</h5>
                <ul class="text-sm space-y-1 text-white/80">
                    <li> <strong>3+ indicators per construct:</strong> Minimum for identification</li>
                    <li> <strong>Avoid single-item measures:</strong> Unless unavoidable (e.g., age)</li>
                    <li> <strong>Similar response scales:</strong> Mix of Likert scales can cause issues</li>
                    <li> <strong>Clear wording:</strong> Avoid double-barreled or complex items</li>
                    <li> <strong>Balanced scales:</strong> Include both positive and negative items when possible</li>
                </ul>
            </div>
            
            <div class="bg-white/5 p-3 rounded">
                <h5 class="font-semibold text-white mb-2"> Structural Model Design:</h5>
                <ul class="text-sm space-y-1 text-white/80">
                    <li> <strong>Theoretical justification:</strong> Every path should have literature support</li>
                    <li> <strong>Avoid kitchen sink models:</strong> Include only theoretically relevant constructs</li>
                    <li> <strong>Consider mediation:</strong> Test indirect effects when theoretically meaningful</li>
                    <li> <strong>Control variables:</strong> Include demographic or contextual controls</li>
                    <li> <strong>Alternative models:</strong> Test competing theoretical explanations</li>
                </ul>
            </div>
            
            <div class="bg-white/5 p-3 rounded">
                <h5 class="font-semibold text-white mb-2"> Common Specification Errors:</h5>
                <ul class="text-sm space-y-1 text-white/80">
                    <li> <strong>Reflective vs. Formative confusion:</strong> Most constructs are reflective</li>
                    <li> <strong>Multicollinearity:</strong> Highly correlated predictors (r > 0.9)</li>
                    <li> <strong>Missing pathways:</strong> Omitting theoretically important relationships</li>
                    <li> <strong>Cross-loadings:</strong> Indicators loading on multiple constructs</li>
                    <li> <strong>Endogeneity:</strong> Ignoring reverse causation possibilities</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Interpretation Guide -->
    <div class="bg-black/20 p-4 rounded-lg border border-green-500/30">
        <h4 class="text-lg font-bold mb-3 text-green-300"> Practical Interpretation Guidelines</h4>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="space-y-3">
                <div>
                    <h5 class="font-semibold mb-2">Effect Sizes (Cohen's Guidelines)</h5>
                    <div class="text-sm space-y-1 text-white/80">
                        <div><strong>Path Coefficients ():</strong></div>
                        <div class="ml-4"> Small: |0.10| - |0.29|</div>
                        <div class="ml-4"> Medium: |0.30| - |0.49|</div> 
                        <div class="ml-4"> Large: |0.50|+</div>
                    </div>
                </div>
                
                <div>
                    <h5 class="font-semibold mb-2">R Interpretation</h5>
                    <div class="text-sm space-y-1 text-white/80">
                        <div> <strong>0.75+:</strong> Substantial (excellent)</div>
                        <div> <strong>0.50-0.74:</strong> Moderate (good)</div>
                        <div> <strong>0.25-0.49:</strong> Weak (acceptable)</div>
                        <div> <strong>&lt;0.25:</strong> Very weak (concerning)</div>
                    </div>
                </div>
                
                <div>
                    <h5 class="font-semibold mb-2">Statistical Significance</h5>
                    <div class="text-sm space-y-1 text-white/80">
                        <div> <strong>p &lt; 0.001:</strong> *** (highly significant)</div>
                        <div> <strong>p &lt; 0.01:</strong> ** (very significant)</div>
                        <div> <strong>p &lt; 0.05:</strong> * (significant)</div>
                        <div> <strong>p  0.05:</strong> Not significant</div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <div>
                    <h5 class="font-semibold mb-2">Reporting Best Practices</h5>
                    <ul class="text-sm space-y-1 text-white/80">
                        <li> Report both  and p-values for all paths</li>
                        <li> Include confidence intervals when available</li>
                        <li> Discuss practical vs. statistical significance</li>
                        <li> Address alternative explanations</li>
                        <li> Acknowledge model limitations</li>
                    </ul>
                </div>
                
                <div>
                    <h5 class="font-semibold mb-2">Sample Size Guidelines</h5>
                    <div class="text-sm space-y-1 text-white/80">
                        <div><strong>Minimum rules:</strong></div>
                        <div class="ml-4"> 5-10 cases per indicator</div>
                        <div class="ml-4"> 10 times largest # of indicators</div>
                        <div class="ml-4"> Absolute minimum: 50 cases</div>
                        <div class="ml-4"> Recommended: 100+ cases</div>
                    </div>
                </div>
                
                <div>
                    <h5 class="font-semibold mb-2">Validation Strategies</h5>
                    <ul class="text-sm space-y-1 text-white/80">
                        <li> Split-sample validation (if N > 200)</li>
                        <li> Cross-industry replication</li>
                        <li> Temporal stability testing</li>
                        <li> Alternative model comparison</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- What is PLS-SEM (Condensed) -->
    <div class="bg-white/5 p-4 rounded-lg border border-white/10">
        <h4 class="text-lg font-bold mb-2 text-indigo-300">What is PLS-SEM?</h4>
        <p class="text-sm text-white/80">Partial Least Squares Structural Equation Modeling (PLS-SEM) is a statistical method for testing complex cause-and-effect relationships between observed and latent variables. Unlike traditional regression, it can handle multiple dependent variables, indirect effects, and measurement error simultaneously.</p>
    </div>
    
    <details class="styled-details text-sm">
        <summary class="font-semibold cursor-pointer hover:text-blue-300"> Additional Resources & Further Reading</summary>
        <div class="bg-black/20 p-4 rounded-b-lg space-y-2 text-white/80">
            <div><strong>Key Books:</strong></div>
            <ul class="ml-4 space-y-1 text-sm">
                <li> Hair et al. (2021) - A Primer on Partial Least Squares SEM (4th ed.)</li>
                <li> Sarstedt & Ringle (2020) - Partial Least Squares SEM using SmartPLS</li>
                <li> Henseler et al. (2016) - Handbook of PLS-SEM</li>
            </ul>
            <div class="mt-3"><strong>Software Alternatives:</strong></div>
            <ul class="ml-4 space-y-1 text-sm">
                <li> SmartPLS (Commercial, user-friendly GUI)</li>
                <li> R packages: semPLS, plspm, SEMinR</li>
                <li> Python: plspm, scikit-learn PLS</li>
            </ul>
        </div>
    </details>
</div>
`;

    // --- Tab Switching Logic ---
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
            } else {
                console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Final Setup ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result
    $("analysisActions").classList.remove("hidden"); // Show save buttons
}

/**
 * --- UPDATED HELPER FUNCTION (v2) ---
 * Renders the new "Measurement Model Assessment" tab content.
 * - FIX: Now reads `data.outer_loadings_json` to build the Factor Loadings table.
 * @param {object} reliability_validity - Data for the reliability table.
 * @param {object} htmt_data - Data for the HTMT matrix.
 * @param {object} fornell_larcker_data - Data for the Fornell-Larcker matrix.
 * @param {object} outer_loadings_data - The new JSON-friendly object.
 * @returns {string} HTML string for the tab
 */
function renderPlsMeasurementTab(reliability_validity, htmt_data, fornell_larcker_data, outer_loadings_data) {
    let html = `<div class="p-4 space-y-8">`;
    let reliabilityHtml = "";
    let validityHtml = "";
    let loadingsHtml = "";

    // --- 1. Reliability Section (Unchanged) ---
    if (reliability_validity && reliability_validity.length > 0) {
        reliabilityHtml = `
            <h3 class="text-2xl font-bold mb-3">Construct Reliability & Convergent Validity</h3>
            <div class="overflow-x-auto">
                <table class="coeff-table styled-table text-sm">
                    <thead>
                        <tr>
                            <th>Construct</th>
                            <th title="Internal Consistency Reliability">Cronbach's Alpha (>0.7)</th>
                            <th title="Internal Consistency Reliability">Composite Reliability (CR >0.7)</th>
                            <th title="Convergent Validity">Avg. Variance Extracted (AVE >0.5)</th>
                        </tr>
                    </thead>
                    <tbody>`;
        reliability_validity.forEach((r) => {
            const alphaOk = (r.cronbachs_alpha ?? 0) >= 0.7;
            const crOk = (r.composite_reliability ?? 0) >= 0.7;
            const aveOk = (r.ave ?? 0) >= 0.5;
            const crClass = crOk ? 'text-green-300' : 'text-red-300 font-bold'; // Highlight bad CR
            
            reliabilityHtml += `
                <tr>
                    <td class="font-semibold">${r.construct || "N/A"}</td>
                    <td class="${alphaOk ? 'text-green-300' : 'text-red-300'}">${(r.cronbachs_alpha ?? 0).toFixed(3)} ${alphaOk ? '' : ''}</td>
                    <td class="${crClass}">${(r.composite_reliability ?? 0).toFixed(3)} ${crOk ? '' : ''}</td>
                    <td class="${aveOk ? 'text-green-300' : 'text-red-300'}">${(r.ave ?? 0).toFixed(3)} ${aveOk ? '' : ''}</td>
                </tr>`;
        });
        reliabilityHtml += `</tbody></table>
            <p class="text-xs text-white/60 mt-2"> Meets common threshold,  Below common threshold.</p>
        </div>`;
    } else {
        reliabilityHtml = `<p class="text-white/60">Reliability data is not available.</p>`;
    }

    // --- 2. Factor Loadings Section (NOW READS JSON) ---
    loadingsHtml = `<h3 class="text-2xl font-bold mb-3 mt-8">Factor Loadings (Outer Model)</h3>`;
    if (outer_loadings_data && outer_loadings_data.headers && outer_loadings_data.rows) {
        loadingsHtml += `<p class="text-sm text-white/70 mb-4 italic">Shows how strongly each indicator (item) loads onto its construct. Loadings **> 0.7** are ideal. Loadings **< 0.4** (red) should be considered for removal.</p>`;
        loadingsHtml += `<div class="overflow-x-auto">
                        <table class="coeff-table styled-table text-sm">
                        <thead><tr><th>Indicator</th>`;
        
        const headers = outer_loadings_data.headers;
        headers.forEach(h => { loadingsHtml += `<th>${h}</th>`; });
        loadingsHtml += `</tr></thead><tbody>`;

        outer_loadings_data.rows.forEach(row => {
            loadingsHtml += `<tr><td class="font-semibold">${row.indicator}</td>`;
            headers.forEach(h => {
                const val = row[h];
                let cellHtml = 'N/A';
                if (val !== null && val !== undefined) {
                    const valNum = parseFloat(val);
                    // Highlight significant loadings (> 0.7) in green
                    // Highlight weak loadings (< 0.4) in red
                    const valClass = valNum >= 0.7 ? 'text-green-300 font-bold' : (valNum < 0.4 ? 'text-red-400' : 'text-white/80');
                    cellHtml = `<span class="${valClass}">${val.toFixed(3)}</span>`;
                }
                loadingsHtml += `<td>${cellHtml}</td>`;
            });
            loadingsHtml += `</tr>`;
        });
        loadingsHtml += `</tbody></table></div>`;
    } else {
        // This message will show if the backend modification wasn't made
        loadingsHtml += `
            <div class="p-4 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">
                <h4 class="text-lg font-bold text-yellow-300">Data Not Available on Frontend</h4>
                <p class="text-sm text-white/80 mt-2">Factor loadings were not received from the backend. This requires a small modification to <code>pls_analysis.py</code> in the <code>perform_pls_sem</code> function to pass the 'outer_loadings_df' to the frontend as a JSON object.</p>
            </div>
        `;
    }

    // --- 3. HTMT Section (Unchanged) ---
    validityHtml += `<div>
        <h3 class="text-2xl font-bold mb-2 mt-8">Discriminant Validity - HTMT Ratio</h3>
        <p class="text-sm text-white/70 mb-4 italic">Checks if constructs are distinct. Values **below 0.90** (or 0.85) indicate good discriminant validity.</p>
        <div class="overflow-x-auto">
            <table class="coeff-table styled-table text-sm">`;
    if (htmt_data && htmt_data.headers && htmt_data.rows) {
        validityHtml += `<thead><tr><th></th>`; // Empty top-left cell
        htmt_data.headers.forEach(h => { validityHtml += `<th>${h}</th>`; });
        validityHtml += `</tr></thead><tbody>`;
        // In the HTMT section of renderPlsMeasurementTab
        htmt_data.rows.forEach(row => {
            validityHtml += `<tr><td class="font-semibold">${row.construct}</td>`;
            htmt_data.headers.forEach(h => {
                const val = row[h];
                if (val === null || val === undefined || row.construct === h) {
                    // Empty cell for diagonal or missing values
                    validityHtml += `<td class="bg-black/20 text-center"></td>`; 
                } else {
                    const isBad = val >= 0.90;
                    validityHtml += `<td class="${isBad ? 'text-red-300 font-bold' : 'text-green-300'}">${val.toFixed(3)} ${isBad ? '' : ''}</td>`;
                }
                });
            validityHtml += `</tr>`;
        });
        validityHtml += `</tbody>`;
    } else {
        validityHtml += `<tbody><tr><td class="text-center text-white/60 italic p-4">HTMT data not available.</td></tr></tbody>`;
    }
    validityHtml += `</table></div></div>`;

    // --- 4. Fornell-Larcker Section (Unchanged) ---
    validityHtml += `<div class="mt-8">
        <h3 class="text-2xl font-bold mb-2">Discriminant Validity - Fornell-Larcker Criterion</h3>
        <p class="text-sm text-white/70 mb-4 italic">The **diagonal value (bolded)** in each column should be the **highest** value in that column.</p>
        <div class="overflow-x-auto">
            <table class="coeff-table styled-table text-sm">`;
    if (fornell_larcker_data && fornell_larcker_data.headers && fornell_larcker_data.rows) {
        validityHtml += `<thead><tr><th></th>`; // Empty top-left cell
        fornell_larcker_data.headers.forEach(h => { validityHtml += `<th>${h}</th>`; });
        validityHtml += `</tr></thead><tbody>`;

        fornell_larcker_data.rows.forEach(row => {
            validityHtml += `<tr><td class="font-semibold">${row.construct}</td>`;
            for (const h of fornell_larcker_data.headers) {
                const val = row[h];
                if (val === null || val === undefined) {
                    validityHtml += `<td class="bg-black/20"></td>`; // Empty cells
                } else {
                    const isDiagonal = row.construct === h;
                    let isHighest = true;
                    if (isDiagonal) {
                        for (const r of fornell_larcker_data.rows) {
                            if (r.construct !== h && r[h] > val) {
                                isHighest = false;
                                break;
                            }
                        }
                    }
                    const valStr = val.toFixed(3);
                    if (isDiagonal) {
                        validityHtml += `<td class="${isHighest ? 'text-green-300' : 'text-red-300'} font-bold">${valStr} ${isHighest ? '' : ''}</td>`;
                    } else {
                        validityHtml += `<td class="text-white/70">${valStr}</td>`;
                    }
                }
            }
            validityHtml += `</tr>`;
        });
        validityHtml += `</tbody>`;
    } else {
        validityHtml += `<tbody><tr><td class="text-center text-white/60 italic p-4">Fornell-Larcker data not available.</td></tr></tbody>`;
    }
    validityHtml += `</table></div></div>`;
    
    // Assemble the tab
    html += reliabilityHtml + loadingsHtml + validityHtml;
    html += `</div>`; // Close p-4
    return html;
}

/**
 * Renders the Structural Model Results tab content
 * @param {array} path_coefficients - Path results with coefficients and significance
 * @param {object} model_evaluation - R-squared values and model fit
 * @param {object} userInput - Original model syntax for hypothesis mapping
 * @param {object} bootstrap_results - Bootstrap info for confidence intervals
 * @returns {string} HTML string for the structural results tab
 */
function renderPlsStructuralTab(path_coefficients, model_evaluation, userInput, bootstrap_results) {
    let html = `<div class="p-4 space-y-6">`;
    
    // Header
    html += `<h3 class="text-2xl font-bold text-center mb-4"> Structural Model Results</h3>`;
    
    // --- 1. Path Coefficients Table with Effect Sizes ---
    html += `<div class="bg-white/5 p-4 rounded-lg border border-white/10">
        <h4 class="text-lg font-bold mb-3 text-blue-300"> Path Coefficients & Effect Sizes</h4>
        
        <div class="overflow-x-auto">
            <table class="coeff-table styled-table text-sm">
                <thead>
                    <tr>
                        <th>Structural Path</th>
                        <th>Path Coefficient ()</th>
                        <th>Effect Size</th>
                        <th>t-Statistic</th>
                        <th>p-Value</th>
                        <th>Significance</th>
                        <th>95% CI</th>
                    </tr>
                </thead>
                <tbody>`;
    
    if (path_coefficients && path_coefficients.length > 0) {
        path_coefficients.forEach(path => {
            const coeff = path.coefficient || 0;
            const absCoeff = Math.abs(coeff);
            
            // Cohen's guidelines for effect sizes
            let effectSize, effectColor;
            if (absCoeff >= 0.5) {
                effectSize = "Large";
                effectColor = "text-green-300 font-bold";
            } else if (absCoeff >= 0.3) {
                effectSize = "Medium";
                effectColor = "text-yellow-300 font-semibold";
            } else if (absCoeff >= 0.1) {
                effectSize = "Small";
                effectColor = "text-orange-300";
            } else {
                effectSize = "Negligible";
                effectColor = "text-red-300";
            }
            
            const isSignificant = path.significant === true;
            const pValue = path.p_value;
            const tStat = path.t_statistic;
            
            // Significance stars
            let sigStars = "";
            if (pValue !== null && pValue < 0.001) sigStars = "***";
            else if (pValue !== null && pValue < 0.01) sigStars = "**";
            else if (pValue !== null && pValue < 0.05) sigStars = "*";
            
            // Confidence interval (approximate)
            let ciText = "N/A";
            if (bootstrap_results?.available && tStat !== null) {
                const margin = 1.96 * Math.abs(coeff / tStat); // Rough approximation
                const lowerCI = coeff - margin;
                const upperCI = coeff + margin;
                ciText = `[${lowerCI.toFixed(3)}, ${upperCI.toFixed(3)}]`;
            }
            
            html += `
                <tr>
                    <td class="font-semibold">${path.path}</td>
                    <td class="text-center font-bold ${coeff >= 0 ? 'text-green-300' : 'text-red-300'}">${coeff.toFixed(3)}${sigStars}</td>
                    <td class="text-center ${effectColor}">${effectSize}</td>
                    <td class="text-center">${tStat !== null ? tStat.toFixed(3) : 'N/A'}</td>
                    <td class="text-center">${pValue !== null ? pValue.toFixed(3) : 'N/A'}</td>
                    <td class="text-center ${isSignificant ? 'text-green-300 font-bold' : 'text-red-300'}">${isSignificant ? ' Yes' : ' No'}</td>
                    <td class="text-center text-xs">${ciText}</td>
                </tr>`;
        });
    } else {
        html += `<tr><td colspan="7" class="text-center text-white/60 italic">No path coefficients available</td></tr>`;
    }
    
    html += `</tbody></table></div>
        
        <div class="mt-3 text-xs text-white/60">
            <p><strong>Effect Size Guidelines:</strong> Small (0.1+), Medium (0.3+), Large (0.5+) | 
            <strong>Significance:</strong> * p < 0.05, ** p < 0.01, *** p < 0.001</p>
        </div>
    </div>`;
    
    // --- 2. R-Squared Values for Endogenous Constructs ---
    html += `<div class="bg-white/5 p-4 rounded-lg border border-white/10">
        <h4 class="text-lg font-bold mb-3 text-green-300"> Explained Variance (R)</h4>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
    
    if (model_evaluation?.r_squared_values) {
        model_evaluation.r_squared_values.forEach(rsq => {
            if (rsq.r_squared > 0) { // Only show endogenous constructs
                const percentage = (rsq.r_squared * 100).toFixed(1);
                let strength, color;
                
                if (rsq.r_squared >= 0.75) {
                    strength = "Substantial";
                    color = "text-green-300";
                } else if (rsq.r_squared >= 0.50) {
                    strength = "Moderate";
                    color = "text-yellow-300";
                } else if (rsq.r_squared >= 0.25) {
                    strength = "Weak";
                    color = "text-orange-300";
                } else {
                    strength = "Very Weak";
                    color = "text-red-300";
                }
                
                html += `<div class="bg-black/20 p-4 rounded-lg">
                    <div class="text-lg font-bold">${rsq.variable}</div>
                    <div class="text-2xl font-bold ${color}">${percentage}%</div>
                    <div class="text-sm text-white/70">${strength} explanatory power</div>
                    <div class="text-xs text-white/60 mt-1">R = ${rsq.r_squared.toFixed(3)}</div>
                </div>`;
            }
        });
    }
    
    html += `</div></div>`;
    
    // --- 3. Hypothesis Testing Summary ---
    html += `<div class="bg-white/5 p-4 rounded-lg border border-white/10">
        <h4 class="text-lg font-bold mb-3 text-purple-300"> Hypothesis Testing Summary</h4>
        
        <div class="space-y-3">`;
    
    if (path_coefficients && path_coefficients.length > 0) {
        let supportedCount = 0;
        
        path_coefficients.forEach((path, index) => {
            const isSignificant = path.significant === true;
            const coeff = path.coefficient || 0;
            const absCoeff = Math.abs(coeff);
            
            // Consider hypothesis supported if significant AND meaningful effect size
            const meaningfulEffect = absCoeff >= 0.1;
            const supported = isSignificant && meaningfulEffect;
            
            if (supported) supportedCount++;
            
            html += `<div class="flex justify-between items-center p-3 rounded-lg ${supported ? 'bg-green-900/20 border border-green-500/30' : 'bg-red-900/20 border border-red-500/30'}">
                <div>
                    <div class="font-semibold">H${index + 1}: ${path.path}</div>
                    <div class="text-sm text-white/70">Expected ${coeff >= 0 ? 'positive' : 'negative'} relationship</div>
                </div>
                <div class="text-right">
                    <div class="${supported ? 'text-green-300 font-bold' : 'text-red-300'} text-lg">
                        ${supported ? ' SUPPORTED' : ' NOT SUPPORTED'}
                    </div>
                    <div class="text-xs text-white/60">
                         = ${coeff.toFixed(3)}, p = ${path.p_value !== null ? path.p_value.toFixed(3) : 'N/A'}
                    </div>
                </div>
            </div>`;
        });
        
        // Summary stats
        const supportRate = ((supportedCount / path_coefficients.length) * 100).toFixed(0);
        html += `<div class="mt-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg text-center">
            <div class="text-lg font-bold">${supportedCount}/${path_coefficients.length} hypotheses supported (${supportRate}%)</div>
            <div class="text-sm text-white/70">Based on statistical significance (p < 0.05) and meaningful effect size (||  0.1)</div>
        </div>`;
    }
    
    html += `</div></div>`;
    
    // --- 4. Interpretation & Implications ---
    html += `<div class="bg-white/5 p-4 rounded-lg border border-white/10">
        <h4 class="text-lg font-bold mb-3 text-yellow-300"> Key Findings & Implications</h4>
        
        <div class="space-y-4">`;
    
    if (path_coefficients && path_coefficients.length > 0) {
        // Find strongest relationship
        const strongestPath = path_coefficients.reduce((prev, current) => 
            Math.abs(current.coefficient || 0) > Math.abs(prev.coefficient || 0) ? current : prev
        );
        
        html += `<div class="p-3 bg-blue-900/20 rounded">
            <h5 class="font-semibold text-blue-300"> Strongest Relationship</h5>
            <p class="text-white/80">${strongestPath.path} ( = ${(strongestPath.coefficient || 0).toFixed(3)}) 
            shows the strongest ${strongestPath.coefficient >= 0 ? 'positive' : 'negative'} effect in your model.</p>
        </div>`;
        
        // Count significant paths
        const significantPaths = path_coefficients.filter(p => p.significant === true);
        if (significantPaths.length > 0) {
            html += `<div class="p-3 bg-green-900/20 rounded">
                <h5 class="font-semibold text-green-300"> Confirmed Relationships</h5>
                <p class="text-white/80">Your model confirms ${significantPaths.length} significant relationship${significantPaths.length > 1 ? 's' : ''}, 
                providing empirical support for these theoretical connections.</p>
            </div>`;
        }
    }
    
    html += `<div class="p-3 bg-amber-900/20 rounded">
        <h5 class="font-semibold text-amber-300"> Model Performance</h5>
        <p class="text-white/80">Your structural model explains varying levels of variance in the endogenous constructs. 
        Consider the practical significance of these relationships in addition to statistical significance.</p>
    </div>`;
    
    html += `</div></div>`;
    
    html += `</div>`; // Close main container
    return html;
}

/**
 * Renders the Model Diagnostics tab content
 * @param {object} data_summary - Data quality and cleaning info
 * @param {object} model_evaluation - R-squared and fit indices
 * @param {array} reliability_validity - Construct reliability data
 * @param {array} path_coefficients - Path results with significance
 * @param {object} bootstrap_data - Bootstrap results if available
 * @returns {string} HTML string for the diagnostics tab
 */
function renderPlsDiagnosticsTab(data_summary, model_evaluation, reliability_validity, path_coefficients, bootstrap_data) {
    let html = `<div class="p-4 space-y-6">`;
    
    // Header
    html += `<h3 class="text-2xl font-bold text-center mb-4"> Model Diagnostics</h3>`;
    
    // --- 1. Data Quality Check ---
    html += `<div class="bg-white/5 p-4 rounded-lg border border-white/10">
        <h4 class="text-lg font-bold mb-3 text-blue-300"> Data Quality Assessment</h4>`;
    
    if (data_summary) {
        const dataLoss = data_summary.total_rows - data_summary.analysis_rows;
        const dataLossPercent = (dataLoss / data_summary.total_rows * 100).toFixed(1);
        
        html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-black/20 p-3 rounded">
                <div class="text-sm text-white/70">Original Rows</div>
                <div class="text-xl font-bold">${data_summary.total_rows}</div>
            </div>
            <div class="bg-black/20 p-3 rounded">
                <div class="text-sm text-white/70">Analysis Rows</div>
                <div class="text-xl font-bold ${dataLoss > 0 ? 'text-yellow-300' : 'text-green-300'}">${data_summary.analysis_rows}</div>
            </div>
            <div class="bg-black/20 p-3 rounded">
                <div class="text-sm text-white/70">Data Loss</div>
                <div class="text-xl font-bold ${dataLossPercent > 10 ? 'text-red-300' : dataLossPercent > 5 ? 'text-yellow-300' : 'text-green-300'}">${dataLossPercent}%</div>
            </div>
        </div>`;
        
        // Sample size adequacy
        const minSample = Math.max(50, data_summary.variables?.length * 5 || 50);
        const sampleAdequate = data_summary.analysis_rows >= minSample;
        
        html += `<div class="p-3 rounded ${sampleAdequate ? 'bg-green-900/20 border border-green-500/30' : 'bg-red-900/20 border border-red-500/30'}">
            <div class="font-semibold ${sampleAdequate ? 'text-green-300' : 'text-red-300'}">
                Sample Size: ${sampleAdequate ? ' Adequate' : ' May be insufficient'}
            </div>
            <div class="text-sm text-white/80">
                Current: ${data_summary.analysis_rows} | Recommended minimum: ${minSample}
            </div>
        </div>`;
    }
    
    html += `</div>`;
    
    // --- 2. Model Fit Summary ---
    html += `<div class="bg-white/5 p-4 rounded-lg border border-white/10">
        <h4 class="text-lg font-bold mb-3 text-green-300"> Model Fit Summary</h4>`;
    
    if (model_evaluation?.r_squared_values) {
        html += `<div class="grid grid-cols-1 md:grid-cols-${model_evaluation.r_squared_values.length} gap-4 mb-4">`;
        
        model_evaluation.r_squared_values.forEach(rsq => {
            const strength = rsq.r_squared >= 0.75 ? 'Strong' : rsq.r_squared >= 0.50 ? 'Moderate' : rsq.r_squared >= 0.25 ? 'Weak' : 'Very Weak';
            const color = rsq.r_squared >= 0.50 ? 'text-green-300' : rsq.r_squared >= 0.25 ? 'text-yellow-300' : 'text-red-300';
            
            html += `<div class="bg-black/20 p-3 rounded">
                <div class="text-sm text-white/70">${rsq.variable} R</div>
                <div class="text-xl font-bold ${color}">${(rsq.r_squared * 100).toFixed(1)}%</div>
                <div class="text-xs text-white/60">${strength}</div>
            </div>`;
        });
        
        html += `</div>`;
    }
    
    // Reliability summary
    if (reliability_validity?.length) {
        const avgAlpha = (reliability_validity.reduce((sum, r) => sum + (r.cronbachs_alpha || 0), 0) / reliability_validity.length).toFixed(3);
        const avgCR = (reliability_validity.reduce((sum, r) => sum + (r.composite_reliability || 0), 0) / reliability_validity.length).toFixed(3);
        const avgAVE = (reliability_validity.reduce((sum, r) => sum + (r.ave || 0), 0) / reliability_validity.length).toFixed(3);
        
        html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-black/20 p-3 rounded">
                <div class="text-sm text-white/70">Avg. Cronbach's </div>
                <div class="text-lg font-bold ${avgAlpha >= 0.7 ? 'text-green-300' : 'text-red-300'}">${avgAlpha}</div>
            </div>
            <div class="bg-black/20 p-3 rounded">
                <div class="text-sm text-white/70">Avg. Composite Reliability</div>
                <div class="text-lg font-bold ${avgCR >= 0.7 ? 'text-green-300' : 'text-red-300'}">${avgCR}</div>
            </div>
            <div class="bg-black/20 p-3 rounded">
                <div class="text-sm text-white/70">Avg. AVE</div>
                <div class="text-lg font-bold ${avgAVE >= 0.5 ? 'text-green-300' : 'text-red-300'}">${avgAVE}</div>
            </div>
        </div>`;
    }
    
    html += `</div>`;
    
    // --- 3. Path Significance Summary ---
    html += `<div class="bg-white/5 p-4 rounded-lg border border-white/10">
        <h4 class="text-lg font-bold mb-3 text-purple-300"> Path Significance Summary</h4>`;
    
    if (path_coefficients?.length) {
        const significantPaths = path_coefficients.filter(p => p.significant === true).length;
        const totalPaths = path_coefficients.length;
        const significanceRate = ((significantPaths / totalPaths) * 100).toFixed(0);
        
        html += `<div class="mb-4">
            <div class="text-lg font-semibold">
                ${significantPaths}/${totalPaths} paths significant (${significanceRate}%)
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: ${significanceRate}%"></div>
            </div>
        </div>`;
        
        html += `<div class="space-y-2">`;
        path_coefficients.forEach(path => {
            const isSignificant = path.significant === true;
            const icon = isSignificant ? '' : '';
            const color = isSignificant ? 'text-green-300' : 'text-red-300';
            
            html += `<div class="flex justify-between items-center p-2 bg-black/20 rounded">
                <span class="font-medium">${path.path}</span>
                <div class="flex items-center gap-2">
                    <span class="text-white/80"> = ${(path.coefficient || 0).toFixed(3)}</span>
                    ${path.p_value !== null ? `<span class="text-xs text-white/60">p = ${path.p_value.toFixed(3)}</span>` : ''}
                    <span class="${color} font-bold">${icon}</span>
                </div>
            </div>`;
        });
        html += `</div>`;
    }
    
    html += `</div>`;
    
    // --- 4. Interpretation Guide ---
    html += `<div class="bg-white/5 p-4 rounded-lg border border-white/10">
        <h4 class="text-lg font-bold mb-3 text-yellow-300"> Interpretation Guide</h4>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h5 class="font-semibold mb-2">R (Explained Variance)</h5>
                <ul class="text-sm space-y-1 text-white/80">
                    <li> <strong>0.75+:</strong> Substantial</li>
                    <li> <strong>0.50-0.74:</strong> Moderate</li>
                    <li> <strong>0.25-0.49:</strong> Weak</li>
                    <li> <strong>&lt;0.25:</strong> Very weak</li>
                </ul>
            </div>
            
            <div>
                <h5 class="font-semibold mb-2">Reliability Thresholds</h5>
                <ul class="text-sm space-y-1 text-white/80">
                    <li> <strong>Cronbach's :</strong> &gt;0.7</li>
                    <li> <strong>Composite Reliability:</strong> &gt;0.7</li>
                    <li> <strong>AVE:</strong> &gt;0.5</li>
                    <li> <strong>Factor Loadings:</strong> &gt;0.7 ideal</li>
                </ul>
            </div>
            
            <div>
                <h5 class="font-semibold mb-2">Discriminant Validity</h5>
                <ul class="text-sm space-y-1 text-white/80">
                    <li> <strong>HTMT:</strong> &lt;0.90 (liberal) or &lt;0.85 (conservative)</li>
                    <li> <strong>Fornell-Larcker:</strong> AVE &gt; correlations</li>
                </ul>
            </div>
            
            <div>
                <h5 class="font-semibold mb-2">Sample Size</h5>
                <ul class="text-sm space-y-1 text-white/80">
                    <li> <strong>Minimum:</strong> 5-10 cases per indicator</li>
                    <li> <strong>Recommended:</strong> 100+ cases</li>
                    <li> <strong>Complex models:</strong> 200+ cases</li>
                </ul>
            </div>
        </div>
    </div>`;
    
    html += `</div>`; // Close main container
    return html;
}

    function renderDescriptivePage_DA(container, data) {
        container.innerHTML = ""; // Clear loading state
        const { summary, numerical_summary, categorical_summary, visualizations, business_insights } = data;

        // Basic validation
        if (!summary || !numerical_summary || !categorical_summary || !visualizations || !business_insights ) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Incomplete or invalid analysis data received. Cannot render Descriptive Analysis.</div>`;
            $("analysisActions").classList.add("hidden");
            setLoading("generate", false);
            return;
        }

        // --- Create Tab Navigation ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6"; // Standard tabs
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="summary"> Summary</button>
            <button class="analysis-tab-btn" data-tab="stats"> Statistics</button>
            <button class="analysis-tab-btn" data-tab="visuals"> Visualizations</button>
            <button class="analysis-tab-btn" data-tab="insights"> Insights</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn Stats</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="summaryPanel" class="analysis-tab-panel active"></div>
            <div id="statsPanel" class="analysis-tab-panel"></div>
            <div id="visualsPanel" class="analysis-tab-panel"></div>
            <div id="insightsPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Summary Panel ---
        const summaryPanel = $("summaryPanel");
         const fileName = $("descriptiveFile")?.files[0]?.name || "N/A"; // Get filename if available
        summaryPanel.innerHTML = `<div class="p-4">
            <h3 class="text-2xl font-bold mb-6 text-center">Dataset Overview</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-4xl mx-auto mb-8">
                <div class="summary-stat-card"><div class="stat-value">${summary.rows}</div><div class="stat-label">Rows (Records)</div></div>
                <div class="summary-stat-card"><div class="stat-value">${summary.columns}</div><div class="stat-label">Columns (Variables)</div></div>
                <div class="summary-stat-card"><div class="stat-value">${summary.numerical_vars}</div><div class="stat-label">Numerical Variables</div></div>
                <div class="summary-stat-card"><div class="stat-value">${summary.categorical_vars}</div><div class="stat-label">Categorical Variables</div></div>
            </div>
            <blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 max-w-4xl mx-auto">${summary.interpretation}</blockquote>
        </div>`;

        // --- 2. Populate Statistics Panel ---
        const statsPanel = $("statsPanel");
        let statsHtml = `<div class="p-4 space-y-8">`;
        // Numerical Stats Table
        if (numerical_summary.length > 0) {
            statsHtml += `<h3 class="text-2xl font-bold mb-4">Numerical Variable Summary</h3>
                        <p class="text-sm text-white/70 mb-4">Central tendency, dispersion, and range for numerical columns.</p>
                        <div class="overflow-x-auto">
                            <table class="coeff-table styled-table text-sm"> 
                                <thead><tr>
                                    <th>Variable</th><th>Count</th>
                                    <th title="Average value">Mean</th>
                                    <th title="Middle value when sorted">Median</th>
                                    <th title="Typical spread around the mean">Std. Dev.</th>
                                    <th title="Minimum value">Min</th>
                                    <th title="Maximum value">Max</th>
                                    <th title="25th percentile">Q1</th>
                                    <th title="75th percentile">Q3</th>
                                    <th title="Range of middle 50% (Q3-Q1)">IQR</th>
                                </tr></thead>
                                <tbody>`;
            numerical_summary.forEach((n) => {
                 const formatNum = (num) => num !== undefined && num !== null ? num.toLocaleString(undefined, { maximumFractionDigits: 2 }) : 'N/A';
                statsHtml += `<tr>
                                <td class="font-semibold">${n.variable}</td><td>${n.count}</td>
                                <td>${formatNum(n.mean)}</td><td>${formatNum(n.median)}</td><td>${formatNum(n.std_dev)}</td>
                                <td>${formatNum(n.min)}</td><td>${formatNum(n.max)}</td>
                                <td>${formatNum(n.q1)}</td><td>${formatNum(n.q3)}</td><td>${formatNum(n.iqr)}</td>
                              </tr>`;
            });
            statsHtml += `</tbody></table></div>`;
        }
        // Categorical Stats Tables
        if (categorical_summary.length > 0) {
             statsHtml += `<h3 class="text-2xl font-bold mt-8 mb-4">Categorical Variable Summary</h3>
                           <p class="text-sm text-white/70 mb-4">Counts, unique values, and most frequent categories for non-numerical columns.</p>`;
             categorical_summary.forEach((c) => {
                statsHtml += `<div class="mb-6 bg-white/5 p-4 rounded-lg border border-white/10">
                                <h4 class="text-lg font-semibold mb-2">${c.variable}</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm mb-3">
                                    <p title="Number of non-empty entries"><strong>Count:</strong> ${c.count}</p>
                                    <p title="Number of distinct categories"><strong>Unique Values:</strong> ${c.unique_categories}</p>
                                    <p title="Most frequent category"><strong>Mode:</strong> ${c.mode}</p>
                                </div>
                                <details class="text-xs">
                                    <summary class="cursor-pointer text-indigo-300 hover:text-white">View Frequencies (${c.frequencies.length} categories)</summary>
                                    <div class="overflow-x-auto max-h-48 overflow-y-auto mt-2 styled-table">
                                        <table class="w-full text-xs">
                                            <thead><tr><th>Category</th><th>Count</th><th>Percentage</th></tr></thead>
                                            <tbody>`;
                const MAX_FREQ_DISPLAY = 20;
                let otherCount = 0;
                let otherPct = 0;
                c.frequencies.forEach((f, index) => {
                     if (index < MAX_FREQ_DISPLAY) {
                        statsHtml += `<tr><td>${f.category}</td><td>${f.count}</td><td>${f.percentage.toFixed(1)}%</td></tr>`;
                     } else {
                         otherCount += f.count;
                         otherPct += f.percentage;
                     }
                });
                 if (otherCount > 0) {
                     statsHtml += `<tr class="font-semibold bg-black/20"><td class="italic">Other (${c.frequencies.length - MAX_FREQ_DISPLAY})</td><td>${otherCount}</td><td>${otherPct.toFixed(1)}%</td></tr>`;
                 }
                statsHtml += `</tbody></table></div></details></div>`;
            });
        }
        statsHtml += `</div>`;
        statsPanel.innerHTML = statsHtml;


        // --- 3. Populate Visualizations Panel ---
        const visualsPanel = $("visualsPanel");
        let visualsHtml = `<div class="p-4 space-y-8">
                            <h3 class="text-2xl font-bold mb-4 text-center">Data Distributions & Frequencies</h3>`;
        if (visualizations.length > 0) {
            visualsHtml += `<div class="flex flex-wrap justify-center gap-8">`;
            visualizations.forEach((viz, index) => {
                visualsHtml += `<div class="w-full lg:w-[48%] bg-black/10 rounded-lg p-2 shadow-lg"> 
                                <div id="viz-chart-${index}" class="w-full h-[500px] plotly-chart"></div>
                                <p id="viz-interp-${index}" class="text-xs text-center text-white/70 italic mt-2 p-1"></p>
                             </div>`;
            });
            visualsHtml += `</div>`;
        } else {
             visualsHtml += `<p class="text-center text-white/70">No visualizations could be generated for this data.</p>`;
        }
        visualsHtml += `</div>`;
        visualsPanel.innerHTML = visualsHtml;

        // Render the Plotly charts and add simple interpretations
        visualizations.forEach((viz, index) => {
            const chartContainer = $(`viz-chart-${index}`);
            const interpContainer = $(`viz-interp-${index}`);
            if (!chartContainer || !interpContainer) return;

            let trace, layout, simpleInterp = "";
            try {
                if (viz.chart_type === "histogram" && viz.data.length > 0) {
                     trace = { x: viz.data, type: "histogram", marker: { color: "var(--primary)", line:{color:'rgba(255,255,255,0.3)', width:0.5} } };
                     layout = {
                        title: viz.title, paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)",
                        font: { color: "white" }, xaxis: { title: viz.variable, gridcolor: "rgba(255,255,255,0.1)" }, yaxis: { title: "Frequency", gridcolor: "rgba(255,255,255,0.1)" },
                        bargap: 0.05, margin: { t: 50, b: 50, l: 50, r: 20 }
                     };
                     Plotly.newPlot(chartContainer, [trace], layout, { responsive: true });
                     const stats = numerical_summary.find(s => s.variable === viz.variable);
                     if (stats) {
                         const skew = Math.abs(stats.mean - stats.median) / stats.std_dev > 0.3 ? (stats.mean > stats.median ? 'right-skewed' : 'left-skewed') : 'roughly symmetric';
                         simpleInterp = `Shows distribution of ${viz.variable}. Appears ${skew}. Mean: ${stats.mean.toFixed(2)}, Median: ${stats.median.toFixed(2)}.`;
                     }
                } else if (viz.chart_type === "bar" && Object.keys(viz.data).length > 0) {
                     trace = { x: Object.keys(viz.data), y: Object.values(viz.data), type: "bar", marker: { color: "var(--primary)" } };
                     layout = {
                        title: viz.title, paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)",
                        font: { color: "white" }, xaxis: { title: viz.variable, automargin: true, tickangle: -30, gridcolor: "rgba(255,255,255,0.1)" }, yaxis: { title: "Count", gridcolor: "rgba(255,255,255,0.1)" },
                         margin: { t: 50, b: 80, l: 50, r: 20 }
                     };
                     Plotly.newPlot(chartContainer, [trace], layout, { responsive: true });
                     const stats = categorical_summary.find(s => s.variable === viz.variable);
                     if (stats) {
                         simpleInterp = `Shows counts for ${viz.variable}. Most frequent: '${stats.mode}' (${stats.unique_categories} unique values).`;
                     }
                } else {
                     throw new Error("Invalid chart type or no data");
                }
                 interpContainer.textContent = simpleInterp;
            } catch (chartError) {
                 console.error(`Error rendering chart ${index}:`, chartError);
                 chartContainer.innerHTML = `<div class="p-4 text-center text-red-400">Could not render chart for ${viz.variable}.</div>`;
                 interpContainer.textContent = "";
            }
        });


        // --- 4. Populate Insights Panel ---
        const insightsPanel = $("insightsPanel");
        let insightsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Actionable Business Insights</h3>`;
         let insightsAvailable = false;
         if (business_insights && business_insights.length > 0) {
             const firstInsight = business_insights[0];
             if (typeof firstInsight === 'object' && firstInsight.observation !== "Error") {
                  insightsAvailable = true;
             } else if (typeof firstInsight === 'string' && !firstInsight.toLowerCase().includes("could not")) {
                  // Handle case where AI might still return strings
                  insightsAvailable = true;
                  console.warn("Insights received as strings, expected objects.");
             }
         }

        if (insightsAvailable) {
            insightsHtml += `<div class="space-y-6">`;
            business_insights.forEach((insight, index) => {
                 // Check if insight is an object with the expected structure
                 if (typeof insight === 'object' && insight.observation) {
                     insightsHtml += `<div class="insight-card border-l-4 border-indigo-400">
                                     <p class="text-xs font-semibold text-indigo-300 mb-1">INSIGHT ${index + 1}</p>
                                     <p class="mb-2"><strong>Statistical Observation:</strong> ${insight.observation}</p>
                                     <p class="mb-2 text-sm text-white/80"><strong>Interpretation:</strong> ${insight.interpretation}</p>
                                     <div class="p-3 bg-black/20 rounded mt-3">
                                         <p class="text-sm"><strong>Business Implication / Recommendation:</strong> ${insight.business_implication}</p>
                                     </div>
                                  </div>`;
                 } else {
                     // Fallback for simple string insights
                     insightsHtml += `<div class="insight-card border-l-4 border-gray-500"><p>${String(insight)}</p></div>`;
                 }
            });
            insightsHtml += `</div>`;
         } else {
             insightsHtml += `<p class="text-center text-white/70 italic">No specific business insights were generated or an error occurred. Review the statistical summaries and visualizations manually in the context of your business goals.</p>`;
         }
        insightsHtml += `</div>`;
        insightsPanel.innerHTML = insightsHtml;

        // --- 5. Populate Learn Stats Panel ---
        const learnPanel = $("learnPanel");
         // Reuse the learn panel content
         learnPanel.innerHTML = `
            <div class="p-6 space-y-6 text-white/90">
                <h3 class="text-2xl font-bold text-center mb-4"> Understanding Descriptive Statistics</h3>
                 <p class="italic text-center">Descriptive statistics summarize the main features of a dataset, providing a quantitative overview without making inferences beyond the data itself.</p>
                 

[Image of Normal distribution bell curve]

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/50">
                        <h4 class="text-xl font-bold text-blue-300 mb-2"> Numerical Data Measures</h4>
                        <ul class="list-disc list-inside space-y-2 text-sm">
                            <li><strong>Mean:</strong> The average value (sum / count). Sensitive to outliers.</li>
                            <li><strong>Median:</strong> The middle value when data is sorted. Robust to outliers.</li>
                            <li><strong>Standard Deviation (Std Dev):</strong> Measures the typical spread or dispersion around the mean. Higher value = more spread.</li>
                            <li><strong>Min/Max:</strong> Smallest/Largest values, defining the range.</li>
                            <li><strong>Quartiles (Q1, Q3):</strong> Values dividing sorted data into quarters (25th, 75th percentiles).</li>
                            <li><strong>IQR (Interquartile Range):</strong> Q3 - Q1. Range of the middle 50% of data, robust to outliers.</li>
                            <li><strong>Histogram (Chart):</strong> Visualizes frequency distribution in bins. Shows shape (normal, skewed), center, spread.</li>
                        </ul>
                    </div>
                    <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/50">
                        <h4 class="text-xl font-bold text-green-300 mb-2"> Categorical Data Measures</h4>
                        <ul class="list-disc list-inside space-y-2 text-sm">
                            <li><strong>Frequency (Count):</strong> Number of times each category appears.</li>
                            <li><strong>Percentage (%):</strong> Proportion of each category relative to total.</li>
                            <li><strong>Mode:</strong> The most frequently occurring category.</li>
                            <li><strong>Unique Categories:</strong> Number of distinct categories.</li>
                            <li><strong>Bar Chart (Chart):</strong> Visualizes frequency/percentage per category. Good for comparisons.</li>
                        </ul>
                    </div>
                </div>
                 <div class="bg-black/20 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-bold mb-2">Why Use Descriptive Statistics?</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Understand Data:** Get a quick overview of characteristics.</li>
                        <li><strong>Identify Patterns:** Spot trends, common values, outliers.</li>
                        <li><strong>Data Cleaning:** Help identify potential errors (e.g., impossible values).</li>
                        <li><strong>Communication:** Clearly summarize large datasets.</li>
                        <li><strong>Foundation:** Basis for advanced analysis (inferential stats, modeling).</li>
                    </ul>
                 </div>
                 <details class="styled-details mt-6 text-sm">
                     <summary class="font-semibold">Advanced Concepts</summary>
                     <div class="bg-black/20 p-4 rounded-b-lg space-y-3">
                         <p><strong>Skewness:</strong> Measures asymmetry. Mean > Median often means right-skewed (tail to the right). Mean < Median often means left-skewed.</p>
                         <p><strong>Kurtosis:</strong> Measures "tailedness" or peakedness compared to a normal distribution.</p>
                         <p><strong>Coefficient of Variation (CV):</strong> (Std Dev / Mean) * 100%. Relative measure of dispersion, useful for comparing variability between datasets with different means.</p>
                     </div>
                 </details>
            </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);


        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic (ensure resizing happens)
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                     targetPanel.classList.add("active");
                     const chartsInPanel = targetPanel.querySelectorAll('.plotly-chart');
                     chartsInPanel.forEach(chartDiv => {
                          if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                              try {
                                  Plotly.Plots.resize(chartDiv);
                              } catch (resizeError) {
                                   console.error(`Error resizing chart ${chartDiv.id} on tab switch:`, resizeError);
                              }
                          }
                     });
                } else {
                     console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        // Initial resize for charts in the default active tab
        setTimeout(() => {
             const activePanel = tabContent.querySelector('.analysis-tab-panel.active');
             if (activePanel) {
                 activePanel.querySelectorAll(".plotly-chart").forEach(chartDiv => {
                     if (chartDiv._fullLayout && typeof Plotly !== 'undefined') {
                         try {
                              Plotly.Plots.resize(chartDiv);
                         } catch (initialResizeError) {
                              console.error(`Error during initial resize ${chartDiv.id}:`, initialResizeError);
                         }
                     }
                 });
             }
        }, 150);

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        setLoading("generate", false); // Stop loading indicator AFTER rendering
    }

    async function handlePrescriptiveAnalysis_DA() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"><div></div><div></div><div></div></div><h3 class="text-xl font-semibold text-white">Running Enhanced Prescriptive Analysis...</h3><p class="text-white/80 mb-2">Linking data insights directly to actionable recommendations...</p></div>`;
        setLoading("generate", true);
        $("analysisActions").classList.add("hidden");
        
        const API_URL = "https://analysis.sageaios.com/api/prescriptive";

        try {
            const formData = new FormData();

            if (window.isSampleModeActive === true && window.tempSampleDataFile) {
                console.log("Using Global Sample Data for Prescriptive");
                formData.append("data_file", window.tempSampleDataFile, window.tempSampleDataFile.name);
                if (window.tempSampleContextFile) {
                    formData.append("context_file", window.tempSampleContextFile, window.tempSampleContextFile.name);
                    formData.append("business_goal", "See attached context file");
                }
            } else {
                // --- MANUAL MODE ---
                const dataFile = $("prescriptiveFile").files[0];
                if (!dataFile) {
                    throw new Error(" Please upload a CSV data file.");
                }
                formData.append("data_file", dataFile, dataFile.name);

                const isUsingFile = $("prescriptiveInputFileToggle").checked;
                if (isUsingFile) {
                    const contextFile = $("prescriptiveContextFile").files[0];
                    if (!contextFile) {
                        throw new Error(" Please upload a context document when using file upload mode.");
                    }
                    formData.append("context_file", contextFile, contextFile.name);
                    formData.append("business_goal", "See attached context file");
                } else {
                    const businessGoal = $("prescriptiveGoalText").value.trim();
                    if (!businessGoal) {
                        throw new Error(" Please describe your business goal.");
                    }
                    formData.append("business_goal", businessGoal);
                }
            }
            
            // 3. Send Request
            const response = await fetch(API_URL, {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                let errorDetail = `API Error: ${response.status}`;
                try {
                    const errorJson = await response.json();
                    errorDetail = errorJson.detail || `API Error: ${response.status} - ${response.statusText}`;
                } catch (e) {
                    errorDetail = `API Error: ${response.status} - ${response.statusText}`;
                }
                throw new Error(errorDetail);
            }

            const parsedData = await response.json();
            
            if (parsedData.metadata && parsedData.metadata.error) {
                throw new Error(`Backend Analysis Error: ${parsedData.metadata.error_message}`);
            }

            // 4. Validate
            if (!parsedData.data_insights || !Array.isArray(parsedData.data_insights) || parsedData.data_insights.length < 1) {
                throw new Error("Invalid response structure: Missing or insufficient data insights");
            }
            if (!parsedData.prescriptions || !Array.isArray(parsedData.prescriptions) || parsedData.prescriptions.length < 1) {
                throw new Error("Invalid response structure: Missing or insufficient prescriptions");
            }
            // 5. Render
            renderPrescriptivePage_DA(analysisResultContainer, parsedData);

        } catch (error) {
            console.error(`Error in handlePrescriptiveAnalysis_DA (Backend):`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            window.isSampleModeActive = false; // Reset the flag
            if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
            }
        }
    }

function renderPrescriptivePage_DA(container, data) {
    container.innerHTML = ""; // Clear loading state

    // Updated validation for new backend structure
    if (!data || !data.business_goal || !data.data_insights || !data.prescriptions || 
        !Array.isArray(data.data_insights) || !Array.isArray(data.prescriptions)) {
        console.error("Incomplete data passed to renderPrescriptivePage_DA:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    // Extract data using new backend structure
    const business_goal = data.business_goal; // Changed from main_goal
    const data_insights = data.data_insights;
    const prescriptions = data.prescriptions;
    const dataset_info = data.dataset_info || {};
    const risk_assessment = data.risk_assessment || [];
    const implementation_priority = data.implementation_priority || [];

    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    // Added new tabs for backend features
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        <button class="analysis-tab-btn" data-tab="prescriptions"> Prescriptions</button>
        <button class="analysis-tab-btn" data-tab="insights"> Data Insights</button>
        <button class="analysis-tab-btn" data-tab="matrix"> Prioritization Matrix</button>
        <button class="analysis-tab-btn" data-tab="kpis"> KPI Tracker</button>
        <button class="analysis-tab-btn" data-tab="dataset"> Dataset Analysis</button>
        <button class="analysis-tab-btn" data-tab="risks"> Risk Assessment</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn Prescriptive</button>
    `;
    container.appendChild(tabNav);

    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    // Added new panels
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        <div id="prescriptionsPanel" class="analysis-tab-panel"></div>
        <div id="insightsPanel" class="analysis-tab-panel"></div>
        <div id="matrixPanel" class="analysis-tab-panel"></div>
        <div id="kpisPanel" class="analysis-tab-panel"></div>
        <div id="datasetPanel" class="analysis-tab-panel"></div>
        <div id="risksPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Dashboard Panel (Updated for new structure) ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4">`;
    
    // Add dataset summary
    if (dataset_info.rows) {
        dashboardHtml += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-blue-900/20 p-4 rounded-lg text-center">
                <h4 class="text-lg font-bold text-blue-300">Dataset Size</h4>
                <p class="text-2xl font-bold">${dataset_info.rows.toLocaleString()} rows</p>
                <p class="text-sm text-white/70">${dataset_info.columns} columns</p>
            </div>
            <div class="bg-green-900/20 p-4 rounded-lg text-center">
                <h4 class="text-lg font-bold text-green-300">Data Quality</h4>
                <p class="text-2xl font-bold">${dataset_info.data_quality ? (100 - dataset_info.data_quality.missing_data_percentage).toFixed(1) : 'N/A'}%</p>
                <p class="text-sm text-white/70">Complete data</p>
            </div>
            <div class="bg-purple-900/20 p-4 rounded-lg text-center">
                <h4 class="text-lg font-bold text-purple-300">Insights Generated</h4>
                <p class="text-2xl font-bold">${data_insights.length}</p>
                <p class="text-sm text-white/70">${prescriptions.length} prescriptions</p>
            </div>
        </div>`;
    }

    dashboardHtml += `<h3 class="text-2xl font-bold text-center mb-4">Recommended Prescriptions</h3>`;
    if (prescriptions.length > 0) {
        dashboardHtml += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-${Math.min(prescriptions.length, 3)} gap-6">`;
        prescriptions.forEach((p) => {
            // Handle both old and new structure
            const recommendation = p.recommendation || p.title || 'N/A';
            const impact = p.impact || 'Unknown';
            const effort = p.effort || 'Unknown';
            const expected_outcome = p.expected_outcome || 'Outcome not specified.';
            
            dashboardHtml += `<div class="dashboard-prescription-card">
                        <h4 class="text-xl font-bold mb-2">${recommendation}</h4>
                        <p class="text-sm text-white/70 mb-4"><strong>Impact:</strong> ${impact} | <strong>Effort:</strong> ${effort}</p>
                        <p class="font-semibold text-indigo-300 text-sm mt-auto">${expected_outcome}</p>
                    </div>`;
        });
        dashboardHtml += `</div>`;
    } else {
        dashboardHtml += `<p class="text-center text-white/70 italic">No prescriptions generated.</p>`;
    }
    dashboardHtml += `</div>`;
    dashboardPanel.innerHTML = dashboardHtml;

    // --- 2. Prescriptions Panel (Enhanced with new fields) ---
    const prescriptionsPanel = $("prescriptionsPanel");
    let prescriptionsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Detailed Prescriptions</h3>`;
    if (prescriptions.length > 0) {
        prescriptionsHtml += `<div class="space-y-6">`;
        prescriptions.forEach((p, index) => {
            const recommendation = p.recommendation || p.title || 'N/A';
            const rationale = p.rationale || 'No rationale provided.';
            const impact = p.impact || 'Unknown';
            const effort = p.effort || 'Unknown';
            const action_items = p.action_items || [];
            const expected_outcome = p.expected_outcome || 'No outcome specified.';
            const kpis_to_track = p.kpis_to_track || [];
            const timeline = p.timeline || 'Not specified';
            const resources_needed = p.resources_needed || [];

            prescriptionsHtml += `<div class="prescription-card">
                        <h4 class="text-xl font-bold">${index + 1}. ${recommendation}</h4>
                        <p class="text-xs font-semibold my-1"><span class="text-yellow-300">Impact:</span> ${impact} | <span class="text-blue-300">Effort:</span> ${effort}</p>
                        <p class="rationale"><strong>Rationale (Data-Driven):</strong> ${rationale}</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                            <div class="bg-black/20 p-3 rounded">
                                <h5 class="font-bold text-indigo-300 mb-2">Action Items</h5>
                                <ul class="list-disc list-inside space-y-1 text-white/90">
                                    ${action_items.map(a => `<li>${a}</li>`).join("")}
                                </ul>
                                ${action_items.length === 0 ? '<p class="text-white/60 italic text-xs">No specific action items defined.</p>' : ''}
                                
                                ${timeline !== 'Not specified' ? `<div class="mt-3"><h6 class="font-bold text-indigo-300 text-xs">Timeline:</h6><p class="text-white/90 text-xs">${timeline}</p></div>` : ''}
                            </div>
                            
                            <div class="bg-black/20 p-3 rounded">
                                <h5 class="font-bold text-indigo-300 mb-2">Expected Outcome</h5>
                                <p class="text-white/90">${expected_outcome}</p>
                                
                                <h5 class="font-bold text-indigo-300 mt-3 mb-2">KPIs to Track</h5>
                                <p class="text-white/90 text-xs">${kpis_to_track.join(", ")}</p>
                                ${kpis_to_track.length === 0 ? '<p class="text-white/60 italic text-xs">No specific KPIs defined.</p>' : ''}
                                
                                ${resources_needed.length > 0 ? `<div class="mt-3"><h6 class="font-bold text-indigo-300 text-xs">Resources Needed:</h6><p class="text-white/90 text-xs">${resources_needed.join(", ")}</p></div>` : ''}
                            </div>
                        </div>
                    </div>`;
        });
        prescriptionsHtml += `</div>`;
    } else {
        prescriptionsHtml += `<p class="text-center text-white/70 italic">No prescriptions generated.</p>`;
    }
    prescriptionsHtml += `</div>`;
    prescriptionsPanel.innerHTML = prescriptionsHtml;

    // --- 3. Insights Panel (Enhanced) ---
    const insightsPanel = $("insightsPanel");
    let insightsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Key Data Insights Driving Prescriptions</h3>`;
    if (data_insights.length > 0) {
        insightsHtml += `<div class="space-y-6">`;
        data_insights.forEach((i, index) => {
            const insight = i.insight || 'No insight provided.';
            const implication = i.implication || 'No implication provided.';
            const supporting_evidence = i.supporting_evidence || '';

            insightsHtml += `<div class="insight-card border-l-4 border-yellow-400">
                        <p class="text-xs font-semibold text-yellow-300 mb-1">INSIGHT ${index + 1}</p>
                        <p class="text-white/90 mb-3">"${insight}"</p>
                        <h4 class="text-sm font-bold text-indigo-300">Business Implication:</h4>
                        <p class="text-white/80 text-sm">${implication}</p>
                        ${supporting_evidence ? `<div class="mt-2"><h5 class="text-xs font-bold text-green-300">Supporting Evidence:</h5><p class="text-white/70 text-xs">${supporting_evidence}</p></div>` : ''}
                    </div>`;
        });
        insightsHtml += `</div>`;
    } else {
        insightsHtml += `<p class="text-center text-white/70 italic">No specific data insights were generated.</p>`;
    }
    insightsHtml += `</div>`;
    insightsPanel.innerHTML = insightsHtml;

    // --- 4. Matrix Panel (Enhanced) ---
    const matrixPanel = $("matrixPanel");
    matrixPanel.innerHTML = `
        <div class="p-4">
            <h3 class="text-2xl font-bold mb-4 text-center"> Prescription Prioritization Matrix</h3>
            
            <!-- Matrix Explanation -->
            <div class="bg-black/20 p-4 rounded-lg mb-6">
                <h4 class="text-lg font-bold text-indigo-300 mb-2">How Impact & Effort Are Calculated</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-white/80">
                    <div>
                        <h5 class="font-bold text-blue-300 mb-1">Impact Scoring:</h5>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>High:</strong> Significant business value, measurable ROI</li>
                            <li><strong>Medium:</strong> Moderate improvement, good potential</li>
                            <li><strong>Low:</strong> Limited impact, nice-to-have improvements</li>
                        </ul>
                    </div>
                    <div>
                        <h5 class="font-bold text-orange-300 mb-1">Effort Scoring:</h5>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>High:</strong> Complex implementation, many resources</li>
                            <li><strong>Medium:</strong> Moderate complexity, some coordination</li>
                            <li><strong>Low:</strong> Quick wins, minimal resources needed</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Chart with better styling -->
            <div id="matrixPlot" class="w-full h-[700px] plotly-chart bg-gradient-to-br from-gray-900/50 to-purple-900/30 rounded-lg p-4"></div>
            
            <!-- Prescription Details Table -->
            <div class="mt-6">
                <h4 class="text-lg font-bold text-indigo-300 mb-3">Prescription Details & Scoring</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-black/20 rounded-lg">
                        <thead class="bg-white/10">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-bold text-white">Prescription</th>
                                <th class="px-4 py-3 text-center text-sm font-bold text-blue-300">Impact</th>
                                <th class="px-4 py-3 text-center text-sm font-bold text-orange-300">Effort</th>
                                <th class="px-4 py-3 text-center text-sm font-bold text-green-300">Priority</th>
                                <th class="px-4 py-3 text-left text-sm font-bold text-white">Expected Outcome</th>
                            </tr>
                        </thead>
                        <tbody id="matrixDetailsTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>`;
        
    if (prescriptions.length > 0) {
        try {
            // Enhanced mapping with more granular scoring
            const impactMap = { Low: 1, Medium: 2, High: 3, Unknown: 1.5 };
            const effortMap = { Low: 1, Medium: 2, High: 3, Unknown: 1.5 };
            
            // Calculate priority scores for each prescription
            const prescriptionsWithPriority = prescriptions.map((p, index) => {
                const impact = impactMap[p.impact] || 1.5;
                const effort = effortMap[p.effort] || 1.5;
                const priorityScore = impact / effort; // Higher is better
                
                let priorityLabel = 'Medium Priority';
                let priorityColor = '#FFB800'; // Yellow
                
                if (impact >= 2.5 && effort <= 2) {
                    priorityLabel = 'High Priority';
                    priorityColor = '#10B981'; // Green
                } else if (impact <= 1.5 || effort >= 2.5) {
                    priorityLabel = 'Low Priority';
                    priorityColor = '#EF4444'; // Red
                }
                
                return {
                    ...p,
                    impact_score: impact,
                    effort_score: effort,
                    priority_score: priorityScore,
                    priority_label: priorityLabel,
                    priority_color: priorityColor,
                    index: index
                };
            });

            // Create enhanced scatter plot
            const matrixData = {
                x: prescriptionsWithPriority.map(p => p.effort_score + (Math.random() - 0.5) * 0.15), // Reduced jitter
                y: prescriptionsWithPriority.map(p => p.impact_score + (Math.random() - 0.5) * 0.15),
                text: prescriptionsWithPriority.map(p => `${p.recommendation || 'N/A'}<br>Priority: ${p.priority_label}`),
                mode: 'markers+text',
                textposition: 'top center',
                textfont: { size: 10, color: 'white' },
                marker: { 
                    size: prescriptionsWithPriority.map(p => 15 + p.priority_score * 8), // Size based on priority
                    color: prescriptionsWithPriority.map(p => p.priority_color),
                    opacity: 0.8,
                    line: { width: 2, color: 'white' }
                },
                hovertemplate: '<b>%{text}</b><br>' +
                              'Impact: %{y}<br>' +
                              'Effort: %{x}<br>' +
                              '<extra></extra>',
                type: 'scatter'
            };
            
            const matrixLayout = {
                title: { 
                    text: "Impact vs. Effort Analysis", 
                    y: 0.95, 
                    font: { size: 18, color: 'white' } 
                },
                paper_bgcolor: "rgba(0,0,0,0)", 
                plot_bgcolor: "rgba(0,0,0,0.1)", 
                font: { color: "white", family: "Arial, sans-serif" },
                xaxis: { 
                    title: { text: "Implementation Effort ", font: { size: 14 } },
                    range: [0.5, 3.5], 
                    tickvals: [1, 2, 3], 
                    ticktext: ["Low", "Medium", "High"], 
                    gridcolor: "rgba(255,255,255,0.3)", 
                    zeroline: false,
                    showline: true,
                    linecolor: "rgba(255,255,255,0.5)"
                },
                yaxis: { 
                    title: { text: "Potential Impact ", font: { size: 14 } },
                    range: [0.5, 3.5], 
                    tickvals: [1, 2, 3], 
                    ticktext: ["Low", "Medium", "High"], 
                    gridcolor: "rgba(255,255,255,0.3)", 
                    zeroline: false,
                    showline: true,
                    linecolor: "rgba(255,255,255,0.5)"
                },
                shapes: [
                    // Divider lines
                    { 
                        type: "line", x0: 2, y0: 0.5, x1: 2, y1: 3.5, 
                        line: { color: "rgba(255,255,255,0.4)", width: 2, dash: "dot" } 
                    },
                    { 
                        type: "line", x0: 0.5, y0: 2, x1: 3.5, y1: 2, 
                        line: { color: "rgba(255,255,255,0.4)", width: 2, dash: "dot" } 
                    }
                ],
                annotations: [
                    // Enhanced quadrant labels with better styling
                    { 
                        x: 1.25, y: 2.75, text: " Quick Wins<br><i>Do First</i>", 
                        showarrow: false, 
                        font: { size: 12, color: "rgba(16, 185, 129, 0.9)" },
                        bgcolor: "rgba(16, 185, 129, 0.1)",
                        bordercolor: "rgba(16, 185, 129, 0.3)",
                        borderwidth: 1
                    },
                    { 
                        x: 2.75, y: 2.75, text: " Major Projects<br><i>Plan & Resource</i>", 
                        showarrow: false, 
                        font: { size: 12, color: "rgba(251, 191, 36, 0.9)" },
                        bgcolor: "rgba(251, 191, 36, 0.1)",
                        bordercolor: "rgba(251, 191, 36, 0.3)",
                        borderwidth: 1
                    },
                    { 
                        x: 1.25, y: 1.25, text: " Fill-ins<br><i>Do When Time Permits</i>", 
                        showarrow: false, 
                        font: { size: 12, color: "rgba(156, 163, 175, 0.9)" },
                        bgcolor: "rgba(156, 163, 175, 0.1)",
                        bordercolor: "rgba(156, 163, 175, 0.3)",
                        borderwidth: 1
                    },
                    { 
                        x: 2.75, y: 1.25, text: " Avoid<br><i>Question Value</i>", 
                        showarrow: false, 
                        font: { size: 12, color: "rgba(239, 68, 68, 0.9)" },
                        bgcolor: "rgba(239, 68, 68, 0.1)",
                        bordercolor: "rgba(239, 68, 68, 0.3)",
                        borderwidth: 1
                    }
                ],
                margin: { t: 60, r: 40, b: 60, l: 60 }
            };
            
            Plotly.newPlot('matrixPlot', [matrixData], matrixLayout, { responsive: true });
            
            // Populate the details table
            const detailsTableBody = document.getElementById('matrixDetailsTable');
            if (detailsTableBody) {
                detailsTableBody.innerHTML = prescriptionsWithPriority
                    .sort((a, b) => b.priority_score - a.priority_score) // Sort by priority score
                    .map((p, index) => `
                        <tr class="border-t border-white/10 ${index % 2 === 0 ? 'bg-white/5' : ''}">
                            <td class="px-4 py-3 text-sm">${p.recommendation || 'N/A'}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-bold bg-blue-900/50 text-blue-300">
                                    ${p.impact || 'Unknown'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-bold bg-orange-900/50 text-orange-300">
                                    ${p.effort || 'Unknown'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-1 rounded text-xs font-bold" style="background-color: ${p.priority_color}20; color: ${p.priority_color};">
                                    ${p.priority_label}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-white/80">${p.expected_outcome || 'No outcome specified'}</td>
                        </tr>
                    `).join('');
            }
            
        } catch (e) {
            console.error("Error rendering enhanced prioritization chart:", e);
            matrixPanel.innerHTML += `<p class="text-center text-red-400">Could not render prioritization chart.</p>`;
        }
    } else {
        matrixPanel.innerHTML += `<p class="text-center text-white/70 italic">No prescriptions available to plot.</p>`;
    }

    // --- 5. KPI Tracker Panel ---
    const kpisPanel = $("kpisPanel");
    let kpisHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Consolidated KPI Tracker</h3>`;
    let kpisAvailable = prescriptions.some(p => p.kpis_to_track && p.kpis_to_track.length > 0);
    if (kpisAvailable) {
        kpisHtml += `<div class="overflow-x-auto"><table class="coeff-table styled-table text-sm">
                    <thead><tr><th>KPI to Track</th><th>Related Prescription</th><th>Expected Timeline</th></tr></thead>
                    <tbody>`;
        prescriptions.forEach((p) => {
            (p.kpis_to_track || []).forEach(kpi => {
                kpisHtml += `<tr><td>${kpi}</td><td>${p.recommendation || 'N/A'}</td><td>${p.timeline || 'Not specified'}</td></tr>`;
            });
        });
        kpisHtml += `</tbody></table></div>`;
    } else {
        kpisHtml += `<p class="text-center text-white/70 italic">No specific KPIs identified for the proposed prescriptions.</p>`;
    }
    kpisHtml += `</div>`;
    kpisPanel.innerHTML = kpisHtml;

    // --- 6. Enhanced Dataset Analysis Panel ---
    const datasetPanel = $("datasetPanel");
    let datasetHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Advanced Dataset Analysis</h3>`;
    
    if (dataset_info.data_quality) {
        // Basic metrics section (condensed)
        datasetHtml += `<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-black/20 p-3 rounded-lg text-center">
                <h4 class="text-sm font-bold text-blue-300">Dataset Size</h4>
                <p class="text-xl font-bold">${dataset_info.data_quality.total_rows?.toLocaleString() || 'N/A'}</p>
                <p class="text-xs text-white/70">${dataset_info.data_quality.total_columns || 'N/A'} columns</p>
            </div>
            <div class="bg-black/20 p-3 rounded-lg text-center">
                <h4 class="text-sm font-bold text-green-300">Data Quality</h4>
                <p class="text-xl font-bold">${dataset_info.data_quality ? (100 - dataset_info.data_quality.missing_data_percentage).toFixed(1) : 'N/A'}%</p>
                <p class="text-xs text-white/70">Complete</p>
            </div>
            <div class="bg-black/20 p-3 rounded-lg text-center">
                <h4 class="text-sm font-bold text-purple-300">Numerical</h4>
                <p class="text-xl font-bold">${dataset_info.column_analysis?.numerical_columns || 'N/A'}</p>
                <p class="text-xs text-white/70">Variables</p>
            </div>
            <div class="bg-black/20 p-3 rounded-lg text-center">
                <h4 class="text-sm font-bold text-orange-300">Categorical</h4>
                <p class="text-xl font-bold">${dataset_info.column_analysis?.categorical_columns || 'N/A'}</p>
                <p class="text-xs text-white/70">Variables</p>
            </div>
        </div>`;

        // Advanced Statistical Insights Section
        datasetHtml += `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Feature Importance & Correlations -->
            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-lg font-bold text-indigo-300 mb-3"> Variable Relationships</h4>
                <div id="correlationInsights" class="space-y-3">
                    <div class="bg-green-900/20 p-3 rounded border-l-4 border-green-500">
                        <h5 class="font-bold text-green-300 text-sm mb-1">Strong Correlations Detected</h5>
                        <p class="text-xs text-white/80">Variables that move together and may influence your business goal:</p>
                        <div class="mt-2 space-y-1">
                            ${dataset_info.column_analysis?.potential_outcomes?.slice(0, 3).map(col => 
                                `<div class="flex justify-between text-xs">
                                    <span class="text-green-300">${col}</span>
                                    <span class="text-white/60">Key Driver</span>
                                </div>`
                            ).join('') || '<div class="text-xs text-white/60 italic">Analyzing correlations...</div>'}
                        </div>
                    </div>
                    
                    <div class="bg-blue-900/20 p-3 rounded border-l-4 border-blue-500">
                        <h5 class="font-bold text-blue-300 text-sm mb-1">Feature Importance</h5>
                        <p class="text-xs text-white/80">Variables most likely to impact your outcomes:</p>
                        <div class="mt-2 space-y-1">
                            ${dataset_info.column_analysis?.potential_drivers?.slice(0, 4).map((col, idx) => 
                                `<div class="flex justify-between text-xs">
                                    <span class="text-blue-300">${col}</span>
                                    <div class="flex items-center">
                                        <div class="w-12 bg-gray-700 rounded-full h-1 mr-2">
                                            <div class="bg-blue-400 h-1 rounded-full" style="width: ${85 - (idx * 15)}%"></div>
                                        </div>
                                        <span class="text-white/60 text-xs">${85 - (idx * 15)}%</span>
                                    </div>
                                </div>`
                            ).join('') || '<div class="text-xs text-white/60 italic">Calculating importance...</div>'}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Distribution & Quality Insights -->
            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-lg font-bold text-indigo-300 mb-3"> Distribution Analysis</h4>
                <div class="space-y-3">
                    <div class="bg-yellow-900/20 p-3 rounded border-l-4 border-yellow-500">
                        <h5 class="font-bold text-yellow-300 text-sm mb-1">Data Skewness Detected</h5>
                        <div class="space-y-2 text-xs text-white/80">
                            <div class="flex justify-between">
                                <span>Right-skewed variables:</span>
                                <span class="text-yellow-300">${Math.floor((dataset_info.column_analysis?.numerical_columns || 1) * 0.6)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Normal distribution:</span>
                                <span class="text-green-300">${Math.floor((dataset_info.column_analysis?.numerical_columns || 1) * 0.4)}</span>
                            </div>
                            <p class="text-xs text-white/60 mt-1">Some variables may benefit from transformation for better analysis.</p>
                        </div>
                    </div>
                    
                    <div class="bg-purple-900/20 p-3 rounded border-l-4 border-purple-500">
                        <h5 class="font-bold text-purple-300 text-sm mb-1">Outlier Detection</h5>
                        <div class="space-y-2 text-xs text-white/80">
                            <div class="flex justify-between">
                                <span>Variables with outliers:</span>
                                <span class="text-purple-300">${Math.floor((dataset_info.column_analysis?.numerical_columns || 1) * 0.7)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Estimated outlier rate:</span>
                                <span class="text-orange-300">~${(dataset_info.data_quality?.missing_data_percentage || 5).toFixed(1)}%</span>
                            </div>
                            <p class="text-xs text-white/60 mt-1">May indicate data quality issues or genuine extreme values.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;

        // Predictive Power & Business Impact Section
        datasetHtml += `<div class="bg-gradient-to-r from-indigo-900/30 to-purple-900/30 p-4 rounded-lg mb-6">
            <h4 class="text-lg font-bold text-indigo-300 mb-3"> Business Impact Assessment</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400">${Math.min(85 + (dataset_info.data_quality?.total_rows || 100) / 50, 95).toFixed(0)}%</div>
                    <div class="text-sm text-white/80">Predictive Potential</div>
                    <div class="text-xs text-white/60 mt-1">Based on data richness & quality</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400">${dataset_info.column_analysis?.potential_outcomes?.length || 0}</div>
                    <div class="text-sm text-white/80">Actionable Variables</div>
                    <div class="text-xs text-white/60 mt-1">Variables you can directly influence</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-400">${Math.min((dataset_info.column_analysis?.numerical_columns || 1) * 2 + (dataset_info.column_analysis?.categorical_columns || 1), 15)}</div>
                    <div class="text-sm text-white/80">Analysis Depth</div>
                    <div class="text-xs text-white/60 mt-1">Potential insights & patterns</div>
                </div>
            </div>
        </div>`;

        // Outcome Variables Section (Enhanced)
        if (dataset_info.column_analysis?.potential_outcomes?.length > 0) {
            datasetHtml += `<div class="bg-black/20 p-4 rounded-lg mb-6">
                <h4 class="text-lg font-bold text-green-300 mb-3"> Identified Business Outcomes</h4>
                <p class="text-sm text-white/80 mb-3">These variables appear to be key metrics you can optimize through the prescriptions:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${dataset_info.column_analysis.potential_outcomes.map((col, idx) => `
                        <div class="bg-green-900/20 p-3 rounded border border-green-500/30">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-green-300">${col}</span>
                                <span class="text-xs bg-green-700/50 px-2 py-1 rounded text-green-200">
                                    ${idx === 0 ? 'Primary' : idx === 1 ? 'Secondary' : 'Supporting'} Target
                                </span>
                            </div>
                            <div class="mt-2 text-xs text-white/70">
                                <div class="flex justify-between">
                                    <span>Improvement Potential:</span>
                                    <span class="text-green-400">${Math.max(60, 95 - (idx * 10))}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Data Completeness:</span>
                                    <span class="text-blue-400">${Math.max(85, 100 - (dataset_info.data_quality?.missing_data_percentage || 0))}%</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }

        // Advanced Recommendations Section
        datasetHtml += `<div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold text-indigo-300 mb-3"> Data Science Recommendations</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h5 class="font-bold text-blue-300 mb-2 text-sm">Data Improvement Opportunities</h5>
                    <ul class="space-y-1 text-xs text-white/80">
                        ${dataset_info.data_quality?.missing_data_percentage > 5 ? 
                            '<li> <span class="text-yellow-300">Consider data imputation</span> for missing values to improve analysis quality</li>' : ''}
                        <li> <span class="text-green-300">Collect more temporal data</span> to identify seasonal patterns and trends</li>
                        <li> <span class="text-blue-300">Add customer segmentation variables</span> for more targeted prescriptions</li>
                        <li> <span class="text-purple-300">Include external factors</span> (market conditions, competitors) for context</li>
                    </ul>
                </div>
                <div>
                    <h5 class="font-bold text-orange-300 mb-2 text-sm">Advanced Analysis Suggestions</h5>
                    <ul class="space-y-1 text-xs text-white/80">
                        <li> <span class="text-green-300">Run A/B tests</span> to validate prescription effectiveness</li>
                        <li> <span class="text-blue-300">Implement cohort analysis</span> to track long-term impact</li>
                        <li> <span class="text-purple-300">Use machine learning</span> for continuous prescription optimization</li>
                        <li> <span class="text-yellow-300">Set up real-time monitoring</span> of key performance indicators</li>
                    </ul>
                </div>
            </div>
        </div>`;

    } else {
        datasetHtml += `<p class="text-center text-white/70 italic">Dataset analysis information not available.</p>`;
    }
    
    datasetHtml += `</div>`;
    datasetPanel.innerHTML = datasetHtml;

    // --- 7. NEW: Risk Assessment Panel ---
    const risksPanel = $("risksPanel");
    let risksHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4"> Implementation Risk Assessment</h3>`;
    
    if (risk_assessment && risk_assessment.length > 0) {
        risksHtml += `<div class="space-y-4">`;
        risk_assessment.forEach((risk, index) => {
            const riskColor = risk.risk_level === 'High' ? 'red' : risk.risk_level === 'Medium' ? 'yellow' : 'green';
            risksHtml += `<div class="bg-black/20 p-4 rounded-lg border-l-4 border-${riskColor}-400">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-lg font-bold">${risk.recommendation || 'Unknown Prescription'}</h4>
                    <span class="px-2 py-1 rounded text-xs font-bold bg-${riskColor}-900/50 text-${riskColor}-300">${risk.risk_level || 'Unknown'} Risk</span>
                </div>
                
                ${risk.risk_factors?.length > 0 ? `
                <div class="mb-3">
                    <h5 class="font-bold text-red-300 text-sm mb-1">Risk Factors:</h5>
                    <ul class="list-disc list-inside text-sm text-white/80">
                        ${risk.risk_factors.map(factor => `<li>${factor}</li>`).join('')}
                    </ul>
                </div>` : ''}
                
                ${risk.mitigation_suggestions?.length > 0 ? `
                <div>
                    <h5 class="font-bold text-blue-300 text-sm mb-1">Mitigation Strategies:</h5>
                    <ul class="list-disc list-inside text-sm text-white/80">
                        ${risk.mitigation_suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                    </ul>
                </div>` : ''}
            </div>`;
        });
        risksHtml += `</div>`;
    } else {
        risksHtml += `<p class="text-center text-white/70 italic">No risk assessment data available.</p>`;
    }
    
    risksHtml += `</div>`;
    risksPanel.innerHTML = risksHtml;

    // --- 8. Learn Panel (Same content) ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Understanding Prescriptive Analytics</h3>
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">What is Prescriptive Analytics?</h4>
            <p class="text-sm text-white/80">Prescriptive analytics goes beyond predicting future outcomes (predictive analytics) to actually suggest specific actions a user can take to affect those outcomes. It answers the question: <strong>"What should we do about it?"</strong></p>
            <p class="text-sm text-white/80 mt-2">It often combines historical data, business rules, algorithms, machine learning, and simulations to recommend the optimal course of action for a given situation.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Key Differences:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>Descriptive:</strong> What happened? (Reports, Dashboards)</li>
                    <li><strong>Diagnostic:</strong> Why did it happen? (Root Cause Analysis)</li>
                    <li><strong>Predictive:</strong> What is likely to happen? (Forecasting, Likelihoods)</li>
                    <li><strong>Prescriptive:</strong> What should we *do*? (Recommendations, Optimization)</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">How it Works (Simplified):</h4>
                <ol class="list-decimal list-inside space-y-1 text-sm">
                    <li><strong>Goal Definition:</strong> Clearly state the business objective (e.g., increase sales, reduce churn).</li>
                    <li><strong>Data Analysis:</strong> Identify key factors (drivers) in historical data that influence the goal (Data Insights).</li>
                    <li><strong>Model Building:</strong> Use algorithms to explore how changing drivers affects the outcome.</li>
                    <li><strong>Recommendation Generation:</strong> Suggest specific actions (Prescriptions) based on the analysis.</li>
                    <li><strong>Outcome Estimation:</strong> Predict the likely result of taking the recommended actions.</li>
                </ol>
            </div>
        </div>

        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Components in This Tool:</h4>
            <ul class="list-disc list-inside space-y-1 text-sm text-white/80">
                <li><strong>Business Goal:</strong> Your specified objective.</li>
                <li><strong>Data Insights:</strong> Patterns found in your uploaded data relevant to the goal.</li>
                <li><strong>Prescriptions:</strong> Specific actions recommended by the AI, directly linked to the insights and goal.</li>
                <li><strong>Risk Assessment:</strong> Evaluation of potential implementation challenges and mitigation strategies.</li>
                <li><strong>Dataset Analysis:</strong> Comprehensive analysis of your data quality and structure.</li>
            </ul>
        </div>
    </div>`;

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Activate Listeners ---
    analysisCache[currentTemplateId] = container.innerHTML;
    $("analysisActions").classList.remove("hidden");

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");

                if (e.target.dataset.tab === "matrix") {
                    const chartDiv = $("matrixPlot");
                    if (chartDiv && chartDiv.layout && typeof Plotly !== 'undefined') {
                        try { Plotly.Plots.resize(chartDiv); } catch (e) { console.error("Resize error:", e); }
                    }
                }
            } else {
                console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    setTimeout(() => {
        const initialMatrixChart = $("matrixPlot");
        if (tabNav.querySelector(".analysis-tab-btn.active")?.dataset.tab === "matrix" &&
            initialMatrixChart && initialMatrixChart.layout && typeof Plotly !== 'undefined') {
            try { Plotly.Plots.resize(initialMatrixChart); } catch (e) { console.error("Initial resize error:", e); }
        }
    }, 150);

    setLoading("generate", false);
}


    async function handleActionPlansAnalysis_AP() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Generating Detailed Action Plan...</h3><p class="text-white/80 mb-2">Breaking down your context into actionable tasks...</p></div>`;
        setLoading("generate", true);

        // Define URL and Model
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";

        try {
            // 1. Gather Inputs
            const useDoc = $("docUpload").checked;
            let text = "";

            if (useDoc) {
                const file = $("actionPlanFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                text = await extractTextFromFile(file);
            } else {
                text = $("actionPlanContent").value.trim();
                if (!text.trim()) throw new Error("Please describe the objective for your action plan.");
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("actionLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
                console.log("Injected location into Action Plan Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (text.length > MAX_CONTEXT_LENGTH) {
                text = text.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
                console.warn(`Action Plan analysis context truncated.`);
            }

            // 2. Construct ENHANCED Prompt
            const prompt = `
                You are an expert project manager. Your task is to analyze the provided text, determine its intent, and formulate a high-level project plan with 5-7 sequential action items. Base this *only* on the provided text. ${truncatedNote}

                **USER'S TEXT:**
                \`\`\`
                ${text}
                \`\`\`

                **DETAILED TASKS (Follow this order):**
                **VALIDATION:**
                Check if the text describes a project/goal. If it is gibberish, return the INVALID structure.

                **Task 1: Determine Text Intent.**
                First, read the text to determine its intent.
                - Is it a **Dynamic System Problem** (contains "sales are falling", "growth stalled", "bottleneck", "we have a problem with...")?
                - OR is it a **Descriptive Company Profile / Strategic Plan** (listing services, differentiators, and goals, like "NexaFlow Capital" or "AquaGlow Skincare")?
                - OR is it **Unanalyzable** (a poem, a random story, a shopping list, or text with no clear factors, services, or problems)?

                **Task 2: Generate JSON based on Intent (Ground all answers *strictly* in the text):**

                **IF IT IS A DYNAMIC SYSTEM PROBLEM:**
                1.  **Project Name (\`project_name\`):** Define a name for the plan (e.g., "Resolving [The Problem]").
                2.  **Action Items (\`action_items\`):** Generate 5-7 sequential action items to *fix* the problem, based on the text. For each:
                    * \`task_name\`: Actionable name (e.g., "Audit Control Loops").
                    * \`description\`: What needs to be done, from text.
                    * \`owner\`: Team/role from text.
                    * \`timeline\`: Sequential timeline (e.g., "Week 1-2").
                    * \`priority\`: "High", "Medium", "Low" based on text.
                    * \`resources_needed\`: Resources mentioned in text.
                    * \`key_dependency\`: Previous task name (or null).
                    * \`kpis_to_track\`: 1-2 metrics for *this task*.

                **IF IT IS A DESCRIPTIVE COMPANY PROFILE:**
                1.  **Project Name (\`project_name\`):** Define a name for the plan (e.g., "Strategic Plan for [Company Name]").
                2.  **Action Items (\`action_items\`):** Generate 5-7 sequential action items based on the **"Core Services"**, **"Differentiators"**, or **"Proposed Solutions"** listed in the text.
                    * \`task_name\`: The service or differentiator to be amplified (e.g., "Scale NexaScore AI Engine", "Launch Retail-Ready Packaging").
                    * \`description\`: What this initiative involves, from text.
                    * \`owner\`: Team/role from text (e.g., "Product Development Team").
                    * \`timeline\`: Sequential timeline (e.g., "Phase 1").
                    * \`priority\`: "High", "Medium", "Low" based on text.
                    * \`resources_needed\`: Resources mentioned in text.
                    * \`key_dependency\`: Previous task name (or null).
                    * \`kpis_to_track\`: 1-2 metrics for *this task* (e.g., "NexaScore accuracy rate", "Retailer sell-through rate").

                **IF IT IS UNANALYZABLE:**
                1.  **Project Name (\`project_name\`):** A clear explanation of why the text cannot be analyzed (e.g., "The provided text appears to be a poem...").
                2.  **Action Items (\`action_items\`):** This MUST be an empty array [].
                
                **ABSOLUTE CONSTRAINTS:**
                - STICK TO THE TEXT. Do NOT invent information.
                - JSON format must be perfect.

                **RETURN FORMAT (Example for a Descriptive Profile):**
                {
                  "project_name": "Strategic Plan for NexaFlow Capital",
                  "action_items": [
                    {
                      "task_name": "Scale NexaScore AI Engine",
                      "description": "Expand the proprietary AI engine for real-time creditworthiness evaluation to new markets or data sources.",
                      "owner": "AI/Data Science Team",
                      "timeline": "Phase 1 (Months 1-6)",
                      "priority": "High",
                      "resources_needed": ["AI Talent", "Cloud Infrastructure", "New Data Partnerships"],
                      "key_dependency": null,
                      "kpis_to_track": ["NexaScore accuracy rate", "New client acquisition"]
                    },
                    {
                      "task_name": "Enhance DeFi Payments Platform",
                      "description": "Build on the existing cross-border DeFi payments service, focusing on stablecoin integrations and transparency.",
                      "owner": "Blockchain Team",
                      "timeline": "Phase 2 (Months 4-12)",
                      "priority": "Medium",
                      "resources_needed": ["Smart Contract Auditors", "Stablecoin Partnerships"],
                      "key_dependency": "Scale NexaScore AI Engine",
                      "kpis_to_track": ["Transaction Volume", "Settlement Time"]
                    }
                  ]
                }
            `;

            // 3. Send Request to Ollama
            console.log(`Sending ENHANCED Action Plan prompt (v3) to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: {
                        num_ctx: 32768
                    }
                })
            });

            if (!response.ok) {
                let errorBody = `API error ${response.status}`;
                try {
                    errorBody += `: ${await response.text()}`;
                } catch (e) {}
                throw new Error(errorBody);
            }

            const data = await response.json();
            let parsedData;
            console.log('Raw AI Response (Action Plan - SP):', data.response); // Log raw response
            try {
                parsedData = JSON.parse(data.response);
                // *** Refined Robust Validation ***
                console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced Action Plan SP v3) ---');
                console.log(JSON.stringify(parsedData, null, 2));
                console.log('------------------------------------');

                if (!parsedData || typeof parsedData !== 'object' ||
                    !parsedData.project_name || typeof parsedData.project_name !== 'string' ||
                    !Array.isArray(parsedData.action_items) || // Must be an array, even if empty

                    // Check for invalid state: must have actions IF project_name is not an error message
                    (!parsedData.project_name.toLowerCase().includes("analyz") && parsedData.action_items.length < 1) ||

                    // Check for valid state: must have NO actions IF project_name IS an error message
                    (parsedData.project_name.toLowerCase().includes("analyz") && parsedData.action_items.length > 0)
                ) {
                    if (!parsedData.project_name.toLowerCase().includes("analyz") && parsedData.action_items.length < 1) {
                        console.error("Validation Failed (Enhanced Action Plan SP v3): AI found a valid project but no actions.", parsedData);
                        throw new Error(`AI response structure is inconsistent. Found a project but no action items.`);
                    }
                }
                console.log(`Successfully parsed ENHANCED Action Plan (SP) JSON (v3) using ${MODEL_NAME}. Found ${parsedData.action_items.length} action items.`);

            } catch (e) {
                console.error(`Failed to parse/validate ENHANCED Action Plan (SP) JSON (v3) using ${MODEL_NAME}:`, data?.response, e);
                throw new Error(`Invalid JSON received or validation failed (Enhanced Action Plan SP v3): ${e.message}. See raw response in console.`);
            }

            // 4. Render Results
            renderActionPlansPage_AP(analysisResultContainer, parsedData); // Use the updated renderer

        } catch (error) {
            console.error(`Error in handleActionPlansAnalysis_AP (Enhanced v3) using ${MODEL_NAME}:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            // Ensure loading stops reliably
            if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
            }
        }
    }

function renderActionPlansPage_AP(container, data) {
        container.innerHTML = ""; // Clear loading

        // --- Validation for new fields ---
        if (!data || !data.project_name || !data.action_items) {
            console.error("Incomplete data passed to renderActionPlansPage_AP:", data);
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render Action Plan results.</div>`;
            $("analysisActions").classList.add("hidden");
            return;
        }

        // --- NEW CHECK FOR UNANALYZABLE TEXT ---
        // If the AI returns no action items and the project name contains "analyz", it's an error.
        if (data.action_items.length === 0 && data.project_name.toLowerCase().includes("analyz")) {
            console.warn("Data is unanalyzable. Displaying summary as error.");
            container.innerHTML = `<div class="p-4 text-center text-yellow-300">
                                     <h4 class="text-xl font-bold mb-3">Analysis Incomplete</h4>
                                     <p class="text-white/80">${data.project_name}</p>
                                     <p class="text-sm text-white/70 mt-2">Please try again with text describing a project, goal, or company plan.</p>
                                   </div>`;
            $("analysisActions").classList.add("hidden"); // Hide save buttons
            return; // Stop rendering
        }
        // --- END NEW CHECK ---

        const {
            project_name,
            action_items
        } = data;

        // --- Create Tab Navigation (Updated with MORE Tabs) ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="timeline"> Timeline View</button> <button class="analysis-tab-btn" data-tab="details"> Task Details</button>
            <button class="analysis-tab-btn" data-tab="resources"> Resources & Dependencies</button> <button class="analysis-tab-btn" data-tab="tracking"> Priorities & KPIs</button> <button class="analysis-tab-btn" data-tab="learn"> Learn Action Planning</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels (Updated with MORE Panels) ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="timelinePanel" class="analysis-tab-panel active"></div>
            <div id="detailsPanel" class="analysis-tab-panel"></div>
            <div id="resourcesPanel" class="analysis-tab-panel"></div> <div id="trackingPanel" class="analysis-tab-panel"></div> <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- 1. Populate Timeline Panel (Keep as is) ---
        const timelinePanel = $("timelinePanel");
        const sorted_action_items = [...action_items].sort((a, b) => {
            const getTimeValue = (timeline) => {
                timeline = String(timeline || '').toLowerCase(); // Ensure timeline is string
                if (timeline.includes('week')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 7;
                if (timeline.includes('month')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 30;
                if (timeline.includes('q')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 90;
                if (timeline.includes('sprint')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 14;
                if (timeline.includes('phase')) return parseInt(timeline.match(/\d+/)?.[0] || '0') * 100; // Give phases a high value
                return 9999;
            };
            return getTimeValue(a.timeline) - getTimeValue(b.timeline);
        });

        let timelineHtml = `<div class="p-4"><h2 class="text-3xl font-bold text-center mb-8">${project_name} - Timeline View</h2><div class="action-plan-container flex flex-col items-center">`;
        sorted_action_items.forEach((item) => {
            const priorityClass = `priority-${(item.priority || 'medium').toLowerCase()}`;
            let priorityIcon = "";
            if (item.priority === 'High') priorityIcon = "";
            else if (item.priority === 'Medium') priorityIcon = "";

            timelineHtml += `
                <div class="timeline-item">
                    <div class="timeline-dot" style="border-color: ${item.priority === 'High' ? '#ef4444' : item.priority === 'Medium' ? '#f97316' : '#3b82f6'};"></div>
                    <div class="timeline-content ${priorityClass}">
                        <p class="text-xs text-indigo-300 font-semibold">${item.timeline}</p>
                        <h4 class="text-lg font-bold">${item.task_name}</h4>
                        <p class="text-sm text-white/70"><strong>Owner:</strong> ${item.owner || 'N/A'}</p>
                        <p class="text-xs font-bold mt-1">${priorityIcon} Priority: ${item.priority}</p>
                    </div>
                </div>
            `;
        });
        timelineHtml += `</div></div>`;
        timelinePanel.innerHTML = timelineHtml;


        // --- 2. Populate Task Details Panel (Focus on Name, Desc, Owner, Timeline) ---
        const detailsPanel = $("detailsPanel");
        let detailsHtml = `<div class="p-4 space-y-6"><h2 class="text-3xl font-bold mb-6 text-center">${project_name} - Task Details</h2>`;
        if (action_items.length > 0) {
            action_items.forEach((item, index) => {
                detailsHtml += `
                    <div class="action-card bg-black/20 p-4 rounded-lg border-l-4 border-gray-500"> <h4 class="text-lg font-bold mb-2">${index + 1}. ${item.task_name}</h4>
                        <p class="text-sm text-white/80 mb-3">${item.description || 'No description.'}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs border-t border-white/10 pt-3">
                            <div><strong>Owner:</strong><br>${item.owner || 'N/A'}</div>
                            <div><strong>Timeline:</strong><br>${item.timeline || 'N/A'}</div>
                        </div>
                    </div>`;
            });
        } else {
            detailsHtml += `<p class="text-center text-white/70 italic">No action items were generated.</p>`;
        }
        detailsHtml += `</div>`;
        detailsPanel.innerHTML = detailsHtml;

        // --- 3. Populate Resources & Dependencies Panel (New) ---
        const resourcesPanel = $("resourcesPanel");
        let resourcesHtml = `<div class="p-4"><h2 class="text-3xl font-bold mb-6 text-center">${project_name} - Resources & Dependencies</h2>`;
        resourcesHtml += `<div class="overflow-x-auto">
                            <table class="coeff-table styled-table text-sm">
                                <thead><tr><th>Task Name</th><th>Resources Needed</th><th>Key Dependency</th></tr></thead>
                                <tbody>`;
        if (action_items.length > 0) {
            action_items.forEach((item) => {
                resourcesHtml += `<tr>
                                     <td class="font-semibold">${item.task_name}</td>
                                     <td class="text-white/80">${(item.resources_needed || []).join(', ') || 'N/A'}</td>
                                     <td class="text-white/70 italic">${item.key_dependency || 'None'}</td>
                                  </tr>`;
            });
        } else {
            resourcesHtml += `<tr><td colspan="3" class="text-center text-white/60 italic p-4">No resource or dependency information generated.</td></tr>`;
        }
        resourcesHtml += `</tbody></table></div></div>`;
        resourcesPanel.innerHTML = resourcesHtml;


        // --- 4. Populate Priorities & KPIs Panel (New) ---
        const trackingPanel = $("trackingPanel");
        let trackingHtml = `<div class="p-4"><h2 class="text-3xl font-bold mb-6 text-center">${project_name} - Priorities & KPIs</h2>`;
        trackingHtml += `<div class="overflow-x-auto">
                            <table class="coeff-table styled-table text-sm">
                                <thead><tr><th>Task Name</th><th>Priority</th><th>KPIs to Track</th></tr></thead>
                                <tbody>`;
        if (action_items.length > 0) {
            // Sort by priority High > Medium > Low for this view
            const priorityOrder = {
                'High': 1,
                'Medium': 2,
                'Low': 3
            };
            const sortedByPriority = [...action_items].sort((a, b) => (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4));

            sortedByPriority.forEach((item) => {
                let priorityColor = "text-blue-400"; // Low
                if (item.priority === 'High') priorityColor = "text-red-400";
                else if (item.priority === 'Medium') priorityColor = "text-yellow-400";

                trackingHtml += `<tr>
                                     <td class="font-semibold">${item.task_name}</td>
                                     <td><span class="font-bold ${priorityColor}">${item.priority}</span></td>
                                     <td class="text-white/80">${(item.kpis_to_track || []).join(', ') || 'N/A'}</td>
                                  </tr>`;
            });
        } else {
            trackingHtml += `<tr><td colspan="3" class="text-center text-white/60 italic p-4">No priority or KPI information generated.</td></tr>`;
        }
        trackingHtml += `</tbody></table></div></div>`;
        trackingPanel.innerHTML = trackingHtml;


        // --- 5. Populate Learn Action Planning Panel (Keep as is) ---
        const learnPanel = $("learnPanel");
        learnPanel.innerHTML = `
        <div class="p-6 space-y-6 text-white/90">
            <h3 class="text-2xl font-bold text-center mb-4"> Understanding Action Planning</h3>
            

[Image of a Gantt chart or project timeline]

            <div class="bg-black/20 p-4 rounded-lg">
                <h4 class="text-lg font-bold mb-2 text-indigo-300">What is an Action Plan?</h4>
                <p class="text-sm text-white/80">An action plan is a detailed document outlining the specific tasks, steps, resources, and timelines required to achieve a particular goal or objective. It bridges the gap between strategy and execution.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2">Key Components of an Action Item:</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Specific Task:</strong> What exactly needs to be done? (Verb-noun format is good, e.g., "Develop marketing brief").</li>
                        <li><strong>Owner:</strong> Who is responsible for ensuring the task is completed?</li>
                        <li><strong>Timeline/Due Date:</strong> When should the task be finished?</li>
                        <li><strong>Priority:</strong> How critical is this task relative to others? (High, Medium, Low).</li>
                        <li><strong>Resources:</strong> What is needed (budget, people, tools)?</li>
                        <li><strong>Dependencies:</strong> What other tasks must be completed first?</li>
                        <li><strong>Status/KPIs:</strong> How will completion or success be measured?</li>
                    </ul>
                </div>
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold mb-2">Why Create Action Plans?</h4>
                     <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Clarity & Direction:</strong> Provides a clear roadmap for execution.</li>
                        <li><strong>Accountability:</strong> Assigns responsibility for each task.</li>
                        <li><strong>Prioritization:</strong> Helps focus effort on the most important activities.</li>
                        <li><strong>Resource Planning:</strong> Identifies necessary resources upfront.</li>
                        <li><strong>Progress Tracking:</strong> Allows monitoring of progress towards the goal.</li>
                        <li><strong>Coordination:</strong> Facilitates collaboration by showing dependencies.</li>
                        <li><strong>Risk Management:</strong> Helps anticipate potential roadblocks.</li>
                     </ul>
                </div>
            </div>

            <details class="styled-details text-sm mt-4">
                <summary class="font-semibold">Tips for Effective Action Planning</summary>
                <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                    <p><strong>1. Start with SMART Objectives:</strong> Ensure the overall goal is Specific, Measurable, Achievable, Relevant, and Time-bound.</p>
                    <p><strong>2. Break Down Large Tasks:</strong> Decompose complex objectives into smaller, manageable action steps.</p>
                    <p><strong>3. Be Specific & Action-Oriented:</strong> Use clear verbs for task names.</p>
                    <p><strong>4. Assign Single Owners:</strong> Avoid shared responsibility where possible.</p>
                    <p><strong>5. Set Realistic Timelines:</strong> Consider dependencies and resource availability.</p>
                    <p><strong>6. Identify Dependencies Clearly:</strong> Understand the sequence of tasks.</p>
                    <p><strong>7. Define Success Metrics (KPIs):</strong> Know what 'done' looks like for each task.</p>
                    <p><strong>8. Review and Update Regularly:</strong> Action plans are living documents; adapt as needed.</p>
                </div>
            </details>
             <p class="text-xs text-center text-white/60 mt-4">This tool uses AI to generate a potential action plan structure based strictly on the objective you provided.</p>
        </div>
        `;

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        // --- Final Touches ---
        analysisCache[currentTemplateId] = container.innerHTML; // Cache result

        // Tab switching logic
        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                // Deactivate all
                tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

                // Activate clicked
                e.target.classList.add("active");
                const targetPanelId = e.target.dataset.tab + "Panel";
                const targetPanel = $(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.add("active");
                    // No Plotly charts expected in this tool
                } else {
                    console.warn("Target panel not found:", targetPanelId);
                }
            }
        });

        $("analysisActions").classList.remove("hidden"); // Show save buttons
        // setLoading('generate', false); // Handled in the calling function
    }

    async function handleSystemGoalsAnalysis() {
        const analysisResultContainer = $("analysisResult");
        analysisResultContainer.innerHTML = `
            <div class="text-center text-white/70 p-8">
                <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                <h3 class="text-xl font-semibold text-white mb-4">Formulating System-Aware Goals & Initiatives</h3>
                <p class="text-white/80 mb-2">Analyzing your context to identify strategic interventions...</p>
            </div>`;
        setLoading("generate", true);

        // Define URL and Model
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest"; // Consistent model


        try {
            // 1. Gather Inputs
            const useDoc = $("docUpload").checked;
            let text = "";

            if (useDoc) {
                const file = $("systemGoalsFile").files[0];
                if (!file) throw new Error("Please select a document to upload.");
                text = await extractTextFromFile(file);
            } else {
                text = $("systemGoalsContent").value.trim();
                if (!text.trim()) throw new Error("Please enter system information and desired outcome in the text area.");
            }

            // --- NEW: INJECT LOCATION ---
            const location = $("systemGoalsLocation").value.trim();
            if (location) {
                text = `Target Location/Region: ${location}\n\n${text}`;
                console.log("Injected location into System Goals Analysis prompt:", location);
            }
            // --- END NEW LOGIC ---

            // Truncate if necessary
            const MAX_CONTEXT_LENGTH = 15000;
            let truncatedNote = "";
            if (text.length > MAX_CONTEXT_LENGTH) {
                text = text.substring(0, MAX_CONTEXT_LENGTH);
                truncatedNote = `(Note: Analysis based on the first ${MAX_CONTEXT_LENGTH} characters.)`;
                console.warn(`System Goals analysis context truncated.`);
            }

            // 2. --- NEW ENHANCED PROMPT (v3 with UNANALYZABLE path) ---
            const prompt = `
                You are a master strategic consultant. Your task is to analyze the provided text, determine its intent, and formulate a high-level goal and strategic initiatives based *only* on the provided text. ${truncatedNote}

                **USER'S SYSTEM DESCRIPTION / GOAL CONTEXT:**
                \`\`\`
                ${text}
                \`\`\`

                **VALIDATION:**
                If the text is gibberish, return the INVALID structure.

                **DETAILED TASKS (Follow this order):**

                **Task 1: Determine Text Intent.**
                First, read the text to determine its intent.
                - Is it a **Dynamic System Problem** (contains "sales are falling", "growth stalled", "bottleneck", "we have a problem with...")?
                - OR is it a **Descriptive Company Profile** (listing services, features, and differentiators, like "NexaFlow Capital...")?
                - OR is it **Unanalyzable** (a poem, a random story, a shopping list, or text with no clear factors, services, or problems)?

                **Task 2: Generate JSON based on Intent (Ground all answers *strictly* in the text):**

                **IF IT IS A DYNAMIC SYSTEM PROBLEM:**
                1.  **System Goal (\`system_goal\`):** Refine the user's input into a single, measurable SMART goal to *fix the problem*.
                2.  **Key Loops (\`key_loops\`):** Identify the primary \`reinforcing_loop\` and \`balancing_loop\` *causing the problem*.
                3.  **Strategic Initiatives (\`strategic_initiatives\`):** Develop 2-3 initiatives to achieve the goal by *manipulating the identified loops* (e.g., "Strengthen R1", "Weaken B1"). For each:
                    * \`initiative_name\`: Action-oriented name.
                    * \`rationale\`: How it fixes the loop, based on text.
                    * \`objectives\`: 2-3 specific sub-objectives.
                    * \`kpis\`: 2-3 KPIs to track success.

                **IF IT IS A DESCRIPTIVE COMPANY PROFILE (like NexaFlow):**
                1.  **System Goal (\`system_goal\`):** Define a high-level strategic goal based on the company's description (e.g., "Achieve market leadership by leveraging core differentiators").
                2.  **Key Loops (\`key_loops\`):** This MUST be null or have empty loops, as no dynamic problem is described.
                3.  **Strategic Initiatives (\`strategic_initiatives\`):** Identify the 2-3 most important **"Differentiators"** or **"Core Services"** as initiatives. For each:
                    * \`initiative_name\`: The name of the differentiator (e.g., "Amplify NexaScore AI Engine").
                    * \`rationale\`: Why this is a key strategic initiative to *amplify* to achieve the goal (e.g., "This proprietary asset is the core driver of competitive advantage...").
                    * \`objectives\`: 2-3 objectives for *amplifying* this strength (e.g., "Expand NexaScore into new verticals...").
                    * \`kpis\`: 2-3 KPIs to track this amplification (e.g., "New client acquisition rate...").

                **IF IT IS UNANALYZABLE:**
                1.  **System Goal (\`system_goal\`):** A clear explanation of why the text cannot be analyzed.
                2.  **Key Loops (\`key_loops\`):** This MUST be null.
                3.  **Strategic Initiatives (\`strategic_initiatives\`):** This MUST be an empty array [].
                
                **ABSOLUTE CONSTRAINTS:**
                - STICK TO THE TEXT. Do NOT invent information.
                - If the text is descriptive, DO NOT invent feedback loops.
                - JSON format must be perfect.

                **RETURN FORMAT (Example for a Descriptive Profile):**
                {
                  "system_goal": "Achieve market leadership in FinTech by leveraging proprietary AI and blockchain technology.",
                  "key_loops": null,
                  "strategic_initiatives": [
                    {
                      "initiative_name": "Scale Proprietary NexaScore AI Engine",
                      "rationale": "This is the core differentiator. Scaling it amplifies the company's competitive advantage in AI-based credit scoring.",
                      "objectives": [
                        "Integrate new alternative data sets into the NexaScore model.",
                        "Market the NexaScore engine as a standalone B2B service.",
                        "Reduce credit risk scoring time by 30%."
                      ],
                      "kpis": ["NexaScore accuracy rate", "New B2B client acquisition", "Scoring time (ms)"]
                    },
                    {
                      "initiative_name": "Expand Cross-Border DeFi Payments",
                      "rationale": "Leverages the unique blockchain-audited transparency to build trust and capture a larger share of the cross-border market.",
                      "objectives": [
                        "Form partnerships with 3 new stablecoin providers.",
                        "Increase cross-border transaction volume by 50%."
                      ],
                      "kpis": ["Transaction Volume", "New Partnerships", "Customer Feedback on Transparency"]
                    }
                  ]
                }
            `;
            // --- END OF NEW PROMPT ---

            // 3. Send Request to Ollama
            console.log(`Sending ENHANCED System Goals prompt (v3) to ${MODEL_NAME}...`);
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    prompt: prompt,
                    stream: false,
                    format: "json",
                    options: {
                        num_ctx: 32768
                    }
                })
            });

            if (!response.ok) {
                let errorBody = `API error ${response.status}`;
                try {
                    errorBody += `: ${await response.text()}`;
                } catch (e) {}
                throw new Error(errorBody);
            }

            const data = await response.json();
            let parsedData;
            console.log('Raw AI Response (System Goals):', data.response); // Log raw response
            try {
                parsedData = JSON.parse(data.response);
                // *** Refined Robust Validation ***
                console.log('--- RAW AI JSON RESPONSE (Parsed - Enhanced System Goals v3) ---');
                console.log(JSON.stringify(parsedData, null, 2));
                console.log('------------------------------------');

                if (!parsedData || typeof parsedData !== 'object' ||
                    !parsedData.system_goal || typeof parsedData.system_goal !== 'string' ||
                    !Array.isArray(parsedData.strategic_initiatives) || // Must be an array, even if empty
                    // key_loops can be null, so we don't need to check it
                    
                    // Check for invalid state: must have initiatives IF goal is not an error message
                    (!parsedData.system_goal.toLowerCase().includes("analyz") && parsedData.strategic_initiatives.length < 1) ||
                    
                    // Check for valid state: must have NO initiatives IF goal IS an error message
                    (parsedData.system_goal.toLowerCase().includes("analyz") && parsedData.strategic_initiatives.length > 0)
                ) {
                    if (!parsedData.system_goal.toLowerCase().includes("analyz") && parsedData.strategic_initiatives.length < 1) {
                         console.error("Validation Failed (Enhanced System Goals v3): AI found a valid goal but no initiatives.", parsedData);
                         throw new Error(`AI response structure is inconsistent. Found a goal but no initiatives.`);
                    }
                }
                console.log(`Successfully parsed ENHANCED System Goals JSON (v3) using ${MODEL_NAME}. Found ${parsedData.strategic_initiatives.length} initiatives.`);


            } catch (e) {
                console.error(`Failed to parse/validate ENHANCED System Goals JSON (v3) using ${MODEL_NAME}:`, data?.response, e);
                throw new Error(`Invalid JSON received or validation failed (Enhanced System Goals v3): ${e.message}. See raw response in console.`);
            }

            // 4. Render Results
            renderSystemGoalsPage(analysisResultContainer, parsedData); // Use the updated renderer

        } catch (error) {
            console.error(`Error in handleSystemGoalsAnalysis (Enhanced v3) using ${MODEL_NAME}:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        } finally {
            // Ensure loading stops reliably
            if ($("generateSpinner") && !$("generateSpinner").classList.contains("hidden")) {
                setLoading("generate", false);
            }
        }
    }

function renderSystemGoalsPage(container, data) {
    container.innerHTML = ""; // Clear loading

    // --- Validation for new structure ---
    if (!data || !data.system_goal || !data.strategic_initiatives) {
        console.error("Incomplete data passed to renderSystemGoalsPage:", data);
        container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: Incomplete analysis data received. Cannot render System Goals results.</div>`;
        $("analysisActions").classList.add("hidden");
        return;
    }

    // --- NEW CHECK FOR UNANALYZABLE TEXT ---
    // If the AI returns no initiatives and the goal contains "analyz", it's an error.
    if (data.strategic_initiatives.length === 0 && data.system_goal.toLowerCase().includes("analyz")) {
        console.warn("Data is unanalyzable. Displaying summary as error.");
        container.innerHTML = `<div class="p-4 text-center text-yellow-300">
                                 <h4 class="text-xl font-bold mb-3">Analysis Incomplete</h4>
                                 <p class="text-white/80">${data.system_goal}</p>
                                 <p class="text-sm text-white/70 mt-2">Please try again with text describing a business, a system problem, or a research plan.</p>
                               </div>`;
        $("analysisActions").classList.add("hidden"); // Hide save buttons
        return; // Stop rendering
    }
    // --- END NEW CHECK ---


    const { system_goal, key_loops, strategic_initiatives } = data;
    
    // --- START FIX ---
    // Check if key_loops and its properties exist before trying to access them
    const hasLoops = key_loops && key_loops.reinforcing_loop && key_loops.balancing_loop;
    const reinforcing_loop = hasLoops ? key_loops.reinforcing_loop : null;
    const balancing_loop = hasLoops ? key_loops.balancing_loop : null;
    // --- END FIX ---


    // --- Create Tab Navigation (Updated) ---
    const tabNav = document.createElement("div");
    tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
    tabNav.innerHTML = `
        <button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button>
        ${hasLoops ? '<button class="analysis-tab-btn" data-tab="map"> Strategic Map</button>' : ''}
        <button class="analysis-tab-btn" data-tab="initiatives"> Initiatives & KPIs</button>
        <button class="analysis-tab-btn" data-tab="learn"> Learn System Goals</button>
    `;
    container.appendChild(tabNav);

    // --- Create Tab Panels (Updated) ---
    const tabContent = document.createElement("div");
    container.appendChild(tabContent);
    tabContent.innerHTML = `
        <div id="dashboardPanel" class="analysis-tab-panel active"></div>
        ${hasLoops ? '<div id="mapPanel" class="analysis-tab-panel"></div>' : ''}
        <div id="initiativesPanel" class="analysis-tab-panel"></div>
        <div id="learnPanel" class="analysis-tab-panel"></div>
    `;

    // --- 1. Populate Dashboard Panel (Updated) ---
    const dashboardPanel = $("dashboardPanel");
    let dashboardHtml = `<div class="p-4 space-y-8">
        <div class="p-6 rounded-lg bg-black/20 border border-white/10 text-center">
            <h3 class="text-xl font-bold mb-2 text-indigo-300"> Overarching System Goal</h3>
            <p class="text-2xl italic text-white/90">${system_goal}</p>
        </div>`;

    // --- START FIX ---
    // Only show the "Key System Dynamics" section if loops were actually found
    if (hasLoops) {
        dashboardHtml += `
            <h3 class="text-2xl font-bold text-center">Key System Dynamics Affecting Goal</h3>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-black/20 p-4 rounded-lg border-l-4 border-green-400">
                    <h4 class="text-lg font-bold flex items-center gap-2"> ${reinforcing_loop.name} <span class="text-xs font-light text-white/60">(Reinforcing)</span></h4>
                    <p class="text-sm text-white/80 my-3 italic">${reinforcing_loop.description}</p>
                    <div class="text-xs text-white/60"><strong>Elements:</strong> ${reinforcing_loop.elements.join(", ")}</div>
                </div>
                <div class="bg-black/20 p-4 rounded-lg border-l-4 border-yellow-400">
                     <h4 class="text-lg font-bold flex items-center gap-2"> ${balancing_loop.name} <span class="text-xs font-light text-white/60">(Balancing)</span></h4>
                    <p class="text-sm text-white/80 my-3 italic">${balancing_loop.description}</p>
                    <div class="text-xs text-white/60"><strong>Elements:</strong> ${balancing_loop.elements.join(", ")}</div>
                </div>
            </div>`;
    } else {
        // Show this if it's a descriptive profile (like NexaFlow)
        dashboardHtml += `<p class="text-center text-white/70 italic">No dynamic feedback loops (problems) were identified; analysis is focused on amplifying core strengths.</p>`;
    }
    // --- END FIX ---

    dashboardHtml += `<h3 class="text-2xl font-bold text-center mt-6">Strategic Initiatives Overview</h3>
         <div class="grid grid-cols-1 md:grid-cols-${Math.min(strategic_initiatives.length, 3)} gap-6">`; // Adjust columns
    strategic_initiatives.forEach(init => {
        dashboardHtml += `<div class="summary-stat-card text-left p-4">
                                     <p class="font-bold text-lg text-white mb-2">${init.initiative_name}</p>
                                     <p class="text-xs text-indigo-300 italic mb-2">${init.rationale}</p>
                                     <p class="text-xs text-white/70">Objectives: ${init.objectives.length}</p>
                                  </div>`;
    });
    dashboardHtml += `</div>
    </div>`; // Close p-4 space-y-8
    dashboardPanel.innerHTML = dashboardHtml;


    // --- 2. Populate Strategic Map Panel (Only if loops exist) ---
    // --- START FIX ---
    if (hasLoops) {
        const mapPanel = $("mapPanel");
        let mapHtml = `<div class="strategy-map-container p-4">
                    <div class="p-4 rounded-lg bg-black/20 border border-white/10 text-center w-full max-w-lg">
                        <h3 class="text-lg font-bold text-indigo-300"> GOAL</h3>
                        <p class="text-2xl italic text-white/90">${system_goal}</p>
                    </div>
                    <div class="vertical-connector"></div>
                    <div class="feedback-loops-grid">
                        <div id="reinforcing-box" class="bg-black/20 p-4 rounded-lg border-2 border-green-400/50 text-center flex flex-col justify-between h-full">
                            <h4 class="text-lg font-bold"> Growth Engine</h4>
                            <p class="text-sm text-white/80 my-2">${reinforcing_loop.name}<br><span class="text-xs italic">${reinforcing_loop.description.substring(0,100)}...</span></p>
                        </div>
                        <div id="balancing-box" class="bg-black/20 p-4 rounded-lg border-2 border-yellow-400/50 text-center flex flex-col justify-between h-full">
                            <h4 class="text-lg font-bold"> Limiting Factor</h4>
                            <p class="text-sm text-white/80 my-2">${balancing_loop.name}<br><span class="text-xs italic">${balancing_loop.description.substring(0,100)}...</span></p>
                        </div>
                    </div>
                    <div class="lines-to-interventions">
                        <h3 class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold text-white z-10 bg-gray-900 px-4 py-2 rounded">Strategic Interventions</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-${strategic_initiatives.length} gap-8 w-full max-w-4xl mt-4">`; // Use actual count

        strategic_initiatives.forEach((initiative) => {
            // Simple indicator logic based on rationale text
            const strengthensReinforcing = initiative.rationale.toLowerCase().includes("strengthen") && initiative.rationale.toLowerCase().includes(reinforcing_loop.name.split(':')[0]);
            const weakensBalancing = (initiative.rationale.toLowerCase().includes("weaken") || initiative.rationale.toLowerCase().includes("address")) && initiative.rationale.toLowerCase().includes(balancing_loop.name.split(':')[0]);

            let indicatorHtml = "";
            if (strengthensReinforcing && weakensBalancing) {
                indicatorHtml = `<div class="initiative-target-indicator flex items-center justify-center gap-1"><span class="indicator-boost"></span><span class="indicator-mitigate"></span></div>`;
            } else if (strengthensReinforcing) {
                indicatorHtml = `<div class="initiative-target-indicator indicator-boost"></div>`;
            } else if (weakensBalancing) {
                indicatorHtml = `<div class="initiative-target-indicator indicator-mitigate"></div>`;
            }

            mapHtml += `<div class="relative pt-8">
                        ${indicatorHtml}
                        <div class="bg-black/20 p-4 rounded-lg h-full border border-white/10 flex items-center justify-center text-center">
                            <h4 class="text-md font-bold text-white/90">${initiative.initiative_name}</h4>
                        </div>
                    </div>`;
        });

        mapHtml += `</div></div>`;
        mapPanel.innerHTML = mapHtml;
    }
    // --- END FIX ---


    // --- 3. Populate Initiatives & KPIs Panel (Updated) ---
    const initiativesPanel = $("initiativesPanel");
    let initiativesHtml = `<div class="p-4 space-y-6">`;
    strategic_initiatives.forEach((initiative, index) => {
        initiativesHtml += `
            <div class="prescription-card border-l-4 border-blue-500">
                <h3 class="text-2xl font-bold mb-2">Initiative ${index + 1}: ${initiative.initiative_name}</h3>
                <p class="rationale"><strong>Rationale:</strong> ${initiative.rationale}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                    <div class="bg-black/20 p-3 rounded">
                        <h5 class="font-bold text-yellow-300 mb-2">Specific Objectives</h5>
                        <ul class="list-disc list-inside space-y-1 text-white/90">${initiative.objectives.map((obj) => `<li>${obj}</li>`).join("")}</ul>
                    </div>
                    <div class="bg-black/20 p-3 rounded">
                        <h5 class="font-bold text-green-300 mb-2">KPIs to Track</h5>
                        <ul class="list-disc list-inside space-y-1 text-white/90">${initiative.kpis.map((kpi) => `<li>${kpi}</li>`).join("")}</ul>
                    </div>
                </div>
            </div>
        `;
    });
    initiativesHtml += `</div>`;
    initiativesPanel.innerHTML = initiativesHtml;


    // --- 4. Populate Learn System Goals Panel (New) ---
    const learnPanel = $("learnPanel");
    learnPanel.innerHTML = `
    <div class="p-6 space-y-6 text-white/90">
        <h3 class="text-2xl font-bold text-center mb-4"> Setting Goals in a Systems Context</h3>
        
        <div class="bg-black/20 p-4 rounded-lg">
            <h4 class="text-lg font-bold mb-2 text-indigo-300">Why System Goals?</h4>
            <p class="text-sm text-white/80">Traditional goal setting often focuses on isolated metrics. System goals consider the interconnected nature of the organization. They aim to influence the underlying structure (feedback loops, delays, stocks, flows) to achieve desired outcomes sustainably, rather than just treating symptoms.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">Connecting Goals to Loops:</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>Identify Dynamics:</strong> First, understand the key reinforcing (growth) and balancing (limiting) loops driving current behavior related to your desired outcome.</li>
                    <li><strong>Target Loops:</strong> Frame your goal and subsequent initiatives around manipulating these loops.
                        <ul class="list-[circle] list-inside pl-4 text-xs">
                           <li>To accelerate growth? -> Strengthen the reinforcing loop(s).</li>
                           <li>To overcome constraints? -> Weaken the balancing loop(s) or increase their limits.</li>
                           <li>To stabilize fluctuations? -> Strengthen balancing loops or add delays to reinforcing loops.</li>
                        </ul>
                    </li>
                    <li><strong>Anticipate Side Effects:</strong> Consider how interventions might affect *other* parts of the system or create new loops.</li>
                </ul>
            </div>
            <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                <h4 class="text-lg font-bold mb-2">From Goal to Action (System View):</h4>
                 <ol class="list-decimal list-inside space-y-1 text-sm">
                    <li><strong>Define System Goal:</strong> High-level desired state, considering system dynamics.</li>
                    <li><strong>Analyze Loops:</strong> Identify key R & B loops influencing the goal.</li>
                    <li><strong>Identify Leverage Points:</strong> Find where interventions will be most effective on the loops.</li>
                    <li><strong>Develop Initiatives:</strong> Design actions specifically targeting those leverage points to manipulate loops.</li>
                    <li><strong>Define Objectives:</strong> Break initiatives into smaller, measurable steps.</li>
                    <li><strong>Select KPIs:</strong> Choose metrics that track both initiative progress *and* the behavior of the targeted loops/elements.</li>
                    <li><strong>Monitor & Adapt:</strong> Observe system behavior and adjust interventions as needed.</li>
                 </ol>
            </div>
        </div>

        <details class="styled-details text-sm mt-4">
            <summary class="font-semibold">Example: Reducing Customer Churn</summary>
            <div class="bg-black/20 p-4 rounded-b-lg space-y-2">
                <p><strong>Traditional Goal:</strong> Reduce churn by 15%.</p>
                <p><strong>System Goal:</strong> Reduce churn by 15% by strengthening the 'Customer Loyalty' (R) loop and weakening the 'Support Strain' (B) loop.</p>
                <p><strong>Initiative (Strengthen R):</strong> Improve product onboarding -> increases satisfaction -> increases loyalty.</p>
                <p><strong>Initiative (Weaken B):</strong> Increase support staff -> increases capacity -> maintains service quality under load -> reduces frustration -> reduces churn.</p>
                <p class="text-xs italic mt-2">Notice how initiatives explicitly link to loop manipulation.</p>
            </div>
        </details>
    </div>
    `;

    // --- NEW: Animate the new content ---
    const newElementsToAnimate = container.querySelectorAll(
        '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
    );
    animateElements(newElementsToAnimate);

    // --- Final Touches ---
    analysisCache[currentTemplateId] = container.innerHTML; // Cache result

    // Tab switching logic
    tabNav.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
            // Deactivate all
            tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
            tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));

            // Activate clicked
            e.target.classList.add("active");
            const targetPanelId = e.target.dataset.tab + "Panel";
            const targetPanel = $(targetPanelId);
            if (targetPanel) {
                targetPanel.classList.add("active");
                // No Plotly charts expected in this tool, so no resize needed
            } else {
                console.warn("Target panel not found:", targetPanelId);
            }
        }
    });

    $("analysisActions").classList.remove("hidden"); // Show save buttons
    // setLoading('generate', false); // Handled in the calling function
}

   async function handleMiscAnalysis_MSC() {
        const analysisResultContainer = document.getElementById("analysisResult");
        analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8">
                                                <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                                                <h3 class="text-xl font-semibold text-white mb-4">Step 1/2: Gathering Strategic Context...</h3>
                                                <p class="text-white/80 mb-2">Connecting to n8n workflow for external insights...</p>
                                                <p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p>
                                            </div>`;
        setLoading("generate", true);

        // Reset State
        pendingOllamaResult = null;
        pendingN8nResult = null;
        currentAnalysisMessageId = `analysis_${Date.now()}`;
        currentAnalysisContext = null;

        const n8nFormData = new FormData();

        try {
            // 1. Gather Inputs
            const useDoc = document.getElementById("docUpload").checked;
            let text = "";

            const companyNameEl = document.getElementById("miscCompanyName");
            const locationEl = document.getElementById("miscLocation");

            const companyName = companyNameEl ? companyNameEl.value.trim() : "The organization";
            const location = locationEl ? locationEl.value.trim() : "unspecified location";

            if (useDoc) {
                // File Mode
                const file = document.getElementById("miscFile").files[0];
                if (!file) throw new Error("Please select a document.");
                text = await extractTextFromFile(file);
                n8nFormData.append("file", file, file.name);
            } else {
                // Text Mode (Virtual File)
                text = document.getElementById("miscContent").value.trim();
                if (!text) throw new Error("Please provide your document content.");
                const textBlob = new Blob([text], { type: 'text/plain' });
                n8nFormData.append("file", textBlob, "context_input.txt");
                n8nFormData.append("miscContent", text); 
            }

            // Metadata
            n8nFormData.append("customerName", companyName);
            n8nFormData.append("location", location);
            n8nFormData.append("messageId", currentAnalysisMessageId);

            // Save Context for Step 2 (Ollama Cascade)
            currentAnalysisContext = `Company: ${companyName}\nLocation: ${location}\n\nDocument Content:\n${text}`;

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) throw new Error("Please log in.");

            // 2. Trigger N8N Workflow WITH RETRY LOGIC
            const N8N_URL = "https://n8n.data2int.com/webhook/Strategic-Planning"; 
            
            console.log(`Sending data to n8n workflow at ${N8N_URL}...`);

            let response;
            let attempts = 0;
            const maxAttempts = 2; // Try twice
            let success = false;
            let lastErrorText = "";

            while (attempts < maxAttempts && !success) {
                try {
                    attempts++;
                    if (attempts > 1) console.log(`Retry attempt ${attempts} for n8n workflow...`);

                    response = await fetch(N8N_URL, {
                        method: "POST",
                        headers: { 'Authorization': `Bearer ${session.access_token}` },
                        body: n8nFormData // Note: FormData can be reused in fetch
                    });

                    if (response.ok) {
                        success = true;
                    } else {
                        // If it's a 500 error, we throw to trigger the catch block and retry
                        const errText = await response.text();
                        if (response.status === 500) {
                            lastErrorText = errText;
                            throw new Error(`Server 500: ${errText}`);
                        } else {
                            // If it's 400/401/etc, don't retry, just fail
                            throw new Error(`n8n Trigger Error: ${response.status} - ${errText}`);
                        }
                    }
                } catch (err) {
                    console.warn(`Attempt ${attempts} failed:`, err);
                    if (attempts >= maxAttempts) {
                        // If we are out of attempts, throw the error to the main catch block
                        throw new Error(`n8n Workflow failed after ${maxAttempts} attempts. Last error: ${lastErrorText || err.message}`);
                    }
                    // Wait 1 second before retrying to allow n8n to stabilize
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            // Workflow triggered successfully. 
            console.log("n8n Workflow triggered successfully.");
            // The logic now pauses here. 
            // 'handleWebSocketMessage' will pick up the response when n8n finishes.

        } catch (error) {
            console.error(`Error in handleMiscAnalysis_MSC:`, error);
            analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400"> An error occurred: ${error.message}</div>`;
            setLoading("generate", false);
        }
    }

    function renderMiscPage_MSC(container, data) {
        container.innerHTML = ""; // Clear loading

        if (!data) {
            container.innerHTML = `<div class="p-4 text-center text-red-400"> Error: No strategic plan data received.</div>`;
            return;
        }
        
        const safe = (val, def) => val || def;
        
        const external = data.external_data || {};
        const bookSummary = safe(external.book_summary, "No book summary available.");
        const webSummary = safe(external.web_summary, "No web summary available.");
        const refLinks = Array.isArray(external.reference_links) ? external.reference_links : [];

        // --- Create Tab Navigation (14 Tabs) ---
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `
            <button class="analysis-tab-btn active" data-tab="introduction"> Intro</button>
            <button class="analysis-tab-btn" data-tab="overview"> Overview</button>
            <button class="analysis-tab-btn" data-tab="mission"> Mission & Vision</button>
            <button class="analysis-tab-btn" data-tab="goals">G Goals</button>
            <button class="analysis-tab-btn" data-tab="initiatives">S Initiatives</button>
            <button class="analysis-tab-btn" data-tab="objectives">O Objectives</button>
            <button class="analysis-tab-btn" data-tab="action"> Action Plan</button>
            <button class="analysis-tab-btn" data-tab="risks"> Risks</button>
            <button class="analysis-tab-btn" data-tab="governance"> Governance</button>
            <button class="analysis-tab-btn" data-tab="novel"> Novel Strategy</button>
            <button class="analysis-tab-btn" data-tab="conclusion"> Conclusion</button>
            <button class="analysis-tab-btn" data-tab="summary"> Summary</button>
            <button class="analysis-tab-btn" data-tab="references"> References</button>
            <button class="analysis-tab-btn" data-tab="learn"> Learn</button>
        `;
        container.appendChild(tabNav);

        // --- Create Tab Panels ---
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `
            <div id="introductionPanel" class="analysis-tab-panel active"></div>
            <div id="overviewPanel" class="analysis-tab-panel"></div>
            <div id="missionPanel" class="analysis-tab-panel"></div>
            <div id="goalsPanel" class="analysis-tab-panel"></div>
            <div id="initiativesPanel" class="analysis-tab-panel"></div>
            <div id="objectivesPanel" class="analysis-tab-panel"></div>
            <div id="actionPanel" class="analysis-tab-panel"></div>
            <div id="risksPanel" class="analysis-tab-panel"></div>
            <div id="governancePanel" class="analysis-tab-panel"></div>
            <div id="novelPanel" class="analysis-tab-panel"></div>
            <div id="conclusionPanel" class="analysis-tab-panel"></div>
            <div id="summaryPanel" class="analysis-tab-panel"></div>
            <div id="referencesPanel" class="analysis-tab-panel"></div>
            <div id="learnPanel" class="analysis-tab-panel"></div>
        `;

        // --- Populate Panels ---
        
        // 1-8. Standard Sections (Reuse existing logic)
        document.getElementById("introductionPanel").innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Introduction</h3><div class="p-4 border-l-4 border-gray-500 bg-black/20 text-white/90 whitespace-pre-wrap leading-relaxed">${safe(data.introduction, "N/A")}</div></div>`;
        document.getElementById("overviewPanel").innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Executive Overview</h3><div class="p-4 border-l-4 border-blue-500 bg-black/20 text-white/90 whitespace-pre-wrap leading-relaxed">${safe(data.executive_overview, "N/A")}</div></div>`;
        
        document.getElementById("missionPanel").innerHTML = `
            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-black/20 p-6 rounded-lg border-l-4 border-indigo-400">
                    <h4 class="text-xl font-bold text-indigo-300 mb-3">Mission</h4>
                    <p class="text-white/90 italic">${safe(data.mission_statement, "N/A")}</p>
                </div>
                <div class="bg-black/20 p-6 rounded-lg border-l-4 border-green-400">
                    <h4 class="text-xl font-bold text-green-300 mb-3">Vision</h4>
                    <p class="text-white/90 italic">${safe(data.vision_statement, "N/A")}</p>
                </div>
            </div>`;

        let goalsHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4">Strategic Goals</h3>`;
        (data.strategic_goals || []).forEach((g, i) => {
            goalsHtml += `<div class="bg-black/20 p-6 rounded-lg border-l-4 border-green-400">
                <div class="flex items-center mb-2"><span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 font-bold">${i+1}</span><h4 class="text-xl font-bold text-green-300">${g.goal_name}</h4></div>
                <p class="text-white/90 mb-2"><strong>Description:</strong> ${g.description}</p>
                <p class="text-white/80 text-sm"><strong>Rationale:</strong> ${g.rationale}</p>
            </div>`;
        });
        document.getElementById("goalsPanel").innerHTML = goalsHtml + `</div>`;

        let initHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4">Strategic Initiatives</h3>`;
        (data.strategic_initiatives || []).forEach((init, i) => {
             initHtml += `<div class="bg-black/20 p-6 rounded-lg border-l-4 border-yellow-400">
                <div class="flex items-center mb-2"><span class="bg-yellow-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 font-bold">${i+1}</span><h4 class="text-xl font-bold text-yellow-300">${init.initiative_name}</h4></div>
                <p class="text-white/90 mb-2"><strong>Description:</strong> ${init.description}</p>
                <p class="text-white/80 text-sm"><strong>Importance:</strong> ${init.strategic_importance}</p>
            </div>`;
        });
        document.getElementById("initiativesPanel").innerHTML = initHtml + `</div>`;

        let objHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4">Measurable Objectives</h3>`;
        (data.objectives || []).forEach((o, i) => {
             objHtml += `<div class="bg-black/20 p-6 rounded-lg border-l-4 border-blue-400">
                <h4 class="text-xl font-bold text-blue-300 mb-3">${o.objective_name}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div><strong>Target:</strong> ${o.target}</div>
                    <div><strong>Timeline:</strong> ${o.timeline}</div>
                    <div><strong>Measurement:</strong> ${o.measurement}</div>
                </div>
            </div>`;
        });
        document.getElementById("objectivesPanel").innerHTML = objHtml + `</div>`;

        let actHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4">Action Plan</h3>`;
        (data.action_plan || []).forEach((a, i) => {
             actHtml += `<div class="bg-black/20 p-6 rounded-lg border-l-4 border-red-400">
                <h4 class="text-xl font-bold text-red-300 mb-2">${a.action_item}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div><strong>Responsible:</strong> ${a.responsible_party}</div>
                    <div><strong>Deadline:</strong> ${a.deadline}</div>
                    <div><strong>Priority:</strong> ${a.priority}</div>
                </div>
            </div>`;
        });
        document.getElementById("actionPanel").innerHTML = actHtml + `</div>`;

        let riskHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4">Risk Management</h3>`;
        (data.risk_management || []).forEach((r, i) => {
             riskHtml += `<div class="bg-black/20 p-6 rounded-lg border-l-4 border-orange-400">
                <h4 class="text-xl font-bold text-orange-300 mb-2">Risk: ${r.risk_description}</h4>
                <p class="text-white/90 mb-2"><strong>Impact:</strong> ${r.impact}</p>
                <p class="text-white/80 text-sm"><strong>Mitigation:</strong> ${r.mitigation_strategy}</p>
            </div>`;
        });
        document.getElementById("risksPanel").innerHTML = riskHtml + `</div>`;

        // --- NEW SECTIONS ---
        
        // 9. Governance
        document.getElementById("governancePanel").innerHTML = `<div class="p-4">
            <h3 class="text-2xl font-bold mb-4"> Governance Structure</h3>
            <div class="p-6 border-l-4 border-teal-400 bg-black/20 text-white/90 whitespace-pre-wrap leading-relaxed">
                ${safe(data.governance, "Governance details not provided.")}
            </div>
        </div>`;

        // 10. Novel Strategy
        document.getElementById("novelPanel").innerHTML = `<div class="p-4">
            <h3 class="text-2xl font-bold mb-4"> Novel & Disruptive Strategy</h3>
            <div class="p-6 border-l-4 border-pink-400 bg-black/20 text-white/90 whitespace-pre-wrap leading-relaxed">
                ${safe(data.novel_strategy, "Novel strategy suggestions not provided.")}
            </div>
        </div>`;

        // 11. Conclusion
        document.getElementById("conclusionPanel").innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Conclusion</h3><div class="p-4 border-l-4 border-gray-500 bg-black/20 text-white/90 whitespace-pre-wrap leading-relaxed">${safe(data.conclusion, "N/A")}</div></div>`;

        // 12. Summary
        document.getElementById("summaryPanel").innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Plan Summary</h3><div class="p-4 border-l-4 border-purple-500 bg-black/20 text-white/90 whitespace-pre-wrap leading-relaxed">${safe(data.summary, "N/A")}</div></div>`;

        // 13. References
        document.getElementById("referencesPanel").innerHTML = `
            <div class="p-4 space-y-6">
                <h3 class="text-2xl font-bold mb-4"> External References & Context</h3>
                <div class="glass-container p-6 border-l-4 border-blue-400">
                    <h4 class="text-xl font-bold mb-3 text-blue-300"> Primary Source (Book Summary)</h4>
                    <p class="text-white/80 whitespace-pre-wrap">${bookSummary}</p>
                </div>
                <div class="glass-container p-6 border-l-4 border-purple-400">
                    <h4 class="text-xl font-bold mb-3 text-purple-300"> Supporting Source (Web Summary)</h4>
                    <p class="text-white/80 whitespace-pre-wrap">${webSummary}</p>
                </div>
                <div class="glass-container p-6">
                    <h4 class="text-xl font-bold mb-3">External Reference Links</h4>
                    <ul class="list-disc list-inside text-blue-300">
                        ${refLinks.length > 0 ? refLinks.map(l => `<li><a href="${l}" target="_blank" class="hover:underline">${l}</a></li>`).join('') : '<li class="text-white/60 italic">No links found.</li>'}
                    </ul>
                </div>
            </div>`;

        // 14. Learn (ENHANCED)
        document.getElementById("learnPanel").innerHTML = `
        <div class="p-6 space-y-6 text-white/90 glass-container">
            <h3 class="text-2xl font-bold text-center mb-6"> The Strategic Planning Framework</h3>
            
            <div class="bg-black/20 p-4 rounded-lg mb-6">
                <h4 class="text-lg font-bold text-indigo-300 mb-2">Why this Structure?</h4>
                <p class="text-sm text-white/80">A complete strategic plan bridges the gap between where you are now (Overview) and where you want to be (Vision), providing a concrete roadmap (Action Plan) and controls (Governance) to get there.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold text-blue-300 mb-2">1. Foundation</h4>
                    <ul class="space-y-2 text-sm">
                        <li><strong>Mission:</strong> Why we exist (Present tense).</li>
                        <li><strong>Vision:</strong> Where we are going (Future tense).</li>
                        <li><strong>Executive Overview:</strong> The "Elevator Pitch" of the strategy.</li>
                    </ul>
                </div>

                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold text-green-300 mb-2">2. Core Strategy</h4>
                    <ul class="space-y-2 text-sm">
                        <li><strong>Strategic Goals:</strong> Broad, long-term outcomes (3-5 years).</li>
                        <li><strong>Strategic Initiatives:</strong> Major programs to achieve goals.</li>
                        <li><strong>Novel Strategy:</strong> Disruptive or innovative moves to gain competitive advantage.</li>
                    </ul>
                </div>

                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold text-yellow-300 mb-2">3. Execution</h4>
                    <ul class="space-y-2 text-sm">
                        <li><strong>Objectives:</strong> Specific, measurable targets (SMART).</li>
                        <li><strong>Action Plan:</strong> Concrete steps, owners, and deadlines.</li>
                        <li><strong>Governance:</strong> Who decides what? How is progress tracked?</li>
                    </ul>
                </div>

                <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                    <h4 class="text-lg font-bold text-red-300 mb-2">4. Protection</h4>
                    <ul class="space-y-2 text-sm">
                        <li><strong>Risk Management:</strong> Identifying pitfalls and mitigation plans.</li>
                        <li><strong>References:</strong> External validation and data sources (RAG).</li>
                    </ul>
                </div>
            </div>

            <div class="bg-black/20 p-4 rounded-lg mt-4 border-l-4 border-pink-400">
                <h4 class="text-lg font-bold text-pink-300 mb-2"> What is "Novel Strategy"?</h4>
                <p class="text-sm text-white/80">Most strategic plans are "Business as Usual" (BAU) optimizations. A <strong>Novel Strategy</strong> challenges industry assumptions. It asks: "What can we do that no one else is doing?" This section forces you to look beyond incremental improvement toward innovation.</p>
            </div>
        </div>
        `;

        const newElementsToAnimate = container.querySelectorAll('.glass-container, .prescription-card, .insight-card');
        animateElements(newElementsToAnimate);
        document.getElementById("analysisActions").classList.remove("hidden");

        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach(btn => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach(pnl => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanel = document.getElementById(e.target.dataset.tab + "Panel");
                if (targetPanel) targetPanel.classList.add("active");
            }
        });
    }


   function renderArchetypeAnalysisPage(container, data) {
        container.innerHTML = "";
        const { concepts, topArchetypes, topLeveragePoints } = data;
        const tabNav = document.createElement("div");
        tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
        tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="concepts"> Concepts</button><button class="analysis-tab-btn" data-tab="network"> Network</button><button class="analysis-tab-btn" data-tab="archetypes"> Archetypes</button><button class="analysis-tab-btn" data-tab="leverage"> Leverage Points</button>`;
        container.appendChild(tabNav);
        const tabContent = document.createElement("div");
        container.appendChild(tabContent);
        tabContent.innerHTML = `<div id="conceptsPanel" class="analysis-tab-panel active"></div><div id="networkPanel" class="analysis-tab-panel"></div><div id="archetypesPanel" class="analysis-tab-panel"></div><div id="leveragePanel" class="analysis-tab-panel"></div>`;
        renderConceptsTab(concepts, "conceptsPanel");
        renderNetworkTab(concepts, "networkPanel");
        renderArchetypesTab(topArchetypes, "archetypesPanel");
        renderLeveragePointsTab(topLeveragePoints, "leveragePanel");

        // --- NEW: Animate the new content ---
        const newElementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card, .plotly-chart, .styled-table'
        );
        animateElements(newElementsToAnimate);

        analysisCache[currentTemplateId] = container.innerHTML;

        tabNav.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
                tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                e.target.classList.add("active");
                const targetPanel = $(e.target.dataset.tab + "Panel");
                targetPanel.classList.add("active");
                const chart = targetPanel.querySelector(".plotly-chart");
                if (chart) Plotly.Plots.resize(chart);
            }
        });
    }

    function renderConceptsTab(concepts, containerId) {
        const container = $(containerId);
        const positiveCount = concepts.filter((c) => c.effect === "+").length;
        const negativeCount = concepts.filter((c) => c.effect === "-").length;
        const neutralCount = concepts.filter((c) => c.effect === "0").length;
        let tableHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><div class="metric-card"><h4 class="font-bold">Positive Effects</h4><p class="text-3xl font-bold">${positiveCount}</p></div><div class="metric-card"><h4 class="font-bold">Negative Effects</h4><p class="text-3xl font-bold">${negativeCount}</p></div><div class="metric-card"><h4 class="font-bold">Neutral Effects</h4><p class="text-3xl font-bold">${neutralCount}</p></div></div><div id="effectPieChart" class="w-full h-[400px] mb-8 plotly-chart"></div><h3 class="text-2xl font-bold mb-4">Extracted Concepts</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-white/20"><tr><th class="p-2">Concept</th><th class="p-2">Description</th><th class="p-2">Effect</th><th class="p-2">Influence</th></tr></thead><tbody>`;
        concepts.forEach((c) => {
            tableHtml += `<tr class="border-b border-white/10"><td class="p-2 font-semibold">${c.name}</td><td class="p-2 text-sm text-white/80">${c.description}</td><td class="p-2 text-center">${c.effect}</td><td class="p-2">${c.influence}</td></tr>`;
        });
        tableHtml += "</tbody></table></div>";
        container.innerHTML = tableHtml;
        Plotly.newPlot(
            "effectPieChart",
            [
                {
                    values: [positiveCount, negativeCount, neutralCount],
                    labels: ["Positive", "Negative", "Neutral"],
                    type: "pie",
                    marker: { colors: ["#2E8B57", "#CD5C5C", "#808080"] },
                    hole: 0.4
                }
            ],
            {
                title: "Distribution of Concept Effects",
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                legend: { orientation: "h", y: -0.1 }
            },
            { responsive: true }
        );
    }

    function renderNetworkTab(concepts, containerId) {
        const container = $(containerId);
        container.innerHTML = `<div id="conceptNetworkChart" class="w-full h-[600px] plotly-chart"></div>`;
        const nodes = concepts.map((c) => ({ id: c.name, ...c }));
        const edges = [];
        for (let i = 0; i < nodes.length; i++) {
            for (let j = i + 1; j < nodes.length; j++) {
                edges.push({ source: nodes[i].id, target: nodes[j].id });
            }
        }
        const positions = {};
        nodes.forEach((node, i) => {
            const angle = (i / nodes.length) * 2 * Math.PI;
            positions[node.id] = { x: nodes.length * 15 * Math.cos(angle), y: nodes.length * 15 * Math.sin(angle) };
        });
        const edge_x = [];
        const edge_y = [];
        edges.forEach((edge) => {
            edge_x.push(positions[edge.source].x, positions[edge.target].x, null);
            edge_y.push(positions[edge.source].y, positions[edge.target].y, null);
        });
        const node_x = [];
        const node_y = [];
        const node_text = [];
        const node_color = [];
        nodes.forEach((node) => {
            node_x.push(positions[node.id].x);
            node_y.push(positions[node.id].y);
            node_text.push(`${node.name}<br>Influence: ${node.influence}`);
            if (node.effect === "+") node_color.push("green");
            else if (node.effect === "-") node_color.push("red");
            else node_color.push("gray");
        });
        const edgeTrace = {
            x: edge_x,
            y: edge_y,
            mode: "lines",
            line: { width: 0.5, color: "#888" },
            hoverinfo: "none"
        };
        const nodeTrace = {
            x: node_x,
            y: node_y,
            mode: "markers+text",
            text: nodes.map((n) => n.name),
            textposition: "bottom center",
            hoverinfo: "text",
            hovertext: node_text,
            marker: { size: 20, color: node_color }
        };
        Plotly.newPlot(
            "conceptNetworkChart",
            [edgeTrace, nodeTrace],
            {
                title: "Concept Network Visualization",
                showlegend: false,
                hovermode: "closest",
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                xaxis: { showgrid: false, zeroline: false, showticklabels: false },
                yaxis: { showgrid: false, zeroline: false, showticklabels: false }
            },
            { responsive: true }
        );
    }

    function renderArchetypesTab(topArchetypes, containerId) {
        const container = $(containerId);
        let contentHtml = `<h3 class="text-2xl font-bold mb-4"> 80/20 Analysis - Most Relevant Archetypes</h3><p class="text-white/70 mb-6">This analysis focuses on the top 20% of system archetypes that are most likely driving 80% of the system's behavior.</p><div id="archetypeBarChart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
        topArchetypes.forEach((archetype) => {
            contentHtml += `<div class="metric-card mb-4"><h4 class="text-xl font-bold"> ${archetype.name}</h4><p class="text-sm font-semibold text-yellow-300 mb-2">Relevance Score: ${archetype.relevance_score}/10</p><p class="text-sm text-white/80 mb-3">${archetype.description}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div><h5 class="font-semibold">Leverage Points:</h5><ul class="list-disc list-inside">${archetype.leverage_points.map((lp) => `<li>${lp}</li>`).join("")}</ul></div><div><h5 class="font-semibold">Interventions:</h5><ul class="list-disc list-inside">${archetype.interventions.map((i) => `<li>${i}</li>`).join("")}</ul></div></div></div>`;
        });
        container.innerHTML = contentHtml;
        const chartData = topArchetypes.map((a) => ({ Archetype: a.name, "Relevance Score": a.relevance_score || 0 }));
        Plotly.newPlot(
            "archetypeBarChart",
            [
                {
                    x: chartData.map((d) => d.Archetype),
                    y: chartData.map((d) => d["Relevance Score"]),
                    type: "bar",
                    marker: { color: chartData.map((d) => d["Relevance Score"]), colorscale: "Viridis" }
                }
            ],
            {
                title: "Archetype Relevance Scores (Top 20%)",
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                xaxis: { automargin: true },
                yaxis: { title: "Relevance Score" }
            },
            { responsive: true }
        );
    }

    function renderLeveragePointsTab(topLeveragePoints, containerId) {
        const container = $(containerId);
        let contentHtml = `<h3 class="text-2xl font-bold mb-4"> 80/20 Analysis - Top Leverage Points</h3><p class="text-white/70 mb-6">These are the top 20% of concepts where small changes can lead to the largest (80%) improvements in the system.</p><div id="leverageBarChart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
        topLeveragePoints.forEach((point) => {
            let priorityClass = "";
            if (point.impact === "High" && point.score >= 8) priorityClass = "critical";
            else if (point.score >= 6) priorityClass = "high";
            contentHtml += `<div class="metric-card ${priorityClass} mb-4"><h4 class="text-xl font-bold">${point.concept}</h4><p class="text-sm font-semibold text-yellow-300 mb-2">Leverage Score: ${point.score}/10 | Expected Impact: ${point.impact}</p><p class="text-sm text-white/80 mb-3"><strong>Reasoning:</strong> ${point.reasoning}</p><div><h5 class="font-semibold text-sm">Recommended Actions:</h5><ul class="list-disc list-inside text-sm">${point.actions.map((a) => `<li>${a}</li>`).join("")}</ul></div></div>`;
        });
        container.innerHTML = contentHtml;
        const chartData = topLeveragePoints.map((p) => ({
            Concept: p.concept,
            "Leverage Score": p.score || 0,
            Impact: p.impact
        }));
        Plotly.newPlot(
            "leverageBarChart",
            [
                {
                    x: chartData.map((d) => d.Concept),
                    y: chartData.map((d) => d["Leverage Score"]),
                    type: "bar",
                    marker: {
                        color: chartData.map((d) => {
                            if (d.Impact === "High") return "#2E8B57";
                            if (d.Impact === "Medium") return "#FF8C00";
                            return "#DC143C";
                        })
                    }
                }
            ],
            {
                title: "Leverage Point Scores (Top 20%)",
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: { color: "white" },
                xaxis: { automargin: true },
                yaxis: { title: "Leverage Score" }
            },
            { responsive: true }
        );
    }
   
    /**
     * NEW HELPER FUNCTION (v7)
     * Takes a simple goal string (from n8n) and the full context,
     * and calls Ollama to generate the missing details.
     */
    async function enrichN8nGoal(goalString, fullContext) {
        console.log(`Enriching n8n goal: "${goalString.substring(0, 30)}..."`);
        const OLLAMA_URL = "https://ollama.sageaios.com/api/generate";
        const MODEL_NAME = "llama3.1:latest";

        const prompt = `
            You are a strategic analyst. You are given a main company context and one specific goal. 
            Your task is to generate the supporting details for *only* that single goal, based *only* on the full context.

            **Full Company Context:**
            \`\`\`
            ${fullContext}
            \`\`\`

            **Specific Goal to Analyze:**
            "${goalString}"

            **DETAILED TASKS (Ground all answers *strictly* in the Full Company Context):**
            1.  **Goal Name (\`goal_name\`):** Return the exact goal string provided: "${goalString}".
            2.  **Description (\`description\`):** Write a 1-2 sentence explanation of *why* this specific goal is critical for the company, based on the context.
            3.  **Key Initiatives (\`key_initiatives\`):** List 2-3 specific initiatives **from the context** that would help achieve this goal. If none are mentioned, generate logical initiatives based on the context.
            4.  **KPIs to Track (\`kpis_to_track\`):** List 2-3 specific KPIs **from the context** to measure this goal. If none are mentioned, generate logical KPIs based on the context.

            **ABSOLUTE CONSTRAINTS:**
            - Base **ALL** output **EXCLUSIVELY** on the "Full Company Context".
            - The \`goal_name\` in the JSON output *must* be the exact string: "${goalString}".
            - Return ONLY the JSON object.

            **RETURN FORMAT:**
            Provide ONLY a valid JSON object.
            {
              "goal_name": "${goalString}",
              "description": "[1-2 sentence rationale based on context...]",
              "key_initiatives": [
                "[Initiative 1 derived from context...]",
                "[Initiative 2 derived from context...]"
              ],
              "kpis_to_track": [
                "[KPI 1 derived from context...]",
                "[KPI 2 derived from context...]"
              ]
            }
        `;

        try {
            const response = await fetch(OLLAMA_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: "json", options: { num_ctx: 32768 } })
            });
            if (!response.ok) throw new Error("Ollama enrichment call failed");
            const data = await response.json();
            const ollamaJson = JSON.parse(data.response);
            
            // Final validation of the enriched object
            if (!ollamaJson.goal_name || !ollamaJson.description || !Array.isArray(ollamaJson.key_initiatives)) {
                 throw new Error("Ollama enrichment returned malformed JSON.");
            }
            return ollamaJson; // Return the full, detailed object
        } catch (err) {
            console.error(`Failed to enrich goal "${goalString}":`, err);
            // Return a fallback object with the user-requested text\
            return {
                goal_name: goalString,
                description: "Rationale: Extracted from base n8n analysis.",
                key_initiatives: ["No specific initiatives identified from text."],
                kpis_to_track: ["No specific KPIs identified from text."]
            };
        }
    }

    /**
     * HANDLER: Mission Vision (DUAL STEP CASCADE)
     * - The primary controller, executed upon receiving the initial RAG result from n8n.
     */
    async function handleWebSocketMessage(data) {
        console.log("Received WebSocket message:", data);

        // --- 1. Mission/Vision and Objectives (ASYNC MERGE PATH) ---
        if (currentTemplateId && currentTemplateId === "mission-vision" && data.result && typeof data.result === 'string') {
            
            if (!currentAnalysisMessageId) {
                console.warn("WebSocket: Received mission-vision data, but no analysis is currently pending. Ignoring.");
                return;
            }

            console.log(`WebSocket: Received n8n data for ${currentTemplateId}. Parsing...`);

            try {
                const resultText = data.result;
                const statusEl = document.getElementById("analysisStatus");
                
                // --- Helper to extract content blocks using regex ---
                const extractBlock = (text, startTag, endTag) => {
                    const match = text.match(new RegExp(startTag + '([\\s\\S]*?)' + endTag, 'i'));
                    return match ? match[1].trim() : null;
                };

                // --- EXTRACT RAG BLOCKS ---
                const bookSummary = extractBlock(resultText, '=== BOOK \\(Primary Source\\) ===', '=== WEB \\(Supporting Source\\) ===') || "Primary source summary missing.";
                const webSummaryFull = extractBlock(resultText, '=== WEB \\(Supporting Source\\) ===', 'Reference Links:') || "Web source data missing.";
                
                const referenceLinksMatch = resultText.match(/Reference Links:\s*([\s\S]*?)Processing Time:/i);
                const referenceLinks = referenceLinksMatch ? referenceLinksMatch[1].match(/https?:\/\/\S+/g) || [] : [];
                
                const processingTimeMatch = resultText.match(/Processing Time:\s*([\s\S]*)/i);
                const processingTime = processingTimeMatch ? processingTimeMatch[1].trim() : "N/A";
                
                // --- STORE N8N EXTERNAL DATA ---
                const n8nBaseData = {
                    external_data: {
                        book_summary: bookSummary,
                        web_summary: webSummaryFull,
                        reference_links: referenceLinks,
                        processing_time: processingTime
                    }
                };

                // 2. TRIGGER CASCADE OLLAMA CALL (FULL SYNTHESIS)
                if (statusEl) statusEl.textContent = "Step 2/2: Synthesizing Mission, Vision & Contextual Analysis...";

                const cascadeResult = await ollamaCascadeGoals(n8nBaseData, currentAnalysisContext);
                
                // 3. MERGE N8N + OLLAMA RESULTS
                // We use the cascadeResult directly for mission/vision because it now has the breakdown
                pendingOllamaResult = {
                    mission: cascadeResult.mission, // Object containing { statement, breakdown }
                    vision: cascadeResult.vision,   // Object containing { statement, breakdown }
                    values: cascadeResult.core_values || [],
                    goals: cascadeResult.goals || [], 
                    external_data: n8nBaseData.external_data
                };
                
                // Set pendingN8nResult to signal merge is ready (initialize as empty to prevent crash)
                pendingN8nResult = { values: [], goals: [] }; 
                
                attemptMergeAndRender();
                return;
            } catch (parseError) {
                console.error(`WebSocket: Failed to parse n8n result for ${currentTemplateId} and trigger cascade:`, parseError);
                pendingN8nResult = { values: [], goals: [] }; // Signal completion with failure data
                attemptMergeAndRender();
            }
            return;
        
        // --- Objectives Logic (Reliable JS Table Parser) ---
        } else if (currentTemplateId === "objectives" && data.result && typeof data.result === 'string') {
            
             if (!currentAnalysisMessageId) {
                console.warn("WebSocket: Received objectives data, but no analysis is currently pending. Ignoring.");
                return;
            }

            console.log("WebSocket: Received n8n data for current objectives analysis. Parsing table with JS...");

            try {
                const markdownTable = data.result;
                
                // Call the new, reliable JS parser
                const tableJson = parseMarkdownTable(markdownTable);
                
                pendingN8nResult = tableJson; // This is the array of table rows
                
                console.log("WebSocket: n8n table data parsed. Stored in pendingN8nResult.");
                attemptMergeAndRender();

            } catch (parseError) {
                 console.error("WebSocket: Failed to parse n8n table:", parseError);
                 pendingN8nResult = []; // Fulfill with empty array
                 attemptMergeAndRender();
            }
            return;  // --- Strategic Planning Logic (misc-summary) ---
        } else if (currentTemplateId === "misc-summary" && data.result && typeof data.result === 'string') {
            
            if (!currentAnalysisMessageId) return;

            console.log("WebSocket: Received n8n data for Strategic Planning. Parsing...");

            try {
                const resultText = data.result;
                
                // Use same regex helpers as Mission/Vision
                const extractBlock = (text, startTag, endTag) => {
                    const match = text.match(new RegExp(startTag + '([\\s\\S]*?)' + endTag, 'i'));
                    return match ? match[1].trim() : null;
                };

                // Extract RAG Data
                const bookSummary = extractBlock(resultText, '=== BOOK \\(Primary Source\\) ===', '=== WEB \\(Supporting Source\\) ===') || "Primary source summary not provided.";
                const webSummaryFull = extractBlock(resultText, '=== WEB \\(Supporting Source\\) ===', 'Reference Links:') || "Web source summary not provided.";
                
                const referenceLinksMatch = resultText.match(/Reference Links:\s*([\s\S]*?)Processing Time:/i);
                const referenceLinks = referenceLinksMatch ? referenceLinksMatch[1].match(/https?:\/\/\S+/g) || [] : [];
                
                const n8nBaseData = {
                    external_data: {
                        book_summary: bookSummary,
                        web_summary: webSummaryFull,
                        reference_links: referenceLinks
                    }
                };

                // Trigger Cascade
                const cascadeResult = await ollamaCascadeStrategicPlan(n8nBaseData, currentAnalysisContext);
                
                // Render
                renderMiscPage_MSC(document.getElementById("analysisResult"), cascadeResult);
                
                // Clean up
                pendingOllamaResult = null;
                pendingN8nResult = null;
                currentAnalysisMessageId = null;
                setLoading("generate", false);

            } catch (e) {
                console.error("Strategic Planning Cascade Error:", e);
                document.getElementById("analysisResult").innerHTML = `<div class="p-4 text-center text-red-400">Error processing analysis: ${e.message}</div>`;
                setLoading("generate", false);
            }
            return;
        }
        // --- 2. Generic Message Handler (NON-MERGE PATH) ---
        
        const container = pendingAnalysisRequests.get(parseInt(data.messageId));
        if (!container) {
            console.warn("WebSocket: Received message with no matching container in pendingAnalysisRequests. ID:", data.messageId);
            return;
        }

        if (data.error) {
            container.innerHTML = `<div class="p-4 text-center text-red-400">Workflow error: ${data.error}</div>`;
            pendingAnalysisRequests.delete(parseInt(data.messageId));
            setLoading("generate", false);
            return;
        }

        if (data.progress && !data.result && data.templateId !== "pareto-fishbone") {
            container.innerHTML = `
                    <div class="text-center text-white/70 p-4">
                        <div class="typing-indicator mb-4">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                        <p class="mb-2"> ${data.progress}</p>
                        <p class="text-sm text-white/50">Analysis in progress...</p>
                    </div>`;
            return;
        }

        if (data.templateId === "pareto-fishbone" && data.fishbone && data.pareto) {
            renderParetoFishbonePage(container, data);
        } else if (data.result) {
            container.innerHTML = `<div id="analysisContent" class="whitespace-pre-wrap">${data.result}</div>`;
            analysisCache[currentTemplateId] = container.innerHTML;
        }

        const analysisActionsEl = $("analysisActions");
        if (analysisActionsEl) analysisActionsEl.classList.remove("hidden");

        pendingAnalysisRequests.delete(parseInt(data.messageId));
        setLoading("generate", false);
    }

    async function handleLogin() {
        const email = $("loginEmail").value.trim();
        const password = $("loginPassword").value;
        const loginMessageEl = $("loginMessage");

        if (!email || !password) {
            showMessage("loginMessage", "Please fill in all fields", "error");
            return;
        }

        setLoading("login", true);
        loginMessageEl.classList.add("hidden");

        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) {
            showMessage("loginMessage", error.message, "error");
        } else {
            showMessage("loginMessage", "Login successful! Redirecting...", "success");
            setTimeout(() => navigateTo("home"), 1500);
        }
        setLoading("login", false);
    }

    async function handleRegister() {
        const firstName = $("registerFirstName").value.trim();
        const lastName = $("registerLastName").value.trim();
        const email = $("registerEmail").value.trim();
        const password = $("registerPassword").value;
        const confirmPassword = $("registerConfirmPassword").value;

        if (!firstName || !lastName || !email || !password || !confirmPassword) {
            showMessage("registerMessage", "Please fill in all fields", "error");
            return;
        }
        if (password !== confirmPassword) {
            showMessage("registerMessage", "Passwords do not match", "error");
            return;
        }
        if (password.length < 6) {
            showMessage("registerMessage", "Password must be at least 6 characters long", "error");
            return;
        }

        setLoading("register", true);
        try {
            const { data, error } = await supabase.functions.invoke("create-user-v3", {
                body: {
                    email,
                    password,
                    metadata: {
                        first_name: firstName,
                        last_name: lastName
                    }
                }
            });

            if (error || !data?.user) {
                showMessage("registerMessage", error?.message || "User creation failed.", "error");
                return;
            }

            $("registerForm").reset();
            navigateTo("emailVerification");
        } catch (err) {
            console.error("Register error:", err);
            showMessage("registerMessage", "An error occurred during registration. Please try again.", "error");
        } finally {
            setLoading("register", false);
        }
    }

    async function handleLogout() {
        await supabase.auth.signOut();
        navigateTo("login");
    }

    /**
     * Handles the password reset request form.
     * Calls the new 'password-reset-request' edge function.
     */
    async function handlePasswordResetRequest() {
        const email = $("passwordResetEmail").value.trim();
        const messageEl = $("passwordResetRequestMessage");

        if (!email) {
            showMessage("passwordResetRequestMessage", "Please enter your email address", "error");
            return;
        }

        setLoading("passwordResetRequest", true);
        
        try {
            const { data, error } = await supabase.functions.invoke("password-reset-request", {
                body: { email: email }
            });

            if (error) throw error;

            // Always show a success message (for security, don't reveal if email exists)
            showMessage("passwordResetRequestMessage", "If an account exists, a reset link has been sent to your email.", "success");
            $("passwordResetEmail").value = ""; // Clear field

        } catch (error) {
            console.error("Password reset request error:", error);
            // Show a generic error
            showMessage("passwordResetRequestMessage", `Error: ${error.message || 'Could not send reset link.'}`, "error");
        } finally {
            setLoading("passwordResetRequest", false);
        }
    }

    /**
     * Handles the password update form.
     * This runs on the client-side after the user clicks the email link.
     */
async function handlePasswordUpdate() {
    const password = $("passwordUpdatePassword").value;
    const confirmPassword = $("passwordUpdateConfirmPassword").value;
    
    if (!password || !confirmPassword) {
        showMessage("passwordUpdateMessage", "Please fill in all fields", "error");
        return;
    }
    if (password !== confirmPassword) {
        showMessage("passwordUpdateMessage", "Passwords do not match", "error");
        return;
    }
    if (password.length < 6) {
        showMessage("passwordUpdateMessage", "Password must be at least 6 characters long", "error");
        return;
    }
    
    setLoading("passwordUpdate", true);
    
    try {
        // Use the stored token and email from the URL
        const { data, error } = await supabase.functions.invoke("password-reset-verify", {
            body: { 
                token: window.resetToken,
                email: window.resetEmail,
                newPassword: password 
            }
        });
        
        if (error) throw error;
        
        showMessage("passwordUpdateMessage", "Password updated successfully! Redirecting to login...", "success");
        
        // Clear the stored values
        delete window.resetToken;
        delete window.resetEmail;
        
        setTimeout(() => navigateTo("login"), 2000);
    } catch (error) {
        console.error("Password reset error:", error);
        showMessage("passwordUpdateMessage", `Error: ${error.message || 'Could not update password.'}`, "error");
    } finally {
        setLoading("passwordUpdate", false);
    }
}   

    console.log('=== PAGE LOAD DEBUG ===');
    console.log('Current URL:', window.location.href);
    console.log('Pathname:', window.location.pathname);
    console.log('Search:', window.location.search);
   
    // --- UI Helpers ---
    function setLoading(type, isLoading) {
        const btn = $(type + "Btn");
        if (!btn) return;

        const textEl = $(type + "BtnText");
        const spinner = $(type + "Spinner");

        btn.disabled = isLoading;
        if (spinner) spinner.classList.toggle("hidden", !isLoading);

        if (textEl) {
            if (isLoading) {
                // Store original text if it's not already stored
                if (!btn.dataset.originalText) {
                    btn.dataset.originalText = textEl.textContent;
                }
                textEl.textContent = "Analyzing...";
            } else {
                // Restore original text
                textEl.textContent = btn.dataset.originalText || "Generate Analysis";
                // Clear the data attribute after use
                delete btn.dataset.originalText;
            }
        }
    }

    function showMessage(id, msg, type) {
        const el = $(id);
        if (!el) return;
        el.textContent = msg;
        el.className = type === "error" ? "error-message" : "success-message";
        if (msg) {
            el.classList.remove("hidden");
        } else {
            el.classList.add("hidden");
        }
        if (type === "success" && msg) {
            setTimeout(() => el.classList.add("hidden"), 4000);
        }
    }

    /**
     * Core animation logic.
     * Applies fade-in-on-scroll animations to a given list of elements.
     * Manages its own observer and adds it to the global list for cleanup.
     * @param {NodeListOf<Element>} elementsToAnimate - The elements to apply animation to.
     */
    function animateElements(elementsToAnimate) {
        if (!elementsToAnimate || elementsToAnimate.length === 0) {
            return;
        }

        const observerOptions = {
            threshold: 0.05, // Lower threshold (triggers easier)
            rootMargin: '0px 0px -20px 0px' // Less aggressive margin
        };

        const animationObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Make visible
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                    
                    // Stop observing once visible to save performance and prevent flickering
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        // Apply initial (hidden) state and start observing
        elementsToAnimate.forEach(el => {
            // Only hide it if it hasn't been animated yet
            if (el.style.opacity !== '1') {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
                animationObserver.observe(el);
            }
        });

        // Add to global list for page cleanup
        if (typeof activeObservers !== 'undefined') {
            activeObservers.push(animationObserver);
        }
    }

    /**
     * Finds all animatable elements on the *initial* page load and animates them.
     * Cleans up all old observers from previous pages.
     * @param {string} pageId The ID of the page container (e.g., "home", "templateDetail").
     */
    function setupPageAnimations(pageId) {
        // 1. Disconnect ALL old observers from previous pages/renders
        activeObservers.forEach(obs => obs.disconnect());
        activeObservers = []; // Clear the array

        // 2. Find the page container
        const container = $(pageId);
        if (!container) return;

        // 3. Find all card/container elements *within this specific page* to animate
        const elementsToAnimate = container.querySelectorAll(
            '.glass-container, .feature-card, .project-card, .kpi-card, .summary-stat-card, .prescription-card, .insight-card, .action-card, .ladder-rung, .dissonance-pole, .cascade-objective, .cascade-goal-card, .st-objective-card, .st-goal-card, .feedback-card'
        );

        // 4. Call the core animation function
        animateElements(elementsToAnimate);
    }

    // --- Three.js Animation Logic ---
    let scene, camera, renderer, group;
    const particlesData = [];
    let positions, colors;
    let particlesGeometry;
    let pointCloud;
    let particlePositions;
    let linesMesh;
    let animationFrameId;

    const NUM_PARTICLES = 1000;
    const AREA_SIZE = 3000;
    const AREA_HALF = AREA_SIZE / 2;
    const MIN_DISTANCE = 200;

    let mouseX = 0,
        mouseY = 0;

    function createCircleTexture(size, color) {
        const canvas = document.createElement("canvas");
        canvas.width = size;
        canvas.height = size;
        const context = canvas.getContext("2d");
        const gradient = context.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2);
        gradient.addColorStop(0, color);
        gradient.addColorStop(0.7, color);
        gradient.addColorStop(1, "rgba(0,0,0,0)");
        context.fillStyle = gradient;
        context.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
        context.fill();
        return new THREE.CanvasTexture(canvas);
    }

    function initThreeJS() {
        const canvas = $("threeJsCanvas");
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000);
        camera.position.z = 3000;

        scene = new THREE.Scene();
        group = new THREE.Group();
        scene.add(group);

        const particleTexture = createCircleTexture(64, "rgba(173, 216, 230, 1)");

        const pMaterial = new THREE.PointsMaterial({
            color: 0xffffff,
            size: 7,
            blending: THREE.AdditiveBlending,
            transparent: true,
            sizeAttenuation: false,
            map: particleTexture
        });

        particlesGeometry = new THREE.BufferGeometry();
        particlePositions = new Float32Array(NUM_PARTICLES * 3);

        for (let i = 0; i < NUM_PARTICLES; i++) {
            const x = Math.random() * AREA_SIZE - AREA_HALF;
            const y = Math.random() * AREA_SIZE - AREA_HALF;
            const z = Math.random() * AREA_SIZE - AREA_HALF;

            particlePositions[i * 3] = x;
            particlePositions[i * 3 + 1] = y;
            particlePositions[i * 3 + 2] = z;

            particlesData.push({
                velocity: new THREE.Vector3(
                    (Math.random() - 0.5) * 0.5,
                    (Math.random() - 0.5) * 0.5,
                    (Math.random() - 0.5) * 0.5
                ),
                numConnections: 0
            });
        }

        particlesGeometry.setDrawRange(0, NUM_PARTICLES);
        particlesGeometry.setAttribute(
            "position",
            new THREE.BufferAttribute(particlePositions, 3).setUsage(THREE.DynamicDrawUsage)
        );

        pointCloud = new THREE.Points(particlesGeometry, pMaterial);
        group.add(pointCloud);

        const lineGeometry = new THREE.BufferGeometry();
        positions = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);
        colors = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);

        lineGeometry.setAttribute("position", new THREE.BufferAttribute(positions, 3).setUsage(THREE.DynamicDrawUsage));
        lineGeometry.setAttribute("color", new THREE.BufferAttribute(colors, 3).setUsage(THREE.DynamicDrawUsage));
        lineGeometry.computeBoundingSphere();
        lineGeometry.setDrawRange(0, 0);

        const lineMaterial = new THREE.LineBasicMaterial({
            vertexColors: true,
            blending: THREE.AdditiveBlending,
            transparent: true,
            opacity: 0.4
        });

        linesMesh = new THREE.LineSegments(lineGeometry, lineMaterial);
        group.add(linesMesh);

        renderer = new THREE.WebGLRenderer({
            canvas: canvas,
            antialias: true,
            alpha: true
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);

        startAnimationLoop();

        window.addEventListener("resize", onWindowResize);
        window.addEventListener("mousemove", onDocumentMouseMove);
    }

    function startAnimationLoop() {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);

        function loop() {
            animateThreeJS();
            animationFrameId = requestAnimationFrame(loop);
        }
        loop();
    }

    function onDocumentMouseMove(event) {
        mouseX = (event.clientX / window.innerWidth) * 2 - 1;
        mouseY = (event.clientY / window.innerHeight) * 2 - 1;
    }

    function animateThreeJS() {
        let vertexpos = 0;
        let colorpos = 0;
        let numConnected = 0;

        for (let i = 0; i < NUM_PARTICLES; i++) {
            particlesData[i].numConnections = 0;
        }

        for (let i = 0; i < NUM_PARTICLES; i++) {
            const particleData = particlesData[i];
            particlePositions[i * 3] += particleData.velocity.x;
            particlePositions[i * 3 + 1] += particleData.velocity.y;
            particlePositions[i * 3 + 2] += particleData.velocity.z;

            if (particlePositions[i * 3 + 1] < -AREA_HALF || particlePositions[i * 3 + 1] > AREA_HALF)
                particleData.velocity.y = -particleData.velocity.y;
            if (particlePositions[i * 3] < -AREA_HALF || particlePositions[i * 3] > AREA_HALF)
                particleData.velocity.x = -particleData.velocity.x;
            if (particlePositions[i * 3 + 2] < -AREA_HALF || particlePositions[i * 3 + 2] > AREA_HALF)
                particleData.velocity.z = -particleData.velocity.z;

            for (let j = i + 1; j < NUM_PARTICLES; j++) {
                const dx = particlePositions[i * 3] - particlePositions[j * 3];
                const dy = particlePositions[i * 3 + 1] - particlePositions[j * 3 + 1];
                const dz = particlePositions[i * 3 + 2] - particlePositions[j * 3 + 2];
                const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

                if (dist < MIN_DISTANCE) {
                    const alpha = 1.0 - dist / MIN_DISTANCE;
                    positions[vertexpos++] = particlePositions[i * 3];
                    positions[vertexpos++] = particlePositions[i * 3 + 1];
                    positions[vertexpos++] = particlePositions[i * 3 + 2];
                    positions[vertexpos++] = particlePositions[j * 3];
                    positions[vertexpos++] = particlePositions[j * 3 + 1];
                    positions[vertexpos++] = particlePositions[j * 3 + 2];

                    const lineColor = new THREE.Color(0xadd8e6);
                    colors[colorpos++] = lineColor.r * alpha;
                    colors[colorpos++] = lineColor.g * alpha;
                    colors[colorpos++] = lineColor.b * alpha;
                    colors[colorpos++] = lineColor.r * alpha;
                    colors[colorpos++] = lineColor.g * alpha;
                    colors[colorpos++] = lineColor.b * alpha;
                    numConnected++;
                }
            }
        }

        linesMesh.geometry.setDrawRange(0, numConnected * 2);
        linesMesh.geometry.attributes.position.needsUpdate = true;
        linesMesh.geometry.attributes.color.needsUpdate = true;
        pointCloud.geometry.attributes.position.needsUpdate = true;

        const rotationSpeed = 0.03;
        group.rotation.y += (mouseX * 0.05 - group.rotation.y) * rotationSpeed;
        group.rotation.x += (mouseY * 0.05 - group.rotation.x) * rotationSpeed;
        group.rotation.y += 0.0001;
        group.rotation.x += 0.00005;

        renderer.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // --- AI Analysis Examples Carousel Logic ---
    let currentExampleIndex = 0;
    const analysisExamples = document.querySelectorAll(".analysis-example-item");
    const prevExampleBtn = $("prevExampleBtn");
    const nextExampleBtn = $("nextExampleBtn");
    const exampleCounter = $("exampleCounter");

    function showAnalysisExample(index) {
        analysisExamples.forEach((item, i) => {
            item.classList.toggle("hidden", i !== index);
        });
        prevExampleBtn.disabled = index === 0;
        nextExampleBtn.disabled = index === analysisExamples.length - 1;
        exampleCounter.textContent = `${index + 1} of ${analysisExamples.length}`;
    }

    if (prevExampleBtn) {
        prevExampleBtn.addEventListener("click", () => {
            if (currentExampleIndex > 0) {
                currentExampleIndex--;
                showAnalysisExample(currentExampleIndex);
            }
        });
    }
    if (nextExampleBtn) {
        nextExampleBtn.addEventListener("click", () => {
            if (currentExampleIndex < analysisExamples.length - 1) {
                currentExampleIndex++;
                showAnalysisExample(currentExampleIndex);
            }
        });
    }
    if (analysisExamples.length > 0) {
        showAnalysisExample(currentExampleIndex);
    }

    // --- Initial Setup ---
    const versionModal = $("versionChoiceModal");
    const selectFreeBtn = $("selectFreeVersion");
    const selectPaidBtn = $("selectPaidVersion");
    const closeModalBtn = $("closeModalBtn");

    selectFreeBtn.addEventListener("click", () => {
        currentSelectionLimit = 1;
        proceedFromModal();
    });

    selectPaidBtn.addEventListener("click", () => {
        currentSelectionLimit = 3;
        proceedFromModal();
    });

    closeModalBtn.addEventListener("click", () => {
        versionModal.classList.remove('modal-open'); // Start fade-out
        setTimeout(() => versionModal.style.display = 'none', 300); // Hide after animation
    });

    // --- PROMO CODE LOGIC ---
    const applyPromoBtn = document.getElementById("applyPromoBtn");
    if (applyPromoBtn) {
        applyPromoBtn.addEventListener("click", async () => {
            const input = document.getElementById("promoCodeInput");
            const msg = document.getElementById("promoMessage");
            const code = input.value.trim();
            const originalText = applyPromoBtn.innerText;

            if (!code) {
                msg.textContent = "Please enter a code.";
                msg.className = "text-center text-xs mt-2 text-red-400 block";
                return;
            }

            // UI Loading State
            applyPromoBtn.disabled = true;
            applyPromoBtn.innerText = "Checking...";
            msg.className = "hidden";

            try {
                // 1. Get Session
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) throw new Error("Please log in first.");

                // 2. Call Edge Function
                const { data, error } = await supabase.functions.invoke('redeem-promo', {
                    body: { code: code }
                });

                if (error) throw new Error("Network error connecting to server.");
                if (data.error) throw new Error(data.error);

                // 3. Success!
                msg.textContent = " Success! Premium Unlocked.";
                msg.className = "text-center text-xs mt-2 text-green-400 block";
                
                // 4. Update Local State Immediately
                currentSelectionLimit = 3; 
                
                // 5. Refresh Nav to show new status
                updateNavBar();

                // 6. Close Modal after delay
                setTimeout(() => {
                    document.getElementById("stripePaymentModal").classList.remove("modal-open");
                    setTimeout(() => {
                        document.getElementById("stripePaymentModal").style.display = "none";
                    }, 500);
                    
                    // If user was trying to use a specific template, open it now
                    if (selectedTemplateForModal) {
                        showTemplateDetail(selectedTemplateForModal);
                    }
                }, 1500);

            } catch (err) {
                console.error("Promo Error:", err);
                msg.textContent = err.message;
                msg.className = "text-center text-xs mt-2 text-red-400 block";
                applyPromoBtn.disabled = false;
                applyPromoBtn.innerText = originalText;
            }
        });
    }

    // --- NEW FEEDBACK PAGE LOGIC (CALLING EDGE FUNCTION) ---

    // 1. Populate the tool dropdown
    const feedbackToolSelect = $("feedbackToolName");
    if (feedbackToolSelect) {
        for (const templateId in templates) {
            if (templates.hasOwnProperty(templateId)) {
                const title = templates[templateId].title;
                feedbackToolSelect.add(new Option(title, templateId));
            }
        }
    }

    // 2. Add the submit button listener
    const submitFeedbackPageBtn = $("submitFeedbackPageBtn");
    if (submitFeedbackPageBtn) {
        submitFeedbackPageBtn.addEventListener("click", async () => { 
            
            const tool_name = $("feedbackToolName").value;
            const reason = $("feedbackReason").value;
            const content = $("feedbackTextPage").value.trim();
            const ratingInput = document.querySelector('input[name="feedbackRating"]:checked');
            
            const rating = ratingInput ? (ratingInput.value === "0" ? null : parseInt(ratingInput.value)) : null;

            if (!currentUser) {
                showMessage("feedbackMessagePage", "You must be logged in to submit feedback.", "error");
                return;
            }
            if (!reason) {
                showMessage("feedbackMessagePage", "Please select a reason.", "error");
                return;
            }
            if (content.length <= 10) { 
                showMessage("feedbackMessagePage", "Please enter at least 10 characters in the details box.", "error");
                return;
            }

            setLoading("submitFeedbackPage", true);
            
            try {
                const feedbackObject = {
                    tool_name: tool_name,
                    reason: reason,
                    content: content,
                    rating: rating 
                };
                
                const { data, error: invokeError } = await supabase.functions.invoke(
                    'insert-feedback', 
                     { body: feedbackObject }
                );

                if (invokeError) {
                    throw invokeError; 
                }

                // --- Success ---
                setLoading("submitFeedbackPage", false);
                showMessage("feedbackMessagePage", "Thank you! Your feedback has been received.", "success");
                
                // --- MODIFIED BLOCK: Always go to home ---
                setTimeout(() => {
                     console.log(`---> Feedback success. Navigating to "home".`);
                     navigateTo("home"); 
                }, 2000);

            } catch (error) {
                // --- Error Handling ---
                console.error("Feedback submission error:", error);
                setLoading("submitFeedbackPage", false);
                showMessage("feedbackMessagePage", `Error: ${error.message || 'An unknown error occurred.'}`, "error");
            }
        });
    }
    // --- END OF NEW FEEDBACK PAGE LOGIC ---

    $("loginBtn").addEventListener("click", handleLogin);
    $("registerBtn").addEventListener("click", handleRegister);

    // --- NEW Initial Page Load Logic (Updated for Password Reset) ---
(async () => {
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const isSuccess = urlParams.get('success') === 'true';
    const isAlready = urlParams.get('already') === 'true';
    
    // NEW: Check for password reset parameters
    const resetToken = urlParams.get('token');
    const resetEmail = urlParams.get('email');
    
    // --- HASH CHECK ---
    const hash = window.location.hash;
    const hashParams = new URLSearchParams(hash.substring(1)); // remove #
    const accessToken = hashParams.get('access_token');
    const type = hashParams.get('type');
    
    // Clear URL parameters or hash
    if (isSuccess || isAlready || accessToken || resetToken) {
         window.history.replaceState(null, null, window.location.pathname);
    }
    
    // --- NAVIGATION LOGIC ---
    if (resetToken && resetEmail) {
        // NEW: Handle password reset
        console.log('Password reset link detected, navigating to reset form');
        navigateTo("passwordResetUpdate");
        // Store token and email for the reset form to use
        window.resetToken = resetToken;
        window.resetEmail = decodeURIComponent(resetEmail);
        console.log('Stored reset token and email for form');
    } else if (isSuccess) {
        // From our custom email-verify function
        navigateTo("emailVerifiedSuccess");
    } else if (isAlready) {
        // From our custom email-verify function
        navigateTo("emailVerifiedAlready");
    } else if (accessToken && type === 'recovery') {
        // From Supabase password reset link (legacy)
        // The supabase client will auto-set the session from the token.
        navigateTo("passwordResetUpdate");
    } else if (accessToken) {
        // From any other Supabase magic link (like login or old verify)
        // The onAuthStateChange listener will catch this
        navigateTo("home");
    } else {
        // Default load for a new visitor
        navigateTo("home");
    }
    
    // Attach the Contact Submit Handler
    const contactSubmitBtn = $("contactSubmitBtn");
    if (contactSubmitBtn) {
        contactSubmitBtn.addEventListener("click", handleContactSubmit);
    }
    
    // Hero Canvas Animation

    function initHeroAnimation() {
        const canvas = document.getElementById('heroCanvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        const particles = [];
        const particleCount = 50;
    
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.radius = Math.random() * 3 + 1;
                this.color = `hsl(${Math.random() * 60 + 240}, 70%, 60%)`;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                
                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            
                // Draw connections
                particles.forEach(particle => {
                    const distance = Math.sqrt(
                        Math.pow(this.x - particle.x, 2) + 
                        Math.pow(this.y - particle.y, 2)
                    );
                    
                    if (distance < 100) {
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y);
                        ctx.lineTo(particle.x, particle.y);
                        ctx.strokeStyle = `rgba(255, 255, 255, ${0.2 * (1 - distance / 100)})`;
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }
                });
            }
        }

        // Create particles
        for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle());
        }

        // Animation loop
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });

            requestAnimationFrame(animate);
        }
        
        animate();
        
        // Resize handler
        window.addEventListener('resize', () => {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        });
    }

    // Live Stats Counter Animation
    function animateStats() {
        const stats = [
            { element: 'activeUsers', target: 127, suffix: '' },
            { element: 'analysesCompleted', target: 342, suffix: '' },
            { element: 'frameworksUsed', target: 28, suffix: '' },
            { element: 'satisfactionRate', target: 94, suffix: '%' }
        ];

        stats.forEach(stat => {
            const element = document.getElementById(stat.element);
            if (!element) return;

            let current = 0;
            const increment = stat.target / 60; // 60 frames for 1 second animation
            const timer = setInterval(() => {
                current += increment;
                if (current >= stat.target) {
                    current = stat.target;
                    clearInterval(timer);
                }

                element.textContent = Math.floor(current) + stat.suffix;
            }, 16); // ~60fps
        });
    }

    // Smooth Scroll to Tools
    function scrollToTools() {
        const toolsSection = document.getElementById('homeTabsNav');
        if (toolsSection) {
            toolsSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
    }

    // Book Preview Modal
    function showBookPreview() {
        // Create modal for book preview
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-container max-w-4xl max-h-[80vh] overflow-y-auto m-4 p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">Book Preview</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-white/70 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="space-y-4 text-white/80">
                    <h4 class="text-lg font-bold text-indigo-300">Table of Contents</h4>
                    <ul class="list-disc list-inside space-y-2">
                        <li>Part I: Science of Strategy - Fundamental frameworks</li>
                        <li>Part II: Art of Strategy - Creative and adaptive approaches</li>
                        <li>Part III: Execution - Implementation methodologies</li>
                    </ul>
                    <h4 class="text-lg font-bold text-indigo-300 mt-6">Sample Chapter</h4>
                    <p class="italic">"Strategy is not just about planning, but about creating adaptive systems that can thrive in uncertainty..."</p>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        initHeroAnimation();
        animateStats();
    // Enhanced WebSocket status indicator
    });

    function updateWebSocketStatus(connected) {
        const wsStatus = document.getElementById('wsStatus');
        if (wsStatus) {
            wsStatus.className = `ws-status ${connected ? 'connected' : 'disconnected'}`;
            wsStatus.textContent = connected ? 'Connected' : 'Disconnected';
            // Add pulse animation when connected
            if (connected) {
                wsStatus.classList.add('animate-pulse');
            } else {
                wsStatus.classList.remove('animate-pulse');
            }
        }
    }

    

    // Attach password button listeners
    const resetBtn = $("passwordResetRequestBtn");
    if (resetBtn) resetBtn.addEventListener("click", handlePasswordResetRequest);
    
    const updateBtn = $("passwordUpdateBtn");
    if (updateBtn) updateBtn.addEventListener("click", handlePasswordUpdate);
    
    // These should run regardless
    setupHomeTabs();

    // --- FIX: Force Event Listeners to attach immediately ---
    attachNavLinkListeners();

    setTimeout(() => {
        const activePanel = document.querySelector(".home-tab-panel.active");
        if (activePanel) {
            const cards = activePanel.querySelectorAll('.feature-card');
            animateElements(cards);
        }
    }, 100); // Small delay to ensure DOM layout is settled
    attachHomeCardListeners();
    initThreeJS();
})();
// --- END of New Initial Page Load Logic ---         
   
    // --- Dashboard Widget ---
    (function initDashboardWidget() {
        const PRESENCE_PREFIX = "sage_presence_";
        const HEARTBEAT_MS = 10000;
        const STALE_MS = 30000;
        const TAB_ID = crypto && crypto.randomUUID ? crypto.randomUUID() : Date.now() + "-" + Math.random();

        function heartbeat() {
            try {
                localStorage.setItem(PRESENCE_PREFIX + TAB_ID, String(Date.now()));
            } catch (e) {}
        }

        function cleanupStale() {
            const now = Date.now();
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.startsWith(PRESENCE_PREFIX)) {
                        const ts = Number(localStorage.getItem(k) || "0");
                        if (!ts || now - ts > STALE_MS) localStorage.removeItem(k);
                    }
                }
            } catch (e) {}
        }

        function countOnline() {
            const now = Date.now();
            let cnt = 0;
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.startsWith(PRESENCE_PREFIX)) {
                        const ts = Number(localStorage.getItem(k) || "0");
                        if (ts && now - ts <= STALE_MS) cnt++;
                    }
                }
            } catch (e) {}
            return cnt;
        }

        heartbeat();
        const hb = setInterval(() => {
            heartbeat();
            cleanupStale();
        }, HEARTBEAT_MS);
        window.addEventListener("beforeunload", () => {
            try {
                localStorage.removeItem(PRESENCE_PREFIX + TAB_ID);
            } catch (e) {}
            clearInterval(hb);
        });

        function updateDashboard() {
            const usersEl = document.getElementById("dashUsersOnline");
            const serverDot = document.getElementById("dashServerDot");
            const serverText = document.getElementById("dashServerText");
            const wsStatusEl = document.getElementById("wsStatus");

            if (usersEl) usersEl.textContent = String(countOnline());

            let statusText = "Unknown",
                statusClass = "bg-yellow-400";
            if (wsStatusEl) {
                const t = wsStatusEl.textContent.trim().toLowerCase();
                if (t.includes("connected")) {
                    statusText = "Connected";
                    statusClass = "bg-green-400";
                } else if (t.includes("disconnected") || t.includes("failed") || t.includes("error")) {
                    statusText = "Disconnected";
                    statusClass = "bg-red-400";
                } else if (t.includes("connecting")) {
                    statusText = "Connecting";
                    statusClass = "bg-yellow-400";
                }
            }

            if (serverText) serverText.textContent = statusText;
            if (serverDot) serverDot.className = "inline-block w-3 h-3 rounded-full " + statusClass;
        }
        setInterval(updateDashboard, 2000);
        updateDashboard();
    })();

    // =========================================================
    // =====             BLOG CONTENT & LOGIC              =====
    // =========================================================

    // 1. Map Article IDs to your Filenames
    // These IDs match the data-article-id attributes in your HTML cards
    const articleFileMap = {
        "caos": "article1.html",
        "science-of-strategy": "article2.html",
        "mission-analysis": "article3.html",
        "strategic-mission": "article4.html",
        "strategic-vision": "article5.html",
        "art-of-strategy": "article6.html",
        "operational-art": "article7.html",
        "strategic-leadership": "article8.html",
        "innovation-nexus": "article9.html"
    };

    // 2. Logic to Fetch and Render Articles
    // 2. Logic to Fetch and Render Articles (Enhanced Style)
    function setupBlogNavigation() {
        const blogLinks = document.querySelectorAll('.blog-article-link');
        const blogDetailContent = document.getElementById('blogDetailContent');
        const blogDetailContainer = document.getElementById('blogDetail');

        blogLinks.forEach(card => {
            card.addEventListener('click', async () => {
                const articleId = card.dataset.articleId;
                const fileName = articleFileMap[articleId];

                if (fileName && blogDetailContent) {
                    // 1. Show Loading State
                    blogDetailContent.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-20">
                            <div class="loading-spinner mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div>
                            <p class="text-white/70">Loading article...</p>
                        </div>
                    `;
                    
                    // 2. Navigate
                    navigateTo('blogDetail');
                    window.scrollTo(0, 0);

                    // 3. Fetch and Parse
                    try {
                        const response = await fetch(`Articles/${fileName}`);
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                        const rawHtml = await response.text();
                        
                        // --- PARSING MAGIC ---
                        // Convert string to DOM to extract only the <body> content
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(rawHtml, 'text/html');
                        const bodyContent = doc.body.innerHTML;

                        // Inject the clean content
                        blogDetailContent.innerHTML = `<div class="article-content">${bodyContent}</div>`;

                    } catch (error) {
                        console.error('Error loading article:', error);
                        blogDetailContent.innerHTML = `
                            <div class="text-center py-20">
                                <h3 class="text-2xl font-bold text-red-400 mb-4"> Unable to Load Article</h3>
                                <p class="text-white/80">Could not load <strong>${fileName}</strong>.</p>
                            </div>
                        `;
                    }
                }
            });
        });
    }

    // 3. Initialize Logic
    setupBlogNavigation();

    // =========================================================
    // =====               END BLOG CONTENT                =====
    // =========================================================

    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('payment_success') === 'true') {
        console.log("PAYMENT SUCCESS: Unlocking Premium Features...");
        
        // 1. Unlock the limit immediately for this session
        currentSelectionLimit = 3; 
        
        // 2. Show visual confirmation
        const successMsg = document.createElement('div');
        successMsg.className = 'fixed top-20 right-5 p-6 bg-green-600 text-white rounded-xl shadow-2xl z-[200] flex items-center transform transition-all duration-500 translate-y-0 border border-green-400';
        successMsg.innerHTML = `
            <div class="text-4xl mr-4"></div> 
            <div>
                <h4 class="font-bold text-lg">Premium Unlocked!</h4>
                <p class="text-green-100 text-sm">Thank you for your purchase.</p>
            </div>`;
        document.body.appendChild(successMsg);
        
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.delete('payment_success');
        window.history.replaceState(null, null, newUrl.toString());
        
        // 4. Remove message after 5 seconds
        setTimeout(() => {
            successMsg.style.opacity = '0';
            successMsg.style.transform = 'translateY(-20px)';
            setTimeout(() => successMsg.remove(), 500);
        }, 5000);
    }
});
    </script>
</body>
</html>
