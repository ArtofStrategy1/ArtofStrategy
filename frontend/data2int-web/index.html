<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>S.A.G.E. - AI Strategy Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Three.js CDN for 3D animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- jsPDF for Save to PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Cytoscape.js CDN for graph visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.33.1/cytoscape.min.js"></script>
	
    <style>
        /* --- Base & Animated Background --- */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #667eea, #764ba2, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 18s ease infinite;
            color: #f9fafb;
            overflow-x: hidden;
            /* Prevent horizontal scroll due to animation */
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .page {
            display: none;
        }

        /* Hide all pages by default */
        .page.active {
            animation: fadeIn .5s ease-out;
        }

        /* Specific display rules for active pages */
        #home.active,
        #templates.active,
        #templateDetail.active,
        #examplesPage.active, #graphPage.active {
            display: block;
            /* Content pages */
        }

        #login.active,
        #signup.active {
            display: flex;
            /* Centered pages */
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        /* --- Glass & Card Effects --- */
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            /*backdrop-filter: blur(12px);*/
            /*-webkit-backdrop-filter: blur(12px);*/
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            transition: all .3s ease;
            text-align: center;
            /* Centered text within feature cards */
        }

        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .template-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: all .3s ease;
            cursor: pointer;
        }

        .template-card:hover {
            transform: translateY(-5px);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* --- Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            text-align: center;
        }

        .btn-primary {
            background: #4f46e5;
            color: #fff;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-tertiary {
            background: transparent;
            color: #c7d2fe;
            text-decoration: underline;
        }

        .btn-tertiary:hover {
            color: #fff;
        }

        /* --- Forms & Inputs --- */
        .input-field {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-field:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: #a78bfa;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
        }

        .error-message {
            color: #fca5a5;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(220, 38, 38, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .success-message {
            color: #a7f3d0;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(5, 150, 105, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        /* --- Loading Spinners --- */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 2rem;
        }

        .typing-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #a78bfa;
            animation: typing 1.4s infinite ease-in-out
        }

        .typing-dot:nth-child(1) {
            animation-delay: -.32s
        }

        .typing-dot:nth-child(2) {
            animation-delay: -.16s
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0s
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(.8);
                opacity: .5
            }

            40% {
                transform: scale(1);
                opacity: 1
            }
        }

        /* --- Three.js Canvas Styling --- */
        #threeJsCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            /* Ensure it's behind the gradient background */
            display: block;
            /* Ensure canvas is block-level */
        }

        /* Carousel specific styles */
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 9999px;
            /* Full circle */
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: background 0.3s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .carousel-button:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .carousel-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Increased distance from the edge of the glass-container */
        .carousel-button.left {
            left: -6rem;
        }

        .carousel-button.right {
            right: -6rem;
        }

        /* Adjust for smaller screens if needed */
        @media (max-width: 768px) {
            .carousel-button.left {
                left: 0.5rem;
            }

            .carousel-button.right {
                right: 0.5rem;
            }
        }

        /* Style for the example content within the carousel */
        .analysis-example-item {
            padding: 2.5rem;
            /* Match glass-container padding */
            margin-bottom: 0;
            /* Remove space-y-12 from individual items */
        }

        .analysis-example-item h3 {
            font-size: 1.5rem;
            /* Tailwind text-2xl equivalent */
            font-weight: 700;
            /* Tailwind font-bold equivalent */
            margin-bottom: 0.5rem;
            /* Tailwind mb-2 equivalent */
        }

        .analysis-example-item ul,
        .analysis-example-item ol {
            list-style-position: inside;
            margin-left: 1.25rem;
            /* Indent lists */
            margin-bottom: 1rem;
            /* Space after lists */
        }

        .analysis-example-item li {
            margin-bottom: 0.5rem;
            /* Space between list items */
        }

        /* Explicitly center list items and paragraphs in long descriptions */
        .feature-card .feature-description ul,
        .feature-card .feature-description ol,
        .feature-card .feature-description p {
            text-align: center;
        }

        /* WebSocket connection status indicator */
        .ws-status {
            position: static;
            top: 20px;
            right: 20px;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .ws-status.connected {
            background: rgba(5, 150, 105, 0.8);
            color: #a7f3d0;
        }

        .ws-status.disconnected {
            background: rgba(220, 38, 38, 0.8);
            color: #fca5a5;
        }

        .ws-status.connecting {
            background: rgba(245, 158, 11, 0.8);
            color: #fbbf24;
		}
		/* Cytoscape.js Graph Container Styling */
		#graph-container {
			position: relative;
			width: 90%;
			height: 600px; /* Adjust height as needed */
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 1.5rem;	/* The amount of rounding you want to apply */
			overflow: hidden; /* So content inside is also rounded */
			box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
			background-color: rgba(30, 30, 30, 0.8); 	/* Slightly transparent background */
			padding: 1.5rem;
		}

		.graph-inner {
			position: relative;
			width: 100%;
			height: 100%;
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 1.5rem;	/* The amount of rounding you want to apply */
			overflow: hidden; /* So content inside is also rounded */
			margin: 0
        }


        /* Glassy Checkboxes */
        .method-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .method-checkbox:checked {
            background: rgba(79, 70, 229, 0.8);
            border-color: rgba(167, 139, 250, 0.9);
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.7);
            transform: scale(1.15);
        }

        .method-checkbox:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.7);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Three.js Canvas for Animated Background -->
    <canvas id="threeJsCanvas"></canvas>
    <div id="wsStatus" class="ws-status disconnected">Disconnected</div>

    <!-- ========================================================= -->
    <!-- NAVIGATION BAR                                            -->
    <!-- ========================================================= -->
    <nav class="bg-black/10 backdrop-blur-sm p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-white nav-link" data-page="home">S.A.G.E.</a>
            <div>
                <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link" data-page="home">Home</a>
                <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link" data-page="templates">Templates</a>
                <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link" data-page="login">Login</a>
				<a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link" data-page="graphPage">Knowledge Graph</a>
            </div>
        </div>
    </nav>

    <!-- ========================================================= -->
    <!-- HOME PAGE                                                 -->
    <!-- ========================================================= -->
    <div id="home" class="page active container mx-auto px-6 py-16 text-center">
        <h1 class="text-5xl md:text-6xl font-extrabold text-white leading-tight mb-4">Unlock Your Strategic Potential
        </h1>
        <p class="text-lg md:text-xl text-white/80 max-w-3xl mx-auto mb-8">
            Transform your organization with comprehensive strategic planning tools and methodologies designed to drive
            success and innovation.
        </p>
        <div class="flex justify-center space-x-4">
            <button class="btn btn-primary nav-link" data-page="templates">Get Started</button>
            <button class="btn btn-secondary nav-link" data-page="examplesPage">View Analysis</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-20">
            <div class="feature-card p-6" data-feature-id="vision">
                <h3 class="text-2xl font-bold mb-2">Vision</h3>
                <p class="text-white/70 mb-4 feature-description" data-state="short">We help you craft a clear vision
                    with detailed strategic steps that will transform your organization and position you for long-term
                    success in an ever-changing marketplace.</p>
                <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn"
                    data-feature-id="vision">More &rarr;</a>
            </div>
            <div class="feature-card p-6" data-feature-id="mission">
                <h3 class="text-2xl font-bold mb-2">Mission or Aim</h3>
                <p class="text-white/70 mb-4 feature-description" data-state="short">Define your organization's core
                    purpose and establish the foundational principles that will guide all strategic decisions and
                    operational activities.</p>
                <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn"
                    data-feature-id="mission">More &rarr;</a>
            </div>
            <div class="feature-card p-6" data-feature-id="goals">
                <h3 class="text-2xl font-bold mb-2">Goals</h3>
                <p class="text-white/70 mb-4 feature-description" data-state="short">Set ambitious yet achievable goals
                    that align with your vision and mission, creating a clear pathway to success with measurable
                    milestones and timelines.</p>
                <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn"
                    data-feature-id="goals">More &rarr;</a>
            </div>
            <div class="feature-card p-6" data-feature-id="strategic-initiatives">
                <h3 class="text-2xl font-bold mb-2">Strategic Initiatives</h3>
                <p class="text-white/70 mb-4 feature-description" data-state="short">Develop comprehensive strategic
                    initiatives that translate your vision into actionable plans, ensuring effective resource allocation
                    and timeline management.</p>
                <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn"
                    data-feature-id="strategic-initiatives">More &rarr;</a>
            </div>
            <div class="feature-card p-6" data-feature-id="objectives">
                <h3 class="text-2xl font-bold mb-2">Objectives</h3>
                <p class="text-white/70 mb-4 feature-description" data-state="short">Break down your goals into
                    specific, measurable objectives that provide clear direction and enable effective progress tracking
                    throughout your organization.</p>
                <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn"
                    data-feature-id="objectives">More &rarr;</a>
            </div>
            <div class="feature-card p-6" data-feature-id="actions">
                <h3 class="text-2xl font-bold mb-2">Actions</h3>
                <p class="text-white/70 mb-4 feature-description" data-state="short">Define specific actions and tactics
                    that will drive the achievement of your objectives, with clear accountability and timeline
                    specifications.</p>
                <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn"
                    data-feature-id="actions">More &rarr;</a>
            </div>
        </div>
    </div>

    <!-- ========================================================= -->
    <!-- LOGIN PAGE                                                -->
    <!-- ========================================================= -->
    <div id="login" class="page flex items-center justify-center min-h-[80vh]">
        <div class="w-full max-w-md">
            <div class="glass-container">
                <h2 class="text-3xl font-bold mb-6 text-center text-white">Sign In</h2>
                <div class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                        <input type="email" id="loginEmail" class="input-field" placeholder="Enter your email" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                        <input type="password" id="loginPassword" class="input-field" placeholder="Enter your password"
                            required>
                    </div>
                    <button id="loginBtn" class="btn btn-primary w-full">
                        <span id="loginBtnText">Sign In</span>
                        <span id="loginSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                    <div id="loginMessage" class="hidden"></div>
                </div>
                <div class="text-center mt-6">
                    <p class="text-gray-300">Don't have an account?</p>
                    <button class="btn-tertiary nav-link" data-page="signup">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================================= -->
    <!-- SIGNUP PAGE                                               -->
    <!-- ========================================================= -->
    <div id="signup" class="page flex items-center justify-center min-h-[80vh]">
        <div class="w-full max-w-md">
            <div class="glass-container">
                <h2 class="text-3xl font-bold mb-6 text-center text-white">Create Account</h2>
                <div class="space-y-4">
                    <div>
                        <label for="registerFirstName" class="block text-sm font-medium text-gray-200 mb-2">First
                            Name</label>
                        <input type="text" id="registerFirstName" class="input-field"
                            placeholder="Enter your First Name" required>
                    </div>
                    <div>
                        <label for="registerLastName" class="block text-sm font-medium text-gray-200 mb-2">Last
                            Name</label>
                        <input type="text" id="registerLastName" class="input-field" placeholder="Enter your Last Name"
                            required>
                    </div>
                    <div>
                        <label for="registerEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                        <input type="email" id="registerEmail" class="input-field" placeholder="Enter your email"
                            required>
                    </div>
                    <div>
                        <label for="registerPassword"
                            class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                        <input type="password" id="registerPassword" class="input-field" placeholder="Create a password"
                            required>
                    </div>
                    <div>
                        <label for="registerConfirmPassword"
                            class="block text-sm font-medium text-gray-200 mb-2">Confirm Password</label>
                        <input type="password" id="registerConfirmPassword" class="input-field"
                            placeholder="Confirm your password" required>
                    </div>
                    <button id="registerBtn" class="btn btn-primary w-full">
                        <span id="registerBtnText">Create Account</span>
                        <span id="registerSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                    <div id="registerMessage" class="hidden"></div>
                </div>
                <div class="text-center mt-6">
                    <p class="text-gray-300">Already have an account?</p>
                    <button class="btn-tertiary nav-link" data-page="login">Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================================= -->
    <!-- TEMPLATES LIST PAGE                                       -->
    <!-- ========================================================= -->
    <div id="templates" class="page container mx-auto px-6 py-16">
        <h1 class="text-4xl font-bold text-center mb-2">Strategy Templates</h1>
        <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Select a professional analysis template to
            begin. Our AI will guide you through a structured framework to generate powerful strategic insights.</p>
        <div id="templatesList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Template cards will be dynamically inserted here by JavaScript -->
        </div>
    </div>

    <!-- ========================================================= -->
    <!-- TEMPLATE DETAIL PAGE (Fixed: Checkboxes always visible)   -->
    <!-- ========================================================= -->
    <div id="templateDetail" class="page container mx-auto px-6 py-16">
        <button class="btn btn-secondary mb-8 nav-link" data-page="templates">&larr; Back to Templates</button>
        <div class="grid lg:grid-cols-2 gap-12">

            <!-- Left side: Form -->
            <div>
                <h1 id="templateTitle" class="text-4xl font-bold mb-4">Template Title</h1>
                <p id="templateDescription" class="text-white/80 mb-8">Template description goes here.</p>

                <div class="glass-container p-6">
                    <div id="templateFormFields" class="space-y-4"></div>

                    <!-- âœ… Checkboxes are here (visible before generate) -->
                    <div id="methodsConsideredContainer" class="glass-container mt-8">
                        <h4 class="text-xl font-bold mb-2 text-white text-center">Select up to 3 methods:</h4>
                        <p id="selectionCounter" class="text-white/70 text-center mb-4">Selected: 0 / 3</p>
                        <ul class="list-none text-white/70 text-left mx-auto max-w-sm">
                            <li class="flex items-center mb-2">
                                <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                <span>Reframing Thinking</span>
                            </li>
                            <li class="flex items-center mb-2">
                                <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                <span>Delphi Method</span>
                            </li>
                            <li class="flex items-center mb-2">
                                <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                <span>Blue Ocean Strategy</span>
                            </li>
                            <li class="flex items-center mb-2">
                                <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                <span>Design Thinking</span>
                            </li>
                            <li class="flex items-center mb-2">
                                <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                <span>Thinking Hats</span>
                            </li>
                            <li class="flex items-center mb-2">
                                <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                <span>Business Model Canvas</span>
                            </li>
                            <li class="flex items-center mb-2">
                                <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                <span>SCAMPER</span>
                            </li>
                            <li class="flex items-center mb-2">
                                <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                <span>TRIZ (Theory of Inventive Problem Solving)</span>
                            </li>
                        </ul>
                    </div>

                    <button id="generateBtn" class="btn btn-primary w-full mt-4">
                        <span id="generateBtnText">Generate Analysis</span>
                        <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                </div>
            </div>

            <!-- Right side: Result and PDF -->
            <div>
                <h2 class="text-3xl font-bold mb-4">Generated Analysis</h2>
                <div id="analysisResult" class="glass-container min-h-[300px] whitespace-pre-wrap overflow-x-auto">
                    <div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>
                </div>
                <!-- Move save button outside the result container -->
                <div class="text-center mt-4">
                    <button id="savePdfBtn" class="btn btn-secondary hidden">Save as PDF</button>
                </div>
            </div>

        </div>
    </div>

    <!-- New Glass Box for Methods -->
    </div>
    </div>
    </div>

    <!-- ========================================================= -->
    <!-- AI EXAMPLES PAGE (NEW)                                    -->
    <!-- ========================================================= -->
    <div id="examplesPage" class="page container mx-auto px-6 py-16">
        <h1 class="text-4xl font-bold text-center mb-2">AI Analysis Examples</h1>
        <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">See how S.A.G.E. can transform complex data
            into actionable strategic insights with these example outputs.</p>

        <div id="analysisCarousel" class="relative max-w-4xl mx-auto glass-container p-0">
            <!-- Example 1: SWOT Analysis -->
            <div class="analysis-example-item">
                <h2 class="text-3xl font-bold mb-4">Example: SWOT Analysis for "GlobalTech Solutions"</h2>
                <div class="text-white/70">
                    <h3>STRENGTHS:</h3>
                    <ul>
                        <li><strong>Strong R&D Department:</strong> GlobalTech consistently innovates, holding numerous
                            patents in AI and quantum computing.</li>
                        <li><strong>Global Presence:</strong> Established offices and client base across North America,
                            Europe, and Asia.</li>
                        <li><strong>Talented Workforce:</strong> Highly skilled engineers and data scientists, fostering
                            a culture of excellence.</li>
                    </ul>

                    <h3>WEAKNESSES:</h3>
                    <ul>
                        <li><strong>High Operating Costs:</strong> Extensive R&D and global infrastructure lead to
                            significant overheads.</li>
                        <li><strong>Limited Marketing Reach:</strong> Reliance on word-of-mouth and niche industry
                            events, missing broader market segments.</li>
                        <li><strong>Bureaucratic Processes:</strong> Slow decision-making due to multi-layered approval
                            systems.</li>
                    </ul>

                    <h3>OPPORTUNITIES:</h3>
                    <ul>
                        <li><strong>Emerging Markets:</strong> Untapped potential in developing economies for AI-driven
                            solutions.</li>
                        <li><strong>Strategic Partnerships:</b> Collaboration with hardware manufacturers to integrate
                                AI software.</li>
                        <li><strong>Government Grants:</strong> Increased funding for AI research and development
                            initiatives.</li>
                    </ul>

                    <h3>THREATS:</h3>
                    <ul>
                        <li><strong>Intense Competition:</strong> Rapidly evolving tech landscape with new startups and
                            established giants.</li>
                        <li><strong>Talent Drain:</strong> High demand for skilled AI professionals leading to
                            competitive recruitment.</li>
                        <li><strong>Regulatory Changes:</strong> Evolving data privacy and AI ethics regulations
                            impacting product development.</li>
                    </ul>

                    <h3>Strategic Recommendations:</h3>
                    <ol>
                        <li><strong>Optimize Cost Structure:</strong> Implement agile methodologies to reduce R&D cycle
                            times and explore automation in operational processes.</li>
                        <li><strong>Expand Marketing Channels:</strong> Invest in digital marketing and content strategy
                            to reach a wider audience and enhance brand visibility.</li>
                        <li><strong>Forge Key Alliances:</strong> Actively pursue partnerships with complementary
                            technology providers to expand market reach and product offerings.</li>
                    </ol>
                </div>
            </div>

            <!-- Example 2: Market Entry Strategy for "EcoCycle Innovations" -->
            <div class="analysis-example-item hidden">
                <h2 class="text-3xl font-bold mb-4">Example: Market Entry Strategy for "EcoCycle Innovations" into
                    Southeast Asia</h2>
                <div class="text-white/70">
                    <h3>MARKET ASSESSMENT:</h3>
                    <ul>
                        <li><strong>Market Size & Growth:</strong> Southeast Asia's recycling and waste management
                            market is projected to grow at a CAGR of 8% over the next five years, driven by increasing
                            environmental awareness and government initiatives.</li>
                        <li><strong>Customer Segments:</strong> Key segments include industrial waste generators,
                            municipal waste facilities, and commercial enterprises seeking sustainable solutions.</li>
                        <li><strong>Market Maturity:</strong> Varies by country; Singapore and Malaysia are more mature,
                            while Vietnam and Indonesia are emerging.</li>
                    </ul>

                    <h3>COMPETITIVE LANDSCAPE:</h3>
                    <ul>
                        <li><strong>Key Players:</strong> Dominated by local players with strong government ties and a
                            few international waste management giants.</li>
                        <li><strong>Competitive Advantages:</strong> Local players often have lower operational costs
                            and established networks. EcoCycle's advanced waste-to-energy technology offers a unique
                            value proposition.</li>
                    </ul>

                    <h3>ENTRY STRATEGY OPTIONS:</h3>
                    <ol>
                        <li><strong>Joint Venture (JV) with Local Partner:</strong> Recommended approach. A JV allows
                            EcoCycle to leverage local expertise, navigate regulatory complexities, and gain immediate
                            market access.
                            <ul>
                                <li><strong>Pros:</strong> Reduced risk, faster market penetration, access to local
                                    networks.</li>
                                <li><strong>Cons:</strong> Potential for cultural clashes, profit sharing.</li>
                            </ul>
                        </li>
                        <li><strong>Greenfield Investment:</strong> Building new facilities.
                            <ul>
                                <li><strong>Pros:</strong> Full control, tailor-made operations.</li>
                                <li><strong>Cons:</strong> High capital investment, long lead times, significant
                                    regulatory hurdles.</li>
                            </ul>
                        </li>
                    </ol>

                    <h3>Implementation Roadmap:</h3>
                    <ul>
                        <li><strong>Phase 1 (Months 1-6):</strong> Partner identification and due diligence. Focus on
                            countries with favorable regulatory environments (e.g., Malaysia, Thailand).</li>
                        <li><strong>Phase 2 (Months 7-18):</strong> JV formation and pilot project initiation. Secure
                            initial contracts with industrial clients.</li>
                        <li><strong>Phase 3 (Months 19-36):</b> Scale operations, expand service offerings, and explore
                                opportunities in other SEA markets.</li>
                    </ul>
                </div>
            </div>

            <!-- Example 3: Digital Transformation Roadmap for "RetailX" -->
            <div class="analysis-example-item hidden">
                <h2 class="text-3xl font-bold mb-4">Example: Digital Transformation Roadmap for "RetailX"</h2>
                <div class="text-white/70">
                    <h3>VISION & OBJECTIVES:</h3>
                    <ul>
                        <li><strong>Vision:</strong> To become a leading omnichannel retailer, leveraging digital
                            technologies to enhance customer experience, optimize operations, and drive sustainable
                            growth.</li>
                        <li><strong>Objectives:</strong> Increase online sales by 30% within 2 years, reduce operational
                            costs by 15% through automation, and improve customer satisfaction scores by 20%.</li>
                    </ul>

                    <h3>CURRENT STATE ASSESSMENT:</h3>
                    <ul>
                        <li><strong>Digital Capabilities:</strong> Fragmented legacy systems, limited e-commerce
                            capabilities, manual inventory management.</li>
                        <li><strong>Pain Points:</strong> Inconsistent customer experience across channels, inefficient
                            supply chain, lack of real-time data for decision-making.</li>
                    </ul>

                    <h3>KEY PILLARS OF TRANSFORMATION:</h3>
                    <ol>
                        <li><strong>Customer Experience:</strong> Unify online and offline channels, personalize
                            customer journeys.</li>
                        <li><strong>Operational Efficiency:</strong> Automate back-office processes, optimize supply
                            chain.</li>
                        <li><strong>Data & Analytics:</strong> Implement robust data infrastructure, leverage AI for
                            insights.</li>
                        <li><strong>Culture & Talent:</strong> Foster digital-first mindset, upskill workforce.</li>
                    </ol>

                    <h3>INITIATIVES & TECHNOLOGIES:</h3>
                    <ul>
                        <li><strong>Customer Experience:</strong> CRM implementation (Salesforce), E-commerce platform
                            upgrade (Shopify Plus), AI-powered chatbots.</li>
                        <li><strong>Operational Efficiency:</strong> ERP system integration (SAP), Warehouse Management
                            System (WMS), Robotic Process Automation (RPA) for routine tasks.</li>
                        <li><strong>Data & Analytics:</strong> Data Lake/Warehouse (Snowflake), Business Intelligence
                            tools (Tableau), Predictive Analytics.</li>
                        <li><strong>Culture & Talent:** Digital literacy training, change management programs.</li>
                    </ul>

                    <h3>PHASED IMPLEMENTATION PLAN:</h3>
                    <ul>
                        <li><strong>Short-term (0-6 months):</strong> CRM implementation, basic e-commerce upgrade,
                            pilot RPA for finance.</li>
                        <li><strong>Mid-term (6-18 months):</strong> Full ERP integration, advanced e-commerce features,
                            initial data lake setup, comprehensive digital training.</li>
                        <li><strong>Long-term (18+ months):</strong> AI-driven personalization, predictive supply chain,
                            expansion into new digital services.</li>
                    </ul>

                    <h3>MEASUREMENT & KPIs:</h3>
                    <ul>
                        <li>Online Conversion Rate, Customer Lifetime Value, Order Fulfillment Time, Inventory Accuracy,
                            Employee Digital Proficiency.</li>
                    </ul>
                </div>
            </div>

            <!-- Carousel Navigation Buttons -->
            <button id="prevExampleBtn" class="carousel-button left">&larr;</button>
            <button id="nextExampleBtn" class="carousel-button right">&rarr;</button>
        </div>
        <div class="text-center text-white/80 mt-4">
            <span id="exampleCounter">1 of 3</span>
        </div>

        <div class="text-center mt-12">
            <button class="btn btn-primary nav-link" data-page="templates">View Templates</button>
        </div>
	</div>
    <!-- ========================================================= -->
    <!-- GRAPH VISUALIZATION PAGE (NEW)                            -->
    <!-- ========================================================= -->
    <div id="graphPage" class="page container mx-auto px-6 py-16">
        <h1 class="text-4xl font-bold text-center mb-2">Knowledge Graph Visualization</h1>
        <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Explore the relationships between entities in an interactive knowledge graph.</p>
        <div id="graph-container">
			<div class="graph-inner"></div>
		</div>
    </div>


    <script type="module">
        // =========================================================
        // SCRIPT
        // =========================================================
        	// Load NVL base library
	import { NVL } from "https://esm.sh/@neo4j-nvl/base@0.3.9/es2022/base.mjs";
	import { 
		ClickInteraction,
		ZoomInteraction,
		PanInteraction,
		DragNodeInteraction,
		HoverInteraction 
	} from "https://esm.sh/@neo4j-nvl/interaction-handlers@0.3.9/es2022/interaction-handlers.mjs";
document.addEventListener('DOMContentLoaded', () => {

            // --- Supabase Configuration ---
            const SUPABASE_URL = 'https://supabase.data2int.com'
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNjQwOTk1MjAwLCJleHAiOjE5NTYzNTUyMDB9.KHXKQpsN6MNB08H_IPxP4Gh0gjcsvXG9IeJuK3XpnAU'

            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

            // --- DOM Element References ---
            const $ = id => document.getElementById(id);
            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const templatesListContainer = $('templatesList');
            const templateDetailContainer = $('templateDetail');
            let currentTemplateId = null; // To store the ID of the selected template
            let websocket = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            const reconnectDelay = 3000; // 3 seconds
            let pendingAnalysisRequests = new Map()


            // --- User Session State ---
            let userLoggedIn = false; // This will track if a user is logged in

            // --- Template Data ---
            const templates = {
                'custom-template': {
                    title: 'Custom Strategy Generator',
                    description: 'Design your own strategic analysis by defining the type of strategy, company, use case, and location.',
                    isPremium: true,
                    // No fixed prompt here, it will be generated from user inputs
                },
                'swot': {
                    title: 'SWOT Analysis',
                    description: "Analyze your organization's Strengths, Weaknesses, Opportunities, and Threats with a comprehensive framework.",
                    prompt: `Please conduct a comprehensive SWOT analysis for my organization. I need you to help me identify and analyze:

STRENGTHS (Internal Positive Factors):
- What advantages do we have over competitors?
- What do we do well?
- What unique resources or assets do we have?
- What do others see as our strengths?

WEAKNESSES (Internal Negative Factors):
- What areas need improvement?
- Where do we lack resources?
- What do competitors do better?
- What internal factors limit our performance?

OPPORTUNITIES (External Positive Factors):
- What market trends could benefit us?
- What changes in technology, regulations, or society could we leverage?
- What gaps exist in the market?
- What partnerships or alliances could benefit us?

THREATS (External Negative Factors):
- What obstacles do we face?
- What competitive threats exist?
- What external changes could harm us?
- What regulatory or economic challenges loom?

Please provide a structured analysis with actionable insights and strategic recommendations based on the SWOT matrix.`
                },
                'competitor': {
                    title: 'Competitor Analysis',
                    description: 'Deep dive into competitor strategies, market positioning, and competitive advantages to inform your strategy.',
                    prompt: `I need a comprehensive competitor analysis. Please help me analyze my competitive landscape using this framework:

COMPETITOR IDENTIFICATION:
- Who are our direct competitors?
- Who are our indirect competitors?
- Who are potential future competitors?

COMPETITIVE ANALYSIS FRAMEWORK:
1. Market Position & Share
2. Products/Services Comparison
3. Pricing Strategies
4. Marketing & Brand Positioning
5. Strengths & Weaknesses
6. Financial Performance (if available)
7. Strategic Direction & Future Plans

COMPETITIVE INTELLIGENCE:
- What are competitors doing well that we should learn from?
- Where are their vulnerabilities?
- What opportunities exist due to competitor gaps?
- How do customers perceive competitors vs. our brand?`
                },
                'market-entry': {
                    title: 'Market Entry Strategy',
                    description: 'Evaluate market opportunities, entry barriers, and develop a roadmap for successful market penetration.',
                    prompt: `I need help developing a market entry strategy. Please guide me through a comprehensive analysis covering:

MARKET ASSESSMENT:
- Market size and growth potential
- Customer segments and needs analysis
- Market maturity and lifecycle stage
- Regulatory environment and requirements

COMPETITIVE LANDSCAPE:
- Key players and their market positions
- Competitive advantages and barriers
- Pricing strategies and profit margins
- Distribution channels and partnerships

ENTRY STRATEGY OPTIONS:
1. Direct export/online sales
2. Licensing or franchising
3. Joint ventures or partnerships
4. Acquisitions or mergers
5. Greenfield investment (new operations)`
                },
                'financial': {
                    title: 'Financial Projections',
                    description: 'Create comprehensive financial forecasts, budgets, and scenario planning for strategic decision-making.',
                    prompt: `I need help creating comprehensive financial projections and analysis. Please assist with:

REVENUE PROJECTIONS:
- Sales forecasting methodologies
- Market size and penetration assumptions
- Pricing strategy analysis

COST STRUCTURE ANALYSIS:
- Fixed vs. variable cost breakdown
- Cost of goods sold (COGS) analysis
- Operating expense projections

PROFITABILITY ANALYSIS:
- Gross margin analysis
- Operating margin projections
- Net profit forecasting
- Break-even analysis`
                },
                'risk': {
                    title: 'Risk Assessment',
                    description: 'Identify, evaluate, and develop mitigation strategies for business risks across all operational areas.',
                    prompt: `I need a comprehensive risk assessment and management strategy. Please help me analyze and address:

RISK IDENTIFICATION:
- Strategic Risks (Market, competitive, technology)
- Operational Risks (Supply chain, process failures, human resource)
- Financial Risks (Credit, liquidity, market)
- External Risks (Economic, political, cybersecurity)

RISK ASSESSMENT MATRIX:
- For each risk: Probability, Impact, Priority

RISK MITIGATION STRATEGIES:
- Avoidance, Reduction, Transfer, Acceptance`
                },
                'business-model': {
                    title: 'Business Model Canvas',
                    description: 'Design and analyze your business model using the proven 9-building-block framework for strategic clarity.',
                    prompt: `Let's design and analyze your business model using the Business Model Canvas framework. I'll guide you through each of the 9 building blocks:
1. Customer Segments
2. Value Propositions
3. Channels
4. Customer Relationships
5. Revenue Streams
6. Key Resources
7. Key Activities
8. Key Partnerships
9. Cost Structure`
                },
                'marketing-plan': {
                    title: 'Marketing Plan Development',
                    description: 'Craft a detailed marketing strategy, including target audience, channels, and campaign planning.',
                    prompt: `Develop a comprehensive marketing plan for my organization. Please include the following sections:

1.  **Executive Summary:** Brief overview of the plan.
2.  **Situational Analysis:**
    * Market Analysis (size, trends, growth)
    * Target Audience (demographics, psychographics, needs)
    * Competitor Analysis (key players, strategies)
    * SWOT Analysis (Strengths, Weaknesses, Opportunities, Threats)
3.  **Marketing Objectives:** SMART (Specific, Measurable, Achievable, Relevant, Time-bound) objectives.
4.  **Marketing Strategy:**
    * Product/Service Strategy
    * Pricing Strategy
    * Distribution Strategy (Place)
    * Promotion Strategy (Communication channels, messaging)
5.  **Action Plan:** Specific tactics, timelines, and responsibilities.
6.  **Budget:** Allocation of resources.
7.  **Measurement & Evaluation:** KPIs and methods for tracking success.`
                },
                'product-launch': {
                    title: 'Product Launch Strategy',
                    description: 'Plan a successful product launch from pre-launch to post-launch activities and market adoption.',
                    prompt: `Outline a detailed product launch strategy for a new product/service. Cover the following phases:

1.  **Pre-Launch Phase:**
    * Market Research & Validation
        * Product Development & Testing
    * Pricing & Packaging Strategy
    * Distribution Channel Selection
    * Marketing & Communication Plan (messaging, branding)
    * Sales Team Training
    * Customer Support Readiness
2.  **Launch Phase:**
    * Launch Event/Announcement
    * Initial Marketing Campaigns
    * Sales Activities
    * PR & Media Relations
3.  **Post-Launch Phase:**
    * Performance Monitoring (sales, adoption, feedback)
    * Customer Feedback Collection & Iteration
    * Scalability Planning
    * Ongoing Marketing & Sales Support
    * Contingency Planning`
                },
                'customer-segmentation': {
                    title: 'Customer Segmentation Analysis',
                    description: 'Identify and analyze distinct customer groups to tailor marketing and product development efforts.',
                    prompt: `Perform a customer segmentation analysis for my business. Identify key segments and and provide insights on how to target them effectively. Consider the following criteria:

1.  **Demographic Segmentation:** (Age, gender, income, education, occupation, family status)
2.  **Geographic Segmentation:** (Location, climate, urban/rural)
3.  **Psychographic Segmentation:** (Lifestyle, values, attitudes, interests, personality traits)
4.  **Behavioral Segmentation:** (Purchase history, usage rate, brand loyalty, benefits sought, readiness to buy)

For each identified segment, provide:
-   A clear profile.
-   Their unique needs and pain points.
-   Recommended value propositions.
-   Preferred communication channels.
-   Potential product/service adaptations.`
                },
                'supply-chain-opt': {
                    title: 'Supply Chain Optimization',
                    description: 'Identify inefficiencies and opportunities to streamline your supply chain for cost savings and improved delivery.',
                    prompt: `Conduct an analysis for supply chain optimization. Focus on identifying areas for improvement in efficiency, cost-effectiveness, and resilience. Address the following:

1.  **Current State Assessment:**
    * Mapping of the existing supply chain (suppliers, production, distribution, customers).
    * Identification of key processes and bottlenecks.
    * Analysis of current costs (procurement, production, logistics, inventory).
2.  **Key Challenges & Opportunities:**
    * Areas of inefficiency (e.g., excess inventory, long lead times, transportation costs).
    * Vulnerabilities (e.g., single-source suppliers, geopolitical risks).
    * Opportunities for technology adoption (e.g., automation, AI, blockchain).
3.  **Optimization Strategies:**
    * Inventory Management (e.g., JIT, safety stock optimization).
    * Logistics & Transportation (e.g., route optimization, carrier selection).
    * Supplier Relationship Management.
    * Demand Forecasting Improvement.
    * Sustainability Initiatives.
4.  **Implementation Roadmap:** Prioritized actions and expected outcomes.`
                },
                'hr-strategy': {
                    title: 'Human Resources Strategy',
                    description: 'Develop an HR strategy aligned with business goals, covering talent acquisition, development, and retention.',
                    prompt: `Create a strategic human resources plan aligned with overall business objectives. Address the following core components:

1.  **Workforce Planning:**
    * Current workforce analysis (skills, demographics).
    * Future workforce needs (talent gaps, growth projections).
    * Succession planning.
2.  **Talent Acquisition Strategy:**
    * Recruitment channels and employer branding.
    * Candidate experience.
    * Onboarding process.
3.  **Talent Development & Training:**
    * Learning and development programs.
    * Performance management systems.
    * Career pathing.
4.  **Compensation & Benefits:**
    * Competitive pay structures.
    * Employee benefits and wellness programs.
    * Employee well-being initiatives.
5.  **Employee Engagement & Retention:**
    * Culture and values.
    * Recognition programs.
    * Employee well-being initiatives.
6.  **HR Technology & Analytics:** Leveraging HRIS and data for decision-making.`
                },
                'digital-transformation': {
                    title: 'Digital Transformation Roadmap',
                    description: 'Plan your organization\'s journey towards digital maturity, integrating technology across all business functions.',
                    prompt: `Develop a digital transformation roadmap for my organization. This roadmap should outline key areas for digital adoption and a phased implementation plan. Include:

1.  **Vision & Objectives:** What does digital transformation mean for us, and what are our key goals?
2.  **Current State Assessment:**
    * Analysis of existing digital capabilities and infrastructure.
    * Identification of pain points and legacy systems.
    * Assessment of digital maturity across departments.
3.  **Key Pillars of Transformation:** (e.g., Customer Experience, Operational Efficiency, New Business Models, Data & Analytics, Culture & Talent)
4.  **Initiatives & Technologies:**
    * Specific digital projects (e.g., CRM implementation, cloud migration, AI integration, automation).
    * Required technologies and platforms.
    * **Phased Implementation Plan:**
    * Short-term (0-6 months): Quick wins, foundational changes.
    * Mid-term (6-18 months): Core system integrations, process automation.
    * Long-term (18+ months): AI-driven personalization, predictive supply chain, expansion into new digital services.
6.  **Change Management & Culture:** Strategies for fostering a digital-first mindset.
7.  **Measurement & KPIs:** How will we track the success of our digital transformation?`
                }
            };

            // --- Feature Content Data ---
            const featureContent = {
                'vision': {
                    short: "We help you craft a clear vision with detailed strategic steps that will transform your organization and position you for long-term success in an ever-changing marketplace.",
                    long: `<strong>Our Vision Framework</strong>
            <p style="text-align: center;">Our comprehensive vision development process includes stakeholder alignment, future scenario planning, and measurable outcome definition. We work with your team to create a vision that inspires action and provides clear direction for organizational growth.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Stakeholder engagement and alignment</li>
                <li style="text-align: center;">Market trend analysis and future forecasting</li>
                <li style="text-align: center;">Vision statement development and refinement</li>
                <li style="text-align: center;">Implementation roadmap creation</li>
            </ul>`
                },
                'mission': {
                    short: "Define your organization's core purpose and establish the foundational principles that will guide all strategic decisions and operational activities.",
                    long: `<strong>Mission Development Process</strong>
            <p style="text-align: center;">We facilitate workshops to help you articulate your organization's fundamental purpose, core values, and primary objectives. This process ensures alignment across all levels of your organization.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Purpose clarification sessions</li>
                <li style="text-align: center;">Value proposition development</li>
                <li style="text-align: center;">Mission statement crafting</li>
                <li style="text-align: center;">Organizational alignment verification</li>
            </ul>`
                },
                'goals': {
                    short: "Set ambitious yet achievable goals that align with your vision and mission, creating a clear pathway to success with measurable milestones and timelines.",
                    long: `<strong>SMART Goals Framework</strong>
            <p style="text-align: center;">Our goal-setting methodology ensures your objectives are Specific, Measurable, Achievable, Relevant, and Time-bound. We help you create both short-term and long-term goals that drive meaningful progress.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Strategic objective identification</li>
                <li style="text-align: center;">KPI and metric development</li>
                <li style="text-align: center;">Timeline and milestone planning</li>
                <li style="text-align: center;">Resource allocation planning</li>
            </ul>`
                },
                'strategic-initiatives': {
                    short: "Develop comprehensive strategic initiatives that translate your vision into actionable plans, ensuring effective resource allocation and timeline management.",
                    long: `<strong>Initiative Development</strong>
            <p style="text-align: center;">We help you identify and prioritize strategic initiatives that will have the greatest impact on achieving your organizational goals. Each initiative includes detailed planning, resource requirements, and success metrics.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Initiative prioritization matrix</li>
                <li style="text-align: center;">Resource requirement analysis</li>
                <li style="text-align: center;">Risk assessment and mitigation</li>
                <li style="text-align: center;">Implementation timeline development</li>
            </ul>`
                },
                'objectives': {
                    short: "Break down your goals into specific, measurable objectives that provide clear direction and enable effective progress tracking throughout your organization.",
                    long: `<strong>Objective Setting Framework</strong>
            <p style="text-align: center;">Our systematic approach to objective setting ensures alignment with strategic goals while maintaining flexibility for changing market conditions and organizational needs.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Objective hierarchy development</li>
                <li style="text-align: center;">Performance indicator definition</li>
                <li style="text-align: center;">Progress tracking systems</li>
                <li style="text-align: center;">Review and adjustment protocols</li>
            </ul>`
                },
                'actions': {
                    short: "Define specific actions and tactics that will drive the achievement of your objectives, with clear accountability and timeline specifications.",
                    long: `<strong>Action Planning</strong>
            <p style="text-align: center;">We help you create detailed action plans that specify who, what, when, and how for each strategic initiative, ensuring nothing falls through the cracks.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Task breakdown and assignment</li>
                <li style="text-align: center;">Timeline and dependency mapping</li>
                <li style="text-align: center;">Resource allocation and budgeting</li>
                <li style="text-align: center;">Progress monitoring systems</li>
            </ul>`
                }
            };


            // WebSocket Management Functions
            function initializeWebSocket() {
                const wsStatus = document.getElementById('wsStatus');

                try {
                    // FastAPI listener's WebSocket endpoint
                    websocket = new WebSocket('wss://n8n-api.data2int.com/ws');

                    wsStatus.textContent = 'Connecting...';
                    wsStatus.className = 'ws-status connecting';

                    websocket.onopen = function (event) {
                        console.log('WebSocket connected successfully');
                        wsStatus.textContent = 'Connected';
                        wsStatus.className = 'ws-status connected';
                        reconnectAttempts = 0; // Reset reconnect attempts on successful connection
                    };

                    websocket.onmessage = function (event) {
                        console.log('Received WebSocket message:', event.data);

                        try {
                            const data = JSON.parse(event.data);
                            handleWebSocketMessage(data);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };

                    websocket.onclose = function (event) {
                        console.log('WebSocket connection closed:', event.code, event.reason);
                        wsStatus.textContent = 'Disconnected';
                        wsStatus.className = 'ws-status disconnected';

                        // Attempt to reconnect unless it was a manual close
                        if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                            setTimeout(() => {
                                reconnectAttempts++;
                                console.log(`WebSocket reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                                initializeWebSocket();
                            }, reconnectDelay);
                        }
                    };

                    websocket.onerror = function (error) {
                        console.error('WebSocket error:', error);
                        wsStatus.textContent = 'Error';
                        wsStatus.className = 'ws-status disconnected';
                    };

                } catch (error) {
                    console.error('Failed to initialize WebSocket:', error);
                    wsStatus.textContent = 'Failed';
                    wsStatus.className = 'ws-status disconnected';
                }
            }

            function handleWebSocketMessage(data) {
                // Handle the analysis result from n8n via FastAPI
                if (data.messageId && data.result) {
                    const container = pendingAnalysisRequests.get(parseInt(data.messageId));
                    if (container) {
                        container.querySelector(".text-white/60")?.remove();
                        container.insertAdjacentHTML("afterbegin", `<div class="whitespace-pre-wrap">${data.result}</div>`);
                        const saveBtn = document.getElementById('savePdfBtn');
                        if (saveBtn) saveBtn.classList.remove('hidden');
                        pendingAnalysisRequests.delete(parseInt(data.messageId));
                        setLoading('generate', false);
                    }
                }

                // You can add other message types here as needed
                // For example, progress updates, status messages, etc.
                if (data.type === 'progress') {
                    // Handle progress updates
                    console.log('Progress update:', data.progress);
                }
            }



            // --- Checkbox Selection Logic ---
            let selectionCounter = document.getElementById('selectionCounter');
            if (selectionCounter) {
                const methodCheckboxes = document.querySelectorAll('.method-checkbox');
                methodCheckboxes.forEach(cb => {
                    cb.addEventListener('change', () => {
                        const checkedBoxes = document.querySelectorAll('.method-checkbox:checked');
                        if (checkedBoxes.length > 3) {
                            cb.checked = false; // prevent selecting more than 3
                            return;
                        }
                        selectionCounter.textContent = `Selected: ${checkedBoxes.length} / 3`;
                    });
                });
            }

            // --- Extend handleGenerate to include checkbox data and validation ---
            const originalHandleGenerate = handleGenerate;
            handleGenerate = async function () {
                const companyName = document.getElementById('companyName')?.value.trim();
                const useCase = document.getElementById('useCase')?.value.trim();
                const location = document.getElementById('location')?.value.trim();
                const analysisResultContainer = document.getElementById('analysisResult');

                const checkedMethods = Array.from(document.querySelectorAll('.method-checkbox:checked'))
                    .map(cb => cb.nextElementSibling.textContent.trim());

                // Validate all fields
                if (!companyName || !useCase || !location) {
                    analysisResultContainer.innerHTML =
                        `<div class="p-4 text-center text-red-400">Please fill out all fields before generating.</div>`;
                    setLoading('generate', false);
                    return;
                }

                if (checkedMethods.length < 1 || checkedMethods.length > 3) {
                    analysisResultContainer.innerHTML =
                        `<div class="p-4 text-center text-red-400">Please select between 1 and 3 methods.</div>`;
                    setLoading('generate', false);
                    return;
                }

                // Call original function logic
                await originalHandleGenerate.apply(this, arguments);

                // Append selected methods to prompt for n8n
                const analysisBox = document.getElementById('analysisResult');
                if (analysisBox && !analysisBox.innerHTML.includes("Your generated analysis will appear here.")) {
                    analysisBox.innerHTML +=
                        `<div class="mt-4 text-sm text-white/60">Methods Chosen: ${checkedMethods.join(", ")}</div>`;
                }
            };

            // --- PDF Save Logic ---
            document.getElementById("savePdfBtn").addEventListener("click", () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const text = document.getElementById("analysisResult").innerText;
                pdf.setFont("helvetica", "normal");
                pdf.setFontSize(12);
                pdf.text(text, 10, 10);
                pdf.save("analysis.pdf");
            });

            // Initialize WebSocket connection
            initializeWebSocket();

            // --- Session Management ---
            async function checkAuthStatus() {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session) {
                        userLoggedIn = true;
                        localStorage.setItem('authToken', session.access_token);
                        updateNavBar();
                    }
                } catch (error) {
                    console.error('Error checking auth status:', error);
                }
            }

            // --- Navigation Logic ---
            function navigateTo(pageId) {
                // Clear any ongoing checkmark animation when navigating away
                const analysisResultContainer = $('analysisResult');
                const methodsContainer = $('methodsConsideredContainer'); // Get reference to the new container

                const oldIntervalIdResult = analysisResultContainer.dataset.checkmarkIntervalId;
                if (oldIntervalIdResult) {
                    clearInterval(parseInt(oldIntervalIdResult));
                    delete analysisResultContainer.dataset.checkmarkIntervalId;
                }

                const oldIntervalIdMethods = methodsContainer.dataset.checkmarkIntervalId; // Check for interval on methods container
                if (oldIntervalIdMethods) {
                    clearInterval(parseInt(oldIntervalIdMethods));
                    delete methodsContainer.dataset.checkmarkIntervalId;
                }

                // Hide all pages first
                pages.forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none'; // Explicitly hide all pages
                });

        const targetPage = $(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
            // Set display based on the type of page
            if (pageId === 'home' || pageId === 'templates' || pageId === 'templateDetail' || pageId === 'examplesPage' || pageId === `graphPage`) {
                targetPage.style.display = 'block';
            } else if (pageId === 'login' || pageId === 'signup') {
                targetPage.style.display = 'flex';
            }
			window.scrollTo(0, 0);

			// Call loadKnowledgeGraph when navigating to the graphPage
			if (pageId === 'graphPage') { 
				loadKnowledgeGraph()
				// requestAnimationFrame(() => {
				// 	loadKnowledgeGraph();
				// });
			}
            
        }
    }

            // --- Update Navigation Bar Links ---
            function updateNavBar() {
                const loginLink = document.querySelector('a[data-page="login"], a[data-page="logout"]'); // Select both
                const templatesLink = document.querySelector('a[data-page="templates"]');

                if (userLoggedIn) {
                    if (loginLink) {
                        loginLink.textContent = 'Logout';
                        loginLink.setAttribute('data-page', 'logout');
                    }
                    if (templatesLink) {
                        templatesLink.classList.remove('hidden'); // Show templates link
                    }
                } else {
                    if (loginLink) {
                        loginLink.textContent = 'Login';
                        loginLink.setAttribute('data-page', 'login');
                    }
                    if (templatesLink) {
                        templatesLink.classList.add('hidden'); // Hide templates link
                    }
                }
                attachNavLinkListeners(); // Re-attach listeners as data-page attributes might change
            }

            // --- Attach Navigation Link Listeners ---
            function attachNavLinkListeners() {
                navLinks.forEach(link => {
                    link.removeEventListener('click', handleNavLinkClick); // Remove old listeners to prevent duplicates
                    link.addEventListener('click', handleNavLinkClick); // Add new listeners
                });
            }

            function handleNavLinkClick(e) {
                e.preventDefault();
                const pageId = this.getAttribute('data-page');

                if (pageId === 'logout') {
                    handleLogout();
                    return;
                }

                if (pageId === 'templates' && !userLoggedIn) {
                    showMessage('loginMessage', 'Please log in to access templates.', 'error'); // Display message on login page
                    navigateTo('login');
                    return;
                }

        if ((pageId === 'login' || pageId === 'signup') && userLoggedIn) {
            showMessage('loginMessage', 'You are already logged in.', 'success'); // Display message on login page
            navigateTo('home'); // Or navigate to templates
            return;
        }

		// Call loadKnowledgeGraph when navigating to the graphPage
		if (pageId === 'graphPage') {
			navigateTo('graphPage')
			return;
		}
        navigateTo(pageId);
    }

            // --- Template Page Logic ---
            function populateTemplatesList() {
                templatesListContainer.innerHTML = '';
                const templateArray = Object.keys(templates).map(key => ({ id: key, ...templates[key] }));

                // Sort to put 'custom-template' first if it exists
                templateArray.sort((a, b) => {
                    if (a.id === 'custom-template') return -1;
                    if (b.id === 'custom-template') return 1;
                    return 0;
                });

                templateArray.forEach(template => {
                    const card = document.createElement('div');
                    card.className = 'template-card p-6' + (template.isPremium ? ' relative' : ''); // Add relative for premium badge
                    card.setAttribute('data-template-id', template.id);
                    card.innerHTML = `
                <h3 class="text-2xl font-bold mb-2">${template.title}</h3>
                <p class="text-white/70">${template.description}</p>
                ${template.isPremium ? '<span class="absolute top-4 right-4 bg-yellow-500 text-yellow-900 text-xs font-semibold px-2.5 py-0.5 rounded-full">Premium</span>' : ''}
            `;
                    card.addEventListener('click', () => {
                        // For demonstration, assume premium access is tied to userLoggedIn for now.
                        // In a real app, you'd check a user's premium status after login.
                        if (template.isPremium && !userLoggedIn) {
                            showMessage('loginMessage', 'Please log in to access premium templates.', 'error');
                            navigateTo('login');
                        } else if (!userLoggedIn) {
                            showMessage('loginMessage', 'Please log in to use templates.', 'error');
                            navigateTo('login');
                        }
                        else {
                            showTemplateDetail(template.id);
                        }
                    });
                    templatesListContainer.appendChild(card);
                });
            }

            function showTemplateDetail(templateId) {
                currentTemplateId = templateId;
                const template = templates[templateId];
                if (!template) return;

                // Clear any previous checkmark animation
                const analysisResultContainer = $('analysisResult');
                const methodsContainer = $('methodsConsideredContainer');

                const oldIntervalIdResult = analysisResultContainer.dataset.checkmarkIntervalId;
                if (oldIntervalIdResult) {
                    clearInterval(parseInt(oldIntervalIdResult));
                    delete analysisResultContainer.dataset.checkmarkIntervalId;
                }

                const oldIntervalIdMethods = methodsContainer.dataset.checkmarkIntervalId;
                if (oldIntervalIdMethods) {
                    clearInterval(parseInt(oldIntervalIdMethods));
                    delete methodsContainer.dataset.checkmarkIntervalId;
                }
                // Reset checkmarks to ensure a clean start when switching templates
                for (let i = 1; i <= 8; i++) {
                    const checkmark = $(`methodCheckmark${i}`);
                    if (checkmark) checkmark.classList.remove('success');
                }


                $('templateTitle').textContent = template.title;
                $('templateDescription').textContent = template.description;

                const templateFormFields = $('templateFormFields');
                templateFormFields.innerHTML = ''; // Clear existing fields

                // Add custom field only for 'custom-template'
                if (templateId === 'custom-template') {

                    templateFormFields.innerHTML += `
                <div>
                    <label for="typeOfStrategy" class="block text-sm font-medium text-gray-200 mb-2">Type of Strategy</label>
                    <input type="text" id="typeOfStrategy" class="input-field" placeholder="e.g., Market Expansion Strategy" required>
                </div>
            `;
                } else {

                }

                // Add common fields for all templates
                templateFormFields.innerHTML += `
            <div>
                <label for="companyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label>
                <input type="text" id="companyName" class="input-field" placeholder="e.g., Innovate Inc." required>
            </div>
            <div>
                <label for="useCase" class="block text-sm font-medium text-gray-200 mb-2">Use Case</label>
                <input type="text" id="useCase" class="input-field" placeholder="e.g., Q4 Marketing Strategy" required>
            </div>
            <div>
                <label for="location" class="block text-sm font-medium text-gray-200 mb-2">Location</label>
                <input type="text" id="location" class="input-field" placeholder="e.g., Global" required>
            </div>
        `;

                // Clear previous results
                $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';

                navigateTo('templateDetail');
            }

            // Get selected frameworks from checkboxes and map to n8n values
            function getSelectedFrameworks() {
                const checkedBoxes = document.querySelectorAll('.method-checkbox:checked');
                const selectedMethods = [];

                checkedBoxes.forEach(checkbox => {
                    const methodText = checkbox.nextElementSibling.textContent.trim();
                    // Map display names to the exact values expected by n8n Switch
                    const frameworkMap = {
                        'Reframing Thinking': 'ReframingThinking', // Fixed the typo
                        'Delphi Method': 'DelphiMethod',
                        'Blue Ocean Strategy': 'BlueOcean',
                        'Design Thinking': 'DesignThinking',
                        'Thinking Hats': 'ThinkingHats',
                        'Six Thinking Hats': 'ThinkingHats', // Alternative name
                        'Business Model Canvas': 'BusinessModelCanvas',
                        'SCAMPER': 'SCAMPER',
                        'TRIZ (Theory of Inventive Problem Solving)': 'TRIZ'
                    };

                    if (frameworkMap[methodText]) {
                        selectedMethods.push(frameworkMap[methodText]);
                    }
                });

                return selectedMethods.join(','); // Return as comma-separated string
            }
            function getFrameworkForTemplate(templateId) {
                const selectedFrameworks = getSelectedFrameworks();

                // If no frameworks selected, return default
                if (!selectedFrameworks) {
                    return 'BlueOcean,SCAMPER';
                }

                return selectedFrameworks;
            }

            async function handleGenerate() {
                if (!currentTemplateId) return;

                const companyName = document.getElementById('companyName').value.trim();
                const useCase = document.getElementById('useCase').value.trim();
                const location = document.getElementById('location').value.trim();
                const analysisResultContainer = document.getElementById('analysisResult');
                const methodsContainer = document.getElementById('methodsConsideredContainer');

                // Clear any previous checkmark animation before starting a new one
                const oldIntervalIdResult = analysisResultContainer.dataset.checkmarkIntervalId;
                if (oldIntervalIdResult) {
                    clearInterval(parseInt(oldIntervalIdResult));
                    delete analysisResultContainer.dataset.checkmarkIntervalId;
                }

                const oldIntervalIdMethods = methodsContainer.dataset.checkmarkIntervalId;
                if (oldIntervalIdMethods) {
                    clearInterval(parseInt(oldIntervalIdMethods));
                    delete methodsContainer.dataset.checkmarkIntervalId;
                }

                // Reset checkmarks to ensure a clean start
                for (let i = 1; i <= 8; i++) {
                    const checkmark = document.getElementById(`methodCheckmark${i}`);
                    if (checkmark) checkmark.classList.remove('success');
                }

                // Get framework for this template
                const framework = getFrameworkForTemplate(currentTemplateId);

                // Validate checkbox selection
                const checkedMethods = Array.from(document.querySelectorAll('.method-checkbox:checked'))
                    .map(cb => cb.nextElementSibling.textContent.trim());

                if (checkedMethods.length < 1 || checkedMethods.length > 3) {
                    analysisResultContainer.innerHTML =
                        `<div class="p-4 text-center text-red-400">Please select between 1 and 3 methods.</div>`;
                    setLoading('generate', false);
                    return;
                }

                let fullPrompt = '';
                if (currentTemplateId === 'custom-template') {
                    const typeOfStrategy = document.getElementById('typeOfStrategy').value.trim();
                    if (!typeOfStrategy || !companyName || !useCase || !location) {
                        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Please fill out all fields for your custom strategy.</div>`;
                        setLoading('generate', false);
                        return;
                    }
                    fullPrompt = `Generate a detailed ${typeOfStrategy} for ${companyName}. Use Case: ${useCase} Location: ${location} Please provide a comprehensive analysis and actionable recommendations for this custom strategic request.`;
                } else {
                    if (!companyName || !useCase || !location) {
                        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Please fill out all fields before generating.</div>`;
                        setLoading('generate', false);
                        return;
                    }
                    const basePrompt = templates[currentTemplateId].prompt;
                    fullPrompt = `User Information: - Company Name: ${companyName} - Use Case: ${useCase} - Location: ${location} --- Template Prompt: ${basePrompt}`;
                }

                // Always show methods and start checkmark animation
                methodsContainer.classList.remove('hidden');
                const checkmarkElements = [];
                for (let i = 1; i <= 8; i++) {
                    checkmarkElements.push(document.getElementById(`methodCheckmark${i}`));
                }
                let checkmarkIndex = 0;
                const intervalId_all = setInterval(() => {
                    if (checkmarkIndex < checkmarkElements.length) {
                        checkmarkElements[checkmarkIndex].classList.add('success');
                        checkmarkIndex++;
                    } else {
                        clearInterval(intervalId_all);
                        delete methodsContainer.dataset.checkmarkIntervalId;
                    }
                }, 700);
                methodsContainer.dataset.checkmarkIntervalId = intervalId_all;

                setLoading('generate', true);

                // Hide save button at start
                const saveBtn = document.getElementById('savePdfBtn');
                if (saveBtn) saveBtn.classList.add('hidden');

                // Single, clear message about processing time
                analysisResultContainer.innerHTML = `
        <div class="text-center text-white/70 p-8">
            <div class="typing-indicator mb-6">
                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
            </div>
            <h3 class="text-xl font-semibold text-white mb-4">Generating Your Strategic Analysis</h3>
            <p class="text-white/80 mb-2">This comprehensive analysis may take 2-5 minutes to complete.</p>
            <p class="text-white/60 text-sm">Please keep this page open while we process your request.</p>
        </div>
    `;

                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) {
                        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Please log in to generate analysis.</div>`;
                        setLoading('generate', false);
                        return;
                    }

                    const messageId = Date.now();

                    // Store this request for WebSocket callback
                    pendingAnalysisRequests.set(messageId, analysisResultContainer);

                    // Create an AbortController for timeout handling
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                    try {
                        // Send to n8n with framework included
                        const response = await fetch('https://n8n.data2int.com/webhook/analysis-ev2', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                customerName: companyName,
                                location: location,
                                useCase: useCase,
                                prompt: fullPrompt,
                                framework: framework,
                                templateId: currentTemplateId,
                                messageId: messageId
                            }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId); // Clear the abort timeout since fetch completed

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Analysis request submitted successfully:', result);

                            // Keep the same message - no updates needed since WebSocket will handle the final result
                            // The actual result will come via WebSocket
                        } else {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                    } catch (error) {
                        clearTimeout(timeoutId);

                        if (error.name === 'AbortError') {
                            // Timeout occurred, but don't treat as error since WebSocket will handle response
                            console.log('Fetch request timed out, but WebSocket will handle the response');

                            // Keep the same processing message - no need to change it
                            // The WebSocket will replace this when the result comes in
                            return;
                        } else {
                            throw error; // Re-throw non-timeout errors
                        }
                    }

                } catch (error) {
                    console.error('Error submitting analysis request:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                    setLoading('generate', false);

                    // Clean up the pending request
                    pendingAnalysisRequests.delete(messageId);
                }
            }
            $('generateBtn').addEventListener('click', handleGenerate);

            function handleWebSocketMessage(data) {
                // Handle the analysis result from n8n via FastAPI
                if (data.messageId && data.result) {
                    const container = pendingAnalysisRequests.get(parseInt(data.messageId));
                    if (container) {
                        // Clear all existing content first
                        container.innerHTML = '';
                        // Add the analysis result
                        container.innerHTML = `<div class="whitespace-pre-wrap">${data.result}</div>`;
                        // Show the save PDF button
                        const saveBtn = document.getElementById('savePdfBtn');
                        if (saveBtn) saveBtn.classList.remove('hidden');
                        // Clean up and stop loading
                        pendingAnalysisRequests.delete(parseInt(data.messageId));
                        setLoading('generate', false);
                    }
                }

                // Handle progress updates
                if (data.messageId && data.progress && !data.result) {
                    const container = pendingAnalysisRequests.get(parseInt(data.messageId));
                    if (container) {
                        container.innerHTML = `
                <div class="text-center text-white/70 p-4">
                    <div class="typing-indicator mb-4">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                    <p class="mb-2">ðŸ”„ ${data.progress}</p>
                    <p class="text-sm text-white/50">Analysis in progress...</p>
                </div>
            `;
                    }
                }

                // Handle error messages
                if (data.messageId && data.error) {
                    const container = pendingAnalysisRequests.get(parseInt(data.messageId));
                    if (container) {
                        container.innerHTML = `<div class="p-4 text-center text-red-400">Workflow error: ${data.error}</div>`;
                        pendingAnalysisRequests.delete(parseInt(data.messageId));
                        setLoading('generate', false);
                    }
                }
            }

            // Add cleanup function for abandoned requests (optional)
            function cleanupAbandonedRequests() {
                const now = Date.now();
                const maxAge = 10 * 60 * 1000; // 10 minutes

                for (const [messageId, container] of pendingAnalysisRequests.entries()) {
                    if (now - messageId > maxAge) {
                        console.log(`Cleaning up abandoned request: ${messageId}`);
                        container.innerHTML = `<div class="p-4 text-center text-yellow-400">Request timed out. Please try again.</div>`;
                        pendingAnalysisRequests.delete(messageId);
                        setLoading('generate', false);
                    }
                }
            }

            // Optional: Run cleanup every 5 minutes
            setInterval(cleanupAbandonedRequests, 5 * 60 * 1000);

            $('generateBtn').addEventListener('click', handleGenerate);
            // Save as PDF handler
            const savePdfBtnEl = document.getElementById('savePdfBtn');
            if (savePdfBtnEl) {
                savePdfBtnEl.addEventListener('click', () => {
                    if (!window.jspdf || !window.jspdf.jsPDF) return alert('PDF library not loaded.');
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ unit: "pt", format: "a4" });
                    const content = document.getElementById("analysisResult").innerText || '';
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const margin = 40;
                    const maxLineWidth = pageWidth - margin * 2;
                    doc.setFont("Helvetica", "normal");
                    doc.setFontSize(12);
                    doc.text(content, margin, 60, { maxWidth: maxLineWidth, align: "left" });
                    doc.save("analysis.pdf");
                });
            }


            // --- Auth Logic using Supabase ---
            async function handleLogin() {
                const email = $('loginEmail').value.trim();
                const password = $('loginPassword').value;
                const loginMessageEl = $('loginMessage');

                if (!email || !password) {
                    showMessage('loginMessage', 'Please fill in all fields', 'error');
                    return;
                }

                setLoading('login', true);
                loginMessageEl.classList.add('hidden'); // Hide previous messages

                try {
                    // Use Supabase Auth
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) {
                        showMessage('loginMessage', error.message, 'error');
                        return;
                    }

                    // Store the token
                    localStorage.setItem('authToken', data.session.access_token);

                    userLoggedIn = true;
                    showMessage('loginMessage', 'Login successful! Redirecting to templates...', 'success');
                    updateNavBar();
                    setTimeout(() => navigateTo('templates'), 1500);

                } catch (error) {
                    showMessage('loginMessage', 'An error occurred during login. Please try again.', 'error');
                    console.error("Login error:", error);
                } finally {
                    setLoading('login', false);
                }
            }

            async function handleRegister() {
                const firstName = $('registerFirstName').value.trim();
                const lastName = $('registerLastName').value.trim();
                const email = $('registerEmail').value.trim();
                const password = $('registerPassword').value;
                const confirmPassword = $('registerConfirmPassword').value;

                // Validation
                if (!firstName || !lastName || !email || !password || !confirmPassword) {
                    showMessage('registerMessage', 'Please fill in all fields', 'error');
                    return;
                }

                if (password !== confirmPassword) {
                    showMessage('registerMessage', 'Passwords do not match', 'error');
                    return;
                }

                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showMessage('registerMessage', 'Please enter a valid email address', 'error');
                    return;
                }

                // Password strength validation (optional)
                if (password.length < 6) {
                    showMessage('registerMessage', 'Password must be at least 6 characters long', 'error');
                    return;
                }

                setLoading('register', true);

                try {
                    // Create user via your Edge Function with separated names
                    const { data: fnData, error: fnError } = await supabase.functions.invoke('create-user-v3', {
                        body: {
                            email,
                            password,
                            metadata: {
                                first_name: firstName,
                                last_name: lastName,
                                role: 'basic'
                            }
                        }
                    });

                    if (fnError) {
                        showMessage('registerMessage', fnError.message || 'Registration failed via Edge Function.', 'error');
                        return;
                    }

                    if (!fnData || !fnData.success) {
                        const msg = fnData?.error || 'Registration failed (unexpected response).';
                        showMessage('registerMessage', msg, 'error');
                        return;
                    }

                    // Try auto-login (your function sets email_confirm: true)
                    const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (signInError) {
                        showMessage('registerMessage', 'Account created successfully! Please log in.', 'success');
                        setTimeout(() => navigateTo('login'), 1500);
                        return;
                    }

                    // Store token and update state
                    if (signInData.session?.access_token) {
                        localStorage.setItem('authToken', signInData.session.access_token);
                        userLoggedIn = true;
                        updateNavBar();

                        // Store user info for display purposes (optional)
                        localStorage.setItem('userInfo', JSON.stringify({
                            email: signInData.user.email,
                            first_name: firstName,
                            last_name: lastName
                        }));
                    }

                    showMessage('registerMessage', `Welcome ${firstName}! Account created successfully. Redirecting...`, 'success');
                    setTimeout(() => navigateTo('templates'), 1500);

                } catch (err) {
                    console.error('Register error:', err);
                    showMessage('registerMessage', 'An error occurred during registration. Please try again.', 'error');
                } finally {
                    setLoading('register', false);
                }
            }

            async function handleLogout() {
                try {
                    await supabase.auth.signOut();
                    localStorage.removeItem('authToken');
                    userLoggedIn = false;
                    updateNavBar();
                    showMessage('loginMessage', 'You have been logged out.', 'success');
                    navigateTo('login');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }

            $('loginBtn').addEventListener('click', handleLogin);
            $('registerBtn').addEventListener('click', handleRegister);

            function setLoading(type, isLoading) {
                const btn = $(`${type}Btn`);
                const text = $(`${type}BtnText`);
                const spinner = $(`${type}Spinner`);
                if (btn) {
                    btn.disabled = isLoading;
                    if (text) text.textContent = isLoading ? 'Processing...' : (type === 'login' ? 'Sign In' : (type === 'register' ? 'Create Account' : 'Generate Analysis'));
                    if (spinner) spinner.classList.toggle('hidden', !isLoading);
                }
            }

            function showMessage(id, msg, type) {
                const el = $(id);
                el.textContent = msg;
                el.className = type === 'error' ? 'error-message' : 'success-message';
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 3000);
            }

            // --- Three.js Animation Logic ---
            let scene, camera, renderer, group;
            const particlesData = [];
            let positions, colors;
            let particlesGeometry;
            let pointCloud;
            let particlePositions;
            let linesMesh;

            const NUM_PARTICLES = 1000; // Increased to 1000 particles
            const AREA_SIZE = 3000; // Increased area size
            const AREA_HALF = AREA_SIZE / 2;
            const MIN_DISTANCE = 200; // Max distance for lines to connect

            let mouseX = 0, mouseY = 0; // Mouse position for interaction
            let targetRotationX = 0, targetRotationY = 0; // Target rotation for group

            // Function to create a circular texture for particles
            function createCircleTexture(size, color) {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const context = canvas.getContext('2d');
                const gradient = context.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2);
                gradient.addColorStop(0, color);
                gradient.addColorStop(0.7, color);
                gradient.addColorStop(1, 'rgba(0,0,0,0)'); // Fade to transparent
                context.fillStyle = gradient;
                context.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
                context.fill();
                return new THREE.CanvasTexture(canvas);
            }

            function initThreeJS() {
                const canvas = $('threeJsCanvas');
                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000);
                camera.position.z = 3000; // Adjusted camera distance to view larger area

                scene = new THREE.Scene();
                group = new THREE.Group();
                scene.add(group);

                // Create circular texture for particles
                const particleTexture = createCircleTexture(64, 'rgba(173, 216, 230, 1)'); // Light Blue color for neurons

                // Particle material (nodes)
                const pMaterial = new THREE.PointsMaterial({
                    color: 0xFFFFFF, // White, will be tinted by texture
                    size: 7, // Reduced size of the rendered circles
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    sizeAttenuation: false, // Keep size consistent regardless of distance
                    map: particleTexture // Apply the circular texture
                });

                particlesGeometry = new THREE.BufferGeometry();
                particlePositions = new Float32Array(NUM_PARTICLES * 3);

                // Initialize particle data and positions
                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const x = Math.random() * AREA_SIZE - AREA_HALF;
                    const y = Math.random() * AREA_SIZE - AREA_HALF;
                    const z = Math.random() * AREA_SIZE - AREA_HALF;

                    particlePositions[i * 3] = x;
                    particlePositions[i * 3 + 1] = y;
                    particlePositions[i * 3 + 2] = z;

                    particlesData.push({
                        velocity: new THREE.Vector3(
                            (Math.random() - 0.5) * 0.5, // Slower velocity
                            (Math.random() - 0.5) * 0.5,
                            (Math.random() - 0.5) * 0.5
                        ),
                        numConnections: 0
                    });
                }

                particlesGeometry.setDrawRange(0, NUM_PARTICLES);
                particlesGeometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3).setUsage(THREE.DynamicDrawUsage));

                pointCloud = new THREE.Points(particlesGeometry, pMaterial);
                group.add(pointCloud);

                // Line material (connections)
                const lineGeometry = new THREE.BufferGeometry();
                positions = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);
                colors = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);

                lineGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3).setUsage(THREE.DynamicDrawUsage));
                lineGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3).setUsage(THREE.DynamicDrawUsage));
                lineGeometry.computeBoundingSphere();
                lineGeometry.setDrawRange(0, 0); // Start with no lines drawn

                const lineMaterial = new THREE.LineBasicMaterial({
                    vertexColors: true,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    opacity: 0.4 // Increased overall line opacity for better visibility
                });

                linesMesh = new THREE.LineSegments(lineGeometry, lineMaterial);
                group.add(linesMesh);

                renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setAnimationLoop(animateThreeJS); // Use the new animation loop

                window.addEventListener('resize', onWindowResize);
                window.addEventListener('mousemove', onDocumentMouseMove);
            }

            function onDocumentMouseMove(event) {
                // Normalize mouse coordinates to -1 to +1
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = - (event.clientY / window.innerHeight) * 2 + 1;
            }

            function animateThreeJS() {
                let vertexpos = 0;
                let colorpos = 0;
                let numConnected = 0;

                // Reset connections for all active particles
                for (let i = 0; i < NUM_PARTICLES; i++) {
                    particlesData[i].numConnections = 0;
                }

                // Update particle positions and check for connections
                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const particleData = particlesData[i];

                    // Update position
                    particlePositions[i * 3] += particleData.velocity.x;
                    particlePositions[i * 3 + 1] += particleData.velocity.y;
                    particlePositions[i * 3 + 2] += particleData.velocity.z;

                    // Boundary check and reverse velocity
                    if (particlePositions[i * 3 + 1] < -AREA_HALF || particlePositions[i * 3 + 1] > AREA_HALF) {
                        particleData.velocity.y = -particleData.velocity.y;
                    }
                    if (particlePositions[i * 3] < -AREA_HALF || particlePositions[i * 3] > AREA_HALF) {
                        particleData.velocity.x = -particleData.velocity.x;
                    }
                    if (particlePositions[i * 3 + 2] < -AREA_HALF || particlePositions[i * 3 + 2] > AREA_HALF) {
                        particleData.velocity.z = -particleData.velocity.z;
                    }

                    // Connect to other particles if within MIN_DISTANCE
                    for (let j = i + 1; j < NUM_PARTICLES; j++) {
                        const dx = particlePositions[i * 3] - particlePositions[j * 3];
                        const dy = particlePositions[i * 3 + 1] - particlePositions[j * 3 + 1];
                        const dz = particlePositions[i * 3 + 2] - particlePositions[j * 3 + 2];
                        const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

                        if (dist < MIN_DISTANCE) {
                            const alpha = 1.0 - dist / MIN_DISTANCE; // Opacity based on distance

                            // Add positions for the line segment
                            positions[vertexpos++] = particlePositions[i * 3];
                            positions[vertexpos++] = particlePositions[i * 3 + 1];
                            positions[vertexpos++] = particlePositions[i * 3 + 2];

                            positions[vertexpos++] = particlePositions[j * 3];
                            positions[vertexpos++] = particlePositions[j * 3 + 1];
                            positions[vertexpos++] = particlePositions[j * 3 + 2];

                            // Set colors for the line segment (fading effect)
                            const lineColor = new THREE.Color(0xADD8E6); // Light Blue for lines
                            colors[colorpos++] = lineColor.r * alpha;
                            colors[colorpos++] = lineColor.g * alpha;
                            colors[colorpos++] = lineColor.b * alpha;

                            colors[colorpos++] = lineColor.r * alpha;
                            colors[colorpos++] = lineColor.g * alpha;
                            colors[colorpos++] = lineColor.b * alpha;

                            numConnected++;
                        }
                    }
                }

                // Update line geometry
                linesMesh.geometry.setDrawRange(0, numConnected * 2);
                linesMesh.geometry.attributes.position.needsUpdate = true;
                linesMesh.geometry.attributes.color.needsUpdate = true;

                // Update particle geometry
                pointCloud.geometry.attributes.position.needsUpdate = true;

                // Smoothly interpolate group rotation towards mouse position
                const rotationSpeed = 0.03; // Controls how quickly it reacts to mouse
                group.rotation.y += (mouseX * 0.05 - group.rotation.y) * rotationSpeed;
                group.rotation.x += (mouseY * 0.05 - group.rotation.x) * rotationSpeed;

                // Add a very subtle continuous rotation for inherent motion
                group.rotation.y += 0.0001;
                group.rotation.x += 0.00005;

                renderer.render(scene, camera);
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            // --- Feature Toggle Logic ---
            document.querySelectorAll('.toggle-feature-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const featureId = this.getAttribute('data-feature-id');
                    const featureDescriptionElement = this.closest('.feature-card').querySelector('.feature-description');
                    const currentState = featureDescriptionElement.getAttribute('data-state');

                    if (currentState === 'short') {
                        featureDescriptionElement.innerHTML = featureContent[featureId].long;
                        featureDescriptionElement.setAttribute('data-state', 'long');
                        this.innerHTML = 'Less &rarr;';
                    } else {
                        featureDescriptionElement.innerHTML = featureContent[featureId].short;
                        featureDescriptionElement.setAttribute('data-state', 'short');
                        this.innerHTML = 'More &rarr;';
                    }
                });
            });

            // --- AI Analysis Examples Carousel Logic ---
            let currentExampleIndex = 0;
            const analysisExamples = document.querySelectorAll('.analysis-example-item');
            const prevExampleBtn = $('prevExampleBtn');
            const nextExampleBtn = $('nextExampleBtn');
            const exampleCounter = $('exampleCounter');

            function showAnalysisExample(index) {
                analysisExamples.forEach((item, i) => {
                    if (i === index) {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                });

                prevExampleBtn.disabled = index === 0;
                nextExampleBtn.disabled = index === analysisExamples.length - 1;
                exampleCounter.textContent = `${index + 1} of ${analysisExamples.length}`;
            }

            prevExampleBtn.addEventListener('click', () => {
                if (currentExampleIndex > 0) {
                    currentExampleIndex--;
                    showAnalysisExample(currentExampleIndex);
                }
            });

            nextExampleBtn.addEventListener('click', () => {
                if (currentExampleIndex < analysisExamples.length - 1) {
                    currentExampleIndex++;
                    showAnalysisExample(currentExampleIndex);
                }
            });

	// --- Knowledge Graph Visualization Logic (NEW) ---
	async function loadKnowledgeGraph() {
		const graphContainer = document.querySelector('.graph-inner')
		
		if (!graphContainer || typeof NVL === 'undefined') {
			console.error('NVL not loaded or graph container not found.');
			return;
		}

		// Function to fetch data from your backend
            async function fetchGraphData() {
                try {
                    const response = await fetch('https://nlp.data2int.com/graph/knowledge-graph'); 
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const graphData = await response.json();
                    console.log("Fetched graph data:", graphData);

                    const transformedNodes = graphData.nodes.map(node => ({
                        id: String(node.id), // Ensure ID is a string
                        caption: node.properties.name || node.label,
                        labels: [String(node.label)], // NVL expects an array of labels
                        properties: node.properties ? { ...node.properties } : {} // Ensure properties is a plain object
                    }));

                    const transformedRelationships = graphData.relationships.map(rel => {
                        const relId = rel.id ? String(rel.id) : `${rel.source_id}-${rel.type}-${rel.target_id}`;
                        return {
                            id: relId,
                            from: String(rel.source_id), // Ensure IDs are strings
                            to: String(rel.target_id),   // Ensure IDs are strings
                            caption: String(rel.type),   // Ensure caption is a string
                            type: String(rel.type),
                            properties: rel.properties ? { ...rel.properties } : {} // Ensure properties is a plain object
                        };
                    });

                    return {
                        nodes: transformedNodes,
                        relationships: transformedRelationships
                    };

                } catch (error) {
                    console.error("Error fetching graph data:", error);
                    graphContainer.innerHTML = `<p style='color: red;'>Error loading graph: ${error.message}</p>`;
                    return null; // Return null on error
                }
            }

            const initialGraphData = await fetchGraphData();
			console.log("Graph data", initialGraphData);
			const { nodes, relationships } = initialGraphData;
            if (initialGraphData) {
                // Pass the data to the NVL constructor
                const visualization = new NVL(graphContainer, nodes, relationships, {
					// Optionally specify a layout, e.g., 'forcedirected' or 'hierarchical'
                    layout: 'forcedirected'
				});
				console.log("Visualization:", visualization);

                // Instantiate and add interaction handlers
                const clickInteraction = new ClickInteraction(visualization);
                const zoomInteraction = new ZoomInteraction(visualization);
                const panInteraction = new PanInteraction(visualization);
                const dragNodeInteraction = new DragNodeInteraction(visualization);
                //const boxSelectInteraction = new BoxSelectInteraction(visualization);
                const hoverInteraction = new HoverInteraction(visualization);

                // Example: Add callbacks to interaction handlers
                clickInteraction.updateCallback('onNodeClick', (node) => {
                    console.log('Node clicked', node);
                });
                // boxSelectInteraction.updateCallback('onBoxSelect', ({ nodes, rels }) => {
                //     console.log('Selected elements:', nodes, rels);
                // });
                dragNodeInteraction.updateCallback('onDrag', (nodes) => {
                    //console.log('Dragged nodes:', nodes);
                });
                hoverInteraction.updateCallback('onHover', (element, hitElements, event) => {
                    //console.log('Hovered element:', element);
                });
                panInteraction.updateCallback('onPan', (panning) => {
                    //console.log('Panning:', panning);
                });
                zoomInteraction.updateCallback('onZoom', (zoomLevel) => {
                    //console.log('Zoom level:', zoomLevel);
                });
            }
		}

            // Initialize carousel on page load
            if (analysisExamples.length > 0) {
                showAnalysisExample(currentExampleIndex);
            }

            // --- Initial Setup ---
            populateTemplatesList();
            updateNavBar(); // Initialize nav bar state (hides templates link)
            navigateTo('home'); // Start on the home page
            checkAuthStatus(); // Check if user is already logged in
            initThreeJS(); // Initialize and start Three.js animation
        });

        // Clean up WebSocket connection when page unloads
        window.addEventListener('beforeunload', () => {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.close(1000, 'Page unloading');
            }
        });
    </script>
</body>


</html>