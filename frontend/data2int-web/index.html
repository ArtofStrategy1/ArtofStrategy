<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>S.A.G.E. - AI Strategy Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        /* --- THEME COLORS (CSS VARIABLES) --- */
        :root {
            --grad-1: #C33764;
            --grad-2: #1D2671;
            --primary: #8E2DE2;
            --primary-hover: #4A00E0;
            --accent: #C33764;
            --edge-color: #4A00E0;
            --node-color: #C33764;
        }

        /* --- Base & Animated Background --- */
        html, body {
            min-height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, var(--grad-1), var(--grad-2));
            background-size: 400% 400%;
            animation: gradientBG 18s ease infinite;
            color: #f9fafb;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex-grow: 1;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .page {
            display: none;
        }

        /* Hide all pages by default */
        .page.active {
            animation: fadeIn .5s ease-out;
        }

        /* Specific display rules for active pages */
        #home.active,
        #templates.active,
        #templateDetail.active,
        #examplesPage.active,
        #adminDashboard.active,
        #about.active {
            display: block;
            /* Content pages */
        }

        #login.active,
        #signup.active,
        #emailVerification.active {
            display: flex;
            /* Centered pages */
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        /* --- Glass & Card Effects --- */
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            transition: all .3s ease;
            text-align: center;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .template-card,
        .project-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: all .3s ease;
            cursor: pointer;
        }

        .template-card:hover,
        .project-card:hover {
            transform: translateY(-5px);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .project-card-content {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* --- Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(220, 38, 38, 0.5);
            color: #fca5a5;
        }

        .btn-danger:hover {
            background: rgba(220, 38, 38, 0.7);
            color: #fff;
        }

        .btn-tertiary {
            background: transparent;
            color: #c7d2fe;
            text-decoration: underline;
        }

        .btn-tertiary:hover {
            color: #fff;
        }

        /* --- Forms & Inputs --- */
        .input-field {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-field:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .error-message {
            color: #fca5a5;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(220, 38, 38, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .success-message {
            color: #a7f3d0;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(5, 150, 105, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        /* --- Loading Spinners --- */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 2rem;
        }

        .typing-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            animation: typing 1.4s infinite ease-in-out
        }

        .typing-dot:nth-child(1) {
            animation-delay: -.32s
        }

        .typing-dot:nth-child(2) {
            animation-delay: -.16s
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0s
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(.8);
                opacity: .5
            }

            40% {
                transform: scale(1);
                opacity: 1
            }
        }

        /* --- Three.js Canvas Styling --- */
        #threeJsCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            display: block;
            transition: opacity 0.5s ease-in-out;
        }

        /* Carousel specific styles */
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 9999px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: background 0.3s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .carousel-button:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .carousel-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .carousel-button.left {
            left: -6rem;
        }

        .carousel-button.right {
            right: -6rem;
        }

        @media (max-width: 768px) {
            .carousel-button.left {
                left: 0.5rem;
            }

            .carousel-button.right {
                right: 0.5rem;
            }
        }

        .analysis-example-item {
            padding: 2.5rem;
            margin-bottom: 0;
        }

        .analysis-example-item h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .analysis-example-item ul,
        .analysis-example-item ol {
            list-style-position: inside;
            margin-left: 1.25rem;
            margin-bottom: 1rem;
        }

        .analysis-example-item li {
            margin-bottom: 0.5rem;
        }

        .feature-card .feature-description ul,
        .feature-card .feature-description ol,
        .feature-card .feature-description p {
            text-align: center;
        }

        /* WebSocket connection status indicator */
        .ws-status {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .ws-status.connected {
            background: rgba(5, 150, 105, 0.8);
            color: #a7f3d0;
        }

        .ws-status.disconnected {
            background: rgba(220, 38, 38, 0.8);
            color: #fca5a5;
        }

        .ws-status.connecting {
            background: rgba(245, 158, 11, 0.8);
            color: #fbbf24;
        }

        /* Glassy Checkboxes */
        .method-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .method-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
        }
        .method-checkbox:disabled + span {
            opacity: 0.5;
        }

        .method-checkbox:checked {
            background: color-mix(in srgb, var(--primary) 80%, transparent);
            border-color: color-mix(in srgb, var(--accent) 90%, transparent);
            box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 70%, transparent);
            transform: scale(1.15);
        }

        .method-checkbox:hover:not(:disabled) {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.7);
        }
        
        /* --- Custom File Input --- */
        .input-file-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .input-file {
            position: absolute;
            font-size: 50px;
            opacity: 0;
            right: 0;
            top: 0;
            cursor: pointer;
        }
        .input-file-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
        }
        .input-file-btn:hover {
             background: rgba(255, 255, 255, 0.1);
             border-color: var(--accent);
        }
        .input-file-btn.has-file {
            color: white;
            border-color: var(--accent);
            background: color-mix(in srgb, var(--primary) 20%, transparent);
        }
        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 0.5rem;
        }

        /* --- Interactive Hover for Guide Cards --- */
        #about .glass-container {
            transition: all 0.3s ease-in-out;
        }

        #about .glass-container:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Footer Styling */
        footer {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* --- Sticky Footer Override --- */
        html, body {
            min-height: 100vh !important;
        }
        body {
            display: flex !important;
            flex-direction: column !important;
        }
        .main-content {
            flex: 1 0 auto !important;
        }
        footer {
            flex-shrink: 0 !important;
            position: relative !important;
        }

        /* --- Analysis Results Tab Styling --- */
        .analysis-tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .analysis-tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }
        .analysis-tab-btn.active {
            color: white;
            font-weight: 600;
            border-bottom-color: var(--accent);
        }
        .analysis-tab-panel {
            display: none;
            padding-top: 1.5rem;
            animation: fadeIn 0.5s;
        }
        .analysis-tab-panel.active {
            display: block;
        }

        /* --- Home Page Tab Styling --- */
        .home-tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }
        .home-tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .home-tab-btn.active {
            color: white;
            font-weight: 600;
            border-bottom-color: var(--primary);
        }
        .home-tab-panel {
            display: none;
            animation: fadeIn 0.5s;
        }
        .home-tab-panel.active {
            display: grid;
        }

        /* SWOT Tool specific styles */
        .input-radio-group {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 0.25rem;
        }
        .input-radio-label {
            flex: 1;
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .input-radio-label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .input-radio:checked + .input-radio-label {
            background: var(--primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .input-radio {
            display: none;
        }

        /* Archetype & Factor Analysis Tool Specific Styles */
        .metric-card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
            margin-bottom: 1rem;
        }
        .metric-card.critical {
            border-left-color: #dc143c;
        }
        .metric-card.high {
            border-left-color: #ff8c00;
        }

    </style>
</head>

<body>
    <div class="main-content">
        <canvas id="threeJsCanvas"></canvas>
        <div id="wsStatus" class="ws-status disconnected">Disconnected</div>

        <nav class="bg-black/10 backdrop-blur-sm p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <a href="#" class="text-2xl font-bold text-white nav-link" data-page="home">S.A.G.E.</a>
                <div>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link"
                        data-page="home">Home</a>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link"
                        data-page="login">Login</a>
                </div>
            </div>
        </nav>

        <div id="versionChoiceModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
            <div class="glass-container w-full max-w-lg text-center">
                <h2 class="text-3xl font-bold mb-4">Choose Your Version</h2>
                <p class="text-white/80 mb-8">Select a version to proceed with your analysis.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="selectFreeVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Free Version</h3>
                        <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Basic analysis</li>
                            <li>Select 1 of 8 frameworks</li>
                        </ul>
                    </div>
                    <div id="selectPaidVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Paid Version</h3>
                         <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Comprehensive analysis</li>
                            <li>Select up to 3 of 8 frameworks</li>
                        </ul>
                    </div>
                </div>
                 <button id="closeModalBtn" class="btn btn-secondary mt-8">Cancel</button>
            </div>
        </div>

        <div id="home" class="page active container mx-auto px-6 py-16">
            <div class="text-center">
                <h1 class="text-5xl md:text-6xl font-extrabold text-white leading-tight mb-4">Unlock Your Strategic Potential</h1>
                <p class="text-lg md:text-xl text-white/80 max-w-3xl mx-auto mb-8">
                    Select a category to explore our comprehensive suite of strategic planning tools and methodologies.
                </p>
            </div>
            
            <div id="homeTabsNav" class="flex flex-wrap justify-center space-x-1 md:space-x-2 border-b-2 border-white/10 mt-16 mb-12">
                <button class="home-tab-btn active" data-tab="strategicPlanning">Strategic Planning</button>
                <button class="home-tab-btn" data-tab="systemThinking">System Thinking</button>
                <button class="home-tab-btn" data-tab="novelStrategies">Novel Strategies</button>
                <button class="home-tab-btn" data-tab="dataAnalysis">Data Analysis</button>
            </div>

            <div id="homeTabsContent">
                <div id="strategicPlanning" class="home-tab-panel active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="mission-vision">
                        <h3 class="text-xl font-bold mb-2">Mission Vision</h3><p class="text-white/70 text-sm">Define your organization's core purpose and future aspirations.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="factor-analysis">
                        <h3 class="text-xl font-bold mb-2">Factor Analysis</h3><p class="text-white/70 text-sm">Assess internal strengths and weaknesses & external opportunities and threats.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="swot-tows">
                        <h3 class="text-xl font-bold mb-2">Swot/Tows Analysis</h3><p class="text-white/70 text-sm">Develop strategies by matching internal factors to external factors.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="goals-initiatives">
                        <h3 class="text-xl font-bold mb-2">Goals & Strategic Initiatives</h3><p class="text-white/70 text-sm">Set high-level goals and the key initiatives to achieve them.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="objectives">
                        <h3 class="text-xl font-bold mb-2">Objectives</h3><p class="text-white/70 text-sm">Formulate specific, measurable, achievable, relevant, and time-bound objectives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="action-plans">
                        <h3 class="text-xl font-bold mb-2">Action Plans</h3><p class="text-white/70 text-sm">Detail the resources, tasks, and timelines required for execution.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="kpi-events">
                        <h3 class="text-xl font-bold mb-2">KPI & Critical Events</h3><p class="text-white/70 text-sm">Define key performance indicators and track critical milestones.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="misc-summary">
                        <h3 class="text-xl font-bold mb-2">Misc</h3><p class="text-white/70 text-sm">Compile summaries, risk assessments, governance, and conclusions.</p>
                    </div>
                </div>

                <div id="systemThinking" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="process-mapping">
                        <h3 class="text-xl font-bold mb-2">Process Mapping</h3><p class="text-white/70 text-sm">Visualize and analyze the flow of activities in a process.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="pareto-fishbone">
                        <h3 class="text-xl font-bold mb-2">Fishbone/Pareto Analysis</h3><p class="text-white/70 text-sm">Identify root causes and prioritize the most significant issues.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-thinking-analysis">
                        <h3 class="text-xl font-bold mb-2">System Thinking Analysis</h3><p class="text-white/70 text-sm">Understand the complex interconnections within your organization.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="leverage-points">
                        <h3 class="text-xl font-bold mb-2">Leverage Points</h3><p class="text-white/70 text-sm">Identify areas where small changes can yield significant results.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="archetype-analysis">
                        <h3 class="text-xl font-bold mb-2">Archetypes Analysis</h3><p class="text-white/70 text-sm">Recognize and address recurring patterns of behavior in your system.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-goals-initiatives">
                        <h3 class="text-xl font-bold mb-2">Goals/Strategic Initiatives</h3><p class="text-white/70 text-sm">Align system-level goals with broader strategic initiatives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-objectives">
                        <h3 class="text-xl font-bold mb-2">Objectives</h3><p class="text-white/70 text-sm">Define clear objectives for improving system performance.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-actions">
                        <h3 class="text-xl font-bold mb-2">Actions</h3><p class="text-white/70 text-sm">Outline concrete actions to implement system-level changes.</p>
                    </div>
                </div>
                
                <div id="novelStrategies" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="novel-goals-initiatives">
                        <h3 class="text-2xl font-bold mb-2">Goals & Strategic Initiatives</h3><p class="text-white/70">Define ambitious goals and innovative initiatives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="all-framework">
                        <h3 class="text-2xl font-bold mb-2">All Framework</h3><p class="text-white/70">Access a comprehensive suite of strategic frameworks.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="creative-dissonance">
                        <h3 class="text-2xl font-bold mb-2">Creative Dissonance</h3><p class="text-white/70">Leverage the gap between vision and reality to spark innovation.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="living-system">
                        <h3 class="text-2xl font-bold mb-2">Living System</h3><p class="text-white/70">Apply principles of living systems to foster organizational adaptability.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="thinking-system">
                        <h3 class="text-2xl font-bold mb-2">Thinking System</h3><p class="text-white/70">Develop a holistic approach to problem-solving and decision-making.</p>
                    </div>
                </div>

                <div id="dataAnalysis" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="descriptive-analysis"><h3 class="text-xl font-bold mb-2">Descriptive</h3><p class="text-white/70 text-sm">Summarize historical data to understand what has happened.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="predictive-analysis"><h3 class="text-xl font-bold mb-2">Predictive</h3><p class="text-white/70 text-sm">Use statistical models to forecast future outcomes.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="prescriptive-analysis"><h3 class="text-xl font-bold mb-2">Prescriptive</h3><p class="text-white/70 text-sm">Advise on possible outcomes and recommend actions.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="visualization"><h3 class="text-xl font-bold mb-2">Visualization</h3><p class="text-white/70 text-sm">Create graphical representations of data for insights.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="regression-analysis"><h3 class="text-xl font-bold mb-2">Regression</h3><p class="text-white/70 text-sm">Model relationships between variables for prediction.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="pls-analysis"><h3 class="text-xl font-bold mb-2">PLS</h3><p class="text-white/70 text-sm">Apply Partial Least Squares for structural equation modeling.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="sem-analysis"><h3 class="text-xl font-bold mb-2">SEM</h3><p class="text-white/70 text-sm">Structural Equation Modeling for complex variable relationships.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="dematel-analysis"><h3 class="text-xl font-bold mb-2">DEMATEL</h3><p class="text-white/70 text-sm">Understand causal relationships between complex factors.</p></div>
                </div>
            </div>
        </div>
        
        <div id="about" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">How to Use S.A.G.E.</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">A Step-by-Step Guide to Unleashing Your Strategic Potential</p>
            <div class="max-w-4xl mx-auto space-y-8">
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 1:</span> Get Started (Login/Sign Up)</h3>
                    <p class="text-white/80">To unlock the full power of S.A.G.E., including saving your projects and using premium templates, you'll need an account. Click the "Login" button in the navigation bar. If you're new, you can create an account in just a few clicks.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 2:</span> Choose Your Template</h3>
                    <p class="text-white/80">From the Home page, browse through the categories like "Strategic Plans" or "Frameworks". Select the template that best fits your objective by clicking on its card.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 3:</span> Select Your Version</h3>
                    <p class="text-white/80">After choosing a template, a modal will appear. You can select the "Free Version" for a basic analysis using one framework, or the "Paid Version" to conduct a more comprehensive analysis with up to three different frameworks.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 4:</span> Provide Context & Select Options</h3>
                    <p class="text-white/80">On the template detail page, fill in the required information, such as your company name and upload your company documents. This context is crucial for the AI to generate a relevant analysis. Below the inputs, select your desired analysis sections and analytical framework(s).</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 5:</span> Generate & Review Your Analysis</h3>
                    <p class="text-white/80">Click the "Generate Analysis" button. S.A.G.E.'s AI will process your inputs and selected frameworks, which may take a few minutes. The complete, structured analysis will appear in the results panel on the right side of the screen.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 6:</span> Save & Export Your Work</h3>
                    <p class="text-white/80">Once your analysis is generated, action buttons will appear below the result. You can export the analysis as a PDF or DOCX file for easy sharing and integration into your reports.</p>
                </div>
            </div>
        </div>

        <div id="login" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Sign In</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="loginEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="loginEmail" class="input-field" placeholder="Enter your email" required>
                        </div>
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="loginPassword" class="input-field" placeholder="Enter your password"
                                required>
                        </div>
                        <button id="loginBtn" class="btn btn-primary w-full">
                            <span id="loginBtnText">Sign In</span>
                            <span id="loginSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="loginMessage" class="hidden"></div>
                    </div>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Don't have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="signup">Create Account</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="signup" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Create Account</h2>
                    <form id="registerForm" class="space-y-4">
                        <div>
                            <label for="registerFirstName" class="block text-sm font-medium text-gray-200 mb-2">First
                                Name</label>
                            <input type="text" id="registerFirstName" class="input-field"
                                placeholder="Enter your First Name" required>
                        </div>
                        <div>
                            <label for="registerLastName" class="block text-sm font-medium text-gray-200 mb-2">Last
                                Name</label>
                            <input type="text" id="registerLastName" class="input-field" placeholder="Enter your Last Name"
                                required>
                        </div>
                        <div>
                            <label for="registerEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="registerEmail" class="input-field" placeholder="Enter your email"
                                required>
                        </div>
                        <div>
                            <label for="registerPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="registerPassword" class="input-field" placeholder="Create a password"
                                required>
                        </div>
                        <div>
                            <label for="registerConfirmPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Confirm Password</label>
                            <input type="password" id="registerConfirmPassword" class="input-field"
                                placeholder="Confirm your password" required>
                        </div>
                        <button type="button" id="registerBtn" class="btn btn-primary w-full">
                            <span id="registerBtnText">Create Account</span>
                            <span id="registerSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="registerMessage" class="hidden"></div>
                    </form>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Already have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="login">Sign In</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="emailVerification" class="page flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container text-center">
                    <h2 class="text-3xl font-bold mb-6 text-white">Check Your Email</h2>
                    <p class="text-white/80 mb-6">Thank you for registering! We've sent a verification link to your email address. Please check your inbox and click the link to complete your registration.</p>
                    <p class="text-white/60 text-sm mb-6">Don't forget to check your spam folder.</p>
                    <div class="text-center">
                        <button class="btn-tertiary nav-link" data-page="login">Return to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="templateDetail" class="page container mx-auto px-6 py-16">
            <button class="btn btn-secondary mb-8 nav-link" data-page="home">&larr; Back to Home</button>
            <div id="templateDetailContent" class="grid lg:grid-cols-2 gap-12">
                </div>
        </div>

        <div id="adminDashboard" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">Admin Dashboard</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Live analytics for S.A.G.E.</p>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Users Online</h3>
                    <p id="dashUsersOnline" class="text-4xl font-bold">—</p>
                    <p class="text-white/60 text-sm mt-2">Approximate active visitors.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Total Queries</h3>
                    <p id="dashQueryCount" class="text-4xl font-bold">0</p>
                    <p class="text-white/60 text-sm mt-2">From live database stats.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Server Status</h3>
                    <div class="flex items-center gap-3">
                        <span id="dashServerDot" class="inline-block w-3 h-3 rounded-full bg-yellow-400"></span>
                        <span id="dashServerText">Checking…</span>
                    </div>
                    <p class="text-white/60 text-sm mt-2">Reflects WebSocket connection.</p>
                </div>
            </div>

            <div class="glass-container mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Live Database Statistics</h3>
                    <button id="refreshStatsBtn" class="btn btn-primary">
                        <span id="refreshStatsBtnText">Refresh Stats</span>
                        <span id="refreshStatsSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                </div>

                <div id="statisticsContainer" class="grid md:grid-cols-2 gap-x-8 gap-y-4 text-white/90">
                    <div>
                        <h4 class="text-xl font-semibold mb-3 border-b border-white/20 pb-2">Database Status</h4>
                        <ul class="space-y-2">
                            <li><strong>Total Users:</strong> <span id="statTotalUsers">—</span></li>
                            <li><strong>Active Users (1h):</strong> <span id="statActiveUsers">—</span></li>
                            <li><strong>Total Queries:</strong> <span id="statTotalQueries">—</span></li>
                            <li><strong>Database Size:</strong> <span id="statDbSize">—</span></li>
                            <li><strong>Avg. Processing Time:</strong> <span id="statAvgTime">—</span></li>
                            <li><strong>Last Recorded:</strong> <span id="statRecordedAt">—</span></li>
                        </ul>
                    </div>
                    <div id="pineconeStatsContainer" class="hidden">
                        <h4 class="text-xl font-semibold mb-3 border-b border-white/20 pb-2">Vector Store Status</h4>
                        <ul class="space-y-2">
                            <li><strong>Index Name:</strong> <span id="statPineconeName">—</span></li>
                            <li><strong>Total Vectors:</strong> <span id="statTotalVectors">—</span></li>
                            <li><strong>Book Vectors:</strong> <span id="statBookVectors">—</span></li>
                            <li><strong>Dimension:</strong> <span id="statPineconeDimension">—</span></li>
                            <li><strong>Status:</strong> <span id="statPineconeStatus">—</span></li>
                            <li><strong>Cloud/Region:</strong> <span id="statPineconeCloud">—</span></li>
                        </ul>
                    </div>
                </div>
                <div id="statsMessage" class="hidden mt-4"></div>
            </div>
        </div>

        <div id="examplesPage" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">AI Analysis Examples</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">See how S.A.G.E. can transform complex data
                into actionable strategic insights with these example outputs.</p>

            <div id="analysisCarousel" class="relative max-w-4xl mx-auto glass-container p-0">
                <div class="analysis-example-item">
                    <h2 class="text-3xl font-bold mb-4">Example: SWOT Analysis for "GlobalTech Solutions"</h2>
                    <div class="text-white/70">
                        <h3>STRENGTHS:</h3>
                        <ul>
                            <li><strong>Strong R&D Department:</strong> GlobalTech consistently innovates, holding numerous
                                patents in AI and quantum computing.</li>
                            <li><strong>Global Presence:</strong> Established offices and client base across North America,
                                Europe, and Asia.</li>
                            <li><strong>Talented Workforce:</strong> Highly skilled engineers and data scientists, fostering
                                a culture of excellence.</li>
                        </ul>

                        <h3>WEAKNESSES:</h3>
                        <ul>
                            <li><strong>High Operating Costs:</strong> Extensive R&D and global infrastructure lead to
                                significant overheads.</li>
                            <li><strong>Limited Marketing Reach:</strong> Reliance on word-of-mouth and niche industry
                                events, missing broader market segments.</li>
                            <li><strong>Bureaucratic Processes:</strong> Slow decision-making due to multi-layered approval
                                systems.</li>
                        </ul>

                        <h3>OPPORTUNITIES:</h3>
                        <ul>
                            <li><strong>Emerging Markets:</strong> Untapped potential in developing economies for AI-driven
                                solutions.</li>
                            <li><strong>Strategic Partnerships:</strong> Collaboration with hardware manufacturers to integrate
                                    AI software.</li>
                            <li><strong>Government Grants:</strong> Increased funding for AI research and development
                                initiatives.</li>
                        </ul>

                        <h3>THREATS:</h3>
                        <ul>
                            <li><strong>Intense Competition:</strong> Rapidly evolving tech landscape with new startups and
                                established giants.</li>
                            <li><strong>Talent Drain:</strong> High demand for skilled AI professionals leading to
                                competitive recruitment.</li>
                            <li><strong>Regulatory Changes:</strong> Evolving data privacy and AI ethics regulations
                                impacting product development.</li>
                        </ul>

                        <h3>Strategic Recommendations:</h3>
                        <ol>
                            <li><strong>Optimize Cost Structure:</strong> Implement agile methodologies to reduce R&D cycle
                                times and explore automation in operational processes.</li>
                            <li><strong>Expand Marketing Channels:</strong> Invest in digital marketing and content strategy
                                to reach a wider audience and enhance brand visibility.</li>
                            <li><strong>Forge Key Alliances:</strong> Actively pursue partnerships with complementary
                                technology providers to expand market reach and product offerings.</li>
                        </ol>
                    </div>
                </div>

                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Market Entry Strategy for "EcoCycle Innovations" into
                        Southeast Asia</h2>
                    <div class="text-white/70">
                        <h3>MARKET ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Market Size & Growth:</strong> Southeast Asia's recycling and waste management
                                market is projected to grow at a CAGR of 8% over the next five years, driven by increasing
                                environmental awareness and government initiatives.</li>
                            <li><strong>Customer Segments:</strong> Key segments include industrial waste generators,
                                municipal waste facilities, and commercial enterprises seeking sustainable solutions.</li>
                            <li><strong>Market Maturity:</strong> Varies by country; Singapore and Malaysia are more mature,
                                while Vietnam and Indonesia are emerging.</li>
                        </ul>

                        <h3>COMPETITIVE LANDSCAPE:</h3>
                        <ul>
                            <li><strong>Key Players:</strong> Dominated by local players with strong government ties and a
                                few international waste management giants.</li>
                            <li><strong>Competitive Advantages:</strong> Local players often have lower operational costs
                                and established networks. EcoCycle's advanced waste-to-energy technology offers a unique
                                value proposition.</li>
                        </ul>

                        <h3>ENTRY STRATEGY OPTIONS:</h3>
                        <ol>
                            <li><strong>Joint Venture (JV) with Local Partner:</strong> Recommended approach. A JV allows
                                EcoCycle to leverage local expertise, navigate regulatory complexities, and gain immediate
                                market access.
                                <ul>
                                    <li><strong>Pros:</strong> Reduced risk, faster market penetration, access to local
                                        networks.</li>
                                    <li><strong>Cons:</strong> Potential for cultural clashes, profit sharing.</li>
                                </ul>
                            </li>
                            <li><strong>Greenfield Investment:</strong> Building new facilities.
                                <ul>
                                    <li><strong>Pros:</strong> Full control, tailor-made operations.</li>
                                    <li><strong>Cons:</strong> High capital investment, long lead times, significant
                                        regulatory hurdles.</li>
                                </ul>
                            </li>
                        </ol>

                        <h3>Implementation Roadmap:</h3>
                        <ul>
                            <li><strong>Phase 1 (Months 1-6):</strong> Partner identification and due diligence. Focus on
                                countries with favorable regulatory environments (e.g., Malaysia, Thailand).</li>
                            <li><strong>Phase 2 (Months 7-18):</strong> JV formation and pilot project initiation. Secure
                                initial contracts with industrial clients.</li>
                            <li><strong>Phase 3 (Months 19-36):</strong> Scale operations, expand service offerings, and explore
                                    opportunities in other SEA markets.</li>
                        </ul>
                    </div>
                </div>

                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Digital Transformation Roadmap for "RetailX"</h2>
                    <div class="text-white/70">
                        <h3>VISION & OBJECTIVES:</h3>
                        <ul>
                            <li><strong>Vision:</strong> To become a leading omnichannel retailer, leveraging digital
                                technologies to enhance customer experience, optimize operations, and drive sustainable
                                growth.</li>
                            <li><strong>Objectives:</strong> Increase online sales by 30% within 2 years, reduce operational
                                costs by 15% through automation, and improve customer satisfaction scores by 20%.</li>
                        </ul>

                        <h3>CURRENT STATE ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Digital Capabilities:</strong> Fragmented legacy systems, limited e-commerce
                                capabilities, manual inventory management.</li>
                            <li><strong>Pain Points:</strong> Inconsistent customer experience across channels, inefficient
                                supply chain, lack of real-time data for decision-making.</li>
                        </ul>

                        <h3>KEY PILLARS OF TRANSFORMATION:</h3>
                        <ol>
                            <li><strong>Customer Experience:</strong> Unify online and offline channels, personalize
                                customer journeys.</li>
                            <li><strong>Operational Efficiency:</strong> Automate back-office processes, optimize supply
                                chain.</li>
                            <li><strong>Data & Analytics:</strong> Implement robust data infrastructure, leverage AI for
                                insights.</li>
                            <li><strong>Culture & Talent:</strong> Foster digital-first mindset, upskill workforce.</li>
                        </ol>

                        <h3>INITIATIVES & TECHNOLOGIES:</h3>
                        <ul>
                            <li><strong>Customer Experience:</strong> CRM implementation (Salesforce), E-commerce platform
                                upgrade (Shopify Plus), AI-powered chatbots.</li>
                            <li><strong>Operational Efficiency:</strong> ERP system integration (SAP), Warehouse Management
                                System (WMS), Robotic Process Automation (RPA) for routine tasks.</li>
                            <li><strong>Data & Analytics:</strong> Data Lake/Warehouse (Snowflake), Business Intelligence
                                tools (Tableau), Predictive Analytics.</li>
                            <li><strong>Culture & Talent:</strong> Digital literacy training, change management programs.</li>
                        </ul>

                        <h3>PHASED IMPLEMENTATION PLAN:</h3>
                        <ul>
                            <li><strong>Short-term (0-6 months):</strong> CRM implementation, basic e-commerce upgrade,
                                pilot RPA for finance.</li>
                            <li><strong>Mid-term (6-18 months):</strong> Full ERP integration, advanced e-commerce features,
                                initial data lake setup, comprehensive digital training.</li>
                            <li><strong>Long-term (18+ months):</strong> AI-driven personalization, predictive supply chain,
                                expansion into new digital services.</li>
                        </ul>

                        <h3>MEASUREMENT & KPIs:</h3>
                        <ul>
                            <li>Online Conversion Rate, Customer Lifetime Value, Order Fulfillment Time, Inventory Accuracy,
                                Employee Digital Proficiency.</li>
                        </ul>
                    </div>
                </div>

                <button id="prevExampleBtn" class="carousel-button left">&larr;</button>
                <button id="nextExampleBtn" class="carousel-button right">&rarr;</button>
            </div>
            <div class="text-center text-white/80 mt-4">
                <span id="exampleCounter">1 of 3</span>
            </div>

            <div class="text-center mt-12">
                 <button class="btn btn-primary nav-link" data-page="home">Back to Tools</button>
            </div>
        </div>

    </div>

    <footer class="mt-auto py-8">
        <div class="container mx-auto text-center text-white/70">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="hover:text-white nav-link" data-page="about">About</a>
                <a href="#" class="hover:text-white nav-link" data-page="adminDashboard">Admin Dashboard</a>
            </div>
            <p>&copy; 2025 S.A.G.E. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // =========================================================
        // SCRIPT
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {

            // --- Supabase Configuration ---
            const SUPABASE_URL = 'https://supabase.data2int.com'
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNjQwOTk1MjAwLCJleHAiOjE5NTYzNTUyMDB9.KHXKQpsN6MNB08H_IPxP4Gh0gjcsvXG9IeJuK3XpnAU'

            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

            // --- DOM Element References ---
            const $ = id => document.getElementById(id);
            const pages = document.querySelectorAll('.page');
            let currentTemplateId = null; 
            let websocket = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            const reconnectDelay = 3000; 
            let pendingAnalysisRequests = new Map()

            // --- User Session State ---
            let userLoggedIn = false; 
            let currentUser = null;

            // --- Version Control State ---
            let currentSelectionLimit = 3; // Default to paid
            let selectedTemplateForModal = null;
            let preFillData = ''; // Used to pass context from home card to template detail
            
            // --- Analysis Cache ---
            const analysisCache = {};

            // --- Template Data ---
            const templates = {
                'custom-template': {
                    title: 'Custom Strategy Generator',
                    description: 'Design your own strategic analysis by defining the type of strategy, company, and location.',
                    isPremium: true,
                },
                'vision-mission-goals': {
                    title: 'Vision & Mission Planning',
                    description: 'A unified tool to define your organization\'s guiding purpose, future state, and core goals.',
                },
                'swot': {
                    title: 'SWOT Analysis',
                    description: "Analyze your organization's Strengths, Weaknesses, Opportunities, and Threats.",
                },
                'swot-tows': {
                    title: 'SWOT/TOWS Analysis',
                    description: 'Develop strategies by matching internal factors (Strengths, Weaknesses) to external factors (Opportunities, Threats).',
                },
                'pareto-fishbone': {
                    title: 'Pareto & Fishbone Analysis',
                    description: 'A combined approach to identify the root causes of problems (Fishbone) and prioritize them based on impact (Pareto).'
                },
                'external-analysis': {
                    title: 'External Analysis',
                    description: 'Analyze the external environment (market, competition, trends) to identify opportunities and threats.'
                },
                'internal-analysis': {
                    title: 'Internal Analysis',
                    description: 'Evaluate your organization\'s internal strengths and weaknesses in resources, capabilities, and core competencies.'
                },
                 'advanced-system-analysis': { 
                    title: 'Advanced System Analysis', 
                    description: 'Model complex systems to understand interdependencies, feedback loops, and high-leverage intervention points.' 
                },
                'archetype-analysis': {
                    title: 'Archetype Analysis',
                    description: 'Identify and analyze recurring patterns of behavior (archetypes) within your system or market.'
                },
                'creative-dissonance': {
                    title: 'Creative Dissonance Analysis',
                    description: 'Explore the gap between your current reality and desired future to fuel innovation and strategic change.'
                },
                'reframing-thinking': {
                    title: 'Reframing Thinking Analysis',
                    description: 'Apply the reframing technique to look at problems from new perspectives and unlock creative solutions.'
                },
                'delphi-method': {
                    title: 'Delphi Method Analysis',
                    description: 'Utilize the Delphi method to gather and synthesize expert opinions for forecasting and decision-making.'
                },
                'blue-ocean': {
                    title: 'Blue Ocean Strategy',
                    description: 'Focuses on creating uncontested market space rather than competing in existing industries.'
                },
                'design-thinking': {
                    title: 'Design Thinking',
                    description: 'A human-centered, iterative process for creative problem-solving and innovation.'
                },
                'thinking-hats': {
                    title: 'Thinking Hats Analysis',
                    description: 'Apply Edward de Bono\'s system for parallel thinking to explore an issue comprehensively.'
                },
                 'scamper': {
                    title: 'SCAMPER Analysis',
                    description: 'A creative thinking technique using seven prompts (Substitute, Combine, Adapt, Modify, Put to another use, Eliminate, Reverse) to innovate.'
                },
                'triz': {
                    title: 'TRIZ Analysis',
                    description: 'A systematic approach based on the study of global patent patterns to find innovative solutions to technical problems.'
                },
                'regression-analysis': { 
                    title: 'Regression Analysis', 
                    description: 'Use statistical regression to model and analyze the relationships between variables for predictive insights.' 
                },
                'pls-analysis': { 
                    title: 'PLS Analysis', 
                    description: 'Apply Partial Least Squares (PLS) for structural equation modeling, especially with complex models and non-normal data.' 
                },
                'dematel-analysis': {
                    title: 'Dematel Analysis',
                    description: 'Understand causal relationships between complex factors to identify core problems and effective leverage points.'
                },
                'competitor': {
                    title: 'Competitor Analysis',
                    description: 'Deep dive into competitor strategies, market positioning, and competitive advantages.',
                },
                'market-entry': {
                    title: 'Market Entry Strategy',
                    description: 'Evaluate market opportunities, entry barriers, and develop a roadmap for market penetration.',
                },
                'risk': {
                    title: 'Risk Assessment',
                    description: 'Identify, evaluate, and develop mitigation strategies for business risks.',
                },
                'business-model': {
                    title: 'Business Model Canvas',
                    description: 'Design and analyze your business model using the proven 9-building-block framework.',
                },
                'digital-transformation': {
                    title: 'Digital Transformation Roadmap',
                    description: 'Plan your organization\'s journey towards digital maturity.',
                },
            };

            // --- Template UI Rules ---
            const templateRules = {
                'swot': { hideAnalysisSection: true },
                'swot-tows': { useSwotLayout: true },
                'archetype-analysis': { useArchetypeLayout: true },
                'factor-analysis': { useFactorAnalysisLayout: true },
                'competitor': { hideAnalysisSection: true },
                'market-entry': { hideAnalysisSection: true },
                'risk': { hideAnalysisSection: true },
                'pareto-fishbone': { useParetoLayout: true, hideAnalysisSection: true, hideFrameworks: true },
                'external-analysis': { hideAnalysisSection: true },
                'internal-analysis': { hideAnalysisSection: true },
                'advanced-system-analysis': { hideAnalysisSection: true },
                
                'creative-dissonance': { hideAnalysisSection: true },
                'regression-analysis': { hideAnalysisSection: true },
                'pls-analysis': { hideAnalysisSection: true },
                'dematel-analysis': { hideAnalysisSection: true },
                'digital-transformation': { hideAnalysisSection: true },
                
                'delphi-method': { preselectFramework: 'Delphi Method', hideAnalysisSection: true },
                'blue-ocean': { preselectFramework: 'Blue Ocean Strategy', hideAnalysisSection: true },
                'design-thinking': { preselectFramework: 'Design Thinking', hideAnalysisSection: true },
                'thinking-hats': { preselectFramework: 'Thinking Hats', hideAnalysisSection: true },
                'business-model': { preselectFramework: 'Business Model Canvas', hideAnalysisSection: true },
                'scamper': { preselectFramework: 'SCAMPER', hideAnalysisSection: true },
                'triz': { preselectFramework: 'TRIZ (Theory of Inventive Problem Solving)', hideAnalysisSection: true },
                'reframing-thinking': { preselectFramework: 'Reframing Thinking', hideAnalysisSection: true },
            };

            // WebSocket Management Functions
            function initializeWebSocket() {
                const wsStatus = document.getElementById('wsStatus');

                try {
                    websocket = new WebSocket('wss://n8n-api.data2int.com/ws');

                    wsStatus.textContent = 'Connecting...';
                    wsStatus.className = 'ws-status connecting';

                    websocket.onopen = function (event) {
                        console.log('WebSocket connected successfully');
                        wsStatus.textContent = 'Connected';
                        wsStatus.className = 'ws-status connected';
                        reconnectAttempts = 0;
                    };

                    websocket.onmessage = function (event) {
                        console.log('Received WebSocket message:', event.data);

                        try {
                            const data = JSON.parse(event.data);
                            handleWebSocketMessage(data);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };

                    websocket.onclose = function (event) {
                        console.log('WebSocket connection closed:', event.code, event.reason);
                        wsStatus.textContent = 'Disconnected';
                        wsStatus.className = 'ws-status disconnected';

                        if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                            setTimeout(() => {
                                reconnectAttempts++;
                                console.log(`WebSocket reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                                initializeWebSocket();
                            }, reconnectDelay);
                        }
                    };

                    websocket.onerror = function (error) {
                        console.error('WebSocket error:', error);
                        wsStatus.textContent = 'Error';
                        wsStatus.className = 'ws-status disconnected';
                    };

                } catch (error) {
                    console.error('Failed to initialize WebSocket:', error);
                    wsStatus.textContent = 'Failed';
                    wsStatus.className = 'ws-status disconnected';
                }
            }
            
            // --- DOCX Export Logic ---
            async function handleSaveAsDocx(filename = "SAGE_Analysis.docx") {
                const { Document, Packer, Paragraph, TextRun, ImageRun } = window.docx;

                const analysisResult = $('analysisResult');
                if (!analysisResult || analysisResult.innerText.includes("Your generated analysis will appear here.")) {
                    alert("No analysis to save.");
                    return;
                }

                const paragraphs = [];
                
                const textContentEl = analysisResult.querySelector("#analysisContent");
                if (textContentEl) {
                    textContentEl.innerText.split('\n').forEach(line => {
                         paragraphs.push(new Paragraph({ children: [new TextRun(line)] }));
                    });
                } else {
                     analysisResult.innerText.split('\n').forEach(line => {
                         paragraphs.push(new Paragraph({ children: [new TextRun(line)] }));
                    });
                }
                
                const children = [...paragraphs];

                const fishboneImgEl = document.getElementById("fishbone_img");
                if (fishboneImgEl && fishboneImgEl.src.startsWith('data:image')) {
                    const base64Data = fishboneImgEl.src.split(",")[1];
                    children.push(new Paragraph({ children: [new ImageRun({ 
                        data: Uint8Array.from(atob(base64Data), c => c.charCodeAt(0)), 
                        transformation: { width: 600, height: 400 } 
                    })] }));
                }

                const paretoChartEl = document.getElementById("paretoChartContainer");
                if (paretoChartEl && window.Plotly) {
                    try {
                        const dataUrl = await Plotly.toImage(paretoChartEl, {format: 'png', width: 800, height: 500});
                        const base64Data = dataUrl.split(",")[1];
                        children.push(new Paragraph({ children: [new ImageRun({ 
                            data: Uint8Array.from(atob(base64Data), c => c.charCodeAt(0)), 
                            transformation: { width: 600, height: 375 } 
                        })] }));
                    } catch(e) {
                        console.error("Could not export Plotly chart to image:", e);
                    }
                }
                
                const doc = new Document({
                    sections: [{ properties: {}, children: children }]
                });

                const blob = await Packer.toBlob(doc);
                saveAs(blob, filename);
            }

            // --- PDF Save Logic ---
            function handleSaveAsPdf() {
                if (!window.jspdf || !window.jspdf.jsPDF) return alert('PDF library not loaded.');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    unit: "pt",
                    format: "a4"
                });

                const targetEl = $("analysisResult");
                if (!targetEl) {
                    alert("Nothing to export.");
                    return;
                }

                const content = targetEl.innerText || "";
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const marginL = 40,
                    marginR = 40,
                    marginT = 60,
                    marginB = 60;
                const maxLineWidth = pageWidth - marginL - marginR;
                const lineHeight = 16;

                doc.setFont("Helvetica", "normal");
                doc.setFontSize(12);

                const lines = doc.splitTextToSize(content, maxLineWidth);
                let cursorY = marginT;
                lines.forEach(line => {
                    if (cursorY > pageHeight - marginB) {
                        doc.addPage();
                        cursorY = marginT;
                    }
                    doc.text(line, marginL, cursorY);
                    cursorY += lineHeight;
                });
                doc.save("SAGE_Analysis.pdf");
            }

            // Initialize WebSocket connection
            initializeWebSocket();

            // --- Session Management ---
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    userLoggedIn = true;
                    currentUser = session.user;
                } else if (event === 'SIGNED_OUT') {
                    userLoggedIn = false;
                    currentUser = null;
                }
                updateNavBar();
            });

            // --- Navigation Logic ---
            function navigateTo(pageId) {
                pages.forEach(page => {
                    page.classList.remove('active', 'flex', 'block');
                    page.style.display = 'none';
                });

                const targetPage = $(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    if (['home', 'templates', 'templateDetail', 'examplesPage', 'adminDashboard', 'about'].includes(pageId)) {
                        targetPage.style.display = 'block';
                    } else {
                        targetPage.style.display = 'flex';
                    }

                    if (pageId === 'adminDashboard') {
                        fetchAndDisplayStatistics();
                    }
                    window.scrollTo(0, 0);
                }
            }

            // --- Update Navigation Bar Links ---
            function updateNavBar() {
                const loginLink = document.querySelector('a[data-page="login"], a[data-page="logout"]');

                if (userLoggedIn) {
                    if (loginLink) {
                        loginLink.textContent = 'Logout';
                        loginLink.setAttribute('data-page', 'logout');
                    }
                } else {
                    if (loginLink) {
                        loginLink.textContent = 'Login';
                        loginLink.setAttribute('data-page', 'login');
                    }
                }
                attachNavLinkListeners();
            }

            // --- Attach Navigation Link Listeners ---
            function attachNavLinkListeners() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.removeEventListener('click', handleNavLinkClick);
                    link.addEventListener('click', handleNavLinkClick);
                });
            }

            function handleNavLinkClick(e) {
                e.preventDefault();
                const pageId = this.getAttribute('data-page');

                if (pageId === 'logout') {
                    handleLogout();
                    return;
                }

                if (pageId === 'templates') {
                    navigateTo('home');
                    return;
                }

                if ((pageId === 'login' || pageId === 'signup') && userLoggedIn) {
                    navigateTo('home');
                    return;
                }
                navigateTo(pageId);
            }
            
            // --- Admin Dashboard Stats Logic ---
            const refreshStatsBtn = $('refreshStatsBtn');
            if (refreshStatsBtn) {
                refreshStatsBtn.addEventListener('click', fetchAndDisplayStatistics);
            }

            async function fetchAndDisplayStatistics() {
                if (!userLoggedIn) {
                    showMessage('statsMessage', 'You must be logged in to refresh statistics.', 'error');
                    return;
                }

                const btn = $('refreshStatsBtn');
                const textEl = $('refreshStatsBtnText');
                const spinner = $('refreshStatsSpinner');
                
                btn.disabled = true;
                spinner.classList.remove('hidden');
                textEl.textContent = 'Loading...';
                showMessage('statsMessage', '', 'success');

                try {
                    const { data, error } = await supabase.functions.invoke('statistics', {
                        body: { update: true },
                    });

                    if (error) {
                        throw error;
                    }

                    if (data && data.success) {
                        const dbStatus = data.database_status;
                        if (dbStatus) {
                            $('statTotalUsers').textContent = dbStatus.total_users ?? 'N/A';
                            $('statActiveUsers').textContent = dbStatus.log_in_users ?? 'N/A';
                            $('statTotalQueries').textContent = dbStatus.total_queries ?? 'N/A';
                            $('dashQueryCount').textContent = dbStatus.total_queries ?? '0';
                            $('statDbSize').textContent = dbStatus.database_size ?? 'N/A';
                            $('statAvgTime').textContent = dbStatus.avg_p_time ? parseFloat(dbStatus.avg_p_time).toFixed(2) + ' ms' : 'N/A';
                            $('statRecordedAt').textContent = dbStatus.recorded_at ? new Date(dbStatus.recorded_at).toLocaleString() : 'N/A';
                        }

                        const pineconeStatus = data.pinecone_status;
                        const pineconeContainer = $('pineconeStatsContainer');
                        if (pineconeStatus && pineconeStatus.status) {
                            pineconeContainer.classList.remove('hidden');
                            $('statPineconeName').textContent = pineconeStatus.name ?? 'N/A';
                            $('statTotalVectors').textContent = pineconeStatus.total_vectors ?? 'N/A';
                            $('statBookVectors').textContent = pineconeStatus.book_namespace_vectors ?? 'N/A';
                            $('statPineconeDimension').textContent = pineconeStatus.dimension ?? 'N/A';
                            $('statPineconeStatus').textContent = pineconeStatus.status ?? 'N/A';
                            $('statPineconeCloud').textContent = `${pineconeStatus.cloud_provider ?? ''} (${pineconeStatus.region ?? ''})`;
                        } else {
                            pineconeContainer.classList.add('hidden');
                        }
                        showMessage('statsMessage', 'Statistics updated successfully!', 'success');
                    } else {
                         throw new Error(data.error || 'Failed to fetch statistics.');
                    }

                } catch (error) {
                    console.error("Error fetching statistics:", error);
                    showMessage('statsMessage', `Error: ${error.message}`, 'error');
                } finally {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    textEl.textContent = 'Refresh Stats';
                }
            }

            // --- Home Page Card & Tab Logic ---
            function setupHomeTabs() {
                const tabsNav = $('homeTabsNav');
                const tabPanels = document.querySelectorAll('.home-tab-panel');
                const tabBtns = document.querySelectorAll('.home-tab-btn');

                tabPanels.forEach(panel => {
                    if (panel.classList.contains('active')) {
                        panel.style.display = 'grid';
                    } else {
                        panel.style.display = 'none';
                    }
                });

                tabsNav.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON') return;
                    const targetTab = e.target.dataset.tab;

                    tabBtns.forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.tab === targetTab);
                    });

                    tabPanels.forEach(panel => {
                        if (panel.id === targetTab) {
                            panel.classList.add('active');
                            panel.style.display = 'grid';
                        } else {
                            panel.classList.remove('active');
                            panel.style.display = 'none';
                        }
                    });
                });
            }

            function attachHomeCardListeners() {
                document.querySelectorAll('.home-template-link').forEach(card => {
                    card.addEventListener('click', () => {
                        const templateId = card.dataset.templateId;
                        preFillData = card.dataset.preFill || '';

                        if (!userLoggedIn) {
                            showMessage('loginMessage', 'Please log in to use the analysis tools.', 'error');
                            navigateTo('login');
                        } else {
                            selectedTemplateForModal = templateId;
                            $('versionChoiceModal').classList.remove('hidden');
                        }
                    });
                });
            }

            function proceedFromModal() {
                $('versionChoiceModal').classList.add('hidden');
                if (selectedTemplateForModal) {
                    showTemplateDetail(selectedTemplateForModal);
                }
            }
            
            // --- Template Detail Page Logic ---

            function reattachActionListeners() {
                const savePdfBtn = $('savePdfBtn');
                const saveDocxBtn = $('saveDocxBtn');
                if (savePdfBtn) savePdfBtn.addEventListener('click', handleSaveAsPdf);
                if (saveDocxBtn) saveDocxBtn.addEventListener('click', handleSaveAsDocx);
            }
            
            function reattachTabListeners(container) {
                const tabNav = container.querySelector('.flex.border-b');
                const tabContent = container.querySelector('div:not(.flex)');
                if (tabNav && tabContent) {
                    tabNav.addEventListener('click', e => {
                        if (e.target.tagName === 'BUTTON') {
                            tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                            tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                            e.target.classList.add('active');
                            const targetPanelId = e.target.dataset.tab + 'Panel';
                            const targetPanel = $(targetPanelId);
                            targetPanel.classList.add('active');
                            
                            const chart = targetPanel.querySelector('.plotly-chart');
                            if (chart) {
                                Plotly.Plots.resize(chart);
                            }
                        }
                    });
                }
            }

            function showTemplateDetail(templateId) {
                currentTemplateId = templateId;
                const rule = templateRules[templateId] || {};

                // Dynamically get template info from the clicked card if not in the predefined list
                let template = templates[templateId];
                if (!template) {
                    const card = document.querySelector(`.home-template-link[data-template-id="${templateId}"]`);
                    if (card) {
                        const title = card.querySelector('h3').innerText;
                        const descriptionEl = card.querySelector('p');
                        const description = descriptionEl ? descriptionEl.innerText : `Generate a detailed analysis for ${title}.`;
                        template = { title: title, description: description };
                        templates[templateId] = template; // Cache it
                    } else {
                        // Generic fallback if card isn't found
                        template = { title: templateId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), description: `Generate a detailed analysis.` };
                        templates[templateId] = template;
                    }
                }

                // Handle special layouts that replace the whole content area
                if (rule.useSwotLayout) {
                    createSwotTowsLayout(template);
                    navigateTo('templateDetail');
                    return;
                }
                if (rule.useArchetypeLayout) {
                    createArchetypeAnalysisLayout(template);
                    navigateTo('templateDetail');
                    return;
                }
                 if (rule.useFactorAnalysisLayout) {
                    createFactorAnalysisLayout(template);
                    navigateTo('templateDetail');
                    return;
                }
                if (rule.useParetoLayout) {
                    createParetoLayout(template);
                    navigateTo('templateDetail');
                    return;
                }
                
                // --- Default Layout Handling (Rebuilds the DOM for consistency) ---
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-2 gap-12'; // Reset to default grid class
                contentContainer.innerHTML = `
                    <div>
                        <h1 id="templateTitle" class="text-4xl font-bold mb-4">${template.title}</h1>
                        <p id="templateDescription" class="text-white/80 mb-8">${template.description}</p>
                        <div class="glass-container p-6">
                            <div id="templateFormFields" class="space-y-4"></div>
                            
                            <div id="analysisSectionsContainer" class="glass-container mt-8" style="display: ${rule.hideAnalysisSection ? 'none' : 'block'}">
                                <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Analysis Sections</h4>
                                <p class="text-white/70 text-center mb-4">Choose the components for your report.</p>
                                <ul id="analysisList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Introduction</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Overview of business</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>process overview</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>mission statement</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision analysis</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision statement 2</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 1</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 2</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 3</span></li>
                                </ul>
                            </div>
                            
                            <div id="methodsConsideredContainer" class="glass-container mt-8" style="display: ${rule.hideFrameworks ? 'none' : 'block'}">
                                <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Frameworks</h4>
                                <p id="selectionCounter" class="text-white/70 text-center mb-4">Selected: 0 / 3</p>
                                <ul id="frameworkList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Reframing Thinking"><span>Reframing Thinking</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Delphi Method"><span>Delphi Method</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Blue Ocean Strategy"><span>Blue Ocean Strategy</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Design Thinking"><span>Design Thinking</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Thinking Hats"><span>Thinking Hats</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Business Model Canvas"><span>Business Model Canvas</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="SCAMPER"><span>SCAMPER</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="TRIZ (Theory of Inventive Problem Solving)"><span>TRIZ (Theory of Inventive Problem Solving)</span></li>
                                </ul>
                            </div>

                            <button id="generateBtn" class="btn btn-primary w-full mt-4">
                                <span id="generateBtnText">Generate Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold mb-4">Generated Analysis</h2>
                        <div id="analysisResult" class="glass-container min-h-[300px] whitespace-pre-wrap overflow-x-auto">
                        </div>
                        <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                             <button id="savePdfBtn" class="btn btn-secondary">PDF</button>
                             <button id="saveDocxBtn" class="btn btn-secondary">DOCX</button>
                        </div>
                    </div>
                `;
                
                // Populate the form fields into the newly created div
                populateDefaultFormFields(templateId);
                
                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult')); 
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }

                // Reset and configure frameworks, re-attaching listeners to new elements
                const frameworkCheckboxes = document.querySelectorAll('#frameworkList .method-checkbox');
                frameworkCheckboxes.forEach(cb => {
                    cb.addEventListener('change', frameworkCheckboxChangeHandler);
                    cb.disabled = false;
                    cb.checked = false;
                });
                
                if (rule.preselectFramework) {
                    frameworkCheckboxes.forEach(cb => {
                        if (cb.dataset.framework === rule.preselectFramework) {
                            cb.checked = true;
                        }
                        cb.disabled = true;
                    });
                }
                
                // Re-attach all necessary event listeners for the new elements
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();

                configureFrameworkSelector(currentSelectionLimit);
                navigateTo('templateDetail');
            }


            function populateDefaultFormFields(templateId) {
                const templateFormFields = $('templateFormFields');
                templateFormFields.innerHTML = ''; // Clear previous fields
                
                // For Fishbone/Pareto, we only need the problem statement.
                if (templateId === 'pareto-fishbone') {
                    templateFormFields.innerHTML = `
                        <div>
                            <label for="problemStatement" class="block text-sm font-medium text-gray-200 mb-2">Problem Statement</label>
                            <input type="text" id="problemStatement" class="input-field" placeholder="e.g., Low Customer Satisfaction" required>
                        </div>
                    `;
                } else { // Default form for most tools
                    templateFormFields.innerHTML = `
                        <div><label for="companyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label><input type="text" id="companyName" class="input-field" placeholder="e.g., Innovate Inc." required></div>
                        <div>
                            <label for="companyDocumentsFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Company Documents</label>
                            <div class="input-file-wrapper">
                                <label for="companyDocumentsFile" id="companyDocumentsFileLabel" class="input-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                    <span class="file-name">Click to select a file...</span>
                                </label>
                                <input type="file" id="companyDocumentsFile" class="input-file">
                            </div>
                        </div>
                        <div><label for="location" class="block text-sm font-medium text-gray-200 mb-2">Location</label><input type="text" id="location" class="input-field" placeholder="e.g., Global" required></div>
                    `;
                    const fileInput = $('companyDocumentsFile');
                    if(fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            const label = $('companyDocumentsFileLabel');
                            const fileNameSpan = label.querySelector('.file-name');
                            if (e.target.files.length > 0) {
                                fileNameSpan.textContent = e.target.files[0].name;
                                label.classList.add('has-file');
                            } else {
                                fileNameSpan.textContent = 'Click to select a file...';
                                label.classList.remove('has-file');
                            }
                        });
                    }
                }
            }


            function createSwotTowsLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12'; // Change class for this layout
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container p-6 max-w-2xl mx-auto w-full">
                            <h3 class="text-xl font-bold mb-4 text-white">Business Information</h3>
                            <div class="space-y-4">
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="businessContent" class="input-field h-48" placeholder="Describe your business, industry, market position, challenges, opportunities, etc."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                     <div class="input-file-wrapper">
                                         <label for="swotFile" id="swotFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Click to select a file...</span>
                                         </label>
                                         <input type="file" id="swotFile" class="input-file" accept=".txt,.pdf,.docx">
                                    </div>
                                    <p class="text-xs text-white/50 mt-2 text-center">Note: Only .txt files can be read by the browser. PDF/DOCX are not supported for reading.</p>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText">Run SWOT/TOWS Analysis</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>

                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;

                // Re-attach event listeners for the newly created elements
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();

                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult'));
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }
                
                // Listeners for radio buttons
                $('textInput').addEventListener('change', () => {
                    $('textInputArea').classList.remove('hidden');
                    $('docUploadArea').classList.add('hidden');
                });
                $('docUpload').addEventListener('change', () => {
                    $('textInputArea').classList.add('hidden');
                    $('docUploadArea').classList.remove('hidden');
                });
                 // Listener for file input
                const fileInput = $('swotFile');
                if(fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const label = $('swotFileLabel');
                        const fileNameSpan = label.querySelector('.file-name');
                        if (e.target.files.length > 0) {
                            fileNameSpan.textContent = e.target.files[0].name;
                            label.classList.add('has-file');
                        } else {
                            fileNameSpan.textContent = 'Click to select a file...';
                            label.classList.remove('has-file');
                        }
                    });
                }
            }
            
            function createArchetypeAnalysisLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12'; // Change layout to single column
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-6">
                            <h3 class="text-xl font-bold text-white text-center">Upload Document</h3>
                            <div class="input-file-wrapper">
                                 <label for="archetypeFile" id="archetypeFileLabel" class="input-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                    <span class="file-name">Select .docx or .txt file...</span>
                                 </label>
                                 <input type="file" id="archetypeFile" class="input-file" accept=".txt,.docx">
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText">🧠 Analyze System</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

                // Attach event listeners
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();
                
                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult'));
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }
                
                const fileInput = $('archetypeFile');
                 if(fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const label = $('archetypeFileLabel');
                        const fileNameSpan = label.querySelector('.file-name');
                        if (e.target.files.length > 0) {
                            fileNameSpan.textContent = e.target.files[0].name;
                            label.classList.add('has-file');
                        } else {
                            fileNameSpan.textContent = 'Select .docx or .txt file...';
                            label.classList.remove('has-file');
                        }
                    });
                }
            }
            
            function createFactorAnalysisLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-6">
                                <h3 class="text-xl font-bold text-white text-center">Upload Document</h3>
                                <div class="input-file-wrapper">
                                    <label for="factorFile" id="factorFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx file...</span>
                                    </label>
                                    <input type="file" id="factorFile" class="input-file" accept=".docx">
                                </div>
                                <div id="fileStats" class="text-sm text-white/70 text-center"></div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText">🔍 Analyze Factors</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                            </div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;

                // Attach event listeners
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();
                
                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult'));
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }

                const fileInput = $('factorFile');
                if (fileInput) {
                    fileInput.addEventListener('change', async (e) => {
                        const label = $('factorFileLabel');
                        const fileNameSpan = label.querySelector('.file-name');
                        const fileStats = $('fileStats');
                        if (e.target.files.length > 0) {
                            const file = e.target.files[0];
                            fileNameSpan.textContent = file.name;
                            label.classList.add('has-file');
                            try {
                                const text = await extractTextFromFile(file);
                                fileStats.innerHTML = `<p>Word Count: ${text.split(/\s+/).length}</p><p>Character Count: ${text.length}</p>`;
                            } catch (err) {
                                fileStats.innerHTML = `<p class="text-red-400">Error reading file.</p>`;
                            }
                        } else {
                            fileNameSpan.textContent = 'Select .docx file...';
                            label.classList.remove('has-file');
                            fileStats.innerHTML = '';
                        }
                    });
                }
            }

            function createParetoLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div>
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="max-w-2xl mx-auto">
                            <div class="glass-container p-6 space-y-4">
                                <div>
                                    <label for="problemStatement" class="block text-sm font-medium text-gray-200 mb-2">Problem Statement</label>
                                    <input type="text" id="problemStatement" class="input-field" placeholder="e.g., Low Customer Satisfaction" required>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText">Analyze Root Causes</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                            </div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult'));
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }
                
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();
            }


            function frameworkCheckboxChangeHandler() {
                const checkedBoxes = document.querySelectorAll('#frameworkList .method-checkbox:checked');
                const selectionCounter = $('selectionCounter');
                
                if (checkedBoxes.length > currentSelectionLimit) {
                    this.checked = false;
                }

                const finalCheckedCount = document.querySelectorAll('#frameworkList .method-checkbox:checked').length;
                if(selectionCounter) {
                    selectionCounter.textContent = `Selected: ${finalCheckedCount} / ${currentSelectionLimit}`;
                }
            }
            
            function configureFrameworkSelector(limit) {
                currentSelectionLimit = limit;
                const selectionCounter = $('selectionCounter');
                const checkboxes = document.querySelectorAll('#frameworkList .method-checkbox');
                
                if(!selectionCounter || !checkboxes) return;

                selectionCounter.textContent = `Selected: 0 / ${limit}`;
                
                const rule = templateRules[currentTemplateId] || {};
                if (!rule.preselectFramework) {
                     checkboxes.forEach(cb => {
                        cb.checked = false;
                    });
                }
                 frameworkCheckboxChangeHandler();
            }

            function getSelectedFrameworks() {
                const checkedBoxes = document.querySelectorAll('#frameworkList .method-checkbox:checked');
                const selectedMethods = [];

                const frameworkMap = {
                    'Reframing Thinking': 'ReframingThinking',
                    'Delphi Method': 'DelphiMethod',
                    'Blue Ocean Strategy': 'BlueOcean',
                    'Design Thinking': 'DesignThinking',
                    'Thinking Hats': 'ThinkingHats',
                    'Business Model Canvas': 'BusinessModelCanvas',
                    'SCAMPER': 'SCAMPER',
                    'TRIZ (Theory of Inventive Problem Solving)': 'TRIZ'
                };

                checkedBoxes.forEach(checkbox => {
                    const methodText = checkbox.dataset.framework;
                    if (frameworkMap[methodText]) {
                        selectedMethods.push(frameworkMap[methodText]);
                    }
                });
                return selectedMethods.join(',');
            }

            function getSelectedSections() {
                const checkedBoxes = document.querySelectorAll('#analysisList .method-checkbox:checked');
                const sectionMap = {
                    'Introduction': 'introduction',
                    'Overview of business': 'overview_of_business',
                    'process overview': 'process_overview',
                    'mission statement': 'mission_statement',
                    'vision analysis': 'vision_analysis',
                    'vision statement 2': 'vision_statement_2',
                    'novel strategy part 1': 'novel_strategy_part_1',
                    'novel strategy part 2': 'novel_strategy_part_2',
                    'novel strategy part 3': 'novel_strategy_part_3'
                };

                if (checkedBoxes.length === 0) {
                    return Object.values(sectionMap).join(',');
                }

                const selectedSections = [];
                checkedBoxes.forEach(checkbox => {
                    const sectionText = checkbox.nextElementSibling.textContent.trim();
                    if (sectionMap[sectionText]) {
                        selectedSections.push(sectionMap[sectionText]);
                    }
                });
                return selectedSections.join(',');
            }

            function getFrameworkForTemplate(templateId) {
                const selectedFrameworks = getSelectedFrameworks();
                return selectedFrameworks || 'BlueOcean,SCAMPER';
            }

            // =========================================================================
            // ===== ANALYSIS LOGIC FUNCTIONS                                     =====
            // =========================================================================

            /**
             * Extracts text from a user-uploaded file. Supports .txt and .docx.
             */
            async function extractTextFromFile(file) {
                return new Promise((resolve, reject) => {
                    if (file.type === "text/plain") {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = e => reject("Error reading .txt file.");
                        reader.readAsText(file);
                    } else if (file.name.endsWith('.docx')) {
                        if (window.mammoth) {
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                const arrayBuffer = event.target.result;
                                try {
                                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                                    resolve(result.value);
                                } catch (err) {
                                    reject(`Error reading .docx file: ${err.message}`);
                                }
                            };
                            reader.onerror = () => reject("Error preparing .docx file for reading.");
                            reader.readAsArrayBuffer(file);
                        } else {
                            reject('.docx reader library (mammoth.js) not found.');
                        }
                    } else {
                        reject(`Unsupported file type: ${file.name.split('.').pop()}. Please use .txt or .docx.`);
                    }
                });
            }

            /**
             * Robustly extracts a JSON object from a string, which might contain extra text.
             */
            function extractJsonRobust(text) {
                try {
                    const jsonStart = text.indexOf('{');
                    const jsonEnd = text.lastIndexOf('}') + 1;
                    if (jsonStart !== -1 && jsonEnd !== -1) {
                        const jsonStr = text.substring(jsonStart, jsonEnd);
                        return JSON.parse(jsonStr);
                    }
                } catch (e) {
                    console.warn("Standard JSON parsing failed. The AI response may be malformed.", e);
                }
                throw new Error("Failed to parse a valid JSON object from the AI's response.");
            }
            
            async function handleGenerate() {
                if (!currentTemplateId) return;

                const analysisResultContainer = $('analysisResult');
                setLoading('generate', true);
                const analysisActionsEl = $('analysisActions');
                if (analysisActionsEl) {
                    analysisActionsEl.classList.add('hidden');
                }

                if (currentTemplateId === 'swot-tows') {
                    await handleSwotTowsAnalysis();
                } else if (currentTemplateId === 'archetype-analysis') {
                    await handleArchetypeAnalysis();
                } else if (currentTemplateId === 'pareto-fishbone') {
                    await handleParetoFishboneAnalysis();
                } else if (currentTemplateId === 'factor-analysis') {
                    await handleFactorAnalysis();
                }
                else {
                    // --- Generic n8n workflow for all other tools ---
                    analysisResultContainer.innerHTML = `
                        <div class="text-center text-white/70 p-8">
                            <div class="typing-indicator mb-6">
                                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-4">Generating Your Strategic Analysis</h3>
                            <p class="text-white/80 mb-2">This comprehensive analysis may take 2-5 minutes to complete.</p>
                            <p class="text-white/60 text-sm">Please keep this page open while we process your request.</p>
                        </div>`;
                    
                    let fullPrompt = '';
                    const formData = new FormData();
                    const companyName = $('companyName').value.trim();
                    const companyDocumentsFile = $('companyDocumentsFile').files[0];
                    const location = $('location').value.trim();
                    const framework = getFrameworkForTemplate(currentTemplateId);
                    const sections = getSelectedSections();

                    if (!companyName || !companyDocumentsFile || !location) {
                        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Please fill out all fields and upload a file.</div>`;
                        setLoading('generate', false);
                        return;
                    }
                    fullPrompt = `User Information: - Company Name: ${companyName} - Location: ${location}`;
                    formData.append('customerName', companyName);
                    formData.append('location', location);
                    formData.append('company_documents', companyDocumentsFile.name);
                    formData.append('file', companyDocumentsFile);
                    formData.append('framework', framework);
                    formData.append('sections', sections);
                    formData.append('prompt', fullPrompt);
                    formData.append('templateId', currentTemplateId);
                    
                    try {
                        const { data: { session } } = await supabase.auth.getSession();
                        if (!session) throw new Error("Please log in to generate analysis.");

                        const messageId = Date.now();
                        pendingAnalysisRequests.set(messageId, analysisResultContainer);
                        formData.append('messageId', messageId);

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000);

                        const response = await fetch('https://n8n.data2int.com/webhook/analysis-ev2', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${session.access_token}` },
                            body: formData,
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        console.log('Analysis request submitted successfully.');
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log('Fetch request timed out as expected. Waiting for WebSocket response.');
                            return;
                        }
                        console.error('Error submitting analysis request:', error);
                        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                        setLoading('generate', false);
                    }
                }
            }

            async function handleParetoFishboneAnalysis() {
                const analysisResultContainer = $('analysisResult');
                 analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Generating Pareto & Fishbone Analysis</h3>
                        <p class="text-white/80 mb-2">This may take a moment...</p>
                    </div>`;

                try {
                    const problem = $('problemStatement').value.trim();
                    if (!problem) {
                        throw new Error("Please enter a problem statement.");
                    }

                    const fullPrompt = `Analyze the problem: "${problem}" and create both a fishbone diagram and Pareto analysis.

                    Generate exactly 6 main categories with sub-causes, then analyze using 80/20 rule.
                    Each label must be MAXIMUM 3 words.

                    Provide response as valid JSON with this exact structure:
                    {{
                      "fishbone": {{
                        "Category 1": ["sub-cause 1", "sub-cause 2", "sub-cause 3"],
                        "Category 2": ["sub-cause 1", "sub-cause 2", "sub-cause 3", "sub-cause 4"],
                        "Category 3": ["sub-cause 1", "sub-cause 2", "sub-cause 3"],
                        "Category 4": ["sub-cause 1", "sub-cause 2", "sub-cause 3"],
                        "Category 5": ["sub-cause 1", "sub-cause 2", "sub-cause 3"],
                        "Category 6": ["sub-cause 1", "sub-cause 2", "sub-cause 3"]
                      }},
                      "pareto_analysis": {{
                        "vital_few": [
                          {{"cause": "Root cause 1", "impact_score": 25, "category": "Category 1"}},
                          {{"cause": "Root cause 2", "impact_score": 20, "category": "Category 2"}},
                          {{"cause": "Root cause 3", "impact_score": 15, "category": "Category 3"}},
                          {{"cause": "Root cause 4", "impact_score": 12, "category": "Category 4"}},
                          {{"cause": "Root cause 5", "impact_score": 10, "category": "Category 5"}}
                        ],
                        "useful_many": [
                          {{"cause": "Root cause 6", "impact_score": 8, "category": "Category 6"}},
                          {{"cause": "Root cause 7", "impact_score": 5, "category": "Category 1"}},
                          {{"cause": "Root cause 8", "impact_score": 3, "category": "Category 2"}},
                          {{"cause": "Root cause 9", "impact_score": 2, "category": "Category 3"}}
                        ],
                        "analysis_summary": "Brief explanation of why these causes follow 80/20 rule for {problem}"
                      }}
                    }}

                    Requirements:
                    - Impact scores should total 100
                    - Vital few (top 20% causes) should account for ~80% of impact
                    - All cause names must be 3 words or less
                    - Use realistic impact scores based on typical root cause analysis
                    - Focus on actionable, specific root causes

                    Respond ONLY with valid JSON, no additional text.`;
                    
                    const ollamaPayload = {
                        model: "llama3",
                        prompt: fullPrompt,
                        format: "json",
                        stream: false
                    };

                    const response = await fetch('https://ollama.data2int.com/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ollamaPayload)
                    });

                    if (!response.ok) {
                        throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                    }

                    const ollamaResult = await response.json();
                    const parsedData = JSON.parse(ollamaResult.response);
                    
                    // --- Render the results in a tabbed interface ---
                    const container = analysisResultContainer;
                    container.innerHTML = '';
                    const fishboneData = parsedData.fishbone;
                    const paretoData = parsedData.pareto_analysis;
                    
                    const tabNav = document.createElement('div');
                    tabNav.className = 'flex border-b border-white/20 -mx-6 px-6'; // Adjusted padding for glass container
                    tabNav.innerHTML = `
                        <button class="analysis-tab-btn active" data-tab="pareto">📊 Pareto Chart</button>
                        <button class="analysis-tab-btn" data-tab="details">📋 Analysis Details</button>
                        <button class="analysis-tab-btn" data-tab="plan">🎯 Action Plan</button>
                    `;
                    container.appendChild(tabNav);
                    
                    const tabContent = document.createElement('div');
                    container.appendChild(tabContent);

                    tabContent.innerHTML = `
                        <div id="paretoPanel" class="analysis-tab-panel active"></div>
                        <div id="detailsPanel" class="analysis-tab-panel"></div>
                        <div id="planPanel" class="analysis-tab-panel"></div>
                    `;
                    
                    const paretoChartDiv = document.createElement('div');
                    paretoChartDiv.id = 'paretoChartContainer';
                    $('paretoPanel').appendChild(paretoChartDiv);
                    createParetoChartJS(paretoData, 'paretoChartContainer');

                    let detailsHtml = `<h3 class="text-2xl font-bold mb-4">Analysis Summary</h3>`;
                    if (paretoData.analysis_summary) {
                        detailsHtml += `<div class="p-4 rounded-lg bg-white/5 mb-6 text-white/80 italic">${paretoData.analysis_summary}</div>`;
                    }
                    detailsHtml += `<h4 class="text-xl font-semibold mb-3">Category Breakdown (Fishbone)</h4>`;
                    for (const [category, sub_causes] of Object.entries(fishboneData)) {
                        detailsHtml += `<details class="bg-white/5 p-3 rounded-lg mb-2"><summary class="cursor-pointer font-semibold">${category} (${sub_causes.length} causes)</summary><ul class="mt-2 pl-4">`;
                        sub_causes.forEach(cause => {
                            const isVital = (paretoData.vital_few || []).some(item => cause.toLowerCase() === item.cause.toLowerCase());
                            detailsHtml += `<li class="mb-1">${isVital ? '🔥' : '📝'} ${cause}</li>`;
                        });
                        detailsHtml += `</ul></details>`;
                    }
                    $('detailsPanel').innerHTML = detailsHtml;

                    let planHtml = `<h3 class="text-2xl font-bold mb-4">Recommended Action Plan</h3>
                                    <div class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6">💡 <strong>80/20 Rule:</strong> Focus 80% of your resources on the 'Vital Few' causes for maximum impact!</div>
                                    <h4 class="text-xl font-semibold mb-3 border-b border-red-500/50 pb-2 text-red-300">🔥 IMMEDIATE FOCUS (Vital Few)</h4>`;
                    (paretoData.vital_few || []).forEach(cause => {
                        planHtml += `<div class="mb-4"><p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p><p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> HIGH ⚡</p></div>`;
                    });
                    planHtml += `<h4 class="text-xl font-semibold mt-8 mb-3 border-b border-white/20 pb-2">📋 SECONDARY ACTIONS (Useful Many)</h4>`;
                    (paretoData.useful_many || []).forEach(cause => {
                        planHtml += `<div class="mb-4"><p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p><p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> Medium/Low</p></div>`;
                    });
                    $('planPanel').innerHTML = planHtml;
                    
                    analysisCache[currentTemplateId] = container.innerHTML;

                    tabNav.addEventListener('click', e => {
                        if(e.target.tagName === 'BUTTON') {
                            tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                            tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                            e.target.classList.add('active');
                            const targetPanel = $(e.target.dataset.tab + 'Panel');
                            targetPanel.classList.add('active');
                            const chart = targetPanel.querySelector('.plotly-chart');
                            if (chart) Plotly.Plots.resize(chart);
                        }
                    });

                    $('analysisActions').classList.remove('hidden');

                } catch (error) {
                    console.error('Error with Pareto/Fishbone generation:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred during generation: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }
            
            function createParetoChartJS(paretoData, containerId) {
                const allCauses = (paretoData.vital_few || []).concat(paretoData.useful_many || []);
                if (allCauses.length === 0) return;

                allCauses.sort((a, b) => b.impact_score - a.impact_score);

                const causes = allCauses.map(item => item.cause);
                const impacts = allCauses.map(item => item.impact_score);
                const categories = allCauses.map(item => item.category);

                const cumulative = impacts.reduce((acc, val) => {
                    acc.push((acc.length > 0 ? acc[acc.length - 1] : 0) + val);
                    return acc;
                }, []);
                const totalImpact = impacts.reduce((a, b) => a + b, 0);
                const cumulativePct = cumulative.map(val => (val / totalImpact) * 100);
                
                const trace1 = {
                    x: causes,
                    y: impacts,
                    name: 'Impact Score',
                    type: 'bar',
                    text: impacts.map(imp => `${imp}%`),
                    textposition: 'outside',
                    marker: { color: 'var(--primary)' },
                    hovertemplate: '<b>%{x}</b><br>Impact: %{y}%<br>Category: %{customdata}<extra></extra>',
                    customdata: categories
                };

                const trace2 = {
                    x: causes,
                    y: cumulativePct,
                    name: 'Cumulative %',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: 'var(--accent)', width: 3 },
                    marker: { size: 8 },
                    yaxis: 'y2',
                    hovertemplate: '<b>%{x}</b><br>Cumulative: %{y:.1f}%<extra></extra>'
                };

                const layout = {
                    title: 'Pareto Analysis - 80/20 Root Cause Impact',
                    xaxis: { title: 'Root Causes', tickangle: -45, automargin: true },
                    yaxis: { title: 'Impact Score (%)' },
                    yaxis2: {
                        title: 'Cumulative Impact (%)',
                        overlaying: 'y',
                        side: 'right',
                        range: [0, 101]
                    },
                    shapes: [{
                        type: 'line', xref: 'paper', x0: 0, x1: 1,
                        yref: 'y2', y0: 80, y1: 80,
                        line: { color: 'orange', width: 2, dash: 'dash' }
                    }],
                    showlegend: true, height: 500, hovermode: 'x unified',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: document.body.classList.contains('light-theme') ? '#1a202c' : 'white' }
                };

                Plotly.newPlot(containerId, [trace1, trace2], layout, {responsive: true});
            }


            // =========================================================================
            // ===== SPECIALIZED ANALYSIS LOGIC (SWOT, ARCHETYPE, FACTOR)         =====
            // =========================================================================

            async function handleSwotTowsAnalysis() {
                const analysisResultContainer = $('analysisResult');
                
                analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Performing Comprehensive SWOT/TOWS Analysis</h3>
                        <p class="text-white/80 mb-2">This multi-step process may take several minutes.</p>
                        <p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p>
                    </div>`;
                
                const statusEl = $('analysisStatus');
                const OLLAMA_URL = "https://ollama.data2int.com/api/generate"; 
                const MODEL_NAME = "llama3.1:latest";

                try {
                    statusEl.textContent = 'Reading your business content...';
                    const useDoc = $('docUpload').checked;
                    let businessContent = '';

                    if (useDoc) {
                        const file = $('swotFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        businessContent = await extractTextFromFile(file);
                    } else {
                        businessContent = $('businessContent').value;
                        if (!businessContent.trim()) throw new Error("Please enter business information in the text area.");
                    }
                    
                    if (businessContent.length > 4000) {
                        businessContent = businessContent.substring(0, 4000);
                    }
                    
                    async function generateOllamaResponse(prompt) {
                        const response = await fetch(OLLAMA_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false })
                        });
                        if (!response.ok) throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                        const data = await response.json();
                        return extractJsonRobust(data.response);
                    }

                    statusEl.textContent = 'Analyzing internal factors (Strengths & Weaknesses)...';
                    const internalPrompt = `
                        You are a strategic business analyst. Analyze the following business content and identify SPECIFIC internal factors.
                        BUSINESS CONTENT: ${businessContent}
                        TASK: Identify exactly 5-7 strengths and 5-7 weaknesses that are INTERNAL to the organization.
                        CRITICAL REQUIREMENTS:
                        - Each factor must be specific and actionable
                        - Base factors ONLY on the content provided
                        - Strengths = internal positive factors the company controls
                        - Weaknesses = internal negative factors the company needs to address
                        RESPOND ONLY with this exact JSON structure (no additional text):
                        {"strengths": ["Strength 1", "Strength 2", "Strength 5"],"weaknesses": ["Weakness 1", "Weakness 2", "Weakness 5"]}`;
                    const internal_factors = await generateOllamaResponse(internalPrompt);
                    if (!internal_factors.strengths || !internal_factors.weaknesses) throw new Error("Failed to identify internal factors.");

                    statusEl.textContent = 'Analyzing external factors (Opportunities & Threats)...';
                    const externalPrompt = `
                        You are a strategic business analyst. Analyze the following business content and identify SPECIFIC external factors.
                        BUSINESS CONTENT: ${businessContent}
                        TASK: Identify exactly 5-7 opportunities and 5-7 threats that are EXTERNAL to the organization.
                        CRITICAL REQUIREMENTS:
                        - Each factor must be specific and actionable
                        - Base factors ONLY on the content provided and logical market context
                        - Opportunities = external positive factors the company can leverage
                        - Threats = external negative factors that pose risks
                        - Consider: market trends, competition, regulations, technology, economy
                        RESPOND ONLY with this exact JSON structure (no additional text):
                        {"opportunities": ["Opportunity 1", "Opportunity 2", "Opportunity 5"],"threats": ["Threat 1", "Threat 2", "Threat 5"]}`;
                    const external_factors = await generateOllamaResponse(externalPrompt);
                    if (!external_factors.opportunities || !external_factors.threats) throw new Error("Failed to identify external factors.");

                    const swot_data = { ...internal_factors, ...external_factors };

                    statusEl.textContent = 'Generating TOWS strategies...';
                    const towsPrompt = `
                        You are a strategic business consultant. Create TOWS matrix strategies based on the following SWOT analysis.
                        STRENGTHS: ${swot_data.strengths.map(s => `- ${s}`).join('\n')}
                        WEAKNESSES: ${swot_data.weaknesses.map(w => `- ${w}`).join('\n')}
                        OPPORTUNITIES: ${swot_data.opportunities.map(o => `- ${o}`).join('\n')}
                        THREATS: ${swot_data.threats.map(t => `- ${t}`).join('\n')}
                        TASK: Generate exactly 3-4 specific strategies for each TOWS quadrant.
                        RESPOND ONLY with this exact JSON structure (no additional text):
                        {"SO_strategies": ["SO strategy 1", "SO strategy 3"],"WO_strategies": ["WO strategy 1", "WO strategy 3"],"ST_strategies": ["ST strategy 1", "ST strategy 3"],"WT_strategies": ["WT strategy 1", "WT strategy 3"]}`;
                    const tows_strategies = await generateOllamaResponse(towsPrompt);

                    statusEl.textContent = 'Applying 80/20 rule for key insights...';
                    const allStrategies = [].concat(...Object.values(tows_strategies));
                    const insightsPrompt = `
                        You are a senior strategy consultant applying the Pareto Principle (80/20 rule).
                        SWOT FACTORS:
                        Strengths: ${JSON.stringify(swot_data.strengths)}
                        Weaknesses: ${JSON.stringify(swot_data.weaknesses)}
                        Opportunities: ${JSON.stringify(swot_data.opportunities)}
                        Threats: ${JSON.stringify(swot_data.threats)}
                        ALL TOWS STRATEGIES: ${allStrategies.map(s => `- ${s}`).join('\n')}
                        TASK: Apply the 80/20 rule to identify the 20% of factors and strategies that will drive 80% of impact/value.
                        RESPOND ONLY with this exact JSON structure (no additional text):
                        {"key_strategies": ["Impactful strategy #1", "Impactful strategy #3"],"critical_factors": ["Critical factor #1", "Critical factor #3"],"strategic_focus": "Single overarching strategic direction.","priority_actions": ["Immediate action #1", "Immediate action #3"]}`;
                    const key_insights_80_20 = await generateOllamaResponse(insightsPrompt);
                    
                    statusEl.textContent = 'Analysis complete! Rendering visualizations...';
                    const finalData = {
                        swot_analysis: swot_data,
                        tows_strategies: tows_strategies,
                        key_insights_80_20: key_insights_80_20
                    };
                    renderFullSwotTowsPage(analysisResultContainer, finalData);
                    
                } catch (error) {
                    console.error('Error during SWOT/TOWS analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}<br><br><span class="text-sm text-white/60">Please ensure your Ollama server is running and accessible at ${OLLAMA_URL}.</span></div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleArchetypeAnalysis() {
                 const analysisResultContainer = $('analysisResult');
                
                analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Performing System Thinking Analysis</h3>
                        <p class="text-white/80 mb-2">This multi-step process may take several minutes.</p>
                        <p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p>
                    </div>`;

                const statusEl = $('analysisStatus');
                const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
                const MODEL_NAME = "llama3.1:latest";

                 try {
                    statusEl.textContent = 'Reading and processing your document...';
                    const file = $('archetypeFile').files[0];
                    if (!file) throw new Error("Please select a document to upload.");
                    
                    let text = await extractTextFromFile(file);
                    if (!text) throw new Error("Could not extract text from the document.");
                    if (text.length > 3000) text = text.substring(0, 3000);

                    async function generateOllamaResponse(prompt) {
                        const response = await fetch(OLLAMA_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: 'json' })
                        });
                        if (!response.ok) throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                        const data = await response.json();
                        return JSON.parse(data.response); // Expecting valid JSON now
                    }

                    // Step 1: Extract Concepts
                    statusEl.textContent = 'Step 1/3: Extracting key system concepts...';
                    const conceptPrompt = `
                        Analyze the following text and extract key 2-4 word concepts. For each concept, provide:
                        1. name (2-4 words)
                        2. description (brief)
                        3. effect ("+", "-", or "0")
                        4. influence ("High", "Medium", or "Low")
                        Text: ${text}
                        Return ONLY a valid JSON object with the structure: {"concepts": [{"name": "...", "description": "...", "effect": "...", "influence": "..."}]}`;
                    const conceptData = await generateOllamaResponse(conceptPrompt);
                    const concepts = conceptData.concepts;
                    if (!concepts || concepts.length === 0) throw new Error("No concepts were extracted from the document.");
                    
                    // Step 2: Identify Archetypes
                    statusEl.textContent = 'Step 2/3: Identifying relevant system archetypes...';
                    const conceptText = concepts.map(c => c.name).join(', ');
                    const archetypePrompt = `
                        From this list of concepts: [${conceptText}], identify the most relevant system archetypes. For each, provide:
                        1. name (standard archetype name)
                        2. relevance_score (1-10)
                        3. description (how it applies to these concepts)
                        4. leverage_points (list of strings)
                        5. interventions (list of strings)
                        Return ONLY a valid JSON object with the structure: {"archetypes": [{"name": "...", "relevance_score": ..., "description": "...", "leverage_points": [], "interventions": []}]}`;
                    const archetypeData = await generateOllamaResponse(archetypePrompt);
                    let archetypes = archetypeData.archetypes;
                    
                    // 80/20 Rule for Archetypes
                    archetypes.sort((a, b) => (b.relevance_score || 0) - (a.relevance_score || 0));
                    const topArchetypeCount = Math.max(1, Math.floor(archetypes.length * 0.2));
                    const topArchetypes = archetypes.slice(0, topArchetypeCount);

                    // Step 3: Analyze Leverage Points
                    statusEl.textContent = 'Step 3/3: Analyzing high-impact leverage points...';
                    const leveragePrompt = `
                        Analyze these concepts: [${conceptText}] and identify leverage points. For each, provide:
                        1. concept (the concept name)
                        2. score (1-10 for impact potential)
                        3. reasoning (why it's a leverage point)
                        4. actions (list of recommended actions)
                        5. impact ("High", "Medium", or "Low")
                        Return ONLY a valid JSON object with the structure: {"leverage_points": [{"concept": "...", "score": ..., "reasoning": "...", "actions": [], "impact": "..."}]}`;
                    const leverageData = await generateOllamaResponse(leveragePrompt);
                    let leveragePoints = leverageData.leverage_points;

                    // 80/20 Rule for Leverage Points
                    leveragePoints.sort((a, b) => (b.score || 0) - (a.score || 0));
                    const topLeverageCount = Math.max(1, Math.floor(leveragePoints.length * 0.2));
                    const topLeveragePoints = leveragePoints.slice(0, topLeverageCount);

                    // Final step: Render the full page
                    statusEl.textContent = 'Analysis complete! Rendering results...';
                    renderArchetypeAnalysisPage(analysisResultContainer, {
                        concepts,
                        topArchetypes,
                        topLeveragePoints
                    });
                    
                 } catch(error) {
                    console.error('Error during Archetype analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}<br><br><span class="text-sm text-white/60">Please ensure your Ollama server is running and accessible at ${OLLAMA_URL}.</span></div>`;
                 } finally {
                    setLoading('generate', false);
                 }
            }

            async function handleFactorAnalysis() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                        <h3 class="text-xl font-semibold text-white">Analyzing Document...</h3>
                    </div>`;

                try {
                    const file = $('factorFile').files[0];
                    if (!file) {
                        throw new Error("Please upload a document to analyze.");
                    }

                    const documentText = await extractTextFromFile(file);
                    
                    const externalFactors = extractExternalFactorsJS(documentText);
                    const internalFactors = extractInternalFactorsJS(documentText);
                    
                    const prioritizedExternal = applyParetoAnalysisJS(externalFactors);
                    const prioritizedInternal = applyParetoAnalysisJS(internalFactors);
                    
                    renderFactorAnalysisPage(analysisResultContainer, {
                        external: prioritizedExternal,
                        internal: prioritizedInternal
                    });

                } catch (error) {
                    console.error('Error during Factor Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }
            
            // =========================================================================
            // ===== FACTOR ANALYSIS LOGIC (JS PORT)                              =====
            // =========================================================================
            
            function findFactors(text, patternsByCategory, factorType) {
                const factors = [];
                const sentences = text.split(/[.!?]+/);
                
                for (const category in patternsByCategory) {
                    for (const sentence of sentences) {
                        const trimmedSentence = sentence.trim();
                        if (trimmedSentence.length > 25) { // Only check substantial sentences
                            for (const pattern of patternsByCategory[category]) {
                                if (pattern.test(trimmedSentence)) {
                                    let factorText = trimmedSentence;
                                    const words = factorText.split(/\s+/);
                                    if (words.length > 30) {
                                        factorText = words.slice(0, 30).join(' ') + '...';
                                    }
                                    
                                    factors.push({
                                        category: category,
                                        factor: factorText,
                                        impact_score: calculateFactorImpactJS(trimmedSentence),
                                        type: factorType
                                    });
                                    break; 
                                }
                            }
                        }
                    }
                }

                const seen = new Set();
                const uniqueFactors = factors.filter(factor => {
                    const key = factor.factor.toLowerCase();
                    if (seen.has(key)) {
                        return false;
                    } else {
                        seen.add(key);
                        return true;
                    }
                });

                return uniqueFactors.sort((a, b) => b.impact_score - a.impact_score);
            }

            function extractExternalFactorsJS(text) {
                const patterns = {
                    'Political/Regulatory': [/government\s+policy/gi, /regulation[s]?/gi, /political\s+climate/gi, /tax\s+policy/gi, /regulatory\s+change[s]?/gi, /political\s+stability/gi, /policy\s+change[s]?/gi, /government\s+support/gi, /regulatory\s+compliance/gi, /legal\s+requirement[s]?/gi, /political\s+risk[s]?/gi, /legislative\s+change[s]?/gi, /government\s+incentive[s]?/gi, /trade\s+policy/gi, /political\s+factor[s]?/gi],
                    'Economic': [/economic\s+growth/gi, /recession/gi, /inflation/gi, /interest\s+rate[s]?/gi, /economic\s+downturn/gi, /market\s+growth/gi, /economic\s+condition[s]?/gi, /gdp\s+growth/gi, /economic\s+trend[s]?/gi, /currency\s+fluctuation[s]?/gi, /economic\s+stability/gi, /market\s+size/gi, /purchasing\s+power/gi, /economic\s+indicator[s]?/gi, /financial\s+crisis/gi, /economic\s+factor[s]?/gi],
                    'Social/Cultural': [/demographic\s+change[s]?/gi, /social\s+trend[s]?/gi, /cultural\s+shift[s]?/gi, /consumer\s+behavior/gi, /lifestyle\s+change[s]?/gi, /population\s+growth/gi, /social\s+attitude[s]?/gi, /cultural\s+preference[s]?/gi, /social\s+factor[s]?/gi, /demographic\s+trend[s]?/gi, /generational\s+change[s]?/gi, /social\s+norm[s]?/gi, /cultural\s+value[s]?/gi, /social\s+movement[s]?/gi],
                    'Technological': [/technological\s+advance[s]?/gi, /innovation[s]?/gi, /digital\s+transformation/gi, /automation/gi, /artificial\s+intelligence/gi, /technology\s+trend[s]?/gi, /digitalization/gi, /technological\s+disruption/gi, /new\s+technolog[y|ies]/gi, /tech\s+development[s]?/gi, /technological\s+change[s]?/gi, /digital\s+trend[s]?/gi, /emerging\s+technolog[y|ies]/gi, /technological\s+factor[s]?/gi],
                    'Market/Industry': [/market\s+trend[s]?/gi, /industry\s+growth/gi, /market\s+demand/gi, /industry\s+change[s]?/gi, /market\s+dynamic[s]?/gi, /industry\s+trend[s]?/gi, /market\s+condition[s]?/gi, /industry\s+standard[s]?/gi, /market\s+evolution/gi, /sector\s+growth/gi, /market\s+maturity/gi, /industry\s+consolidation/gi, /market\s+expansion/gi, /industry\s+factor[s]?/gi],
                    'Competitive': [/competitor[s]?\s+enter[y|ing]/gi, /new\s+competitor[s]?/gi, /competitive\s+pressure/gi, /market\s+competition/gi, /competitor[s]?\s+action[s]?/gi, /competitive\s+threat[s]?/gi, /industry\s+rival[s]?/gi, /competitive\s+landscape/gi, /competitor[s]?\s+strategy/gi, /market\s+rival[s]?/gi, /competitive\s+force[s]?/gi, /competitor[s]?\s+advantage/gi, /competitive\s+environment/gi, /rival\s+compan[y|ies]/gi],
                    'Environmental': [/climate\s+change/gi, /environmental\s+regulation[s]?/gi, /sustainability\s+trend[s]?/gi, /environmental\s+concern[s]?/gi, /green\s+initiative[s]?/gi, /carbon\s+footprint/gi, /environmental\s+impact/gi, /climate\s+factor[s]?/gi, /environmental\s+policy/gi, /sustainability\s+requirement[s]?/gi, /environmental\s+standard[s]?/gi, /climate\s+risk[s]?/gi, /environmental\s+factor[s]?/gi]
                };
                return findFactors(text, patterns, 'External');
            }

            function extractInternalFactorsJS(text) {
                const patterns = {
                    'Human Resources': [/skilled\s+workforce/gi, /talent\s+pool/gi, /employee\s+expertise/gi, /team\s+capability/gi, /staff\s+skill[s]?/gi, /human\s+resource[s]?/gi, /employee\s+motivation/gi, /workforce\s+quality/gi, /talent\s+management/gi, /staff\s+experience/gi, /employee\s+training/gi, /skill[s]?\s+gap[s]?/gi, /team\s+strength[s]?/gi, /personnel\s+capability/gi, /employee\s+retention/gi],
                    'Financial Resources': [/financial\s+strength/gi, /cash\s+flow/gi, /capital\s+resource[s]?/gi, /funding/gi, /financial\s+position/gi, /revenue\s+stream[s]?/gi, /profitability/gi, /financial\s+performance/gi, /capital\s+structure/gi, /financial\s+stability/gi, /budget\s+allocation/gi, /financial\s+resource[s]?/gi, /cost\s+structure/gi, /financial\s+capability/gi, /investment\s+capacity/gi],
                    'Technology & Systems': [/technology\s+infrastructure/gi, /it\s+system[s]?/gi, /technological\s+capability/gi, /software\s+system[s]?/gi, /technology\s+platform[s]?/gi, /digital\s+infrastructure/gi, /technical\s+expertise/gi, /system\s+integration/gi, /technology\s+stack/gi, /it\s+capability/gi, /technological\s+asset[s]?/gi, /digital\s+capability/gi, /system\s+efficiency/gi, /technical\s+resource[s]?/gi],
                    'Operations & Processes': [/operational\s+efficiency/gi, /process\s+improvement/gi, /operational\s+capability/gi, /production\s+capacity/gi, /operational\s+excellence/gi, /process\s+optimization/gi, /supply\s+chain/gi, /operational\s+process[es]?/gi, /manufacturing\s+capability/gi, /operational\s+system[s]?/gi, /process\s+efficiency/gi, /operational\s+strength[s]?/gi, /production\s+process[es]?/gi, /operational\s+performance/gi],
                    'Brand & Marketing': [/brand\s+recognition/gi, /brand\s+strength/gi, /market\s+presence/gi, /brand\s+value/gi, /marketing\s+capability/gi, /brand\s+reputation/gi, /customer\s+loyalty/gi, /brand\s+awareness/gi, /marketing\s+expertise/gi, /brand\s+position[ing]?/gi, /marketing\s+strength[s]?/gi, /brand\s+equity/gi, /marketing\s+resource[s]?/gi, /promotional\s+capability/gi, /brand\s+image/gi],
                    'Research & Development': [/research\s+capability/gi, /innovation\s+capability/gi, /r&d\s+strength[s]?/gi, /product\s+development/gi, /research\s+expertise/gi, /innovation\s+process[es]?/gi, /development\s+capability/gi, /research\s+resource[s]?/gi, /innovative\s+capacity/gi, /r&d\s+investment/gi, /research\s+facility/gi, /development\s+expertise/gi, /innovation\s+strength[s]?/gi, /research\s+team/gi],
                    'Strategic Assets': [/intellectual\s+property/gi, /patent[s]?/gi, /strategic\s+alliance[s]?/gi, /partnership[s]?/gi, /strategic\s+asset[s]?/gi, /competitive\s+advantage/gi, /core\s+competenc[y|ies]/gi, /unique\s+resource[s]?/gi, /strategic\s+capability/gi, /proprietary\s+technology/gi, /strategic\s+position/gi, /key\s+asset[s]?/gi, /distinctive\s+capability/gi, /strategic\s+strength[s]?/gi]
                };
                return findFactors(text, patterns, 'Internal');
            }

            function calculateFactorImpactJS(sentence) {
                let base_score = 5.0;
                const positive_words = ['growth', 'opportunity', 'strength', 'advantage', 'improvement', 'increase', 'strong', 'effective', 'successful', 'excellent', 'high'];
                const negative_words = ['risk', 'threat', 'challenge', 'weakness', 'decline', 'decrease', 'poor', 'low', 'difficult', 'problem', 'issue', 'concern'];
                const high_impact_words = ['significant', 'major', 'critical', 'important', 'key', 'essential', 'substantial', 'considerable', 'dramatic', 'crucial'];
                
                const sentence_lower = sentence.toLowerCase();
                
                const positive_count = positive_words.reduce((count, word) => count + (sentence_lower.includes(word) ? 1 : 0), 0);
                const negative_count = negative_words.reduce((count, word) => count + (sentence_lower.includes(word) ? 1 : 0), 0);
                const high_impact_count = high_impact_words.reduce((count, word) => count + (sentence_lower.includes(word) ? 1 : 0), 0);
                
                const impact_modifier = (positive_count * 0.5) - (negative_count * 0.3) + (high_impact_count * 0.8);
                let final_score = base_score + impact_modifier;
                
                return parseFloat(Math.max(1.0, Math.min(10.0, final_score)).toFixed(2));
            }

            function applyParetoAnalysisJS(factors) {
                if (!factors || factors.length === 0) return [];
                
                const sorted_factors = [...factors].sort((a, b) => b.impact_score - a.impact_score);
                const total_impact = sorted_factors.reduce((sum, f) => sum + f.impact_score, 0);
                
                if (total_impact === 0) {
                    return sorted_factors.map((f, i) => ({ ...f, cumulative_percentage: 0, priority: 'Low', rank: i + 1 }));
                }
                
                let cumulative_impact = 0;
                return sorted_factors.map((factor, i) => {
                    cumulative_impact += factor.impact_score;
                    const cumulative_percentage = (cumulative_impact / total_impact) * 100;
                    return {
                        ...factor,
                        cumulative_percentage: parseFloat(cumulative_percentage.toFixed(1)),
                        priority: cumulative_percentage <= 80 ? 'High' : 'Low',
                        rank: i + 1
                    };
                });
            }

            // =========================================================================
            // ===== VISUALIZATION & RENDERING FUNCTIONS                          =====
            // =========================================================================
            function renderFactorAnalysisPage(container, data) {
                 container.innerHTML = '';
                 const { external, internal } = data;

                 const tabNav = document.createElement('div');
                 tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                 tabNav.innerHTML = `
                     <button class="analysis-tab-btn active" data-tab="external">🌍 External Factors</button>
                     <button class="analysis-tab-btn" data-tab="internal">🏢 Internal Factors</button>
                     <button class="analysis-tab-btn" data-tab="pareto">📈 80/20 Analysis</button>
                     <button class="analysis-tab-btn" data-tab="summary">📋 Summary</button>
                 `;
                 container.appendChild(tabNav);
                 
                 const tabContent = document.createElement('div');
                 container.appendChild(tabContent);

                 tabContent.innerHTML = `
                     <div id="externalPanel" class="analysis-tab-panel active"></div>
                     <div id="internalPanel" class="analysis-tab-panel"></div>
                     <div id="paretoPanel" class="analysis-tab-panel"></div>
                     <div id="summaryPanel" class="analysis-tab-panel"></div>
                 `;

                 renderFactorTab('externalPanel', 'External Factors Analysis', external);
                 renderFactorTab('internalPanel', 'Internal Factors Analysis', internal);
                 renderParetoTab('paretoPanel', [...external, ...internal]);
                 renderSummaryTab('summaryPanel', external, internal);
                 
                 analysisCache[currentTemplateId] = container.innerHTML;

                 tabNav.addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        const targetPanelId = e.target.dataset.tab + 'Panel';
                        const targetPanel = $(targetPanelId);
                        targetPanel.classList.add('active');
                        
                        const chart = targetPanel.querySelector('.plotly-chart');
                        if (chart) {
                            Plotly.Plots.resize(chart);
                        }
                    }
                 });
            }

            function renderFactorTab(containerId, title, factors) {
                const container = $(containerId);
                let contentHtml = `<h3 class="text-2xl font-bold mb-4">${title}</h3>`;
                
                if (factors && factors.length > 0) {
                    const categories = factors.reduce((acc, f) => {
                        if (!acc[f.category]) acc[f.category] = [];
                        acc[f.category].push(f);
                        return acc;
                    }, {});

                    contentHtml += `<div id="${containerId}-chart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
                    
                    for (const category in categories) {
                        contentHtml += `<div class="mb-4"><details class="bg-white/5 p-3 rounded-lg"><summary class="cursor-pointer font-semibold">${category} (${categories[category].length} factors)</summary><div class="mt-2 pl-4">`;
                        categories[category].forEach(factor => {
                             contentHtml += `<div class="py-2 border-b border-white/10 last:border-b-0">
                                <p class="${factor.priority === 'High' ? 'text-red-300' : 'text-yellow-300'}"><strong>Rank #${factor.rank}</strong> - Score: ${factor.impact_score}</p>
                                <p>${factor.factor}</p>
                                <p class="text-sm text-white/60">Priority: ${factor.priority} | Cumulative: ${factor.cumulative_percentage}%</p>
                            </div>`;
                        });
                        contentHtml += `</div></details></div>`;
                    }
                } else {
                    contentHtml += '<p class="text-white/70">No factors found in this category.</p>';
                }
                
                container.innerHTML = contentHtml;
                
                if (factors && factors.length > 0) {
                    const categoryCounts = Object.entries(factors.reduce((acc, f) => {
                        acc[f.category] = (acc[f.category] || 0) + 1;
                        return acc;
                    }, {})).map(([cat, count]) => ({ category: cat, count: count }));

                    Plotly.newPlot(`${containerId}-chart`, [{
                        x: categoryCounts.map(c => c.category),
                        y: categoryCounts.map(c => c.count),
                        type: 'bar',
                        marker: { color: 'var(--primary)' }
                    }], {
                        title: `${title.split(' ')[0]} Factors by Category`,
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: 'white' },
                        xaxis: { automargin: true, tickangle: -25 },
                        yaxis: { title: 'Number of Factors', gridcolor: 'rgba(255,255,255,0.2)' }
                    }, {responsive: true});
                }
            }

            function renderParetoTab(containerId, allFactors) {
                const container = $(containerId);
                let contentHtml = `<h3 class="text-2xl font-bold mb-4">📈 80/20 Pareto Analysis</h3>`;
                
                if (allFactors && allFactors.length > 0) {
                    contentHtml += `<div id="pareto-chart-container" class="w-full h-[600px] mb-8 plotly-chart"></div>`;
                    
                    const highPriorityFactors = allFactors.filter(f => f.priority === 'High');
                    contentHtml += `<h4 class="text-xl font-semibold mt-8 mb-3">🎯 Priority Recommendations</h4>
                                    <p class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6"><strong>80/20 Rule Application:</strong> Focus on the top ${highPriorityFactors.length} factors to address ~80% of the strategic impact.</p>`;
                    
                    const extHigh = highPriorityFactors.filter(f => f.type === 'External').slice(0, 5);
                    const intHigh = highPriorityFactors.filter(f => f.type === 'Internal').slice(0, 5);

                    contentHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><h5 class="font-bold mb-2">Top External Priorities</h5>`;
                    extHigh.forEach(f => {
                        contentHtml += `<div class="text-sm mb-2 p-2 bg-white/5 rounded"><strong>${f.category}:</strong> ${f.factor.substring(0, 60)}...</div>`;
                    });
                    contentHtml += `</div><div><h5 class="font-bold mb-2">Top Internal Priorities</h5>`;
                    intHigh.forEach(f => {
                        contentHtml += `<div class="text-sm mb-2 p-2 bg-white/5 rounded"><strong>${f.category}:</strong> ${f.factor.substring(0, 60)}...</div>`;
                    });
                    contentHtml += `</div></div>`;
                } else {
                    contentHtml += '<p class="text-white/70">No factors available for Pareto analysis.</p>';
                }
                
                container.innerHTML = contentHtml;
                
                if (allFactors && allFactors.length > 0) {
                    const topFactors = [...allFactors].sort((a, b) => b.impact_score - a.impact_score).slice(0, 15);
                    
                    const trace1 = {
                        x: topFactors.map(f => `${f.type.substring(0,3)}: ${f.factor.substring(0,40)}...`),
                        y: topFactors.map(f => f.impact_score),
                        name: 'Impact Score',
                        type: 'bar',
                        marker: { color: topFactors.map(f => f.priority === 'High' ? 'var(--accent)' : 'var(--primary)') }
                    };

                    const trace2 = {
                        x: topFactors.map(f => `${f.type.substring(0,3)}: ${f.factor.substring(0,40)}...`),
                        y: topFactors.map(f => f.cumulative_percentage),
                        name: 'Cumulative %',
                        type: 'scatter',
                        yaxis: 'y2',
                        line: { color: '#FFF' }
                    };

                    const layout = {
                        title: '80/20 Pareto Analysis - Top Strategic Factors',
                        xaxis: { tickangle: -45, automargin: true },
                        yaxis: { title: 'Impact Score' },
                        yaxis2: { title: 'Cumulative %', overlaying: 'y', side: 'right', range: [0, 101] },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                        legend: { orientation: 'h', y: -0.4 },
                        shapes: [{ type: 'line', xref: 'paper', yref: 'y2', x0: 0, y0: 80, x1: 1, y1: 80, line: { color: 'orange', width: 2, dash: 'dash' }}]
                    };
                    
                    Plotly.newPlot('pareto-chart-container', [trace1, trace2], layout, {responsive: true});
                }
            }
            
            function renderSummaryTab(containerId, external, internal) {
                 const container = $(containerId);
                 const highPriorityExternal = external.filter(f => f.priority === 'High').length;
                 const highPriorityInternal = internal.filter(f => f.priority === 'High').length;
                 const topExtCat = external.length > 0 ? Object.entries(external.reduce((acc, f) => { acc[f.category] = (acc[f.category] || 0) + 1; return acc; }, {})).sort((a,b) => b[1]-a[1])[0][0] : 'N/A';
                 const topIntCat = internal.length > 0 ? Object.entries(internal.reduce((acc, f) => { acc[f.category] = (acc[f.category] || 0) + 1; return acc; }, {})).sort((a,b) => b[1]-a[1])[0][0] : 'N/A';
                 
                 container.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">📋 Executive Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="metric-card"><h4 class="font-bold">Total External Factors</h4><p class="text-3xl font-bold">${external.length}</p></div>
                        <div class="metric-card"><h4 class="font-bold">Total Internal Factors</h4><p class="text-3xl font-bold">${internal.length}</p></div>
                        <div class="metric-card critical"><h4 class="font-bold">High-Priority External</h4><p class="text-3xl font-bold">${highPriorityExternal}</p></div>
                        <div class="metric-card critical"><h4 class="font-bold">High-Priority Internal</h4><p class="text-3xl font-bold">${highPriorityInternal}</p></div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-lg">
                        <h4 class="text-xl font-semibold mb-3">Key Insights</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>External Focus:</strong> The most dominant external factors fall under the <strong>${topExtCat}</strong> category.</li>
                            <li><strong>Internal Focus:</strong> Internally, factors related to <strong>${topIntCat}</strong> are most prominent.</li>
                            <li><strong>80/20 Application:</strong> A total of <strong>${highPriorityExternal + highPriorityInternal}</strong> factors have been identified as high-priority, representing the critical 20% that likely drive 80% of strategic impact.</li>
                        </ul>
                    </div>
                 `;
            }

            function renderFullSwotTowsPage(container, data) {
                container.innerHTML = ''; // Clear loading state
                const { swot_analysis, tows_strategies, key_insights_80_20 } = data;
                if (!swot_analysis || !tows_strategies || !key_insights_80_20) {
                     container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete analysis data received.</div>`;
                     return;
                }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `
                    <button class="analysis-tab-btn active" data-tab="swot">SWOT Matrix</button>
                    <button class="analysis-tab-btn" data-tab="tows">TOWS Strategies</button>
                    <button class="analysis-tab-btn" data-tab="insights">80/20 Key Insights</button>
                    <button class="analysis-tab-btn" data-tab="details">Detailed Analysis</button>
                `;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);

                tabContent.innerHTML = `
                    <div id="swotPanel" class="analysis-tab-panel active"></div>
                    <div id="towsPanel" class="analysis-tab-panel"></div>
                    <div id="insightsPanel" class="analysis-tab-panel"></div>
                    <div id="detailsPanel" class="analysis-tab-panel"></div>
                `;

                renderSwotVisualization(swot_analysis, 'swotPanel');
                renderTowsVisualization(tows_strategies, 'towsPanel');
                render8020Visualization(key_insights_80_20, 'insightsPanel');
                renderDetailedAnalysis(swot_analysis, tows_strategies, 'detailsPanel');
                
                analysisCache[currentTemplateId] = container.innerHTML;

                tabNav.addEventListener('click', e => {
                    if(e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        const targetPanel = $(e.target.dataset.tab + 'Panel');
                        targetPanel.classList.add('active');
                        const chart = targetPanel.querySelector('.plotly-chart');
                        if (chart) Plotly.Plots.resize(chart);
                    }
                });
            }
            
            function renderDetailedAnalysis(swotData, towsData, containerId) {
                const container = $(containerId);
                const factorCounts = { 'Strengths': (swotData.strengths || []).length, 'Weaknesses': (swotData.weaknesses || []).length, 'Opportunities': (swotData.opportunities || []).length, 'Threats': (swotData.threats || []).length };
                const strategyCounts = { 'SO (Strength-Opportunity)': (towsData.SO_strategies || []).length, 'WO (Weakness-Opportunity)': (towsData.WO_strategies || []).length, 'ST (Strength-Threat)': (towsData.ST_strategies || []).length, 'WT (Weakness-Threat)': (towsData.WT_strategies || []).length };
                const factorColors = ['#2E8B57', '#CD5C5C', '#4169E1', '#FF8C00'];
                
                let metricsHtml = `<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">`;
                Object.entries(factorCounts).forEach(([key, value], index) => { metricsHtml += `<div class="p-4 rounded-lg bg-white/5 text-center"><h4 class="text-sm font-bold" style="color:${factorColors[index]}">${key}</h4><p class="text-3xl font-bold">${value}</p></div>`; });
                metricsHtml += `</div>`;
                
                let chartHtml = `<div id="strategyBarChart" class="w-full h-[400px] plotly-chart"></div>`;

                let recommendationsHtml = `<h4 class="text-xl font-semibold mt-8 mb-3">Strategic Recommendations Summary</h4><ul class="list-disc list-inside space-y-2 text-white/80">`;
                recommendationsHtml += factorCounts['Strengths'] > factorCounts['Weaknesses'] ? "<li>Strong internal position - leverage strengths for growth.</li>" : "<li>Address internal weaknesses to improve competitive position.</li>";
                recommendationsHtml += factorCounts['Opportunities'] > factorCounts['Threats'] ? "<li>Favorable external environment - pursue growth opportunities.</li>" : "<li>Defensive strategy needed - mitigate external threats.</li>";
                recommendationsHtml += `</ul>`;

                container.innerHTML = metricsHtml + chartHtml + recommendationsHtml;
                
                const plotData = [{ x: Object.keys(strategyCounts), y: Object.values(strategyCounts), type: 'bar', marker: { color: Object.values(strategyCounts), colorscale: 'Viridis' } }];
                const layout = { title: 'Number of Strategies by Type', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: { title: 'Strategy Type', automargin: true }, yaxis: { title: 'Count', gridcolor: 'rgba(255,255,255,0.2)' }, margin: { t: 40, b: 60, l: 40, r: 20 }};
                Plotly.newPlot('strategyBarChart', plotData, layout, {responsive: true});
            }

            function renderSwotVisualization(swotData, containerId) {
                const container = $(containerId);
                const quadrants = [ { title: 'Strengths', data: swotData.strengths, color: '#2E8B57', icon: '💪' }, { title: 'Weaknesses', data: swotData.weaknesses, color: '#CD5C5C', icon: '⚠️' }, { title: 'Opportunities', data: swotData.opportunities, color: '#4169E1', icon: '✨' }, { title: 'Threats', data: swotData.threats, color: '#FF8C00', icon: '🛡️' }];
                let gridHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                quadrants.forEach(q => {
                    const itemsHtml = q.data && q.data.length > 0 ? q.data.map(item => `<li>${item}</li>`).join('') : '<li>No items identified.</li>';
                    gridHtml += `<div class="bg-white/5 rounded-lg p-4 border-t-4" style="border-top-color: ${q.color};"><h3 class="text-lg font-bold text-center mb-3" style="color: ${q.color};">${q.icon} ${q.title}</h3><ul class="list-disc list-inside space-y-2 text-white/80 text-sm">${itemsHtml}</ul></div>`;
                });
                gridHtml += '</div>';
                container.innerHTML = gridHtml;
            }

            function renderTowsVisualization(towsData, containerId) {
                const container = $(containerId);
                const quadrants = [ { title: 'SO Strategies (Maxi-Maxi)', data: towsData.SO_strategies, color: '#32CD32', icon: '🚀' }, { title: 'WO Strategies (Mini-Maxi)', data: towsData.WO_strategies, color: '#FFD700', icon: '📈' }, { title: 'ST Strategies (Maxi-Mini)', data: towsData.ST_strategies, color: '#87CEEB', icon: '🛡️' }, { title: 'WT Strategies (Mini-Mini)', data: towsData.WT_strategies, color: '#DDA0DD', icon: '🚧' }];
                let gridHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                quadrants.forEach(q => {
                    const itemsHtml = q.data && q.data.length > 0 ? q.data.map(item => `<li>${item}</li>`).join('') : '<li>No strategies generated.</li>';
                    gridHtml += `<div class="bg-white/5 rounded-lg p-4 border-t-4" style="border-top-color: ${q.color};"><h3 class="text-lg font-bold text-center mb-3" style="color: ${q.color};">${q.icon} ${q.title}</h3><ul class="list-disc list-inside space-y-2 text-white/80 text-sm">${itemsHtml}</ul></div>`;
                });
                gridHtml += '</div>';
                container.innerHTML = gridHtml;
            }

            function render8020Visualization(insightsData, containerId) {
                const container = $(containerId);
                container.innerHTML = `
                    <div class="p-4 space-y-8">
                        <div class="p-6 rounded-lg bg-white/10 border border-white/20"><h3 class="text-2xl font-bold mb-4 text-center text-indigo-300">🎯 Strategic Focus</h3><p class="text-center text-lg italic text-white/90">${insightsData.strategic_focus || 'Not defined.'}</p></div>
                        <div class="grid md:grid-cols-2 gap-8">
                            <div class="p-4 rounded-lg bg-white/5"><h4 class="text-xl font-semibold mb-3 text-center">🚀 Key Strategies (Top 20%)</h4><ul class="space-y-3 list-disc list-inside text-white/80">${(insightsData.key_strategies || []).map(s => `<li>${s}</li>`).join('')}</ul></div>
                            <div class="p-4 rounded-lg bg-white/5"><h4 class="text-xl font-semibold mb-3 text-center">⚡ Critical Factors (Top 20%)</h4><ul class="space-y-3 list-disc list-inside text-white/80">${(insightsData.critical_factors || []).map(f => `<li>${f}</li>`).join('')}</ul></div>
                        </div>
                        <div class="p-6 rounded-lg bg-white/10 border border-white/20"><h4 class="text-xl font-semibold mb-3 text-center">✅ Priority Actions</h4><ol class="space-y-3 list-decimal list-inside text-white/90 text-center">${(insightsData.priority_actions || []).map(a => `<li>${a}</li>`).join('')}</ol></div>
                    </div>`;
            }
            
            function renderArchetypeAnalysisPage(container, data) {
                container.innerHTML = '';
                const { concepts, topArchetypes, topLeveragePoints } = data;
                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="concepts">📋 Concepts</button><button class="analysis-tab-btn" data-tab="network">🕸️ Network</button><button class="analysis-tab-btn" data-tab="archetypes">🏛️ Archetypes</button><button class="analysis-tab-btn" data-tab="leverage">⚡ Leverage Points</button>`;
                container.appendChild(tabNav);
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="conceptsPanel" class="analysis-tab-panel active"></div><div id="networkPanel" class="analysis-tab-panel"></div><div id="archetypesPanel" class="analysis-tab-panel"></div><div id="leveragePanel" class="analysis-tab-panel"></div>`;
                renderConceptsTab(concepts, 'conceptsPanel');
                renderNetworkTab(concepts, 'networkPanel');
                renderArchetypesTab(topArchetypes, 'archetypesPanel');
                renderLeveragePointsTab(topLeveragePoints, 'leveragePanel');
                
                analysisCache[currentTemplateId] = container.innerHTML;

                tabNav.addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        const targetPanel = $(e.target.dataset.tab + 'Panel');
                        targetPanel.classList.add('active');
                        const chart = targetPanel.querySelector('.plotly-chart');
                        if (chart) Plotly.Plots.resize(chart);
                    }
                });
            }

            function renderConceptsTab(concepts, containerId) {
                const container = $(containerId);
                const positiveCount = concepts.filter(c => c.effect === '+').length;
                const negativeCount = concepts.filter(c => c.effect === '-').length;
                const neutralCount = concepts.filter(c => c.effect === '0').length;
                let tableHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><div class="metric-card"><h4 class="font-bold">Positive Effects</h4><p class="text-3xl font-bold">${positiveCount}</p></div><div class="metric-card"><h4 class="font-bold">Negative Effects</h4><p class="text-3xl font-bold">${negativeCount}</p></div><div class="metric-card"><h4 class="font-bold">Neutral Effects</h4><p class="text-3xl font-bold">${neutralCount}</p></div></div><div id="effectPieChart" class="w-full h-[400px] mb-8 plotly-chart"></div><h3 class="text-2xl font-bold mb-4">Extracted Concepts</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-white/20"><tr><th class="p-2">Concept</th><th class="p-2">Description</th><th class="p-2">Effect</th><th class="p-2">Influence</th></tr></thead><tbody>`;
                concepts.forEach(c => { tableHtml += `<tr class="border-b border-white/10"><td class="p-2 font-semibold">${c.name}</td><td class="p-2 text-sm text-white/80">${c.description}</td><td class="p-2 text-center">${c.effect}</td><td class="p-2">${c.influence}</td></tr>`; });
                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;
                Plotly.newPlot('effectPieChart', [{ values: [positiveCount, negativeCount, neutralCount], labels: ['Positive', 'Negative', 'Neutral'], type: 'pie', marker: { colors: ['#2E8B57', '#CD5C5C', '#808080'] }, hole: .4 }], { title: 'Distribution of Concept Effects', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, legend: { orientation: 'h', y: -0.1 } }, {responsive: true});
            }

            function renderNetworkTab(concepts, containerId) {
                const container = $(containerId);
                container.innerHTML = `<div id="conceptNetworkChart" class="w-full h-[600px] plotly-chart"></div>`;
                const nodes = concepts.map(c => ({ id: c.name, ...c }));
                const edges = [];
                for (let i = 0; i < nodes.length; i++) { for (let j = i + 1; j < nodes.length; j++) { edges.push({ source: nodes[i].id, target: nodes[j].id }); } }
                const positions = {};
                nodes.forEach((node, i) => { const angle = (i / nodes.length) * 2 * Math.PI; positions[node.id] = { x: (nodes.length * 15) * Math.cos(angle), y: (nodes.length * 15) * Math.sin(angle) }; });
                const edge_x = []; const edge_y = [];
                edges.forEach(edge => { edge_x.push(positions[edge.source].x, positions[edge.target].x, null); edge_y.push(positions[edge.source].y, positions[edge.target].y, null); });
                const node_x = []; const node_y = []; const node_text = []; const node_color = [];
                nodes.forEach(node => { node_x.push(positions[node.id].x); node_y.push(positions[node.id].y); node_text.push(`${node.name}<br>Influence: ${node.influence}`); if (node.effect === '+') node_color.push('green'); else if (node.effect === '-') node_color.push('red'); else node_color.push('gray'); });
                const edgeTrace = { x: edge_x, y: edge_y, mode: 'lines', line: { width: 0.5, color: '#888' }, hoverinfo: 'none' };
                const nodeTrace = { x: node_x, y: node_y, mode: 'markers+text', text: nodes.map(n => n.name), textposition: 'bottom center', hoverinfo: 'text', hovertext: node_text, marker: { size: 20, color: node_color } };
                Plotly.newPlot('conceptNetworkChart', [edgeTrace, nodeTrace], { title: 'Concept Network Visualization', showlegend: false, hovermode: 'closest', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: { showgrid: false, zeroline: false, showticklabels: false }, yaxis: { showgrid: false, zeroline: false, showticklabels: false } }, {responsive: true});
            }

            function renderArchetypesTab(topArchetypes, containerId) {
                const container = $(containerId);
                let contentHtml = `<h3 class="text-2xl font-bold mb-4">🎯 80/20 Analysis - Most Relevant Archetypes</h3><p class="text-white/70 mb-6">This analysis focuses on the top 20% of system archetypes that are most likely driving 80% of the system's behavior.</p><div id="archetypeBarChart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
                topArchetypes.forEach(archetype => { contentHtml += `<div class="metric-card mb-4"><h4 class="text-xl font-bold">🏛️ ${archetype.name}</h4><p class="text-sm font-semibold text-yellow-300 mb-2">Relevance Score: ${archetype.relevance_score}/10</p><p class="text-sm text-white/80 mb-3">${archetype.description}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div><h5 class="font-semibold">Leverage Points:</h5><ul class="list-disc list-inside">${archetype.leverage_points.map(lp => `<li>${lp}</li>`).join('')}</ul></div><div><h5 class="font-semibold">Interventions:</h5><ul class="list-disc list-inside">${archetype.interventions.map(i => `<li>${i}</li>`).join('')}</ul></div></div></div>`; });
                container.innerHTML = contentHtml;
                const chartData = topArchetypes.map(a => ({ Archetype: a.name, 'Relevance Score': a.relevance_score || 0 }));
                Plotly.newPlot('archetypeBarChart', [{ x: chartData.map(d => d.Archetype), y: chartData.map(d => d['Relevance Score']), type: 'bar', marker: { color: chartData.map(d => d['Relevance Score']), colorscale: 'Viridis' } }], { title: 'Archetype Relevance Scores (Top 20%)', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: { automargin: true }, yaxis: { title: 'Relevance Score' } }, {responsive: true});
            }

            function renderLeveragePointsTab(topLeveragePoints, containerId) {
                const container = $(containerId);
                let contentHtml = `<h3 class="text-2xl font-bold mb-4">⚡ 80/20 Analysis - Top Leverage Points</h3><p class="text-white/70 mb-6">These are the top 20% of concepts where small changes can lead to the largest (80%) improvements in the system.</p><div id="leverageBarChart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
                topLeveragePoints.forEach(point => { let priorityClass = ''; if (point.impact === 'High' && point.score >= 8) priorityClass = 'critical'; else if (point.score >= 6) priorityClass = 'high'; contentHtml += `<div class="metric-card ${priorityClass} mb-4"><h4 class="text-xl font-bold">${point.concept}</h4><p class="text-sm font-semibold text-yellow-300 mb-2">Leverage Score: ${point.score}/10 | Expected Impact: ${point.impact}</p><p class="text-sm text-white/80 mb-3"><strong>Reasoning:</strong> ${point.reasoning}</p><div><h5 class="font-semibold text-sm">Recommended Actions:</h5><ul class="list-disc list-inside text-sm">${point.actions.map(a => `<li>${a}</li>`).join('')}</ul></div></div>`; });
                container.innerHTML = contentHtml;
                const chartData = topLeveragePoints.map(p => ({ Concept: p.concept, 'Leverage Score': p.score || 0, Impact: p.impact }));
                Plotly.newPlot('leverageBarChart', [{ x: chartData.map(d => d.Concept), y: chartData.map(d => d['Leverage Score']), type: 'bar', marker: { color: chartData.map(d => { if(d.Impact === 'High') return '#2E8B57'; if(d.Impact === 'Medium') return '#FF8C00'; return '#DC143C'; }) } }], { title: 'Leverage Point Scores (Top 20%)', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: { automargin: true }, yaxis: { title: 'Leverage Score' } }, {responsive: true});
            }
            // =========================================================================
            // ===== END OF ANALYSIS LOGIC & RENDERING                            =====
            // =========================================================================

            function handleWebSocketMessage(data) {
                const container = pendingAnalysisRequests.get(parseInt(data.messageId));
                if (!container) return;

                if (data.error) {
                    container.innerHTML = `<div class="p-4 text-center text-red-400">Workflow error: ${data.error}</div>`;
                    pendingAnalysisRequests.delete(parseInt(data.messageId));
                    setLoading('generate', false);
                    return;
                }

                if (data.progress && !data.result && data.templateId !== 'pareto-fishbone') {
                    container.innerHTML = `
                    <div class="text-center text-white/70 p-4">
                        <div class="typing-indicator mb-4">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                        <p class="mb-2">🔄 ${data.progress}</p>
                        <p class="text-sm text-white/50">Analysis in progress...</p>
                    </div>`;
                    return;
                }
                
                // Handle complex data for pareto-fishbone
                if (data.templateId === 'pareto-fishbone' && data.fishbone && data.pareto) {
                    container.innerHTML = ''; // Clear loading
                    const fishboneData = data.fishbone;
                    const paretoData = data.pareto;
                    
                    // Create Tab Interface
                    const tabNav = document.createElement('div');
                    tabNav.className = 'flex border-b border-white/20 -mx-10 px-6';
                    tabNav.innerHTML = `
                        <button class="analysis-tab-btn active" data-tab="pareto">📊 Pareto Chart</button>
                        <button class="analysis-tab-btn" data-tab="fishbone">🐟 Fishbone Diagram</button>
                        <button class="analysis-tab-btn" data-tab="details">📋 Analysis Details</button>
                        <button class="analysis-tab-btn" data-tab="plan">🎯 Action Plan</button>
                    `;
                    container.appendChild(tabNav);
                    
                    const tabContent = document.createElement('div');
                    container.appendChild(tabContent);

                    // Create Tab Panels
                    tabContent.innerHTML = `
                        <div id="paretoPanel" class="analysis-tab-panel active"></div>
                        <div id="fishbonePanel" class="analysis-tab-panel"></div>
                        <div id="detailsPanel" class="analysis-tab-panel"></div>
                        <div id="planPanel" class="analysis-tab-panel"></div>
                    `;

                    // Populate Pareto Tab
                    const paretoPanel = $('paretoPanel');
                    const paretoChartDiv = document.createElement('div');
                    paretoChartDiv.id = 'paretoChartContainer';
                    paretoChartDiv.className = 'plotly-chart';
                    paretoPanel.appendChild(paretoChartDiv);
                    createParetoChartJS(paretoData, 'paretoChartContainer');

                    // Populate Fishbone Tab
                    const fishbonePanel = $('fishbonePanel');
                    if(data.fishbone_image) {
                        fishbonePanel.innerHTML = `<img id="fishbone_img" src="data:image/png;base64,${data.fishbone_image}" class="w-full h-auto rounded-lg" alt="Fishbone Diagram">`;
                    } else {
                        fishbonePanel.innerHTML = `<p class="text-white/70">Fishbone image not available.</p>`;
                    }

                    // Populate Details Tab
                    const detailsPanel = $('detailsPanel');
                    let detailsHtml = `<h3 class="text-2xl font-bold mb-4">Analysis Summary</h3>`;
                    if(paretoData.analysis_summary) {
                        detailsHtml += `<div class="p-4 rounded-lg bg-white/5 mb-6 text-white/80 italic">${paretoData.analysis_summary}</div>`;
                    }
                     detailsHtml += `<h4 class="text-xl font-semibold mb-3">Category Breakdown</h4>`;
                    for(const [category, sub_causes] of Object.entries(fishboneData)) {
                        detailsHtml += `<details class="bg-white/5 p-3 rounded-lg mb-2"><summary class="cursor-pointer font-semibold">${category} (${sub_causes.length} causes)</summary><ul class="mt-2 pl-4">`;
                        sub_causes.forEach(cause => {
                            const isVital = (paretoData.vital_few || []).some(item => cause.toLowerCase() === item.cause.toLowerCase());
                            detailsHtml += `<li class="mb-1">${isVital ? '🔥' : '📝'} ${cause}</li>`;
                        });
                        detailsHtml += `</ul></details>`;
                    }
                    detailsPanel.innerHTML = detailsHtml;

                    // Populate Action Plan Tab
                    const planPanel = $('planPanel');
                    let planHtml = `<h3 class="text-2xl font-bold mb-4">Recommended Action Plan</h3>
                                    <div class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6">💡 <strong>80/20 Rule:</strong> Focus 80% of your resources on the 'Vital Few' causes for maximum impact!</div>
                                    <h4 class="text-xl font-semibold mb-3 border-b border-red-500/50 pb-2 text-red-300">🔥 IMMEDIATE FOCUS (Vital Few)</h4>`;
                    (paretoData.vital_few || []).forEach(cause => {
                        planHtml += `<div class="mb-4">
                                        <p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p>
                                        <p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> HIGH ⚡</p>
                                     </div>`;
                    });
                    planHtml += `<h4 class="text-xl font-semibold mt-8 mb-3 border-b border-white/20 pb-2">📋 SECONDARY ACTIONS (Useful Many)</h4>`;
                    (paretoData.useful_many || []).forEach(cause => {
                         planHtml += `<div class="mb-4">
                                        <p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p>
                                        <p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> Medium/Low</p>
                                     </div>`;
                    });
                    planPanel.innerHTML = planHtml;
                    
                    analysisCache[currentTemplateId] = container.innerHTML;

                    // Add Tab Switching Logic
                    tabNav.addEventListener('click', e => {
                        if(e.target.tagName === 'BUTTON') {
                            tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                            tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                            
                            e.target.classList.add('active');
                            const targetPanelId = e.target.dataset.tab + 'Panel';
                            const targetPanel = $(targetPanelId);
                            targetPanel.classList.add('active');
                            const chart = targetPanel.querySelector('.plotly-chart');
                            if (chart) Plotly.Plots.resize(chart);
                        }
                    });


                } else if (data.result) { // Handle simple text result for other templates
                    container.innerHTML = `<div id="analysisContent" class="whitespace-pre-wrap">${data.result}</div>`;
                    analysisCache[currentTemplateId] = container.innerHTML;
                }

                const analysisActionsEl = $('analysisActions');
                if(analysisActionsEl) analysisActionsEl.classList.remove('hidden');
                
                pendingAnalysisRequests.delete(parseInt(data.messageId));
                setLoading('generate', false);
            }

            // --- Auth Logic using Supabase ---
            async function handleLogin() {
                const email = $('loginEmail').value.trim();
                const password = $('loginPassword').value;
                const loginMessageEl = $('loginMessage');

                if (!email || !password) {
                    showMessage('loginMessage', 'Please fill in all fields', 'error');
                    return;
                }

                setLoading('login', true);
                loginMessageEl.classList.add('hidden');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showMessage('loginMessage', error.message, 'error');
                } else {
                    showMessage('loginMessage', 'Login successful! Redirecting...', 'success');
                    setTimeout(() => navigateTo('home'), 1500);
                }
                setLoading('login', false);
            }

            async function handleRegister() {
                const firstName = $('registerFirstName').value.trim();
                const lastName = $('registerLastName').value.trim();
                const email = $('registerEmail').value.trim();
                const password = $('registerPassword').value;
                const confirmPassword = $('registerConfirmPassword').value;

                if (!firstName || !lastName || !email || !password || !confirmPassword) {
                    showMessage('registerMessage', 'Please fill in all fields', 'error');
                    return;
                }
                if (password !== confirmPassword) {
                    showMessage('registerMessage', 'Passwords do not match', 'error');
                    return;
                }
                if (password.length < 6) {
                    showMessage('registerMessage', 'Password must be at least 6 characters long', 'error');
                    return;
                }

                setLoading('register', true);
                try {
                    const { data, error } = await supabase.functions.invoke('create-user-v3', {
                         body: {
                            email,
                            password,
                            metadata: {
                                first_name: firstName,
                                last_name: lastName
                            }
                        }
                    });

                    if (error || !data?.user) {
                         showMessage('registerMessage', error?.message || 'User creation failed.', 'error');
                         return;
                    }
                    
                    $('registerForm').reset();
                    navigateTo('emailVerification');

                } catch (err) {
                    console.error('Register error:', err);
                    showMessage('registerMessage', 'An error occurred during registration. Please try again.', 'error');
                } finally {
                    setLoading('register', false);
                }
            }

            async function handleLogout() {
                await supabase.auth.signOut();
                navigateTo('login');
            }
            
            // --- UI Helpers ---
            function setLoading(type, isLoading) {
                const btn = $(type + 'Btn');
                if (!btn) return;
                
                const textEl = $(type + 'BtnText');
                const spinner = $(type + 'Spinner');

                btn.disabled = isLoading;
                if (spinner) spinner.classList.toggle('hidden', !isLoading);
                
                if(textEl) {
                    if (isLoading) {
                        // Store original text if it's not already stored
                        if (!btn.dataset.originalText) {
                            btn.dataset.originalText = textEl.textContent;
                        }
                        textEl.textContent = 'Analyzing...';
                    } else {
                        // Restore original text
                        textEl.textContent = btn.dataset.originalText || 'Generate Analysis';
                        // Clear the data attribute after use
                        delete btn.dataset.originalText;
                    }
                }
            }


            function showMessage(id, msg, type) {
                const el = $(id);
                if (!el) return;
                el.textContent = msg;
                el.className = type === 'error' ? 'error-message' : 'success-message';
                if (msg) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
                if (type === 'success' && msg) {
                    setTimeout(() => el.classList.add('hidden'), 4000);
                }
            }

            // --- Three.js Animation Logic ---
            let scene, camera, renderer, group;
            const particlesData = [];
            let positions, colors;
            let particlesGeometry;
            let pointCloud;
            let particlePositions;
            let linesMesh;
            let animationFrameId;

            const NUM_PARTICLES = 1000;
            const AREA_SIZE = 3000;
            const AREA_HALF = AREA_SIZE / 2;
            const MIN_DISTANCE = 200;

            let mouseX = 0, mouseY = 0;

            function createCircleTexture(size, color) {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const context = canvas.getContext('2d');
                const gradient = context.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2);
                gradient.addColorStop(0, color);
                gradient.addColorStop(0.7, color);
                gradient.addColorStop(1, 'rgba(0,0,0,0)');
                context.fillStyle = gradient;
                context.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
                context.fill();
                return new THREE.CanvasTexture(canvas);
            }

            function initThreeJS() {
                const canvas = $('threeJsCanvas');
                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000);
                camera.position.z = 3000;

                scene = new THREE.Scene();
                group = new THREE.Group();
                scene.add(group);

                const particleTexture = createCircleTexture(64, 'rgba(173, 216, 230, 1)');

                const pMaterial = new THREE.PointsMaterial({
                    color: 0xFFFFFF,
                    size: 7,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    sizeAttenuation: false,
                    map: particleTexture
                });

                particlesGeometry = new THREE.BufferGeometry();
                particlePositions = new Float32Array(NUM_PARTICLES * 3);

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const x = Math.random() * AREA_SIZE - AREA_HALF;
                    const y = Math.random() * AREA_SIZE - AREA_HALF;
                    const z = Math.random() * AREA_SIZE - AREA_HALF;

                    particlePositions[i * 3] = x;
                    particlePositions[i * 3 + 1] = y;
                    particlePositions[i * 3 + 2] = z;

                    particlesData.push({
                        velocity: new THREE.Vector3(
                            (Math.random() - 0.5) * 0.5,
                            (Math.random() - 0.5) * 0.5,
                            (Math.random() - 0.5) * 0.5
                        ),
                        numConnections: 0
                    });
                }

                particlesGeometry.setDrawRange(0, NUM_PARTICLES);
                particlesGeometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3).setUsage(THREE.DynamicDrawUsage));

                pointCloud = new THREE.Points(particlesGeometry, pMaterial);
                group.add(pointCloud);

                const lineGeometry = new THREE.BufferGeometry();
                positions = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);
                colors = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);

                lineGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3).setUsage(THREE.DynamicDrawUsage));
                lineGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3).setUsage(THREE.DynamicDrawUsage));
                lineGeometry.computeBoundingSphere();
                lineGeometry.setDrawRange(0, 0);

                const lineMaterial = new THREE.LineBasicMaterial({
                    vertexColors: true,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    opacity: 0.4
                });

                linesMesh = new THREE.LineSegments(lineGeometry, lineMaterial);
                group.add(linesMesh);

                renderer = new THREE.WebGLRenderer({
                    canvas: canvas,
                    antialias: true,
                    alpha: true
                });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                
                startAnimationLoop();

                window.addEventListener('resize', onWindowResize);
                window.addEventListener('mousemove', onDocumentMouseMove);
            }

            function startAnimationLoop() {
                if(animationFrameId) cancelAnimationFrame(animationFrameId);

                function loop() {
                    animateThreeJS();
                    animationFrameId = requestAnimationFrame(loop);
                }
                loop();
            }

            function onDocumentMouseMove(event) {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            }

             function animateThreeJS() {
                let vertexpos = 0;
                let colorpos = 0;
                let numConnected = 0;

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    particlesData[i].numConnections = 0;
                }

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const particleData = particlesData[i];
                    particlePositions[i * 3] += particleData.velocity.x;
                    particlePositions[i * 3 + 1] += particleData.velocity.y;
                    particlePositions[i * 3 + 2] += particleData.velocity.z;

                    if (particlePositions[i * 3 + 1] < -AREA_HALF || particlePositions[i * 3 + 1] > AREA_HALF)
                        particleData.velocity.y = -particleData.velocity.y;
                    if (particlePositions[i * 3] < -AREA_HALF || particlePositions[i * 3] > AREA_HALF)
                        particleData.velocity.x = -particleData.velocity.x;
                    if (particlePositions[i * 3 + 2] < -AREA_HALF || particlePositions[i * 3 + 2] > AREA_HALF)
                        particleData.velocity.z = -particleData.velocity.z;

                    for (let j = i + 1; j < NUM_PARTICLES; j++) {
                        const dx = particlePositions[i * 3] - particlePositions[j * 3];
                        const dy = particlePositions[i * 3 + 1] - particlePositions[j * 3 + 1];
                        const dz = particlePositions[i * 3 + 2] - particlePositions[j * 3 + 2];
                        const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

                        if (dist < MIN_DISTANCE) {
                            const alpha = 1.0 - dist / MIN_DISTANCE;
                            positions[vertexpos++] = particlePositions[i * 3];
                            positions[vertexpos++] = particlePositions[i * 3 + 1];
                            positions[vertexpos++] = particlePositions[i * 3 + 2];
                            positions[vertexpos++] = particlePositions[j * 3];
                            positions[vertexpos++] = particlePositions[j * 3 + 1];
                            positions[vertexpos++] = particlePositions[j * 3 + 2];

                            const lineColor = new THREE.Color(0xADD8E6);
                            colors[colorpos++] = lineColor.r * alpha;
                            colors[colorpos++] = lineColor.g * alpha;
                            colors[colorpos++] = lineColor.b * alpha;
                            colors[colorpos++] = lineColor.r * alpha;
                            colors[colorpos++] = lineColor.g * alpha;
                            colors[colorpos++] = lineColor.b * alpha;
                            numConnected++;
                        }
                    }
                }

                linesMesh.geometry.setDrawRange(0, numConnected * 2);
                linesMesh.geometry.attributes.position.needsUpdate = true;
                linesMesh.geometry.attributes.color.needsUpdate = true;
                pointCloud.geometry.attributes.position.needsUpdate = true;

                const rotationSpeed = 0.03;
                group.rotation.y += (mouseX * 0.05 - group.rotation.y) * rotationSpeed;
                group.rotation.x += (mouseY * 0.05 - group.rotation.x) * rotationSpeed;
                group.rotation.y += 0.0001;
                group.rotation.x += 0.00005;

                renderer.render(scene, camera);
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            // --- AI Analysis Examples Carousel Logic ---
            let currentExampleIndex = 0;
            const analysisExamples = document.querySelectorAll('.analysis-example-item');
            const prevExampleBtn = $('prevExampleBtn');
            const nextExampleBtn = $('nextExampleBtn');
            const exampleCounter = $('exampleCounter');

            function showAnalysisExample(index) {
                analysisExamples.forEach((item, i) => {
                    item.classList.toggle('hidden', i !== index);
                });
                prevExampleBtn.disabled = index === 0;
                nextExampleBtn.disabled = index === analysisExamples.length - 1;
                exampleCounter.textContent = `${index + 1} of ${analysisExamples.length}`;
            }

            if (prevExampleBtn) {
                prevExampleBtn.addEventListener('click', () => {
                    if (currentExampleIndex > 0) {
                        currentExampleIndex--;
                        showAnalysisExample(currentExampleIndex);
                    }
                });
            }
            if (nextExampleBtn) {
                nextExampleBtn.addEventListener('click', () => {
                    if (currentExampleIndex < analysisExamples.length - 1) {
                        currentExampleIndex++;
                        showAnalysisExample(currentExampleIndex);
                    }
                });
            }
            if (analysisExamples.length > 0) {
                showAnalysisExample(currentExampleIndex);
            }

            // --- Initial Setup ---
            const versionModal = $('versionChoiceModal');
            const selectFreeBtn = $('selectFreeVersion');
            const selectPaidBtn = $('selectPaidVersion');
            const closeModalBtn = $('closeModalBtn');
            
            selectFreeBtn.addEventListener('click', () => {
                currentSelectionLimit = 1;
                proceedFromModal();
            });

            selectPaidBtn.addEventListener('click', () => {
                currentSelectionLimit = 3;
                proceedFromModal();
            });

            closeModalBtn.addEventListener('click', () => {
                versionModal.classList.add('hidden');
            });

            $('loginBtn').addEventListener('click', handleLogin);
            $('registerBtn').addEventListener('click', handleRegister);
            
            if (window.location.hash.includes('access_token')) {
                 navigateTo('home');
            } else {
                 navigateTo('home');
            }
            
            setupHomeTabs();
            attachHomeCardListeners();
            
            initThreeJS();

            // --- Dashboard Widget ---
            (function initDashboardWidget() {
                const PRESENCE_PREFIX = 'sage_presence_';
                const HEARTBEAT_MS = 10000;
                const STALE_MS = 30000;
                const TAB_ID = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '-' + Math.random());

                function heartbeat() {
                    try {
                        localStorage.setItem(PRESENCE_PREFIX + TAB_ID, String(Date.now()));
                    } catch (e) {}
                }

                function cleanupStale() {
                    const now = Date.now();
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i);
                            if (k && k.startsWith(PRESENCE_PREFIX)) {
                                const ts = Number(localStorage.getItem(k) || '0');
                                if (!ts || (now - ts) > STALE_MS) localStorage.removeItem(k);
                            }
                        }
                    } catch (e) {}
                }

                function countOnline() {
                    const now = Date.now();
                    let cnt = 0;
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i);
                            if (k && k.startsWith(PRESENCE_PREFIX)) {
                                const ts = Number(localStorage.getItem(k) || '0');
                                if (ts && (now - ts) <= STALE_MS) cnt++;
                            }
                        }
                    } catch (e) {}
                    return cnt;
                }

                heartbeat();
                const hb = setInterval(() => {
                    heartbeat();
                    cleanupStale();
                }, HEARTBEAT_MS);
                window.addEventListener('beforeunload', () => {
                    try {
                        localStorage.removeItem(PRESENCE_PREFIX + TAB_ID);
                    } catch (e) {};
                    clearInterval(hb);
                });

                function updateDashboard() {
                    const usersEl = document.getElementById('dashUsersOnline');
                    const serverDot = document.getElementById('dashServerDot');
                    const serverText = document.getElementById('dashServerText');
                    const wsStatusEl = document.getElementById('wsStatus');
                    
                    if (usersEl) usersEl.textContent = String(countOnline());

                    let statusText = 'Unknown', statusClass = 'bg-yellow-400';
                    if (wsStatusEl) {
                        const t = wsStatusEl.textContent.trim().toLowerCase();
                        if (t.includes('connected')) {
                            statusText = 'Connected';
                            statusClass = 'bg-green-400';
                        } else if (t.includes('disconnected') || t.includes('failed') || t.includes('error')) {
                            statusText = 'Disconnected';
                            statusClass = 'bg-red-400';
                        } else if (t.includes('connecting')) {
                            statusText = 'Connecting';
                            statusClass = 'bg-yellow-400';
                        }
                    }
                    
                    if (serverText) serverText.textContent = statusText;
                    if (serverDot) serverDot.className = 'inline-block w-3 h-3 rounded-full ' + statusClass;
                }
                setInterval(updateDashboard, 2000);
                updateDashboard();
            })();
    
        });
    </script>

</body>

</html>