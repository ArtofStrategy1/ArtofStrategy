<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>S.A.G.E. - AI Strategy Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Three.js CDN for 3D animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- jsPDF for Save to PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- FileSaver.js for DOCX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Cytoscape.js for Graph Visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <style>
        /* --- Base & Animated Background --- */
        html, body {
            min-height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #667eea, #764ba2, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 18s ease infinite;
            color: #f9fafb;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex-grow: 1;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .page {
            display: none;
        }

        /* Hide all pages by default */
        .page.active {
            animation: fadeIn .5s ease-out;
        }

        /* Specific display rules for active pages */
        #home.active,
        #templates.active,
        #templateDetail.active,
        #examplesPage.active,
        #myProjects.active,
        #adminDashboard.active,
        #frameworks.active,
        #about.active,
        #knowledgeGraph.active,
        #termsOfService.active,
        #privacyPolicy.active {
            display: block;
            /* Content pages */
        }

        #login.active,
        #signup.active,
        #emailVerification.active {
            display: flex;
            /* Centered pages */
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        /* --- Glass & Card Effects --- */
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            transition: all .3s ease;
            text-align: center;
            /* Centered text within feature cards */
        }

        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .template-card,
        .project-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: all .3s ease;
            cursor: pointer;
        }

        .template-card:hover,
        .project-card:hover {
            transform: translateY(-5px);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .project-card-content {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* --- Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: #4f46e5;
            color: #fff;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(220, 38, 38, 0.5);
            color: #fca5a5;
        }

        .btn-danger:hover {
            background: rgba(220, 38, 38, 0.7);
            color: #fff;
        }

        .btn-tertiary {
            background: transparent;
            color: #c7d2fe;
            text-decoration: underline;
        }

        .btn-tertiary:hover {
            color: #fff;
        }

        /* --- Forms & Inputs --- */
        .input-field {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-field:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: #a78bfa;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
        }

        .error-message {
            color: #fca5a5;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(220, 38, 38, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .success-message {
            color: #a7f3d0;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(5, 150, 105, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        /* --- Loading Spinners --- */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 2rem;
        }

        .typing-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #a78bfa;
            animation: typing 1.4s infinite ease-in-out
        }

        .typing-dot:nth-child(1) {
            animation-delay: -.32s
        }

        .typing-dot:nth-child(2) {
            animation-delay: -.16s
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0s
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(.8);
                opacity: .5
            }

            40% {
                transform: scale(1);
                opacity: 1
            }
        }

        /* --- Three.js Canvas Styling --- */
        #threeJsCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            /* Ensure it's behind the gradient background */
            display: block;
            /* Ensure canvas is block-level */
        }

        /* Carousel specific styles */
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 9999px;
            /* Full circle */
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: background 0.3s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .carousel-button:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .carousel-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Increased distance from the edge of the glass-container */
        .carousel-button.left {
            left: -6rem;
        }

        .carousel-button.right {
            right: -6rem;
        }

        /* Adjust for smaller screens if needed */
        @media (max-width: 768px) {
            .carousel-button.left {
                left: 0.5rem;
            }

            .carousel-button.right {
                right: 0.5rem;
            }
        }

        /* Style for the example content within the carousel */
        .analysis-example-item {
            padding: 2.5rem;
            /* Match glass-container padding */
            margin-bottom: 0;
            /* Remove space-y-12 from individual items */
        }

        .analysis-example-item h3 {
            font-size: 1.5rem;
            /* Tailwind text-2xl equivalent */
            font-weight: 700;
            /* Tailwind font-bold equivalent */
            margin-bottom: 0.5rem;
            /* Tailwind mb-2 equivalent */
        }

        .analysis-example-item ul,
        .analysis-example-item ol {
            list-style-position: inside;
            margin-left: 1.25rem;
            /* Indent lists */
            margin-bottom: 1rem;
            /* Space after lists */
        }

        .analysis-example-item li {
            margin-bottom: 0.5rem;
            /* Space between list items */
        }

        /* Explicitly center list items and paragraphs in long descriptions */
        .feature-card .feature-description ul,
        .feature-card .feature-description ol,
        .feature-card .feature-description p {
            text-align: center;
        }

        /* WebSocket connection status indicator */
        .ws-status {
            position: static;
            top: 20px;
            right: 20px;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .ws-status.connected {
            background: rgba(5, 150, 105, 0.8);
            color: #a7f3d0;
        }

        .ws-status.disconnected {
            background: rgba(220, 38, 38, 0.8);
            color: #fca5a5;
        }

        .ws-status.connecting {
            background: rgba(245, 158, 11, 0.8);
            color: #fbbf24;
        }


        /* Glassy Checkboxes */
        .method-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .method-checkbox:checked {
            background: rgba(79, 70, 229, 0.8);
            border-color: rgba(167, 139, 250, 0.9);
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.7);
            transform: scale(1.15);
        }

        .method-checkbox:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.7);
        }
        
        /* --- Custom File Input --- */
        .input-file-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            cursor: pointer;
        }
        .input-file {
            position: absolute;
            font-size: 50px;
            opacity: 0;
            right: 0;
            top: 0;
            cursor: pointer;
        }
        .input-file-label {
            display: block;
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .input-file-label.has-file {
            color: white;
            border-color: #a78bfa;
        }

        /* --- Interactive Hover for Guide & Framework Cards --- */
        #about .glass-container,
        #frameworks .glass-container,
        #termsOfService .glass-container,
        #privacyPolicy .glass-container {
            transition: all 0.3s ease-in-out;
        }

        #about .glass-container:hover,
        #frameworks .glass-container:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Neo4j Visualization Library Styling */
        #graph-container {
			position: relative;
			width: 90%;
			height: 600px; /* Adjust height as needed */
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 1.5rem;	/* The amount of rounding you want to apply */
			overflow: hidden; /* So content inside is also rounded */
			box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
			background-color: rgba(30, 30, 30, 0.8); 	/* Slightly transparent background */
			padding: 1.5rem;
		}

		.graph-inner {
			position: relative;
			width: 100%;
			height: 100%;
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 1.5rem;	/* The amount of rounding you want to apply */
			overflow: hidden; /* So content inside is also rounded */
			margin: 0
        }

        /* Footer Styling */
        footer {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

    </style>
</head>

<body>
    <div class="main-content">
        <!-- Three.js Canvas for Animated Background -->
        <canvas id="threeJsCanvas"></canvas>
        <div id="wsStatus" class="ws-status disconnected">Disconnected</div>

        <!-- ========================================================= -->
        <!-- NAVIGATION BAR                                            -->
        <!-- ========================================================= -->
        <nav class="bg-black/10 backdrop-blur-sm p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <a href="#" class="text-2xl font-bold text-white nav-link" data-page="home">S.A.G.E.</a>
                <div>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link"
                        data-page="home">Home</a>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link"
                        data-page="knowledgeGraph">Knowledge Graph</a>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link hidden"
                        data-page="myProjects">My Projects</a>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link hidden"
                        data-page="templates">Templates</a>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link"
                        data-page="login">Login</a>
                </div>
            </div>
        </nav>

        <!-- ========================================================= -->
        <!-- VERSION CHOICE MODAL                                      -->
        <!-- ========================================================= -->
        <div id="versionChoiceModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
            <div class="glass-container w-full max-w-lg text-center">
                <h2 class="text-3xl font-bold mb-4">Choose Your Version</h2>
                <p class="text-white/80 mb-8">Select a version to proceed with your analysis.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="selectFreeVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Free Version</h3>
                        <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Basic analysis</li>
                            <li>Select 1 of 8 frameworks</li>
                        </ul>
                    </div>
                    <div id="selectPaidVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Paid Version</h3>
                         <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Comprehensive analysis</li>
                            <li>Select up to 3 of 8 frameworks</li>
                        </ul>
                    </div>
                </div>
                 <button id="closeModalBtn" class="btn btn-secondary mt-8">Cancel</button>
            </div>
        </div>


        <!-- ========================================================= -->
        <!-- HOME PAGE                                                 -->
        <!-- ========================================================= -->
        <div id="home" class="page active container mx-auto px-6 py-16 text-center">
            <h1 class="text-5xl md:text-6xl font-extrabold text-white leading-tight mb-4">Unlock Your Strategic Potential
            </h1>
            <p class="text-lg md:text-xl text-white/80 max-w-3xl mx-auto mb-8">
                Transform your organization with comprehensive strategic planning tools and methodologies designed to drive
                success and innovation.
            </p>
            <div class="flex justify-center space-x-4">
                <button class="btn btn-primary nav-link" data-page="templates">Get Started</button>
                <button class="btn btn-secondary nav-link" data-page="examplesPage">View Analysis</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-20">
                <!-- Vision to Action -->
                <div class="feature-card p-6" data-feature-id="vision">
                    <h3 class="text-2xl font-bold mb-2">Vision</h3>
                    <p class="text-white/70 mb-4 feature-description" data-state="short">We help you craft a clear vision with detailed strategic steps.</p>
                    <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn" data-feature-id="vision">More &rarr;</a>
                </div>
                <div class="feature-card p-6" data-feature-id="mission">
                    <h3 class="text-2xl font-bold mb-2">Mission or Aim</h3>
                    <p class="text-white/70 mb-4 feature-description" data-state="short">Define your organization's core purpose and foundational principles.</p>
                    <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn" data-feature-id="mission">More &rarr;</a>
                </div>
                <div class="feature-card p-6" data-feature-id="goals">
                    <h3 class="text-2xl font-bold mb-2">Goals</h3>
                    <p class="text-white/70 mb-4 feature-description" data-state="short">Set ambitious yet achievable goals that align with your vision.</p>
                    <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn" data-feature-id="goals">More &rarr;</a>
                </div>
                <div class="feature-card p-6" data-feature-id="strategic-initiatives">
                    <h3 class="text-2xl font-bold mb-2">Strategic Initiatives</h3>
                    <p class="text-white/70 mb-4 feature-description" data-state="short">Develop initiatives that translate your vision into actionable plans.</p>
                    <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn" data-feature-id="strategic-initiatives">More &rarr;</a>
                </div>
                <div class="feature-card p-6" data-feature-id="objectives">
                    <h3 class="text-2xl font-bold mb-2">Objectives</h3>
                    <p class="text-white/70 mb-4 feature-description" data-state="short">Break down goals into specific, measurable objectives for tracking.</p>
                    <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn" data-feature-id="objectives">More &rarr;</a>
                </div>
                <div class="feature-card p-6" data-feature-id="actions">
                    <h3 class="text-2xl font-bold mb-2">Actions</h3>
                    <p class="text-white/70 mb-4 feature-description" data-state="short">Define specific actions and tactics to drive achievement.</p>
                    <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn" data-feature-id="actions">More &rarr;</a>
                </div>
                <!-- New Sections -->
                <div class="feature-card p-6" data-feature-id="internal-external-analysis">
                    <h3 class="text-2xl font-bold mb-2">Factor Analysis</h3>
                    <p class="text-white/70 mb-4 feature-description" data-state="short">Analyze internal and external factors to build a robust strategic position.</p>
                    <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn" data-feature-id="internal-external-analysis">More &rarr;</a>
                </div>
                <div class="feature-card p-6" data-feature-id="system-analysis">
                    <h3 class="text-2xl font-bold mb-2">System Analysis</h3>
                    <p class="text-white/70 mb-4 feature-description" data-state="short">Understand complex interconnections to identify high-leverage intervention points.</p>
                    <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn" data-feature-id="system-analysis">More &rarr;</a>
                </div>
                 <div class="feature-card p-6" data-feature-id="problem-solving">
                    <h3 class="text-2xl font-bold mb-2">Problem Solving</h3>
                    <p class="text-white/70 mb-4 feature-description" data-state="short">Apply structured frameworks to diagnose root causes and prioritize solutions.</p>
                    <a href="#" class="font-semibold text-indigo-300 hover:text-indigo-200 toggle-feature-btn" data-feature-id="problem-solving">More &rarr;</a>
                </div>
            </div>
        </div>
        
        <!-- ========================================================= -->
        <!-- ABOUT PAGE                                                -->
        <!-- ========================================================= -->
        <div id="about" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">How to Use S.A.G.E.</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">A Step-by-Step Guide to Unleashing Your Strategic Potential</p>
            <div class="max-w-4xl mx-auto space-y-8">
                <!-- Step 1 -->
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 1:</span> Get Started (Login/Sign Up)</h3>
                    <p class="text-white/80">To unlock the full power of S.A.G.E., including saving your projects and using premium templates, you'll need an account. Click the "Login" button in the navigation bar. If you're new, you can create an account in just a few clicks.</p>
                </div>
                <!-- Step 2 -->
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 2:</span> Choose Your Template</h3>
                    <p class="text-white/80">Once logged in, navigate to the "Templates" page. Here you'll find a variety of professionally designed strategic frameworks. Select the template that best fits your objective, whether it's a SWOT Analysis, a Market Entry Strategy, or a custom-built plan.</p>
                </div>
                <!-- Step 3 -->
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 3:</span> Select Your Version</h3>
                    <p class="text-white/80">After choosing a template, a modal will appear. You can select the "Free Version" for a basic analysis using one framework, or the "Paid Version" to conduct a more comprehensive analysis with up to three different frameworks.</p>
                </div>
                <!-- Step 4 -->
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 4:</span> Provide Context & Select Frameworks</h3>
                    <p class="text-white/80">On the template detail page, fill in the required information, such as your company name and upload your company documents. This context is crucial for the AI to generate a relevant analysis. Below the inputs, select your desired analytical framework(s) and report sections.</p>
                </div>
                <!-- Step 5 -->
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 5:</span> Generate & Review Your Analysis</h3>
                    <p class="text-white/80">Click the "Generate Analysis" button. S.A.G.E.'s AI will process your inputs and selected frameworks, which may take a few minutes. The complete, structured analysis will appear in the results panel on the right side of the screen.</p>
                </div>
                <!-- Step 6 -->
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 6:</span> Save & Export Your Work</h3>
                    <p class="text-white/80">Once your analysis is generated, action buttons will appear below the result. You can "Save Project" to your personal dashboard ("My Projects"), or export the analysis as a PDF or DOCX file for easy sharing and integration into your reports.</p>
                </div>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- FRAMEWORKS PAGE                                           -->
        <!-- ========================================================= -->
        <div id="frameworks" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">Our Methodologies</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">S.A.G.E. integrates a diverse set of proven strategic frameworks to provide deep, multi-faceted insights. Hover over a card to learn more.</p>
            <div id="frameworksGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Framework cards will be dynamically inserted here by JavaScript -->
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- KNOWLEDGE GRAPH VISUALIZATION PAGE                        -->
        <!-- ========================================================= -->
        <div id="knowledgeGraph class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">Knowledge Graph Visualization</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Explore the relationships between entities in an interactive knowledge graph.</p>
            <div id="graph-container">
                <div class="graph-inner"></div>
            </div>
        </div>


        <!-- ========================================================= -->
        <!-- LOGIN PAGE                                                -->
        <!-- ========================================================= -->
        <div id="login" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Sign In</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="loginEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="loginEmail" class="input-field" placeholder="Enter your email" required>
                        </div>
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="loginPassword" class="input-field" placeholder="Enter your password"
                                required>
                        </div>
                        <button id="loginBtn" class="btn btn-primary w-full">
                            <span id="loginBtnText">Sign In</span>
                            <span id="loginSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="loginMessage" class="hidden"></div>
                    </div>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Don't have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="signup">Create Account</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- SIGNUP PAGE                                               -->
        <!-- ========================================================= -->
        <div id="signup" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Create Account</h2>
                    <form id="registerForm" class="space-y-4">
                        <div>
                            <label for="registerFirstName" class="block text-sm font-medium text-gray-200 mb-2">First
                                Name</label>
                            <input type="text" id="registerFirstName" class="input-field"
                                placeholder="Enter your First Name" required>
                        </div>
                        <div>
                            <label for="registerLastName" class="block text-sm font-medium text-gray-200 mb-2">Last
                                Name</label>
                            <input type="text" id="registerLastName" class="input-field" placeholder="Enter your Last Name"
                                required>
                        </div>
                        <div>
                            <label for="registerEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="registerEmail" class="input-field" placeholder="Enter your email"
                                required>
                        </div>
                        <div>
                            <label for="registerPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="registerPassword" class="input-field" placeholder="Create a password"
                                required>
                        </div>
                        <div>
                            <label for="registerConfirmPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Confirm Password</label>
                            <input type="password" id="registerConfirmPassword" class="input-field"
                                placeholder="Confirm your password" required>
                        </div>
                        <button type="button" id="registerBtn" class="btn btn-primary w-full">
                            <span id="registerBtnText">Create Account</span>
                            <span id="registerSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="registerMessage" class="hidden"></div>
                    </form>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Already have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="login">Sign In</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================================================= -->
        <!-- EMAIL VERIFICATION PAGE                                   -->
        <!-- ========================================================= -->
        <div id="emailVerification" class="page flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container text-center">
                    <h2 class="text-3xl font-bold mb-6 text-white">Check Your Email</h2>
                    <p class="text-white/80 mb-6">Thank you for registering! We've sent a verification link to your email address. Please check your inbox and click the link to complete your registration.</p>
                    <p class="text-white/60 text-sm mb-6">Don't forget to check your spam folder.</p>
                    <div class="text-center">
                        <button class="btn-tertiary nav-link" data-page="login">Return to Login</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- ========================================================= -->
        <!-- TEMPLATES LIST PAGE                                       -->
        <!-- ========================================================= -->
        <div id="templates" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">Strategy Templates</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Select a professional analysis template to
                begin. Our AI will guide you through a structured framework to generate powerful strategic insights.</p>
            <div id="templatesList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Template cards will be dynamically inserted here by JavaScript -->
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- TEMPLATE DETAIL PAGE (Fixed: Checkboxes always visible)   -->
        <!-- ========================================================= -->
        <div id="templateDetail" class="page container mx-auto px-6 py-16">
            <button class="btn btn-secondary mb-8 nav-link" data-page="templates">&larr; Back to Templates</button>
            <div class="grid lg:grid-cols-2 gap-12">

                <!-- Left side: Form -->
                <div>
                    <h1 id="templateTitle" class="text-4xl font-bold mb-4">Template Title</h1>
                    <p id="templateDescription" class="text-white/80 mb-8">Template description goes here.</p>

                    <div class="glass-container p-6">
                        <div id="templateFormFields" class="space-y-4"></div>
                        <div id="methodsConsideredContainer" class="glass-container mt-8">
                            <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Frameworks</h4>
                            <p id="selectionCounter" class="text-white/70 text-center mb-4">Selected: 0 / 3</p>
                            <ul id="frameworkList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                <li class="flex items-center mb-2">
                                    <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                    <span>Reframing Thinking</span>
                                </li>
                                <li class="flex items-center mb-2">
                                    <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                    <span>Delphi Method</span>
                                </li>
                                <li class="flex items-center mb-2">
                                    <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                    <span>Blue Ocean Strategy</span>
                                </li>
                                <li class="flex items-center mb-2">
                                    <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                    <span>Design Thinking</span>
                                </li>
                                <li class="flex items-center mb-2">
                                    <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                    <span>Thinking Hats</span>
                                </li>
                                <li class="flex items-center mb-2">
                                    <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                    <span>Business Model Canvas</span>
                                </li>
                                <li class="flex items-center mb-2">
                                    <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                    <span>SCAMPER</span>
                                </li>
                                <li class="flex items-center mb-2">
                                    <input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500">
                                    <span>TRIZ (Theory of Inventive Problem Solving)</span>
                                </li>
                            </ul>
                        </div>

                        <div id="analysisSectionsContainer" class="glass-container mt-8">
                            <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Analysis Sections</h4>
                            <p class="text-white/70 text-center mb-4">Choose the components for your report.</p>
                            <ul id="analysisList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Introduction</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Overview of business</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>process overview</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>mission statement</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision analysis</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision statement 2</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 1</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 2</span></li>
                                <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 3</span></li>
                            </ul>
                        </div>

                        <button id="generateBtn" class="btn btn-primary w-full mt-4">
                            <span id="generateBtnText">Generate Analysis</span>
                            <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                    </div>
                </div>

                <!-- Right side: Result and actions -->
                <div>
                    <h2 class="text-3xl font-bold mb-4">Generated Analysis</h2>
                    <div id="analysisResult" class="glass-container min-h-[300px] whitespace-pre-wrap overflow-x-auto">
                        <div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>
                    </div>
                    <!-- Action buttons will appear here -->
                    <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                        <button id="saveProjectBtn" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-save mr-2" viewBox="0 0 16 16">
                                <path
                                    d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v4.5h2a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 5.5 6.5h2V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1z" />
                            </svg>
                            Save Project
                        </button>
                        <button id="savePdfBtn" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-file-earmark-pdf mr-2" viewBox="0 0 16 16">
                                <path
                                    d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                                <path
                                    d="M4.603 14.087a.8.8 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.7 7.7 0 0 1 1.482-.645 20 20 0 0 0 1.062-2.227 7.3 7.3 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.658-.897.38-.23.84-.287 1.287-.138.448.157.826.519 1.05.979.24.49.25.99.06 1.452a8 8 0 0 1-.647 1.547c-.38.51-.84.954-1.35 1.258a11 11 0 0 1-.97 1.24c-.58.684-1.25.918-1.921.983a1.2 1.2 0 0 1-.51.06z" />
                            </svg>
                            Save as PDF
                        </button>
                        <button id="saveDocxBtn" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-file-earmark-word mr-2" viewBox="0 0 16 16">
                                <path
                                    d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                                <path
                                    d="M4.225 11.94H5.5v-1.542h.053l.85 1.542h1.325l.86-1.542h.053v1.542h1.275V8.5h-1.9v1.238h-.04l-.82-1.238H6.55l-.818 1.238h-.04V8.5H3.85v3.44z" />
                            </svg>
                            Save as DOCX
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- ========================================================= -->
        <!-- MY PROJECTS PAGE                                          -->
        <!-- ========================================================= -->
        <div id="myProjects" class="page container mx-auto px-6 py-16">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h1 class="text-4xl font-bold mb-2">My Projects</h1>
                    <p class="text-lg text-white/80">View, edit, or delete your saved strategic analyses.</p>
                </div>
                <button class="btn btn-primary nav-link" data-page="templates">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-plus-lg mr-2" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2" />
                    </svg>
                    New Analysis
                </button>
            </div>
            <div id="projectsList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Project cards will be dynamically inserted here -->
            </div>
            <div id="noProjectsMessage" class="hidden text-center glass-container py-12">
                <h3 class="text-2xl font-bold mb-2">No Projects Yet</h3>
                <p class="text-white/70 mb-6">You haven't saved any analyses. Get started by selecting a template.</p>
                <button class="btn btn-primary nav-link" data-page="templates">Create First Analysis</button>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- ADMIN DASHBOARD PAGE (Restored)                           -->
        <!-- ========================================================= -->
        <div id="adminDashboard" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">Admin Dashboard</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Live analytics for S.A.G.E. (visible to
                everyone for now).</p>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Users Online</h3>
                    <p id="dashUsersOnline" class="text-4xl font-bold">—</p>
                    <p class="text-white/60 text-sm mt-2">Approximate active visitors (tab-based).</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Queries (this browser)</h3>
                    <p id="dashQueryCount" class="text-4xl font-bold">0</p>
                    <p class="text-white/60 text-sm mt-2">Increments each time you click "Generate Analysis".</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Server Status</h3>
                    <div class="flex items-center gap-3">
                        <span id="dashServerDot" class="inline-block w-3 h-3 rounded-full bg-yellow-400"></span>
                        <span id="dashServerText">Checking…</span>
                    </div>
                    <p class="text-white/60 text-sm mt-2">Reflects WebSocket connection state.</p>
                </div>
            </div>
            <div class="glass-container mt-8">
                <h3 class="text-xl font-semibold mb-2">Details</h3>
                <ul class="list-disc ml-6 space-y-1 text-white/90">
                    <li><strong>WebSocket:</strong> <span id="dashWsDetail">—</span></li>
                    <li><strong>Last Update:</strong> <span id="dashUpdatedAt">—</span></li>
                </ul>
            </div>
        </div>


        <!-- ========================================================= -->
        <!-- AI EXAMPLES PAGE (NEW)                                    -->
        <!-- ========================================================= -->
        <div id="examplesPage" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">AI Analysis Examples</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">See how S.A.G.E. can transform complex data
                into actionable strategic insights with these example outputs.</p>

            <div id="analysisCarousel" class="relative max-w-4xl mx-auto glass-container p-0">
                <!-- Example 1: SWOT Analysis -->
                <div class="analysis-example-item">
                    <h2 class="text-3xl font-bold mb-4">Example: SWOT Analysis for "GlobalTech Solutions"</h2>
                    <div class="text-white/70">
                        <h3>STRENGTHS:</h3>
                        <ul>
                            <li><strong>Strong R&D Department:</strong> GlobalTech consistently innovates, holding numerous
                                patents in AI and quantum computing.</li>
                            <li><strong>Global Presence:</strong> Established offices and client base across North America,
                                Europe, and Asia.</li>
                            <li><strong>Talented Workforce:</strong> Highly skilled engineers and data scientists, fostering
                                a culture of excellence.</li>
                        </ul>

                        <h3>WEAKNESSES:</h3>
                        <ul>
                            <li><strong>High Operating Costs:</strong> Extensive R&D and global infrastructure lead to
                                significant overheads.</li>
                            <li><strong>Limited Marketing Reach:</strong> Reliance on word-of-mouth and niche industry
                                events, missing broader market segments.</li>
                            <li><strong>Bureaucratic Processes:</strong> Slow decision-making due to multi-layered approval
                                systems.</li>
                        </ul>

                        <h3>OPPORTUNITIES:</h3>
                        <ul>
                            <li><strong>Emerging Markets:</strong> Untapped potential in developing economies for AI-driven
                                solutions.</li>
                            <li><strong>Strategic Partnerships:</strong> Collaboration with hardware manufacturers to integrate
                                    AI software.</li>
                            <li><strong>Government Grants:</strong> Increased funding for AI research and development
                                initiatives.</li>
                        </ul>

                        <h3>THREATS:</h3>
                        <ul>
                            <li><strong>Intense Competition:</strong> Rapidly evolving tech landscape with new startups and
                                established giants.</li>
                            <li><strong>Talent Drain:</strong> High demand for skilled AI professionals leading to
                                competitive recruitment.</li>
                            <li><strong>Regulatory Changes:</strong> Evolving data privacy and AI ethics regulations
                                impacting product development.</li>
                        </ul>

                        <h3>Strategic Recommendations:</h3>
                        <ol>
                            <li><strong>Optimize Cost Structure:</strong> Implement agile methodologies to reduce R&D cycle
                                times and explore automation in operational processes.</li>
                            <li><strong>Expand Marketing Channels:</strong> Invest in digital marketing and content strategy
                                to reach a wider audience and enhance brand visibility.</li>
                            <li><strong>Forge Key Alliances:</strong> Actively pursue partnerships with complementary
                                technology providers to expand market reach and product offerings.</li>
                        </ol>
                    </div>
                </div>

                <!-- Example 2: Market Entry Strategy for "EcoCycle Innovations" -->
                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Market Entry Strategy for "EcoCycle Innovations" into
                        Southeast Asia</h2>
                    <div class="text-white/70">
                        <h3>MARKET ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Market Size & Growth:</strong> Southeast Asia's recycling and waste management
                                market is projected to grow at a CAGR of 8% over the next five years, driven by increasing
                                environmental awareness and government initiatives.</li>
                            <li><strong>Customer Segments:</strong> Key segments include industrial waste generators,
                                municipal waste facilities, and commercial enterprises seeking sustainable solutions.</li>
                            <li><strong>Market Maturity:</strong> Varies by country; Singapore and Malaysia are more mature,
                                while Vietnam and Indonesia are emerging.</li>
                        </ul>

                        <h3>COMPETITIVE LANDSCAPE:</h3>
                        <ul>
                            <li><strong>Key Players:</strong> Dominated by local players with strong government ties and a
                                few international waste management giants.</li>
                            <li><strong>Competitive Advantages:</strong> Local players often have lower operational costs
                                and established networks. EcoCycle's advanced waste-to-energy technology offers a unique
                                value proposition.</li>
                        </ul>

                        <h3>ENTRY STRATEGY OPTIONS:</h3>
                        <ol>
                            <li><strong>Joint Venture (JV) with Local Partner:</strong> Recommended approach. A JV allows
                                EcoCycle to leverage local expertise, navigate regulatory complexities, and gain immediate
                                market access.
                                <ul>
                                    <li><strong>Pros:</strong> Reduced risk, faster market penetration, access to local
                                        networks.</li>
                                    <li><strong>Cons:</strong> Potential for cultural clashes, profit sharing.</li>
                                </ul>
                            </li>
                            <li><strong>Greenfield Investment:</strong> Building new facilities.
                                <ul>
                                    <li><strong>Pros:</strong> Full control, tailor-made operations.</li>
                                    <li><strong>Cons:</strong> High capital investment, long lead times, significant
                                        regulatory hurdles.</li>
                                </ul>
                            </li>
                        </ol>

                        <h3>Implementation Roadmap:</h3>
                        <ul>
                            <li><strong>Phase 1 (Months 1-6):</strong> Partner identification and due diligence. Focus on
                                countries with favorable regulatory environments (e.g., Malaysia, Thailand).</li>
                            <li><strong>Phase 2 (Months 7-18):</strong> JV formation and pilot project initiation. Secure
                                initial contracts with industrial clients.</li>
                            <li><strong>Phase 3 (Months 19-36):</strong> Scale operations, expand service offerings, and explore
                                    opportunities in other SEA markets.</li>
                        </ul>
                    </div>
                </div>

                <!-- Example 3: Digital Transformation Roadmap for "RetailX" -->
                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Digital Transformation Roadmap for "RetailX"</h2>
                    <div class="text-white/70">
                        <h3>VISION & OBJECTIVES:</h3>
                        <ul>
                            <li><strong>Vision:</strong> To become a leading omnichannel retailer, leveraging digital
                                technologies to enhance customer experience, optimize operations, and drive sustainable
                                growth.</li>
                            <li><strong>Objectives:</strong> Increase online sales by 30% within 2 years, reduce operational
                                costs by 15% through automation, and improve customer satisfaction scores by 20%.</li>
                        </ul>

                        <h3>CURRENT STATE ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Digital Capabilities:</strong> Fragmented legacy systems, limited e-commerce
                                capabilities, manual inventory management.</li>
                            <li><strong>Pain Points:</strong> Inconsistent customer experience across channels, inefficient
                                supply chain, lack of real-time data for decision-making.</li>
                        </ul>

                        <h3>KEY PILLARS OF TRANSFORMATION:</h3>
                        <ol>
                            <li><strong>Customer Experience:</strong> Unify online and offline channels, personalize
                                customer journeys.</li>
                            <li><strong>Operational Efficiency:</strong> Automate back-office processes, optimize supply
                                chain.</li>
                            <li><strong>Data & Analytics:</strong> Implement robust data infrastructure, leverage AI for
                                insights.</li>
                            <li><strong>Culture & Talent:</strong> Foster digital-first mindset, upskill workforce.</li>
                        </ol>

                        <h3>INITIATIVES & TECHNOLOGIES:</h3>
                        <ul>
                            <li><strong>Customer Experience:</strong> CRM implementation (Salesforce), E-commerce platform
                                upgrade (Shopify Plus), AI-powered chatbots.</li>
                            <li><strong>Operational Efficiency:</strong> ERP system integration (SAP), Warehouse Management
                                System (WMS), Robotic Process Automation (RPA) for routine tasks.</li>
                            <li><strong>Data & Analytics:</strong> Data Lake/Warehouse (Snowflake), Business Intelligence
                                tools (Tableau), Predictive Analytics.</li>
                            <li><strong>Culture & Talent:** Digital literacy training, change management programs.</li>
                        </ul>

                        <h3>PHASED IMPLEMENTATION PLAN:</h3>
                        <ul>
                            <li><strong>Short-term (0-6 months):</strong> CRM implementation, basic e-commerce upgrade,
                                pilot RPA for finance.</li>
                            <li><strong>Mid-term (6-18 months):</strong> Full ERP integration, advanced e-commerce features,
                                initial data lake setup, comprehensive digital training.</li>
                            <li><strong>Long-term (18+ months):</strong> AI-driven personalization, predictive supply chain,
                                expansion into new digital services.</li>
                        </ul>

                        <h3>MEASUREMENT & KPIs:</h3>
                        <ul>
                            <li>Online Conversion Rate, Customer Lifetime Value, Order Fulfillment Time, Inventory Accuracy,
                                Employee Digital Proficiency.</li>
                        </ul>
                    </div>
                </div>

                <!-- Carousel Navigation Buttons -->
                <button id="prevExampleBtn" class="carousel-button left">&larr;</button>
                <button id="nextExampleBtn" class="carousel-button right">&rarr;</button>
            </div>
            <div class="text-center text-white/80 mt-4">
                <span id="exampleCounter">1 of 3</span>
            </div>

            <div class="text-center mt-12">
                <button class="btn btn-primary nav-link" data-page="templates">View Templates</button>
            </div>
        </div>
        
        <!-- ========================================================= -->
        <!-- TERMS OF SERVICE PAGE                                     -->
        <!-- ========================================================= -->
        <div id="termsOfService" class="page container mx-auto px-6 py-16">
            <div class="max-w-4xl mx-auto glass-container">
                <h1 class="text-3xl font-bold mb-6">Terms of Service</h1>
                <div class="space-y-4 text-white/80">
                    <p><strong>Last Updated:</strong> September 28, 2025</p>
                    <p>Welcome to S.A.G.E. ("Service"), an AI-powered strategic analysis tool. These Terms of Service ("Terms") govern your use of our website and services. By accessing or using the Service, you agree to be bound by these Terms.</p>
                    <h2 class="text-xl font-semibold pt-4">1. Use of Service</h2>
                    <p>You must be at least 18 years old to use the Service. You are responsible for maintaining the confidentiality of your account and password. You agree to accept responsibility for all activities that occur under your account.</p>
                    <h2 class="text-xl font-semibold pt-4">2. User Content</h2>
                    <p>You retain all rights to any documents or information you upload to the Service ("User Content"). By uploading User Content, you grant us a limited license to use, process, and store the content solely for the purpose of providing the Service to you.</p>
                    <h2 class="text-xl font-semibold pt-4">3. Prohibited Conduct</h2>
                    <p>You agree not to use the Service for any unlawful purpose or to engage in any conduct that could damage, disable, or impair the Service. This includes uploading malicious software or infringing on intellectual property rights.</p>
                    <h2 class="text-xl font-semibold pt-4">4. Disclaimers</h2>
                    <p>The Service is provided on an "as is" and "as available" basis. We do not warrant that the analysis generated will be accurate, reliable, or complete. The strategic insights provided are for informational purposes only and should not be considered professional advice.</p>
                    <h2 class="text-xl font-semibold pt-4">5. Limitation of Liability</h2>
                    <p>In no event shall S.A.G.E. or its developers be liable for any indirect, incidental, special, or consequential damages arising out of or in connection with your use of the Service.</p>
                    <h2 class="text-xl font-semibold pt-4">6. Changes to Terms</h2>
                    <p>We reserve the right to modify these Terms at any time. We will notify you of any changes by posting the new Terms on this page. Your continued use of the Service after any such changes constitutes your acceptance of the new Terms.</p>
                </div>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- PRIVACY POLICY PAGE                                       -->
        <!-- ========================================================= -->
        <div id="privacyPolicy" class="page container mx-auto px-6 py-16">
            <div class="max-w-4xl mx-auto glass-container">
                <h1 class="text-3xl font-bold mb-6">Privacy Policy</h1>
                <div class="space-y-4 text-white/80">
                    <p><strong>Last Updated:</strong> September 28, 2025</p>
                    <p>Your privacy is important to us. This Privacy Policy explains how we collect, use, and protect your information when you use S.A.G.E. ("Service").</p>
                    <h2 class="text-xl font-semibold pt-4">1. Information We Collect</h2>
                    <p><strong>Account Information:</strong> When you register, we collect your name and email address. <br><strong>User Content:</strong> We collect the documents and data you upload for analysis. <br><strong>Usage Data:</strong> We may collect anonymous data about your interaction with the Service to help us improve it.</p>
                    <h2 class="text-xl font-semibold pt-4">2. How We Use Your Information</h2>
                    <p>We use your information to: <br>- Provide, operate, and maintain the Service. <br>- Process your documents to generate strategic analysis. <br>- Communicate with you, including sending service-related notices. <br>- Improve and personalize the Service.</p>
                    <h2 class="text-xl font-semibold pt-4">3. Data Security</h2>
                    <p>We implement a variety of security measures to maintain the safety of your personal information and User Content. Your data is encrypted in transit and at rest. We do not share your uploaded documents with third parties, except as required to provide the AI analysis via our integrated partners.</p>
                    <h2 class="text-xl font-semibold pt-4">4. Data Retention</h2>
                    <p>We retain your account information for as long as your account is active. Saved projects are stored until you choose to delete them. Uploaded documents that are not part of a saved project are deleted from our servers after the analysis is complete.</p>
                    <h2 class="text-xl font-semibold pt-4">5. Your Rights</h2>
                    <p>You have the right to access, update, or delete your personal information and saved projects at any time through your account dashboard.</p>
                    <h2 class="text-xl font-semibold pt-4">6. Changes to This Policy</h2>
                    <p>We may update this Privacy Policy from time to time. We will notify you of any changes by posting the new policy on this page.</p>
                </div>
            </div>
        </div>

    </div><!-- End Main Content -->

    <!-- ========================================================= -->
    <!-- FOOTER                                                    -->
    <!-- ========================================================= -->
    <footer class="mt-auto py-8">
        <div class="container mx-auto text-center text-white/70">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="hover:text-white nav-link" data-page="about">About</a>
                <a href="#" class="hover:text-white nav-link" data-page="frameworks">Frameworks</a>
                <a href="#" class="hover:text-white nav-link" data-page="adminDashboard">Admin Dashboard</a>
                 <a href="#" class="hover:text-white nav-link" data-page="termsOfService">Terms of Service</a>
                <a href="#" class="hover:text-white nav-link" data-page="privacyPolicy">Privacy Policy</a>
            </div>
            <p>&copy; 2025 S.A.G.E. All rights reserved.</p>
        </div>
    </footer>


    <script type="module">
        // =========================================================
        // SCRIPT
        // =========================================================
        // Load NVL base library
        import { NVL } from "https://esm.sh/@neo4j-nvl/base@0.3.9/es2022/base.mjs";
        import { 
            ClickInteraction,
            ZoomInteraction,
            PanInteraction,
            DragNodeInteraction,
            HoverInteraction 
        } from "https://esm.sh/@neo4j-nvl/interaction-handlers@0.3.9/es2022/interaction-handlers.mjs";
        document.addEventListener('DOMContentLoaded', () => {

            // --- Supabase Configuration ---
            const SUPABASE_URL = 'https://supabase.data2int.com'
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNjQwOTk1MjAwLCJleHAiOjE5NTYzNTUyMDB9.KHXKQpsN6MNB08H_IPxP4Gh0gjcsvXG9IeJuK3XpnAU'

            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

            // --- DOM Element References ---
            const $ = id => document.getElementById(id);
            const pages = document.querySelectorAll('.page');
            const templatesListContainer = $('templatesList');
            let currentTemplateId = null; 
            let currentProjectId = null; 
            let websocket = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            const reconnectDelay = 3000; 
            let pendingAnalysisRequests = new Map()


            // --- User Session State ---
            let userLoggedIn = false; 
            let currentUser = null;

            // --- Version Control State ---
            let currentSelectionLimit = 3; // Default to paid
            let selectedTemplateForModal = null;


            // --- Template Data (Prompts Removed) ---
            const templates = {
                'custom-template': {
                    title: 'Custom Strategy Generator',
                    description: 'Design your own strategic analysis by defining the type of strategy, company, and location.',
                    isPremium: true,
                },
                'swot': {
                    title: 'SWOT Analysis',
                    description: "Analyze your organization's Strengths, Weaknesses, Opportunities, and Threats.",
                },
                'competitor': {
                    title: 'Competitor Analysis',
                    description: 'Deep dive into competitor strategies, market positioning, and competitive advantages.',
                },
                'market-entry': {
                    title: 'Market Entry Strategy',
                    description: 'Evaluate market opportunities, entry barriers, and develop a roadmap for market penetration.',
                },
                'financial': {
                    title: 'Financial Projections',
                    description: 'Create comprehensive financial forecasts, budgets, and scenario planning.',
                },
                'risk': {
                    title: 'Risk Assessment',
                    description: 'Identify, evaluate, and develop mitigation strategies for business risks.',
                },
                'business-model': {
                    title: 'Business Model Canvas',
                    description: 'Design and analyze your business model using the proven 9-building-block framework.',
                },
                'marketing-plan': {
                    title: 'Marketing Plan Development',
                    description: 'Craft a detailed marketing strategy, including target audience, channels, and campaigns.',
                },
                'product-launch': {
                    title: 'Product Launch Strategy',
                    description: 'Plan a successful product launch from pre-launch to post-launch activities.',
                },
                'customer-segmentation': {
                    title: 'Customer Segmentation Analysis',
                    description: 'Identify and analyze distinct customer groups to tailor marketing efforts.',
                },
                'supply-chain-opt': {
                    title: 'Supply Chain Optimization',
                    description: 'Identify inefficiencies to streamline your supply chain for cost savings.',
                },
                'hr-strategy': {
                    title: 'Human Resources Strategy',
                    description: 'Develop an HR strategy aligned with business goals, covering talent acquisition and retention.',
                },
                'digital-transformation': {
                    title: 'Digital Transformation Roadmap',
                    description: 'Plan your organization\'s journey towards digital maturity.',
                },
                'dematel-analysis': {
                    title: 'Dematel Analysis',
                    description: 'Understand causal relationships between complex factors to identify core problems and effective leverage points.'
                },
                'data-analysis': {
                    title: 'Data Analysis',
                    description: 'Leverage quantitative data to uncover trends, patterns, and insights that inform strategic decisions.'
                },
                'sem-analysis': {
                    title: 'SEM Analysis',
                    description: 'Apply Structural Equation Modeling to test and validate complex theoretical models and causal relationships.'
                },
                'archetype-analysis': {
                    title: 'Archetype Analysis',
                    description: 'Identify and analyze recurring patterns of behavior (archetypes) within your system or market.'
                },
                'creative-dissonance': {
                    title: 'Creative Dissonance Analysis',
                    description: 'Explore the gap between your current reality and desired future to fuel innovation and strategic change.'
                },
                'strategic-alignment': {
                    title: 'Strategic Alignment Analysis',
                    description: 'Ensure all parts of your organization are working in unison towards common strategic goals.'
                }
            };
            
            // --- Frameworks Data ---
            const frameworksData = {
                'reframing': {
                    title: 'Reframing',
                    short: 'Shift your perspective to view problems in a new light, unlocking creative solutions.',
                    long: 'A technique to shift perspective and view a problem or situation in a new light. It helps in challenging assumptions and unlocking creative solutions by changing the conceptual and/or emotional setting.'
                },
                'delphi': {
                    title: 'Delphi Method',
                    short: 'Leverage a panel of experts through structured, anonymous feedback to achieve consensus.',
                    long: 'A structured communication technique for forecasting, using a panel of independent experts. The experts answer questionnaires in two or more rounds, facilitating a convergence of opinion.'
                },
                'design-thinking': {
                    title: 'Design Thinking',
                    short: 'A human-centered, iterative process for creative problem-solving and innovation.',
                    long: 'A human-centered, iterative process for creative problem-solving. It focuses on empathy, ideation, prototyping, and testing to develop solutions that meet user needs and business goals.'
                },
                'business-canvas': {
                    title: 'Business Model Canvas',
                    short: 'Visually map out your business model to understand and innovate its core components.',
                    long: 'A visual chart with nine blocks describing a company\'s value proposition, infrastructure, customers, and finances. It’s a strategic tool for developing, documenting, and analyzing business models.'
                },
                'thinking-hats': {
                    title: 'Thinking Hats',
                    short: 'Explore issues from multiple perspectives to make well-rounded decisions.',
                    long: 'Edward de Bono\'s system for parallel thinking. Participants metaphorically wear six colored hats, each representing a distinct thinking style (e.g., facts, feelings, creativity), to explore an issue comprehensively.'
                },
                'blue-ocean': {
                    title: 'Blue Ocean Strategy',
                    short: 'Create uncontested market space and make the competition irrelevant.',
                    long: 'Focuses on creating uncontested market space rather than competing in existing industries. It involves the simultaneous pursuit of differentiation and low cost to open up new demand.'
                },
                'mckinsey-7s': {
                    title: 'McKinsey 7S',
                    short: 'Align seven key internal elements to improve organizational effectiveness.',
                    long: 'A model that identifies seven internal elements of an organization (Strategy, Structure, Systems, Shared Values, Skills, Style, Staff) that must be aligned for it to achieve its objectives.'
                },
                'triz': {
                    title: 'TRIZ',
                    short: 'A systematic, patent-based approach for inventive problem-solving.',
                    long: 'A Russian acronym for "Theory of Inventive Problem Solving." It\'s a systematic approach based on the study of global patent patterns to find innovative solutions to technical problems.'
                },
                'balanced-scorecard': {
                    title: 'Balanced Scorecard',
                    short: 'Track performance against strategic objectives across four key perspectives.',
                    long: 'A strategic performance management tool that tracks execution against objectives across four perspectives: Financial, Customer, Internal Business Processes, and Learning and Growth.'
                },
                'burke-litwin': {
                    title: 'Burke-Litwin Model',
                    short: 'Understand and manage organizational change by linking strategy and performance.',
                    long: 'A causal model for understanding organizational change. It distinguishes between transformational factors (deep-seated culture) and transactional factors (day-to-day operations).'
                },
                'fishbone': {
                    title: 'Fishbone Chart',
                    short: 'Visually identify and categorize the potential root causes of a problem.',
                    long: 'Also known as an Ishikawa or Cause-and-Effect Diagram, it\'s a visualization tool for categorizing the potential causes of a problem in order to identify its root causes.'
                },
                'pareto': {
                    title: 'Pareto Analysis',
                    short: 'Focus on the vital few causes that create the majority of problems (80/20 rule).',
                    long: 'A decision-making technique based on the 80/20 rule (Pareto Principle), which states that for many events, roughly 80% of the effects come from 20% of the causes.'
                }
            };

            // --- Feature Content Data ---
            const featureContent = {
                'vision': {
                    short: "We help you craft a clear vision with detailed strategic steps.",
                    long: `<strong>Our Vision Framework</strong>
            <p style="text-align: center;">Our comprehensive vision development process includes stakeholder alignment, future scenario planning, and measurable outcome definition. We work with your team to create a vision that inspires action and provides clear direction for organizational growth.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Stakeholder engagement and alignment</li>
                <li style="text-align: center;">Market trend analysis and future forecasting</li>
                <li style="text-align: center;">Vision statement development and refinement</li>
                <li style="text-align: center;">Implementation roadmap creation</li>
            </ul>`
                },
                'mission': {
                    short: "Define your organization's core purpose and foundational principles.",
                    long: `<strong>Mission Development Process</strong>
            <p style="text-align: center;">We facilitate workshops to help you articulate your organization's fundamental purpose, core values, and primary objectives. This process ensures alignment across all levels of your organization.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Purpose clarification sessions</li>
                <li style="text-align: center;">Value proposition development</li>
                <li style="text-align: center;">Mission statement crafting</li>
                <li style="text-align: center;">Organizational alignment verification</li>
            </ul>`
                },
                'goals': {
                    short: "Set ambitious yet achievable goals that align with your vision.",
                    long: `<strong>SMART Goals Framework</strong>
            <p style="text-align: center;">Our goal-setting methodology ensures your objectives are Specific, Measurable, Achievable, Relevant, and Time-bound. We help you create both short-term and long-term goals that drive meaningful progress.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Strategic objective identification</li>
                <li style="text-align: center;">KPI and metric development</li>
                <li style="text-align: center;">Timeline and milestone planning</li>
                <li style="text-align: center;">Resource allocation planning</li>
            </ul>`
                },
                'strategic-initiatives': {
                    short: "Develop initiatives that translate your vision into actionable plans.",
                    long: `<strong>Initiative Development</strong>
            <p style="text-align: center;">We help you identify and prioritize strategic initiatives that will have the greatest impact on achieving your organizational goals. Each initiative includes detailed planning, resource requirements, and success metrics.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Initiative prioritization matrix</li>
                <li style="text-align: center;">Resource requirement analysis</li>
                <li style="text-align: center;">Risk assessment and mitigation</li>
                <li style="text-align: center;">Implementation timeline development</li>
            </ul>`
                },
                'objectives': {
                    short: "Break down goals into specific, measurable objectives for tracking.",
                    long: `<strong>Objective Setting Framework</strong>
            <p style="text-align: center;">Our systematic approach to objective setting ensures alignment with strategic goals while maintaining flexibility for changing market conditions and organizational needs.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Objective hierarchy development</li>
                <li style="text-align: center;">Performance indicator definition</li>
                <li style="text-align: center;">Progress tracking systems</li>
                <li style="text-align: center;">Review and adjustment protocols</li>
            </ul>`
                },
                'actions': {
                    short: "Define specific actions and tactics to drive achievement.",
                    long: `<strong>Action Planning</strong>
            <p style="text-align: center;">We help you create detailed action plans that specify who, what, when, and how for each strategic initiative, ensuring nothing falls through the cracks.</p>
            <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                <li style="text-align: center;">Task breakdown and assignment</li>
                <li style="text-align: center;">Timeline and dependency mapping</li>
                <li style="text-align: center;">Resource allocation and budgeting</li>
                <li style="text-align: center;">Progress monitoring systems</li>
            </ul>`
                },
                'internal-external-analysis': {
                    short: "Analyze internal and external factors to build a robust strategic position.",
                    long: `<strong>Factor Analysis Techniques</strong>
                    <p style="text-align: center;">Utilize established frameworks to evaluate your organization's landscape, identifying key variables that can influence your strategy and decision-making.</p>
                    <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                        <li style="text-align: center;">SWOT Analysis</li>
                        <li style="text-align: center;">TOWS Matrix</li>
                        <li style="text-align: center;">DEMATEL Method</li>
                    </ul>`
                },
                'system-analysis': {
                    short: "Understand complex interconnections to identify high-leverage intervention points.",
                    long: `<strong>Systems Thinking Tools</strong>
                    <p style="text-align: center;">Go beyond linear cause-and-effect to see the patterns, structures, and feedback loops that drive behavior in your organization and market.</p>
                    <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                        <li style="text-align: center;">System Mapping</li>
                        <li style="text-align: center;">Levels of Thinking</li>
                        <li style="text-align: center;">Leverage Points</li>
                        <li style="text-align: center;">System Archetypes</li>
                        <li style="text-align: center;">Dissonance Analysis</li>
                    </ul>`
                },
                'problem-solving': {
                    short: "Apply structured frameworks to diagnose root causes and prioritize solutions.",
                    long: `<strong>Root Cause Analysis</strong>
                    <p style="text-align: center;">Move past symptoms to address the fundamental issues, ensuring your solutions are effective and long-lasting.</p>
                    <ul class="list-disc list-inside mt-2 text-white/70" style="text-align: center;">
                         <li style="text-align: center;">Fishbone (Ishikawa) Diagram</li>
                         <li style="text-align: center;">Pareto Analysis (80/20 Rule)</li>
                    </ul>`
                }
            };


            // WebSocket Management Functions
            function initializeWebSocket() {
                const wsStatus = document.getElementById('wsStatus');

                try {
                    // FastAPI listener's WebSocket endpoint
                    websocket = new WebSocket('wss://n8n-api.data2int.com/ws');

                    wsStatus.textContent = 'Connecting...';
                    wsStatus.className = 'ws-status connecting';

                    websocket.onopen = function (event) {
                        console.log('WebSocket connected successfully');
                        wsStatus.textContent = 'Connected';
                        wsStatus.className = 'ws-status connected';
                        reconnectAttempts = 0; // Reset reconnect attempts on successful connection
                    };

                    websocket.onmessage = function (event) {
                        console.log('Received WebSocket message:', event.data);

                        try {
                            const data = JSON.parse(event.data);
                            handleWebSocketMessage(data);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };

                    websocket.onclose = function (event) {
                        console.log('WebSocket connection closed:', event.code, event.reason);
                        wsStatus.textContent = 'Disconnected';
                        wsStatus.className = 'ws-status disconnected';

                        // Attempt to reconnect unless it was a manual close
                        if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                            setTimeout(() => {
                                reconnectAttempts++;
                                console.log(`WebSocket reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                                initializeWebSocket();
                            }, reconnectDelay);
                        }
                    };

                    websocket.onerror = function (error) {
                        console.error('WebSocket error:', error);
                        wsStatus.textContent = 'Error';
                        wsStatus.className = 'ws-status disconnected';
                    };

                } catch (error) {
                    console.error('Failed to initialize WebSocket:', error);
                    wsStatus.textContent = 'Failed';
                    wsStatus.className = 'ws-status disconnected';
                }
            }

            // --- DOCX Export Logic ---
            function handleSaveAsDocx() {
                const content = $('analysisResult').innerText;
                if (!content || content.includes("Your generated analysis will appear here.")) {
                    alert("No analysis to save.");
                    return;
                }
                const blob = new Blob([content], {
                    type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });
                saveAs(blob, "SAGE_Analysis.docx");
            }


            // --- PDF Save Logic ---
            function handleSaveAsPdf() {
                if (!window.jspdf || !window.jspdf.jsPDF) return alert('PDF library not loaded.');
                const {
                    jsPDF
                } = window.jspdf;
                const doc = new jsPDF({
                    unit: "pt",
                    format: "a4"
                });

                const targetEl = $("analysisResult");
                if (!targetEl) {
                    alert("Nothing to export.");
                    return;
                }

                const content = targetEl.innerText || "";
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const marginL = 40,
                    marginR = 40,
                    marginT = 60,
                    marginB = 60;
                const maxLineWidth = pageWidth - marginL - marginR;
                const lineHeight = 16; // points

                doc.setFont("Helvetica", "normal");
                doc.setFontSize(12);

                const lines = doc.splitTextToSize(content, maxLineWidth);
                let cursorY = marginT;
                lines.forEach(line => {
                    if (cursorY > pageHeight - marginB) {
                        doc.addPage();
                        cursorY = marginT;
                    }
                    doc.text(line, marginL, cursorY);
                    cursorY += lineHeight;
                });
                doc.save("SAGE_Analysis.pdf");
            }

            // Initialize WebSocket connection
            initializeWebSocket();

            // --- Session Management ---
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    userLoggedIn = true;
                    currentUser = session.user;
                } else if (event === 'SIGNED_OUT') {
                    userLoggedIn = false;
                    currentUser = null;
                }
                updateNavBar();
            });


            // --- Navigation Logic ---
            function navigateTo(pageId) {
                pages.forEach(page => {
                    page.classList.remove('active', 'flex', 'block');
                    page.style.display = 'none';
                });

                const targetPage = $(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    if (['home', 'templates', 'templateDetail', 'examplesPage', 'myProjects', 'adminDashboard', 'frameworks', 'about', 'knowledgeGraph', 'termsOfService', 'privacyPolicy'].includes(pageId)) {
                        targetPage.style.display = 'block';
                    } else {
                        targetPage.style.display = 'flex';
                    }

                    if (pageId === 'myProjects' && userLoggedIn) {
                        loadProjectsForUser(); 
                    }
                    if(pageId === 'frameworks'){
                        populateFrameworksPage();
                    }
                    if (pageId === 'knowledgeGraph') {
                        loadKnowledgeGraph();
                    }
                    window.scrollTo(0, 0);
                }
            }

            // --- Update Navigation Bar Links ---
            function updateNavBar() {
                const loginLink = document.querySelector('a[data-page="login"], a[data-page="logout"]');
                const templatesLink = document.querySelector('a[data-page="templates"]');
                const myProjectsLink = document.querySelector('a[data-page="myProjects"]');

                if (userLoggedIn) {
                    if (loginLink) {
                        loginLink.textContent = 'Logout';
                        loginLink.setAttribute('data-page', 'logout');
                    }
                    if (templatesLink) templatesLink.classList.remove('hidden');
                    if (myProjectsLink) myProjectsLink.classList.remove('hidden');
                } else {
                    if (loginLink) {
                        loginLink.textContent = 'Login';
                        loginLink.setAttribute('data-page', 'login');
                    }
                    if (templatesLink) templatesLink.classList.add('hidden');
                    if (myProjectsLink) myProjectsLink.classList.add('hidden');
                }
                attachNavLinkListeners();
            }


            // --- Attach Navigation Link Listeners ---
            function attachNavLinkListeners() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.removeEventListener('click', handleNavLinkClick);
                    link.addEventListener('click', handleNavLinkClick);
                });
            }

            function handleNavLinkClick(e) {
                e.preventDefault();
                const pageId = this.getAttribute('data-page');

                if (pageId === 'logout') {
                    handleLogout();
                    return;
                }

                const needsAuth = ['templates', 'myProjects', 'knowledgeGraph'];
                if (needsAuth.includes(pageId) && !userLoggedIn) {
                    showMessage('loginMessage', `Please log in to access ${pageId}.`, 'error');
                    navigateTo('login');
                    return;
                }

                if ((pageId === 'login' || pageId === 'signup') && userLoggedIn) {
                    navigateTo('myProjects');
                    return;
                }

                // Call loadKnowledgeGraph when navigating to the knowledgeGraph
                if (pageId === 'knowledgeGraph') {
                    navigateTo('knowledgeGraph')
                    return;
                }
                navigateTo(pageId);
            }

            // --- Template Page & Modal Logic ---
            function populateTemplatesList() {
                templatesListContainer.innerHTML = '';
                const templateArray = Object.keys(templates).map(key => ({
                    id: key,
                    ...templates[key]
                }));

                templateArray.sort((a, b) => {
                    if (a.id === 'custom-template') return -1;
                    if (b.id === 'custom-template') return 1;
                    return 0;
                });

                templateArray.forEach(template => {
                    const card = document.createElement('div');
                    card.className = 'template-card p-6' + (template.isPremium ? ' relative' : '');
                    card.setAttribute('data-template-id', template.id);
                    card.innerHTML = `
                <h3 class="text-2xl font-bold mb-2">${template.title}</h3>
                <p class="text-white/70">${template.description}</p>
                ${template.isPremium ? '<span class="absolute top-4 right-4 bg-yellow-500 text-yellow-900 text-xs font-semibold px-2.5 py-0.5 rounded-full">Premium</span>' : ''}
            `;
                    card.addEventListener('click', () => {
                        if (template.isPremium && !userLoggedIn) {
                            showMessage('loginMessage', 'Please log in to access premium templates.', 'error');
                            navigateTo('login');
                        } else if (!userLoggedIn) {
                            showMessage('loginMessage', 'Please log in to use templates.', 'error');
                            navigateTo('login');
                        } else {
                            selectedTemplateForModal = template.id;
                            $('versionChoiceModal').classList.remove('hidden');
                        }
                    });
                    templatesListContainer.appendChild(card);
                });
            }

            function proceedFromModal() {
                $('versionChoiceModal').classList.add('hidden');
                if (selectedTemplateForModal) {
                    showTemplateDetail(selectedTemplateForModal);
                }
            }

            function showTemplateDetail(templateId) {
                currentTemplateId = templateId;
                const template = templates[templateId];
                if (!template) return;

                $('templateTitle').textContent = template.title;
                $('templateDescription').textContent = template.description;
                const templateFormFields = $('templateFormFields');
                templateFormFields.innerHTML = '';

                if (templateId === 'custom-template') {
                    templateFormFields.innerHTML += `
                <div>
                    <label for="typeOfStrategy" class="block text-sm font-medium text-gray-200 mb-2">Type of Strategy</label>
                    <input type="text" id="typeOfStrategy" class="input-field" placeholder="e.g., Market Expansion Strategy" required>
                </div>`;
                }

                templateFormFields.innerHTML += `
                    <div><label for="companyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label><input type="text" id="companyName" class="input-field" placeholder="e.g., Innovate Inc." required></div>
                    <div>
                        <label for="companyDocumentsFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Company Documents</label>
                        <div class="input-file-wrapper">
                             <label for="companyDocumentsFile" id="companyDocumentsFileLabel" class="input-file-label">Click to select a file...</label>
                             <input type="file" id="companyDocumentsFile" class="input-file" required>
                        </div>
                    </div>
                    <div><label for="location" class="block text-sm font-medium text-gray-200 mb-2">Location</label><input type="text" id="location" class="input-field" placeholder="e.g., Global" required></div>
                `;

                $('companyDocumentsFile').addEventListener('change', (e) => {
                    const label = $('companyDocumentsFileLabel');
                    if (e.target.files.length > 0) {
                        label.textContent = e.target.files[0].name;
                        label.classList.add('has-file');
                    } else {
                        label.textContent = 'Click to select a file...';
                         label.classList.remove('has-file');
                    }
                });

                $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                $('analysisActions').classList.add('hidden');
                currentProjectId = null;
                
                configureFrameworkSelector(currentSelectionLimit);
                navigateTo('templateDetail');
            }
            
            function frameworkCheckboxChangeHandler() {
                const checkedBoxes = document.querySelectorAll('#frameworkList .method-checkbox:checked');
                const selectionCounter = $('selectionCounter');
                
                if (checkedBoxes.length > currentSelectionLimit) {
                    this.checked = false;
                }

                const finalCheckedCount = document.querySelectorAll('#frameworkList .method-checkbox:checked').length;
                selectionCounter.textContent = `Selected: ${finalCheckedCount} / ${currentSelectionLimit}`;
            }
            
            function configureFrameworkSelector(limit) {
                currentSelectionLimit = limit;
                const selectionCounter = $('selectionCounter');
                const checkboxes = document.querySelectorAll('#frameworkList .method-checkbox');

                selectionCounter.textContent = `Selected: 0 / ${limit}`;
                checkboxes.forEach(cb => {
                    cb.checked = false;
                });
            }

            // Get selected frameworks from checkboxes and map to n8n values
            function getSelectedFrameworks() {
                const checkedBoxes = document.querySelectorAll('#frameworkList .method-checkbox:checked');
                const selectedMethods = [];

                const frameworkMap = {
                    'Reframing Thinking': 'ReframingThinking',
                    'Delphi Method': 'DelphiMethod',
                    'Blue Ocean Strategy': 'BlueOcean',
                    'Design Thinking': 'DesignThinking',
                    'Thinking Hats': 'ThinkingHats',
                    'Business Model Canvas': 'BusinessModelCanvas',
                    'SCAMPER': 'SCAMPER',
                    'TRIZ (Theory of Inventive Problem Solving)': 'TRIZ'
                };

                checkedBoxes.forEach(checkbox => {
                    const methodText = checkbox.nextElementSibling.textContent.trim();
                    if (frameworkMap[methodText]) {
                        selectedMethods.push(frameworkMap[methodText]);
                    }
                });
                return selectedMethods.join(',');
            }

            // Get selected analysis sections
            function getSelectedSections() {
                const checkedBoxes = document.querySelectorAll('#analysisList .method-checkbox:checked');
                const selectedSections = [];

                const sectionMap = {
                    'Introduction': 'introduction',
                    'Overview of business': 'overview_of_business',
                    'process overview': 'process_overview',
                    'mission statement': 'mission_statement',
                    'vision analysis': 'vision_analysis',
                    'vision statement 2': 'vision_statement_2',
                    'novel strategy part 1': 'novel_strategy_part_1',
                    'novel strategy part 2': 'novel_strategy_part_2',
                    'novel strategy part 3': 'novel_strategy_part_3'
                };

                checkedBoxes.forEach(checkbox => {
                    const sectionText = checkbox.nextElementSibling.textContent.trim();
                    if (sectionMap[sectionText]) {
                        selectedSections.push(sectionMap[sectionText]);
                    }
                });
                return selectedSections.join(',');
            }

            function getFrameworkForTemplate(templateId) {
                const selectedFrameworks = getSelectedFrameworks();
                return selectedFrameworks || 'BlueOcean,SCAMPER';
            }


            async function handleGenerate() {
                if (!currentTemplateId) return;

                try {
                    const currentCount = Number(localStorage.getItem('sage_query_count') || '0');
                    localStorage.setItem('sage_query_count', String(currentCount + 1));
                } catch (e) { console.error("Could not update query count", e); }

                setLoading('generate', true);
                $('analysisActions').classList.add('hidden');

                const companyName = $('companyName').value.trim();
                const companyDocumentsFile = $('companyDocumentsFile').files[0];
                const location = $('location').value.trim();
                const analysisResultContainer = $('analysisResult');

                const framework = getFrameworkForTemplate(currentTemplateId);
                const sections = getSelectedSections();
                const checkedFrameworks = Array.from(document.querySelectorAll('#frameworkList .method-checkbox:checked'));

                if (checkedFrameworks.length < 1 || checkedFrameworks.length > currentSelectionLimit) {
                    analysisResultContainer.innerHTML =
                        `<div class="p-4 text-center text-red-400">Please select between 1 and ${currentSelectionLimit} frameworks.</div>`;
                    setLoading('generate', false);
                    return;
                }

                let fullPrompt = '';
                if (currentTemplateId === 'custom-template') {
                    const typeOfStrategy = $('typeOfStrategy').value.trim();
                    if (!typeOfStrategy || !companyName || !companyDocumentsFile || !location) {
                        analysisResultContainer.innerHTML =
                            `<div class="p-4 text-center text-red-400">Please fill out all fields and upload a file for your custom strategy.</div>`;
                        setLoading('generate', false);
                        return;
                    }
                    fullPrompt =
                        `Generate a detailed ${typeOfStrategy} for ${companyName}. Use Case: See attached document. Location: ${location} Please provide a comprehensive analysis and actionable recommendations for this custom strategic request.`;
                } else {
                    if (!companyName || !companyDocumentsFile || !location) {
                        analysisResultContainer.innerHTML =
                            `<div class="p-4 text-center text-red-400">Please fill out all fields and upload a file before generating.</div>`;
                        setLoading('generate', false);
                        return;
                    }
                    fullPrompt =
                        `User Information: - Company Name: ${companyName} - Location: ${location}`;
                }


                analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Generating Your Strategic Analysis</h3>
                        <p class="text-white/80 mb-2">This comprehensive analysis may take 2-5 minutes to complete.</p>
                        <p class="text-white/60 text-sm">Please keep this page open while we process your request.</p>
                    </div>`;

                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) {
                        analysisResultContainer.innerHTML =
                            `<div class="p-4 text-center text-red-400">Please log in to generate analysis.</div>`;
                        setLoading('generate', false);
                        return;
                    }

                    const messageId = Date.now();
                    pendingAnalysisRequests.set(messageId, analysisResultContainer);

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                    
                    const formData = new FormData();
                    formData.append('customerName', companyName);
                    formData.append('location', location);
                    formData.append('company_documents', companyDocumentsFile.name); 
                    formData.append('prompt', fullPrompt);
                    formData.append('framework', framework);
                    formData.append('sections', sections);
                    formData.append('templateId', currentTemplateId);
                    formData.append('messageId', messageId);
                    formData.append('file', companyDocumentsFile); // Append the actual file data


                    const response = await fetch('https://n8n.data2int.com/webhook-test/analysis-ev2', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: formData,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    console.log('Analysis request submitted successfully.');
                    // Result will be handled by WebSocket

                } catch (error) {
                    if (error.name === 'AbortError') {
                        // This is an expected timeout of the initial request.
                        // The actual result will come via WebSocket, so we don't show an error.
                        console.log('Fetch request timed out as expected. Waiting for WebSocket response.');
                        return; // Keep the "Generating..." message visible.
                    }
                    console.error('Error submitting analysis request:', error);
                    analysisResultContainer.innerHTML =
                        `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                    setLoading('generate', false);
                }
            }

            function handleWebSocketMessage(data) {
                if (data.messageId && data.result) {
                    const container = pendingAnalysisRequests.get(parseInt(data.messageId));
                    if (container) {
                        container.innerHTML = `<div class="whitespace-pre-wrap">${data.result}</div>`;
                        $('analysisActions').classList.remove('hidden'); // Show all action buttons
                        pendingAnalysisRequests.delete(parseInt(data.messageId));
                        setLoading('generate', false);
                    }
                }

                if (data.messageId && data.progress && !data.result) {
                    const container = pendingAnalysisRequests.get(parseInt(data.messageId));
                    if (container) {
                        container.innerHTML = `
                <div class="text-center text-white/70 p-4">
                    <div class="typing-indicator mb-4">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                    <p class="mb-2">🔄 ${data.progress}</p>
                    <p class="text-sm text-white/50">Analysis in progress...</p>
                </div>`;
                    }
                }

                if (data.messageId && data.error) {
                    const container = pendingAnalysisRequests.get(parseInt(data.messageId));
                    if (container) {
                        container.innerHTML =
                            `<div class="p-4 text-center text-red-400">Workflow error: ${data.error}</div>`;
                        pendingAnalysisRequests.delete(parseInt(data.messageId));
                        setLoading('generate', false);
                    }
                }
            }

            // --- Project Management (Supabase) ---
            async function saveProjectToSupabase() {
                if (!currentUser) {
                    alert('You must be logged in to save a project.');
                    return;
                }

                const projectTitle = $('companyName').value.trim() || 'Untitled Project';
                const analysisText = $('analysisResult').innerText;
                const inputs = {
                    templateId: currentTemplateId,
                    companyName: $('companyName').value,
                    location: $('location').value,
                    typeOfStrategy: $('typeOfStrategy')?.value,
                };

                const saveBtn = $('saveProjectBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="loading-spinner mr-2"></span> Saving...';

                const { data, error } = await supabase
                    .from('projects')
                    .insert([{
                        user_id: currentUser.id,
                        project_title: projectTitle,
                        analysis_text: analysisText,
                        inputs: inputs
                    }]);

                saveBtn.disabled = false;
                 saveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save mr-2" viewBox="0 0 16 16"><path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v4.5h2a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 5.5 6.5h2V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1z"/></svg> Save Project`;


                if (error) {
                    console.error("Error saving project:", error);
                    alert("Error saving project.");
                } else {
                    alert("Project saved successfully!");
                }
            }

            async function loadProjectsForUser() {
                if (!currentUser) return;

                const projectsListContainer = $('projectsList');
                const noProjectsMessage = $('noProjectsMessage');
                projectsListContainer.innerHTML =
                    '<div class="col-span-3 text-center p-8"><span class="loading-spinner mx-auto"></span></div>';
                noProjectsMessage.classList.add('hidden');

                const {
                    data: projects,
                    error
                } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', {
                        ascending: false
                    });

                if (error) {
                    console.error("Error loading projects:", error);
                    projectsListContainer.innerHTML =
                        '<p class="text-red-400 col-span-3 text-center">Could not load projects.</p>';
                    return;
                }

                projectsListContainer.innerHTML = ''; // Clear loader
                if (projects.length === 0) {
                    noProjectsMessage.classList.remove('hidden');
                } else {
                    noProjectsMessage.classList.add('hidden');
                    projects.forEach(project => {
                        const card = document.createElement('div');
                        card.className = 'project-card p-6 flex flex-col justify-between';
                        card.innerHTML = `
                            <div>
                                <h3 class="text-xl font-bold mb-2">${project.project_title}</h3>
                                <p class="text-white/70 text-sm mb-4">Saved on: ${new Date(project.created_at).toLocaleDateString()}</p>
                                <p class="text-white/80 project-card-content">${project.analysis_text}</p>
                            </div>
                            <div class="mt-4 flex justify-end space-x-2">
                                <button class="btn btn-secondary view-btn" data-project-id="${project.id}">View</button>
                                <button class="btn btn-danger delete-btn" data-project-id="${project.id}">Delete</button>
                            </div>
                        `;
                        projectsListContainer.appendChild(card);
                    });
                }

                // Add event listeners after cards are created
                document.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    viewProject(e.target.dataset.projectId, projects);
                }));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteProjectFromSupabase(e.target.dataset.projectId);
                }));
            }

            async function deleteProjectFromSupabase(projectId) {
                if (!confirm("Are you sure you want to delete this project? This cannot be undone.")) return;

                const {
                    error
                } = await supabase
                    .from('projects')
                    .delete()
                    .match({
                        id: projectId
                    });

                if (error) {
                    console.error("Error deleting project:", error);
                    alert("Could not delete project.");
                } else {
                    loadProjectsForUser(); // Refresh the project list
                }
            }

            function viewProject(projectId, allProjects) {
                const project = allProjects.find(p => p.id == projectId);
                if (!project) return;

                currentProjectId = project.id;
                currentTemplateId = project.inputs.templateId;

                showTemplateDetail(currentTemplateId);

                // Use a slight delay to ensure the page navigation has completed
                setTimeout(() => {
                    $('templateTitle').textContent = project.project_title;
                    $('companyName').value = project.inputs.companyName || '';
                    if ($('companyDocumentsFileLabel')) $('companyDocumentsFileLabel').textContent = "Previous documents not stored.";
                    $('location').value = project.inputs.location || '';
                    if ($('typeOfStrategy')) $('typeOfStrategy').value = project.inputs.typeOfStrategy || '';

                    $('analysisResult').innerHTML =
                        `<div class="whitespace-pre-wrap">${project.analysis_text}</div>`;
                    $('analysisActions').classList.remove('hidden');
                }, 100);
            }


            // --- Auth Logic using Supabase (NEW) ---
            async function handleLogin() {
                const email = $('loginEmail').value.trim();
                const password = $('loginPassword').value;
                const loginMessageEl = $('loginMessage');

                if (!email || !password) {
                    showMessage('loginMessage', 'Please fill in all fields', 'error');
                    return;
                }

                setLoading('login', true);
                loginMessageEl.classList.add('hidden');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showMessage('loginMessage', error.message, 'error');
                } else {
                    showMessage('loginMessage', 'Login successful! Redirecting...', 'success');
                    setTimeout(() => navigateTo('myProjects'), 1500);
                }
                setLoading('login', false);
            }

            async function handleRegister() {
                const firstName = $('registerFirstName').value.trim();
                const lastName = $('registerLastName').value.trim();
                const email = $('registerEmail').value.trim();
                const password = $('registerPassword').value;
                const confirmPassword = $('registerConfirmPassword').value;

                if (!firstName || !lastName || !email || !password || !confirmPassword) {
                    showMessage('registerMessage', 'Please fill in all fields', 'error');
                    return;
                }
                if (password !== confirmPassword) {
                    showMessage('registerMessage', 'Passwords do not match', 'error');
                    return;
                }
                if (password.length < 6) {
                    showMessage('registerMessage', 'Password must be at least 6 characters long', 'error');
                    return;
                }

                setLoading('register', true);
                try {
                    const { data, error } = await supabase.functions.invoke('create-user-v3', {
                         body: {
                            email,
                            password,
                            metadata: {
                                first_name: firstName,
                                last_name: lastName
                            }
                        }
                    });

                    if (error || !data?.user) {
                         showMessage('registerMessage', error?.message || 'User creation failed.', 'error');
                         return;
                    }
                    
                    $('registerForm').reset();
                    navigateTo('emailVerification');

                } catch (err) {
                    console.error('Register error:', err);
                    showMessage('registerMessage', 'An error occurred during registration. Please try again.', 'error');
                } finally {
                    setLoading('register', false);
                }
            }


            async function handleLogout() {
                await supabase.auth.signOut();
                navigateTo('login');
            }
            
            // --- UI Helpers ---
            function setLoading(type, isLoading) {
                const btn = $(type + 'Btn');
                const textEl = $(type + 'BtnText');
                const spinner = $(type + 'Spinner');
                if (!btn) return;

                btn.disabled = isLoading;
                if (spinner) spinner.classList.toggle('hidden', !isLoading);
                
                if(textEl) {
                    if (isLoading) {
                        textEl.textContent = 'Loading...';
                    } else {
                        if (type === "register") textEl.textContent = 'Create Account';
                        else if (type === "login") textEl.textContent = 'Sign In';
                        else textEl.textContent = 'Generate Analysis';
                    }
                }
            }


            function showMessage(id, msg, type) {
                const el = $(id);
                el.textContent = msg;
                el.className = type === 'error' ? 'error-message' : 'success-message';
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 4000);
            }

            // --- Three.js Animation Logic ---
            let scene, camera, renderer, group;
            const particlesData = [];
            let positions, colors;
            let particlesGeometry;
            let pointCloud;
            let particlePositions;
            let linesMesh;

            const NUM_PARTICLES = 1000;
            const AREA_SIZE = 3000;
            const AREA_HALF = AREA_SIZE / 2;
            const MIN_DISTANCE = 200;

            let mouseX = 0,
                mouseY = 0;

            function createCircleTexture(size, color) {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const context = canvas.getContext('2d');
                const gradient = context.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2);
                gradient.addColorStop(0, color);
                gradient.addColorStop(0.7, color);
                gradient.addColorStop(1, 'rgba(0,0,0,0)');
                context.fillStyle = gradient;
                context.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
                context.fill();
                return new THREE.CanvasTexture(canvas);
            }

            function initThreeJS() {
                const canvas = $('threeJsCanvas');
                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000);
                camera.position.z = 3000;

                scene = new THREE.Scene();
                group = new THREE.Group();
                scene.add(group);

                const particleTexture = createCircleTexture(64, 'rgba(173, 216, 230, 1)');

                const pMaterial = new THREE.PointsMaterial({
                    color: 0xFFFFFF,
                    size: 7,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    sizeAttenuation: false,
                    map: particleTexture
                });

                particlesGeometry = new THREE.BufferGeometry();
                particlePositions = new Float32Array(NUM_PARTICLES * 3);

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const x = Math.random() * AREA_SIZE - AREA_HALF;
                    const y = Math.random() * AREA_SIZE - AREA_HALF;
                    const z = Math.random() * AREA_SIZE - AREA_HALF;

                    particlePositions[i * 3] = x;
                    particlePositions[i * 3 + 1] = y;
                    particlePositions[i * 3 + 2] = z;

                    particlesData.push({
                        velocity: new THREE.Vector3(
                            (Math.random() - 0.5) * 0.5,
                            (Math.random() - 0.5) * 0.5,
                            (Math.random() - 0.5) * 0.5
                        ),
                        numConnections: 0
                    });
                }

                particlesGeometry.setDrawRange(0, NUM_PARTICLES);
                particlesGeometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3).setUsage(THREE
                    .DynamicDrawUsage));

                pointCloud = new THREE.Points(particlesGeometry, pMaterial);
                group.add(pointCloud);

                const lineGeometry = new THREE.BufferGeometry();
                positions = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);
                colors = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);

                lineGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3).setUsage(THREE
                    .DynamicDrawUsage));
                lineGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3).setUsage(THREE.DynamicDrawUsage));
                lineGeometry.computeBoundingSphere();
                lineGeometry.setDrawRange(0, 0);

                const lineMaterial = new THREE.LineBasicMaterial({
                    vertexColors: true,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    opacity: 0.4
                });

                linesMesh = new THREE.LineSegments(lineGeometry, lineMaterial);
                group.add(linesMesh);

                renderer = new THREE.WebGLRenderer({
                    canvas: canvas,
                    antialias: true,
                    alpha: true
                });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setAnimationLoop(animateThreeJS);

                window.addEventListener('resize', onWindowResize);
                window.addEventListener('mousemove', onDocumentMouseMove);
            }

            function onDocumentMouseMove(event) {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            }

            function animateThreeJS() {
                let vertexpos = 0;
                let colorpos = 0;
                let numConnected = 0;

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    particlesData[i].numConnections = 0;
                }

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const particleData = particlesData[i];
                    particlePositions[i * 3] += particleData.velocity.x;
                    particlePositions[i * 3 + 1] += particleData.velocity.y;
                    particlePositions[i * 3 + 2] += particleData.velocity.z;

                    if (particlePositions[i * 3 + 1] < -AREA_HALF || particlePositions[i * 3 + 1] > AREA_HALF)
                        particleData.velocity.y = -particleData.velocity.y;
                    if (particlePositions[i * 3] < -AREA_HALF || particlePositions[i * 3] > AREA_HALF)
                        particleData.velocity.x = -particleData.velocity.x;
                    if (particlePositions[i * 3 + 2] < -AREA_HALF || particlePositions[i * 3 + 2] > AREA_HALF)
                        particleData.velocity.z = -particleData.velocity.z;

                    for (let j = i + 1; j < NUM_PARTICLES; j++) {
                        const dx = particlePositions[i * 3] - particlePositions[j * 3];
                        const dy = particlePositions[i * 3 + 1] - particlePositions[j * 3 + 1];
                        const dz = particlePositions[i * 3 + 2] - particlePositions[j * 3 + 2];
                        const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

                        if (dist < MIN_DISTANCE) {
                            const alpha = 1.0 - dist / MIN_DISTANCE;
                            positions[vertexpos++] = particlePositions[i * 3];
                            positions[vertexpos++] = particlePositions[i * 3 + 1];
                            positions[vertexpos++] = particlePositions[i * 3 + 2];
                            positions[vertexpos++] = particlePositions[j * 3];
                            positions[vertexpos++] = particlePositions[j * 3 + 1];
                            positions[vertexpos++] = particlePositions[j * 3 + 2];

                            const lineColor = new THREE.Color(0xADD8E6);
                            colors[colorpos++] = lineColor.r * alpha;
                            colors[colorpos++] = lineColor.g * alpha;
                            colors[colorpos++] = lineColor.b * alpha;
                            colors[colorpos++] = lineColor.r * alpha;
                            colors[colorpos++] = lineColor.g * alpha;
                            colors[colorpos++] = lineColor.b * alpha;
                            numConnected++;
                        }
                    }
                }

                linesMesh.geometry.setDrawRange(0, numConnected * 2);
                linesMesh.geometry.attributes.position.needsUpdate = true;
                linesMesh.geometry.attributes.color.needsUpdate = true;
                pointCloud.geometry.attributes.position.needsUpdate = true;

                const rotationSpeed = 0.03;
                group.rotation.y += (mouseX * 0.05 - group.rotation.y) * rotationSpeed;
                group.rotation.x += (mouseY * 0.05 - group.rotation.x) * rotationSpeed;
                group.rotation.y += 0.0001;
                group.rotation.x += 0.00005;

                renderer.render(scene, camera);
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            // --- Feature Toggle Logic ---
            document.querySelectorAll('.toggle-feature-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const featureId = this.getAttribute('data-feature-id');
                    const featureDescriptionElement = this.closest('.feature-card').querySelector(
                        '.feature-description');
                    const currentState = featureDescriptionElement.getAttribute('data-state');

                    if (currentState === 'short') {
                        featureDescriptionElement.innerHTML = featureContent[featureId].long;
                        featureDescriptionElement.setAttribute('data-state', 'long');
                        this.innerHTML = 'Less &rarr;';
                    } else {
                        featureDescriptionElement.innerHTML = featureContent[featureId].short;
                        featureDescriptionElement.setAttribute('data-state', 'short');
                        this.innerHTML = 'More &rarr;';
                    }
                });
            });

            // --- AI Analysis Examples Carousel Logic ---
            let currentExampleIndex = 0;
            const analysisExamples = document.querySelectorAll('.analysis-example-item');
            const prevExampleBtn = $('prevExampleBtn');
            const nextExampleBtn = $('nextExampleBtn');
            const exampleCounter = $('exampleCounter');

            function showAnalysisExample(index) {
                analysisExamples.forEach((item, i) => {
                    item.classList.toggle('hidden', i !== index);
                });
                prevExampleBtn.disabled = index === 0;
                nextExampleBtn.disabled = index === analysisExamples.length - 1;
                exampleCounter.textContent = `${index + 1} of ${analysisExamples.length}`;
            }

            if (prevExampleBtn) {
                prevExampleBtn.addEventListener('click', () => {
                    if (currentExampleIndex > 0) {
                        currentExampleIndex--;
                        showAnalysisExample(currentExampleIndex);
                    }
                });
            }
            if (nextExampleBtn) {
                nextExampleBtn.addEventListener('click', () => {
                    if (currentExampleIndex < analysisExamples.length - 1) {
                        currentExampleIndex++;
                        showAnalysisExample(currentExampleIndex);
                    }
                });
            }
            if (analysisExamples.length > 0) {
                showAnalysisExample(currentExampleIndex);
            }
            
            // --- Frameworks Page Logic ---
            function populateFrameworksPage() {
                const grid = $('frameworksGrid');
                if(!grid || grid.dataset.populated) return;

                grid.innerHTML = '';
                Object.values(frameworksData).forEach(fw => {
                    const card = document.createElement('div');
                    card.className = 'glass-container p-6 framework-card';
                    card.innerHTML = `
                        <h3 class="text-2xl font-bold mb-2">${fw.title}</h3>
                        <div class="description-container h-24 relative overflow-hidden">
                            <p class="text-white/70 short-desc opacity-100 transition-opacity duration-300">${fw.short}</p>
                            <p class="text-white/80 long-desc absolute top-0 left-0 opacity-0 transition-opacity duration-300">${fw.long}</p>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                grid.dataset.populated = 'true';
                
                grid.querySelectorAll('.framework-card').forEach(card => {
                    card.addEventListener('mouseenter', () => {
                        card.querySelector('.short-desc').classList.remove('opacity-100');
                        card.querySelector('.short-desc').classList.add('opacity-0');
                        card.querySelector('.long-desc').classList.remove('opacity-0');
                        card.querySelector('.long-desc').classList.add('opacity-100');
                    });
                    card.addEventListener('mouseleave', () => {
                        card.querySelector('.short-desc').classList.add('opacity-100');
                        card.querySelector('.short-desc').classList.remove('opacity-0');
                        card.querySelector('.long-desc').classList.add('opacity-0');
                        card.querySelector('.long-desc').classList.remove('opacity-100');
                    });
                });
            }

            // --- Knowledge Graph Visualization Logic ---
            async function loadKnowledgeGraph() {
                const graphContainer = document.querySelector('.graph-inner')
                
                if (!graphContainer || typeof NVL === 'undefined') {
                    console.error('NVL not loaded or graph container not found.');
                    return;
                }

                // Function to fetch data from your backend
                async function fetchGraphData() {
                    try {
                        const response = await fetch('https://nlp.data2int.com/graph/knowledge-graph'); 
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const graphData = await response.json();
                        console.log("Fetched graph data:", graphData);

                        const transformedNodes = graphData.nodes.map(node => ({
                            id: String(node.id), // Ensure ID is a string
                            caption: node.properties.name || node.label,
                            labels: [String(node.label)], // NVL expects an array of labels
                            properties: node.properties ? { ...node.properties } : {} // Ensure properties is a plain object
                        }));

                        const transformedRelationships = graphData.relationships.map(rel => {
                            const relId = rel.id ? String(rel.id) : `${rel.source_id}-${rel.type}-${rel.target_id}`;
                            return {
                                id: relId,
                                from: String(rel.source_id), // Ensure IDs are strings
                                to: String(rel.target_id),   // Ensure IDs are strings
                                caption: String(rel.type),   // Ensure caption is a string
                                type: String(rel.type),
                                properties: rel.properties ? { ...rel.properties } : {} // Ensure properties is a plain object
                            };
                        });

                        return {
                            nodes: transformedNodes,
                            relationships: transformedRelationships
                        };

                    } catch (error) {
                        console.error("Error fetching graph data:", error);
                        graphContainer.innerHTML = `<p style='color: red;'>Error loading graph: ${error.message}</p>`;
                        return null; // Return null on error
                    }
                }

                const initialGraphData = await fetchGraphData();
                console.log("Graph data", initialGraphData);
                const { nodes, relationships } = initialGraphData;
                if (initialGraphData) {
                    // Pass the data to the NVL constructor
                    const visualization = new NVL(graphContainer, nodes, relationships, {
                        // Optionally specify a layout, e.g., 'forcedirected' or 'hierarchical'
                        layout: 'forcedirected'
                    });
                    console.log("Visualization:", visualization);

                    // Instantiate and add interaction handlers
                    const clickInteraction = new ClickInteraction(visualization);
                    const zoomInteraction = new ZoomInteraction(visualization);
                    const panInteraction = new PanInteraction(visualization);
                    const dragNodeInteraction = new DragNodeInteraction(visualization);
                    //const boxSelectInteraction = new BoxSelectInteraction(visualization);
                    const hoverInteraction = new HoverInteraction(visualization);

                    // Example: Add callbacks to interaction handlers
                    clickInteraction.updateCallback('onNodeClick', (node) => {
                        console.log('Node clicked', node);
                    });
                    // boxSelectInteraction.updateCallback('onBoxSelect', ({ nodes, rels }) => {
                    //     console.log('Selected elements:', nodes, rels);
                    // });
                    dragNodeInteraction.updateCallback('onDrag', (nodes) => {
                        //console.log('Dragged nodes:', nodes);
                    });
                    hoverInteraction.updateCallback('onHover', (element, hitElements, event) => {
                        //console.log('Hovered element:', element);
                    });
                    panInteraction.updateCallback('onPan', (panning) => {
                        //console.log('Panning:', panning);
                    });
                    zoomInteraction.updateCallback('onZoom', (zoomLevel) => {
                        //console.log('Zoom level:', zoomLevel);
                    });
                }
            }


            // --- Initial Setup ---
            const versionModal = $('versionChoiceModal');
            const selectFreeBtn = $('selectFreeVersion');
            const selectPaidBtn = $('selectPaidVersion');
            const closeModalBtn = $('closeModalBtn');
            
            selectFreeBtn.addEventListener('click', () => {
                currentSelectionLimit = 1;
                proceedFromModal();
            });

            selectPaidBtn.addEventListener('click', () => {
                currentSelectionLimit = 3;
                proceedFromModal();
            });

            closeModalBtn.addEventListener('click', () => {
                versionModal.classList.add('hidden');
            });

            $('loginBtn').addEventListener('click', handleLogin);
            $('registerBtn').addEventListener('click', handleRegister);
            $('generateBtn').addEventListener('click', handleGenerate);
            $('saveProjectBtn').addEventListener('click', saveProjectToSupabase);
            $('savePdfBtn').addEventListener('click', handleSaveAsPdf);
            $('saveDocxBtn').addEventListener('click', handleSaveAsDocx);
            
            document.querySelectorAll('#frameworkList .method-checkbox').forEach(cb => {
                cb.addEventListener('change', frameworkCheckboxChangeHandler);
            });
            
            if (window.location.hash.includes('access_token')) {
                 navigateTo('myProjects');
            } else {
                 navigateTo('home');
            }

            populateTemplatesList();
            initThreeJS();
        });

        window.addEventListener('beforeunload', () => {
            if (window.websocket && window.websocket.readyState === WebSocket.OPEN) {
                window.websocket.close(1000, 'Page unloading');
            }
        });
    </script>
    <script>
        // Dashboard updater: presence + query counter + server status
        (function initDashboardWidget() {
            const PRESENCE_PREFIX = 'sage_presence_';
            const HEARTBEAT_MS = 10000;
            const STALE_MS = 30000;
            const TAB_ID = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '-' + Math.random());

            function heartbeat() {
                try {
                    localStorage.setItem(PRESENCE_PREFIX + TAB_ID, String(Date.now()));
                } catch (e) {}
            }

            function cleanupStale() {
                const now = Date.now();
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(PRESENCE_PREFIX)) {
                            const ts = Number(localStorage.getItem(k) || '0');
                            if (!ts || (now - ts) > STALE_MS) localStorage.removeItem(k);
                        }
                    }
                } catch (e) {}
            }

            function countOnline() {
                const now = Date.now();
                let cnt = 0;
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(PRESENCE_PREFIX)) {
                            const ts = Number(localStorage.getItem(k) || '0');
                            if (ts && (now - ts) <= STALE_MS) cnt++;
                        }
                    }
                } catch (e) {}
                return cnt;
            }

            heartbeat();
            const hb = setInterval(() => {
                heartbeat();
                cleanupStale();
            }, HEARTBEAT_MS);
            window.addEventListener('beforeunload', () => {
                try {
                    localStorage.removeItem(PRESENCE_PREFIX + TAB_ID);
                } catch (e) {};
                clearInterval(hb);
            });

            function updateDashboard() {
                const usersEl = document.getElementById('dashUsersOnline');
                const queriesEl = document.getElementById('dashQueryCount');
                const serverDot = document.getElementById('dashServerDot');
                const serverText = document.getElementById('dashServerText');
                const wsDetail = document.getElementById('dashWsDetail');
                const wsStatusEl = document.getElementById('wsStatus');
                const updatedAt = document.getElementById('dashUpdatedAt');

                if (usersEl) usersEl.textContent = String(countOnline());
                if (queriesEl) queriesEl.textContent = String(Number(localStorage.getItem('sage_query_count') ||
                    '0'));

                let statusText = 'Unknown',
                    statusClass = 'bg-yellow-400',
                    detailText = '—';
                if (wsStatusEl) {
                    const t = wsStatusEl.textContent.trim().toLowerCase();
                    if (t.includes('connected')) {
                        statusText = 'Connected';
                        statusClass = 'bg-green-400';
                        detailText = window.websocket ? window.websocket.url : 'Connected';
                    } else if (t.includes('disconnected') || t.includes('failed') || t.includes('error')) {
                        statusText = 'Disconnected';
                        statusClass = 'bg-red-400';
                        detailText = 'Connection failed or closed.';
                    } else if (t.includes('connecting')) {
                        statusText = 'Connecting';
                        statusClass = 'bg-yellow-400';
                        detailText = 'Attempting to connect...';
                    }
                }
                if (serverText) serverText.textContent = statusText;
                if (serverDot) serverDot.className = 'inline-block w-3 h-3 rounded-full ' + statusClass;
                if (wsDetail) wsDetail.textContent = detailText;
                if (updatedAt) updatedAt.textContent = new Date().toLocaleString();
            }
            setInterval(updateDashboard, 2000);
            updateDashboard();
        })();
    </script>
</body>

</html>


