<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>S.A.G.E. - AI Strategy Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        /* --- THEME COLORS (CSS VARIABLES) --- */
        :root {
            --grad-1: #C33764;
            --grad-2: #1D2671;
            --primary: #8E2DE2;
            --primary-hover: #4A00E0;
            --accent: #C33764;
            --edge-color: #4A00E0;
            --node-color: #C33764;
        }

        /* --- Base & Animated Background --- */
        html, body {
            min-height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, var(--grad-1), var(--grad-2));
            background-size: 400% 400%;
            animation: gradientBG 18s ease infinite;
            color: #f9fafb;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex-grow: 1;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .page {
            display: none;
        }

        /* Hide all pages by default */
        .page.active {
            animation: fadeIn .5s ease-out;
        }

        /* Specific display rules for active pages */
        #home.active,
        #templates.active,
        #templateDetail.active,
        #examplesPage.active,
        #adminDashboard.active,
        #about.active {
            display: block;
            /* Content pages */
        }

        #login.active,
        #signup.active,
        #emailVerification.active {
            display: flex;
            /* Centered pages */
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        /* --- Glass & Card Effects --- */
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            transition: all .3s ease;
            text-align: center;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .template-card,
        .project-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: all .3s ease;
            cursor: pointer;
        }

        .template-card:hover,
        .project-card:hover {
            transform: translateY(-5px);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .project-card-content {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* --- Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(220, 38, 38, 0.5);
            color: #fca5a5;
        }

        .btn-danger:hover {
            background: rgba(220, 38, 38, 0.7);
            color: #fff;
        }

        .btn-tertiary {
            background: transparent;
            color: #c7d2fe;
            text-decoration: underline;
        }

        .btn-tertiary:hover {
            color: #fff;
        }

        /* --- Forms & Inputs --- */
        .input-field {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-field:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .error-message {
            color: #fca5a5;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(220, 38, 38, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .success-message {
            color: #a7f3d0;
            font-size: .875rem;
            margin-top: .5rem;
            background: rgba(5, 150, 105, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        /* --- Loading Spinners --- */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 2rem;
        }

        .typing-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            animation: typing 1.4s infinite ease-in-out
        }

        .typing-dot:nth-child(1) {
            animation-delay: -.32s
        }

        .typing-dot:nth-child(2) {
            animation-delay: -.16s
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0s
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(.8);
                opacity: .5
            }

            40% {
                transform: scale(1);
                opacity: 1
            }
        }

        /* --- Three.js Canvas Styling --- */
        #threeJsCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            display: block;
            transition: opacity 0.5s ease-in-out;
        }

        /* Carousel specific styles */
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 9999px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: background 0.3s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .carousel-button:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .carousel-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .carousel-button.left {
            left: -6rem;
        }

        .carousel-button.right {
            right: -6rem;
        }

        @media (max-width: 768px) {
            .carousel-button.left {
                left: 0.5rem;
            }

            .carousel-button.right {
                right: 0.5rem;
            }
        }

        .analysis-example-item {
            padding: 2.5rem;
            margin-bottom: 0;
        }

        .analysis-example-item h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .analysis-example-item ul,
        .analysis-example-item ol {
            list-style-position: inside;
            margin-left: 1.25rem;
            margin-bottom: 1rem;
        }

        .analysis-example-item li {
            margin-bottom: 0.5rem;
        }

        .feature-card .feature-description ul,
        .feature-card .feature-description ol,
        .feature-card .feature-description p {
            text-align: center;
        }

        /* WebSocket connection status indicator */
        .ws-status {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .ws-status.connected {
            background: rgba(5, 150, 105, 0.8);
            color: #a7f3d0;
        }

        .ws-status.disconnected {
            background: rgba(220, 38, 38, 0.8);
            color: #fca5a5;
        }

        .ws-status.connecting {
            background: rgba(245, 158, 11, 0.8);
            color: #fbbf24;
        }

        /* Glassy Checkboxes */
        .method-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .method-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
        }
        .method-checkbox:disabled + span {
            opacity: 0.5;
        }

        .method-checkbox:checked {
            background: color-mix(in srgb, var(--primary) 80%, transparent);
            border-color: color-mix(in srgb, var(--accent) 90%, transparent);
            box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 70%, transparent);
            transform: scale(1.15);
        }

        .method-checkbox:hover:not(:disabled) {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.7);
        }
        
        /* --- Custom File Input --- */
        .input-file-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .input-file {
            position: absolute;
            font-size: 50px;
            opacity: 0;
            right: 0;
            top: 0;
            cursor: pointer;
        }
        .input-file-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: .5rem;
            font-size: 1rem;
            transition: all .2s;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
        }
        .input-file-btn:hover {
             background: rgba(255, 255, 255, 0.1);
             border-color: var(--accent);
        }
        .input-file-btn.has-file {
            color: white;
            border-color: var(--accent);
            background: color-mix(in srgb, var(--primary) 20%, transparent);
        }
        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 0.5rem;
        }

        /* --- Interactive Hover for Guide Cards --- */
        #about .glass-container {
            transition: all 0.3s ease-in-out;
        }

        #about .glass-container:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Footer Styling */
        footer {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* --- Sticky Footer Override --- */
        html, body {
            min-height: 100vh !important;
        }
        body {
            display: flex !important;
            flex-direction: column !important;
        }
        .main-content {
            flex: 1 0 auto !important;
        }
        footer {
            flex-shrink: 0 !important;
            position: relative !important;
        }

        /* --- Analysis Results Tab Styling --- */
        .analysis-tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .analysis-tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }
        .analysis-tab-btn.active {
            color: white;
            font-weight: 600;
            border-bottom-color: var(--accent);
        }
        .analysis-tab-panel {
            display: none;
            padding-top: 1.5rem;
            animation: fadeIn 0.5s;
        }
        .analysis-tab-panel.active {
            display: block;
        }

        /* --- Home Page Tab Styling --- */
        .home-tab-btn {
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }
        .home-tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .home-tab-btn.active {
            color: white;
            font-weight: 600;
            border-bottom-color: var(--primary);
        }
        .home-tab-panel {
            display: none;
            animation: fadeIn 0.5s;
        }
        .home-tab-panel.active {
            display: grid;
        }

        /* SWOT Tool specific styles */
        .input-radio-group {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 0.25rem;
        }
        .input-radio-label {
            flex: 1;
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .input-radio-label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .input-radio:checked + .input-radio-label {
            background: var(--primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .input-radio {
            display: none;
        }

        /* Archetype & Factor Analysis Tool Specific Styles */
        .metric-card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
            margin-bottom: 1rem;
        }
        .metric-card.critical {
            border-left-color: #dc143c;
        }
        .metric-card.high {
            border-left-color: #ff8c00;
        }

        /* --- Strategic Map Diagram Styles --- */
        .strategy-map-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem; /* 24px */
            padding-bottom: 2rem; /* Add some padding to the bottom */
        }

        /* Generic vertical line connecting sections */
        .vertical-connector {
            width: 2px;
            background-color: rgba(255, 255, 255, 0.4);
            height: 40px; /* Standard height for connectors */
            position: relative;
        }
        /* Downward arrow head for generic connectors */
        .vertical-connector::after {
            content: '';
            position: absolute;
            left: -5px;
            bottom: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid rgba(255, 255, 255, 0.4);
        }

        /* Container for the Feedback Loops, allowing horizontal alignment */
        .feedback-loops-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 2rem; /* Spacing between loop boxes */
            width: 100%;
            max-width: 900px; /* Control max width for better readability */
        }
        @media (max-width: 768px) {
            .feedback-loops-grid {
                grid-template-columns: 1fr; /* Stack on smaller screens */
            }
        }

        /* Lines from feedback loops to interventions header */
        .lines-to-interventions {
            display: flex;
            justify-content: center;
            width: 100%;
            height: 40px; /* Space for the lines */
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        /* Line from Reinforcing Loop */
        .lines-to-interventions::before {
            content: '';
            position: absolute;
            left: 25%; /* Roughly center of the left box */
            top: 0;
            width: 2px;
            height: 100%;
            background-color: rgba(46, 139, 87, 0.6); /* Greenish for reinforcing */
        }

        /* Line from Balancing Loop */
        .lines-to-interventions::after {
            content: '';
            position: absolute;
            right: 25%; /* Roughly center of the right box */
            top: 0;
            width: 2px;
            height: 100%;
            background-color: rgba(255, 140, 0, 0.6); /* Orangish for balancing */
        }

        /* Individual initiative connection indicators */
        .initiative-target-indicator {
            position: absolute;
            top: -25px; /* Position above the card */
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem; /* Larger icon */
            line-height: 1;
        }
        /* Specific colors for indicators */
        .indicator-boost { color: #28a745; /* Bootstrap success green */ }
        .indicator-mitigate { color: #ffc107; /* Bootstrap warning yellow */ }

        /* --- Strategic Cascade Styles --- */
        .cascade-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            padding: 2rem 1rem;
        }
        .cascade-objective {
            width: 100%;
            max-width: 700px;
            text-align: center;
            padding: 1.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            border-top: 4px solid var(--primary);
        }
        .cascade-connector {
            width: 2px;
            height: 40px;
            background: rgba(255,255,255,0.3);
        }
        .cascade-goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            width: 100%;
            max-width: 1200px;
        }
        .cascade-goal-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--accent);
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .cascade-strategy {
            background: rgba(0,0,0,0.2);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

        /* --- Action Plan Timeline Styles --- */
        .action-plan-container {
            position: relative;
            padding: 2rem 0;
        }
        .action-plan-container::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            transform: translateX(-50%);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 2.5rem;
            width: 50%;
        }
        .timeline-item:nth-child(odd) {
            padding-right: 2.5rem;
            align-self: flex-start;
        }
        .timeline-item:nth-child(even) {
            padding-left: 2.5rem;
            align-self: flex-end;
        }
        .timeline-dot {
            content: '';
            position: absolute;
            top: 1rem;
            width: 20px;
            height: 20px;
            background: var(--background-dark);
            border-radius: 50%;
            border: 4px solid var(--primary);
        }
        .timeline-item:nth-child(odd) .timeline-dot {
            right: -10px;
            transform: translateX(50%);
        }
        .timeline-item:nth-child(even) .timeline-dot {
            left: -10px;
            transform: translateX(-50%);
        }
        .timeline-content {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.75rem;
        }
        .priority-high { border-left: 4px solid #dc2626; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #2563eb; }

        /* --- KPI Dashboard Styles --- */
        .kpi-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .kpi-card .kpi-name {
            font-size: 1.125rem;
            font-weight: bold;
            color: white;
        }
        .kpi-card .kpi-target {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0.5rem 0;
            line-height: 1.2;
        }
        .kpi-card .kpi-type {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.1);
            align-self: center;
        }

        /* --- Misc Tool: Risk Table Styles --- */
        .risk-pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            min-width: 80px;
        }
        .risk-level-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        .risk-level-medium {
            background-color: rgba(249, 115, 22, 0.2);
            color: #fdba74;
        }
        .risk-level-low {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        /* --- Strategic Horizons Visual Styles --- */
        .horizons-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1 / 1;
            margin: 2rem auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .horizon-circle {
            position: absolute;
            border-style: dashed;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #h3-circle { width: 100%; height: 100%; border: 2px dashed rgba(255, 255, 255, 0.2); }
        #h2-circle { width: 70%; height: 70%; border: 2px dashed rgba(255, 255, 255, 0.3); }
        #h1-circle { width: 40%; height: 40%; border: 2px dashed rgba(255, 255, 255, 0.4); }
        .horizon-label {
            position: absolute;
            top: 10px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
        }
        .main-goal-center {
            width: 33%; /* Increased size */
            height: 33%; /* Increased size */
            background: rgba(var(--primary-rgb), 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
            font-weight: bold;
            font-size: 0.9rem; /* Adjusted font size */
            z-index: 10;
        }
        .initiative-point {
            position: absolute;
            background: rgba(0,0,0,0.5);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 130px; /* Added max-width for wrapping */
            text-align: center;
        }
        .initiative-point:hover {
            transform: scale(1.1) translate(-50%, -50%); /* Adjusted for proper scaling */
            background: var(--primary);
            z-index: 20;
        }

        /* --- Regression Analysis Table Styles --- */
        .coeff-table {
            width: 100%;
            text-align: left;
            border-collapse: collapse;
        }
        .coeff-table th, .coeff-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .coeff-table th {
            font-weight: 600;
            background-color: rgba(0,0,0,0.2);
        }
        .coeff-table .significant {
            color: #6ee7b7; /* A light green for significant p-values */
            font-weight: bold;
        }

        /* --- PLS-SEM Path Diagram Styles (New Flow Method) --- */
        .path-flow-container {
            display: flex;
            justify-content: space-between;
            gap: 2rem;
            padding: 2rem;
        }
        .path-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .path-column-title {
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 1rem;
        }
        .path-node-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            width: 100%;
            text-align: center;
        }
        .path-node-card h4 {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
        }
        .path-influence-list {
            margin-top: 1rem;
            font-size: 0.9rem;
            text-align: left;
        }
        .path-influence-list strong {
            color: white;
        }
        .path-influence {
            color: rgba(255,255,255,0.7);
        }
        .path-influence.significant {
            color: var(--accent);
            font-weight: bold;
        }

        /* --- Descriptive Analysis Styles --- */
        .summary-stat-card {
            background: rgba(0,0,0,0.25);
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .summary-stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
        }
        .summary-stat-card .stat-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.8);
            margin-top: 0.5rem;
        }

        /* --- Styling for SEM Learn Tab --- */
        .styled-table {
            border-collapse: collapse;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .styled-table th,
        .styled-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .styled-table thead th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: white;
        }
        .styled-table tbody tr:last-child td {
            border-bottom: none;
        }
        .styled-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        .styled-details {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
        }
        .styled-details summary {
            padding: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 0.5rem;
        }
        .styled-details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .styled-details summary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .styled-details pre {
            white-space: pre-wrap; /* Allow syntax to wrap */
        }
        /* --- Styling for SEM Analysis Model Tab --- */
        .model-section-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 1.5rem;
            height: 100%;
        }

        /* --- Prescriptive Analysis Styles --- */
        .prescription-card {
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            border-left: 5px solid var(--primary);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .prescription-card h4 {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        .prescription-card .rationale {
            font-style: italic;
            color: rgba(255,255,255,0.8);
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
        }

        /* --- Prescriptive Analysis - Enhanced Styles --- */
        .dashboard-prescription-card {
            background: rgba(0,0,0,0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border-left: 4px solid var(--accent);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .insight-card {
            background: rgba(0,0,0,0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Regression Analysis - Enhanced Styles --- */
        .diagnostic-card {
            background: rgba(0,0,0,0.2);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .diagnostic-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }
        .diagnostic-card .stat-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.25rem;
        }
        /* --- Visualization Tool Styles --- */
        .viz-interpretation-box {
            background: rgba(0,0,0,0.2);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            border-top: 2px solid var(--primary);
        }
        /* --- System Thinking Objectives Styles --- */
        .st-dashboard-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            padding: 2rem;
        }
        .st-objective-card {
            background: rgba(var(--primary-rgb), 0.2);
            border: 1px solid var(--primary);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }
        .st-goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            position: relative;
        }
        .st-goal-card {
            background: rgba(0,0,0,0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .st-loops-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        /* --- System Thinking Actions Styles --- */
        .action-card {
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .action-card.short-term { border-left: 5px solid #f59e0b; }
        .action-card.long-term { border-left: 5px solid #2563eb; }
        
        .action-card h4 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .archetype-card {
            background: rgba(var(--primary-rgb), 0.2);
            border: 1px solid var(--primary);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }
        /* --- Creative Dissonance Styles --- */
        .dissonance-map-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            gap: 2rem;
        }
        .dissonance-pole {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .dissonance-gap {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        .dissonance-point {
            background: rgba(var(--primary-rgb), 0.2);
            border: 1px solid var(--primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
        }
        /* --- Living System Analysis Styles --- */
        .ls-dashboard-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 500px;
            padding: 2rem;
        }
        .ls-core {
            width: 200px;
            height: 200px;
            background: rgba(var(--primary-rgb), 0.3);
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }
        .ls-system-node {
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
        }
        .ls-health-robust { border-top: 4px solid #22c55e; } /* green */
        .ls-health-strained { border-top: 4px solid #f97316; } /* orange */
        .ls-health-fragile { border-top: 4px solid #ef4444; } /* red */
        /* --- Thinking System (Ladder of Inference) Styles --- */
        .ladder-container {
            display: flex;
            flex-direction: column-reverse; /* Build the ladder from the bottom up */
            align-items: center;
            gap: 0.5rem;
            padding: 2rem;
        }
        .ladder-rung {
            width: 100%;
            max-width: 600px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .ladder-rung h4 {
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .ladder-rung p {
            font-size: 1.125rem;
            font-style: italic;
            color: rgba(255,255,255,0.9);
        }
        .ladder-arrow {
            font-size: 2rem;
            color: rgba(255,255,255,0.4);
            transform: rotate(90deg);
        }

    </style>
</head>

<body>
    <div class="main-content">
        <canvas id="threeJsCanvas"></canvas>
        <div id="wsStatus" class="ws-status disconnected">Disconnected</div>

        <nav class="bg-black/10 backdrop-blur-sm p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <a href="#" class="text-2xl font-bold text-white nav-link" data-page="home">S.A.G.E.</a>
                <div>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link"
                        data-page="home">Home</a>
                    <a href="#" class="text-white/80 hover:text-white px-3 py-2 rounded-md text-sm font-medium nav-link"
                        data-page="login">Login</a>
                </div>
            </div>
        </nav>

        <div id="versionChoiceModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
            <div class="glass-container w-full max-w-lg text-center">
                <h2 class="text-3xl font-bold mb-4">Choose Your Version</h2>
                <p class="text-white/80 mb-8">Select a version to proceed with your analysis.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="selectFreeVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Free Version</h3>
                        <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Basic analysis</li>
                            <li>Select 1 of 8 frameworks</li>
                        </ul>
                    </div>
                    <div id="selectPaidVersion" class="feature-card p-6 cursor-pointer">
                        <h3 class="text-2xl font-bold mb-2">Paid Version</h3>
                         <ul class="text-white/70 list-disc list-inside text-left mx-auto max-w-xs">
                            <li>Comprehensive analysis</li>
                            <li>Select up to 3 of 8 frameworks</li>
                        </ul>
                    </div>
                </div>
                 <button id="closeModalBtn" class="btn btn-secondary mt-8">Cancel</button>
            </div>
        </div>

        <div id="home" class="page active container mx-auto px-6 py-16">
            <div class="text-center">
                <h1 class="text-5xl md:text-6xl font-extrabold text-white leading-tight mb-4">Unlock Your Strategic Potential</h1>
                <p class="text-lg md:text-xl text-white/80 max-w-3xl mx-auto mb-8">
                    Select a category to explore our comprehensive suite of strategic planning tools and methodologies.
                </p>
            </div>
            
            <div id="homeTabsNav" class="flex flex-wrap justify-center space-x-1 md:space-x-2 border-b-2 border-white/10 mt-16 mb-12">
                <button class="home-tab-btn active" data-tab="strategicPlanning">Strategic Planning</button>
                <button class="home-tab-btn" data-tab="systemThinking">System Thinking</button>
                <button class="home-tab-btn" data-tab="novelStrategies">Novel Strategies</button>
                <button class="home-tab-btn" data-tab="dataAnalysis">Data Analysis</button>
            </div>

            <div id="homeTabsContent">
                <div id="strategicPlanning" class="home-tab-panel active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="mission-vision">
                        <h3 class="text-xl font-bold mb-2">Mission Vision</h3><p class="text-white/70 text-sm">Define your organization's core purpose and future aspirations.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="factor-analysis">
                        <h3 class="text-xl font-bold mb-2">Factor Analysis</h3><p class="text-white/70 text-sm">Assess internal strengths and weaknesses & external opportunities and threats.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="swot-tows">
                        <h3 class="text-xl font-bold mb-2">Swot/Tows Analysis</h3><p class="text-white/70 text-sm">Develop strategies by matching internal factors to external factors.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="goals-initiatives">
                        <h3 class="text-xl font-bold mb-2">Goals & Strategic Initiatives</h3><p class="text-white/70 text-sm">Set high-level goals and the key initiatives to achieve them.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="objectives">
                        <h3 class="text-xl font-bold mb-2">Objectives</h3><p class="text-white/70 text-sm">Formulate specific, measurable, achievable, relevant, and time-bound objectives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="action-plans">
                        <h3 class="text-xl font-bold mb-2">Action Plans</h3><p class="text-white/70 text-sm">Detail the resources, tasks, and timelines required for execution.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="kpi-events">
                        <h3 class="text-xl font-bold mb-2">KPI & Critical Events</h3><p class="text-white/70 text-sm">Define key performance indicators and track critical milestones.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="misc-summary">
                        <h3 class="text-xl font-bold mb-2">Misc</h3><p class="text-white/70 text-sm">Compile summaries, risk assessments, governance, and conclusions.</p>
                    </div>
                </div>

                <div id="systemThinking" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="process-mapping">
                        <h3 class="text-xl font-bold mb-2">Process Mapping</h3><p class="text-white/70 text-sm">Visualize and analyze the flow of activities in a process.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="pareto-fishbone">
                        <h3 class="text-xl font-bold mb-2">Fishbone/Pareto Analysis</h3><p class="text-white/70 text-sm">Identify root causes and prioritize the most significant issues.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-thinking-analysis">
                        <h3 class="text-xl font-bold mb-2">System Thinking Analysis</h3><p class="text-white/70 text-sm">Understand the complex interconnections within your organization.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="leverage-points">
                        <h3 class="text-xl font-bold mb-2">Leverage Points</h3><p class="text-white/70 text-sm">Identify areas where small changes can yield significant results.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="archetype-analysis">
                        <h3 class="text-xl font-bold mb-2">Archetypes Analysis</h3><p class="text-white/70 text-sm">Recognize and address recurring patterns of behavior in your system.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-goals-initiatives">
                        <h3 class="text-xl font-bold mb-2">Goals/Strategic Initiatives</h3><p class="text-white/70 text-sm">Align system-level goals with broader strategic initiatives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-objectives">
                        <h3 class="text-xl font-bold mb-2">Objectives</h3><p class="text-white/70 text-sm">Define clear objectives for improving system performance.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="system-actions">
                        <h3 class="text-xl font-bold mb-2">Actions</h3><p class="text-white/70 text-sm">Outline concrete actions to implement system-level changes.</p>
                    </div>
                </div>
                
                <div id="novelStrategies" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="novel-goals-initiatives">
                        <h3 class="text-2xl font-bold mb-2">Goals & Strategic Initiatives</h3><p class="text-white/70">Define ambitious goals and innovative initiatives.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="all-framework">
                        <h3 class="text-2xl font-bold mb-2">All Framework</h3><p class="text-white/70">Access a comprehensive suite of strategic frameworks.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="creative-dissonance">
                        <h3 class="text-2xl font-bold mb-2">Creative Dissonance</h3><p class="text-white/70">Leverage the gap between vision and reality to spark innovation.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="living-system">
                        <h3 class="text-2xl font-bold mb-2">Living System</h3><p class="text-white/70">Apply principles of living systems to foster organizational adaptability.</p>
                    </div>
                    <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="thinking-system">
                        <h3 class="text-2xl font-bold mb-2">Thinking System</h3><p class="text-white/70">Develop a holistic approach to problem-solving and decision-making.</p>
                    </div>
                </div>

                <div id="dataAnalysis" class="home-tab-panel grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="descriptive-analysis"><h3 class="text-xl font-bold mb-2">Descriptive</h3><p class="text-white/70 text-sm">Summarize historical data to understand what has happened.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="predictive-analysis"><h3 class="text-xl font-bold mb-2">Predictive</h3><p class="text-white/70 text-sm">Use statistical models to forecast future outcomes.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="prescriptive-analysis"><h3 class="text-xl font-bold mb-2">Prescriptive</h3><p class="text-white/70 text-sm">Advise on possible outcomes and recommend actions.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="visualization"><h3 class="text-xl font-bold mb-2">Visualization</h3><p class="text-white/70 text-sm">Create graphical representations of data for insights.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="regression-analysis"><h3 class="text-xl font-bold mb-2">Regression</h3><p class="text-white/70 text-sm">Model relationships between variables for prediction.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="pls-analysis"><h3 class="text-xl font-bold mb-2">PLS</h3><p class="text-white/70 text-sm">Apply Partial Least Squares for structural equation modeling.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="sem-analysis"><h3 class="text-xl font-bold mb-2">SEM</h3><p class="text-white/70 text-sm">Structural Equation Modeling for complex variable relationships.</p></div>
                     <div class="feature-card p-6 home-template-link cursor-pointer" data-template-id="dematel-analysis"><h3 class="text-xl font-bold mb-2">DEMATEL</h3><p class="text-white/70 text-sm">Understand causal relationships between complex factors.</p></div>
                </div>
            </div>
        </div>
        
        <div id="about" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">How to Use S.A.G.E.</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">A Step-by-Step Guide to Unleashing Your Strategic Potential</p>
            <div class="max-w-4xl mx-auto space-y-8">
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 1:</span> Get Started (Login/Sign Up)</h3>
                    <p class="text-white/80">To unlock the full power of S.A.G.E., including saving your projects and using premium templates, you'll need an account. Click the "Login" button in the navigation bar. If you're new, you can create an account in just a few clicks.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 2:</span> Choose Your Template</h3>
                    <p class="text-white/80">From the Home page, browse through the categories like "Strategic Plans" or "Frameworks". Select the template that best fits your objective by clicking on its card.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 3:</span> Select Your Version</h3>
                    <p class="text-white/80">After choosing a template, a modal will appear. You can select the "Free Version" for a basic analysis using one framework, or the "Paid Version" to conduct a more comprehensive analysis with up to three different frameworks.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 4:</span> Provide Context & Select Options</h3>
                    <p class="text-white/80">On the template detail page, fill in the required information, such as your company name and upload your company documents. This context is crucial for the AI to generate a relevant analysis. Below the inputs, select your desired analysis sections and analytical framework(s).</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 5:</span> Generate & Review Your Analysis</h3>
                    <p class="text-white/80">Click the "Generate Analysis" button. S.A.G.E.'s AI will process your inputs and selected frameworks, which may take a few minutes. The complete, structured analysis will appear in the results panel on the right side of the screen.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-2xl font-bold mb-2"><span class="text-indigo-300">Step 6:</span> Save & Export Your Work</h3>
                    <p class="text-white/80">Once your analysis is generated, action buttons will appear below the result. You can export the analysis as a PDF or DOCX file for easy sharing and integration into your reports.</p>
                </div>
            </div>
        </div>

        <div id="login" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Sign In</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="loginEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="loginEmail" class="input-field" placeholder="Enter your email" required>
                        </div>
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="loginPassword" class="input-field" placeholder="Enter your password"
                                required>
                        </div>
                        <button id="loginBtn" class="btn btn-primary w-full">
                            <span id="loginBtnText">Sign In</span>
                            <span id="loginSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="loginMessage" class="hidden"></div>
                    </div>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Don't have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="signup">Create Account</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="signup" class="page flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Create Account</h2>
                    <form id="registerForm" class="space-y-4">
                        <div>
                            <label for="registerFirstName" class="block text-sm font-medium text-gray-200 mb-2">First
                                Name</label>
                            <input type="text" id="registerFirstName" class="input-field"
                                placeholder="Enter your First Name" required>
                        </div>
                        <div>
                            <label for="registerLastName" class="block text-sm font-medium text-gray-200 mb-2">Last
                                Name</label>
                            <input type="text" id="registerLastName" class="input-field" placeholder="Enter your Last Name"
                                required>
                        </div>
                        <div>
                            <label for="registerEmail" class="block text-sm font-medium text-gray-200 mb-2">Email</label>
                            <input type="email" id="registerEmail" class="input-field" placeholder="Enter your email"
                                required>
                        </div>
                        <div>
                            <label for="registerPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Password</label>
                            <input type="password" id="registerPassword" class="input-field" placeholder="Create a password"
                                required>
                        </div>
                        <div>
                            <label for="registerConfirmPassword"
                                class="block text-sm font-medium text-gray-200 mb-2">Confirm Password</label>
                            <input type="password" id="registerConfirmPassword" class="input-field"
                                placeholder="Confirm your password" required>
                        </div>
                        <button type="button" id="registerBtn" class="btn btn-primary w-full">
                            <span id="registerBtnText">Create Account</span>
                            <span id="registerSpinner" class="loading-spinner hidden ml-2"></span>
                        </button>
                        <div id="registerMessage" class="hidden"></div>
                    </form>
                    <div class="text-center mt-6">
                        <p class="text-gray-300">Already have an account?</p>
                        <button class="btn-tertiary nav-link" data-page="login">Sign In</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="emailVerification" class="page flex-col items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <div class="glass-container text-center">
                    <h2 class="text-3xl font-bold mb-6 text-white">Check Your Email</h2>
                    <p class="text-white/80 mb-6">Thank you for registering! We've sent a verification link to your email address. Please check your inbox and click the link to complete your registration.</p>
                    <p class="text-white/60 text-sm mb-6">Don't forget to check your spam folder.</p>
                    <div class="text-center">
                        <button class="btn-tertiary nav-link" data-page="login">Return to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="templateDetail" class="page container mx-auto px-6 py-16">
            <button class="btn btn-secondary mb-8 nav-link" data-page="home">&larr; Back to Home</button>
            <div id="templateDetailContent" class="grid lg:grid-cols-2 gap-12">
                </div>
        </div>

        <div id="adminDashboard" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">Admin Dashboard</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">Live analytics for S.A.G.E.</p>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Users Online</h3>
                    <p id="dashUsersOnline" class="text-4xl font-bold"></p>
                    <p class="text-white/60 text-sm mt-2">Approximate active visitors.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Total Queries</h3>
                    <p id="dashQueryCount" class="text-4xl font-bold">0</p>
                    <p class="text-white/60 text-sm mt-2">From live database stats.</p>
                </div>
                <div class="glass-container">
                    <h3 class="text-xl font-semibold mb-2">Server Status</h3>
                    <div class="flex items-center gap-3">
                        <span id="dashServerDot" class="inline-block w-3 h-3 rounded-full bg-yellow-400"></span>
                        <span id="dashServerText">Checking</span>
                    </div>
                    <p class="text-white/60 text-sm mt-2">Reflects WebSocket connection.</p>
                </div>
            </div>

            <div class="glass-container mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Live Database Statistics</h3>
                    <button id="refreshStatsBtn" class="btn btn-primary">
                        <span id="refreshStatsBtnText">Refresh Stats</span>
                        <span id="refreshStatsSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                </div>

                <div id="statisticsContainer" class="grid md:grid-cols-2 gap-x-8 gap-y-4 text-white/90">
                    <div>
                        <h4 class="text-xl font-semibold mb-3 border-b border-white/20 pb-2">Database Status</h4>
                        <ul class="space-y-2">
                            <li><strong>Total Users:</strong> <span id="statTotalUsers"></span></li>
                            <li><strong>Active Users (1h):</strong> <span id="statActiveUsers"></span></li>
                            <li><strong>Total Queries:</strong> <span id="statTotalQueries"></span></li>
                            <li><strong>Database Size:</strong> <span id="statDbSize"></span></li>
                            <li><strong>Avg. Processing Time:</strong> <span id="statAvgTime"></span></li>
                            <li><strong>Last Recorded:</strong> <span id="statRecordedAt"></span></li>
                        </ul>
                    </div>
                    <div id="pineconeStatsContainer" class="hidden">
                        <h4 class="text-xl font-semibold mb-3 border-b border-white/20 pb-2">Vector Store Status</h4>
                        <ul class="space-y-2">
                            <li><strong>Index Name:</strong> <span id="statPineconeName"></span></li>
                            <li><strong>Total Vectors:</strong> <span id="statTotalVectors"></span></li>
                            <li><strong>Book Vectors:</strong> <span id="statBookVectors"></span></li>
                            <li><strong>Dimension:</strong> <span id="statPineconeDimension"></span></li>
                            <li><strong>Status:</strong> <span id="statPineconeStatus"></span></li>
                            <li><strong>Cloud/Region:</strong> <span id="statPineconeCloud"></span></li>
                        </ul>
                    </div>
                </div>
                <div id="statsMessage" class="hidden mt-4"></div>
            </div>
        </div>

        <div id="examplesPage" class="page container mx-auto px-6 py-16">
            <h1 class="text-4xl font-bold text-center mb-2">AI Analysis Examples</h1>
            <p class="text-lg text-white/80 text-center mb-12 max-w-2xl mx-auto">See how S.A.G.E. can transform complex data
                into actionable strategic insights with these example outputs.</p>

            <div id="analysisCarousel" class="relative max-w-4xl mx-auto glass-container p-0">
                <div class="analysis-example-item">
                    <h2 class="text-3xl font-bold mb-4">Example: SWOT Analysis for "GlobalTech Solutions"</h2>
                    <div class="text-white/70">
                        <h3>STRENGTHS:</h3>
                        <ul>
                            <li><strong>Strong R&D Department:</strong> GlobalTech consistently innovates, holding numerous
                                patents in AI and quantum computing.</li>
                            <li><strong>Global Presence:</strong> Established offices and client base across North America,
                                Europe, and Asia.</li>
                            <li><strong>Talented Workforce:</strong> Highly skilled engineers and data scientists, fostering
                                a culture of excellence.</li>
                        </ul>

                        <h3>WEAKNESSES:</h3>
                        <ul>
                            <li><strong>High Operating Costs:</strong> Extensive R&D and global infrastructure lead to
                                significant overheads.</li>
                            <li><strong>Limited Marketing Reach:</strong> Reliance on word-of-mouth and niche industry
                                events, missing broader market segments.</li>
                            <li><strong>Bureaucratic Processes:</strong> Slow decision-making due to multi-layered approval
                                systems.</li>
                        </ul>

                        <h3>OPPORTUNITIES:</h3>
                        <ul>
                            <li><strong>Emerging Markets:</strong> Untapped potential in developing economies for AI-driven
                                solutions.</li>
                            <li><strong>Strategic Partnerships:</strong> Collaboration with hardware manufacturers to integrate
                                    AI software.</li>
                            <li><strong>Government Grants:</strong> Increased funding for AI research and development
                                initiatives.</li>
                        </ul>

                        <h3>THREATS:</h3>
                        <ul>
                            <li><strong>Intense Competition:</strong> Rapidly evolving tech landscape with new startups and
                                established giants.</li>
                            <li><strong>Talent Drain:</strong> High demand for skilled AI professionals leading to
                                competitive recruitment.</li>
                            <li><strong>Regulatory Changes:</strong> Evolving data privacy and AI ethics regulations
                                impacting product development.</li>
                        </ul>

                        <h3>Strategic Recommendations:</h3>
                        <ol>
                            <li><strong>Optimize Cost Structure:</strong> Implement agile methodologies to reduce R&D cycle
                                times and explore automation in operational processes.</li>
                            <li><strong>Expand Marketing Channels:</strong> Invest in digital marketing and content strategy
                                to reach a wider audience and enhance brand visibility.</li>
                            <li><strong>Forge Key Alliances:</strong> Actively pursue partnerships with complementary
                                technology providers to expand market reach and product offerings.</li>
                        </ol>
                    </div>
                </div>

                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Market Entry Strategy for "EcoCycle Innovations" into
                        Southeast Asia</h2>
                    <div class="text-white/70">
                        <h3>MARKET ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Market Size & Growth:</strong> Southeast Asia's recycling and waste management
                                market is projected to grow at a CAGR of 8% over the next five years, driven by increasing
                                environmental awareness and government initiatives.</li>
                            <li><strong>Customer Segments:</strong> Key segments include industrial waste generators,
                                municipal waste facilities, and commercial enterprises seeking sustainable solutions.</li>
                            <li><strong>Market Maturity:</strong> Varies by country; Singapore and Malaysia are more mature,
                                while Vietnam and Indonesia are emerging.</li>
                        </ul>

                        <h3>COMPETITIVE LANDSCAPE:</h3>
                        <ul>
                            <li><strong>Key Players:</strong> Dominated by local players with strong government ties and a
                                few international waste management giants.</li>
                            <li><strong>Competitive Advantages:</strong> Local players often have lower operational costs
                                and established networks. EcoCycle's advanced waste-to-energy technology offers a unique
                                value proposition.</li>
                        </ul>

                        <h3>ENTRY STRATEGY OPTIONS:</h3>
                        <ol>
                            <li><strong>Joint Venture (JV) with Local Partner:</strong> Recommended approach. A JV allows
                                EcoCycle to leverage local expertise, navigate regulatory complexities, and gain immediate
                                market access.
                                <ul>
                                    <li><strong>Pros:</strong> Reduced risk, faster market penetration, access to local
                                        networks.</li>
                                    <li><strong>Cons:</strong> Potential for cultural clashes, profit sharing.</li>
                                </ul>
                            </li>
                            <li><strong>Greenfield Investment:</strong> Building new facilities.
                                <ul>
                                    <li><strong>Pros:</strong> Full control, tailor-made operations.</li>
                                    <li><strong>Cons:</strong> High capital investment, long lead times, significant
                                        regulatory hurdles.</li>
                                </ul>
                            </li>
                        </ol>

                        <h3>Implementation Roadmap:</h3>
                        <ul>
                            <li><strong>Phase 1 (Months 1-6):</strong> Partner identification and due diligence. Focus on
                                countries with favorable regulatory environments (e.g., Malaysia, Thailand).</li>
                            <li><strong>Phase 2 (Months 7-18):</strong> JV formation and pilot project initiation. Secure
                                initial contracts with industrial clients.</li>
                            <li><strong>Phase 3 (Months 19-36):</strong> Scale operations, expand service offerings, and explore
                                    opportunities in other SEA markets.</li>
                        </ul>
                    </div>
                </div>

                <div class="analysis-example-item hidden">
                    <h2 class="text-3xl font-bold mb-4">Example: Digital Transformation Roadmap for "RetailX"</h2>
                    <div class="text-white/70">
                        <h3>VISION & OBJECTIVES:</h3>
                        <ul>
                            <li><strong>Vision:</strong> To become a leading omnichannel retailer, leveraging digital
                                technologies to enhance customer experience, optimize operations, and drive sustainable
                                growth.</li>
                            <li><strong>Objectives:</strong> Increase online sales by 30% within 2 years, reduce operational
                                costs by 15% through automation, and improve customer satisfaction scores by 20%.</li>
                        </ul>

                        <h3>CURRENT STATE ASSESSMENT:</h3>
                        <ul>
                            <li><strong>Digital Capabilities:</strong> Fragmented legacy systems, limited e-commerce
                                capabilities, manual inventory management.</li>
                            <li><strong>Pain Points:</strong> Inconsistent customer experience across channels, inefficient
                                supply chain, lack of real-time data for decision-making.</li>
                        </ul>

                        <h3>KEY PILLARS OF TRANSFORMATION:</h3>
                        <ol>
                            <li><strong>Customer Experience:</strong> Unify online and offline channels, personalize
                                customer journeys.</li>
                            <li><strong>Operational Efficiency:</strong> Automate back-office processes, optimize supply
                                chain.</li>
                            <li><strong>Data & Analytics:</strong> Implement robust data infrastructure, leverage AI for
                                insights.</li>
                            <li><strong>Culture & Talent:</strong> Foster digital-first mindset, upskill workforce.</li>
                        </ol>

                        <h3>INITIATIVES & TECHNOLOGIES:</h3>
                        <ul>
                            <li><strong>Customer Experience:</strong> CRM implementation (Salesforce), E-commerce platform
                                upgrade (Shopify Plus), AI-powered chatbots.</li>
                            <li><strong>Operational Efficiency:</strong> ERP system integration (SAP), Warehouse Management
                                System (WMS), Robotic Process Automation (RPA) for routine tasks.</li>
                            <li><strong>Data & Analytics:</strong> Data Lake/Warehouse (Snowflake), Business Intelligence
                                tools (Tableau), Predictive Analytics.</li>
                            <li><strong>Culture & Talent:</strong> Digital literacy training, change management programs.</li>
                        </ul>

                        <h3>PHASED IMPLEMENTATION PLAN:</h3>
                        <ul>
                            <li><strong>Short-term (0-6 months):</strong> CRM implementation, basic e-commerce upgrade,
                                pilot RPA for finance.</li>
                            <li><strong>Mid-term (6-18 months):</strong> Full ERP integration, advanced e-commerce features,
                                initial data lake setup, comprehensive digital training.</li>
                            <li><strong>Long-term (18+ months):</strong> AI-driven personalization, predictive supply chain,
                                expansion into new digital services.</li>
                        </ul>

                        <h3>MEASUREMENT & KPIs:</h3>
                        <ul>
                            <li>Online Conversion Rate, Customer Lifetime Value, Order Fulfillment Time, Inventory Accuracy,
                                Employee Digital Proficiency.</li>
                        </ul>
                    </div>
                </div>

                <button id="prevExampleBtn" class="carousel-button left">&larr;</button>
                <button id="nextExampleBtn" class="carousel-button right">&rarr;</button>
            </div>
            <div class="text-center text-white/80 mt-4">
                <span id="exampleCounter">1 of 3</span>
            </div>

            <div class="text-center mt-12">
                 <button class="btn btn-primary nav-link" data-page="home">Back to Tools</button>
            </div>
        </div>

    </div>

    <footer class="mt-auto py-8">
        <div class="container mx-auto text-center text-white/70">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="hover:text-white nav-link" data-page="about">About</a>
                <a href="#" class="hover:text-white nav-link" data-page="adminDashboard">Admin Dashboard</a>
            </div>
            <p>&copy; 2025 S.A.G.E. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // =========================================================
        // SCRIPT
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {

            // --- Supabase Configuration ---
            const SUPABASE_URL = 'https://supabase.data2int.com'
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNjQwOTk1MjAwLCJleHAiOjE5NTYzNTUyMDB9.KHXKQpsN6MNB08H_IPxP4Gh0gjcsvXG9IeJuK3XpnAU'

            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

            // --- DOM Element References ---
            const $ = id => document.getElementById(id);
            const pages = document.querySelectorAll('.page');
            let currentTemplateId = null; 
            let websocket = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            const reconnectDelay = 3000; 
            let pendingAnalysisRequests = new Map()

            // --- User Session State ---
            let userLoggedIn = false; 
            let currentUser = null;

            // --- Version Control State ---
            let currentSelectionLimit = 3; // Default to paid
            let selectedTemplateForModal = null;
            let preFillData = ''; // Used to pass context from home card to template detail
            
            // --- Analysis Cache ---
            const analysisCache = {};

            // --- Template Data ---
            const templates = {
                'custom-template': {
                    title: 'Custom Strategy Generator',
                    description: 'Design your own strategic analysis by defining the type of strategy, company, and location.',
                    isPremium: true,
                },
                'vision-mission-goals': {
                    title: 'Vision & Mission Planning',
                    description: 'A unified tool to define your organization\'s guiding purpose, future state, and core goals.',
                },
                'swot': {
                    title: 'SWOT Analysis',
                    description: "Analyze your organization's Strengths, Weaknesses, Opportunities, and Threats.",
                },
                'swot-tows': {
                    title: 'SWOT/TOWS Analysis',
                    description: 'Develop strategies by matching internal factors (Strengths, Weaknesses) to external factors (Opportunities, Threats).',
                },
                'pareto-fishbone': {
                    title: 'Pareto & Fishbone Analysis',
                    description: 'A combined approach to identify the root causes of problems (Fishbone) and prioritize them based on impact (Pareto).'
                },
                'external-analysis': {
                    title: 'External Analysis',
                    description: 'Analyze the external environment (market, competition, trends) to identify opportunities and threats.'
                },
                'internal-analysis': {
                    title: 'Internal Analysis',
                    description: 'Evaluate your organization\'s internal strengths and weaknesses in resources, capabilities, and core competencies.'
                },
                 'advanced-system-analysis': { 
                    title: 'Advanced System Analysis', 
                    description: 'Model complex systems to understand interdependencies, feedback loops, and high-leverage intervention points.' 
                },
                'archetype-analysis': {
                    title: 'Archetype Analysis',
                    description: 'Identify and analyze recurring patterns of behavior (archetypes) within your system or market.'
                },
                'creative-dissonance': {
                    title: 'Creative Dissonance Analysis',
                    description: 'Explore the gap between your current reality and desired future to fuel innovation and strategic change.'
                },
                'reframing-thinking': {
                    title: 'Reframing Thinking Analysis',
                    description: 'Apply the reframing technique to look at problems from new perspectives and unlock creative solutions.'
                },
                'delphi-method': {
                    title: 'Delphi Method Analysis',
                    description: 'Utilize the Delphi method to gather and synthesize expert opinions for forecasting and decision-making.'
                },
                'blue-ocean': {
                    title: 'Blue Ocean Strategy',
                    description: 'Focuses on creating uncontested market space rather than competing in existing industries.'
                },
                'design-thinking': {
                    title: 'Design Thinking',
                    description: 'A human-centered, iterative process for creative problem-solving and innovation.'
                },
                'thinking-hats': {
                    title: 'Thinking Hats Analysis',
                    description: 'Apply Edward de Bono\'s system for parallel thinking to explore an issue comprehensively.'
                },
                 'scamper': {
                    title: 'SCAMPER Analysis',
                    description: 'A creative thinking technique using seven prompts (Substitute, Combine, Adapt, Modify, Put to another use, Eliminate, Reverse) to innovate.'
                },
                'triz': {
                    title: 'TRIZ Analysis',
                    description: 'A systematic approach based on the study of global patent patterns to find innovative solutions to technical problems.'
                },
                'regression-analysis': { 
                    title: 'Regression Analysis', 
                    description: 'Use statistical regression to model and analyze the relationships between variables for predictive insights.' 
                },
                'pls-analysis': { 
                    title: 'PLS Analysis', 
                    description: 'Apply Partial Least Squares (PLS) for structural equation modeling, especially with complex models and non-normal data.' 
                },
                'dematel-analysis': {
                    title: 'Dematel Analysis',
                    description: 'Understand causal relationships between complex factors to identify core problems and effective leverage points.'
                },
                'competitor': {
                    title: 'Competitor Analysis',
                    description: 'Deep dive into competitor strategies, market positioning, and competitive advantages.',
                },
                'market-entry': {
                    title: 'Market Entry Strategy',
                    description: 'Evaluate market opportunities, entry barriers, and develop a roadmap for market penetration.',
                },
                'risk': {
                    title: 'Risk Assessment',
                    description: 'Identify, evaluate, and develop mitigation strategies for business risks.',
                },
                'business-model': {
                    title: 'Business Model Canvas',
                    description: 'Design and analyze your business model using the proven 9-building-block framework.',
                },
                'digital-transformation': {
                    title: 'Digital Transformation Roadmap',
                    description: 'Plan your organization\'s journey towards digital maturity.',
                },
            };

            // --- Template UI Rules ---
            const templateRules = {
                'thinking-system': { useThinkingSystemLayout_NS: true },
                'sem-analysis': { useSemAnalysisLayout: true },
                'living-system': { useLivingSystemLayout_NS: true },
                'creative-dissonance': { useCreativeDissonanceLayout_NS: true },
                'system-actions': { useSystemActionsLayout_ST: true },
                'system-objectives': { useSystemObjectivesLayout_ST: true },
                'descriptive-analysis': { useDescriptiveLayout_DA: true },
                'visualization': { useVisualizationLayout_DA: true },
                'pls-analysis': { usePlsLayout_DA: true },
                'mission-vision': { hideAnalysisSection: true, hideFrameworks: true },
                'regression-analysis': { useRegressionLayout_DA: true },
                'novel-goals-initiatives': { useNovelGoalsLayout_NS: true },
                'misc-summary': { useMiscLayout_MSC: true },
                'kpi-events': { useKpiLayout_KE: true },
                'action-plans': { useActionPlansLayout_AP: true },
                'objectives': { hideAnalysisSection: true, hideFrameworks: true },
                'goals-initiatives': { useGoalsAndInitiativesLayout_SP: true },
                'swot': { hideAnalysisSection: true },
                'objectives': { hideAnalysisSection: true, hideFrameworks: true },
                'swot-tows': { useSwotLayout: true },
                'leverage-points': { useLeveragePointsLayout: true },
                'system-goals-initiatives': { useSystemGoalsLayout: true },
                'archetype-analysis': { useArchetypeLayout: true },
                'factor-analysis': { useFactorAnalysisLayout: true },
                'process-mapping': { useProcessMappingLayout: true },
                'system-thinking-analysis': { useSystemThinkingLayout: true },
                'competitor': { hideAnalysisSection: true },
                'market-entry': { hideAnalysisSection: true },
                'risk': { hideAnalysisSection: true },
                'pareto-fishbone': { useParetoLayout: true, hideAnalysisSection: true, hideFrameworks: true },
                'external-analysis': { hideAnalysisSection: true },
                'internal-analysis': { hideAnalysisSection: true },
                'prescriptive-analysis': { usePrescriptiveLayout_DA: true },
                'dematel-analysis': { hideAnalysisSection: true },
                'digital-transformation': { hideAnalysisSection: true },
                'delphi-method': { preselectFramework: 'Delphi Method', hideAnalysisSection: true },
                'blue-ocean': { preselectFramework: 'Blue Ocean Strategy', hideAnalysisSection: true },
                'design-thinking': { preselectFramework: 'Design Thinking', hideAnalysisSection: true },
                'thinking-hats': { preselectFramework: 'Thinking Hats', hideAnalysisSection: true },
                'business-model': { preselectFramework: 'Business Model Canvas', hideAnalysisSection: true },
                'scamper': { preselectFramework: 'SCAMPER', hideAnalysisSection: true },
                'triz': { preselectFramework: 'TRIZ (Theory of Inventive Problem Solving)', hideAnalysisSection: true },
                'reframing-thinking': { preselectFramework: 'Reframing Thinking', hideAnalysisSection: true },
            };

            // WebSocket Management Functions
            function initializeWebSocket() {
                const wsStatus = document.getElementById('wsStatus');

                try {
                    websocket = new WebSocket('wss://n8n-api.data2int.com/ws');

                    wsStatus.textContent = 'Connecting...';
                    wsStatus.className = 'ws-status connecting';

                    websocket.onopen = function (event) {
                        console.log('WebSocket connected successfully');
                        wsStatus.textContent = 'Connected';
                        wsStatus.className = 'ws-status connected';
                        reconnectAttempts = 0;
                    };

                    websocket.onmessage = function (event) {
                        console.log('Received WebSocket message:', event.data);

                        try {
                            const data = JSON.parse(event.data);
                            handleWebSocketMessage(data);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };

                    websocket.onclose = function (event) {
                        console.log('WebSocket connection closed:', event.code, event.reason);
                        wsStatus.textContent = 'Disconnected';
                        wsStatus.className = 'ws-status disconnected';

                        if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                            setTimeout(() => {
                                reconnectAttempts++;
                                console.log(`WebSocket reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                                initializeWebSocket();
                            }, reconnectDelay);
                        }
                    };

                    websocket.onerror = function (error) {
                        console.error('WebSocket error:', error);
                        wsStatus.textContent = 'Error';
                        wsStatus.className = 'ws-status disconnected';
                    };

                } catch (error) {
                    console.error('Failed to initialize WebSocket:', error);
                    wsStatus.textContent = 'Failed';
                    wsStatus.className = 'ws-status disconnected';
                }
            }
            
            // --- DOCX Export Logic ---
            async function handleSaveAsDocx(filename = "SAGE_Analysis.docx") {
                const { Document, Packer, Paragraph, TextRun, ImageRun } = window.docx;

                const analysisResult = $('analysisResult');
                if (!analysisResult || analysisResult.innerText.includes("Your generated analysis will appear here.")) {
                    alert("No analysis to save.");
                    return;
                }

                const paragraphs = [];
                
                const textContentEl = analysisResult.querySelector("#analysisContent");
                if (textContentEl) {
                    textContentEl.innerText.split('\n').forEach(line => {
                         paragraphs.push(new Paragraph({ children: [new TextRun(line)] }));
                    });
                } else {
                     analysisResult.innerText.split('\n').forEach(line => {
                         paragraphs.push(new Paragraph({ children: [new TextRun(line)] }));
                    });
                }
                
                const children = [...paragraphs];

                const fishboneImgEl = document.getElementById("fishbone_img");
                if (fishboneImgEl && fishboneImgEl.src.startsWith('data:image')) {
                    const base64Data = fishboneImgEl.src.split(",")[1];
                    children.push(new Paragraph({ children: [new ImageRun({ 
                        data: Uint8Array.from(atob(base64Data), c => c.charCodeAt(0)), 
                        transformation: { width: 600, height: 400 } 
                    })] }));
                }

                const paretoChartEl = document.getElementById("paretoChartContainer");
                if (paretoChartEl && window.Plotly) {
                    try {
                        const dataUrl = await Plotly.toImage(paretoChartEl, {format: 'png', width: 800, height: 500});
                        const base64Data = dataUrl.split(",")[1];
                        children.push(new Paragraph({ children: [new ImageRun({ 
                            data: Uint8Array.from(atob(base64Data), c => c.charCodeAt(0)), 
                            transformation: { width: 600, height: 375 } 
                        })] }));
                    } catch(e) {
                        console.error("Could not export Plotly chart to image:", e);
                    }
                }
                
                const doc = new Document({
                    sections: [{ properties: {}, children: children }]
                });

                const blob = await Packer.toBlob(doc);
                saveAs(blob, filename);
            }

            // --- PDF Save Logic ---
            function handleSaveAsPdf() {
                if (!window.jspdf || !window.jspdf.jsPDF) return alert('PDF library not loaded.');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    unit: "pt",
                    format: "a4"
                });

                const targetEl = $("analysisResult");
                if (!targetEl) {
                    alert("Nothing to export.");
                    return;
                }

                const content = targetEl.innerText || "";
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const marginL = 40,
                    marginR = 40,
                    marginT = 60,
                    marginB = 60;
                const maxLineWidth = pageWidth - marginL - marginR;
                const lineHeight = 16;

                doc.setFont("Helvetica", "normal");
                doc.setFontSize(12);

                const lines = doc.splitTextToSize(content, maxLineWidth);
                let cursorY = marginT;
                lines.forEach(line => {
                    if (cursorY > pageHeight - marginB) {
                        doc.addPage();
                        cursorY = marginT;
                    }
                    doc.text(line, marginL, cursorY);
                    cursorY += lineHeight;
                });
                doc.save("SAGE_Analysis.pdf");
            }

            // Initialize WebSocket connection
            initializeWebSocket();

            // --- Session Management ---
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    userLoggedIn = true;
                    currentUser = session.user;
                } else if (event === 'SIGNED_OUT') {
                    userLoggedIn = false;
                    currentUser = null;
                }
                updateNavBar();
            });

            // --- Navigation Logic ---
            function navigateTo(pageId) {
                pages.forEach(page => {
                    page.classList.remove('active', 'flex', 'block');
                    page.style.display = 'none';
                });

                const targetPage = $(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    if (['home', 'templates', 'templateDetail', 'examplesPage', 'adminDashboard', 'about'].includes(pageId)) {
                        targetPage.style.display = 'block';
                    } else {
                        targetPage.style.display = 'flex';
                    }

                    if (pageId === 'adminDashboard') {
                        fetchAndDisplayStatistics();
                    }
                    window.scrollTo(0, 0);
                }
            }

            // --- Update Navigation Bar Links ---
            function updateNavBar() {
                const loginLink = document.querySelector('a[data-page="login"], a[data-page="logout"]');

                if (userLoggedIn) {
                    if (loginLink) {
                        loginLink.textContent = 'Logout';
                        loginLink.setAttribute('data-page', 'logout');
                    }
                } else {
                    if (loginLink) {
                        loginLink.textContent = 'Login';
                        loginLink.setAttribute('data-page', 'login');
                    }
                }
                attachNavLinkListeners();
            }

            // --- Attach Navigation Link Listeners ---
            function attachNavLinkListeners() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.removeEventListener('click', handleNavLinkClick);
                    link.addEventListener('click', handleNavLinkClick);
                });
            }

            function handleNavLinkClick(e) {
                e.preventDefault();
                const pageId = this.getAttribute('data-page');

                if (pageId === 'logout') {
                    handleLogout();
                    return;
                }

                if (pageId === 'templates') {
                    navigateTo('home');
                    return;
                }

                if ((pageId === 'login' || pageId === 'signup') && userLoggedIn) {
                    navigateTo('home');
                    return;
                }
                navigateTo(pageId);
            }
            
            // --- Admin Dashboard Stats Logic ---
            const refreshStatsBtn = $('refreshStatsBtn');
            if (refreshStatsBtn) {
                refreshStatsBtn.addEventListener('click', fetchAndDisplayStatistics);
            }

            async function fetchAndDisplayStatistics() {
                if (!userLoggedIn) {
                    showMessage('statsMessage', 'You must be logged in to refresh statistics.', 'error');
                    return;
                }

                const btn = $('refreshStatsBtn');
                const textEl = $('refreshStatsBtnText');
                const spinner = $('refreshStatsSpinner');
                
                btn.disabled = true;
                spinner.classList.remove('hidden');
                textEl.textContent = 'Loading...';
                showMessage('statsMessage', '', 'success');

                try {
                    const { data, error } = await supabase.functions.invoke('statistics', {
                        body: { update: true },
                    });

                    if (error) {
                        throw error;
                    }

                    if (data && data.success) {
                        const dbStatus = data.database_status;
                        if (dbStatus) {
                            $('statTotalUsers').textContent = dbStatus.total_users ?? 'N/A';
                            $('statActiveUsers').textContent = dbStatus.log_in_users ?? 'N/A';
                            $('statTotalQueries').textContent = dbStatus.total_queries ?? 'N/A';
                            $('dashQueryCount').textContent = dbStatus.total_queries ?? '0';
                            $('statDbSize').textContent = dbStatus.database_size ?? 'N/A';
                            $('statAvgTime').textContent = dbStatus.avg_p_time ? parseFloat(dbStatus.avg_p_time).toFixed(2) + ' ms' : 'N/A';
                            $('statRecordedAt').textContent = dbStatus.recorded_at ? new Date(dbStatus.recorded_at).toLocaleString() : 'N/A';
                        }

                        const pineconeStatus = data.pinecone_status;
                        const pineconeContainer = $('pineconeStatsContainer');
                        if (pineconeStatus && pineconeStatus.status) {
                            pineconeContainer.classList.remove('hidden');
                            $('statPineconeName').textContent = pineconeStatus.name ?? 'N/A';
                            $('statTotalVectors').textContent = pineconeStatus.total_vectors ?? 'N/A';
                            $('statBookVectors').textContent = pineconeStatus.book_namespace_vectors ?? 'N/A';
                            $('statPineconeDimension').textContent = pineconeStatus.dimension ?? 'N/A';
                            $('statPineconeStatus').textContent = pineconeStatus.status ?? 'N/A';
                            $('statPineconeCloud').textContent = `${pineconeStatus.cloud_provider ?? ''} (${pineconeStatus.region ?? ''})`;
                        } else {
                            pineconeContainer.classList.add('hidden');
                        }
                        showMessage('statsMessage', 'Statistics updated successfully!', 'success');
                    } else {
                         throw new Error(data.error || 'Failed to fetch statistics.');
                    }

                } catch (error) {
                    console.error("Error fetching statistics:", error);
                    showMessage('statsMessage', `Error: ${error.message}`, 'error');
                } finally {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    textEl.textContent = 'Refresh Stats';
                }
            }

            // --- Home Page Card & Tab Logic ---
            function setupHomeTabs() {
                const tabsNav = $('homeTabsNav');
                const tabPanels = document.querySelectorAll('.home-tab-panel');
                const tabBtns = document.querySelectorAll('.home-tab-btn');

                tabPanels.forEach(panel => {
                    if (panel.classList.contains('active')) {
                        panel.style.display = 'grid';
                    } else {
                        panel.style.display = 'none';
                    }
                });

                tabsNav.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON') return;
                    const targetTab = e.target.dataset.tab;

                    tabBtns.forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.tab === targetTab);
                    });

                    tabPanels.forEach(panel => {
                        if (panel.id === targetTab) {
                            panel.classList.add('active');
                            panel.style.display = 'grid';
                        } else {
                            panel.classList.remove('active');
                            panel.style.display = 'none';
                        }
                    });
                });
            }

            function attachHomeCardListeners() {
                document.querySelectorAll('.home-template-link').forEach(card => {
                    card.addEventListener('click', () => {
                        const templateId = card.dataset.templateId;
                        preFillData = card.dataset.preFill || '';

                        if (!userLoggedIn) {
                            showMessage('loginMessage', 'Please log in to use the analysis tools.', 'error');
                            navigateTo('login');
                        } else {
                            selectedTemplateForModal = templateId;
                            $('versionChoiceModal').classList.remove('hidden');
                        }
                    });
                });
            }

            function proceedFromModal() {
                $('versionChoiceModal').classList.add('hidden');
                if (selectedTemplateForModal) {
                    showTemplateDetail(selectedTemplateForModal);
                }
            }
            
            // --- Template Detail Page Logic ---

            function reattachActionListeners() {
                const savePdfBtn = $('savePdfBtn');
                const saveDocxBtn = $('saveDocxBtn');
                if (savePdfBtn) savePdfBtn.addEventListener('click', handleSaveAsPdf);
                if (saveDocxBtn) saveDocxBtn.addEventListener('click', handleSaveAsDocx);
            }
            
            function reattachTabListeners(container) {
                const tabNav = container.querySelector('.flex.border-b');
                const tabContent = container.querySelector('div:not(.flex)');
                if (tabNav && tabContent) {
                    tabNav.addEventListener('click', e => {
                        if (e.target.tagName === 'BUTTON') {
                            tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                            tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                            e.target.classList.add('active');
                            const targetPanelId = e.target.dataset.tab + 'Panel';
                            const targetPanel = $(targetPanelId);
                            if (targetPanel) {
                                targetPanel.classList.add('active');
                                const chart = targetPanel.querySelector('.plotly-chart');
                                if (chart) {
                                    Plotly.Plots.resize(chart);
                                }
                            }
                        }
                    });
                }
            }


            function showTemplateDetail(templateId) {
                currentTemplateId = templateId;
                const rule = templateRules[templateId] || {};

                // Dynamically get template info from the clicked card if not in the predefined list
                let template = templates[templateId];
                if (!template) {
                    const card = document.querySelector(`.home-template-link[data-template-id="${templateId}"]`);
                    if (card) {
                        const title = card.querySelector('h3').innerText;
                        const descriptionEl = card.querySelector('p');
                        const description = descriptionEl ? descriptionEl.innerText : `Generate a detailed analysis for ${title}.`;
                        template = { title: title, description: description };
                        templates[templateId] = template; // Cache it
                    } else {
                        // Generic fallback if card isn't found
                        template = { title: templateId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), description: `Generate a detailed analysis.` };
                        templates[templateId] = template;
                    }
                }

                // Handle special layouts that replace the whole content area
                if (rule.useSwotLayout) {
                    createSwotTowsLayout(template);
                } else if (rule.useArchetypeLayout) {
                    createArchetypeAnalysisLayout(template);
                } else if (rule.useThinkingSystemLayout_NS) { // <-- ADD THIS BLOCK
                    createThinkingSystemLayout_NS(template);
                } else if (rule.useLivingSystemLayout_NS) { // <-- ADD THIS BLOCK
                    createLivingSystemLayout_NS(template);
                } else if (rule.useVisualizationLayout_DA) { // <-- ADD THIS BLOCK
                    createVisualizationLayout_DA(template);
                } else if (rule.useSystemObjectivesLayout_ST) { // <-- ADD THIS BLOCK
                    createSystemObjectivesLayout_ST(template);
                } else if (rule.useCreativeDissonanceLayout_NS) { // <-- ADD THIS BLOCK
                    createCreativeDissonanceLayout_NS(template);
                } else if (rule.useSystemActionsLayout_ST) { // <-- ADD THIS BLOCK
                    createSystemActionsLayout_ST(template);
                } else if (rule.usePrescriptiveLayout_DA) { // <-- ADD THIS BLOCK
                    createPrescriptiveLayout_DA(template);
                } else if (rule.usePlsLayout_DA) { // <-- ADD THIS BLOCK
                    createPlsLayout_DA(template);
                } else if (rule.useDescriptiveLayout_DA) { // <-- ADD THIS BLOCK
                    createDescriptiveLayout_DA(template);
                } else if (rule.useFactorAnalysisLayout) {
                    createFactorAnalysisLayout(template);
                } else if (rule.useSemAnalysisLayout) { // <-- ADD THIS BLOCK
                    createSemLayout_DA(template);
                } else if (rule.useActionPlansLayout_AP) { 
                    createActionPlansLayout_AP(template);
                } else if (rule.useLeveragePointsLayout) { 
                    createLeveragePointsLayout(template);
                } else if (rule.useMiscLayout_MSC) { 
                    createMiscLayout_MSC(template);
                } else if (rule.useNovelGoalsLayout_NS) { // <-- ADD THIS BLOCK
                    createNovelGoalsLayout_NS(template);
                } else if (rule.useKpiLayout_KE) {
                    createKpiLayout_KE(template);
                } else if (rule.useGoalsAndInitiativesLayout_SP) {
                    createGoalsAndInitiativesLayout_SP(template);
                } else if (rule.useRegressionLayout_DA) { // <-- ADD THIS BLOCK
                    createRegressionLayout_DA(template);
                } else if (rule.useParetoLayout) {
                    createParetoLayout(template);
                } else if (rule.useProcessMappingLayout) {
                    createProcessMappingLayout(template);
                } else if (rule.useSystemGoalsLayout) { 
                    createSystemGoalsLayout(template);
                } else if (rule.useSystemThinkingLayout) {
                    createSystemThinkingLayout(template);
                }
                else {
                    createDefaultLayout(template, rule);
                }
                navigateTo('templateDetail');
            }
            
            function createDefaultLayout(template, rule) {
                 // --- Default Layout Handling (Rebuilds the DOM for consistency) ---
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-2 gap-12'; // Reset to default grid class
                contentContainer.innerHTML = `
                    <div>
                        <h1 id="templateTitle" class="text-4xl font-bold mb-4">${template.title}</h1>
                        <p id="templateDescription" class="text-white/80 mb-8">${template.description}</p>
                        <div class="glass-container p-6">
                            <div id="templateFormFields" class="space-y-4"></div>
                            
                            <div id="analysisSectionsContainer" class="glass-container mt-8" style="display: ${rule.hideAnalysisSection ? 'none' : 'block'}">
                                <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Analysis Sections</h4>
                                <p class="text-white/70 text-center mb-4">Choose the components for your report.</p>
                                <ul id="analysisList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Introduction</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>Overview of business</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>process overview</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>mission statement</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision analysis</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>vision statement 2</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 1</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 2</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2"><span>novel strategy part 3</span></li>
                                </ul>
                            </div>
                            
                            <div id="methodsConsideredContainer" class="glass-container mt-8" style="display: ${rule.hideFrameworks ? 'none' : 'block'}">
                                <h4 class="text-xl font-bold mb-2 text-white text-center">Select Your Frameworks</h4>
                                <p id="selectionCounter" class="text-white/70 text-center mb-4">Selected: 0 / 3</p>
                                <ul id="frameworkList" class="list-none text-white/70 text-left mx-auto max-w-sm">
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Reframing Thinking"><span>Reframing Thinking</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Delphi Method"><span>Delphi Method</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Blue Ocean Strategy"><span>Blue Ocean Strategy</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Design Thinking"><span>Design Thinking</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Thinking Hats"><span>Thinking Hats</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="Business Model Canvas"><span>Business Model Canvas</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="SCAMPER"><span>SCAMPER</span></li>
                                    <li class="flex items-center mb-2"><input type="checkbox" class="method-checkbox w-5 h-5 mr-2 accent-indigo-500" data-framework="TRIZ (Theory of Inventive Problem Solving)"><span>TRIZ (Theory of Inventive Problem Solving)</span></li>
                                </ul>
                            </div>

                            <button id="generateBtn" class="btn btn-primary w-full mt-4">
                                <span id="generateBtnText">Generate Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold mb-4">Generated Analysis</h2>
                        <div id="analysisResult" class="glass-container min-h-[300px] whitespace-pre-wrap overflow-x-auto">
                        </div>
                        <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                             <button id="savePdfBtn" class="btn btn-secondary">PDF</button>
                             <button id="saveDocxBtn" class="btn btn-secondary">DOCX</button>
                        </div>
                    </div>
                `;
                
                // Populate the form fields into the newly created div
                populateDefaultFormFields(currentTemplateId);
                
                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult')); 
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }

                // Reset and configure frameworks, re-attaching listeners to new elements
                const frameworkCheckboxes = document.querySelectorAll('#frameworkList .method-checkbox');
                frameworkCheckboxes.forEach(cb => {
                    cb.addEventListener('change', frameworkCheckboxChangeHandler);
                    cb.disabled = false;
                    cb.checked = false;
                });
                
                if (rule.preselectFramework) {
                    frameworkCheckboxes.forEach(cb => {
                        if (cb.dataset.framework === rule.preselectFramework) {
                            cb.checked = true;
                        }
                        cb.disabled = true;
                    });
                }
                
                // Re-attach all necessary event listeners for the new elements
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();
                configureFrameworkSelector(currentSelectionLimit);
            }


            function populateDefaultFormFields(templateId) {
                const templateFormFields = $('templateFormFields');
                templateFormFields.innerHTML = ''; // Clear previous fields

                // For Fishbone/Pareto, we only need the problem statement.
                if (templateId === 'pareto-fishbone') {
                    templateFormFields.innerHTML = `
                        <div>
                            <label for="problemStatement" class="block text-sm font-medium text-gray-200 mb-2">Problem Statement</label>
                            <input type="text" id="problemStatement" class="input-field" placeholder="e.g., Low Customer Satisfaction" required>
                        </div>
                    `;
                } else { // Default form for most tools
                    let formHtml = `
                        <div><label for="companyName" class="block text-sm font-medium text-gray-200 mb-2">Company Name</label><input type="text" id="companyName" class="input-field" placeholder="e.g., Innovate Inc." required></div>
                        <div>
                            <label for="companyDocumentsFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Company Documents</label>
                            <div class="input-file-wrapper">
                                <label for="companyDocumentsFile" id="companyDocumentsFileLabel" class="input-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                    <span class="file-name">Click to select a file...</span>
                                </label>
                                <input type="file" id="companyDocumentsFile" class="input-file">
                            </div>
                        </div>
                        <div><label for="location" class="block text-sm font-medium text-gray-200 mb-2">Location</label><input type="text" id="location" class="input-field" placeholder="e.g., Global" required></div>
                    `;

                    // Add context box for specific templates
                    if (templateId === 'mission-vision' || templateId === 'objectives') {
                        formHtml += `
                            <div>
                                <label for="useCaseContext" class="block text-sm font-medium text-gray-200 mb-2">Use Case / Company Context</label>
                                <textarea id="useCaseContext" class="input-field h-32" placeholder="Describe your company's mission, goals, or the specific use case for this analysis..."></textarea>
                            </div>
                        `;
                    }

                    templateFormFields.innerHTML = formHtml;
                    
                    const fileInput = $('companyDocumentsFile');
                    if(fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            const label = $('companyDocumentsFileLabel');
                            const fileNameSpan = label.querySelector('.file-name');
                            if (e.target.files.length > 0) {
                                fileNameSpan.textContent = e.target.files[0].name;
                                label.classList.add('has-file');
                            } else {
                                fileNameSpan.textContent = 'Click to select a file...';
                                label.classList.remove('has-file');
                            }
                        });
                    }
                }
            }

            function createSystemGoalsLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12'; // Single column layout
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">System & Goal Description</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="systemGoalsContent" class="input-field h-48" placeholder="Describe your system, its current state, and what you want to achieve. For example: 'Our software company is growing fast, but customer churn is high. We want to increase customer retention by 30%.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                 <div class="input-file-wrapper">
                                     <label for="systemGoalsFile" id="systemGoalsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                     </label>
                                     <input type="file" id="systemGoalsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Formulate Initiatives</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

                // Re-attach all necessary event listeners for the new elements
                setupInputToggle('systemGoalsFile', 'systemGoalsFileLabel', 'textInputArea', 'docUploadArea');
            }

            function createGoalsAndInitiativesLayout_SP(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">High-Level Goal or Vision</h3>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="goalsContent" class="input-field h-48" placeholder="Describe your main business objective or long-term vision. For example: 'Become the #1 provider of eco-friendly cleaning supplies in North America by 2030.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="goalsFile" id="goalsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="goalsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Build Strategic Plan</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('goalsFile', 'goalsFileLabel', 'textInputArea', 'docUploadArea');
            }

            function createActionPlansLayout_AP(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Objective or Initiative to Plan</h3>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="actionPlanContent" class="input-field h-48" placeholder="Describe the goal or objective you want to create an action plan for. For example: 'Launch a new mobile application for our e-commerce store within the next 6 months.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="actionPlanFile" id="actionPlanFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="actionPlanFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Create Action Plan</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Generated Action Plan</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('actionPlanFile', 'actionPlanFileLabel', 'textInputArea', 'docUploadArea');
            }

            function createKpiLayout_KE(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Project or Goal Description</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="kpiContent" class="input-field h-48" placeholder="Describe the project, goal, or strategic initiative you want to track. For example: 'Launch a new customer loyalty program to increase repeat purchase rate.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="kpiFile" id="kpiFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="kpiFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Define KPIs & Events</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Performance Framework</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('kpiFile', 'kpiFileLabel', 'textInputArea', 'docUploadArea');
            }

            function createNovelGoalsLayout_NS(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg-col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe Your Overarching Ambition or Goal</h3>
                             <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="novelGoalsContent" class="input-field h-48" placeholder="Provide a high-level, ambitious goal. For example: 'To transition our company from a traditional hardware manufacturer to a leading software-as-a-service provider in the IoT space.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="novelGoalsFile" id="novelGoalsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="novelGoalsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Map Strategic Horizons</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Horizons of Growth Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('novelGoalsFile', 'novelGoalsFileLabel', 'textInputArea', 'docUploadArea');
            }

            function createRegressionLayout_DA(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Analysis Setup</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="dependentVar" class="block text-sm font-medium text-gray-200 mb-2">Dependent Variable (Y)</label>
                                    <input type="text" id="dependentVar" class="input-field" placeholder="The outcome you want to predict (e.g., 'Sales')">
                                </div>
                                <div>
                                    <label for="independentVars" class="block text-sm font-medium text-gray-200 mb-2">Independent Variables (X)</label>
                                    <input type="text" id="independentVars" class="input-field" placeholder="Comma-separated predictors (e.g., 'Marketing Spend, Website Traffic')">
                                </div>
                                <div>
                                    <label for="regressionContextFile" class="block text-sm font-medium text-gray-200 mb-2">Company Document (.txt, .docx)</label>
                                    <div class="input-file-wrapper">
                                        <label for="regressionContextFile" id="regressionContextFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select context document...</span>
                                        </label>
                                        <input type="file" id="regressionContextFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <div>
                                    <label for="regressionFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="regressionFile" id="regressionFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv data file...</span>
                                        </label>
                                        <input type="file" id="regressionFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Run Regression Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Regression Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Helper to attach listeners to file inputs
                const attachListener = (inputId, labelId) => {
                    const fileInput = $(inputId);
                    if(fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            const label = $(labelId);
                            const fileNameSpan = label.querySelector('.file-name');
                            if (e.target.files.length > 0) {
                                fileNameSpan.textContent = e.target.files[0].name;
                                label.classList.add('has-file');
                            } else {
                                fileNameSpan.textContent = 'Select a file...';
                                label.classList.remove('has-file');
                            }
                        });
                    }
                };
                
                attachListener('regressionFile', 'regressionFileLabel');
                attachListener('regressionContextFile', 'regressionContextFileLabel');

                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();
            }

           function createPlsLayout_DA(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">PLS-SEM Model Setup</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="plsMeasurementModel" class="block text-sm font-medium text-gray-200 mb-2">Measurement Model</label>
                                    <textarea id="plsMeasurementModel" class="input-field h-32" placeholder="Define latent variables and their indicators. Example:\nBrandImage = BI1, BI2, BI3\nLoyalty = LOY1, LOY2, LOY3"></textarea>
                                </div>
                                <div>
                                    <label for="plsStructuralModel" class="block text-sm font-medium text-gray-200 mb-2">Structural Model (Paths)</label>
                                    <textarea id="plsStructuralModel" class="input-field h-24" placeholder="Define hypothesized paths between latent variables. Example:\nBrandImage -> Loyalty"></textarea>
                                </div>
                                <div>
                                    <label for="plsFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="plsFile" id="plsFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv file...</span>
                                        </label>
                                        <input type="file" id="plsFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Run PLS-SEM Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">PLS-SEM Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                // --- THIS IS THE FIX ---
                setupInputToggle('plsFile', 'plsFileLabel', null, null);
            }

            function createDescriptiveLayout_DA(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Upload Your Dataset & Context</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="descriptiveContextFile" class="block text-sm font-medium text-gray-200 mb-2">Company Document (.txt, .docx)</label>
                                    <div class="input-file-wrapper">
                                        <label for="descriptiveContextFile" id="descriptiveContextFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select context document...</span>
                                        </label>
                                        <input type="file" id="descriptiveContextFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <div>
                                    <label for="descriptiveFile" class="block text-sm font-medium text-gray-200 mb-2">Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="descriptiveFile" id="descriptiveFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv data file...</span>
                                        </label>
                                        <input type="file" id="descriptiveFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Analyze Data</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Descriptive Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                 const attachListener = (inputId, labelId) => {
                    const fileInput = $(inputId);
                    if(fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            const label = $(labelId);
                            const fileNameSpan = label.querySelector('.file-name');
                            if (e.target.files.length > 0) { fileNameSpan.textContent = e.target.files[0].name; label.classList.add('has-file'); } 
                            else { fileNameSpan.textContent = 'Select a file...'; label.classList.remove('has-file'); }
                        });
                    }
                };
                attachListener('descriptiveFile', 'descriptiveFileLabel');
                attachListener('descriptiveContextFile', 'descriptiveContextFileLabel');
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();
            }

            function createSemLayout_DA(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">SEM Model Setup</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="semModelSyntax" class="block text-sm font-medium text-gray-200 mb-2">Model Syntax (lavaan style)</label>
                                    <textarea id="semModelSyntax" class="input-field h-48" placeholder="Define your model using lavaan syntax.\nExample:\n# Measurement Model\n  IMAGE =~ V1 + V2 + V3\n  LOYALTY =~ Y1 + Y2 + Y3\n\n# Structural Model\n  LOYALTY ~ IMAGE"></textarea>
                                </div>
                                <div>
                                    <label for="semFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="semFile" id="semFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv file...</span>
                                        </label>
                                        <input type="file" id="semFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Run SEM Analysis</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">SEM Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('semFile', 'semFileLabel', null, null);
            }

            function createSemAnalysisLayout(template) {
                const contentContainer = $("templateDetailContent");
                contentContainer.className = "grid lg:grid-cols-1 gap-12";
                contentContainer.innerHTML = `
                        <div class="lg:col-span-1">
                            <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                            <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                            <div class="max-w-2xl mx-auto w-full">
                                <div class="glass-container p-6 space-y-4">
                                <h3 class="text-xl font-bold mb-4 text-white">Provide Data/Context</h3>
                                    <div class="input-radio-group">
                                        <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                        <label for="textInput" class="input-radio-label">Text Input</label>
                                        <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                        <label for="docUpload" class="input-radio-label">Document Upload</label>
                                    </div>
                                    <div id="textInputArea">
                                        <textarea id="semContent" class="input-field h-48" placeholder="Describe your variables, hypothesized relationships, or provide raw data context..."></textarea>
                                    </div>
                                    <div id="docUploadArea" class="hidden">
                                        <div class="input-file-wrapper">
                                            <label for="semFile" id="semFileLabel" class="input-file-btn">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                                <span class="file-name">Select .txt, .csv, or .docx file...</span>
                                            </label>
                                            <input type="file" id="semFile" class="input-file" accept=".txt,.docx,.csv">
                                        </div>
                                    </div>
                                    <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                        <span id="generateBtnText"> Run SEM Analysis</span>
                                        <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-12">
                                <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                                <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                                </div>
                                <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                    <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                    <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                                </div>
                            </div>
                        </div>`;
                setupInputToggle("semFile", "semFileLabel", "textInputArea", "docUploadArea");
            }

            async function handleSemAnalysis() {
                const analysisResultContainer = $("analysisResult");
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white">Running Structural Equation Model...</h3></div>`;
                try {
                    // --- THIS IS THE FIX ---
                    // Directly access the specific inputs for the SEM tool
                    const modelSyntax = $("semModelSyntax").value.trim();
                    const file = $("semFile").files[0];

                    if (!modelSyntax) {
                        throw new Error("Please define your model in the 'Model Syntax' text area.");
                    }
                    if (!file) {
                        throw new Error("Please upload a .csv data file.");
                    }
                    
                    const content = await extractTextFromFile(file);
                    // --- END OF FIX ---

                    const prompt = `
                            Analyze the following SEM model and data.
                            MODEL SYNTAX: "${modelSyntax}"
                            DATA: "${content}"

                            TASK:
                            1. Define the latent constructs and structural paths from the syntax.
                            2. Estimate path coefficients (with p-values) and model fit indices (CFI, TLI, RMSEA) based on the data.

                            RESPOND ONLY with a valid JSON object with this exact structure:
                            {
                              "model_summary": "A brief summary of the hypothesized model.",
                              "constructs": [
                                { "name": "ServiceQuality", "type": "exogenous", "description": "...", "indicators": ["quality1", "quality2"] },
                                { "name": "CustomerSatisfaction", "type": "endogenous", "description": "...", "indicators": ["satisfaction1", "satisfaction2"] }
                              ],
                              "structural_relationships": [
                                { "from": "ServiceQuality", "to": "CustomerSatisfaction", "hypothesis": "Better service quality directly influences customer satisfaction" }
                              ],
                              "model_fit": [
                                {"metric": "CFI", "value": 0.95}, {"metric": "TLI", "value": 0.94}, {"metric": "RMSEA", "value": 0.06}
                              ],
                              "path_coefficients": [
                                {"from": "ServiceQuality", "to": "CustomerSatisfaction", "estimate": 0.45, "p_value": 0.001}
                              ]
                            }`;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: "json", options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderSemAnalysisPage(analysisResultContainer, parsedData);
                } catch (error) {
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Error: ${error.message}</div>`;
                } finally {
                    setLoading("generate", false);
                }
            }

            function renderSemAnalysisPage(container, data) {
                container.innerHTML = "";
                const tabNav = document.createElement("div");
                tabNav.className = "flex flex-wrap border-b border-white/20 -mx-6 px-6";
                tabNav.innerHTML = `
                        <button class="analysis-tab-btn active" data-tab="model"> SEM Analysis</button>
                        <button class="analysis-tab-btn" data-tab="diagram"> Path Diagram</button>
                        <button class="analysis-tab-btn" data-tab="estimates"> Parameter Estimates</button>
                        <button class="analysis-tab-btn" data-tab="guidelines"> Model Guidelines</button>
                        <button class="analysis-tab-btn" data-tab="learn"> Learn SEM</button>
                    `;
                container.appendChild(tabNav);

                const tabContent = document.createElement("div");
                container.appendChild(tabContent);
                tabContent.innerHTML = `
                        <div id="modelPanel" class="analysis-tab-panel active p-4"></div>
                        <div id="diagramPanel" class="analysis-tab-panel p-4"></div>
                        <div id="estimatesPanel" class="analysis-tab-panel p-4"></div>
                        <div id="guidelinesPanel" class="analysis-tab-panel p-4"></div>
                        <div id="learnPanel" class="analysis-tab-panel p-4"></div>
                    `;

                renderSemModelTab("modelPanel", data);
                renderSemPathDiagramTab("diagramPanel", data);
                
                const estimatesPanel = $("estimatesPanel");
                let pathsHtml = '<h3 class="text-2xl font-bold mb-4">Parameter Estimates</h3><div id="semPathChart" class="w-full h-[400px] mb-8 plotly-chart"></div>' +
                                '<div class="overflow-x-auto"><table class="w-full text-left styled-table"><thead><tr><th>Path</th><th>Estimate</th><th>P-Value</th><th>Significance</th></tr></thead><tbody>';
                if (data.path_coefficients?.length > 0) {
                    data.path_coefficients.forEach((path) => {
                        const significant = path.p_value < 0.05;
                        pathsHtml += `<tr class="${significant ? "text-green-300" : "text-white/70"}"><td>${path.from} &rarr; ${path.to}</td><td>${path.estimate}</td><td>${path.p_value}</td><td>${significant ? "Significant" : "Not Significant"}</td></tr>`;
                    });
                } else {
                    pathsHtml += `<tr><td colspan="4" class="text-center text-white/70">No path coefficients were generated.</td></tr>`;
                }
                pathsHtml += "</tbody></table></div>";
                estimatesPanel.innerHTML = pathsHtml;

                renderModelGuidelinesTab("guidelinesPanel");
                renderLearnSemTab("learnPanel");

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener("click", (e) => {
                    if (e.target.tagName === "BUTTON") {
                        tabNav.querySelectorAll(".analysis-tab-btn").forEach((btn) => btn.classList.remove("active"));
                        tabContent.querySelectorAll(".analysis-tab-panel").forEach((pnl) => pnl.classList.remove("active"));
                        e.target.classList.add("active");
                        const targetPanel = $(e.target.dataset.tab + "Panel");
                        targetPanel.classList.add("active");
                        const chart = targetPanel.querySelector(".plotly-chart");
                        if (chart) Plotly.Plots.resize(chart);
                    }
                });

                if (data.path_coefficients?.length > 0) {
                    Plotly.newPlot("semPathChart", [{
                        x: data.path_coefficients.map((p) => `${p.from}  ${p.to}`),
                        y: data.path_coefficients.map((p) => p.estimate),
                        type: "bar",
                        marker: { color: data.path_coefficients.map((p) => (p.p_value < 0.05 ? "var(--primary)" : "rgba(255,255,255,0.3)")) }
                    }], {
                        title: "Path Coefficient Estimates", paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", font: { color: "white" }, yaxis: { title: "Estimate", gridcolor: "rgba(255,255,255,0.2)" }
                    }, { responsive: true });
                }
            }

            function renderSemModelTab(containerId, data) {
                const container = $(containerId);
                const constructsHtml = data.constructs?.map(c => `
                    <div class="mb-4">
                        <h4 class="text-lg font-bold">${c.type === "exogenous" ? "" : ""} ${c.name} <span class="text-sm font-light text-white/70">(${c.type})</span></h4>
                        <p class="text-white/80 text-sm mb-2">${c.description}</p>
                        <p class="text-sm text-white/60"><strong>Indicators:</strong> ${c.indicators.join(', ')}</p>
                    </div>`).join('') || "<p class='text-white/70'>No latent constructs were defined.</p>";
                
                const relationshipsHtml = data.structural_relationships?.map((rel, i) => `
                    <div class="mb-4">
                        <h4 class="text-lg font-bold">${i + 1}. ${rel.from} &rarr; ${rel.to}</h4>
                        <p class="text-white/80 text-sm"><strong>Hypothesis:</strong> ${rel.hypothesis}</p>
                    </div>`).join('') || "<p class='text-white/70'>No structural relationships were defined.</p>";

                container.innerHTML = `
                    <div class="mb-6"><h3 class="text-xl font-bold mb-2">Model Purpose</h3><p class="text-indigo-300 italic">${data.model_summary || "N/A"}</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><h3 class="text-2xl font-bold mb-4">Latent Constructs</h3><div class="model-section-container">${constructsHtml}</div></div>
                        <div><h3 class="text-2xl font-bold mb-4">Structural Relationships</h3><div class="model-section-container">${relationshipsHtml}</div></div>
                    </div>`;
            }

            function renderSemPathDiagramTab(containerId, data) {
                const container = $(containerId);
                container.innerHTML = `<h3 class="text-2xl font-bold mb-4">SEM Path Diagram</h3><div id="semPathDiagramChart" class="w-full h-[600px] plotly-chart"></div>`;
                try {
                    const nodes = [], edges = [], node_x = [], node_y = [], node_text = [], node_color = [], node_size = [];
                    (data.constructs || []).forEach(c => { nodes.push({ id: c.name, type: "construct" }); node_text.push(`<b>${c.name}</b>`); node_color.push("var(--primary)"); node_size.push(30); });
                    
                    const numNodes = nodes.length;
                    nodes.forEach((node, i) => { const angle = (i / numNodes) * 2 * Math.PI; node.x = 100 * Math.cos(angle); node.y = 100 * Math.sin(angle); node_x.push(node.x); node_y.push(node.y); });

                    const line_traces = (data.structural_relationships || []).map(rel => {
                        const fromNode = nodes.find(n => n.id === rel.from);
                        const toNode = nodes.find(n => n.id === rel.to);
                        return { type: "scatter", mode: "lines", x: [fromNode.x, toNode.x], y: [fromNode.y, toNode.y], line: { width: 4, color: "var(--accent)" }, hoverinfo: "none" };
                    });

                    const node_trace = { type: "scatter", mode: "markers+text", x: node_x, y: node_y, text: nodes.map(n => n.id), textposition: "bottom center", textfont: { color: "white" }, marker: { size: node_size, color: node_color }, hovertext: node_text, hoverinfo: "text" };
                    Plotly.newPlot("semPathDiagramChart", [...line_traces, node_trace], { title: "SEM Path Diagram", paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", font: { color: "white" }, showlegend: false, xaxis: { visible: false }, yaxis: { visible: false } }, { responsive: true });
                } catch (e) {
                    $("semPathDiagramChart").innerHTML = `<p class='text-red-400'>Could not render path diagram. ${e.message}</p>`;
                }
            }
            
            function renderModelGuidelinesTab(containerId) {
                const container = $(containerId);
                container.innerHTML = `<div class="learn-section"><h4>Interpreting Model Fit</h4><p>...</p><ul class="list-disc list-inside mt-2 space-y-2 text-sm"><li><strong>CFI / TLI:</strong> > 0.95 for excellent fit.</li><li><strong>RMSEA:</strong> < 0.06 for good fit.</li><li><strong>SRMR:</strong> < 0.08 for good fit.</li></ul></div><div class="learn-section"><h4>Interpreting Parameter Estimates</h4><p>...</p><ul class="list-disc list-inside mt-2 space-y-2 text-sm"><li><strong>Estimate:</strong> The strength and direction of the relationship.</li><li><strong>P-value (p):</strong> If < 0.05, the relationship is statistically significant.</li></ul></div>`;
            }

            function renderLearnSemTab(containerId) {
                const container = $(containerId);
                container.innerHTML = `<div class="learn-section"><h4>What is SEM?</h4><p>Structural Equation Modeling (SEM) is a statistical technique to test causal relationships between variables, especially 'latent' (unobserved) concepts.</p></div><div class="learn-section"><h4>How to Define a Model (lavaan syntax)</h4><p>This tool uses syntax similar to R's 'lavaan' package:</p><ul class="list-disc list-inside mt-2 space-y-1"><li><code>=~</code> (is measured by): Defines a latent variable.</li><li><code>~</code> (is regressed on): Defines a causal path.</li><li><code>~~</code> (is correlated with): Defines a correlation.</li></ul></div>`;
            }
            
            function renderSemPage_DA(container, data) {
                container.innerHTML = '';
                const { model_fit, path_coefficients, visual_data, business_recommendations } = data;
                if (!model_fit || !path_coefficients || !visual_data) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="analysis">SEM Analysis</button><button class="analysis-tab-btn" data-tab="diagram">Path Diagram</button><button class="analysis-tab-btn" data-tab="estimates">Parameter Estimates</button><button class="analysis-tab-btn" data-tab="guidelines">Model Guidelines</button><button class="analysis-tab-btn" data-tab="learn">Learn SEM</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="analysisPanel" class="analysis-tab-panel active"></div><div id="diagramPanel" class="analysis-tab-panel"></div><div id="estimatesPanel" class="analysis-tab-panel"></div><div id="guidelinesPanel" class="analysis-tab-panel"></div><div id="learnPanel" class="analysis-tab-panel"></div>`;

                // --- 1. SEM Analysis Panel ---
                const analysisPanel = $('analysisPanel');
                let fitHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Model Fit Indices</h3><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>Index</th><th>Value</th><th>Good Fit Threshold</th><th>Interpretation</th></tr></thead><tbody>`;
                model_fit.forEach(f => { fitHtml += `<tr><td>${f.index}</td><td>${typeof f.value === 'number' ? f.value.toFixed(3) : f.value}</td><td>${f.threshold}</td><td class="text-sm">${f.interpretation}</td></tr>`; });
                fitHtml += `</tbody></table></div><div class="p-4 mt-4"><h3 class="text-2xl font-bold mb-4">Actionable Recommendations</h3><ul class="list-disc list-inside space-y-4 text-white/90">`;
                (business_recommendations || []).forEach(rec => { fitHtml += `<li>${rec}</li>`; });
                fitHtml += `</ul></div>`;
                analysisPanel.innerHTML = fitHtml;

                // --- 2. Path Diagram Panel (FIXED) ---
                const diagramPanel = $('diagramPanel');
                let diagramHtml = `<div class="path-diagram-container"><svg width="100%" height="100%" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <marker id="semArrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(255,255,255,0.7)"/></marker>
                        <marker id="semArrowSig" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="var(--accent)"/></marker>
                    </defs>`;
                const nodeMap = new Map(visual_data.nodes.map(n => [n.id, n]));
                
                // Draw Measurement paths (Latent -> Indicator)
                (visual_data.measurements || []).forEach((m, i) => {
                    const latentNode = nodeMap.get(m.latent);
                    if (latentNode) {
                        m.indicators.forEach((indicator, j) => {
                            const indX = latentNode.x - 200;
                            const indY = latentNode.y - 50 + (j * 50);
                            diagramHtml += `<rect x="${indX - 40}" y="${indY - 20}" width="80" height="40" fill="rgba(0,0,0,0.3)" stroke="rgba(255,255,255,0.3)" />`;
                            diagramHtml += `<text x="${indX}" y="${indY}" fill="white" text-anchor="middle" dominant-baseline="middle">${indicator}</text>`;
                            diagramHtml += `<line x1="${latentNode.x - 80}" y1="${latentNode.y}" x2="${indX + 40}" y2="${indY}" stroke="rgba(255,255,255,0.3)" stroke-width="1" marker-end="url(#semArrow)" />`;
                        });
                    }
                });

                // Draw Structural paths (Latent -> Latent)
                path_coefficients.forEach(p => {
                    const [targetId, sourceId] = p.path.split(' ~ ');
                    const sourceNode = nodeMap.get(sourceId);
                    const targetNode = nodeMap.get(targetId);
                    if (sourceNode && targetNode) {
                        const isSig = p.p_value === "<0.001" || parseFloat(p.p_value) < 0.05;
                        diagramHtml += `<line x1="${sourceNode.x + 80}" y1="${sourceNode.y}" x2="${targetNode.x - 80}" y2="${targetNode.y}" class="path-arrow ${isSig ? 'significant' : ''}" marker-end="url(#semArrow${isSig ? 'Sig' : ''})" />`;
                        diagramHtml += `<text x="${(sourceNode.x + targetNode.x) / 2}" y="${targetNode.y - 20}" class="path-label-text ${isSig ? 'significant' : ''}">${p.estimate.toFixed(3)}</text>`;
                    }
                });

                // Draw Latent nodes
                visual_data.nodes.forEach(node => {
                    diagramHtml += `<ellipse cx="${node.x}" cy="${node.y}" rx="80" ry="40" class="pls-svg-node" />`;
                    diagramHtml += `<text x="${node.x}" y="${node.y}" class="pls-svg-node-text">${node.id}</text>`;
                });
                diagramHtml += `</svg></div>`;
                diagramPanel.innerHTML = diagramHtml;

                // --- 3. Parameter Estimates Panel ---
                const estimatesPanel = $('estimatesPanel');
                let estimatesHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Path Coefficients</h3><div id="parameterChart" class="w-full h-[400px] plotly-chart mb-8"></div><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>Path</th><th>Estimate</th><th>Std. Error</th><th>Z-value</th><th>P-value</th></tr></thead><tbody>`;
                path_coefficients.forEach(p => {
                    const isSig = p.p_value === "<0.001" || parseFloat(p.p_value) < 0.05;
                    estimatesHtml += `<tr class="${isSig ? 'significant' : ''}"><td>${p.path}</td><td>${p.estimate.toFixed(3)}</td><td>${p.std_error.toFixed(3)}</td><td>${p.z_value.toFixed(2)}</td><td>${p.p_value} ${isSig ? '***' : ''}</td></tr>`;
                });
                estimatesHtml += `</tbody></table><p class="text-xs text-white/60 mt-4">*** indicates statistical significance</p></div>`;
                estimatesPanel.innerHTML = estimatesHtml;
                const chartData = [...path_coefficients].reverse();
                const trace = { y: chartData.map(p => p.path), x: chartData.map(p => p.estimate), type: 'bar', orientation: 'h', marker: { color: chartData.map(p => (p.p_value === "<0.001" || parseFloat(p.p_value) < 0.05) ? 'var(--accent)' : 'rgba(255,255,255,0.3)') } };
                Plotly.newPlot('parameterChart', [trace], { title: 'Standardized Path Estimates', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: {title: 'Estimate'}, yaxis: {automargin: true} }, {responsive: true});

                // --- 4. & 5. Guidelines and Learn Panels ---
                $('guidelinesPanel').innerHTML = `<div class="p-4"><div class="learn-section"><h4>Interpreting Model Fit</h4><p>...</p><ul class="list-disc list-inside mt-2 space-y-2 text-sm"><li><strong>CFI / TLI:</strong> > 0.95 for excellent fit.</li><li><strong>RMSEA:</strong> < 0.06 for good fit.</li><li><strong>SRMR:</strong> < 0.08 for good fit.</li></ul></div><div class="learn-section"><h4>Interpreting Parameter Estimates</h4><p>...</p><ul class="list-disc list-inside mt-2 space-y-2 text-sm"><li><strong>Estimate:</strong> The strength and direction of the relationship.</li><li><strong>P-value (p):</strong> If < 0.05, the relationship is statistically significant.</li></ul></div></div>`;
                $('learnPanel').innerHTML = `<div class="p-4"><div class="learn-section"><h4>What is SEM?</h4><p>Structural Equation Modeling (SEM) is a statistical technique to test causal relationships between variables, especially 'latent' (unobserved) concepts.</p></div><div class="learn-section"><h4>How to Define a Model (lavaan syntax)</h4><p>This tool uses syntax similar to R's 'lavaan' package:</p><ul class="list-disc list-inside mt-2 space-y-1"><li><code>=~</code> (is measured by): Defines a latent variable.</li><li><code>~</code> (is regressed on): Defines a causal path.</li><li><code>~~</code> (is correlated with): Defines a correlation.</li></ul></div></div>`;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); const targetPanel = $(e.target.dataset.tab + 'Panel'); targetPanel.classList.add('active'); const chart = targetPanel.querySelector('.plotly-chart'); if (chart) { Plotly.Plots.resize(chart); } } });
                $('analysisActions').classList.remove('hidden');
            }

            function createPrescriptiveLayout_DA(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Analysis Setup</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="prescriptiveGoal" class="block text-sm font-medium text-gray-200 mb-2">Business Goal</label>
                                    <textarea id="prescriptiveGoal" class="input-field h-24" placeholder="Describe the business outcome you want to achieve. Example: 'Increase customer retention by 15% in the next quarter.'"></textarea>
                                </div>
                                <div>
                                    <label for="prescriptiveFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="prescriptiveFile" id="prescriptiveFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv file...</span>
                                        </label>
                                        <input type="file" id="prescriptiveFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> prescribe Actions</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Prescriptive Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('prescriptiveFile', 'prescriptiveFileLabel', null, null);
            }

            function createVisualizationLayout_DA(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Visualization Setup</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="vizRequest" class="block text-sm font-medium text-gray-200 mb-2">What do you want to visualize?</label>
                                    <textarea id="vizRequest" class="input-field h-24" placeholder="Be specific. For example: 'Show the relationship between Marketing Spend and Sales Revenue', or 'Visualize the distribution of customer ages by product category.'"></textarea>
                                </div>
                                <div>
                                    <label for="vizFile" class="block text-sm font-medium text-gray-200 mb-2">Upload Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="vizFile" id="vizFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .csv file...</span>
                                        </label>
                                        <input type="file" id="vizFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Generate Visualizations</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Data Visualizations</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('vizFile', 'vizFileLabel', null, null);
            }

           async function handleVisualizationAnalysis_DA() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Generating Advanced Visualizations...</h3><p class="text-white/80 mb-2">Analyzing your data to create the best charts for your request...</p></div>`;

                try {
                    const vizRequest = $('vizRequest').value.trim();
                    const file = $('vizFile').files[0];

                    if (!vizRequest || !file) {
                        throw new Error("Please describe your visualization request and upload a CSV file.");
                    }
                    
                    let csvText = await extractTextFromFile(file);
                    let contextNote = "";
                    if (csvText.length > 15000) {
                        csvText = csvText.substring(0, 15000);
                        contextNote = " (Note: The analysis was performed on the first 15,000 characters of the provided data file due to size limitations.)";
                    }

                    const prompt = `
                        You are a senior business intelligence analyst using Plotly.js. A user has provided a dataset and a complex request for visualizations.

                        **Analysis Context:**
                        - User Request: ${vizRequest}
                        - Full CSV Data: ${csvText}
                        ${contextNote}

                        **TASK:**
                        Analyze the data and the user's request. Deconstruct the complex request into 3-4 distinct, complementary visualizations that tell a clear story. You may use a variety of chart types (bar, line, scatter, pie, box, heatmap). For each visualization, provide:
                        1.  A short, descriptive title.
                        2.  A complete Plotly.js trace object.
                        3.  A complete Plotly.js layout object.
                        4.  A detailed, multi-sentence 'interpretation' of what the chart shows.
                        5.  A specific, 'actionable_insight' explaining what business action should be taken based on the chart.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "visualizations": [
                            {
                              "title": "Profit Trend Over Time",
                              "plotly_trace": {
                                "x": ["Q1 2023", "Q2 2023", "Q3 2023", "Q4 2023"],
                                "y": [25000, 28000, 35000, 42000],
                                "type": "line", "mode": "lines+markers", "name": "Profit"
                              },
                              "plotly_layout": { "title": "Quarterly Profit Trend", "xaxis": {"title": "Quarter"}, "yaxis": {"title": "Profit ($)"} },
                              "interpretation": "The line chart illustrates a strong and consistent upward trend in profit throughout the fiscal year. Growth accelerated significantly in the second half of the year, particularly between Q2 and Q3. This suggests that business strategies implemented mid-year were highly effective.",
                              "actionable_insight": "The business should double down on the strategies initiated in Q2. Conduct a post-mortem on Q2/Q3 marketing campaigns and product launches to identify the specific drivers of this accelerated growth and reallocate budget towards these successful initiatives for the next fiscal year."
                            },
                            {
                              "title": "Sales by Category",
                              "plotly_trace": {
                                "labels": ["Skincare", "Makeup", "Haircare"],
                                "values": [250000, 150000, 80000],
                                "type": "pie", "hole": 0.4
                              },
                              "plotly_layout": { "title": "Sales Revenue Distribution by Category" },
                              "interpretation": "The donut chart clearly shows that 'Skincare' is the dominant category, contributing the largest share of total sales revenue. 'Makeup' is the second-largest contributor, while 'Haircare' represents a smaller, tertiary segment.",
                              "actionable_insight": "Given that 'Skincare' is the cash cow, protect and expand this segment. Launch a customer survey to the skincare user base to identify opportunities for new product development within this category. For the 'Haircare' segment, consider either divestment or a targeted niche marketing campaign to increase its market share."
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderVisualizationPage_DA(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Visualization Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            function renderVisualizationPage_DA(container, data) {
                container.innerHTML = '';
                const { visualizations } = data;
                if (!visualizations || visualizations.length === 0) { container.innerHTML = `<div class="p-4 text-center text-red-400">Could not generate any visualizations for your request.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                visualizations.forEach((viz, index) => {
                    tabNav.innerHTML += `<button class="analysis-tab-btn ${index === 0 ? 'active' : ''}" data-tab="viz-${index}">${viz.title}</button>`;
                });
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                visualizations.forEach((viz, index) => {
                    tabContent.innerHTML += `<div id="viz-${index}Panel" class="analysis-tab-panel ${index === 0 ? 'active' : ''}"></div>`;
                });

                visualizations.forEach((viz, index) => {
                    const panel = $(`viz-${index}Panel`);
                    let panelHtml = `<div class="p-4">
                        <div id="viz-chart-${index}" class="w-full h-[550px] plotly-chart"></div>
                        <div class="viz-interpretation-box">
                            <h4 class="text-xl font-bold mb-2">Interpretation</h4>
                            <p class="text-white/80 mb-4">${viz.interpretation}</p>
                            <h4 class="text-xl font-bold mb-2 text-indigo-300"> Actionable Insight</h4>
                            <p class="text-white/90">${viz.actionable_insight}</p>
                        </div>
                    </div>`;
                    panel.innerHTML = panelHtml;

                    const chartContainer = $(`viz-chart-${index}`);
                    
                    const trace = viz.plotly_trace;
                    const layout = {
                        ...viz.plotly_layout,
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: 'white' },
                        legend: { font: { color: 'white' } }
                    };
                    
                    if (trace && layout) {
                        // Handle cases where trace is an array or a single object
                        const traces = Array.isArray(trace) ? trace : [trace];
                        Plotly.newPlot(chartContainer, traces, layout, {responsive: true});
                    }
                });

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); const targetPanel = $(e.target.dataset.tab + 'Panel'); targetPanel.classList.add('active'); const chart = targetPanel.querySelector('.plotly-chart'); if (chart) { Plotly.Plots.resize(chart); } } });
                $('analysisActions').classList.remove('hidden');
            }

            function createSystemActionsLayout_ST(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe a Problem in Your System</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="systemActionContent" class="input-field h-48" placeholder="Describe a recurring problem. For example: 'Every time we hire more salespeople to boost revenue, our customer satisfaction drops and churn increases.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="systemActionFile" id="systemActionFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="systemActionFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Formulate Actions</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Systemic Action Plan</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('systemActionFile', 'systemActionFileLabel', 'textInputArea', 'docUploadArea');
            }

            async function handleSystemActionsAnalysis_ST() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Diagnosing System Behavior...</h3><p class="text-white/80 mb-2">Identifying archetypes and formulating interventions...</p></div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';
                    if (useDoc) {
                        const file = $('systemActionFile').files[0];
                        if (!file) throw new Error("Please select a document.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('systemActionContent').value;
                        if (!text.trim()) throw new Error("Please describe the system problem.");
                    }
                    if (text.length > 15000) { text = text.substring(0, 15000); }

                    const prompt = `
                        You are a systems thinking expert. A user has described a recurring problem. Your task is to diagnose the underlying system structure and prescribe a set of actions.

                        **System Problem:**
                        ${text}

                        **TASK:**
                        Analyze the problem and generate a complete action plan.

                        1.  **problem_diagnosis**: A concise, one-sentence statement of the core systemic problem.
                        2.  **system_archetype**: An object identifying the most likely system archetype at play, including its name and a brief explanation of how it applies to the user's problem.
                        3.  **leverage_points**: A list of 2-3 key leverage points for intervention.
                        4.  **actions**: An array of 3-4 recommended actions. For each action:
                            - "action_name": A clear name for the action.
                            - "type": Classify as either a "Short-Term Fix" (addresses a symptom) or a "Long-Term Solution" (addresses the fundamental structure).
                            - "rationale": Explain how this action addresses a leverage point and manipulates the system's structure.
                            - "impact": "High", "Medium", or "Low".
                            - "effort": "High", "Medium", or "Low".
                            - "kpis": A list of 2-3 KPIs to track success.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "problem_diagnosis": "Revenue growth initiatives are inadvertently eroding the service capacity required to retain customers, creating a self-defeating cycle.",
                          "system_archetype": {
                            "name": "Limits to Growth",
                            "explanation": "The reinforcing engine of 'Hiring Salespeople' to grow revenue is colliding with a balancing process: 'Declining Service Quality'. As the sales team grows the customer base, the support system becomes overwhelmed, which increases churn and ultimately limits revenue growth."
                          },
                          "leverage_points": ["Strengthening the capacity of the support system.", "Coupling sales growth directly to support capacity.", "Improving the efficiency of the support process."],
                          "actions": [
                            {
                              "action_name": "Temporary Freeze on Sales Hiring",
                              "type": "Short-Term Fix",
                              "rationale": "This immediately eases the pressure on the overwhelmed support system, buying time to implement a fundamental solution and stopping the immediate financial and reputational damage from high churn.",
                              "impact": "Medium", "effort": "Low",
                              "kpis": ["Customer Churn Rate", "Average Support Ticket Time", "Sales Team Morale"]
                            },
                            {
                              "action_name": "Invest in Support Team Scaling",
                              "type": "Long-Term Solution",
                              "rationale": "This addresses the core 'limit' by increasing the support system's capacity. By scaling the support team and tools, the system can handle a larger customer base, allowing the growth engine to function without being counteracted.",
                              "impact": "High", "effort": "High",
                              "kpis": ["Support Headcount", "Customer Satisfaction Score (CSAT)", "Net Promoter Score (NPS)"]
                            },
                            {
                              "action_name": "Implement a 'Growth-to-Support' Ratio Policy",
                              "type": "Long-Term Solution",
                              "rationale": "This structurally links the growth engine to the balancing loop. It creates a new rule where for every 'X' new salespeople hired, 'Y' new support agents must also be hired, ensuring that capacity always grows in line with demand.",
                              "impact": "High", "effort": "Medium",
                              "kpis": ["Sales-to-Support Staff Ratio", "Budget Allocation for Support vs. Sales"]
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderSystemActionsPage_ST(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during System Actions analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            function renderSystemActionsPage_ST(container, data) {
                container.innerHTML = '';
                const { problem_diagnosis, system_archetype, leverage_points, actions } = data;
                if (!problem_diagnosis || !actions) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button><button class="analysis-tab-btn" data-tab="actions"> Action Details</button><button class="analysis-tab-btn" data-tab="dynamics"> System Dynamics</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="dashboardPanel" class="analysis-tab-panel active"></div><div id="actionsPanel" class="analysis-tab-panel"></div><div id="dynamicsPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Dashboard Panel (REVISED) ---
                const dashboardPanel = $('dashboardPanel');
                let dashboardHtml = `<div class="p-4">
                    <blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 mb-8"><strong>Problem Diagnosis:</strong> ${problem_diagnosis}</blockquote>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div id="actionTypeChart" class="w-full h-[400px] plotly-chart"></div>
                        <div id="actionCompareChart" class="w-full h-[400px] plotly-chart"></div>
                    </div>
                </div>`;
                dashboardPanel.innerHTML = dashboardHtml;

                // Chart 1: Donut Chart for Action Types
                const shortTermCount = actions.filter(a => a.type === 'Short-Term Fix').length;
                const longTermCount = actions.filter(a => a.type === 'Long-Term Solution').length;
                const typeTrace = {
                    values: [shortTermCount, longTermCount],
                    labels: ['Short-Term Fixes', 'Long-Term Solutions'],
                    type: 'pie',
                    hole: .4,
                    marker: { colors: ['#f59e0b', '#2563eb'] }
                };
                const typeLayout = {
                    title: 'Action Type Breakdown',
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: 'white' }, showlegend: true
                };
                Plotly.newPlot('actionTypeChart', [typeTrace], typeLayout, {responsive: true});

                // Chart 2: Grouped Bar Chart for Impact vs. Effort
                const valueMap = { 'Low': 1, 'Medium': 2, 'High': 3 };
                const actionNames = actions.map(a => a.action_name);
                const impactValues = actions.map(a => valueMap[a.impact] || 0);
                const effortValues = actions.map(a => valueMap[a.effort] || 0);
                
                const impactTrace = { y: actionNames, x: impactValues, name: 'Impact', type: 'bar', orientation: 'h', marker: {color: 'var(--accent)'} };
                const effortTrace = { y: actionNames, x: effortValues, name: 'Effort', type: 'bar', orientation: 'h', marker: {color: 'rgba(255,255,255,0.4)'} };
                const compareLayout = {
                    title: 'Impact vs. Effort Comparison',
                    barmode: 'group',
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: 'white' },
                    yaxis: { automargin: true },
                    xaxis: { tickvals: [1, 2, 3], ticktext: ['Low', 'Medium', 'High'] },
                    legend: { x: 0.6, y: -0.2, orientation: 'h' }
                };
                Plotly.newPlot('actionCompareChart', [impactTrace, effortTrace], compareLayout, {responsive: true});


                // --- 2. Action Details Panel ---
                const actionsPanel = $('actionsPanel');
                let actionsHtml = `<div class="p-4">`;
                actions.forEach(a => {
                    const typeClass = a.type === 'Short-Term Fix' ? 'short-term' : 'long-term';
                    actionsHtml += `<div class="action-card ${typeClass}">
                        <p class="text-sm font-semibold ${typeClass === 'short-term' ? 'text-yellow-400' : 'text-blue-400'}">${a.type}</p>
                        <h4>${a.action_name}</h4>
                        <p class="rationale"><strong>Systemic Rationale:</strong> ${a.rationale}</p>
                        <p class="text-sm"><strong>KPIs to Track:</strong> ${a.kpis.join(', ')}</p>
                    </div>`;
                });
                actionsHtml += `</div>`;
                actionsPanel.innerHTML = actionsHtml;
                
                // --- 3. System Dynamics Panel ---
                const dynamicsPanel = $('dynamicsPanel');
                let dynamicsHtml = `<div class="p-4">
                    <div class="archetype-card mb-8">
                        <h3 class="text-xl font-bold text-indigo-300">SYSTEM ARCHETYPE</h3>
                        <p class="text-2xl font-semibold mt-2">${system_archetype.name}</p>
                        <p class="text-white/80 mt-2">${system_archetype.explanation}</p>
                    </div>
                    <div class="insight-card">
                        <h4 class="text-lg font-bold text-indigo-300">Key Leverage Points:</h4>
                        <ul class="list-disc list-inside space-y-2 mt-2 text-white/90">`;
                leverage_points.forEach(lp => { dynamicsHtml += `<li>${lp}</li>`; });
                dynamicsHtml += `</ul></div></div>`;
                dynamicsPanel.innerHTML = dynamicsHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); const targetPanel = $(e.target.dataset.tab + 'Panel'); targetPanel.classList.add('active'); targetPanel.querySelectorAll('.plotly-chart').forEach(chart => Plotly.Plots.resize(chart)); } });
                $('analysisActions').classList.remove('hidden');
            }

            function createSystemObjectivesLayout_ST(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe Your System & Desired Outcome</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="systemObjContent" class="input-field h-48" placeholder="Describe the system and what you want to achieve. For example: 'Our user base is growing, but engagement is low. We want to increase the daily active user rate.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="systemObjFile" id="systemObjFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="systemObjFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Set System-Aware Objectives</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Systemic Objective Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('systemObjFile', 'systemObjFileLabel', 'textInputArea', 'docUploadArea');
            }

            async function handleSystemObjectivesAnalysis_ST() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Analyzing System Dynamics...</h3><p class="text-white/80 mb-2">Formulating objectives based on feedback loops...</p></div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';
                    if (useDoc) {
                        const file = $('systemObjFile').files[0];
                        if (!file) throw new Error("Please select a document.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('systemObjContent').value;
                        if (!text.trim()) throw new Error("Please describe your system and goal.");
                    }
                    if (text.length > 15000) {
                        text = text.substring(0, 15000);
                    }

                    const prompt = `
                        You are a systems thinking strategist. A user has described a system and a desired outcome. Your task is to structure an OGSI (Objective, Goals, Strategies, Initiatives) plan that is explicitly based on the system's feedback loops.

                        **System Context:**
                        ${text}

                        **TASK:**
                        Analyze the context and generate a complete OGSI plan.

                        1.  **main_objective**: Refine the user's input into a single, high-level, aspirational Objective.
                        2.  **feedback_loops**: Identify the most critical 'reinforcing_loop' (growth engine) and 'balancing_loop' (limiting factor) that affect the objective.
                        3.  **goals**: Define 2-3 specific, measurable Goals that contribute to the main objective.
                        4.  **strategies_and_initiatives**: An array where each item links a Goal to a system-aware Strategy and concrete Initiatives. For each item:
                            - "goal": The name of the goal it addresses.
                            - "strategy": A specific strategy designed to either **amplify the reinforcing loop** or **weaken the balancing loop**. The rationale must be explicit about this.
                            - "initiatives": An array of 2-3 specific action items to execute the strategy.
                            - "kpis": A list of 2-3 KPIs to track the success of the initiatives.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "main_objective": "Transform our platform from a simple tool into a highly engaging, self-reinforcing ecosystem.",
                          "feedback_loops": {
                            "reinforcing_loop": "The 'Network Effect Loop': More active users create more valuable content, which attracts more new users, further increasing activity and value.",
                            "balancing_loop": "The 'New User Confusion Loop': A rapid influx of new users who don't understand the platform leads to low-quality contributions and clutters the experience for existing users, causing churn."
                          },
                          "goals": ["Increase Daily Active Users (DAU) by 50%", "Increase User-Generated Content by 100%"],
                          "strategies_and_initiatives": [
                            {
                              "goal": "Increase Daily Active Users (DAU) by 50%",
                              "strategy": "Amplify the 'Network Effect Loop' by making high-quality content more discoverable and rewarding its creators.",
                              "initiatives": [
                                "Develop a new content recommendation algorithm.",
                                "Launch a 'Top Creator of the Week' feature with platform-wide visibility.",
                                "Implement a user-friendly onboarding tutorial."
                              ],
                              "kpis": ["Daily Active Users", "Average Session Duration", "Content Share Rate"]
                            },
                            {
                              "goal": "Increase User-Generated Content by 100%",
                              "strategy": "Weaken the 'New User Confusion Loop' by improving the quality of first-time contributions and reducing friction for new creators.",
                              "initiatives": [
                                "Introduce content creation templates for new users.",
                                "Create a mentorship program pairing new users with experienced 'superusers'.",
                                "Gamify the content creation process with badges and rewards."
                              ],
                              "kpis": ["New Content Submissions per Day", "First-to-Second Post Conversion Rate", "User Retention Rate (30-day)"]
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderSystemObjectivesPage_ST(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during System Objectives analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            function renderSystemObjectivesPage_ST(container, data) {
                container.innerHTML = '';
                const { main_objective, feedback_loops, goals, strategies_and_initiatives } = data;
                if (!main_objective || !feedback_loops || !goals) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="dashboard"> Strategic Dashboard</button><button class="analysis-tab-btn" data-tab="strategies"> Goals & Strategies</button><button class="analysis-tab-btn" data-tab="initiatives"> Initiatives & KPIs</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="dashboardPanel" class="analysis-tab-panel active"></div><div id="strategiesPanel" class="analysis-tab-panel"></div><div id="initiativesPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Dashboard Panel ---
                const dashboardPanel = $('dashboardPanel');
                let dashboardHtml = `<div class="st-dashboard-container">
                    <div class="st-objective-card">
                        <h3 class="text-xl font-bold text-indigo-300">MAIN OBJECTIVE</h3>
                        <p class="text-2xl font-semibold mt-2">${main_objective}</p>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-center mb-4">Key Goals</h3>
                        <div class="st-goals-grid">`;
                goals.forEach(goal => { dashboardHtml += `<div class="st-goal-card"><p class="text-lg font-bold">${goal}</p></div>`; });
                dashboardHtml += `</div></div>
                    <div>
                        <h3 class="text-2xl font-bold text-center mb-4">Influential System Dynamics</h3>
                        <div class="st-loops-grid">
                            <div class="bg-white/5 p-4 rounded-lg border-l-4 border-green-400"><h4 class="text-lg font-bold"> Reinforcing Loop</h4><p class="text-sm text-white/80 my-2">${feedback_loops.reinforcing_loop}</p></div>
                            <div class="bg-white/5 p-4 rounded-lg border-l-4 border-yellow-400"><h4 class="text-lg font-bold"> Balancing Loop</h4><p class="text-sm text-white/80 my-2">${feedback_loops.balancing_loop}</p></div>
                        </div>
                    </div>
                </div>`;
                dashboardPanel.innerHTML = dashboardHtml;

                // --- 2. Goals & Strategies Panel ---
                const strategiesPanel = $('strategiesPanel');
                let strategiesHtml = `<div class="p-4 space-y-6">`;
                strategies_and_initiatives.forEach(item => {
                    strategiesHtml += `<div class="prescription-card">
                        <p class="text-sm font-semibold text-indigo-300">GOAL</p>
                        <h4 class="text-2xl font-bold mb-2">${item.goal}</h4>
                        <p class="rationale"><strong>System-Aware Strategy:</strong> ${item.strategy}</p>
                    </div>`;
                });
                strategiesHtml += `</div>`;
                strategiesPanel.innerHTML = strategiesHtml;

                // --- 3. Initiatives & KPIs Panel ---
                const initiativesPanel = $('initiativesPanel');
                let initiativesHtml = `<div class="p-4"><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>Initiative</th><th>Related Goal</th><th>KPIs to Track</th></tr></thead><tbody>`;
                strategies_and_initiatives.forEach(item => {
                    item.initiatives.forEach(initiative => {
                        initiativesHtml += `<tr><td>${initiative}</td><td>${item.goal}</td><td>${item.kpis.join(', ')}</td></tr>`;
                    });
                });
                initiativesHtml += `</tbody></table></div></div>`;
                initiativesPanel.innerHTML = initiativesHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); $(e.target.dataset.tab + 'Panel').classList.add('active'); } });
                $('analysisActions').classList.remove('hidden');
            }

            function createCreativeDissonanceLayout_NS(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-4xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-center text-white">Define the Dissonance</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="currentReality" class="block text-lg font-medium text-gray-200 mb-2"> Current Reality</label>
                                    <textarea id="currentReality" class="input-field h-48" placeholder="Describe your current situation, challenges, and limitations..."></textarea>
                                </div>
                                <div>
                                    <label for="futureVision" class="block text-lg font-medium text-gray-200 mb-2"> Future Vision</label>
                                    <textarea id="futureVision" class="input-field h-48" placeholder="Describe your ambitious, desired future state..."></textarea>
                                </div>
                            </div>
                             <h3 class="text-xl font-bold mt-6 mb-4 text-center text-white">Provide Additional Context (Optional)</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="dissonanceContextFile" class="block text-sm font-medium text-gray-200 mb-2">Business Document (.txt, .docx)</label>
                                    <div class="input-file-wrapper">
                                        <label for="dissonanceContextFile" id="dissonanceContextFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select context file...</span>
                                        </label>
                                        <input type="file" id="dissonanceContextFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <div>
                                    <label for="dissonanceDataFile" class="block text-sm font-medium text-gray-200 mb-2">Data File (.csv)</label>
                                    <div class="input-file-wrapper">
                                        <label for="dissonanceDataFile" id="dissonanceDataFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select data file...</span>
                                        </label>
                                        <input type="file" id="dissonanceDataFile" class="input-file" accept=".csv">
                                    </div>
                                </div>
                             </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Generate Creative Strategies</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Creative Dissonance Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                const attachListener = (inputId, labelId) => {
                    const fileInput = $(inputId);
                    if(fileInput) {
                        fileInput.addEventListener('change', (e) => {
                            const label = $(labelId);
                            const fileNameSpan = label.querySelector('.file-name');
                            if (e.target.files.length > 0) { fileNameSpan.textContent = e.target.files[0].name; } 
                            else { fileNameSpan.textContent = 'Select a file...'; }
                        });
                    }
                };
                attachListener('dissonanceContextFile', 'dissonanceContextFileLabel');
                attachListener('dissonanceDataFile', 'dissonanceDataFileLabel');
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();
            }

            async function handleCreativeDissonanceAnalysis_NS() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Analyzing the Creative Gap...</h3><p class="text-white/80 mb-2">Formulating data-driven initiatives...</p></div>`;

                try {
                    const currentReality = $('currentReality').value.trim();
                    const futureVision = $('futureVision').value.trim();
                    const contextFile = $('dissonanceContextFile').files[0];
                    const dataFile = $('dissonanceDataFile').files[0];

                    if (!currentReality || !futureVision) {
                        throw new Error("Please describe both your Current Reality and Future Vision.");
                    }

                    let businessContext = "No additional business document provided.";
                    if (contextFile) { businessContext = await extractTextFromFile(contextFile); }

                    let dataContext = "No additional data file provided.";
                    if (dataFile) {
                        dataContext = await extractTextFromFile(dataFile);
                        if (dataContext.length > 5000) { dataContext = dataContext.substring(0, 5000) + "\n... (data truncated)"; }
                    }

                    const prompt = `
                        You are a master strategist specializing in the Creative Dissonance framework. A user has defined their current reality, a desired future vision, and provided supporting documents.

                        **Analysis Context:**
                        - Current Reality: ${currentReality}
                        - Future Vision: ${futureVision}
                        - Business Context (from .txt/.docx): ${businessContext}
                        - Data Context (from .csv): ${dataContext}

                        **TASK:**
                        Perform a Creative Dissonance analysis. Your entire output must be derived **exclusively** from the information provided in the 'Current Reality', 'Future Vision', 'Business Context', and 'Data Context' sections.

                        **CRITICAL INSTRUCTIONS:**
                        - Do NOT invent or infer any problems, gaps, initiatives, or KPIs that are not directly supported by the provided texts.
                        - Your 'gap_analysis' must precisely identify the discrepancies between the 'reality_statement' and the 'vision_statement'.
                        - Your 'strategic_initiatives' must be designed specifically to close the identified gaps, referencing the provided context.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "dissonance_points": [
                            "From 'Stagnant DTC Sales' to 'Omnichannel Retail Presence'",
                            "From 'Packaging Unsuitable for Retail' to 'Shelf-Ready Product Lines'"
                          ],
                          "gap_analysis": [
                            {
                              "theme": "Market Channel",
                              "reality_statement": "The business currently relies on a single Direct-to-Consumer (DTC) channel, and sales have stagnated.",
                              "vision_statement": "The future vision involves diversifying into major national or regional specialty retail chains to increase revenue and brand visibility.",
                              "gap": "The core gap is the absence of any brick-and-mortar retail partnerships and the experience required to manage them."
                            },
                            {
                              "theme": "Operational Readiness",
                              "reality_statement": "Current product packaging is designed for e-commerce shipping, not for in-store shelves. The company lacks wholesale logistics experience.",
                              "vision_statement": "The vision requires a product line that is visually appealing on retail shelves and a supply chain capable of handling bulk orders.",
                              "gap": "There is a significant operational gap in packaging design and third-party logistics (3PL) capabilities."
                            }
                          ],
                          "strategic_initiatives": [
                            {
                              "initiative_name": "Retail Partnership Initiative",
                              "rationale": "This initiative directly addresses the 'Market Channel' gap by actively pursuing and securing the retail partnerships that are central to the future vision.",
                              "impact": "High",
                              "effort": "High",
                              "action_items": [
                                "Identify and engage with buyers from at least 10 target specialty retail chains.",
                                "Develop a wholesale pricing structure and partnership agreement template."
                              ],
                              "kpis_to_track": ["Number of Secured Retail Partnerships", "Total Revenue from Retail Channels", "Wholesale Order Volume"]
                            },
                            {
                              "initiative_name": "Operational Overhaul for Retail",
                              "rationale": "This initiative tackles the 'Operational Readiness' gap by developing the physical products and logistical capabilities required to successfully service retail partners.",
                              "impact": "High",
                              "effort": "Medium",
                              "action_items": [
                                "Redesign all primary product packaging to be shelf-ready and visually competitive.",
                                "Select and integrate with a third-party logistics (3PL) provider specializing in retail distribution."
                              ],
                              "kpis_to_track": ["Time to Fulfill Bulk Order", "Packaging Compliance Rate with Retailer Standards", "Logistics Cost per Unit"]
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderCreativeDissonancePage_NS(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Creative Dissonance Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            function renderCreativeDissonancePage_NS(container, data) {
                container.innerHTML = '';
                const { dissonance_points, gap_analysis, strategic_initiatives } = data;
                if (!dissonance_points || !gap_analysis || !strategic_initiatives) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button><button class="analysis-tab-btn" data-tab="gap"> Gap Analysis</button><button class="analysis-tab-btn" data-tab="initiatives"> Strategic Initiatives</button><button class="analysis-tab-btn" data-tab="kpis"> KPI Tracker</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="dashboardPanel" class="analysis-tab-panel active"></div><div id="gapPanel" class="analysis-tab-panel"></div><div id="initiativesPanel" class="analysis-tab-panel"></div><div id="kpisPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Dashboard Panel ---
                const dashboardPanel = $('dashboardPanel');
                let dashboardHtml = `<div class="p-4">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="dissonance-pole !h-auto">
                            <h3 class="text-2xl font-bold mb-4"> Current Reality</h3>
                            <p class="text-white/80">${$('currentReality').value}</p>
                        </div>
                        <div class="dissonance-pole !h-auto">
                            <h3 class="text-2xl font-bold mb-4"> Future Vision</h3>
                            <p class="text-white/80">${$('futureVision').value}</p>
                        </div>
                    </div>
                    <h3 class="text-2xl font-bold text-center mb-4">Initiative Prioritization Matrix</h3>
                    <div id="initiativeMatrixPlot" class="w-full h-[600px] plotly-chart"></div>
                </div>`;
                dashboardPanel.innerHTML = dashboardHtml;
                const impactMap = { 'Low': 1, 'Medium': 2, 'High': 3 }; const effortMap = { 'Low': 1, 'Medium': 2, 'High': 3 };
                const matrixData = { x: strategic_initiatives.map(a => effortMap[a.effort] || 1), y: strategic_initiatives.map(a => impactMap[a.impact] || 1), text: strategic_initiatives.map(a => a.initiative_name), mode: 'markers+text', textposition: 'top center', marker: { size: 20, color: 'var(--primary)' } };
                const matrixLayout = { paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: { title: 'Effort', range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ['Low', 'Medium', 'High'], gridcolor: 'rgba(255,255,255,0.2)' }, yaxis: { title: 'Impact', range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ['Low', 'Medium', 'High'], gridcolor: 'rgba(255,255,255,0.2)' }, shapes: [ { type: 'line', x0: 2, y0: 0.5, x1: 2, y1: 3.5, line: { color: 'rgba(255,255,255,0.3)', width: 2, dash: 'dash' } }, { type: 'line', x0: 0.5, y0: 2, x1: 3.5, y1: 2, line: { color: 'rgba(255,255,255,0.3)', width: 2, dash: 'dash' } } ], annotations: [ {x: 1, y: 3, text: 'Quick Wins', showarrow: false, font: {size: 16, color: 'rgba(255,255,255,0.5)'}}, {x: 3, y: 3, text: 'Major Projects', showarrow: false, font: {size: 16, color: 'rgba(255,255,255,0.5)'}}, {x: 1, y: 1, text: 'Fill-ins', showarrow: false, font: {size: 16, color: 'rgba(255,255,255,0.5)'}}, {x: 3, y: 1, text: 'Thankless Tasks', showarrow: false, font: {size: 16, color: 'rgba(255,255,255,0.5)'}}, ] };
                Plotly.newPlot('initiativeMatrixPlot', [matrixData], matrixLayout, {responsive: true});

                // --- 2. Gap Analysis Panel ---
                const gapPanel = $('gapPanel');
                let gapHtml = `<div class="p-4 space-y-6">`;
                gap_analysis.forEach(gap => {
                    gapHtml += `<div class="insight-card"><h4 class="text-xl font-bold mb-3">${gap.theme}</h4><p class="mb-2"><strong>Current State:</strong> ${gap.reality_statement}</p><p class="mb-3"><strong>Future State:</strong> ${gap.vision_statement}</p><div class="p-3 bg-black/20 rounded border-l-4 border-yellow-400"><p><strong>Identified Gap:</strong> ${gap.gap}</p></div></div>`;
                });
                gapHtml += `</div>`;
                gapPanel.innerHTML = gapHtml;

                // --- 3. Strategic Initiatives Panel ---
                const initiativesPanel = $('initiativesPanel');
                let initiativesHtml = `<div class="p-4">`;
                strategic_initiatives.forEach(p => {
                    initiativesHtml += `<div class="prescription-card"><h4>${p.initiative_name}</h4><p class="rationale"><strong>Strategic Rationale:</strong> ${p.rationale}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm"><div class="bg-black/20 p-3 rounded"><h5 class="font-bold text-yellow-300 mb-2">Action Items</h5><ul class="list-disc list-inside space-y-1">${p.action_items.map(a => `<li>${a}</li>`).join('')}</ul></div><div class="bg-black/20 p-3 rounded"><h5 class="font-bold text-yellow-300 mb-2">KPIs to Track</h5><p>${p.kpis_to_track.join(', ')}</p></div></div></div>`;
                });
                initiativesHtml += `</div>`;
                initiativesPanel.innerHTML = initiativesHtml;
                
                // --- 4. KPI Tracker Panel ---
                const kpisPanel = $('kpisPanel');
                let kpisHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Consolidated KPI Tracker</h3><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>KPI to Track</th><th>Related Initiative</th></tr></thead><tbody>`;
                strategic_initiatives.forEach(p => {
                    p.kpis_to_track.forEach(kpi => { kpisHtml += `<tr><td>${kpi}</td><td>${p.initiative_name}</td></tr>`; });
                });
                kpisHtml += `</tbody></table></div></div>`;
                kpisPanel.innerHTML = kpisHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                // --- THIS IS THE CORRECTED LINE ---
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); const targetPanel = $(e.target.dataset.tab + 'Panel'); targetPanel.classList.add('active'); const chart = targetPanel.querySelector('.plotly-chart'); if (chart) { Plotly.Plots.resize(chart); } } });
                $('analysisActions').classList.remove('hidden');
            }

            function createLivingSystemLayout_NS(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-4xl mx-auto w-full p-6 space-y-6">
                             <h3 class="text-xl font-bold mb-4 text-center text-white">Describe Your Living System</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Detailed Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="lsCoreIdentity" class="block text-lg font-medium text-gray-200 mb-2"> Core Identity (DNA)</label>
                                        <textarea id="lsCoreIdentity" class="input-field h-32" placeholder="What is your organization's fundamental purpose, mission, and core values?"></textarea>
                                    </div>
                                    <div>
                                        <label for="lsEnvironment" class="block text-lg font-medium text-gray-200 mb-2"> Environment</label>
                                        <textarea id="lsEnvironment" class="input-field h-32" placeholder="Describe your market, competitors, customers, and key trends."></textarea>
                                    </div>
                                    <div>
                                        <label for="lsMetabolism" class="block text-lg font-medium text-gray-200 mb-2"> Metabolism</label>
                                        <textarea id="lsMetabolism" class="input-field h-32" placeholder="How does your organization take in resources (revenue, talent, data) and convert them into value?"></textarea>
                                    </div>
                                    <div>
                                        <label for="lsNervousSystem" class="block text-lg font-medium text-gray-200 mb-2"> Nervous System</label>
                                        <textarea id="lsNervousSystem" class="input-field h-32" placeholder="How does information flow? How do you sense changes and make decisions?"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div id="docUploadArea" class="hidden max-w-md mx-auto">
                                <div class="input-file-wrapper">
                                    <label for="lsFile" id="lsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="lsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Diagnose Living System</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">System Health Analysis</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('lsFile', 'lsFileLabel', 'textInputArea', 'docUploadArea');
            }

            async function handleLivingSystemAnalysis_NS() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Diagnosing System Health...</h3><p class="text-white/80 mb-2">Analyzing metabolism, nervous system, and immune response...</p></div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';

                    if (useDoc) {
                        const file = $('lsFile').files[0];
                        if (!file) throw new Error("Please select a document.");
                        text = await extractTextFromFile(file);
                    } else {
                        const coreIdentity = $('lsCoreIdentity').value.trim();
                        const environment = $('lsEnvironment').value.trim();
                        const metabolism = $('lsMetabolism').value.trim();
                        const nervousSystem = $('lsNervousSystem').value.trim();
                        if (!coreIdentity || !environment || !metabolism || !nervousSystem) {
                            throw new Error("Please fill out all four detailed input sections.");
                        }
                        text = `Core Identity (DNA): ${coreIdentity}\n\nEnvironment: ${environment}\n\nMetabolism: ${metabolism}\n\nNervous System: ${nervousSystem}`;
                    }

                    if (text.length > 15000) { text = text.substring(0, 15000); }

                    const prompt = `
                        You are a master strategist specializing in the "Living System" framework. A user has provided a description of their organization. Your primary task is to diagnose the health of the system based *strictly* on the evidence provided by the user.

                        **System Description:**
                        ${text}

                        **TASK:**
                        Perform a comprehensive Living System diagnosis. The 'health_status' for each system MUST be a direct reflection of the problems or strengths described in the user's text. For example, if the text mentions 'stagnated sales', the 'Metabolism' cannot be 'Robust'. Your interventions must be specific strategies to fix the identified weaknesses.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "overall_diagnosis": "The organization's metabolism has stalled due to over-reliance on a single metabolic pathway (DTC channel). Its nervous system is too slow to sense and adapt to the changing environment, making its growth fragile.",
                          "system_analysis": [
                            {
                              "system_name": "Metabolism",
                              "health_status": "Strained",
                              "analysis": "The system's ability to convert resources (investment) into value (sales growth) has stalled, as evidenced by stagnated sales. It is stuck in a single, saturated metabolic pathway (DTC channel) and is not efficiently acquiring new energy from its environment."
                            },
                            {
                              "system_name": "Nervous System",
                              "health_status": "Strained",
                              "analysis": "The system was slow to sense the saturation of its primary channel. Decision-making is reactive, based on lagging indicators (stagnant sales) rather than proactive sensing of market shifts."
                            },
                            {
                              "system_name": "Immune System",
                              "health_status": "Fragile",
                              "analysis": "The organization is vulnerable to external threats like larger competitors entering the clean beauty market. It lacks the systemic resilience that a diversity of channels would provide."
                            },
                            {
                              "system_name": "Growth & Adaptation",
                              "health_status": "Fragile",
                              "analysis": "The system has failed to adapt by finding new ways to grow (new channels). Current growth mechanisms are exhausted, and the organization must now evolve its structure to survive."
                            }
                          ],
                          "strategic_interventions": [
                            {
                              "initiative_name": "Develop New Metabolic Pathways (Channel Diversification)",
                              "target_system": "Metabolism",
                              "rationale": "To create new, resilient ways for the organization to acquire energy (revenue) by tapping into the resource-rich retail environment. This directly addresses the stagnated sales.",
                              "action_items": [
                                "Launch the 'Retail Partnership Initiative' to secure placement in major retail chains.",
                                "Develop retail-ready packaging and a 3PL partnership to support wholesale distribution."
                              ],
                              "kpis_to_track": ["Revenue from Retail Channels", "Number of New Retail Partnerships", "Wholesale Order Volume"]
                            },
                            {
                              "initiative_name": "Enhance Environmental Sensors",
                              "target_system": "Nervous System",
                              "rationale": "To improve the organization's ability to sense market opportunities and threats proactively, preventing future instances of being caught off-guard by market saturation.",
                              "action_items": [
                                "Establish a formal process for monitoring competitor activities in the clean beauty space.",
                                "Implement regular 'Voice of the Customer' surveys to track changing consumer preferences."
                              ],
                              "kpis_to_track": ["Time to Detect Competitor Launch", "Accuracy of Sales Forecasts", "Customer Satisfaction (CSAT)"]
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderLivingSystemPage_NS(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Living System Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            function renderLivingSystemPage_NS(container, data) {
                container.innerHTML = '';
                const { overall_diagnosis, system_analysis, strategic_interventions } = data;
                if (!overall_diagnosis || !system_analysis) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="dashboard"> System Health</button><button class="analysis-tab-btn" data-tab="deepdive"> Deep Dive</button><button class="analysis-tab-btn" data-tab="interventions"> Interventions</button><button class="analysis-tab-btn" data-tab="kpis"> KPI Tracker</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="dashboardPanel" class="analysis-tab-panel active"></div><div id="deepdivePanel" class="analysis-tab-panel"></div><div id="interventionsPanel" class="analysis-tab-panel"></div><div id="kpisPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Dashboard Panel ---
                const dashboardPanel = $('dashboardPanel');
                let dashboardHtml = `<div class="p-4">
                    <blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 mb-8"><strong>Overall Diagnosis:</strong> ${overall_diagnosis}</blockquote>
                    <div class="ls-dashboard-container">
                        <div class="ls-core">
                            <h3 class="text-xl font-bold">Core Identity</h3>
                            <p class="text-sm text-white/70">${$('lsCoreIdentity')?.value || 'N/A'}</p>
                        </div>`;
                
                const positions = [ { top: '50%', left: '5%', transform: 'translateY(-50%)' }, { top: '5%', left: '50%', transform: 'translateX(-50%)' }, { top: '50%', right: '5%', transform: 'translateY(-50%)' }, { bottom: '5%', left: '50%', transform: 'translateX(-50%)' } ];
                (system_analysis || []).forEach((sys, index) => {
                    const pos = positions[index % positions.length];
                    const healthClass = `ls-health-${(sys.health_status || 'strained').toLowerCase()}`;
                    dashboardHtml += `<div class="ls-system-node ${healthClass}" style="top:${pos.top || 'auto'}; left:${pos.left || 'auto'}; right:${pos.right || 'auto'}; bottom:${pos.bottom || 'auto'}; transform:${pos.transform};">
                        <h4 class="font-bold">${sys.system_name}</h4><p class="text-lg font-bold mt-1">${sys.health_status}</p></div>`;
                });
                dashboardHtml += `</div></div>`;
                dashboardPanel.innerHTML = dashboardHtml;

                // --- 2. Deep Dive Panel ---
                const deepdivePanel = $('deepdivePanel');
                let deepdiveHtml = `<div class="p-4 space-y-6">`;
                (system_analysis || []).forEach(sys => {
                    const healthClass = `ls-health-${(sys.health_status || 'strained').toLowerCase()}`;
                    deepdiveHtml += `<div class="insight-card ${healthClass}"><h4 class="text-xl font-bold mb-2">${sys.system_name} - <span class="font-semibold">${sys.health_status}</span></h4><p class="text-white/90">${sys.analysis}</p></div>`;
                });
                deepdiveHtml += `</div>`;
                deepdivePanel.innerHTML = deepdiveHtml;
                
                // --- 3. Interventions Panel ---
                const interventionsPanel = $('interventionsPanel');
                let interventionsHtml = `<div class="p-4">`;
                (strategic_interventions || []).forEach(p => {
                    interventionsHtml += `<div class="prescription-card"><h4>${p.initiative_name}</h4><p class="text-sm font-semibold text-indigo-300">TARGET SYSTEM: ${p.target_system}</p><p class="rationale"><strong>Strategic Rationale:</strong> ${p.rationale}</p><div class="bg-black/20 p-3 rounded text-sm"><h5 class="font-bold text-yellow-300 mb-2">Action Items</h5><ul class="list-disc list-inside space-y-1">${(p.action_items || []).map(a => `<li>${a}</li>`).join('')}</ul></div></div>`;
                });
                interventionsHtml += `</div>`;
                interventionsPanel.innerHTML = interventionsHtml;
                
                // --- 4. KPI Tracker Panel ---
                const kpisPanel = $('kpisPanel');
                let kpisHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Consolidated KPI Tracker</h3><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>KPI to Track</th><th>Related Initiative</th><th>Target System</th></tr></thead><tbody>`;
                (strategic_interventions || []).forEach(p => {
                    // --- THIS IS THE CORRECTED LINE ---
                    (p.kpis_to_track || []).forEach(kpi => { 
                        kpisHtml += `<tr><td>${kpi}</td><td>${p.initiative_name || 'N/A'}</td><td>${p.target_system || 'N/A'}</td></tr>`;
                    });
                });
                kpisHtml += `</tbody></table></div></div>`;
                kpisPanel.innerHTML = kpisHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); $(e.target.dataset.tab + 'Panel').classList.add('active'); } });
                $('analysisActions').classList.remove('hidden');
            }

           function createThinkingSystemLayout_NS(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Describe a Belief or Conclusion</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="tsContent" class="input-field h-48" placeholder="Describe a belief, conclusion, or decision that has led to a recurring problem. For example: 'I believe our marketing campaigns are failing because the creative team is uninspired.'"></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="tsFile" id="tsFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="tsFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3 mt-4">
                                <span id="generateBtnText"> Deconstruct Thinking</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis of Your Thinking System</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('tsFile', 'tsFileLabel', 'textInputArea', 'docUploadArea');
            }

           async function handleThinkingSystemAnalysis_NS() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Deconstructing Mental Models...</h3><p class="text-white/80 mb-2">Analyzing your thought process to uncover new paths...</p></div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let belief = '';

                    if (useDoc) {
                        const file = $('tsFile').files[0];
                        if (!file) throw new Error("Please select a document.");
                        belief = await extractTextFromFile(file);
                    } else {
                        belief = $('tsContent').value.trim();
                        if (!belief) { throw new Error("Please describe a belief or conclusion to analyze."); }
                    }
                    
                    if (belief.length > 15000) { belief = belief.substring(0, 15000); }

                    const prompt = `
                        You are a master strategist specializing in the "Ladder of Inference" framework. A user has provided a document describing a business problem.

                        **User's Document:**
                        ${belief}

                        **TASK:**
                        Perform a comprehensive Ladder of Inference analysis. 
                        1. First, read the document and infer the implicit, problematic belief at the top of the ladder that is causing the business problem.
                        2. Deconstruct this inferred belief by working DOWN the ladder, basing each rung on the evidence in the document.
                        3. Propose a new, more constructive path UP the ladder by reframing the problem.
                        4. Formulate specific, actionable initiatives based on this new perspective.
                        Your entire analysis must be strictly derived from the user's document. Do NOT invent unrelated problems.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "deconstruction": {
                            "action": "Continue focusing only on the existing Direct-to-Consumer (DTC) channel.",
                            "belief": "Our brand and products are strong, so sales should grow if we just keep doing what we're doing.",
                            "conclusion": "The recent sales stagnation is a temporary dip, not a systemic problem.",
                            "assumption": "I assume our target market is exclusively online and that the DTC channel has infinite growth potential.",
                            "interpretation": "I interpret 'stagnated sales' as a minor fluctuation rather than a signal of market saturation.",
                            "selection": "I am selecting to focus only on our historical DTC sales data and ignoring the broader market trend towards omnichannel shopping.",
                            "observation": "Observable reality: Sales have stagnated. We operate in a single DTC channel. Larger competitors are in retail stores."
                          },
                          "reframing": {
                            "critical_question": "What if our assumption is wrong? What if the DTC channel is saturated and growth now requires entering new channels where customers are?",
                            "new_observation": "Let's re-examine the full reality: Our DTC sales have flatlined. Competitors are succeeding in physical retail. Our packaging and logistics are not prepared for this.",
                            "new_interpretation": "'Stagnated sales' is not a fluctuation; it's a 'Limits to Growth' signal. Our single-channel system has reached its limit.",
                            "new_conclusion": "The problem is not our product, but our channel. To grow, we must diversify and meet customers where they are: in retail stores."
                          },
                          "new_actions": [
                            {
                              "action_name": "Launch the 'Retail Partnership Initiative'",
                              "rationale": "This action directly tests the new conclusion that growth requires channel diversification. It moves from belief to action by entering the retail environment.",
                              "steps": [
                                "Identify and engage with buyers from at least 10 target specialty retail chains.",
                                "Develop a wholesale pricing structure and partnership agreement template.",
                                "Allocate budget for trade marketing and in-store promotions."
                              ],
                              "kpis": ["Number of Secured Retail Partnerships", "Total Revenue from Retail Channels", "Wholesale Order Volume"]
                            },
                            {
                              "action_name": "Initiate Operational Overhaul for Retail",
                              "rationale": "This action addresses the 'Observation' that we are unprepared for retail. It builds the necessary capabilities to act on the new conclusion, breaking down the operational barriers to growth.",
                              "steps": [
                                "Begin redesign of all primary product packaging to be shelf-ready and visually competitive.",
                                "Select and integrate with a third-party logistics (3PL) provider specializing in retail distribution.",
                                "Revise demand forecasting models to account for bulk wholesale orders."
                              ],
                              "kpis": ["Time to Fulfill Bulk Order", "Packaging Compliance Rate with Retailer Standards", "Logistics Cost per Unit"]
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderThinkingSystemPage_NS(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Thinking System Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            function renderThinkingSystemPage_NS(container, data) {
                container.innerHTML = '';
                const { deconstruction, reframing, new_actions } = data;
                if (!deconstruction || !reframing || !new_actions) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="ladder"> The Ladder</button><button class="analysis-tab-btn" data-tab="reframing"> Analysis & Reframing</button><button class="analysis-tab-btn" data-tab="actions"> New Actions</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="ladderPanel" class="analysis-tab-panel active"></div><div id="reframingPanel" class="analysis-tab-panel"></div><div id="actionsPanel" class="analysis-tab-panel"></div>`;

                // --- 1. The Ladder Panel ---
                const ladderPanel = $('ladderPanel');
                ladderPanel.innerHTML = `<div class="ladder-container">
                    <div class="ladder-rung"><h4>OBSERVATION</h4><p>${deconstruction.observation}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>SELECTION</h4><p>${deconstruction.selection}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>INTERPRETATION</h4><p>${deconstruction.interpretation}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>ASSUMPTION</h4><p>${deconstruction.assumption}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>CONCLUSION</h4><p>${deconstruction.conclusion}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>BELIEF</h4><p>${deconstruction.belief}</p></div>
                    <div class="ladder-arrow"></div>
                    <div class="ladder-rung"><h4>ACTION</h4><p>${deconstruction.action}</p></div>
                </div>`;

                // --- 2. Analysis & Reframing Panel ---
                const reframingPanel = $('reframingPanel');
                reframingPanel.innerHTML = `<div class="p-4 space-y-6">
                    <div class="insight-card">
                        <h4 class="text-xl font-bold text-indigo-300">The Critical Question to Ask:</h4>
                        <p class="text-white/90 text-lg mt-2">${reframing.critical_question}</p>
                    </div>
                    <div class="insight-card">
                        <h4 class="text-xl font-bold">Reframing Your Perspective</h4>
                        <p class="mt-2"><strong>1. Broaden Your Observation:</strong> Instead of only looking at creative and engagement, consider the full picture: <code>${reframing.new_observation}</code></p>
                        <p class="mt-2"><strong>2. Propose a New Interpretation:</strong> With the full data, a new possibility emerges: <code>${reframing.new_interpretation}</code></p>
                        <p class="mt-2"><strong>3. Form a New Conclusion:</strong> This leads to a more nuanced conclusion: <code>${reframing.new_conclusion}</code></p>
                    </div>
                </div>`;
                
                // --- 3. New Actions Panel ---
                const actionsPanel = $('actionsPanel');
                let actionsHtml = `<div class="p-4">`;
                new_actions.forEach(p => {
                    actionsHtml += `<div class="prescription-card">
                        <h4>${p.action_name}</h4>
                        <p class="rationale"><strong>Strategic Rationale:</strong> ${p.rationale}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                            <div class="bg-black/20 p-3 rounded"><h5 class="font-bold text-yellow-300 mb-2">Steps to Take</h5><ul class="list-disc list-inside space-y-1">${p.steps.map(a => `<li>${a}</li>`).join('')}</ul></div>
                            <div class="bg-black/20 p-3 rounded"><h5 class="font-bold text-yellow-300 mb-2">KPIs to Track</h5><p>${p.kpis.join(', ')}</p></div>
                        </div>
                    </div>`;
                });
                actionsHtml += `</div>`;
                actionsPanel.innerHTML = actionsHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); $(e.target.dataset.tab + 'Panel').classList.add('active'); } });
                $('analysisActions').classList.remove('hidden');
            }


            function createSwotTowsLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12'; // Change class for this layout
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container p-6 max-w-2xl mx-auto w-full">
                            <h3 class="text-xl font-bold mb-4 text-white">Business Information</h3>
                            <div class="space-y-4">
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="businessContent" class="input-field h-48" placeholder="Describe your business, industry, market position, challenges, opportunities, etc."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                     <div class="input-file-wrapper">
                                         <label for="swotFile" id="swotFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Click to select a file...</span>
                                         </label>
                                         <input type="file" id="swotFile" class="input-file" accept=".txt,.pdf,.docx">
                                    </div>
                                    <p class="text-xs text-white/50 mt-2 text-center">Note: Only .txt files can be read by the browser. PDF/DOCX are not supported for reading.</p>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText">Run SWOT/TOWS Analysis</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>

                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;

                // Re-attach event listeners for the newly created elements
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();

                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult'));
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }
                
                // Listeners for radio buttons
                $('textInput').addEventListener('change', () => {
                    $('textInputArea').classList.remove('hidden');
                    $('docUploadArea').classList.add('hidden');
                });
                $('docUpload').addEventListener('change', () => {
                    $('textInputArea').classList.add('hidden');
                    $('docUploadArea').classList.remove('hidden');
                });
                 // Listener for file input
                const fileInput = $('swotFile');
                if(fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const label = $('swotFileLabel');
                        const fileNameSpan = label.querySelector('.file-name');
                        if (e.target.files.length > 0) {
                            fileNameSpan.textContent = e.target.files[0].name;
                            label.classList.add('has-file');
                        } else {
                            fileNameSpan.textContent = 'Click to select a file...';
                            label.classList.remove('has-file');
                        }
                    });
                }
            }

            function createMiscLayout_MSC(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide Full Strategic Plan / Business Document</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="miscContent" class="input-field h-48" placeholder="Paste your complete business plan, strategic analysis, or project proposal here..."></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                <div class="input-file-wrapper">
                                    <label for="miscFile" id="miscFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                    </label>
                                    <input type="file" id="miscFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Compile Final Report</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Final Sections</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto"></div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;
                setupInputToggle('miscFile', 'miscFileLabel', 'textInputArea', 'docUploadArea');
            }

            function createLeveragePointsLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12'; // Single column layout
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide System Description</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="leverageContent" class="input-field h-48" placeholder="Describe the system, its components, the goal of the system, and any challenges or inefficiencies you have observed..."></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                 <div class="input-file-wrapper">
                                     <label for="leverageFile" id="leverageFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                     </label>
                                     <input type="file" id="leverageFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Find Leverage Points</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

                // Re-attach all necessary event listeners for the new elements
                setupInputToggle('leverageFile', 'leverageFileLabel', 'textInputArea', 'docUploadArea');
            }
            
            function createArchetypeAnalysisLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12'; // Change layout to single column
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                         <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                         <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                    
                        <div class="glass-container max-w-2xl mx-auto w-full p-6 space-y-4">
                             <h3 class="text-xl font-bold mb-4 text-white">Provide System Information</h3>
                            <div class="input-radio-group">
                                <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                <label for="textInput" class="input-radio-label">Text Input</label>
                                <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                <label for="docUpload" class="input-radio-label">Document Upload</label>
                            </div>
                            <div id="textInputArea">
                                <textarea id="archetypeContent" class="input-field h-48" placeholder="Describe the system, its components, behaviors, and any recurring problems or patterns you have observed..."></textarea>
                            </div>
                            <div id="docUploadArea" class="hidden">
                                 <div class="input-file-wrapper">
                                     <label for="archetypeFile" id="archetypeFileLabel" class="input-file-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                        <span class="file-name">Select .docx or .txt file...</span>
                                     </label>
                                     <input type="file" id="archetypeFile" class="input-file" accept=".txt,.docx">
                                </div>
                            </div>
                            <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                <span id="generateBtnText"> Analyze System</span>
                                <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                            </button>
                        </div>
                        
                        <div class="mt-12">
                             <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                             <div id="analysisResult" class="glass-container min-h-[500px] overflow-x-auto">
                             </div>
                             <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

                // Attach event listeners
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();
                
                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult'));
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }
                
                // Add listeners for radio buttons and file input
                $('textInput').addEventListener('change', () => {
                    $('textInputArea').classList.remove('hidden');
                    $('docUploadArea').classList.add('hidden');
                });
                $('docUpload').addEventListener('change', () => {
                    $('textInputArea').classList.add('hidden');
                    $('docUploadArea').classList.remove('hidden');
                });

                const fileInput = $('archetypeFile');
                 if(fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const label = $('archetypeFileLabel');
                        const fileNameSpan = label.querySelector('.file-name');
                        if (e.target.files.length > 0) {
                            fileNameSpan.textContent = e.target.files[0].name;
                            label.classList.add('has-file');
                        } else {
                            fileNameSpan.textContent = 'Select .docx or .txt file...';
                            label.classList.remove('has-file');
                        }
                    });
                }
            }
            
            function createFactorAnalysisLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-4">
                               <h3 class="text-xl font-bold mb-4 text-white">Provide Business Information</h3>
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="factorContent" class="input-field h-48" placeholder="Describe your business, its operations, market environment, and internal resources..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="factorFile" id="factorFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .txt or .docx file...</span>
                                        </label>
                                        <input type="file" id="factorFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                    <div id="fileStats" class="text-sm text-white/70 text-center mt-2"></div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Analyze Factors</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                            </div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;

                // Attach event listeners
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();
                
                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult'));
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }

                 // Add listeners for radio buttons and file input
                $('textInput').addEventListener('change', () => {
                    $('textInputArea').classList.remove('hidden');
                    $('docUploadArea').classList.add('hidden');
                });
                $('docUpload').addEventListener('change', () => {
                    $('textInputArea').classList.add('hidden');
                    $('docUploadArea').classList.remove('hidden');
                });

                const fileInput = $('factorFile');
                if (fileInput) {
                    fileInput.addEventListener('change', async (e) => {
                        const label = $('factorFileLabel');
                        const fileNameSpan = label.querySelector('.file-name');
                        const fileStats = $('fileStats');
                        if (e.target.files.length > 0) {
                            const file = e.target.files[0];
                            fileNameSpan.textContent = file.name;
                            label.classList.add('has-file');
                            try {
                                const text = await extractTextFromFile(file);
                                fileStats.innerHTML = `<p>Word Count: ${text.split(/\s+/).length}</p><p>Character Count: ${text.length}</p>`;
                            } catch (err) {
                                fileStats.innerHTML = `<p class="text-red-400">Error reading file.</p>`;
                            }
                        } else {
                            fileNameSpan.textContent = 'Select .txt or .docx file...';
                            label.classList.remove('has-file');
                            fileStats.innerHTML = '';
                        }
                    });
                }
            }

            function createParetoLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div>
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="max-w-2xl mx-auto">
                            <div class="glass-container p-6 space-y-4">
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <label for="problemStatement" class="block text-sm font-medium text-gray-200 mb-2">Problem Statement</label>
                                    <textarea id="problemStatement" class="input-field h-32" placeholder="Describe the problem you want to analyze, including symptoms, context, and any known contributing factors..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                     <div class="input-file-wrapper">
                                         <label for="paretoFile" id="paretoFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Click to select a file...</span>
                                         </label>
                                         <input type="file" id="paretoFile" class="input-file" accept=".txt,.pdf,.docx">
                                    </div>
                                    <p class="text-xs text-white/50 mt-2 text-center">Upload a document describing the problem.</p>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText">Analyze Root Causes</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto">
                            </div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>
                `;

                // Restore from cache or set default
                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult'));
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }
                
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();

                 // Add listeners for radio buttons and file input
                $('textInput').addEventListener('change', () => {
                    $('textInputArea').classList.remove('hidden');
                    $('docUploadArea').classList.add('hidden');
                });
                $('docUpload').addEventListener('change', () => {
                    $('textInputArea').classList.add('hidden');
                    $('docUploadArea').classList.remove('hidden');
                });

                const fileInput = $('paretoFile');
                if(fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const label = $('paretoFileLabel');
                        const fileNameSpan = label.querySelector('.file-name');
                        if (e.target.files.length > 0) {
                            fileNameSpan.textContent = e.target.files[0].name;
                            label.classList.add('has-file');
                        } else {
                            fileNameSpan.textContent = 'Click to select a file...';
                            label.classList.remove('has-file');
                        }
                    });
                }
            }
            
            function createProcessMappingLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                    <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>

                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-4">
                               <h3 class="text-xl font-bold mb-4 text-white">Process Information</h3>
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="processContent" class="input-field h-48" placeholder="Describe the business process from start to finish. Include the steps, roles involved, and any decision points..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="processFile" id="processFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .txt or .docx file...</span>
                                        </label>
                                        <input type="file" id="processFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Map Process</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"></div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;
                setupInputToggle('processFile', 'processFileLabel', 'textInputArea', 'docUploadArea');
            }

            function createSystemThinkingLayout(template) {
                const contentContainer = $('templateDetailContent');
                contentContainer.className = 'grid lg:grid-cols-1 gap-12';
                contentContainer.innerHTML = `
                     <div class="lg:col-span-1">
                        <h1 class="text-4xl font-bold text-center mb-2">${template.title}</h1>
                        <p class="text-lg text-white/80 text-center mb-12 max-w-3xl mx-auto">${template.description}</p>
                        <div class="max-w-2xl mx-auto w-full">
                            <div class="glass-container p-6 space-y-4">
                                <h3 class="text-xl font-bold mb-4 text-white">System Description</h3>
                                <div class="input-radio-group">
                                    <input type="radio" name="inputType" id="textInput" class="input-radio" checked>
                                    <label for="textInput" class="input-radio-label">Text Input</label>
                                    <input type="radio" name="inputType" id="docUpload" class="input-radio">
                                    <label for="docUpload" class="input-radio-label">Document Upload</label>
                                </div>
                                <div id="textInputArea">
                                    <textarea id="systemContent" class="input-field h-48" placeholder="Describe the system you want to analyze. Include key elements, their relationships, and any observed behaviors or problems..."></textarea>
                                </div>
                                <div id="docUploadArea" class="hidden">
                                    <div class="input-file-wrapper">
                                        <label for="systemFile" id="systemFileLabel" class="input-file-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/></svg>
                                            <span class="file-name">Select .txt or .docx file...</span>
                                        </label>
                                        <input type="file" id="systemFile" class="input-file" accept=".txt,.docx">
                                    </div>
                                </div>
                                <button id="generateBtn" class="btn btn-primary w-full text-lg py-3">
                                    <span id="generateBtnText"> Analyze System Dynamics</span>
                                    <span id="generateSpinner" class="loading-spinner hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-12">
                            <h2 class="text-3xl font-bold mb-4 text-center">Analysis Results</h2>
                            <div id="analysisResult" class="glass-container min-h-[300px] overflow-x-auto"></div>
                            <div id="analysisActions" class="text-center mt-4 space-x-2 hidden">
                                <button id="savePdfBtn" class="btn btn-secondary">Save as PDF</button>
                                <button id="saveDocxBtn" class="btn btn-secondary">Save as DOCX</button>
                            </div>
                        </div>
                    </div>`;
                setupInputToggle('systemFile', 'systemFileLabel', 'textInputArea', 'docUploadArea');
            }
            
           function setupInputToggle(fileInputId, fileLabelId, textInputAreaId, docUploadAreaId) {
                $('generateBtn').addEventListener('click', handleGenerate);
                reattachActionListeners();

                if (analysisCache[currentTemplateId]) {
                    $('analysisResult').innerHTML = analysisCache[currentTemplateId];
                    $('analysisActions').classList.remove('hidden');
                    reattachTabListeners($('analysisResult'));
                } else {
                    $('analysisResult').innerHTML = '<div class="text-white/60 p-8 text-center">Your generated analysis will appear here.</div>';
                    $('analysisActions').classList.add('hidden');
                }
                
                // --- THIS IS THE FIX ---
                // Only add radio button listeners if the elements actually exist on the page.
                const textInput = $('textInput');
                const docUpload = $('docUpload');
                if (textInput && docUpload && $(textInputAreaId) && $(docUploadAreaId)) {
                    textInput.addEventListener('change', () => {
                        $(textInputAreaId).classList.remove('hidden');
                        $(docUploadAreaId).classList.add('hidden');
                    });
                    docUpload.addEventListener('change', () => {
                        $(textInputAreaId).classList.add('hidden');
                        $(docUploadAreaId).classList.remove('hidden');
                    });
                }
                // --- END OF FIX ---

                const fileInput = $(fileInputId);
                if(fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const label = $(fileLabelId);
                        const fileNameSpan = label.querySelector('.file-name');
                        if (e.target.files.length > 0) {
                            fileNameSpan.textContent = e.target.files[0].name;
                            label.classList.add('has-file');
                        } else {
                            fileNameSpan.textContent = 'Click to select a file...';
                            label.classList.remove('has-file');
                        }
                    });
                }
            }



            function frameworkCheckboxChangeHandler() {
                const checkedBoxes = document.querySelectorAll('#frameworkList .method-checkbox:checked');
                const selectionCounter = $('selectionCounter');
                
                if (checkedBoxes.length > currentSelectionLimit) {
                    this.checked = false;
                }

                const finalCheckedCount = document.querySelectorAll('#frameworkList .method-checkbox:checked').length;
                if(selectionCounter) {
                    selectionCounter.textContent = `Selected: ${finalCheckedCount} / ${currentSelectionLimit}`;
                }
            }
            
            function configureFrameworkSelector(limit) {
                currentSelectionLimit = limit;
                const selectionCounter = $('selectionCounter');
                const checkboxes = document.querySelectorAll('#frameworkList .method-checkbox');
                
                if(!selectionCounter || !checkboxes) return;

                selectionCounter.textContent = `Selected: 0 / ${limit}`;
                
                const rule = templateRules[currentTemplateId] || {};
                if (!rule.preselectFramework) {
                     checkboxes.forEach(cb => {
                        cb.checked = false;
                    });
                }
                 frameworkCheckboxChangeHandler();
            }

            function getSelectedFrameworks() {
                const checkedBoxes = document.querySelectorAll('#frameworkList .method-checkbox:checked');
                const selectedMethods = [];

                const frameworkMap = {
                    'Reframing Thinking': 'ReframingThinking',
                    'Delphi Method': 'DelphiMethod',
                    'Blue Ocean Strategy': 'BlueOcean',
                    'Design Thinking': 'DesignThinking',
                    'Thinking Hats': 'ThinkingHats',
                    'Business Model Canvas': 'BusinessModelCanvas',
                    'SCAMPER': 'SCAMPER',
                    'TRIZ (Theory of Inventive Problem Solving)': 'TRIZ'
                };

                checkedBoxes.forEach(checkbox => {
                    const methodText = checkbox.dataset.framework;
                    if (frameworkMap[methodText]) {
                        selectedMethods.push(frameworkMap[methodText]);
                    }
                });
                return selectedMethods.join(',');
            }

            function getSelectedSections() {
                const checkedBoxes = document.querySelectorAll('#analysisList .method-checkbox:checked');
                const sectionMap = {
                    'Introduction': 'introduction',
                    'Overview of business': 'overview_of_business',
                    'process overview': 'process_overview',
                    'mission statement': 'mission_statement',
                    'vision analysis': 'vision_analysis',
                    'vision statement 2': 'vision_statement_2',
                    'novel strategy part 1': 'novel_strategy_part_1',
                    'novel strategy part 2': 'novel_strategy_part_2',
                    'novel strategy part 3': 'novel_strategy_part_3'
                };

                if (checkedBoxes.length === 0) {
                    return Object.values(sectionMap).join(',');
                }

                const selectedSections = [];
                checkedBoxes.forEach(checkbox => {
                    const sectionText = checkbox.nextElementSibling.textContent.trim();
                    if (sectionMap[sectionText]) {
                        selectedSections.push(sectionMap[sectionText]);
                    }
                });
                return selectedSections.join(',');
            }

            function getFrameworkForTemplate(templateId) {
                const selectedFrameworks = getSelectedFrameworks();
                return selectedFrameworks || 'BlueOcean,SCAMPER';
            }

            // =========================================================================
            // ===== ANALYSIS LOGIC FUNCTIONS                                     =====
            // =========================================================================

            /**
             * Extracts text from a user-uploaded file. Supports .txt and .docx.
             */
            async function extractTextFromFile(file) {
                return new Promise((resolve, reject) => {
                    if (file.type === "text/plain" || file.name.endsWith('.csv')) { // This is the corrected line
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = e => reject("Error reading file.");
                        reader.readAsText(file);
                    } else if (file.name.endsWith('.docx')) {
                        if (window.mammoth) {
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                const arrayBuffer = event.target.result;
                                try {
                                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                                    resolve(result.value);
                                } catch (err) {
                                    reject(`Error reading .docx file: ${err.message}`);
                                }
                            };
                            reader.onerror = () => reject("Error preparing .docx file for reading.");
                            reader.readAsArrayBuffer(file);
                        } else {
                            reject('.docx reader library (mammoth.js) not found.');
                        }
                    } else {
                        reject(`Unsupported file type: ${file.name.split('.').pop()}. Please use .txt or .docx.`);
                    }
                });
            }

            /**
             * Robustly extracts a JSON object from a string, which might contain extra text.
             */
            function extractJsonRobust(text) {
                try {
                    const jsonStart = text.indexOf('{');
                    const jsonEnd = text.lastIndexOf('}') + 1;
                    if (jsonStart !== -1 && jsonEnd !== -1) {
                        const jsonStr = text.substring(jsonStart, jsonEnd);
                        return JSON.parse(jsonStr);
                    }
                } catch (e) {
                    console.warn("Standard JSON parsing failed. The AI response may be malformed.", e);
                }
                throw new Error("Failed to parse a valid JSON object from the AI's response.");
            }
            
            async function handleGenerate() {
                if (!currentTemplateId) return;

                const analysisResultContainer = $('analysisResult');
                setLoading('generate', true);
                const analysisActionsEl = $('analysisActions');
                if (analysisActionsEl) {
                    analysisActionsEl.classList.add('hidden');
                }

                if (currentTemplateId === 'swot-tows') {
                    await handleSwotTowsAnalysis();
                } else if (currentTemplateId === 'archetype-analysis') {
                    await handleArchetypeAnalysis();
                } else if (currentTemplateId === 'leverage-points') { 
                    await handleLeveragePointsAnalysis();
                } else if (currentTemplateId === 'visualization') { // <-- ADD THIS BLOCK
                    await handleVisualizationAnalysis_DA();
                } else if (currentTemplateId === 'prescriptive-analysis') { // <-- ADD THIS BLOCK
                    await handlePrescriptiveAnalysis_DA();
                } else if (currentTemplateId === 'thinking-system') { // <-- ADD THIS BLOCK
                    await handleThinkingSystemAnalysis_NS();
                } else if (currentTemplateId === 'creative-dissonance') { // <-- ADD THIS BLOCK
                    await handleCreativeDissonanceAnalysis_NS();
                } else if (currentTemplateId === 'pareto-fishbone') {
                    await handleParetoFishboneAnalysis();
                } else if (currentTemplateId === 'system-actions') { // <-- ADD THIS BLOCK
                    await handleSystemActionsAnalysis_ST();
                } else if (currentTemplateId === 'goals-initiatives') { 
                    await handleGoalsAndInitiativesAnalysis_SP();
                } else if (currentTemplateId === 'living-system') { // <-- ADD THIS BLOCK
                    await handleLivingSystemAnalysis_NS();
                } else if (currentTemplateId === 'system-objectives') { // <-- ADD THIS BLOCK
                    await handleSystemObjectivesAnalysis_ST();
                } else if (currentTemplateId === 'pls-analysis') { // <-- ADD THIS BLOCK
                    await handlePlsAnalysis_DA();
                } else if (currentTemplateId === 'sem-analysis') { // <-- ADD THIS BLOCK
                    await handleSemAnalysis();
                } else if (currentTemplateId === 'descriptive-analysis') { // <-- ADD THIS BLOCK
                    await handleDescriptiveAnalysis_DA();
                } else if (currentTemplateId === 'kpi-events') {
                    await handleKpiAnalysis_KE();
                } else if (currentTemplateId === 'regression-analysis') { // <-- ADD THIS BLOCK
                    await handleRegressionAnalysis_DA();
                } else if (currentTemplateId === 'novel-goals-initiatives') { // <-- ADD THIS BLOCK
                    await handleNovelGoalsAnalysis_NS();
                } else if (currentTemplateId === 'misc-summary') { 
                    await handleMiscAnalysis_MSC();
                } else if (currentTemplateId === 'action-plans') { 
                    await handleActionPlansAnalysis_AP();
                } else if (currentTemplateId === 'factor-analysis') {
                    await handleFactorAnalysis();
                } else if (currentTemplateId === 'system-goals-initiatives') {
                    await handleSystemGoalsAnalysis();
                } else if (currentTemplateId === 'process-mapping') {
                    await handleProcessMappingAnalysis();
                } else if (currentTemplateId === 'system-thinking-analysis') {
                    await handleSystemThinkingAnalysis();
                }
                else {
                    // --- Generic n8n workflow for all other tools ---
                    analysisResultContainer.innerHTML = `
                        <div class="text-center text-white/70 p-8">
                            <div class="typing-indicator mb-6">
                                <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-4">Generating Your Strategic Analysis</h3>
                            <p class="text-white/80 mb-2">This comprehensive analysis may take 2-5 minutes to complete.</p>
                            <p class="text-white/60 text-sm">Please keep this page open while we process your request.</p>
                        </div>`;
                    
                    let fullPrompt = '';
                    const formData = new FormData();
                    const companyName = $('companyName').value.trim();
                    const companyDocumentsFile = $('companyDocumentsFile').files[0];
                    const location = $('location').value.trim();
                    const framework = getFrameworkForTemplate(currentTemplateId);
                    const sections = getSelectedSections();

                    if (!companyName || !companyDocumentsFile || !location) {
                        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Please fill out all fields and upload a file.</div>`;
                        setLoading('generate', false);
                        return;
                    }
                    fullPrompt = `User Information: - Company Name: ${companyName} - Location: ${location}`;

                    // Add context if the field exists
                    const contextEl = $('useCaseContext');
                    if (contextEl && contextEl.value.trim()) {
                        const context = contextEl.value.trim();
                        fullPrompt += ` - Context: ${context}`;
                        formData.append('context', context);
                    }

                    formData.append('customerName', companyName);
                    formData.append('location', location);
                    formData.append('company_documents', companyDocumentsFile.name);
                    formData.append('file', companyDocumentsFile);
                    formData.append('framework', framework);
                    formData.append('sections', sections);
                    formData.append('prompt', fullPrompt);
                    formData.append('templateId', currentTemplateId);
                    
                    try {
                        const { data: { session } } = await supabase.auth.getSession();
                        if (!session) throw new Error("Please log in to generate analysis.");

                        const messageId = Date.now();
                        pendingAnalysisRequests.set(messageId, analysisResultContainer);
                        formData.append('messageId', messageId);

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000);

                        const response = await fetch('https://n8n.data2int.com/webhook/analysis-ev2', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${session.access_token}` },
                            body: formData,
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        console.log('Analysis request submitted successfully.');
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log('Fetch request timed out as expected. Waiting for WebSocket response.');
                            return;
                        }
                        console.error('Error submitting analysis request:', error);
                        analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                        setLoading('generate', false);
                    }
                }
            }

            async function handleDescriptiveAnalysis_DA() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Performing Calculations...</h3><p class="text-white/80 mb-2">Calculating statistics from your data...</p></div>`;

                try {
                    const dataFile = $('descriptiveFile').files[0];
                    const contextFile = $('descriptiveContextFile').files[0];
                    if (!dataFile) throw new Error("Please upload a CSV data file.");

                    const csvText = await extractTextFromFile(dataFile);
                    const { header, rows } = parseCSV(csvText);

                    // --- JAVASCRIPT-BASED STATISTICAL CALCULATIONS ---
                    const numerical_summary = [];
                    const categorical_summary = [];
                    const visualizations = [];

                    header.forEach(col => {
                        const values = rows.map(r => r[col]);
                        const isNumeric = values.every(v => typeof v === 'number');

                        if (isNumeric) {
                            const numericValues = values.filter(v => !isNaN(v));
                            if (numericValues.length > 0) {
                                const sum = numericValues.reduce((a, b) => a + b, 0);
                                const mean = sum / numericValues.length;
                                const sorted = [...numericValues].sort((a, b) => a - b);
                                const median = sorted.length % 2 === 0 ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2 : sorted[Math.floor(sorted.length / 2)];
                                const min = Math.min(...numericValues);
                                const max = Math.max(...numericValues);
                                const std_dev = Math.sqrt(numericValues.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / numericValues.length);

                                numerical_summary.push({ variable: col, mean, median, std_dev, min, max, interpretation: "" });
                                visualizations.push({ chart_type: "histogram", variable: col, data: numericValues, title: `Distribution of ${col}` });
                            }
                        } else {
                            const frequencies = {};
                            values.forEach(v => { frequencies[v] = (frequencies[v] || 0) + 1; });
                            
                            const freqArray = Object.entries(frequencies).map(([category, count]) => ({
                                category,
                                count,
                                percentage: (count / values.length) * 100
                            }));

                            categorical_summary.push({ variable: col, frequencies: freqArray, interpretation: "" });
                            visualizations.push({ chart_type: "bar", variable: col, data: frequencies, title: `Count by ${col}` });
                        }
                    });

                    const summary = {
                        rows: rows.length,
                        columns: header.length,
                        interpretation: `The dataset contains ${rows.length} records and ${header.length} variables. The analysis summarizes the key statistical properties of each variable.`
                    };
                    
                    // --- USE LLM FOR INSIGHTS ONLY ---
                    analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Generating Business Insights...</h3></div>`;
                    let businessContext = "No additional business context provided.";
                    if (contextFile) { businessContext = await extractTextFromFile(contextFile); }
                    
                    const statsForPrompt = JSON.stringify({ numerical_summary, categorical_summary }, null, 2);
                    const prompt = `
                        You are a data analyst. Based on the following statistical summary and business context, provide 3-4 actionable business insights.

                        **Business Context:**
                        ${businessContext}

                        **Statistical Summary of Data:**
                        ${statsForPrompt}

                        **TASK:**
                        Generate only a JSON object containing a list of business insights based on the provided statistics and context.
                        Return ONLY a valid JSON object with this exact structure:
                        { "business_insights": ["Insight 1...", "Insight 2...", "Insight 3..."] }
                    `;

                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const insightsData = JSON.parse(data.response);
                    
                    // --- ASSEMBLE FINAL, ACCURATE DATA ---
                    const finalData = {
                        summary,
                        numerical_summary,
                        categorical_summary,
                        visualizations,
                        business_insights: insightsData.business_insights
                    };
                    
                    renderDescriptivePage_DA(analysisResultContainer, finalData);

                } catch (error) {
                    console.error('Error during Descriptive Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleParetoFishboneAnalysis() {
                const analysisResultContainer = $('analysisResult');
                 analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Generating Pareto & Fishbone Analysis</h3>
                        <p class="text-white/80 mb-2">This may take a moment...</p>
                    </div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let problem = '';

                    if (useDoc) {
                        const file = $('paretoFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        problem = await extractTextFromFile(file);
                    } else {
                        problem = $('problemStatement').value;
                        if (!problem.trim()) throw new Error("Please enter a problem statement in the text area.");
                    }

                    if (!problem) {
                        throw new Error("Could not get problem description from input or file.");
                    }


                    const fullPrompt = `Analyze the problem: "${problem}" and create both a fishbone diagram and Pareto analysis.

                    Generate exactly 6 main categories with sub-causes, then analyze using 80/20 rule.
                    Each label must be MAXIMUM 3 words.

                    Provide response as valid JSON with this exact structure:
                    {{
                      "fishbone": {{
                        "Category 1": ["sub-cause 1", "sub-cause 2", "sub-cause 3"],
                        "Category 2": ["sub-cause 1", "sub-cause 2", "sub-cause 3", "sub-cause 4"],
                        "Category 3": ["sub-cause 1", "sub-cause 2", "sub-cause 3"],
                        "Category 4": ["sub-cause 1", "sub-cause 2", "sub-cause 3"],
                        "Category 5": ["sub-cause 1", "sub-cause 2", "sub-cause 3"],
                        "Category 6": ["sub-cause 1", "sub-cause 2", "sub-cause 3"]
                      }},
                      "pareto_analysis": {{
                        "vital_few": [
                          {{"cause": "Root cause 1", "impact_score": 25, "category": "Category 1"}},
                          {{"cause": "Root cause 2", "impact_score": 20, "category": "Category 2"}},
                          {{"cause": "Root cause 3", "impact_score": 15, "category": "Category 3"}},
                          {{"cause": "Root cause 4", "impact_score": 12, "category": "Category 4"}},
                          {{"cause": "Root cause 5", "impact_score": 10, "category": "Category 5"}}
                        ],
                        "useful_many": [
                          {{"cause": "Root cause 6", "impact_score": 8, "category": "Category 6"}},
                          {{"cause": "Root cause 7", "impact_score": 5, "category": "Category 1"}},
                          {{"cause": "Root cause 8", "impact_score": 3, "category": "Category 2"}},
                          {{"cause": "Root cause 9", "impact_score": 2, "category": "Category 3"}}
                        ],
                        "analysis_summary": "Brief explanation of why these causes follow 80/20 rule for {problem}"
                      }}
                    }}

                    Requirements:
                    - Impact scores should total 100
                    - Vital few (top 20% causes) should account for ~80% of impact
                    - All cause names must be 3 words or less
                    - Use realistic impact scores based on typical root cause analysis
                    - Focus on actionable, specific root causes

                    Respond ONLY with valid JSON, no additional text.`;
                    
                    const ollamaPayload = {
                        model: "llama3",
                        prompt: fullPrompt,
                        format: "json",
                        stream: false
                    };

                    const response = await fetch('https://ollama.data2int.com/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ollamaPayload)
                    });

                    if (!response.ok) {
                        throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                    }

                    const ollamaResult = await response.json();
                    const parsedData = JSON.parse(ollamaResult.response);
                    
                    // --- Render the results in a tabbed interface ---
                    const container = analysisResultContainer;
                    container.innerHTML = '';
                    const fishboneData = parsedData.fishbone;
                    const paretoData = parsedData.pareto_analysis;
                    
                    const tabNav = document.createElement('div');
                    tabNav.className = 'flex border-b border-white/20 -mx-6 px-6'; // Adjusted padding for glass container
                    tabNav.innerHTML = `
                        <button class="analysis-tab-btn active" data-tab="pareto"> Pareto Chart</button>
                        <button class="analysis-tab-btn" data-tab="details"> Analysis Details</button>
                        <button class="analysis-tab-btn" data-tab="plan"> Action Plan</button>
                    `;
                    container.appendChild(tabNav);
                    
                    const tabContent = document.createElement('div');
                    container.appendChild(tabContent);

                    tabContent.innerHTML = `
                        <div id="paretoPanel" class="analysis-tab-panel active"></div>
                        <div id="detailsPanel" class="analysis-tab-panel"></div>
                        <div id="planPanel" class="analysis-tab-panel"></div>
                    `;
                    
                    const paretoChartDiv = document.createElement('div');
                    paretoChartDiv.id = 'paretoChartContainer';
                    $('paretoPanel').appendChild(paretoChartDiv);
                    createParetoChartJS(paretoData, 'paretoChartContainer');

                    let detailsHtml = `<h3 class="text-2xl font-bold mb-4">Analysis Summary</h3>`;
                    if (paretoData.analysis_summary) {
                        detailsHtml += `<div class="p-4 rounded-lg bg-white/5 mb-6 text-white/80 italic">${paretoData.analysis_summary}</div>`;
                    }
                    detailsHtml += `<h4 class="text-xl font-semibold mb-3">Category Breakdown (Fishbone)</h4>`;
                    for (const [category, sub_causes] of Object.entries(fishboneData)) {
                        detailsHtml += `<details class="bg-white/5 p-3 rounded-lg mb-2"><summary class="cursor-pointer font-semibold">${category} (${sub_causes.length} causes)</summary><ul class="mt-2 pl-4">`;
                        sub_causes.forEach(cause => {
                            const isVital = (paretoData.vital_few || []).some(item => cause.toLowerCase() === item.cause.toLowerCase());
                            detailsHtml += `<li class="mb-1">${isVital ? '' : ''} ${cause}</li>`;
                        });
                        detailsHtml += `</ul></details>`;
                    }
                    $('detailsPanel').innerHTML = detailsHtml;

                    let planHtml = `<h3 class="text-2xl font-bold mb-4">Recommended Action Plan</h3>
                                    <div class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6"> <strong>80/20 Rule:</strong> Focus 80% of your resources on the 'Vital Few' causes for maximum impact!</div>
                                    <h4 class="text-xl font-semibold mb-3 border-b border-red-500/50 pb-2 text-red-300"> IMMEDIATE FOCUS (Vital Few)</h4>`;
                    (paretoData.vital_few || []).forEach(cause => {
                        planHtml += `<div class="mb-4"><p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p><p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> HIGH </p></div>`;
                    });
                    planHtml += `<h4 class="text-xl font-semibold mt-8 mb-3 border-b border-white/20 pb-2"> SECONDARY ACTIONS (Useful Many)</h4>`;
                    (paretoData.useful_many || []).forEach(cause => {
                        planHtml += `<div class="mb-4"><p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p><p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> Medium/Low</p></div>`;
                    });
                    $('planPanel').innerHTML = planHtml;
                    
                    analysisCache[currentTemplateId] = container.innerHTML;

                    tabNav.addEventListener('click', e => {
                        if(e.target.tagName === 'BUTTON') {
                            tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                            tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                            e.target.classList.add('active');
                            const targetPanel = $(e.target.dataset.tab + 'Panel');
                            targetPanel.classList.add('active');
                            const chart = targetPanel.querySelector('.plotly-chart');
                            if (chart) Plotly.Plots.resize(chart);
                        }
                    });

                    $('analysisActions').classList.remove('hidden');

                } catch (error) {
                    console.error('Error with Pareto/Fishbone generation:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred during generation: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }
            
            function createParetoChartJS(paretoData, containerId) {
                const allCauses = (paretoData.vital_few || []).concat(paretoData.useful_many || []);
                if (allCauses.length === 0) return;

                allCauses.sort((a, b) => b.impact_score - a.impact_score);

                const causes = allCauses.map(item => item.cause);
                const impacts = allCauses.map(item => item.impact_score);
                const categories = allCauses.map(item => item.category);

                const cumulative = impacts.reduce((acc, val) => {
                    acc.push((acc.length > 0 ? acc[acc.length - 1] : 0) + val);
                    return acc;
                }, []);
                const totalImpact = impacts.reduce((a, b) => a + b, 0);
                const cumulativePct = cumulative.map(val => (val / totalImpact) * 100);
                
                const trace1 = {
                    x: causes,
                    y: impacts,
                    name: 'Impact Score',
                    type: 'bar',
                    text: impacts.map(imp => `${imp}%`),
                    textposition: 'outside',
                    marker: { color: 'var(--primary)' },
                    hovertemplate: '<b>%{x}</b><br>Impact: %{y}%<br>Category: %{customdata}<extra></extra>',
                    customdata: categories
                };

                const trace2 = {
                    x: causes,
                    y: cumulativePct,
                    name: 'Cumulative %',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: 'var(--accent)', width: 3 },
                    marker: { size: 8 },
                    yaxis: 'y2',
                    hovertemplate: '<b>%{x}</b><br>Cumulative: %{y:.1f}%<extra></extra>'
                };

                const layout = {
                    title: 'Pareto Analysis - 80/20 Root Cause Impact',
                    xaxis: { title: 'Root Causes', tickangle: -45, automargin: true },
                    yaxis: { title: 'Impact Score (%)' },
                    yaxis2: {
                        title: 'Cumulative Impact (%)',
                        overlaying: 'y',
                        side: 'right',
                        range: [0, 101]
                    },
                    shapes: [{
                        type: 'line', xref: 'paper', x0: 0, x1: 1,
                        yref: 'y2', y0: 80, y1: 80,
                        line: { color: 'orange', width: 2, dash: 'dash' }
                    }],
                    showlegend: true, height: 500, hovermode: 'x unified',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: document.body.classList.contains('light-theme') ? '#1a202c' : 'white' }
                };

                Plotly.newPlot(containerId, [trace1, trace2], layout, {responsive: true});
            }


            // =========================================================================
            // ===== SPECIALIZED ANALYSIS LOGIC (SWOT, ARCHETYPE, FACTOR, etc.)   =====
            // =========================================================================

            async function handleSystemGoalsAnalysis() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Formulating System-Aware Goals & Initiatives</h3>
                        <p class="text-white/80 mb-2">Analyzing feedback loops to identify strategic interventions...</p>
                    </div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';

                    if (useDoc) {
                        const file = $('systemGoalsFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('systemGoalsContent').value;
                        if (!text.trim()) throw new Error("Please enter system information in the text area.");
                    }
                    if (text.length > 4000) text = text.substring(0, 4000);

                    const prompt = `
                        You are a senior strategic consultant specializing in applying systems thinking to business goals. Based on the provided system description, formulate a high-level system goal and develop strategic initiatives to achieve it.

                        **System Description & Goal Context:**
                        ${text}

                        **TASK:**
                        Analyze the system and provide a strategic plan in a single JSON object.
                        
                        1.  **system_goal**: A single, concise, and measurable overarching goal derived from the user's input.
                        
                        2.  **key_loops**:
                            -   "reinforcing_loop": Describe the primary reinforcing loop that helps achieve the goal.
                            -   "balancing_loop": Describe the primary balancing loop that hinders or limits the goal.

                        3.  **strategic_initiatives**: An array of 2-3 strategic initiatives. For each initiative:
                            -   "initiative_name": A clear name for the initiative.
                            -   "rationale": Explain how this initiative manipulates the key feedback loops to achieve the system goal.
                            -   "objectives": A list of 2-3 specific, actionable objectives for the initiative.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "system_goal": "Increase the customer retention rate by 30% over the next 18 months.",
                          "key_loops": {
                            "reinforcing_loop": "The 'Customer Loyalty Loop': High product quality leads to greater customer satisfaction, which in turn drives positive word-of-mouth and repeat purchases, growing the loyal customer base.",
                            "balancing_loop": "The 'Support Strain Loop': As the customer base grows, support ticket volume increases. If support capacity doesn't keep pace, service quality drops, leading to customer frustration and churn, which limits growth."
                          },
                          "strategic_initiatives": [
                            {
                              "initiative_name": "Proactive Customer Success Enhancement",
                              "rationale": "This initiative strengthens the 'Customer Loyalty Loop' by improving product quality and satisfaction, while weakening the 'Support Strain Loop' by reducing the number of issues that require support.",
                              "objectives": [
                                "Implement a predictive analytics system to identify at-risk customers with 90% accuracy within 6 months.",
                                "Reduce critical bug reports by 50% through a new QA process in the next two quarters.",
                                "Launch a 'train-the-trainer' program for key clients to improve product adoption."
                              ]
                            },
                            {
                              "initiative_name": "Scale Support Infrastructure",
                              "rationale": "This initiative directly addresses the limiting factor in the 'Support Strain Loop' by increasing the system's capacity to handle growth, allowing the reinforcing loop to continue functioning effectively.",
                              "objectives": [
                                "Decrease average support ticket resolution time by 40% in 9 months by hiring and training new support staff.",
                                "Implement a new AI-powered knowledge base to deflect 25% of common support inquiries within one year."
                              ]
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);

                    renderSystemGoalsPage(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during System Goals analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleGoalsAndInitiativesAnalysis_SP() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Building OGSM Framework</h3><p class="text-white/80 mb-2">Cascading your objective into actionable strategies...</p></div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';

                    if (useDoc) {
                        const file = $('goalsFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('goalsContent').value;
                        if (!text.trim()) throw new Error("Please enter your high-level goal in the text area.");
                    }
                    if (text.length > 4000) text = text.substring(0, 4000);

                    const prompt = `
                        You are a strategic planning consultant specializing in the OGSM (Objective, Goals, Strategies, Measures) framework. Based on the user's high-level goal, create a complete OGSM plan.

                        **User's High-Level Goal:**
                        ${text}

                        **TASK:**
                        Formulate the OGSM plan and return it as a single JSON object.
                        
                        1.  **main_objective**: Refine the user's input into a single, clear, overarching Objective.
                        
                        2.  **goals**: An array of 2-3 specific, high-level Goals that support the Objective. For each goal:
                            -   "goal_name": The name of the goal.
                            -   "strategies": An array of 1-2 Strategies to achieve that goal. For each strategy:
                                -   "strategy_name": The name of the strategy.
                                -   "measures": A list of 1-2 key Measures (KPIs) to track the strategy's success.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "main_objective": "To become the #1 market leader for eco-friendly cleaning supplies in North America by 2030.",
                          "goals": [
                            {
                              "goal_name": "Achieve Market Share Dominance",
                              "strategies": [
                                {
                                  "strategy_name": "Expand into major retail channels",
                                  "measures": ["Secure partnerships with 5 national retailers", "Achieve 15% category market share"]
                                },
                                {
                                  "strategy_name": "Launch a direct-to-consumer subscription service",
                                  "measures": ["Acquire 50,000 active subscribers", "Maintain a churn rate below 5%"]
                                }
                              ]
                            },
                            {
                              "goal_name": "Establish Brand as an Innovation Leader",
                              "strategies": [
                                {
                                  "strategy_name": "Develop and launch three new patented cleaning formulas",
                                  "measures": ["File 3+ patents", "New products contribute 20% of total revenue"]
                                }
                              ]
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderGoalsAndInitiativesPage_SP(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during OGSM analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleActionPlansAnalysis_AP() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Generating Action Plan</h3><p class="text-white/80 mb-2">Breaking your objective into a timeline of actionable tasks...</p></div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';

                    if (useDoc) {
                        const file = $('actionPlanFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('actionPlanContent').value;
                        if (!text.trim()) throw new Error("Please describe the objective for your action plan.");
                    }
                    if (text.length > 4000) text = text.substring(0, 4000);

                    const prompt = `
                        You are a project management expert. Analyze the user's objective and break it down into a detailed action plan.

                        **User's Objective:**
                        ${text}

                        **TASK:**
                        Formulate the action plan and return it as a single JSON object.
                        
                        1.  **project_name**: A concise name for the action plan derived from the user's objective.
                        
                        2.  **action_items**: An array of 5-7 sequential action items. For each item:
                            - "task_name": A clear, actionable name for the task.
                            - "description": A brief, one-sentence description of what needs to be done.
                            - "owner": The department, team, or role responsible for the task.
                            - "timeline": A specific, sequential timeframe (e.g., "Weeks 1-2", "Month 2", "Sprint 3").
                            - "priority": The task's priority level ("High", "Medium", or "Low").

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "project_name": "Mobile App Launch Action Plan",
                          "action_items": [
                            {
                              "task_name": "Finalize App Features & UI/UX",
                              "description": "The product team will finalize the core feature set and approve the final UI/UX designs from the design agency.",
                              "owner": "Product & Design Teams",
                              "timeline": "Weeks 1-3",
                              "priority": "High"
                            },
                            {
                              "task_name": "Backend Development & API Integration",
                              "description": "The engineering team will develop the necessary backend services and APIs to support the mobile application's features.",
                              "owner": "Engineering Team",
                              "timeline": "Weeks 2-8",
                              "priority": "High"
                            },
                            {
                              "task_name": "Frontend Mobile App Development",
                              "description": "The mobile development team will build the native iOS and Android applications based on the approved designs and APIs.",
                              "owner": "Mobile Dev Team",
                              "timeline": "Weeks 4-16",
                              "priority": "High"
                            },
                            {
                              "task_name": "Quality Assurance & Testing",
                              "description": "The QA team will conduct thorough testing, including functional, performance, and user acceptance testing.",
                              "owner": "QA Team",
                              "timeline": "Weeks 17-20",
                              "priority": "Medium"
                            },
                            {
                              "task_name": "Prepare App Store Listings",
                              "description": "The marketing team will prepare all required assets, descriptions, and screenshots for the Apple App Store and Google Play Store.",
                              "owner": "Marketing Team",
                              "timeline": "Weeks 18-21",
                              "priority": "Medium"
                            },
                            {
                              "task_name": "Launch Marketing Campaign",
                              "description": "Execute the pre-launch and launch day marketing campaigns across all channels to drive awareness and initial downloads.",
                              "owner": "Marketing Team",
                              "timeline": "Weeks 22-24",
                              "priority": "High"
                            },
                            {
                              "task_name": "App Launch & Post-Launch Monitoring",
                              "description": "Deploy the apps to the stores and monitor for any immediate issues, bugs, or performance problems.",
                              "owner": "Engineering & Ops Teams",
                              "timeline": "Week 24",
                              "priority": "High"
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderActionPlansPage_AP(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Action Plan analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleKpiAnalysis_KE() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Defining Performance Metrics</h3><p class="text-white/80 mb-2">Identifying key indicators and critical milestones...</p></div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';
                    if (useDoc) {
                        const file = $('kpiFile').files[0];
                        if (!file) throw new Error("Please select a document.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('kpiContent').value;
                        if (!text.trim()) throw new Error("Please describe the project or goal.");
                    }
                    if (text.length > 4000) text = text.substring(0, 4000);

                    const prompt = `
                        You are a performance management and strategy execution expert. Analyze the user's goal and develop a framework of Key Performance Indicators (KPIs) and critical events.

                        **User's Goal/Project:**
                        ${text}

                        **TASK:**
                        Formulate the performance framework and return it as a single JSON object.
                        
                        1.  **main_goal**: A refined, single-sentence summary of the user's primary goal.
                        
                        2.  **kpis**: An array of 4-5 diverse KPIs. For each KPI:
                            - "name": The name of the KPI.
                            - "description": A brief explanation of what it measures.
                            - "formula": How the KPI is calculated (e.g., "(Repeat Customers / Total Customers) * 100").
                            - "target": A specific, measurable target (e.g., "Increase to 25%").
                            - "type": The category of the KPI (e.g., "Leading", "Lagging", "Financial", "Customer").

                        3.  **critical_events**: An array of 3-4 major project milestones or events. For each event:
                            - "event_name": The name of the event.
                            - "description": What signifies the completion of this event.
                            - "timeline": The target timeframe for this event.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "main_goal": "Successfully launch a new customer loyalty program to increase the repeat purchase rate.",
                          "kpis": [
                            {
                              "name": "Repeat Purchase Rate",
                              "description": "The percentage of customers who have made more than one purchase within a specific time frame.",
                              "formula": "(Number of Repeat Customers / Total Customers) * 100%",
                              "target": "Increase from 15% to 25%",
                              "type": "Lagging"
                            },
                            {
                              "name": "Customer Lifetime Value (CLV)",
                              "description": "The total revenue a business can expect from a single customer account throughout their relationship.",
                              "formula": "Average Purchase Value * Average Purchase Frequency",
                              "target": "Increase by 20%",
                              "type": "Financial"
                            },
                            {
                              "name": "Loyalty Program Enrollment Rate",
                              "description": "The percentage of new customers who sign up for the loyalty program.",
                              "formula": "(New Program Members / Total New Customers) * 100%",
                              "target": "Achieve 40% enrollment",
                              "type": "Leading"
                            },
                            {
                              "name": "Net Promoter Score (NPS)",
                              "description": "A metric measuring customer loyalty and satisfaction.",
                              "formula": "% Promoters - % Detractors",
                              "target": "Improve score to +50",
                              "type": "Customer"
                            }
                          ],
                          "critical_events": [
                            {
                              "event_name": "Program Design Finalized",
                              "description": "Final approval of the loyalty program's structure, rewards, and branding.",
                              "timeline": "Month 1"
                            },
                            {
                              "event_name": "Technical Integration Complete",
                              "description": "The loyalty program is fully integrated with the e-commerce platform and CRM.",
                              "timeline": "Month 3"
                            },
                            {
                              "event_name": "Program Launch",
                              "description": "The loyalty program is officially launched and available to all customers.",
                              "timeline": "Month 4"
                            },
                            {
                              "event_name": "First Quarterly Performance Review",
                              "description": "Initial data on enrollment, repeat purchases, and CLV is analyzed to measure early success.",
                              "timeline": "Month 7"
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderKpiPage_KE(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during KPI analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleNovelGoalsAnalysis_NS() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Mapping Horizons of Growth</h3><p class="text-white/80 mb-2">Analyzing your goal across core, adjacent, and transformational timeframes...</p></div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';

                    if (useDoc) {
                        const file = $('novelGoalsFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('novelGoalsContent').value;
                        if (!text.trim()) throw new Error("Please describe your ambition or goal.");
                    }
                    
                    if (text.length > 4000) text = text.substring(0, 4000);
                    
                    const prompt = `
                        You are a corporate strategist specializing in the "Three Horizons of Growth" framework. Analyze the user's high-level goal and structure a comprehensive strategic plan.

                        **User's Ambition:**
                        ${text}

                        **TASK:**
                        Formulate the plan and return it as a single JSON object.
                        
                        1.  **main_goal**: A refined, ambitious goal statement.
                        
                        2.  **horizons**: An array of exactly three objects, one for each horizon.
                            - For **Horizon 1**: Focus on initiatives that defend and optimize the current core business.
                            - For **Horizon 2**: Focus on initiatives that build on existing capabilities to create new growth.
                            - For **Horizon 3**: Focus on innovative, high-risk/high-reward initiatives that could become the core business of the future.
                            
                            For each horizon object, provide:
                            - "horizon_name": The name (e.g., "Horizon 1: Core Business").
                            - "timeframe": A typical timeframe (e.g., "0-18 Months").
                            - "focus": A one-sentence description of the horizon's strategic focus.
                            - "initiatives": An array of 2-3 initiatives. For each initiative:
                                - "initiative_name": Name of the initiative.
                                - "description": A brief explanation.
                                - "kpis": A list of 2-3 key metrics to measure its success.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "main_goal": "Transition from a hardware manufacturer to a leading SaaS provider in the IoT space.",
                          "horizons": [
                            {
                              "horizon_name": "Horizon 1: Optimize the Core",
                              "timeframe": "0-18 Months",
                              "focus": "Maximize the profitability and efficiency of the existing hardware business to fund future growth.",
                              "initiatives": [
                                {
                                  "initiative_name": "Supply Chain Automation",
                                  "description": "Implement robotics and AI to reduce manufacturing costs and improve delivery times.",
                                  "kpis": ["Reduce Cost of Goods Sold by 15%", "Improve on-time delivery rate to 99%"]
                                },
                                {
                                  "initiative_name": "Premium Hardware Tiers",
                                  "description": "Introduce high-margin, premium versions of existing hardware products to increase average selling price.",
                                  "kpis": ["Increase ASP by 20%", "Achieve 25% sales mix from premium tiers"]
                                }
                              ]
                            },
                            {
                              "horizon_name": "Horizon 2: Build Adjacent Growth",
                              "timeframe": "12-36 Months",
                              "focus": "Leverage existing hardware and customer relationships to build emerging SaaS revenue streams.",
                              "initiatives": [
                                {
                                  "initiative_name": "Develop IoT Data Platform",
                                  "description": "Create a subscription-based platform that aggregates and analyzes data from our hardware devices.",
                                  "kpis": ["Acquire 1,000 paying subscribers", "Achieve $1M in Annual Recurring Revenue (ARR)"]
                                },
                                {
                                  "initiative_name": "Pilot Predictive Maintenance Service",
                                  "description": "Offer a service for key industrial clients that uses device data to predict hardware failures.",
                                  "kpis": ["Secure 5 enterprise pilot customers", "Generate $500k in service revenue"]
                                }
                              ]
                            },
                            {
                              "horizon_name": "Horizon 3: Create Transformational Options",
                              "timeframe": "3-7 Years",
                              "focus": "Explore and invest in disruptive technologies and business models that could redefine the company's future.",
                              "initiatives": [
                                {
                                  "initiative_name": "R&D in AI-Powered Automation",
                                  "description": "Establish a dedicated research lab to explore fully autonomous systems that operate independently of human intervention.",
                                  "kpis": ["File 2 foundational patents in AI automation", "Develop a functional prototype of an autonomous system"]
                                },
                                {
                                  "initiative_name": "Venture Arm for IoT Startups",
                                  "description": "Create a corporate venture capital arm to make strategic investments in promising early-stage IoT software companies.",
                                  "kpis": ["Invest in 3-5 startups", "Achieve 1 successful technology integration from a portfolio company"]
                                }
                              ]
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderNovelGoalsPage_NS(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Novel Goals analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleRegressionAnalysis_DA() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Running Comprehensive Regression...</h3><p class="text-white/80 mb-2">Building model, running diagnostics, and generating insights...</p></div>`;

                try {
                    const dependentVar = $('dependentVar').value.trim();
                    const independentVars = $('independentVars').value.trim();
                    const dataFile = $('regressionFile').files[0];
                    const contextFile = $('regressionContextFile').files[0];

                    if (!dependentVar || !independentVars || !dataFile) {
                        throw new Error("Please specify variables and upload a CSV data file.");
                    }
                    
                    let csvText = await extractTextFromFile(dataFile);
                    let businessContext = "No additional context provided.";
                    if (contextFile) {
                        businessContext = await extractTextFromFile(contextFile);
                    }

                    if (csvText.length > 15000) {
                        csvText = csvText.substring(0, 15000);
                        businessContext += " (Note: The analysis was performed on the first 15,000 characters of the data file.)";
                    }

                    const prompt = `
                        You are a senior data analyst performing a comprehensive regression analysis for a business user.

                        **Analysis Context:**
                        - Dependent Variable (Y): ${dependentVar}
                        - Independent Variables (X): ${independentVars}
                        - Business Context: ${businessContext}
                        - Full CSV Data: ${csvText}

                        **TASK:**
                        Perform a detailed multiple regression analysis based *solely* on the provided data. Do NOT simulate or invent data. Generate detailed results, diagnostics, and context-aware recommendations.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "model_summary": {
                            "dependent_variable": "${dependentVar}",
                            "r_squared": 0.783,
                            "adj_r_squared": 0.765,
                            "f_statistic": 45.67,
                            "prob_f_statistic": 0.000,
                            "regression_equation": "${dependentVar} = 5120.50 + (15.75 * Marketing_Spend) + (2.20 * Website_Traffic)",
                            "interpretation": "The model explains 78.3% of the variance in ${dependentVar}, indicating a strong fit. The F-statistic's p-value (<0.001) confirms the overall model is statistically significant."
                          },
                          "variable_importance": [
                            { "variable": "Marketing_Spend", "importance_score": 0.85 },
                            { "variable": "Website_Traffic", "importance_score": 0.15 }
                          ],
                          "coefficients": [
                            { "variable": "Intercept", "coefficient": 5120.50, "std_error": 850.20, "p_value": 0.000, "interpretation": "The baseline value of ${dependentVar} when all predictors are zero." },
                            { "variable": "Marketing_Spend", "coefficient": 15.75, "std_error": 2.10, "p_value": 0.000, "interpretation": "For each $1 increase in Marketing Spend, ${dependentVar} is predicted to increase by $15.75, holding other variables constant. This is a highly significant predictor." },
                            { "variable": "Website_Traffic", "coefficient": 2.20, "std_error": 0.55, "p_value": 0.002, "interpretation": "For each additional website visitor, ${dependentVar} is predicted to increase by $2.20. This is also a significant predictor." }
                          ],
                          "residuals_data": {
                            "predicted": [20000, 25000, 30000, 35000, 40000, 45000, 50000, 55000],
                            "residuals": [1000, -1500, 2000, -500, 1200, -800, 300, -1700],
                            "interpretation": "The residuals appear randomly scattered around zero, with no obvious patterns. This suggests the model's assumptions (like linearity and homoscedasticity) are likely met, inspiring confidence in the results."
                          },
                          "business_recommendations": [
                            { "recommendation": "Scale Investment in Marketing Spend", "action_items": ["..."], "potential_risks": "...", "kpis_to_track": ["..."] }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderRegressionPage_DA(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Regression Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

           async function handlePlsAnalysis_DA() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Running PLS-SEM on your data...</h3><p class="text-white/80 mb-2">This may take a moment.</p></div>`;

                try {
                    const measurementModel = $('plsMeasurementModel').value.trim();
                    const structuralModel = $('plsStructuralModel').value.trim();
                    const file = $('plsFile').files[0];

                    if (!measurementModel || !structuralModel || !file) {
                        throw new Error("Please define both models and upload a CSV file.");
                    }
                    let csvText = await extractTextFromFile(file);

                    let contextNote = "";
                    if (csvText.length > 15000) {
                        csvText = csvText.substring(0, 15000);
                        contextNote = " (Note: The analysis was performed on the first 15,000 characters of the provided data file due to size limitations.)";
                    }

                    const prompt = `
                        You are a data scientist. The following is a complete CSV dataset and a proposed PLS-SEM model. Perform a full analysis based *solely* on the provided data and model structure. ${contextNote}

                        **User's Model & Data:**
                        - Measurement Model: ${measurementModel}
                        - Structural Model: ${structuralModel}
                        - Full CSV Data:
                        ${csvText}

                        **TASK:**
                        Analyze the data according to the specified model. Do NOT simulate or invent results. All outputs (coefficients, p-values, reliability metrics, etc.) must be derived directly from your analysis of the provided data and model.

                        Return ONLY a valid JSON object with the structure defined below, filling it with the results of your actual analysis:
                        {
                          "model_evaluation": { "r_squared": [ { "variable": "<endogenous_var>", "value": <value> } ], "interpretation": "<Your detailed interpretation>" },
                          "path_coefficients": [ { "path": "<path_from_input>", "coefficient": <value>, "t_statistic": <value>, "p_value": <value>, "interpretation": "<Your detailed interpretation>" } ],
                          "reliability_validity": [ {"construct": "<construct_name>", "cronbachs_alpha": <value>, "composite_reliability": <value>, "ave": <value>} ],
                          "visual_data": { "nodes": [ { "id": "<construct_name>", "x": <pos>, "y": <pos> } ] },
                          "business_recommendations": [ { "recommendation": "<Rec title>", "insight": "<Insight from data>", "action_items": ["<item>"], "kpis_to_track": ["<kpi>"] } ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderPlsPage_DA(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during PLS-SEM Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

           function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const header = lines[0].split(',').map(h => h.trim());
                const rows = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length === header.length) {
                        const row = {};
                        for (let j = 0; j < header.length; j++) {
                            const value = values[j];
                            // Attempt to convert to number if possible
                            const numValue = parseFloat(value);
                            row[header[j]] = isNaN(numValue) ? value : numValue;
                        }
                        rows.push(row);
                    }
                }
                return { header, rows };
            }

            async function handlePrescriptiveAnalysis_DA() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Running Prescriptive Analysis</h3><p class="text-white/80 mb-2">Analyzing data to formulate actionable recommendations...</p></div>`;

                try {
                    const businessGoal = $('prescriptiveGoal').value.trim();
                    const file = $('prescriptiveFile').files[0];

                    if (!businessGoal || !file) {
                        throw new Error("Please describe your business goal and upload a CSV file.");
                    }
                    
                    let csvText = await extractTextFromFile(file);
                    let contextNote = "";
                    if (csvText.length > 15000) {
                        csvText = csvText.substring(0, 15000);
                        contextNote = " (Note: The analysis was performed on the first 15,000 characters of the provided data file due to size limitations.)";
                    }

                    const prompt = `
                        You are a prescriptive analytics expert. Analyze the user's business goal and the provided dataset to recommend specific actions.

                        **Analysis Context:**
                        - Business Goal: ${businessGoal}
                        - Full CSV Data: ${csvText}
                        ${contextNote}

                        **TASK:**
                        Perform a comprehensive prescriptive analysis. Your analysis must identify key drivers in the data and translate them into a set of detailed, actionable recommendations to achieve the business goal.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "main_goal": "${businessGoal}",
                          "data_insights": [
                            {
                              "insight": "Customers with a 'Customer_Satisfaction_Score' below 3 are 80% more likely to churn.",
                              "implication": "This identifies a critical, high-risk customer segment where targeted intervention could have an immediate and significant impact on the overall churn rate."
                            },
                            {
                              "insight": "Customers who have purchased from both 'Skincare' and 'Makeup' categories have a 50% higher Customer Lifetime Value (CLV).",
                              "implication": "This demonstrates that cross-selling is a powerful driver of customer value. Increasing the number of multi-category customers should be a key strategic priority."
                            }
                          ],
                          "prescriptions": [
                            {
                              "recommendation": "Launch At-Risk Customer Campaign",
                              "rationale": "Since low satisfaction is the strongest predictor of churn, proactively engaging these customers is the most direct way to improve retention.",
                              "impact": "High",
                              "effort": "Low",
                              "action_items": [
                                "Create a customer segment for all users with a satisfaction score of 3 or less.",
                                "Send this segment a personalized email offering a 20% discount and a feedback survey link."
                              ],
                              "expected_outcome": "Reduce churn within this 'at-risk' segment by 25% over the next 3 months.",
                              "kpis_to_track": ["Segment Churn Rate", "Campaign Redemption Rate"]
                            },
                            {
                              "recommendation": "Develop Cross-Sell Campaign",
                              "rationale": "Multi-category customers are more valuable, so encouraging cross-purchasing is a direct path to increasing overall CLV and loyalty.",
                              "impact": "High",
                              "effort": "Medium",
                              "action_items": [
                                "Identify customers who have only purchased 'Skincare' products.",
                                "Create a targeted marketing campaign showcasing complementary 'Makeup' products."
                              ],
                              "expected_outcome": "Increase the percentage of multi-category customers by 10% within 6 months.",
                              "kpis_to_track": ["Cross-Sell Conversion Rate", "Average Order Value (AOV)"]
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderPrescriptivePage_DA(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Prescriptive Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleSwotTowsAnalysis() {
                const analysisResultContainer = $('analysisResult');
                
                analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Performing Comprehensive SWOT/TOWS Analysis</h3>
                        <p class="text-white/80 mb-2">This multi-step process may take several minutes.</p>
                        <p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p>
                    </div>`;
                
                const statusEl = $('analysisStatus');
                const OLLAMA_URL = "https://ollama.data2int.com/api/generate"; 
                const MODEL_NAME = "llama3.1:latest";

                try {
                    statusEl.textContent = 'Reading your business content...';
                    const useDoc = $('docUpload').checked;
                    let businessContent = '';

                    if (useDoc) {
                        const file = $('swotFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        businessContent = await extractTextFromFile(file);
                    } else {
                        businessContent = $('businessContent').value;
                        if (!businessContent.trim()) throw new Error("Please enter business information in the text area.");
                    }
                    
                    if (businessContent.length > 4000) {
                        businessContent = businessContent.substring(0, 4000);
                    }
                    
                    async function generateOllamaResponse(prompt) {
                        const response = await fetch(OLLAMA_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, options: {num_ctx: 32768} })
                        });
                        if (!response.ok) throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                        const data = await response.json();
                        return extractJsonRobust(data.response);
                    }

                    statusEl.textContent = 'Analyzing internal factors (Strengths & Weaknesses)...';
                    const internalPrompt = `
                        You are a strategic business analyst. Analyze the following business content and identify SPECIFIC internal factors.
                        BUSINESS CONTENT: ${businessContent}
                        TASK: Identify 5-7 strengths and 5-7 weaknesses that are INTERNAL to the organization.
                        CRITICAL REQUIREMENTS:
                        - **Strictly adhere to the provided text.** Do not invent or infer information that is not explicitly stated in the business content.
                        - Each factor must be specific and actionable.
                        - Strengths = internal positive factors the company controls.
                        - Weaknesses = internal negative factors the company needs to address.
                        RESPOND ONLY with this exact JSON structure (no additional text):
                        {"strengths": ["Strength 1", "Strength 2", "Strength 5"],"weaknesses": ["Weakness 1", "Weakness 2", "Weakness 5"]}`;
                    const internal_factors = await generateOllamaResponse(internalPrompt);
                    if (!internal_factors.strengths || !internal_factors.weaknesses) throw new Error("Failed to identify internal factors.");

                    statusEl.textContent = 'Analyzing external factors (Opportunities & Threats)...';
                    const externalPrompt = `
                        You are a strategic business analyst. Analyze the following business content and identify SPECIFIC external factors.
                        BUSINESS CONTENT: ${businessContent}
                        TASK: Identify 5-7 opportunities and 5-7 threats that are EXTERNAL to the organization.
                        CRITICAL REQUIREMENTS:
                        - **Strictly adhere to the provided text.** Do not invent or infer opportunities or threats that are not explicitly mentioned or directly implied in the business content.
                        - Each factor must be specific and actionable.
                        - Opportunities = external positive factors the company can leverage.
                        - Threats = external negative factors that pose risks.
                        RESPOND ONLY with this exact JSON structure (no additional text):
                        {"opportunities": ["Opportunity 1", "Opportunity 2", "Opportunity 5"],"threats": ["Threat 1", "Threat 2", "Threat 5"]}`;
                    const external_factors = await generateOllamaResponse(externalPrompt);
                    if (!external_factors.opportunities || !external_factors.threats) throw new Error("Failed to identify external factors.");

                    const swot_data = { ...internal_factors, ...external_factors };

                    statusEl.textContent = 'Generating TOWS strategies...';
                    const towsPrompt = `
                        You are a strategic business consultant. Your task is to create TOWS matrix strategies that align with the company's primary strategic goal.
                        **Primary Strategic Goal (from the business content):** The company's main goal is to **diversify away from a single DTC model and enter physical retail channels** to increase revenue and brand visibility.
                        **SWOT ANALYSIS:**
                        Strengths: ${swot_data.strengths.map(s => `- ${s}`).join('\n')}
                        Weaknesses: ${swot_data.weaknesses.map(w => `- ${w}`).join('\n')}
                        Opportunities: ${swot_data.opportunities.map(o => `- ${o}`).join('\n')}
                        Threats: ${swot_data.threats.map(t => `- ${t}`).join('\n')}
                        **TASK:**
                        Generate 2-3 specific strategies for each TOWS quadrant. **Every strategy must directly support the primary strategic goal of entering retail partnerships.** Avoid any strategy that contradicts this goal (e.g., do not suggest expanding the DTC model).
                        RESPOND ONLY with this exact JSON structure (no additional text):
                        {"SO_strategies": ["SO strategy 1", "SO strategy 2"],"WO_strategies": ["WO strategy 1", "WO strategy 2"],"ST_strategies": ["ST strategy 1", "ST strategy 2"],"WT_strategies": ["WT strategy 1", "WT strategy 2"]}`;
                    const tows_strategies = await generateOllamaResponse(towsPrompt);

                    statusEl.textContent = 'Applying 80/20 rule for key insights...';
                    const allStrategies = [].concat(...Object.values(tows_strategies));
                    const insightsPrompt = `
                        You are a senior strategy consultant applying the Pareto Principle (80/20 rule).
                        **Primary Strategic Goal:** The company's main goal is to **diversify away from a single DTC model and enter physical retail channels**.
                        **SWOT & TOWS Data:**
                        SWOT FACTORS:
                        Strengths: ${JSON.stringify(swot_data.strengths)}
                        Weaknesses: ${JSON.stringify(swot_data.weaknesses)}
                        Opportunities: ${JSON.stringify(swot_data.opportunities)}
                        Threats: ${JSON.stringify(swot_data.threats)}
                        GENERATED STRATEGIES: ${allStrategies.map(s => `- ${s}`).join('\n')}
                        **TASK:**
                        Apply the 80/20 rule to identify the critical few factors and strategies that will drive the most impact towards achieving the primary strategic goal.
                        1.  **strategic_focus:** Define an overarching strategic direction that is **directly aligned with entering retail channels**.
                        2.  **key_strategies:** Select the 2-3 most impactful strategies from the list provided that support this focus.
                        3.  **critical_factors:** Identify the 2-3 most critical SWOT factors to consider.
                        4.  **priority_actions:** List 2-3 immediate, actionable steps to begin executing the key strategies.
                        RESPOND ONLY with this exact JSON structure (no additional text):
                        {"key_strategies": ["Impactful retail-focused strategy #1", "Impactful retail-focused strategy #2"],"critical_factors": ["Critical factor #1", "Critical factor #2"],"strategic_focus": "A single sentence about successfully launching in retail.","priority_actions": ["Immediate action for retail #1", "Immediate action for retail #2"]}`;
                    const key_insights_80_20 = await generateOllamaResponse(insightsPrompt);
                    
                    statusEl.textContent = 'Analysis complete! Rendering visualizations...';
                    const finalData = {
                        swot_analysis: swot_data,
                        tows_strategies: tows_strategies,
                        key_insights_80_20: key_insights_80_20
                    };
                    renderFullSwotTowsPage(analysisResultContainer, finalData);
                    
                } catch (error) {
                    console.error('Error during SWOT/TOWS analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}<br><br><span class="text-sm text-white/60">Please ensure your Ollama server is running and accessible at ${OLLAMA_URL}.</span></div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

           async function handleMiscAnalysis_MSC() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white mb-4">Compiling Final Report Sections</h3><p class="text-white/80 mb-2">Generating summary, risks, governance, and conclusion...</p></div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';
                    if (useDoc) {
                        const file = $('miscFile').files[0];
                        if (!file) throw new Error("Please select a document.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('miscContent').value;
                        if (!text.trim()) throw new Error("Please provide your document content.");
                    }
                    if (text.length > 4000) text = text.substring(0, 4000);

                    const prompt = `
                        You are a senior business strategist tasked with finalizing a strategic plan. Analyze the provided document.

                        **Strategic Document:**
                        ${text}

                        **TASK:**
                        Compile the final sections of the strategic plan into a single JSON object.

                        1.  **executive_summary**: A detailed, multi-sentence executive summary covering the core problem, the strategic goal, the key initiatives proposed, and the expected outcomes. It should be comprehensive enough for a stakeholder to understand the entire plan at a high level.

                        2.  **risk_assessment**: An array of 3-4 major risks. For each risk:
                            - "risk": A description of the potential risk.
                            - "impact": The potential impact level ("High", "Medium", or "Low").
                            - "likelihood": The likelihood of the risk occurring ("High", "Medium", or "Low").
                            - "mitigation": A specific strategy to mitigate this risk.

                        3.  **governance**: An array of 3-4 key stakeholders or teams. For each:
                            - "stakeholder": The name of the team or role (e.g., "Executive Team", "Marketing Team").
                            - "responsibilities": A list of 2-3 key responsibilities related to the plan's execution.

                        4.  **conclusion**: A comprehensive concluding section that summarizes the strategic importance of the plan, reinforces the key success factors, and provides a final, forward-looking statement on the potential for long-term success.

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "executive_summary": "This strategic plan addresses the critical issue of sales stagnation by proposing a pivot from a solely direct-to-consumer model to a diversified, omnichannel approach. The primary objective is to increase overall company revenue by 40% within 18 months. This will be achieved through three core initiatives: a complete overhaul of product packaging to meet retail standards, the optimization of the supply chain via a 3PL partnership, and the execution of co-branded marketing campaigns to support retail partners. The expected outcomes are not only significant revenue growth but also enhanced brand credibility, a diversified and more resilient business model, and a scalable foundation for future expansion.",
                          "risk_assessment": [
                            {
                              "risk": "Operational bottlenecks from a sudden increase in wholesale order volume.",
                              "impact": "High",
                              "likelihood": "High",
                              "mitigation": "Partner with a scalable third-party logistics (3PL) provider and conduct stress tests before the official retail launch."
                            },
                            {
                              "risk": "Failure to meet the stringent compliance and packaging standards of major retailers.",
                              "impact": "High",
                              "likelihood": "Medium",
                              "mitigation": "Engage with retail consultants during the package redesign phase and secure pre-approval on designs from key retail partners."
                            },
                            {
                              "risk": "Co-branded marketing campaigns fail to drive sufficient in-store traffic.",
                              "impact": "Medium",
                              "likelihood": "Medium",
                              "mitigation": "Allocate a portion of the marketing budget to targeted digital ads geo-fenced around retail locations and track foot traffic data."
                            }
                          ],
                          "governance": [
                            {
                              "stakeholder": "Executive Team",
                              "responsibilities": [
                                "Negotiate and approve final retail partnership contracts.",
                                "Provide strategic oversight and final budget approval.",
                                "Monitor high-level KPIs and overall project ROI."
                              ]
                            },
                            {
                              "stakeholder": "Operations & Supply Chain Team",
                              "responsibilities": [
                                "Manage the 3PL partnership and day-to-day logistics.",
                                "Ensure inventory levels are sufficient to meet retailer demand.",
                                "Oversee the transition to new, retail-ready packaging."
                              ]
                            }
                          ],
                          "conclusion": "In conclusion, this strategic pivot into the retail sector represents a critical and necessary evolution for the company. The plan is ambitious yet grounded in a realistic assessment of the operational and marketing transformations required. The key success factors will be the seamless integration with a 3PL partner and the ability to forge strong, collaborative relationships with retail chains. By proactively managing the identified risks and adhering to the governance structure, the company is well-positioned not just to meet its revenue targets, but to establish itself as a credible and scalable player in the broader beauty market, ensuring long-term sustainable growth."
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    renderMiscPage_MSC(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Misc analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

           async function handleLeveragePointsAnalysis() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Performing Full System Leverage Analysis</h3>
                        <p class="text-white/80 mb-2">Identifying feedback loops and key intervention points...</p>
                    </div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let text = '';

                    if (useDoc) {
                        const file = $('leverageFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('leverageContent').value;
                        if (!text.trim()) throw new Error("Please enter system information in the text area.");
                    }
                    if (text.length > 4000) text = text.substring(0, 4000);

                    const prompt = `
                        You are a master systems thinking analyst. Your task is to analyze the provided system description and create a full leverage point analysis.

                        **System Description:**
                        ${text}

                        **TASK:**
                        Deconstruct the system and provide the following insights in a single JSON object.
                        
                        **Gist Section:**
                        - "summary": A single, concise sentence that captures the core behavior of the system.
                        - "elements": An array of 5-7 key system elements. For each, provide a 'name' and its 'type' ('Stock' or 'Flow').

                        **Feedback Loops Section:**
                        - Identify the single most important "reinforcing" loop (the engine of growth).
                        - Identify the single most important "balancing" loop (what limits or stabilizes the system).
                        - For each loop, provide a "name", "type" ('Reinforcing' or 'Balancing'), a clear "description" of how it works, and a list of the "elements" involved.

                        **Leverage Points Section:**
                        - Identify 3-5 high-impact leverage points based on the system's structure.
                        - For each point, provide a "point" (name), and a recommended "intervention".

                        Return ONLY a valid JSON object with this exact structure:
                        {
                          "gist": {
                            "summary": "The system exhibits growth potential due to X but is constrained by Y.",
                            "elements": [
                              {"name": "Retail Partnerships", "type": "Stock"},
                              {"name": "Marketing Budget", "type": "Flow"}
                            ]
                          },
                          "feedback_loops": {
                            "reinforcing": {
                              "name": "R1: Retail Expansion",
                              "type": "Reinforcing",
                              "description": "More retail partnerships lead to increased brand visibility, attracting even more customers and revenue.",
                              "elements": ["Retail Partnerships", "Brand Visibility", "Revenue"]
                            },
                            "balancing": {
                              "name": "B1: Operational Overwhelm",
                              "type": "Balancing",
                              "description": "Increased demand from new partnerships may overwhelm existing operations, requiring process improvements to maintain efficiency.",
                              "elements": ["Retail Partnerships", "Operational Capacity", "Customer Satisfaction"]
                            }
                          },
                          "leverage_points": [
                            {
                              "point": "Supply Chain Optimization",
                              "intervention": "Implement a supply chain analysis and optimize logistics to meet the increased demand from new retail partnerships."
                            },
                            {
                              "point": "Marketing Strategy Refinement",
                              "intervention": "Refine marketing strategies to effectively reach customers through both digital channels and in-store experiences."
                            },
                            {
                              "point": "Operational Capacity Expansion",
                              "intervention": "Expand operational capacity, including hiring additional staff or investing in technology, to maintain efficiency as the business grows."
                            }
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);

                    renderLeveragePointsPage(analysisResultContainer, parsedData);

                } catch (error) {
                    console.error('Error during Leverage Points analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleArchetypeAnalysis() {
                 const analysisResultContainer = $('analysisResult');
                
                analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div>
                        <h3 class="text-xl font-semibold text-white mb-4">Performing System Thinking Analysis</h3>
                        <p class="text-white/80 mb-2">This multi-step process may take several minutes.</p>
                        <p id="analysisStatus" class="text-white/60 text-sm">Initializing...</p>
                    </div>`;

                const statusEl = $('analysisStatus');
                const OLLAMA_URL = "https://ollama.data2int.com/api/generate";
                const MODEL_NAME = "llama3.1:latest";

                 try {
                    statusEl.textContent = 'Reading and processing your document...';
                    const useDoc = $('docUpload').checked;
                    let text = '';

                    if (useDoc) {
                        const file = $('archetypeFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        text = await extractTextFromFile(file);
                    } else {
                        text = $('archetypeContent').value;
                        if (!text.trim()) throw new Error("Please enter system information in the text area.");
                    }
                    if (!text) throw new Error("Could not get text from the document or text area.");

                    if (text.length > 3000) text = text.substring(0, 3000);

                    async function generateOllamaResponse(prompt) {
                        const response = await fetch(OLLAMA_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: MODEL_NAME, prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                        });
                        if (!response.ok) throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                        const data = await response.json();
                        return JSON.parse(data.response); // Expecting valid JSON now
                    }

                    // Step 1: Extract Concepts
                    statusEl.textContent = 'Step 1/3: Extracting key system concepts...';
                    const conceptPrompt = `
                        Analyze the following text and extract key 2-4 word concepts. For each concept, provide:
                        1. name (2-4 words)
                        2. description (brief)
                        3. effect ("+", "-", or "0")
                        4. influence ("High", "Medium", or "Low")
                        Text: ${text}
                        Return ONLY a valid JSON object with the structure: {"concepts": [{"name": "...", "description": "...", "effect": "...", "influence": "..."}]}`;
                    const conceptData = await generateOllamaResponse(conceptPrompt);
                    const concepts = conceptData.concepts;
                    if (!concepts || concepts.length === 0) throw new Error("No concepts were extracted from the document.");
                    
                    // Step 2: Identify Archetypes
                    statusEl.textContent = 'Step 2/3: Identifying relevant system archetypes...';
                    const conceptText = concepts.map(c => c.name).join(', ');
                    const archetypePrompt = `
                        You are a system thinking expert. Analyze the provided text and the key concepts extracted from it to identify the single most fitting system archetype.

                        **System Description/Text:**
                        ${text}

                        **Key Concepts:**
                        [${conceptText}]

                        **Task:**
                        From the list of common archetypes below, select the ONE that best explains the dynamics described in the text.
                        - **Success to the Successful:** One entity gets more resources, which it uses to perform better and get even more resources, starving competitors.
                        - **Limits to Growth:** A reinforcing process of growth eventually meets a balancing process that slows or stops the growth.
                        - **Shifting the Burden:** A short-term solution is used to correct a problem, but it undermines the ability of the system to use a more fundamental, long-term solution.
                        - **Tragedy of the Commons:** Individuals use a shared resource in their own self-interest, leading to its depletion.
                        - **Fixes that Fail:** A fix is applied to a problem that has immediate positive results but unforeseen long-term negative consequences.

                        **Analysis & Response:**
                        Based on the text and concepts, provide a JSON response with the following structure. The description MUST explain *why* the chosen archetype fits the specific situation described in the text.

                        Return ONLY a valid JSON object:
                        {
                          "archetypes": [{
                            "name": "Name of the chosen archetype (e.g., Success to the Successful)",
                            "relevance_score": 10,
                            "description": "A detailed explanation of how the dynamics in the provided text perfectly match the chosen archetype. Reference the key concepts.",
                            "leverage_points": ["Specific leverage point 1", "Specific leverage point 2"],
                            "interventions": ["Specific intervention 1", "Specific intervention 2"]
                          }]
                        }`;
                    const archetypeData = await generateOllamaResponse(archetypePrompt);
                    let archetypes = archetypeData.archetypes;
                    
                    archetypes.sort((a, b) => (b.relevance_score || 0) - (a.relevance_score || 0));
                    const topArchetypeCount = Math.max(1, Math.floor(archetypes.length * 0.2));
                    const topArchetypes = archetypes.slice(0, topArchetypeCount);

                    // --- MODIFICATION START ---
                    // Step 3: Analyze Leverage Points with enhanced context-aware prompt
                    statusEl.textContent = 'Step 3/3: Analyzing high-impact leverage points...';
                    const leveragePrompt = `
                        You are a systems thinking strategist. Your task is to identify the most effective leverage point to overcome the central problem described in the provided text.

                        **Context:**
                        The text describes a 'Limits to Growth' situation. The company's growth, driven by its "Direct-to-Consumer Model," has hit a limit, causing sales stagnation.
                        The **primary strategic goal** is to break this limit by diversifying sales channels and entering physical retail stores.

                        **Key Concepts Extracted from the Text:**
                        [${conceptText}]

                        **Task:**
                        From the list of key concepts, identify the single concept that represents the **most powerful solution or intervention** to achieve the strategic goal of successful retail expansion.

                        **CRITICAL INSTRUCTION:** Do NOT select a concept that represents the problem (e.g., 'Direct-to-Consumer Model', 'Scalability and Growth Limitations'). You must select the concept that represents the **SOLUTION**.

                        Provide your response as a valid JSON object with the following structure:
                        {
                          "leverage_points": [{
                            "concept": "The name of the concept that is the best leverage point",
                            "score": 10,
                            "reasoning": "Explain WHY this concept is the key to overcoming the DTC limitation and achieving the retail expansion goal, based on the text.",
                            "actions": ["Action 1 related to the solution", "Action 2 related to the solution", "Action 3 related to the solution"],
                            "impact": "High"
                          }]
                        }`;
                    // --- MODIFICATION END ---
                    const leverageData = await generateOllamaResponse(leveragePrompt);
                    let leveragePoints = leverageData.leverage_points;

                    leveragePoints.sort((a, b) => (b.score || 0) - (a.score || 0));
                    const topLeverageCount = Math.max(1, Math.floor(leveragePoints.length * 0.2));
                    const topLeveragePoints = leveragePoints.slice(0, topLeverageCount);

                    // Final step: Render the full page
                    statusEl.textContent = 'Analysis complete! Rendering results...';
                    renderArchetypeAnalysisPage(analysisResultContainer, {
                        concepts,
                        topArchetypes,
                        topLeveragePoints
                    });
                    
                 } catch(error) {
                    console.error('Error during Archetype analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}<br><br><span class="text-sm text-white/60">Please ensure your Ollama server is running and accessible at ${OLLAMA_URL}.</span></div>`;
                 } finally {
                    setLoading('generate', false);
                 }
            }

            async function handleFactorAnalysis() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `
                    <div class="text-center text-white/70 p-8">
                        <div class="typing-indicator mb-6">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                        <h3 class="text-xl font-semibold text-white">Analyzing Document...</h3>
                    </div>`;

                try {
                    const useDoc = $('docUpload').checked;
                    let documentText = '';

                    if (useDoc) {
                        const file = $('factorFile').files[0];
                        if (!file) throw new Error("Please select a document to upload.");
                        documentText = await extractTextFromFile(file);
                    } else {
                        documentText = $('factorContent').value;
                        if (!documentText.trim()) throw new Error("Please enter business information in the text area.");
                    }
                    
                    const externalFactors = extractExternalFactorsJS(documentText);
                    const internalFactors = extractInternalFactorsJS(documentText);
                    
                    const prioritizedExternal = applyParetoAnalysisJS(externalFactors);
                    const prioritizedInternal = applyParetoAnalysisJS(internalFactors);
                    
                    renderFactorAnalysisPage(analysisResultContainer, {
                        external: prioritizedExternal,
                        internal: prioritizedInternal
                    });

                } catch (error) {
                    console.error('Error during Factor Analysis:', error);
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">An error occurred: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }
            
            async function handleProcessMappingAnalysis() {
                const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white">Mapping Your Process...</h3></div>`;
                
                try {
                    const useDoc = document.querySelector('input[name="inputType"]:checked').id === 'docUpload';
                    let content = '';
                    if (useDoc) {
                        const file = $('processFile').files[0];
                        if (!file) throw new Error("Please select a document.");
                        content = await extractTextFromFile(file);
                    } else {
                        content = $('processContent').value.trim();
                        if (!content) throw new Error("Please describe the process.");
                    }

                    const prompt = `
                        Analyze the following process description and model it.
                        DESCRIPTION: "${content}"
                        
                        TASK:
                        1. Define the process name.
                        2. Identify 8-12 sequential steps. For each step: id, name, description, owner/role, and type (Start, Task, Decision, End).
                        3. Define connections between steps: from, to, and label (e.g., 'Yes', 'No', 'Next').
                        4. Identify 2-3 potential bottlenecks with reasons.
                        5. Suggest 3-4 relevant Key Performance Indicators (KPIs).

                        RESPOND ONLY with a valid JSON object with this exact structure, no extra text:
                        {
                          "process_name": "Example: Customer Order Fulfillment",
                          "steps": [
                            {"id": 1, "name": "Order Received", "description": "...", "owner": "Sales", "type": "Start"},
                            {"id": 2, "name": "Check Stock", "description": "...", "owner": "Warehouse", "type": "Task"}
                          ],
                          "connections": [
                            {"from": 1, "to": 2, "label": "Next"}
                          ],
                          "bottlenecks": [
                            {"step_name": "Check Stock", "reason": "Manual inventory checks are slow..."}
                          ],
                          "kpis": [
                            {"name": "Order Cycle Time", "description": "Time from order receipt to delivery."},
                            {"name": "Fulfillment Accuracy", "description": "Percentage of orders fulfilled without errors."}
                          ]
                        }
                    `;
                    
                    const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    
                    renderProcessMappingPage(analysisResultContainer, parsedData);

                } catch (error) {
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Error: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }

            async function handleSystemThinkingAnalysis() {
                 const analysisResultContainer = $('analysisResult');
                analysisResultContainer.innerHTML = `<div class="text-center text-white/70 p-8"><div class="typing-indicator mb-6"> <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div> </div><h3 class="text-xl font-semibold text-white">Analyzing System Dynamics...</h3></div>`;
                
                try {
                    const useDoc = document.querySelector('input[name="inputType"]:checked').id === 'docUpload';
                    let content = '';
                    if (useDoc) {
                        const file = $('systemFile').files[0];
                        if (!file) throw new Error("Please select a document.");
                        content = await extractTextFromFile(file);
                    } else {
                        content = $('systemContent').value.trim();
                        if (!content) throw new Error("Please describe the system.");
                    }
                    
                    const prompt = `
                        Analyze the provided system description to identify its underlying structure.
                        DESCRIPTION: "${content}"

                        TASK:
                        1. Identify 5-7 key elements (stocks, flows, or variables).
                        2. Identify 2-4 feedback loops (reinforcing or balancing). Describe each loop and the elements involved.
                        3. Provide a brief summary of the system's overall behavior based on these loops.
                        4. Identify 2-3 high-leverage points and suggest interventions for each.
                        
                        RESPOND ONLY with a valid JSON object with this exact structure, no extra text:
                        {
                          "elements": [
                            {"name": "Customer Base", "type": "Stock"},
                            {"name": "New Customers", "type": "Flow"}
                          ],
                          "feedback_loops": [
                            {"name": "R1: Word of Mouth", "type": "Reinforcing", "description": "More customers lead to more positive reviews, attracting even more customers.", "elements": ["Customer Base", "Positive Reviews", "New Customers"]}
                          ],
                          "summary": "The system exhibits strong growth potential due to reinforcing loops, but may be constrained by...",
                          "leverage_points": [
                            {"point": "Service Quality", "intervention": "Implement a customer feedback system to quickly address issues and improve service quality, strengthening the 'Word of Mouth' loop."}
                          ]
                        }
                    `;

                     const response = await fetch("https://ollama.data2int.com/api/generate", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: "llama3.1:latest", prompt: prompt, stream: false, format: 'json', options: {num_ctx: 32768} })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const parsedData = JSON.parse(data.response);
                    
                    renderSystemThinkingPage(analysisResultContainer, parsedData);

                } catch (error) {
                    analysisResultContainer.innerHTML = `<div class="p-4 text-center text-red-400">Error: ${error.message}</div>`;
                } finally {
                    setLoading('generate', false);
                }
            }


            // =========================================================================
            // ===== FACTOR ANALYSIS LOGIC (JS PORT)                              =====
            // =========================================================================
            
            function findFactors(text, patternsByCategory, factorType) {
                const factors = [];
                const sentences = text.split(/[.!?]+/);
                
                for (const category in patternsByCategory) {
                    for (const sentence of sentences) {
                        const trimmedSentence = sentence.trim();
                        if (trimmedSentence.length > 25) { // Only check substantial sentences
                            for (const pattern of patternsByCategory[category]) {
                                if (pattern.test(trimmedSentence)) {
                                    let factorText = trimmedSentence;
                                    const words = factorText.split(/\s+/);
                                    if (words.length > 30) {
                                        factorText = words.slice(0, 30).join(' ') + '...';
                                    }
                                    
                                    factors.push({
                                        category: category,
                                        factor: factorText,
                                        impact_score: calculateFactorImpactJS(trimmedSentence),
                                        type: factorType
                                    });
                                    break; 
                                }
                            }
                        }
                    }
                }

                const seen = new Set();
                const uniqueFactors = factors.filter(factor => {
                    const key = factor.factor.toLowerCase();
                    if (seen.has(key)) {
                        return false;
                    } else {
                        seen.add(key);
                        return true;
                    }
                });

                return uniqueFactors.sort((a, b) => b.impact_score - a.impact_score);
            }

            function extractExternalFactorsJS(text) {
                const patterns = {
                    'Political/Regulatory': [/government\s+policy/gi, /regulation[s]?/gi, /political\s+climate/gi, /tax\s+policy/gi, /regulatory\s+change[s]?/gi, /political\s+stability/gi, /policy\s+change[s]?/gi, /government\s+support/gi, /regulatory\s+compliance/gi, /legal\s+requirement[s]?/gi, /political\s+risk[s]?/gi, /legislative\s+change[s]?/gi, /government\s+incentive[s]?/gi, /trade\s+policy/gi, /political\s+factor[s]?/gi],
                    'Economic': [/economic\s+growth/gi, /recession/gi, /inflation/gi, /interest\s+rate[s]?/gi, /economic\s+downturn/gi, /market\s+growth/gi, /economic\s+condition[s]?/gi, /gdp\s+growth/gi, /economic\s+trend[s]?/gi, /currency\s+fluctuation[s]?/gi, /economic\s+stability/gi, /market\s+size/gi, /purchasing\s+power/gi, /economic\s+indicator[s]?/gi, /financial\s+crisis/gi, /economic\s+factor[s]?/gi],
                    'Social/Cultural': [/demographic\s+change[s]?/gi, /social\s+trend[s]?/gi, /cultural\s+shift[s]?/gi, /consumer\s+behavior/gi, /lifestyle\s+change[s]?/gi, /population\s+growth/gi, /social\s+attitude[s]?/gi, /cultural\s+preference[s]?/gi, /social\s+factor[s]?/gi, /demographic\s+trend[s]?/gi, /generational\s+change[s]?/gi, /social\s+norm[s]?/gi, /cultural\s+value[s]?/gi, /social\s+movement[s]?/gi],
                    'Technological': [/technological\s+advance[s]?/gi, /innovation[s]?/gi, /digital\s+transformation/gi, /automation/gi, /artificial\s+intelligence/gi, /technology\s+trend[s]?/gi, /digitalization/gi, /technological\s+disruption/gi, /new\s+technolog[y|ies]/gi, /tech\s+development[s]?/gi, /technological\s+change[s]?/gi, /digital\s+trend[s]?/gi, /emerging\s+technolog[y|ies]/gi, /technological\s+factor[s]?/gi],
                    'Market/Industry': [/market\s+trend[s]?/gi, /industry\s+growth/gi, /market\s+demand/gi, /industry\s+change[s]?/gi, /market\s+dynamic[s]?/gi, /industry\s+trend[s]?/gi, /market\s+condition[s]?/gi, /industry\s+standard[s]?/gi, /market\s+evolution/gi, /sector\s+growth/gi, /market\s+maturity/gi, /industry\s+consolidation/gi, /market\s+expansion/gi, /industry\s+factor[s]?/gi],
                    'Competitive': [/competitor[s]?\s+enter[y|ing]/gi, /new\s+competitor[s]?/gi, /competitive\s+pressure/gi, /market\s+competition/gi, /competitor[s]?\s+action[s]?/gi, /competitive\s+threat[s]?/gi, /industry\s+rival[s]?/gi, /competitive\s+landscape/gi, /competitor[s]?\s+strategy/gi, /market\s+rival[s]?/gi, /competitive\s+force[s]?/gi, /competitor[s]?\s+advantage/gi, /competitive\s+environment/gi, /rival\s+compan[y|ies]/gi],
                    'Environmental': [/climate\s+change/gi, /environmental\s+regulation[s]?/gi, /sustainability\s+trend[s]?/gi, /environmental\s+concern[s]?/gi, /green\s+initiative[s]?/gi, /carbon\s+footprint/gi, /environmental\s+impact/gi, /climate\s+factor[s]?/gi, /environmental\s+policy/gi, /sustainability\s+requirement[s]?/gi, /environmental\s+standard[s]?/gi, /climate\s+risk[s]?/gi, /environmental\s+factor[s]?/gi]
                };
                return findFactors(text, patterns, 'External');
            }

            function extractInternalFactorsJS(text) {
                const patterns = {
                    'Human Resources': [/skilled\s+workforce/gi, /talent\s+pool/gi, /employee\s+expertise/gi, /team\s+capability/gi, /staff\s+skill[s]?/gi, /human\s+resource[s]?/gi, /employee\s+motivation/gi, /workforce\s+quality/gi, /talent\s+management/gi, /staff\s+experience/gi, /employee\s+training/gi, /skill[s]?\s+gap[s]?/gi, /team\s+strength[s]?/gi, /personnel\s+capability/gi, /employee\s+retention/gi],
                    'Financial Resources': [/financial\s+strength/gi, /cash\s+flow/gi, /capital\s+resource[s]?/gi, /funding/gi, /financial\s+position/gi, /revenue\s+stream[s]?/gi, /profitability/gi, /financial\s+performance/gi, /capital\s+structure/gi, /financial\s+stability/gi, /budget\s+allocation/gi, /financial\s+resource[s]?/gi, /cost\s+structure/gi, /financial\s+capability/gi, /investment\s+capacity/gi],
                    'Technology & Systems': [/technology\s+infrastructure/gi, /it\s+system[s]?/gi, /technological\s+capability/gi, /software\s+system[s]?/gi, /technology\s+platform[s]?/gi, /digital\s+infrastructure/gi, /technical\s+expertise/gi, /system\s+integration/gi, /technology\s+stack/gi, /it\s+capability/gi, /technological\s+asset[s]?/gi, /digital\s+capability/gi, /system\s+efficiency/gi, /technical\s+resource[s]?/gi],
                    'Operations & Processes': [/operational\s+efficiency/gi, /process\s+improvement/gi, /operational\s+capability/gi, /production\s+capacity/gi, /operational\s+excellence/gi, /process\s+optimization/gi, /supply\s+chain/gi, /operational\s+process[es]?/gi, /manufacturing\s+capability/gi, /operational\s+system[s]?/gi, /process\s+efficiency/gi, /operational\s+strength[s]?/gi, /production\s+process[es]?/gi, /operational\s+performance/gi],
                    'Brand & Marketing': [/brand\s+recognition/gi, /brand\s+strength/gi, /market\s+presence/gi, /brand\s+value/gi, /marketing\s+capability/gi, /brand\s+reputation/gi, /customer\s+loyalty/gi, /brand\s+awareness/gi, /marketing\s+expertise/gi, /brand\s+position[ing]?/gi, /marketing\s+strength[s]?/gi, /brand\s+equity/gi, /marketing\s+resource[s]?/gi, /promotional\s+capability/gi, /brand\s+image/gi],
                    'Research & Development': [/research\s+capability/gi, /innovation\s+capability/gi, /r&d\s+strength[s]?/gi, /product\s+development/gi, /research\s+expertise/gi, /innovation\s+process[es]?/gi, /development\s+capability/gi, /research\s+resource[s]?/gi, /innovative\s+capacity/gi, /r&d\s+investment/gi, /research\s+facility/gi, /development\s+expertise/gi, /innovation\s+strength[s]?/gi, /research\s+team/gi],
                    'Strategic Assets': [/intellectual\s+property/gi, /patent[s]?/gi, /strategic\s+alliance[s]?/gi, /partnership[s]?/gi, /strategic\s+asset[s]?/gi, /competitive\s+advantage/gi, /core\s+competenc[y|ies]/gi, /unique\s+resource[s]?/gi, /strategic\s+capability/gi, /proprietary\s+technology/gi, /strategic\s+position/gi, /key\s+asset[s]?/gi, /distinctive\s+capability/gi, /strategic\s+strength[s]?/gi]
                };
                return findFactors(text, patterns, 'Internal');
            }

            function calculateFactorImpactJS(sentence) {
                let base_score = 5.0;
                const positive_words = ['growth', 'opportunity', 'strength', 'advantage', 'improvement', 'increase', 'strong', 'effective', 'successful', 'excellent', 'high'];
                const negative_words = ['risk', 'threat', 'challenge', 'weakness', 'decline', 'decrease', 'poor', 'low', 'difficult', 'problem', 'issue', 'concern'];
                const high_impact_words = ['significant', 'major', 'critical', 'important', 'key', 'essential', 'substantial', 'considerable', 'dramatic', 'crucial'];
                
                const sentence_lower = sentence.toLowerCase();
                
                const positive_count = positive_words.reduce((count, word) => count + (sentence_lower.includes(word) ? 1 : 0), 0);
                const negative_count = negative_words.reduce((count, word) => count + (sentence_lower.includes(word) ? 1 : 0), 0);
                const high_impact_count = high_impact_words.reduce((count, word) => count + (sentence_lower.includes(word) ? 1 : 0), 0);
                
                const impact_modifier = (positive_count * 0.5) - (negative_count * 0.3) + (high_impact_count * 0.8);
                let final_score = base_score + impact_modifier;
                
                return parseFloat(Math.max(1.0, Math.min(10.0, final_score)).toFixed(2));
            }

           function applyParetoAnalysisJS(factors) {
                if (!factors || factors.length === 0) return [];
                
                const sorted_factors = [...factors].sort((a, b) => b.impact_score - a.impact_score);
                const total_impact = sorted_factors.reduce((sum, f) => sum + f.impact_score, 0);
                
                if (total_impact === 0) {
                    return sorted_factors.map((f, i) => ({ ...f, cumulative_percentage: 0, priority: 'Low', rank: i + 1 }));
                }
                
                let cumulative_impact = 0;
                return sorted_factors.map((factor, i) => {
                    cumulative_impact += factor.impact_score;
                    const cumulative_percentage = (cumulative_impact / total_impact) * 100;
                    return {
                        ...factor,
                        cumulative_percentage: parseFloat(cumulative_percentage.toFixed(1)),
                        priority: cumulative_percentage <= 80 ? 'High' : 'Low',
                        rank: i + 1
                    };
                });
            }

            // =========================================================================
            // ===== VISUALIZATION & RENDERING FUNCTIONS                          =====
            // =========================================================================
            function renderProcessMappingPage(container, data) {
                container.innerHTML = ''; // Clear the loading indicator
                const { process_name, steps, connections, bottlenecks, kpis } = data;

                if (!process_name || !steps || !connections) {
                    container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete process data received from the AI. Please try again.</div>`;
                    return;
                }

                // --- Create Tab Navigation ---
                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `
                    <button class="analysis-tab-btn active" data-tab="flowchart"> Process Flowchart</button>
                    <button class="analysis-tab-btn" data-tab="details"> Step Details</button>
                    <button class="analysis-tab-btn" data-tab="insights"> Insights & KPIs</button>
                `;
                container.appendChild(tabNav);

                // --- Create Tab Panels ---
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `
                    <div id="flowchartPanel" class="analysis-tab-panel active"></div>
                    <div id="detailsPanel" class="analysis-tab-panel"></div>
                    <div id="insightsPanel" class="analysis-tab-panel"></div>
                `;

                // --- 1. Populate Flowchart Panel ---
                const flowchartPanel = $('flowchartPanel');
                let flowchartHtml = `<h3 class="text-2xl font-bold mb-6 text-center">${process_name}</h3><div class="space-y-2">`;
                
                const stepMap = new Map(steps.map(step => [step.id, step]));

                steps.forEach((step, index) => {
                    let stepClass = 'bg-white/10 p-4 rounded-lg border-l-4 ';
                    let icon = '';
                    switch(step.type.toLowerCase()) {
                        case 'start':
                            stepClass += 'border-green-400';
                            icon = '';
                            break;
                        case 'end':
                            stepClass += 'border-red-400';
                            icon = '';
                            break;
                        case 'decision':
                            stepClass += 'border-yellow-400';
                            icon = '';
                            break;
                        default:
                            stepClass += 'border-blue-400';
                            icon = '';
                    }
                    flowchartHtml += `<div class="${stepClass}"><p class="font-bold text-lg">${icon} ${step.name}</p><p class="text-sm text-white/70">Owner: ${step.owner}</p></div>`;

                    // Add connection arrow and label if not the last step
                    if (index < steps.length - 1) {
                         const connection = connections.find(c => c.from === step.id);
                         const label = connection ? connection.label : 'Next';
                         flowchartHtml += `<div class="text-center text-white/50 text-2xl font-light leading-none" aria-hidden="true"> <span class="text-xs font-sans">${label}</span></div>`;
                    }
                });
                flowchartHtml += '</div>';
                flowchartPanel.innerHTML = flowchartHtml;

                // --- 2. Populate Step Details Panel ---
                const detailsPanel = $('detailsPanel');
                let detailsHtml = `<h3 class="text-2xl font-bold mb-4">Detailed Step Breakdown</h3><div class="overflow-x-auto"><table class="w-full text-left">
                    <thead><tr class="border-b border-white/20"><th class="p-2">Step</th><th class="p-2">Owner/Role</th><th class="p-2">Type</th><th class="p-2">Description</th></tr></thead><tbody>`;
                steps.forEach(step => {
                    detailsHtml += `<tr class="border-b border-white/10"><td class="p-2 font-semibold">${step.name}</td><td class="p-2">${step.owner}</td><td class="p-2">${step.type}</td><td class="p-2 text-sm text-white/80">${step.description}</td></tr>`;
                });
                detailsHtml += `</tbody></table></div>`;
                detailsPanel.innerHTML = detailsHtml;

                // --- 3. Populate Insights & KPIs Panel ---
                const insightsPanel = $('insightsPanel');
                let insightsHtml = `<h3 class="text-2xl font-bold mb-4">Analysis & Recommendations</h3>`;
                // Bottlenecks
                if (bottlenecks && bottlenecks.length > 0) {
                    insightsHtml += `<h4 class="text-xl font-semibold mb-3 text-red-300"> Potential Bottlenecks</h4><div class="space-y-3 mb-6">`;
                    bottlenecks.forEach(b => {
                        insightsHtml += `<div class="metric-card"><p class="font-bold">${b.step_name}</p><p class="text-sm text-white/80">${b.reason}</p></div>`;
                    });
                    insightsHtml += `</div>`;
                }
                // KPIs
                if (kpis && kpis.length > 0) {
                    insightsHtml += `<h4 class="text-xl font-semibold mb-3 text-green-300"> Recommended KPIs</h4><div class="space-y-3">`;
                    kpis.forEach(k => {
                        insightsHtml += `<div class="metric-card"><p class="font-bold">${k.name}</p><p class="text-sm text-white/80">${k.description}</p></div>`;
                    });
                    insightsHtml += `</div>`;
                }
                insightsPanel.innerHTML = insightsHtml;

                // --- Final Touches ---
                analysisCache[currentTemplateId] = container.innerHTML; // Cache the result
                
                // Add event listener for tab switching
                tabNav.addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        const targetPanel = $(e.target.dataset.tab + 'Panel');
                        targetPanel.classList.add('active');
                    }
                });

                $('analysisActions').classList.remove('hidden'); // Show save buttons
            }

            function renderSystemThinkingPage(container, data) {
                container.innerHTML = ''; // Clear the loading indicator
                const { elements, feedback_loops, summary, leverage_points } = data;

                if (!elements || !feedback_loops || !summary || !leverage_points) {
                    container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete system analysis data received. Please try again.</div>`;
                    return;
                }

                // --- Create Tab Navigation ---
                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `
                    <button class="analysis-tab-btn active" data-tab="summary"> Gist</button>
                    <button class="analysis-tab-btn" data-tab="loops"> Feedback Loops</button>
                    <button class="analysis-tab-btn" data-tab="leverage"> Leverage Points</button>
                `;
                container.appendChild(tabNav);

                // --- Create Tab Panels ---
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `
                    <div id="summaryPanel" class="analysis-tab-panel active"></div>
                    <div id="loopsPanel" class="analysis-tab-panel"></div>
                    <div id="leveragePanel" class="analysis-tab-panel"></div>
                `;

                // --- 1. Populate System Summary Panel ---
                const summaryPanel = $('summaryPanel');
                let summaryHtml = `<h3 class="text-2xl font-bold mb-4">System Overview</h3>`;
                summaryHtml += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="metric-card"><h4 class="font-bold">Key Elements</h4><p class="text-3xl font-bold">${elements.length}</p></div>
                    <div class="metric-card"><h4 class="font-bold">Feedback Loops</h4><p class="text-3xl font-bold">${feedback_loops.length}</p></div>
                    <div class="metric-card critical"><h4 class="font-bold">Leverage Points</h4><p class="text-3xl font-bold">${leverage_points.length}</p></div>
                </div>`;
                summaryHtml += `<blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 mb-6">"${summary}"</blockquote>`;
                summaryHtml += `<h4 class="text-xl font-semibold mb-3">System Elements</h4><div class="flex flex-wrap gap-2">`;
                elements.forEach(el => {
                    const typeClass = el.type.toLowerCase() === 'stock' ? 'bg-blue-500/20 text-blue-300' : 'bg-purple-500/20 text-purple-300';
                    summaryHtml += `<span class="px-3 py-1 rounded-full text-sm ${typeClass}">${el.name} <span class="text-xs opacity-70">(${el.type})</span></span>`;
                });
                summaryHtml += `</div>`;
                summaryPanel.innerHTML = summaryHtml;


                // --- 2. Populate Feedback Loops Panel ---
                const loopsPanel = $('loopsPanel');
                let loopsHtml = `<h3 class="text-2xl font-bold mb-4">Identified Feedback Loops</h3><div class="space-y-4">`;
                feedback_loops.forEach(loop => {
                    const isReinforcing = loop.type.toLowerCase() === 'reinforcing';
                    const loopIcon = isReinforcing ? '' : '';
                    const loopColor = isReinforcing ? 'border-green-400' : 'border-yellow-400';
                    loopsHtml += `<div class="bg-white/5 p-4 rounded-lg border-l-4 ${loopColor}">
                        <h4 class="text-lg font-bold">${loopIcon} ${loop.name} <span class="text-sm font-light text-white/70">(${loop.type})</span></h4>
                        <p class="text-sm text-white/80 my-2">${loop.description}</p>
                        <div class="text-xs text-white/60"><strong>Elements:</strong> ${loop.elements.join(', ')}</div>
                    </div>`;
                });
                loopsHtml += `</div>`;
                loopsPanel.innerHTML = loopsHtml;

                // --- 3. Populate Leverage Points Panel ---
                const leveragePanel = $('leveragePanel');
                let leverageHtml = `<h3 class="text-2xl font-bold mb-4">High-Impact Leverage Points</h3>
                <div class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6"> <strong>Focus here for maximum impact.</strong> Small, well-focused actions on these points can lead to significant, enduring improvements.</div>
                <div class="space-y-4">`;
                leverage_points.forEach(point => {
                    leverageHtml += `<div class="bg-white/5 p-4 rounded-lg border-l-4 border-indigo-400">
                        <h4 class="text-lg font-bold"> ${point.point}</h4>
                        <p class="text-sm text-white/80 mt-2"><strong>Recommended Intervention:</strong> ${point.intervention}</p>
                    </div>`;
                });
                leverageHtml += `</div>`;
                leveragePanel.innerHTML = leverageHtml;


                // --- Final Touches ---
                analysisCache[currentTemplateId] = container.innerHTML; // Cache the result

                // Add event listener for tab switching
                tabNav.addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        const targetPanel = $(e.target.dataset.tab + 'Panel');
                        targetPanel.classList.add('active');
                    }
                });

                $('analysisActions').classList.remove('hidden'); // Show save buttons
            }

            function renderFactorAnalysisPage(container, data) {
                 container.innerHTML = '';
                 const { external, internal } = data;

                 const tabNav = document.createElement('div');
                 tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                 tabNav.innerHTML = `
                     <button class="analysis-tab-btn active" data-tab="external"> External Factors</button>
                     <button class="analysis-tab-btn" data-tab="internal"> Internal Factors</button>
                     <button class="analysis-tab-btn" data-tab="pareto"> 80/20 Analysis</button>
                     <button class="analysis-tab-btn" data-tab="summary"> Summary</button>
                 `;
                 container.appendChild(tabNav);
                 
                 const tabContent = document.createElement('div');
                 container.appendChild(tabContent);

                 tabContent.innerHTML = `
                     <div id="externalPanel" class="analysis-tab-panel active"></div>
                     <div id="internalPanel" class="analysis-tab-panel"></div>
                     <div id="paretoPanel" class="analysis-tab-panel"></div>
                     <div id="summaryPanel" class="analysis-tab-panel"></div>
                 `;

                 renderFactorTab('externalPanel', 'External Factors Analysis', external);
                 renderFactorTab('internalPanel', 'Internal Factors Analysis', internal);
                 renderParetoTab('paretoPanel', [...external, ...internal]);
                 renderSummaryTab('summaryPanel', external, internal);
                 
                 analysisCache[currentTemplateId] = container.innerHTML;

                 tabNav.addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        const targetPanelId = e.target.dataset.tab + 'Panel';
                        const targetPanel = $(targetPanelId);
                        targetPanel.classList.add('active');
                        
                        const chart = targetPanel.querySelector('.plotly-chart');
                        if (chart) {
                            Plotly.Plots.resize(chart);
                        }
                    }
                 });
            }

            function renderFactorTab(containerId, title, factors) {
                const container = $(containerId);
                let contentHtml = `<h3 class="text-2xl font-bold mb-4">${title}</h3>`;
                
                if (factors && factors.length > 0) {
                    const categories = factors.reduce((acc, f) => {
                        if (!acc[f.category]) acc[f.category] = [];
                        acc[f.category].push(f);
                        return acc;
                    }, {});

                    contentHtml += `<div id="${containerId}-chart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
                    
                    for (const category in categories) {
                        contentHtml += `<div class="mb-4"><details class="bg-white/5 p-3 rounded-lg"><summary class="cursor-pointer font-semibold">${category} (${categories[category].length} factors)</summary><div class="mt-2 pl-4">`;
                        categories[category].forEach(factor => {
                             contentHtml += `<div class="py-2 border-b border-white/10 last:border-b-0">
                                <p class="${factor.priority === 'High' ? 'text-red-300' : 'text-yellow-300'}"><strong>Rank #${factor.rank}</strong> - Score: ${factor.impact_score}</p>
                                <p>${factor.factor}</p>
                                <p class="text-sm text-white/60">Priority: ${factor.priority} | Cumulative: ${factor.cumulative_percentage}%</p>
                            </div>`;
                        });
                        contentHtml += `</div></details></div>`;
                    }
                } else {
                    contentHtml += '<p class="text-white/70">No factors found in this category.</p>';
                }
                
                container.innerHTML = contentHtml;
                
                if (factors && factors.length > 0) {
                    const categoryCounts = Object.entries(factors.reduce((acc, f) => {
                        acc[f.category] = (acc[f.category] || 0) + 1;
                        return acc;
                    }, {})).map(([cat, count]) => ({ category: cat, count: count }));

                    Plotly.newPlot(`${containerId}-chart`, [{
                        x: categoryCounts.map(c => c.category),
                        y: categoryCounts.map(c => c.count),
                        type: 'bar',
                        marker: { color: 'var(--primary)' }
                    }], {
                        title: `${title.split(' ')[0]} Factors by Category`,
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: 'white' },
                        xaxis: { automargin: true, tickangle: -25 },
                        yaxis: { title: 'Number of Factors', gridcolor: 'rgba(255,255,255,0.2)' }
                    }, {responsive: true});
                }
            }

            function renderParetoTab(containerId, allFactors) {
                const container = $(containerId);
                let contentHtml = `<h3 class="text-2xl font-bold mb-4"> 80/20 Pareto Analysis</h3>`;
                
                if (allFactors && allFactors.length > 0) {
                    contentHtml += `<div id="pareto-chart-container" class="w-full h-[600px] mb-8 plotly-chart"></div>`;
                    
                    const highPriorityFactors = allFactors.filter(f => f.priority === 'High');
                    contentHtml += `<h4 class="text-xl font-semibold mt-8 mb-3"> Priority Recommendations</h4>
                                    <p class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6"><strong>80/20 Rule Application:</strong> Focus on the top ${highPriorityFactors.length} factors to address ~80% of the strategic impact.</p>`;
                    
                    const extHigh = highPriorityFactors.filter(f => f.type === 'External').slice(0, 5);
                    const intHigh = highPriorityFactors.filter(f => f.type === 'Internal').slice(0, 5);

                    contentHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><h5 class="font-bold mb-2">Top External Priorities</h5>`;
                    extHigh.forEach(f => {
                        contentHtml += `<div class="text-sm mb-2 p-2 bg-white/5 rounded"><strong>${f.category}:</strong> ${f.factor.substring(0, 60)}...</div>`;
                    });
                    contentHtml += `</div><div><h5 class="font-bold mb-2">Top Internal Priorities</h5>`;
                    intHigh.forEach(f => {
                        contentHtml += `<div class="text-sm mb-2 p-2 bg-white/5 rounded"><strong>${f.category}:</strong> ${f.factor.substring(0, 60)}...</div>`;
                    });
                    contentHtml += `</div></div>`;
                } else {
                    contentHtml += '<p class="text-white/70">No factors available for Pareto analysis.</p>';
                }
                
                container.innerHTML = contentHtml;
                
                if (allFactors && allFactors.length > 0) {
                    const topFactors = [...allFactors].sort((a, b) => b.impact_score - a.impact_score).slice(0, 15);
                    
                    const trace1 = {
                        x: topFactors.map(f => `${f.type.substring(0,3)}: ${f.factor.substring(0,40)}...`),
                        y: topFactors.map(f => f.impact_score),
                        name: 'Impact Score',
                        type: 'bar',
                        marker: { color: topFactors.map(f => f.priority === 'High' ? 'var(--accent)' : 'var(--primary)') }
                    };

                    const trace2 = {
                        x: topFactors.map(f => `${f.type.substring(0,3)}: ${f.factor.substring(0,40)}...`),
                        y: topFactors.map(f => f.cumulative_percentage),
                        name: 'Cumulative %',
                        type: 'scatter',
                        yaxis: 'y2',
                        line: { color: '#FFF' }
                    };

                    const layout = {
                        title: '80/20 Pareto Analysis - Top Strategic Factors',
                        xaxis: { tickangle: -45, automargin: true },
                        yaxis: { title: 'Impact Score' },
                        yaxis2: { title: 'Cumulative %', overlaying: 'y', side: 'right', range: [0, 101] },
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                        legend: { orientation: 'h', y: -0.4 },
                        shapes: [{ type: 'line', xref: 'paper', yref: 'y2', x0: 0, y0: 80, x1: 1, y1: 80, line: { color: 'orange', width: 2, dash: 'dash' }}]
                    };
                    
                    Plotly.newPlot('pareto-chart-container', [trace1, trace2], layout, {responsive: true});
                }
            }
            
            function renderSummaryTab(containerId, external, internal) {
                 const container = $(containerId);
                 const highPriorityExternal = external.filter(f => f.priority === 'High').length;
                 const highPriorityInternal = internal.filter(f => f.priority === 'High').length;
                 const topExtCat = external.length > 0 ? Object.entries(external.reduce((acc, f) => { acc[f.category] = (acc[f.category] || 0) + 1; return acc; }, {})).sort((a,b) => b[1]-a[1])[0][0] : 'N/A';
                 const topIntCat = internal.length > 0 ? Object.entries(internal.reduce((acc, f) => { acc[f.category] = (acc[f.category] || 0) + 1; return acc; }, {})).sort((a,b) => b[1]-a[1])[0][0] : 'N/A';
                 
                 container.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4"> Executive Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="metric-card"><h4 class="font-bold">Total External Factors</h4><p class="text-3xl font-bold">${external.length}</p></div>
                        <div class="metric-card"><h4 class="font-bold">Total Internal Factors</h4><p class="text-3xl font-bold">${internal.length}</p></div>
                        <div class="metric-card critical"><h4 class="font-bold">High-Priority External</h4><p class="text-3xl font-bold">${highPriorityExternal}</p></div>
                        <div class="metric-card critical"><h4 class="font-bold">High-Priority Internal</h4><p class="text-3xl font-bold">${highPriorityInternal}</p></div>
                    </div>
                    <div class="bg-white/5 p-4 rounded-lg">
                        <h4 class="text-xl font-semibold mb-3">Key Insights</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>External Focus:</strong> The most dominant external factors fall under the <strong>${topExtCat}</strong> category.</li>
                            <li><strong>Internal Focus:</strong> Internally, factors related to <strong>${topIntCat}</strong> are most prominent.</li>
                            <li><strong>80/20 Application:</strong> A total of <strong>${highPriorityExternal + highPriorityInternal}</strong> factors have been identified as high-priority, representing the critical 20% that likely drive 80% of strategic impact.</li>
                        </ul>
                    </div>
                 `;
            }

            function renderKpiPage_KE(container, data) {
                container.innerHTML = '';
                const { main_goal, kpis, critical_events } = data;
                if (!main_goal || !kpis || !critical_events) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="dashboard"> KPI Dashboard</button><button class="analysis-tab-btn" data-tab="timeline"> Critical Events Timeline</button><button class="analysis-tab-btn" data-tab="details"> Detailed Framework</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="dashboardPanel" class="analysis-tab-panel active"></div><div id="timelinePanel" class="analysis-tab-panel"></div><div id="detailsPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Populate KPI Dashboard Panel ---
                const dashboardPanel = $('dashboardPanel');
                let dashboardHtml = `<div class="p-4 space-y-8"><div class="p-6 rounded-lg bg-white/10 border border-white/20 text-center"><h3 class="text-xl font-bold mb-2 text-indigo-300"> Main Goal</h3><p class="text-2xl italic text-white/90">${main_goal}</p></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4">`;
                kpis.forEach(kpi => {
                    dashboardHtml += `<div class="kpi-card"><div><p class="kpi-name">${kpi.name}</p></div><div><p class="kpi-target">${kpi.target}</p></div><div><p class="kpi-type">${kpi.type}</p></div></div>`;
                });
                dashboardHtml += `</div></div>`;
                dashboardPanel.innerHTML = dashboardHtml;

                // --- 2. Populate Timeline Panel ---
                const timelinePanel = $('timelinePanel');
                let timelineHtml = `<h2 class="text-3xl font-bold text-center mb-8">Project Milestones</h2><div class="action-plan-container flex flex-col items-center">`;
                critical_events.forEach(event => {
                    timelineHtml += `<div class="timeline-item"><div class="timeline-dot"></div><div class="timeline-content"><p class="text-xs text-indigo-300 font-semibold">${event.timeline}</p><h4 class="text-lg font-bold">${event.event_name}</h4></div></div>`;
                });
                timelineHtml += `</div>`;
                timelinePanel.innerHTML = timelineHtml;

                // --- 3. Populate Detailed Framework Panel ---
                const detailsPanel = $('detailsPanel');
                let detailsHtml = `<div class="p-4 space-y-6"><h3 class="text-2xl font-bold mb-4">Key Performance Indicators (KPIs)</h3>`;
                kpis.forEach(kpi => {
                    detailsHtml += `<div class="bg-white/5 p-4 rounded-lg"><h4 class="text-lg font-bold">${kpi.name} <span class="text-sm font-light text-white/70">(${kpi.type})</span></h4><p class="text-sm text-white/80 my-2">${kpi.description}</p><div class="text-xs grid grid-cols-2 gap-2"><p><strong>Formula:</strong> ${kpi.formula}</p><p><strong>Target:</strong> ${kpi.target}</p></div></div>`;
                });
                detailsHtml += `<h3 class="text-2xl font-bold mt-8 mb-4">Critical Events & Milestones</h3>`;
                critical_events.forEach(event => {
                    detailsHtml += `<div class="bg-white/5 p-4 rounded-lg mb-3"><h4 class="text-lg font-bold">${event.event_name} <span class="text-sm font-light text-white/70">(${event.timeline})</span></h4><p class="text-sm text-white/80 my-1">${event.description}</p></div>`;
                });
                detailsHtml += `</div>`;
                detailsPanel.innerHTML = detailsHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); $(e.target.dataset.tab + 'Panel').classList.add('active'); } });
                $('analysisActions').classList.remove('hidden');
            }

            function renderFullSwotTowsPage(container, data) {
                container.innerHTML = ''; // Clear loading state
                const { swot_analysis, tows_strategies, key_insights_80_20 } = data;
                if (!swot_analysis || !tows_strategies || !key_insights_80_20) {
                     container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete analysis data received.</div>`;
                     return;
                }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `
                    <button class="analysis-tab-btn active" data-tab="swot">SWOT Matrix</button>
                    <button class="analysis-tab-btn" data-tab="tows">TOWS Strategies</button>
                    <button class="analysis-tab-btn" data-tab="insights">80/20 Key Insights</button>
                    <button class="analysis-tab-btn" data-tab="details">Detailed Analysis</button>
                `;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);

                tabContent.innerHTML = `
                    <div id="swotPanel" class="analysis-tab-panel active"></div>
                    <div id="towsPanel" class="analysis-tab-panel"></div>
                    <div id="insightsPanel" class="analysis-tab-panel"></div>
                    <div id="detailsPanel" class="analysis-tab-panel"></div>
                `;

                renderSwotVisualization(swot_analysis, 'swotPanel');
                renderTowsVisualization(tows_strategies, 'towsPanel');
                render8020Visualization(key_insights_80_20, 'insightsPanel');
                renderDetailedAnalysis(swot_analysis, tows_strategies, 'detailsPanel');
                
                analysisCache[currentTemplateId] = container.innerHTML;

                tabNav.addEventListener('click', e => {
                    if(e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        const targetPanel = $(e.target.dataset.tab + 'Panel');
                        targetPanel.classList.add('active');
                        const chart = targetPanel.querySelector('.plotly-chart');
                        if (chart) Plotly.Plots.resize(chart);
                    }
                });
            }
            
            function renderDetailedAnalysis(swotData, towsData, containerId) {
                const container = $(containerId);
                const factorCounts = { 'Strengths': (swotData.strengths || []).length, 'Weaknesses': (swotData.weaknesses || []).length, 'Opportunities': (swotData.opportunities || []).length, 'Threats': (swotData.threats || []).length };
                const strategyCounts = { 'SO (Strength-Opportunity)': (towsData.SO_strategies || []).length, 'WO (Weakness-Opportunity)': (towsData.WO_strategies || []).length, 'ST (Strength-Threat)': (towsData.ST_strategies || []).length, 'WT (Weakness-Threat)': (towsData.WT_strategies || []).length };
                const factorColors = ['#2E8B57', '#CD5C5C', '#4169E1', '#FF8C00'];
                
                let metricsHtml = `<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">`;
                Object.entries(factorCounts).forEach(([key, value], index) => { metricsHtml += `<div class="p-4 rounded-lg bg-white/5 text-center"><h4 class="text-sm font-bold" style="color:${factorColors[index]}">${key}</h4><p class="text-3xl font-bold">${value}</p></div>`; });
                metricsHtml += `</div>`;
                
                let chartHtml = `<div id="strategyBarChart" class="w-full h-[400px] plotly-chart"></div>`;

                let recommendationsHtml = `<h4 class="text-xl font-semibold mt-8 mb-3">Strategic Recommendations Summary</h4><ul class="list-disc list-inside space-y-2 text-white/80">`;
                recommendationsHtml += factorCounts['Strengths'] > factorCounts['Weaknesses'] ? "<li>Strong internal position - leverage strengths for growth.</li>" : "<li>Address internal weaknesses to improve competitive position.</li>";
                recommendationsHtml += factorCounts['Opportunities'] > factorCounts['Threats'] ? "<li>Favorable external environment - pursue growth opportunities.</li>" : "<li>Defensive strategy needed - mitigate external threats.</li>";
                recommendationsHtml += `</ul>`;

                container.innerHTML = metricsHtml + chartHtml + recommendationsHtml;
                
                const plotData = [{ x: Object.keys(strategyCounts), y: Object.values(strategyCounts), type: 'bar', marker: { color: Object.values(strategyCounts), colorscale: 'Viridis' } }];
                const layout = { title: 'Number of Strategies by Type', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: { title: 'Strategy Type', automargin: true }, yaxis: { title: 'Count', gridcolor: 'rgba(255,255,255,0.2)' }, margin: { t: 40, b: 60, l: 40, r: 20 }};
                Plotly.newPlot('strategyBarChart', plotData, layout, {responsive: true});
            }

            function renderGoalsAndInitiativesPage_SP(container, data) {
                container.innerHTML = '';
                const { main_objective, goals } = data;
                if (!main_objective || !goals) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete analysis data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="cascade"> Strategic Cascade</button><button class="analysis-tab-btn" data-tab="details"> Detailed Plan</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="cascadePanel" class="analysis-tab-panel active"></div><div id="detailsPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Populate Strategic Cascade Panel ---
                const cascadePanel = $('cascadePanel');
                let cascadeHtml = `<div class="cascade-container">
                    <div class="cascade-objective"><h3 class="text-lg font-bold text-indigo-300">OBJECTIVE</h3><p class="text-xl font-semibold">${main_objective}</p></div>
                    <div class="cascade-connector"></div>
                    <div class="cascade-goals-grid">`;

                goals.forEach(goal => {
                    cascadeHtml += `<div class="cascade-goal-card">
                        <div><h4 class="text-md font-bold text-red-300">GOAL</h4><p class="text-lg font-semibold">${goal.goal_name}</p></div>
                        <div class="space-y-3">`;
                    goal.strategies.forEach(strategy => {
                        cascadeHtml += `<div class="cascade-strategy">
                            <h5 class="text-sm font-bold text-yellow-300">STRATEGY</h5>
                            <p class="font-semibold">${strategy.strategy_name}</p>
                            <div class="mt-2 text-xs text-white/70">
                                <p><strong>Measures:</strong></p>
                                <ul class="list-disc list-inside ml-2">${strategy.measures.map(m => `<li>${m}</li>`).join('')}</ul>
                            </div>
                        </div>`;
                    });
                    cascadeHtml += `</div></div>`;
                });
                cascadeHtml += `</div></div>`;
                cascadePanel.innerHTML = cascadeHtml;

                // --- 2. Populate Detailed Plan Panel ---
                const detailsPanel = $('detailsPanel');
                // --- THIS IS THE CORRECTED LINE ---
                let detailsHtml = `<div class="p-4 space-y-6">
                    <div class="cascade-objective mx-auto"><h3 class="text-lg font-bold text-indigo-300">OBJECTIVE</h3><p class="text-xl font-semibold">${main_objective}</p></div>`;
                goals.forEach((goal, index) => {
                    detailsHtml += `<div class="cascade-goal-card">
                        <div><h4 class="text-md font-bold text-red-300">GOAL ${index + 1}</h4><p class="text-lg font-semibold">${goal.goal_name}</p></div>
                        <div class="space-y-3">`;
                    goal.strategies.forEach((strategy, s_index) => {
                        detailsHtml += `<div class="cascade-strategy">
                            <h5 class="text-sm font-bold text-yellow-300">STRATEGY ${index + 1}.${s_index + 1}</h5>
                            <p class="font-semibold">${strategy.strategy_name}</p>
                            <div class="mt-2 text-sm text-white/80">
                                <p><strong>Key Measures (KPIs):</strong></p>
                                <ul class="list-disc list-inside ml-4">${strategy.measures.map(m => `<li>${m}</li>`).join('')}</ul>
                            </div>
                        </div>`;
                    });
                    detailsHtml += `</div></div>`;
                });
                detailsHtml += `</div>`;
                detailsPanel.innerHTML = detailsHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); $(e.target.dataset.tab + 'Panel').classList.add('active'); } });
                $('analysisActions').classList.remove('hidden');
            }

            function renderNovelGoalsPage_NS(container, data) {
                container.innerHTML = '';
                const { main_goal, horizons } = data;
                if (!main_goal || !horizons || horizons.length !== 3) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="horizons"> Strategic Horizons</button><button class="analysis-tab-btn" data-tab="details"> Detailed Plan</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="horizonsPanel" class="analysis-tab-panel active"></div><div id="detailsPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Populate Horizons Visual Panel ---
                const horizonsPanel = $('horizonsPanel');
                let horizonsHtml = `<div class="horizons-container">
                    <div id="h3-circle" class="horizon-circle"><span class="horizon-label">Horizon 3</span></div>
                    <div id="h2-circle" class="horizon-circle"><span class="horizon-label">Horizon 2</span></div>
                    <div id="h1-circle" class="horizon-circle"><span class="horizon-label">Horizon 1</span></div>
                    <div class="main-goal-center">${main_goal}</div>`;
                
                let initiativeCount = 0;
                const totalInitiatives = horizons.flatMap(h => h.initiatives).length;

                horizons.forEach((horizon, hIndex) => {
                    horizon.initiatives.forEach(initiative => {
                        const angle = (Math.PI / 4) + (initiativeCount / totalInitiatives) * 2 * Math.PI; // Add offset
                        // --- THIS IS THE CORRECTED RADIUS LOGIC ---
                        const radius = 25 + (hIndex * 12); // H1 at 25%, H2 at 37%, H3 at 49%
                        const x = 50 + radius * Math.cos(angle);
                        const y = 50 + radius * Math.sin(angle);
                        horizonsHtml += `<div class="initiative-point" style="left: ${x}%; top: ${y}%; transform: translate(-50%, -50%);" title="${initiative.description}">${initiative.initiative_name}</div>`;
                        initiativeCount++;
                    });
                });
                horizonsHtml += `</div>`;
                horizonsPanel.innerHTML = horizonsHtml;

                // --- 2. Populate Detailed Plan Panel ---
                const detailsPanel = $('detailsPanel');
                let detailsHtml = `<div class="p-4 space-y-6">`;
                horizons.forEach(horizon => {
                    detailsHtml += `<div class="bg-white/10 p-6 rounded-lg">
                        <h3 class="text-2xl font-bold mb-1">${horizon.horizon_name}</h3>
                        <p class="text-sm text-indigo-300 font-semibold mb-2">${horizon.timeframe}</p>
                        <p class="text-sm italic text-white/80 mb-4">${horizon.focus}</p>
                        <table class="w-full text-left text-sm">
                            <thead><tr class="border-b border-white/20"><th class="p-2 w-1/3">Initiative</th><th class="p-2 w-2/3">Key Performance Indicators (KPIs)</th></tr></thead>
                            <tbody>`;
                    horizon.initiatives.forEach(initiative => {
                        detailsHtml += `<tr class="border-b border-white/10"><td class="p-2 font-semibold align-top">${initiative.initiative_name}</td><td class="p-2 align-top"><ul class="list-disc list-inside">${initiative.kpis.map(kpi => `<li>${kpi}</li>`).join('')}</ul></td></tr>`;
                    });
                    detailsHtml += `</tbody></table></div>`;
                });
                detailsHtml += `</div>`;
                detailsPanel.innerHTML = detailsHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); $(e.target.dataset.tab + 'Panel').classList.add('active'); } });
                $('analysisActions').classList.remove('hidden');
            }

            function renderRegressionPage_DA(container, data) {
                container.innerHTML = '';
                const { model_summary, variable_importance, coefficients, residuals_data, business_recommendations } = data;
                if (!model_summary || !coefficients) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button><button class="analysis-tab-btn" data-tab="fit"> Model Fit & Diagnostics</button><button class="analysis-tab-btn" data-tab="importance"> Variable Importance</button><button class="analysis-tab-btn" data-tab="coeffs"> Coefficient Details</button><button class="analysis-tab-btn" data-tab="rec"> Recommendations</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="dashboardPanel" class="analysis-tab-panel active"></div><div id="fitPanel" class="analysis-tab-panel"></div><div id="importancePanel" class="analysis-tab-panel"></div><div id="coeffsPanel" class="analysis-tab-panel"></div><div id="recPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Dashboard Panel ---
                const dashboardPanel = $('dashboardPanel');
                let dashboardHtml = `<div class="p-4">
                    <h3 class="text-2xl font-bold mb-4 text-center">Regression Dashboard</h3>
                    <div class="cascade-objective mb-6 text-center mx-auto"><h4 class="text-lg font-bold text-indigo-300">Regression Equation</h4><p class="text-xl font-semibold break-words">${model_summary.regression_equation}</p></div>
                    <blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 mb-8 max-w-4xl mx-auto">${model_summary.interpretation}</blockquote>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 max-w-2xl mx-auto">
                        <div class="kpi-card"><p class="kpi-name">R-Squared</p><p class="kpi-target">${model_summary.r_squared}</p></div>
                        <div class="kpi-card"><p class="kpi-name">Adj. R-Squared</p><p class="kpi-target">${model_summary.adj_r_squared}</p></div>
                    </div>
                </div>`;
                dashboardPanel.innerHTML = dashboardHtml;
                
                // --- 2. Model Fit & Diagnostics Panel ---
                const fitPanel = $('fitPanel');
                let fitHtml = `<div class="p-4">
                    <h3 class="text-2xl font-bold mb-6 text-center">Model Fit & Diagnostics</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto mb-8">
                        <div class="diagnostic-card"><div class="stat-value">${model_summary.f_statistic.toFixed(2)}</div><div class="stat-label">F-Statistic</div></div>
                        <div class="diagnostic-card"><div class="stat-value">${model_summary.prob_f_statistic.toFixed(3)}</div><div class="stat-label">Prob (F-Statistic)</div></div>
                    </div>
                    <blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 mb-8 max-w-4xl mx-auto">${residuals_data.interpretation}</blockquote>
                    <div id="residualsPlot" class="w-full h-[500px] plotly-chart"></div>
                </div>`;
                fitPanel.innerHTML = fitHtml;
                const residualsTrace = { x: residuals_data.predicted, y: residuals_data.residuals, mode: 'markers', type: 'scatter', name: 'Residuals' };
                const residualsLayout = { title: 'Residuals vs. Predicted Values', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: {title: 'Predicted Values', gridcolor: 'rgba(255,255,255,0.2)'}, yaxis: {title: 'Residuals', zerolinecolor: 'var(--accent)', zerolinewidth: 2, gridcolor: 'rgba(255,255,255,0.2)'} };
                Plotly.newPlot('residualsPlot', [residualsTrace], residualsLayout, {responsive: true});

                // --- 3. Variable Importance Panel ---
                const importancePanel = $('importancePanel');
                importancePanel.innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center">Variable Importance</h3><div id="importancePlot" class="w-full h-[500px] plotly-chart"></div></div>`;
                const importanceData = [...variable_importance].sort((a, b) => a.importance_score - b.importance_score);
                const importanceTrace = { y: importanceData.map(v => v.variable), x: importanceData.map(v => v.importance_score), type: 'bar', orientation: 'h', marker: { color: 'var(--primary)' } };
                const importanceLayout = { title: 'Relative Importance of Predictors', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, yaxis: {automargin: true}, xaxis: {title: 'Importance Score'} };
                Plotly.newPlot('importancePlot', [importanceTrace], importanceLayout, {responsive: true});

                // --- 4. Coefficient Details Panel ---
                const coeffsPanel = $('coeffsPanel');
                let coeffsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Coefficient Interpretation</h3><div class="space-y-4">`;
                coefficients.forEach(c => {
                    const isSignificant = c.p_value <= 0.05;
                    const borderColor = isSignificant ? 'border-green-400' : 'border-gray-500';
                    coeffsHtml += `<div class="bg-white/5 p-4 rounded-lg border-l-4 ${borderColor}"><h4 class="text-lg font-bold">${c.variable}</h4><div class="grid grid-cols-3 gap-2 text-sm mt-2 mb-3"><p><strong>Coefficient:</strong> ${c.coefficient.toFixed(4)}</p><p><strong>Std. Error:</strong> ${c.std_error.toFixed(4)}</p><p class="${isSignificant ? 'significant' : ''}"><strong>P-value:</strong> ${c.p_value.toFixed(3)} ${isSignificant ? '***' : ''}</p></div><p class="text-sm text-white/80 italic"><strong>Interpretation:</strong> ${c.interpretation}</p></div>`;
                });
                coeffsHtml += `</div><p class="text-xs text-white/60 mt-4">*** indicates statistical significance at p < 0.05</p></div>`;
                coeffsPanel.innerHTML = coeffsHtml;

                // --- 5. Recommendations Panel ---
                const recPanel = $('recPanel');
                let recHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Actionable Recommendations</h3><div class="space-y-6">`;
                business_recommendations.forEach(rec => {
                    recHtml += `<div class="cascade-goal-card"><h4 class="text-xl font-bold">${rec.recommendation}</h4><div class="cascade-strategy"><h5 class="text-sm font-bold text-yellow-300">Action Items</h5><ul class="list-disc list-inside mt-1 space-y-1 text-sm text-white/90">${rec.action_items.map(a => `<li>${a}</li>`).join('')}</ul></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div class="bg-black/20 p-3 rounded"><strong>Potential Risks:</strong> ${rec.potential_risks}</div><div class="bg-black/20 p-3 rounded"><strong>KPIs to Track:</strong> ${rec.kpis_to_track.join(', ')}</div></div></div>`;
                });
                recHtml += `</div></div>`;
                recPanel.innerHTML = recHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); const targetPanel = $(e.target.dataset.tab + 'Panel'); targetPanel.classList.add('active'); targetPanel.querySelectorAll('.plotly-chart').forEach(chart => Plotly.Plots.resize(chart)); } });
                $('analysisActions').classList.remove('hidden');
            }

            function renderLeveragePointsPage(container, data) {
                container.innerHTML = ''; // Clear the loading indicator
                const { gist, feedback_loops, leverage_points } = data;

                if (!gist || !feedback_loops || !leverage_points) {
                    container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete system analysis data received. Please try again.</div>`;
                    return;
                }

                // --- Create Tab Navigation ---
                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `
                    <button class="analysis-tab-btn active" data-tab="gist"> Gist</button>
                    <button class="analysis-tab-btn" data-tab="loops"> Feedback Loops</button>
                    <button class="analysis-tab-btn" data-tab="leverage"> Leverage Points</button>
                `;
                container.appendChild(tabNav);

                // --- Create Tab Panels ---
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `
                    <div id="gistPanel" class="analysis-tab-panel active"></div>
                    <div id="loopsPanel" class="analysis-tab-panel"></div>
                    <div id="leveragePanel" class="analysis-tab-panel"></div>
                `;

                // --- 1. Populate System Gist Panel ---
                const gistPanel = $('gistPanel');
                let gistHtml = `<h3 class="text-2xl font-bold mb-4">System Overview</h3>`;
                gistHtml += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="metric-card"><h4 class="font-bold">Key Elements</h4><p class="text-3xl font-bold">${gist.elements.length}</p></div>
                    <div class="metric-card"><h4 class="font-bold">Feedback Loops</h4><p class="text-3xl font-bold">2</p></div>
                    <div class="metric-card critical"><h4 class="font-bold">Leverage Points</h4><p class="text-3xl font-bold">${leverage_points.length}</p></div>
                </div>`;
                gistHtml += `<blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90 mb-6">"${gist.summary}"</blockquote>`;
                gistHtml += `<h4 class="text-xl font-semibold mb-3">System Elements</h4><div class="flex flex-wrap gap-2">`;
                gist.elements.forEach(el => {
                    const typeClass = el.type.toLowerCase() === 'stock' ? 'bg-blue-500/20 text-blue-300' : 'bg-purple-500/20 text-purple-300';
                    gistHtml += `<span class="px-3 py-1 rounded-full text-sm ${typeClass}">${el.name} <span class="text-xs opacity-70">(${el.type})</span></span>`;
                });
                gistHtml += `</div>`;
                gistPanel.innerHTML = gistHtml;

                // --- 2. Populate Feedback Loops Panel ---
                const loopsPanel = $('loopsPanel');
                let loopsHtml = `<h3 class="text-2xl font-bold mb-4">Identified Feedback Loops</h3><div class="space-y-4">`;
                const loops = [feedback_loops.reinforcing, feedback_loops.balancing];
                loops.forEach(loop => {
                    const isReinforcing = loop.type.toLowerCase() === 'reinforcing';
                    const loopIcon = isReinforcing ? ' R1:' : ' B1:';
                    const loopColor = isReinforcing ? 'border-green-400' : 'border-yellow-400';
                    loopsHtml += `<div class="bg-white/5 p-4 rounded-lg border-l-4 ${loopColor}">
                        <h4 class="text-lg font-bold">${loopIcon} ${loop.name} <span class="text-sm font-light text-white/70">(${loop.type})</span></h4>
                        <p class="text-sm text-white/80 my-2">${loop.description}</p>
                        <div class="text-xs text-white/60"><strong>Elements:</strong> ${loop.elements.join(', ')}</div>
                    </div>`;
                });
                loopsHtml += `</div>`;
                loopsPanel.innerHTML = loopsHtml;

                // --- 3. Populate Leverage Points Panel ---
                const leveragePanel = $('leveragePanel');
                let leverageHtml = `<h3 class="text-2xl font-bold mb-4">High-Impact Leverage Points</h3>
                <div class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6"> <strong>Focus here for maximum impact.</strong> Small, well-focused actions on these points can lead to significant, enduring improvements.</div>
                <div class="space-y-4">`;
                leverage_points.forEach(point => {
                    leverageHtml += `<div class="bg-white/5 p-4 rounded-lg border-l-4 border-indigo-400">
                        <h4 class="text-lg font-bold"> ${point.point}</h4>
                        <p class="text-sm text-white/80 mt-2"><strong>Recommended Intervention:</strong> ${point.intervention}</p>
                    </div>`;
                });
                leverageHtml += `</div>`;
                leveragePanel.innerHTML = leverageHtml;

                // --- Final Touches ---
                analysisCache[currentTemplateId] = container.innerHTML;

                tabNav.addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        const targetPanel = $(e.target.dataset.tab + 'Panel');
                        targetPanel.classList.add('active');
                    }
                });

                $('analysisActions').classList.remove('hidden');
            }

          function renderPlsPage_DA(container, data) {
                container.innerHTML = '';
                // Less strict check: only require the main 'data' object to exist.
                if (!data) { 
                    container.innerHTML = `<div class="p-4 text-center text-red-400">A valid analysis could not be generated from the provided data. Please check your inputs.</div>`; 
                    return; 
                }

                const { model_evaluation, path_coefficients, reliability_validity, visual_data, business_recommendations } = data;

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="diagram"> Path Model</button><button class="analysis-tab-btn" data-tab="paths"> Path Analysis</button><button class="analysis-tab-btn" data-tab="reliability"> Model Fit & Reliability</button><button class="analysis-tab-btn" data-tab="rec"> Recommendations</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="diagramPanel" class="analysis-tab-panel active"></div><div id="pathsPanel" class="analysis-tab-panel"></div><div id="reliabilityPanel" class="analysis-tab-panel"></div><div id="recPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Populate Path Diagram Panel ---
                const diagramPanel = $('diagramPanel');
                if (visual_data?.nodes && path_coefficients) {
                    const nodeIds = visual_data.nodes.map(n => n.id);
                    const sources = new Set(path_coefficients.map(p => p.path?.split(' -> ')[0]));
                    const targets = new Set(path_coefficients.map(p => p.path?.split(' -> ')[1]));
                    const exogenous = nodeIds.filter(id => sources.has(id) && !targets.has(id));
                    const endogenous = nodeIds.filter(id => targets.has(id) && !sources.has(id));
                    const mediating = nodeIds.filter(id => sources.has(id) && targets.has(id));

                    let diagramHtml = `<div class="path-flow-container">
                        <div class="path-column"><div class="path-column-title">Predictors</div>${exogenous.map(id => `<div class="path-node-card"><h4>${id}</h4></div>`).join('')}</div>
                        <div class="path-column"><div class="path-column-title">Mediators</div>${mediating.map(id => {
                            const influences = path_coefficients.filter(p => p.path?.endsWith(` -> ${id}`));
                            return `<div class="path-node-card"><h4>${id}</h4><div class="path-influence-list">Influenced by:<br>${influences.map(inf => {
                                const isSig = (inf.p_value ?? 1) < 0.05;
                                const coeff = (inf.coefficient ?? 0).toFixed(3);
                                return `<span class="path-influence ${isSig ? 'significant' : ''}"><strong>${inf.path?.split(' -> ')[0] ?? 'N/A'}</strong> (${coeff})${isSig ? '***' : ''}</span>`;
                            }).join('<br>')}</div></div>`;
                        }).join('')}</div>
                        <div class="path-column"><div class="path-column-title">Outcomes</div>${endogenous.map(id => {
                            const influences = path_coefficients.filter(p => p.path?.endsWith(` -> ${id}`));
                            return `<div class="path-node-card"><h4>${id}</h4><div class="path-influence-list">Influenced by:<br>${influences.map(inf => {
                                const isSig = (inf.p_value ?? 1) < 0.05;
                                const coeff = (inf.coefficient ?? 0).toFixed(3);
                                return `<span class="path-influence ${isSig ? 'significant' : ''}"><strong>${inf.path?.split(' -> ')[0] ?? 'N/A'}</strong> (${coeff})${isSig ? '***' : ''}</span>`;
                            }).join('<br>')}</div></div>`;
                        }).join('')}</div>
                    </div>`;
                    diagramPanel.innerHTML = diagramHtml;
                } else {
                    diagramPanel.innerHTML = `<div class="p-4 text-center text-white/60">Path model could not be rendered.</div>`;
                }

                // --- 2. Populate Path Analysis Panel ---
                const pathsPanel = $('pathsPanel');
                if (path_coefficients) {
                    let pathsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Structural Model - Path Coefficients</h3><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>Path</th><th>Coefficient</th><th>T-Statistic</th><th>P-value</th></tr></thead><tbody>`;
                    path_coefficients.forEach(p => {
                        const isSignificant = (p.p_value ?? 1) < 0.05;
                        pathsHtml += `<tr class="${isSignificant ? 'significant' : ''}"><td>${p.path || 'N/A'}</td><td>${(p.coefficient ?? 0).toFixed(3)}</td><td>${(p.t_statistic ?? 0).toFixed(2)}</td><td>${(p.p_value ?? 1).toFixed(3)} ${isSignificant ? '***' : ''}</td></tr>`;
                    });
                    pathsHtml += `</tbody></table></div><div class="p-4 mt-4 space-y-4">`;
                    path_coefficients.forEach(p => { pathsHtml += `<div class="bg-white/5 p-3 rounded-lg"><p class="font-bold">${p.path || 'N/A'}</p><p class="text-sm text-white/80 italic">${p.interpretation || 'No interpretation provided.'}</p></div>`; });
                    pathsHtml += `</div></div>`;
                    pathsPanel.innerHTML = pathsHtml;
                } else {
                    pathsPanel.innerHTML = `<div class="p-4 text-center text-white/60">Path coefficient data is not available.</div>`;
                }

                // --- 3. Populate Reliability Panel ---
                const reliabilityPanel = $('reliabilityPanel');
                if (reliability_validity && model_evaluation) {
                    let reliabilityHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Model Fit & Reliability</h3><p class="text-white/80 italic mb-6">${model_evaluation.interpretation || ''}</p><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>Construct</th><th>Cronbach's Alpha</th><th>Composite Reliability (CR)</th><th>Avg. Variance Extracted (AVE)</th></tr></thead><tbody>`;
                    reliability_validity.forEach(r => {
                        reliabilityHtml += `<tr><td>${r.construct || 'N/A'}</td><td>${(r.cronbachs_alpha ?? 0).toFixed(3)}</td><td>${(r.composite_reliability ?? 0).toFixed(3)}</td><td>${(r.ave ?? 0).toFixed(3)}</td></tr>`;
                    });
                    reliabilityHtml += `</tbody></table><p class="text-xs text-white/60 mt-4">Common thresholds: Cronbach's Alpha > 0.7, CR > 0.7, AVE > 0.5</p></div></div>`;
                    reliabilityPanel.innerHTML = reliabilityHtml;
                } else {
                    reliabilityPanel.innerHTML = `<div class="p-4 text-center text-white/60">Model reliability data is not available.</div>`;
                }

                // --- 4. Populate Recommendations Panel ---
                const recPanel = $('recPanel');
                if (business_recommendations) {
                    let recHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Actionable Recommendations</h3><div class="space-y-6">`;
                    business_recommendations.forEach(rec => {
                        recHtml += `<div class="cascade-goal-card">
                            <h4 class="text-xl font-bold">${rec.recommendation || ''}</h4>
                            <p class="text-sm text-white/80 italic p-2 bg-black/20 rounded"><strong>Insight:</strong> ${rec.insight || ''}</p>
                            <div class="cascade-strategy">
                                <h5 class="text-sm font-bold text-yellow-300">Action Items</h5>
                                <ul class="list-disc list-inside mt-1 space-y-1 text-sm text-white/90">${(rec.action_items || []).map(a => `<li>${a}</li>`).join('')}</ul>
                            </div>
                            <div class="bg-black/20 p-3 rounded text-sm"><strong>KPIs to Track:</strong> ${(rec.kpis_to_track || []).join(', ')}</div>
                        </div>`;
                    });
                    recHtml += `</div></div>`;
                    recPanel.innerHTML = recHtml;
                } else {
                    recPanel.innerHTML = `<div class="p-4 text-center text-white/60">Business recommendations are not available.</div>`;
                }

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); $(e.target.dataset.tab + 'Panel').classList.add('active'); } });
                $('analysisActions').classList.remove('hidden');
            }

            function renderDescriptivePage_DA(container, data) {
                container.innerHTML = '';
                const { summary, numerical_summary, categorical_summary, visualizations, business_insights } = data;
                if (!summary || !numerical_summary) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="summary"> Summary</button><button class="analysis-tab-btn" data-tab="stats"> Statistics</button><button class="analysis-tab-btn" data-tab="visuals"> Visualizations</button><button class="analysis-tab-btn" data-tab="insights"> Insights</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="summaryPanel" class="analysis-tab-panel active"></div><div id="statsPanel" class="analysis-tab-panel"></div><div id="visualsPanel" class="analysis-tab-panel"></div><div id="insightsPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Populate Summary Panel ---
                const summaryPanel = $('summaryPanel');
                summaryPanel.innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-6 text-center">Dataset Overview</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-lg mx-auto mb-8"><div class="summary-stat-card"><div class="stat-value">${summary.rows}</div><div class="stat-label">Rows</div></div><div class="summary-stat-card"><div class="stat-value">${summary.columns}</div><div class="stat-label">Columns</div></div></div><blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90">${summary.interpretation}</blockquote></div>`;

                // --- 2. Populate Statistics Panel ---
                const statsPanel = $('statsPanel');
                let statsHtml = `<div class="p-4 space-y-8"><h3 class="text-2xl font-bold mb-4">Numerical Variable Summary</h3><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>Variable</th><th>Mean</th><th>Median</th><th>Std. Dev.</th><th>Min</th><th>Max</th></tr></thead><tbody>`;
                numerical_summary.forEach(n => { statsHtml += `<tr><td>${n.variable}</td><td>${n.mean.toFixed(2)}</td><td>${n.median.toFixed(2)}</td><td>${n.std_dev.toFixed(2)}</td><td>${n.min.toFixed(2)}</td><td>${n.max.toFixed(2)}</td></tr>`; });
                statsHtml += `</tbody></table></div>`;
                categorical_summary.forEach(c => { statsHtml += `<h3 class="text-2xl font-bold mt-8 mb-4">${c.variable} Frequencies</h3><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>Category</th><th>Count</th><th>Percentage</th></tr></thead><tbody>`; c.frequencies.forEach(f => { statsHtml += `<tr><td>${f.category}</td><td>${f.count}</td><td>${f.percentage.toFixed(1)}%</td></tr>`; }); statsHtml += `</tbody></table></div>`; });
                statsHtml += `</div>`;
                statsPanel.innerHTML = statsHtml;

                // --- 3. Populate Visualizations Panel (with centering) ---
                const visualsPanel = $('visualsPanel');
                let visualsHtml = `<div class="p-4 flex justify-center"><div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full max-w-7xl">`;
                visualizations.forEach((viz, index) => { visualsHtml += `<div id="viz-chart-${index}" class="w-full h-[500px] plotly-chart"></div>`; });
                visualsHtml += `</div></div>`;
                visualsPanel.innerHTML = visualsHtml;

                visualizations.forEach((viz, index) => {
                    const chartContainer = $(`viz-chart-${index}`);
                    if (viz.chart_type === 'histogram') {
                        const trace = { x: viz.data, type: 'histogram', marker: { color: 'var(--primary)' } };
                        const layout = { title: viz.title, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis:{title: viz.variable}, yaxis:{title:'Frequency'} };
                        Plotly.newPlot(chartContainer, [trace], layout, {responsive: true});
                    } else if (viz.chart_type === 'bar') {
                        const trace = { x: Object.keys(viz.data), y: Object.values(viz.data), type: 'bar', marker: { color: 'var(--primary)' } };
                        const layout = { title: viz.title, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis:{title: viz.variable}, yaxis:{title:'Count'} };
                        Plotly.newPlot(chartContainer, [trace], layout, {responsive: true});
                    }
                });

                // --- 4. Populate Insights Panel ---
                const insightsPanel = $('insightsPanel');
                let insightsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Actionable Business Insights</h3><ul class="list-disc list-inside space-y-4 text-white/90">`;
                business_insights.forEach(insight => { insightsHtml += `<li>${insight}</li>`; });
                insightsHtml += `</ul></div>`;
                insightsPanel.innerHTML = insightsHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); const targetPanel = $(e.target.dataset.tab + 'Panel'); targetPanel.classList.add('active'); targetPanel.querySelectorAll('.plotly-chart').forEach(chart => Plotly.Plots.resize(chart)); } });
                $('analysisActions').classList.remove('hidden');
            }

            function renderPrescriptivePage_DA(container, data) {
                container.innerHTML = '';
                const { main_goal, data_insights, prescriptions } = data;
                if (!main_goal || !data_insights || !prescriptions) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="dashboard"> Dashboard</button><button class="analysis-tab-btn" data-tab="prescriptions"> Prescriptions</button><button class="analysis-tab-btn" data-tab="insights"> Data Insights</button><button class="analysis-tab-btn" data-tab="matrix"> Prioritization Matrix</button><button class="analysis-tab-btn" data-tab="kpis"> KPI Tracker</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="dashboardPanel" class="analysis-tab-panel active"></div><div id="prescriptionsPanel" class="analysis-tab-panel"></div><div id="insightsPanel" class="analysis-tab-panel"></div><div id="matrixPanel" class="analysis-tab-panel"></div><div id="kpisPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Populate Dashboard Panel ---
                const dashboardPanel = $('dashboardPanel');
                let dashboardHtml = `<div class="p-4">
                    <div class="p-6 rounded-lg bg-white/10 border border-white/20 text-center mb-8">
                        <h3 class="text-xl font-bold mb-2 text-indigo-300"> Business Goal</h3>
                        <p class="text-2xl italic text-white/90">${main_goal}</p>
                    </div>
                    <h3 class="text-2xl font-bold text-center mb-4">Recommended Prescriptions</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                prescriptions.forEach(p => {
                    dashboardHtml += `<div class="dashboard-prescription-card">
                        <h4 class="text-xl font-bold mb-2">${p.recommendation}</h4>
                        <p class="text-sm text-white/70 mb-4"><strong>Impact:</strong> ${p.impact} | <strong>Effort:</strong> ${p.effort}</p>
                        <p class="font-semibold text-indigo-300">${p.expected_outcome}</p>
                    </div>`;
                });
                dashboardHtml += `</div></div>`;
                dashboardPanel.innerHTML = dashboardHtml;
                
                // --- 2. Populate Prescriptions Panel ---
                const prescriptionsPanel = $('prescriptionsPanel');
                let prescriptionsHtml = `<div class="p-4">`;
                prescriptions.forEach(p => {
                    prescriptionsHtml += `<div class="prescription-card">
                        <h4>${p.recommendation}</h4>
                        <p class="rationale"><strong>Rationale:</strong> ${p.rationale}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                            <div class="bg-black/20 p-3 rounded"><h5 class="font-bold text-yellow-300 mb-2">Action Items</h5><ul class="list-disc list-inside space-y-1">${p.action_items.map(a => `<li>${a}</li>`).join('')}</ul></div>
                            <div class="bg-black/20 p-3 rounded"><h5 class="font-bold text-yellow-300 mb-2">Expected Outcome</h5><p>${p.expected_outcome}</p><h5 class="font-bold text-yellow-300 mt-4 mb-2">KPIs to Track</h5><p>${p.kpis_to_track.join(', ')}</p></div>
                        </div>
                    </div>`;
                });
                prescriptionsHtml += `</div>`;
                prescriptionsPanel.innerHTML = prescriptionsHtml;

                // --- 3. Populate Insights Panel ---
                const insightsPanel = $('insightsPanel');
                let insightsHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Key Data Insights</h3>`;
                data_insights.forEach(i => {
                    insightsHtml += `<div class="insight-card">
                        <h4 class="text-lg font-bold text-indigo-300">Insight:</h4>
                        <p class="text-white/90 mb-3">${i.insight}</p>
                        <h4 class="text-lg font-bold text-indigo-300">Business Implication:</h4>
                        <p class="text-white/90">${i.implication}</p>
                    </div>`;
                });
                insightsHtml += `</div>`;
                insightsPanel.innerHTML = insightsHtml;

                // --- 4. Populate Prioritization Matrix Panel ---
                const matrixPanel = $('matrixPanel');
                matrixPanel.innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold mb-4 text-center">Prioritization Matrix</h3><div id="matrixPlot" class="w-full h-[600px] plotly-chart"></div></div>`;
                const impactMap = { 'Low': 1, 'Medium': 2, 'High': 3 };
                const effortMap = { 'Low': 1, 'Medium': 2, 'High': 3 };
                const matrixData = {
                    x: prescriptions.map(p => effortMap[p.effort] || 1),
                    y: prescriptions.map(p => impactMap[p.impact] || 1),
                    text: prescriptions.map(p => p.recommendation),
                    mode: 'markers+text',
                    textposition: 'top center',
                    marker: { size: 20, color: 'var(--primary)' }
                };
                const matrixLayout = {
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' },
                    xaxis: { title: 'Effort', range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ['Low', 'Medium', 'High'], gridcolor: 'rgba(255,255,255,0.2)' },
                    yaxis: { title: 'Impact', range: [0.5, 3.5], tickvals: [1, 2, 3], ticktext: ['Low', 'Medium', 'High'], gridcolor: 'rgba(255,255,255,0.2)' },
                    shapes: [ // Quadrant lines
                        { type: 'line', x0: 2, y0: 0.5, x1: 2, y1: 3.5, line: { color: 'rgba(255,255,255,0.3)', width: 2, dash: 'dash' } },
                        { type: 'line', x0: 0.5, y0: 2, x1: 3.5, y1: 2, line: { color: 'rgba(255,255,255,0.3)', width: 2, dash: 'dash' } }
                    ],
                    annotations: [
                        {x: 1, y: 3, text: 'Quick Wins', showarrow: false, font: {size: 16, color: 'rgba(255,255,255,0.5)'}},
                        {x: 3, y: 3, text: 'Major Projects', showarrow: false, font: {size: 16, color: 'rgba(255,255,255,0.5)'}},
                        {x: 1, y: 1, text: 'Fill-ins', showarrow: false, font: {size: 16, color: 'rgba(255,255,255,0.5)'}},
                        {x: 3, y: 1, text: 'Thankless Tasks', showarrow: false, font: {size: 16, color: 'rgba(255,255,255,0.5)'}},
                    ]
                };
                Plotly.newPlot('matrixPlot', [matrixData], matrixLayout, {responsive: true});

                // --- 5. Populate KPI Tracker Panel ---
                const kpisPanel = $('kpisPanel');
                let kpisHtml = `<div class="p-4"><h3 class="text-2xl font-bold mb-4">Consolidated KPI Tracker</h3><div class="overflow-x-auto"><table class="coeff-table"><thead><tr><th>KPI to Track</th><th>Related Prescription</th></tr></thead><tbody>`;
                prescriptions.forEach(p => {
                    p.kpis_to_track.forEach(kpi => { kpisHtml += `<tr><td>${kpi}</td><td>${p.recommendation}</td></tr>`; });
                });
                kpisHtml += `</tbody></table></div></div>`;
                kpisPanel.innerHTML = kpisHtml;


                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); const targetPanel = $(e.target.dataset.tab + 'Panel'); targetPanel.classList.add('active'); const chart = targetPanel.querySelector('.plotly-chart'); if (chart) { Plotly.Plots.resize(chart); } } });
                $('analysisActions').classList.remove('hidden');
            }

            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const header = lines[0].split(',').map(h => h.trim());
                const rows = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length === header.length) {
                        const row = {};
                        for (let j = 0; j < header.length; j++) {
                            const value = values[j];
                            // Attempt to convert to number if possible
                            const numValue = parseFloat(value);
                            row[header[j]] = isNaN(numValue) ? value : numValue;
                        }
                        rows.push(row);
                    }
                }
                return { header, rows };
            }

            function renderSwotVisualization(swotData, containerId) {
                const container = $(containerId);
                const quadrants = [ { title: 'Strengths', data: swotData.strengths, color: '#2E8B57', icon: '' }, { title: 'Weaknesses', data: swotData.weaknesses, color: '#CD5C5C', icon: '' }, { title: 'Opportunities', data: swotData.opportunities, color: '#4169E1', icon: '' }, { title: 'Threats', data: swotData.threats, color: '#FF8C00', icon: '' }];
                let gridHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                quadrants.forEach(q => {
                    const itemsHtml = q.data && q.data.length > 0 ? q.data.map(item => `<li>${item}</li>`).join('') : '<li>No items identified.</li>';
                    gridHtml += `<div class="bg-white/5 rounded-lg p-4 border-t-4" style="border-top-color: ${q.color};"><h3 class="text-lg font-bold text-center mb-3" style="color: ${q.color};">${q.icon} ${q.title}</h3><ul class="list-disc list-inside space-y-2 text-white/80 text-sm">${itemsHtml}</ul></div>`;
                });
                gridHtml += '</div>';
                container.innerHTML = gridHtml;
            }

            function renderActionPlansPage_AP(container, data) {
                container.innerHTML = '';
                const { project_name, action_items } = data;
                if (!project_name || !action_items) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="timeline"> Task Timeline</button><button class="analysis-tab-btn" data-tab="details"> Detailed Task List</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="timelinePanel" class="analysis-tab-panel active"></div><div id="detailsPanel" class="analysis-tab-panel"></div>`;

                // --- 1. Populate Timeline Panel ---
                const timelinePanel = $('timelinePanel');
                let timelineHtml = `<h2 class="text-3xl font-bold text-center mb-8">${project_name}</h2><div class="action-plan-container flex flex-col items-center">`;
                action_items.forEach(item => {
                    const priorityClass = `priority-${item.priority.toLowerCase()}`;
                    timelineHtml += `
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content ${priorityClass}">
                                <p class="text-xs text-indigo-300 font-semibold">${item.timeline}</p>
                                <h4 class="text-lg font-bold">${item.task_name}</h4>
                                <p class="text-sm text-white/70"><strong>Owner:</strong> ${item.owner}</p>
                            </div>
                        </div>
                    `;
                });
                timelineHtml += `</div>`;
                timelinePanel.innerHTML = timelineHtml;

                // --- 2. Populate Detailed List Panel ---
                const detailsPanel = $('detailsPanel');
                let detailsHtml = `<div class="p-4"><h2 class="text-3xl font-bold mb-6">${project_name}</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-white/20"><th class="p-2">Task</th><th class="p-2">Description</th><th class="p-2">Owner</th><th class="p-2">Timeline</th><th class="p-2">Priority</th></tr></thead><tbody>`;
                action_items.forEach(item => {
                    detailsHtml += `<tr class="border-b border-white/10">
                        <td class="p-2 font-semibold">${item.task_name}</td>
                        <td class="p-2 text-sm text-white/80">${item.description}</td>
                        <td class="p-2">${item.owner}</td>
                        <td class="p-2">${item.timeline}</td>
                        <td class="p-2"><span class="font-bold text-${item.priority === 'High' ? 'red' : item.priority === 'Medium' ? 'yellow' : 'blue'}-400">${item.priority}</span></td>
                    </tr>`;
                });
                detailsHtml += `</tbody></table></div></div>`;
                detailsPanel.innerHTML = detailsHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); $(e.target.dataset.tab + 'Panel').classList.add('active'); } });
                $('analysisActions').classList.remove('hidden');
            }

            function renderTowsVisualization(towsData, containerId) {
                const container = $(containerId);
                const quadrants = [ { title: 'SO Strategies (Maxi-Maxi)', data: towsData.SO_strategies, color: '#32CD32', icon: '' }, { title: 'WO Strategies (Mini-Maxi)', data: towsData.WO_strategies, color: '#FFD700', icon: '' }, { title: 'ST Strategies (Maxi-Mini)', data: towsData.ST_strategies, color: '#87CEEB', icon: '' }, { title: 'WT Strategies (Mini-Mini)', data: towsData.WT_strategies, color: '#DDA0DD', icon: '' }];
                let gridHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                quadrants.forEach(q => {
                    const itemsHtml = q.data && q.data.length > 0 ? q.data.map(item => `<li>${item}</li>`).join('') : '<li>No strategies generated.</li>';
                    gridHtml += `<div class="bg-white/5 rounded-lg p-4 border-t-4" style="border-top-color: ${q.color};"><h3 class="text-lg font-bold text-center mb-3" style="color: ${q.color};">${q.icon} ${q.title}</h3><ul class="list-disc list-inside space-y-2 text-white/80 text-sm">${itemsHtml}</ul></div>`;
                });
                gridHtml += '</div>';
                container.innerHTML = gridHtml;
            }

            function render8020Visualization(insightsData, containerId) {
                const container = $(containerId);
                container.innerHTML = `
                    <div class="p-4 space-y-8">
                        <div class="p-6 rounded-lg bg-white/10 border border-white/20"><h3 class="text-2xl font-bold mb-4 text-center text-indigo-300"> Strategic Focus</h3><p class="text-center text-lg italic text-white/90">${insightsData.strategic_focus || 'Not defined.'}</p></div>
                        <div class="grid md:grid-cols-2 gap-8">
                            <div class="p-4 rounded-lg bg-white/5"><h4 class="text-xl font-semibold mb-3 text-center"> Key Strategies (Top 20%)</h4><ul class="space-y-3 list-disc list-inside text-white/80">${(insightsData.key_strategies || []).map(s => `<li>${s}</li>`).join('')}</ul></div>
                            <div class="p-4 rounded-lg bg-white/5"><h4 class="text-xl font-semibold mb-3 text-center"> Critical Factors (Top 20%)</h4><ul class="space-y-3 list-disc list-inside text-white/80">${(insightsData.critical_factors || []).map(f => `<li>${f}</li>`).join('')}</ul></div>
                        </div>
                        <div class="p-6 rounded-lg bg-white/10 border border-white/20"><h4 class="text-xl font-semibold mb-3 text-center"> Priority Actions</h4><ol class="space-y-3 list-decimal list-inside text-white/90 text-center">${(insightsData.priority_actions || []).map(a => `<li>${a}</li>`).join('')}</ol></div>
                    </div>`;
            }

            function renderSystemGoalsPage(container, data) {
                container.innerHTML = ''; // Clear loading
                const { system_goal, key_loops, strategic_initiatives } = data;

                if (!system_goal || !key_loops || !strategic_initiatives) {
                    container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete analysis data received.</div>`;
                    return;
                }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `
                    <button class="analysis-tab-btn active" data-tab="map"> Strategic Map</button>
                    <button class="analysis-tab-btn" data-tab="dashboard"> Dashboard</button>
                    <button class="analysis-tab-btn" data-tab="initiatives"> Initiatives & Objectives</button>
                `;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `
                    <div id="mapPanel" class="analysis-tab-panel active"></div>
                    <div id="dashboardPanel" class="analysis-tab-panel"></div>
                    <div id="initiativesPanel" class="analysis-tab-panel"></div>
                `;

                // --- 1. Populate Strategic Map Panel ---
                const mapPanel = $('mapPanel');
                let mapHtml = `<div class="strategy-map-container p-4">
                    <div class="p-4 rounded-lg bg-white/10 border border-white/20 text-center w-full max-w-lg">
                        <h3 class="text-lg font-bold text-indigo-300"> GOAL</h3>
                        <p class="text-2xl italic text-white/90">${system_goal}</p>
                    </div>
                    <div class="vertical-connector"></div>
                    <div class="feedback-loops-grid">
                        <div id="reinforcing-box" class="bg-white/5 p-4 rounded-lg border-2 border-green-400/50 text-center flex flex-col justify-between h-full">
                            <h4 class="text-lg font-bold"> Growth Engine</h4>
                            <p class="text-sm text-white/80 my-2">${key_loops.reinforcing_loop}</p>
                        </div>
                        <div id="balancing-box" class="bg-white/5 p-4 rounded-lg border-2 border-yellow-400/50 text-center flex flex-col justify-between h-full">
                            <h4 class="text-lg font-bold"> Limiting Factor</h4>
                            <p class="text-sm text-white/80 my-2">${key_loops.balancing_loop}</p>
                        </div>
                    </div>
                    <div class="lines-to-interventions">
                        <h3 class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold text-white z-10 bg-gray-900 px-4 py-2 rounded">Strategic Interventions</h3>
                    </div>
                    <div class="grid md:grid-cols-${strategic_initiatives.length} gap-8 w-full max-w-4xl mt-4">`; // Increased max-width for initiatives

                strategic_initiatives.forEach(initiative => {
                    const strengthensReinforcing = /strengthens|boosts|enhances/i.test(initiative.rationale);
                    const weakensBalancing = /weakens|addresses|mitigates|reduces/i.test(initiative.rationale);
                    
                    let indicatorHtml = '';
                    if (strengthensReinforcing && weakensBalancing) {
                        indicatorHtml = `<div class="initiative-target-indicator flex items-center justify-center gap-1">
                                            <span class="indicator-boost"></span><span class="indicator-mitigate"></span>
                                         </div>`;
                    } else if (strengthensReinforcing) {
                        indicatorHtml = `<div class="initiative-target-indicator indicator-boost"></div>`;
                    } else if (weakensBalancing) {
                        indicatorHtml = `<div class="initiative-target-indicator indicator-mitigate"></div>`;
                    }

                    mapHtml += `<div class="relative pt-8">
                        ${indicatorHtml}
                        <div class="bg-white/10 p-4 rounded-lg h-full border border-white/10 flex items-center justify-center text-center">
                            <h4 class="text-lg font-bold text-white/90">${initiative.initiative_name}</h4>
                        </div>
                    </div>`;
                });

                mapHtml += `</div></div>`;
                mapPanel.innerHTML = mapHtml;

                // --- 2. Populate Dashboard Panel ---
                const dashboardPanel = $('dashboardPanel');
                let dashboardHtml = `<div class="p-4 space-y-8">
                    <div class="p-6 rounded-lg bg-white/10 border border-white/20 text-center">
                        <h3 class="text-xl font-bold mb-2 text-indigo-300"> Overarching System Goal</h3>
                        <p class="text-2xl italic text-white/90">${system_goal}</p>
                    </div>
                    <h3 class="text-2xl font-bold text-center">Key System Dynamics</h3>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-white/5 p-4 rounded-lg border-l-4 border-green-400">
                            <h4 class="text-lg font-bold"> Reinforcing Loop (Growth Engine)</h4>
                            <p class="text-sm text-white/80 my-2">${key_loops.reinforcing_loop}</p>
                        </div>
                        <div class="bg-white/5 p-4 rounded-lg border-l-4 border-yellow-400">
                            <h4 class="text-lg font-bold"> Balancing Loop (Limiting Factor)</h4>
                            <p class="text-sm text-white/80 my-2">${key_loops.balancing_loop}</p>
                        </div>
                    </div>
                </div>`;
                dashboardPanel.innerHTML = dashboardHtml;

                // --- 3. Populate Initiatives Panel ---
                const initiativesPanel = $('initiativesPanel');
                let initiativesHtml = `<div class="p-4 space-y-6">`;
                strategic_initiatives.forEach((initiative, index) => {
                    initiativesHtml += `
                        <div class="bg-white/10 p-6 rounded-lg">
                            <h3 class="text-2xl font-bold mb-2">Initiative ${index + 1}: ${initiative.initiative_name}</h3>
                            <div class="p-3 my-3 rounded-lg bg-black/20 text-sm text-white/80 italic">
                                <strong>Systems Rationale:</strong> ${initiative.rationale}
                            </div>
                            <h4 class="text-lg font-semibold mt-4 mb-2">Specific Objectives:</h4>
                            <ol class="list-decimal list-inside space-y-2 text-white/90">
                                ${initiative.objectives.map(obj => `<li>${obj}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                });
                initiativesHtml += `</div>`;
                initiativesPanel.innerHTML = initiativesHtml;

                // --- Final Touches ---
                analysisCache[currentTemplateId] = container.innerHTML;

                tabNav.addEventListener('click', e => {
                    if(e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        $(e.target.dataset.tab + 'Panel').classList.add('active');
                    }
                });
                $('analysisActions').classList.remove('hidden');
            }

            function renderMiscPage_MSC(container, data) {
                container.innerHTML = '';
                const { executive_summary, risk_assessment, governance, conclusion } = data;
                if (!executive_summary || !risk_assessment || !governance || !conclusion) { container.innerHTML = `<div class="p-4 text-center text-red-400">Incomplete data received.</div>`; return; }

                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="summary"> Executive Summary</button><button class="analysis-tab-btn" data-tab="risks"> Risk Assessment</button><button class="analysis-tab-btn" data-tab="gov"> Governance</button><button class="analysis-tab-btn" data-tab="conclusion"> Conclusion</button>`;
                container.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="summaryPanel" class="analysis-tab-panel active"></div><div id="risksPanel" class="analysis-tab-panel"></div><div id="govPanel" class="analysis-tab-panel"></div><div id="conclusionPanel" class="analysis-tab-panel"></div>`;

                // --- Populate Panels ---
                $('summaryPanel').innerHTML = `<div class="p-4"><blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90">${executive_summary}</blockquote></div>`;
                $('conclusionPanel').innerHTML = `<div class="p-4"><blockquote class="p-4 italic border-l-4 border-gray-500 bg-gray-800 text-white/90">${conclusion}</blockquote></div>`;
                
                let risksHtml = `<div class="p-4 overflow-x-auto"><table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-white/20">
                            <th class="p-2">Risk Description</th>
                            <th class="p-2 text-center">Impact</th>
                            <th class="p-2 text-center">Likelihood</th>
                            <th class="p-2">Mitigation Strategy</th>
                        </tr>
                    </thead>
                    <tbody>`;
                risk_assessment.forEach(item => {
                    const impactClass = `risk-level-${(item.impact || 'low').toLowerCase()}`;
                    const likelihoodClass = `risk-level-${(item.likelihood || 'low').toLowerCase()}`;
                    risksHtml += `<tr class="border-b border-white/10">
                        <td class="p-2">${item.risk}</td>
                        <td class="p-2 text-center"><span class="risk-pill ${impactClass}">${item.impact}</span></td>
                        <td class="p-2 text-center"><span class="risk-pill ${likelihoodClass}">${item.likelihood}</span></td>
                        <td class="p-2 text-sm text-white/80">${item.mitigation}</td>
                    </tr>`;
                });
                risksHtml += `</tbody></table></div>`;
                $('risksPanel').innerHTML = risksHtml;

                let govHtml = `<div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">`;
                governance.forEach(item => {
                    govHtml += `<div class="governance-card">
                        <h4 class="text-xl font-bold mb-3">${item.stakeholder}</h4>
                        <p class="text-sm font-semibold text-white/80 mb-2">Key Responsibilities:</p>
                        <ul class="list-disc list-inside space-y-1 text-sm">${item.responsibilities.map(r => `<li>${r}</li>`).join('')}</ul>
                    </div>`;
                });
                govHtml += `</div>`;
                $('govPanel').innerHTML = govHtml;

                analysisCache[currentTemplateId] = container.innerHTML;
                tabNav.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active')); tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active')); e.target.classList.add('active'); $(e.target.dataset.tab + 'Panel').classList.add('active'); } });
                $('analysisActions').classList.remove('hidden');
            }
            
            function renderArchetypeAnalysisPage(container, data) {
                container.innerHTML = '';
                const { concepts, topArchetypes, topLeveragePoints } = data;
                const tabNav = document.createElement('div');
                tabNav.className = 'flex flex-wrap border-b border-white/20 -mx-6 px-6';
                tabNav.innerHTML = `<button class="analysis-tab-btn active" data-tab="concepts"> Concepts</button><button class="analysis-tab-btn" data-tab="network"> Network</button><button class="analysis-tab-btn" data-tab="archetypes"> Archetypes</button><button class="analysis-tab-btn" data-tab="leverage"> Leverage Points</button>`;
                container.appendChild(tabNav);
                const tabContent = document.createElement('div');
                container.appendChild(tabContent);
                tabContent.innerHTML = `<div id="conceptsPanel" class="analysis-tab-panel active"></div><div id="networkPanel" class="analysis-tab-panel"></div><div id="archetypesPanel" class="analysis-tab-panel"></div><div id="leveragePanel" class="analysis-tab-panel"></div>`;
                renderConceptsTab(concepts, 'conceptsPanel');
                renderNetworkTab(concepts, 'networkPanel');
                renderArchetypesTab(topArchetypes, 'archetypesPanel');
                renderLeveragePointsTab(topLeveragePoints, 'leveragePanel');
                
                analysisCache[currentTemplateId] = container.innerHTML;

                tabNav.addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                        tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                        e.target.classList.add('active');
                        const targetPanel = $(e.target.dataset.tab + 'Panel');
                        targetPanel.classList.add('active');
                        const chart = targetPanel.querySelector('.plotly-chart');
                        if (chart) Plotly.Plots.resize(chart);
                    }
                });
            }

            function renderConceptsTab(concepts, containerId) {
                const container = $(containerId);
                const positiveCount = concepts.filter(c => c.effect === '+').length;
                const negativeCount = concepts.filter(c => c.effect === '-').length;
                const neutralCount = concepts.filter(c => c.effect === '0').length;
                let tableHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><div class="metric-card"><h4 class="font-bold">Positive Effects</h4><p class="text-3xl font-bold">${positiveCount}</p></div><div class="metric-card"><h4 class="font-bold">Negative Effects</h4><p class="text-3xl font-bold">${negativeCount}</p></div><div class="metric-card"><h4 class="font-bold">Neutral Effects</h4><p class="text-3xl font-bold">${neutralCount}</p></div></div><div id="effectPieChart" class="w-full h-[400px] mb-8 plotly-chart"></div><h3 class="text-2xl font-bold mb-4">Extracted Concepts</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-white/20"><tr><th class="p-2">Concept</th><th class="p-2">Description</th><th class="p-2">Effect</th><th class="p-2">Influence</th></tr></thead><tbody>`;
                concepts.forEach(c => { tableHtml += `<tr class="border-b border-white/10"><td class="p-2 font-semibold">${c.name}</td><td class="p-2 text-sm text-white/80">${c.description}</td><td class="p-2 text-center">${c.effect}</td><td class="p-2">${c.influence}</td></tr>`; });
                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;
                Plotly.newPlot('effectPieChart', [{ values: [positiveCount, negativeCount, neutralCount], labels: ['Positive', 'Negative', 'Neutral'], type: 'pie', marker: { colors: ['#2E8B57', '#CD5C5C', '#808080'] }, hole: .4 }], { title: 'Distribution of Concept Effects', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, legend: { orientation: 'h', y: -0.1 } }, {responsive: true});
            }

            function renderNetworkTab(concepts, containerId) {
                const container = $(containerId);
                container.innerHTML = `<div id="conceptNetworkChart" class="w-full h-[600px] plotly-chart"></div>`;
                const nodes = concepts.map(c => ({ id: c.name, ...c }));
                const edges = [];
                for (let i = 0; i < nodes.length; i++) { for (let j = i + 1; j < nodes.length; j++) { edges.push({ source: nodes[i].id, target: nodes[j].id }); } }
                const positions = {};
                nodes.forEach((node, i) => { const angle = (i / nodes.length) * 2 * Math.PI; positions[node.id] = { x: (nodes.length * 15) * Math.cos(angle), y: (nodes.length * 15) * Math.sin(angle) }; });
                const edge_x = []; const edge_y = [];
                edges.forEach(edge => { edge_x.push(positions[edge.source].x, positions[edge.target].x, null); edge_y.push(positions[edge.source].y, positions[edge.target].y, null); });
                const node_x = []; const node_y = []; const node_text = []; const node_color = [];
                nodes.forEach(node => { node_x.push(positions[node.id].x); node_y.push(positions[node.id].y); node_text.push(`${node.name}<br>Influence: ${node.influence}`); if (node.effect === '+') node_color.push('green'); else if (node.effect === '-') node_color.push('red'); else node_color.push('gray'); });
                const edgeTrace = { x: edge_x, y: edge_y, mode: 'lines', line: { width: 0.5, color: '#888' }, hoverinfo: 'none' };
                const nodeTrace = { x: node_x, y: node_y, mode: 'markers+text', text: nodes.map(n => n.name), textposition: 'bottom center', hoverinfo: 'text', hovertext: node_text, marker: { size: 20, color: node_color } };
                Plotly.newPlot('conceptNetworkChart', [edgeTrace, nodeTrace], { title: 'Concept Network Visualization', showlegend: false, hovermode: 'closest', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: { showgrid: false, zeroline: false, showticklabels: false }, yaxis: { showgrid: false, zeroline: false, showticklabels: false } }, {responsive: true});
            }

            function renderArchetypesTab(topArchetypes, containerId) {
                const container = $(containerId);
                let contentHtml = `<h3 class="text-2xl font-bold mb-4"> 80/20 Analysis - Most Relevant Archetypes</h3><p class="text-white/70 mb-6">This analysis focuses on the top 20% of system archetypes that are most likely driving 80% of the system's behavior.</p><div id="archetypeBarChart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
                topArchetypes.forEach(archetype => { contentHtml += `<div class="metric-card mb-4"><h4 class="text-xl font-bold"> ${archetype.name}</h4><p class="text-sm font-semibold text-yellow-300 mb-2">Relevance Score: ${archetype.relevance_score}/10</p><p class="text-sm text-white/80 mb-3">${archetype.description}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><div><h5 class="font-semibold">Leverage Points:</h5><ul class="list-disc list-inside">${archetype.leverage_points.map(lp => `<li>${lp}</li>`).join('')}</ul></div><div><h5 class="font-semibold">Interventions:</h5><ul class="list-disc list-inside">${archetype.interventions.map(i => `<li>${i}</li>`).join('')}</ul></div></div></div>`; });
                container.innerHTML = contentHtml;
                const chartData = topArchetypes.map(a => ({ Archetype: a.name, 'Relevance Score': a.relevance_score || 0 }));
                Plotly.newPlot('archetypeBarChart', [{ x: chartData.map(d => d.Archetype), y: chartData.map(d => d['Relevance Score']), type: 'bar', marker: { color: chartData.map(d => d['Relevance Score']), colorscale: 'Viridis' } }], { title: 'Archetype Relevance Scores (Top 20%)', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: { automargin: true }, yaxis: { title: 'Relevance Score' } }, {responsive: true});
            }

            function renderLeveragePointsTab(topLeveragePoints, containerId) {
                const container = $(containerId);
                let contentHtml = `<h3 class="text-2xl font-bold mb-4"> 80/20 Analysis - Top Leverage Points</h3><p class="text-white/70 mb-6">These are the top 20% of concepts where small changes can lead to the largest (80%) improvements in the system.</p><div id="leverageBarChart" class="w-full h-[400px] mb-8 plotly-chart"></div>`;
                topLeveragePoints.forEach(point => { let priorityClass = ''; if (point.impact === 'High' && point.score >= 8) priorityClass = 'critical'; else if (point.score >= 6) priorityClass = 'high'; contentHtml += `<div class="metric-card ${priorityClass} mb-4"><h4 class="text-xl font-bold">${point.concept}</h4><p class="text-sm font-semibold text-yellow-300 mb-2">Leverage Score: ${point.score}/10 | Expected Impact: ${point.impact}</p><p class="text-sm text-white/80 mb-3"><strong>Reasoning:</strong> ${point.reasoning}</p><div><h5 class="font-semibold text-sm">Recommended Actions:</h5><ul class="list-disc list-inside text-sm">${point.actions.map(a => `<li>${a}</li>`).join('')}</ul></div></div>`; });
                container.innerHTML = contentHtml;
                const chartData = topLeveragePoints.map(p => ({ Concept: p.concept, 'Leverage Score': p.score || 0, Impact: p.impact }));
                Plotly.newPlot('leverageBarChart', [{ x: chartData.map(d => d.Concept), y: chartData.map(d => d['Leverage Score']), type: 'bar', marker: { color: chartData.map(d => { if(d.Impact === 'High') return '#2E8B57'; if(d.Impact === 'Medium') return '#FF8C00'; return '#DC143C'; }) } }], { title: 'Leverage Point Scores (Top 20%)', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: 'white' }, xaxis: { automargin: true }, yaxis: { title: 'Leverage Score' } }, {responsive: true});
            }
            // =========================================================================
            // ===== END OF ANALYSIS LOGIC & RENDERING                            =====
            // =========================================================================

            function handleWebSocketMessage(data) {
                const container = pendingAnalysisRequests.get(parseInt(data.messageId));
                if (!container) return;

                if (data.error) {
                    container.innerHTML = `<div class="p-4 text-center text-red-400">Workflow error: ${data.error}</div>`;
                    pendingAnalysisRequests.delete(parseInt(data.messageId));
                    setLoading('generate', false);
                    return;
                }

                if (data.progress && !data.result && data.templateId !== 'pareto-fishbone') {
                    container.innerHTML = `
                    <div class="text-center text-white/70 p-4">
                        <div class="typing-indicator mb-4">
                            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                        </div>
                        <p class="mb-2"> ${data.progress}</p>
                        <p class="text-sm text-white/50">Analysis in progress...</p>
                    </div>`;
                    return;
                }
                
                // Handle complex data for pareto-fishbone
                if (data.templateId === 'pareto-fishbone' && data.fishbone && data.pareto) {
                    container.innerHTML = ''; // Clear loading
                    const fishboneData = data.fishbone;
                    const paretoData = data.pareto;
                    
                    // Create Tab Interface
                    const tabNav = document.createElement('div');
                    tabNav.className = 'flex border-b border-white/20 -mx-10 px-6';
                    tabNav.innerHTML = `
                        <button class="analysis-tab-btn active" data-tab="pareto"> Pareto Chart</button>
                        <button class="analysis-tab-btn" data-tab="fishbone"> Fishbone Diagram</button>
                        <button class="analysis-tab-btn" data-tab="details"> Analysis Details</button>
                        <button class="analysis-tab-btn" data-tab="plan"> Action Plan</button>
                    `;
                    container.appendChild(tabNav);
                    
                    const tabContent = document.createElement('div');
                    container.appendChild(tabContent);

                    // Create Tab Panels
                    tabContent.innerHTML = `
                        <div id="paretoPanel" class="analysis-tab-panel active"></div>
                        <div id="fishbonePanel" class="analysis-tab-panel"></div>
                        <div id="detailsPanel" class="analysis-tab-panel"></div>
                        <div id="planPanel" class="analysis-tab-panel"></div>
                    `;

                    // Populate Pareto Tab
                    const paretoPanel = $('paretoPanel');
                    const paretoChartDiv = document.createElement('div');
                    paretoChartDiv.id = 'paretoChartContainer';
                    paretoChartDiv.className = 'plotly-chart';
                    paretoPanel.appendChild(paretoChartDiv);
                    createParetoChartJS(paretoData, 'paretoChartContainer');

                    // Populate Fishbone Tab
                    const fishbonePanel = $('fishbonePanel');
                    if(data.fishbone_image) {
                        fishbonePanel.innerHTML = `<img id="fishbone_img" src="data:image/png;base64,${data.fishbone_image}" class="w-full h-auto rounded-lg" alt="Fishbone Diagram">`;
                    } else {
                        fishbonePanel.innerHTML = `<p class="text-white/70">Fishbone image not available.</p>`;
                    }

                    // Populate Details Tab
                    const detailsPanel = $('detailsPanel');
                    let detailsHtml = `<h3 class="text-2xl font-bold mb-4">Analysis Summary</h3>`;
                    if(paretoData.analysis_summary) {
                        detailsHtml += `<div class="p-4 rounded-lg bg-white/5 mb-6 text-white/80 italic">${paretoData.analysis_summary}</div>`;
                    }
                     detailsHtml += `<h4 class="text-xl font-semibold mb-3">Category Breakdown</h4>`;
                    for(const [category, sub_causes] of Object.entries(fishboneData)) {
                        detailsHtml += `<details class="bg-white/5 p-3 rounded-lg mb-2"><summary class="cursor-pointer font-semibold">${category} (${sub_causes.length} causes)</summary><ul class="mt-2 pl-4">`;
                        sub_causes.forEach(cause => {
                            const isVital = (paretoData.vital_few || []).some(item => cause.toLowerCase() === item.cause.toLowerCase());
                            detailsHtml += `<li class="mb-1">${isVital ? '' : ''} ${cause}</li>`;
                        });
                        detailsHtml += `</ul></details>`;
                    }
                    detailsPanel.innerHTML = detailsHtml;

                    // Populate Action Plan Tab
                    const planPanel = $('planPanel');
                    let planHtml = `<h3 class="text-2xl font-bold mb-4">Recommended Action Plan</h3>
                                    <div class="p-4 rounded-lg bg-green-500/10 text-green-300 mb-6"> <strong>80/20 Rule:</strong> Focus 80% of your resources on the 'Vital Few' causes for maximum impact!</div>
                                    <h4 class="text-xl font-semibold mb-3 border-b border-red-500/50 pb-2 text-red-300"> IMMEDIATE FOCUS (Vital Few)</h4>`;
                    (paretoData.vital_few || []).forEach(cause => {
                        planHtml += `<div class="mb-4">
                                        <p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p>
                                        <p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> HIGH </p>
                                     </div>`;
                    });
                    planHtml += `<h4 class="text-xl font-semibold mt-8 mb-3 border-b border-white/20 pb-2"> SECONDARY ACTIONS (Useful Many)</h4>`;
                    (paretoData.useful_many || []).forEach(cause => {
                         planHtml += `<div class="mb-4">
                                        <p class="font-bold text-lg">${cause.cause} (${cause.impact_score}% impact)</p>
                                        <p class="text-sm text-white/70"><strong>Category:</strong> ${cause.category} | <strong>Priority:</strong> Medium/Low</p>
                                     </div>`;
                    });
                    planPanel.innerHTML = planHtml;
                    
                    analysisCache[currentTemplateId] = container.innerHTML;

                    // Add Tab Switching Logic
                    tabNav.addEventListener('click', e => {
                        if(e.target.tagName === 'BUTTON') {
                            tabNav.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                            tabContent.querySelectorAll('.analysis-tab-panel').forEach(pnl => pnl.classList.remove('active'));
                            
                            e.target.classList.add('active');
                            const targetPanelId = e.target.dataset.tab + 'Panel';
                            const targetPanel = $(targetPanelId);
                            targetPanel.classList.add('active');
                            const chart = targetPanel.querySelector('.plotly-chart');
                            if (chart) Plotly.Plots.resize(chart);
                        }
                    });


                } else if (data.result) { // Handle simple text result for other templates
                    container.innerHTML = `<div id="analysisContent" class="whitespace-pre-wrap">${data.result}</div>`;
                    analysisCache[currentTemplateId] = container.innerHTML;
                }

                const analysisActionsEl = $('analysisActions');
                if(analysisActionsEl) analysisActionsEl.classList.remove('hidden');
                
                pendingAnalysisRequests.delete(parseInt(data.messageId));
                setLoading('generate', false);
            }

            // --- Auth Logic using Supabase ---
            async function handleLogin() {
                const email = $('loginEmail').value.trim();
                const password = $('loginPassword').value;
                const loginMessageEl = $('loginMessage');

                if (!email || !password) {
                    showMessage('loginMessage', 'Please fill in all fields', 'error');
                    return;
                }

                setLoading('login', true);
                loginMessageEl.classList.add('hidden');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showMessage('loginMessage', error.message, 'error');
                } else {
                    showMessage('loginMessage', 'Login successful! Redirecting...', 'success');
                    setTimeout(() => navigateTo('home'), 1500);
                }
                setLoading('login', false);
            }

            async function handleRegister() {
                const firstName = $('registerFirstName').value.trim();
                const lastName = $('registerLastName').value.trim();
                const email = $('registerEmail').value.trim();
                const password = $('registerPassword').value;
                const confirmPassword = $('registerConfirmPassword').value;

                if (!firstName || !lastName || !email || !password || !confirmPassword) {
                    showMessage('registerMessage', 'Please fill in all fields', 'error');
                    return;
                }
                if (password !== confirmPassword) {
                    showMessage('registerMessage', 'Passwords do not match', 'error');
                    return;
                }
                if (password.length < 6) {
                    showMessage('registerMessage', 'Password must be at least 6 characters long', 'error');
                    return;
                }

                setLoading('register', true);
                try {
                    const { data, error } = await supabase.functions.invoke('create-user-v3', {
                         body: {
                            email,
                            password,
                            metadata: {
                                first_name: firstName,
                                last_name: lastName
                            }
                        }
                    });

                    if (error || !data?.user) {
                         showMessage('registerMessage', error?.message || 'User creation failed.', 'error');
                         return;
                    }
                    
                    $('registerForm').reset();
                    navigateTo('emailVerification');

                } catch (err) {
                    console.error('Register error:', err);
                    showMessage('registerMessage', 'An error occurred during registration. Please try again.', 'error');
                } finally {
                    setLoading('register', false);
                }
            }

            async function handleLogout() {
                await supabase.auth.signOut();
                navigateTo('login');
            }
            
            // --- UI Helpers ---
            function setLoading(type, isLoading) {
                const btn = $(type + 'Btn');
                if (!btn) return;
                
                const textEl = $(type + 'BtnText');
                const spinner = $(type + 'Spinner');

                btn.disabled = isLoading;
                if (spinner) spinner.classList.toggle('hidden', !isLoading);
                
                if(textEl) {
                    if (isLoading) {
                        // Store original text if it's not already stored
                        if (!btn.dataset.originalText) {
                            btn.dataset.originalText = textEl.textContent;
                        }
                        textEl.textContent = 'Analyzing...';
                    } else {
                        // Restore original text
                        textEl.textContent = btn.dataset.originalText || 'Generate Analysis';
                        // Clear the data attribute after use
                        delete btn.dataset.originalText;
                    }
                }
            }


            function showMessage(id, msg, type) {
                const el = $(id);
                if (!el) return;
                el.textContent = msg;
                el.className = type === 'error' ? 'error-message' : 'success-message';
                if (msg) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
                if (type === 'success' && msg) {
                    setTimeout(() => el.classList.add('hidden'), 4000);
                }
            }

            // --- Three.js Animation Logic ---
            let scene, camera, renderer, group;
            const particlesData = [];
            let positions, colors;
            let particlesGeometry;
            let pointCloud;
            let particlePositions;
            let linesMesh;
            let animationFrameId;

            const NUM_PARTICLES = 1000;
            const AREA_SIZE = 3000;
            const AREA_HALF = AREA_SIZE / 2;
            const MIN_DISTANCE = 200;

            let mouseX = 0, mouseY = 0;

            function createCircleTexture(size, color) {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const context = canvas.getContext('2d');
                const gradient = context.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2);
                gradient.addColorStop(0, color);
                gradient.addColorStop(0.7, color);
                gradient.addColorStop(1, 'rgba(0,0,0,0)');
                context.fillStyle = gradient;
                context.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
                context.fill();
                return new THREE.CanvasTexture(canvas);
            }

            function initThreeJS() {
                const canvas = $('threeJsCanvas');
                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000);
                camera.position.z = 3000;

                scene = new THREE.Scene();
                group = new THREE.Group();
                scene.add(group);

                const particleTexture = createCircleTexture(64, 'rgba(173, 216, 230, 1)');

                const pMaterial = new THREE.PointsMaterial({
                    color: 0xFFFFFF,
                    size: 7,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    sizeAttenuation: false,
                    map: particleTexture
                });

                particlesGeometry = new THREE.BufferGeometry();
                particlePositions = new Float32Array(NUM_PARTICLES * 3);

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const x = Math.random() * AREA_SIZE - AREA_HALF;
                    const y = Math.random() * AREA_SIZE - AREA_HALF;
                    const z = Math.random() * AREA_SIZE - AREA_HALF;

                    particlePositions[i * 3] = x;
                    particlePositions[i * 3 + 1] = y;
                    particlePositions[i * 3 + 2] = z;

                    particlesData.push({
                        velocity: new THREE.Vector3(
                            (Math.random() - 0.5) * 0.5,
                            (Math.random() - 0.5) * 0.5,
                            (Math.random() - 0.5) * 0.5
                        ),
                        numConnections: 0
                    });
                }

                particlesGeometry.setDrawRange(0, NUM_PARTICLES);
                particlesGeometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3).setUsage(THREE.DynamicDrawUsage));

                pointCloud = new THREE.Points(particlesGeometry, pMaterial);
                group.add(pointCloud);

                const lineGeometry = new THREE.BufferGeometry();
                positions = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);
                colors = new Float32Array(NUM_PARTICLES * NUM_PARTICLES * 3);

                lineGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3).setUsage(THREE.DynamicDrawUsage));
                lineGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3).setUsage(THREE.DynamicDrawUsage));
                lineGeometry.computeBoundingSphere();
                lineGeometry.setDrawRange(0, 0);

                const lineMaterial = new THREE.LineBasicMaterial({
                    vertexColors: true,
                    blending: THREE.AdditiveBlending,
                    transparent: true,
                    opacity: 0.4
                });

                linesMesh = new THREE.LineSegments(lineGeometry, lineMaterial);
                group.add(linesMesh);

                renderer = new THREE.WebGLRenderer({
                    canvas: canvas,
                    antialias: true,
                    alpha: true
                });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                
                startAnimationLoop();

                window.addEventListener('resize', onWindowResize);
                window.addEventListener('mousemove', onDocumentMouseMove);
            }

            function startAnimationLoop() {
                if(animationFrameId) cancelAnimationFrame(animationFrameId);

                function loop() {
                    animateThreeJS();
                    animationFrameId = requestAnimationFrame(loop);
                }
                loop();
            }

            function onDocumentMouseMove(event) {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            }

             function animateThreeJS() {
                let vertexpos = 0;
                let colorpos = 0;
                let numConnected = 0;

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    particlesData[i].numConnections = 0;
                }

                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const particleData = particlesData[i];
                    particlePositions[i * 3] += particleData.velocity.x;
                    particlePositions[i * 3 + 1] += particleData.velocity.y;
                    particlePositions[i * 3 + 2] += particleData.velocity.z;

                    if (particlePositions[i * 3 + 1] < -AREA_HALF || particlePositions[i * 3 + 1] > AREA_HALF)
                        particleData.velocity.y = -particleData.velocity.y;
                    if (particlePositions[i * 3] < -AREA_HALF || particlePositions[i * 3] > AREA_HALF)
                        particleData.velocity.x = -particleData.velocity.x;
                    if (particlePositions[i * 3 + 2] < -AREA_HALF || particlePositions[i * 3 + 2] > AREA_HALF)
                        particleData.velocity.z = -particleData.velocity.z;

                    for (let j = i + 1; j < NUM_PARTICLES; j++) {
                        const dx = particlePositions[i * 3] - particlePositions[j * 3];
                        const dy = particlePositions[i * 3 + 1] - particlePositions[j * 3 + 1];
                        const dz = particlePositions[i * 3 + 2] - particlePositions[j * 3 + 2];
                        const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

                        if (dist < MIN_DISTANCE) {
                            const alpha = 1.0 - dist / MIN_DISTANCE;
                            positions[vertexpos++] = particlePositions[i * 3];
                            positions[vertexpos++] = particlePositions[i * 3 + 1];
                            positions[vertexpos++] = particlePositions[i * 3 + 2];
                            positions[vertexpos++] = particlePositions[j * 3];
                            positions[vertexpos++] = particlePositions[j * 3 + 1];
                            positions[vertexpos++] = particlePositions[j * 3 + 2];

                            const lineColor = new THREE.Color(0xADD8E6);
                            colors[colorpos++] = lineColor.r * alpha;
                            colors[colorpos++] = lineColor.g * alpha;
                            colors[colorpos++] = lineColor.b * alpha;
                            colors[colorpos++] = lineColor.r * alpha;
                            colors[colorpos++] = lineColor.g * alpha;
                            colors[colorpos++] = lineColor.b * alpha;
                            numConnected++;
                        }
                    }
                }

                linesMesh.geometry.setDrawRange(0, numConnected * 2);
                linesMesh.geometry.attributes.position.needsUpdate = true;
                linesMesh.geometry.attributes.color.needsUpdate = true;
                pointCloud.geometry.attributes.position.needsUpdate = true;

                const rotationSpeed = 0.03;
                group.rotation.y += (mouseX * 0.05 - group.rotation.y) * rotationSpeed;
                group.rotation.x += (mouseY * 0.05 - group.rotation.x) * rotationSpeed;
                group.rotation.y += 0.0001;
                group.rotation.x += 0.00005;

                renderer.render(scene, camera);
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            // --- AI Analysis Examples Carousel Logic ---
            let currentExampleIndex = 0;
            const analysisExamples = document.querySelectorAll('.analysis-example-item');
            const prevExampleBtn = $('prevExampleBtn');
            const nextExampleBtn = $('nextExampleBtn');
            const exampleCounter = $('exampleCounter');

            function showAnalysisExample(index) {
                analysisExamples.forEach((item, i) => {
                    item.classList.toggle('hidden', i !== index);
                });
                prevExampleBtn.disabled = index === 0;
                nextExampleBtn.disabled = index === analysisExamples.length - 1;
                exampleCounter.textContent = `${index + 1} of ${analysisExamples.length}`;
            }

            if (prevExampleBtn) {
                prevExampleBtn.addEventListener('click', () => {
                    if (currentExampleIndex > 0) {
                        currentExampleIndex--;
                        showAnalysisExample(currentExampleIndex);
                    }
                });
            }
            if (nextExampleBtn) {
                nextExampleBtn.addEventListener('click', () => {
                    if (currentExampleIndex < analysisExamples.length - 1) {
                        currentExampleIndex++;
                        showAnalysisExample(currentExampleIndex);
                    }
                });
            }
            if (analysisExamples.length > 0) {
                showAnalysisExample(currentExampleIndex);
            }

            // --- Initial Setup ---
            const versionModal = $('versionChoiceModal');
            const selectFreeBtn = $('selectFreeVersion');
            const selectPaidBtn = $('selectPaidVersion');
            const closeModalBtn = $('closeModalBtn');
            
            selectFreeBtn.addEventListener('click', () => {
                currentSelectionLimit = 1;
                proceedFromModal();
            });

            selectPaidBtn.addEventListener('click', () => {
                currentSelectionLimit = 3;
                proceedFromModal();
            });

            closeModalBtn.addEventListener('click', () => {
                versionModal.classList.add('hidden');
            });

            $('loginBtn').addEventListener('click', handleLogin);
            $('registerBtn').addEventListener('click', handleRegister);
            
            if (window.location.hash.includes('access_token')) {
                 navigateTo('home');
            } else {
                 navigateTo('home');
            }
            
            setupHomeTabs();
            attachHomeCardListeners();
            
            initThreeJS();

            // --- Dashboard Widget ---
            (function initDashboardWidget() {
                const PRESENCE_PREFIX = 'sage_presence_';
                const HEARTBEAT_MS = 10000;
                const STALE_MS = 30000;
                const TAB_ID = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '-' + Math.random());

                function heartbeat() {
                    try {
                        localStorage.setItem(PRESENCE_PREFIX + TAB_ID, String(Date.now()));
                    } catch (e) {}
                }

                function cleanupStale() {
                    const now = Date.now();
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i);
                            if (k && k.startsWith(PRESENCE_PREFIX)) {
                                const ts = Number(localStorage.getItem(k) || '0');
                                if (!ts || (now - ts) > STALE_MS) localStorage.removeItem(k);
                            }
                        }
                    } catch (e) {}
                }

                function countOnline() {
                    const now = Date.now();
                    let cnt = 0;
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i);
                            if (k && k.startsWith(PRESENCE_PREFIX)) {
                                const ts = Number(localStorage.getItem(k) || '0');
                                if (ts && (now - ts) <= STALE_MS) cnt++;
                            }
                        }
                    } catch (e) {}
                    return cnt;
                }

                heartbeat();
                const hb = setInterval(() => {
                    heartbeat();
                    cleanupStale();
                }, HEARTBEAT_MS);
                window.addEventListener('beforeunload', () => {
                    try {
                        localStorage.removeItem(PRESENCE_PREFIX + TAB_ID);
                    } catch (e) {};
                    clearInterval(hb);
                });

                function updateDashboard() {
                    const usersEl = document.getElementById('dashUsersOnline');
                    const serverDot = document.getElementById('dashServerDot');
                    const serverText = document.getElementById('dashServerText');
                    const wsStatusEl = document.getElementById('wsStatus');
                    
                    if (usersEl) usersEl.textContent = String(countOnline());

                    let statusText = 'Unknown', statusClass = 'bg-yellow-400';
                    if (wsStatusEl) {
                        const t = wsStatusEl.textContent.trim().toLowerCase();
                        if (t.includes('connected')) {
                            statusText = 'Connected';
                            statusClass = 'bg-green-400';
                        } else if (t.includes('disconnected') || t.includes('failed') || t.includes('error')) {
                            statusText = 'Disconnected';
                            statusClass = 'bg-red-400';
                        } else if (t.includes('connecting')) {
                            statusText = 'Connecting';
                            statusClass = 'bg-yellow-400';
                        }
                    }
                    
                    if (serverText) serverText.textContent = statusText;
                    if (serverDot) serverDot.className = 'inline-block w-3 h-3 rounded-full ' + statusClass;
                }
                setInterval(updateDashboard, 2000);
                updateDashboard();
            })();
    
        });
    </script>

</body>

</html>
